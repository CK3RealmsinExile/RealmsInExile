namespace = mongol_invasion

##############################
# Demands for Subjugation
# 2000-2999
# by Petter Vilberg
##############################

# The Khan demands subjugation
mongol_invasion.2001 = {
	type = letter_event
	opening = mongol_invasion.2001.opening
	desc = mongol_invasion.2001.desc
	sender = {
		character = scope:mongol_emperor
		animation = personality_bold
	}

	trigger = {
		NOT = { is_at_war_with = scope:mongol_emperor }
		root != scope:mongol_emperor
	}

	immediate = {
		save_scope_as = demand_recipient
		scope:mongol_emperor = {
			remove_list_variable = {
				name = subjugation_offer_under_consideration
				target = root
			}
		}
	}

	option = { # Submit
		name = mongol_invasion.2001.a
		custom_tooltip = mongol_invasion.2001.a.tt
		hidden_effect = {
			scope:mongol_emperor = {
				trigger_event = mongol_invasion.2002
			}
		}
		ai_chance = {
			base = 100
			# More likely for Altaic group to join the big 'un
			# modifier = {
				# add = 300
				# culture = { has_cultural_pillar = heritage_mongolic }
			# }
			# More likely for orcs to join the big 'un
			modifier = {
				add = 300
				is_orc = yes
			}			
			# More likely if you're Evil
			modifier = {
				add = 500
				faith_is_evil = yes	#LotR
			}
			# Unlikely if you're an elf
			modifier = {
				factor = 0.2
				is_elf = yes
			}
			# More likely if you're just a count
			modifier = {
				add = 300
				highest_held_title_tier = tier_county
			}
			# More likely if you're a duke
			modifier = {
				add = 100
				highest_held_title_tier = tier_duchy
			}
			# Unlikely if you're Arrogant
			modifier = {
				factor = 0.2
				has_trait = arrogant
			}
			# Unlikely if you're brave
			modifier = {
				factor = 0.2
				has_trait = brave
			}
			# Likely if you're a Craven
			modifier = {
				factor = 1.2
				has_trait = craven
			}
			# Lower chance if you're decently large
			modifier = {
				factor = 0.5
				realm_size >= 35 # Poland-sized
			}
			# No chance of accepting if you're large
			modifier = {
				factor = 0
				realm_size >= 55 # Hungary-sized
			}
		}
	}

	option = { # Resist
		name = mongol_invasion.2001.b
		custom_tooltip = mongol_invasion.2001.b.tt
		add_internal_flag = dangerous
		hidden_effect = {
			scope:mongol_emperor = {
				trigger_event = mongol_invasion.2003
			}
		}
		ai_chance = {
			base = 300
		}
	}
}

# Subjugation accepted
mongol_invasion.2002 = {
	type = letter_event
	opening = mongol_invasion.2002.opening
	desc = mongol_invasion.2002.desc
	sender = scope:demand_recipient

	immediate = {
		create_title_and_vassal_change = {
			type = swear_fealty
			save_scope_as = title_change
			add_claim_on_loss = no
		}
		scope:demand_recipient = {
			change_liege = {
				liege = root
				change = scope:title_change
			}
		}
		resolve_title_and_vassal_change = scope:title_change
		# Remove from the list blocking war declarations
		remove_list_variable = {
			name = subjugation_offer_under_consideration
			target = scope:demand_recipient
		}

		debug_log = "Someone accepted Mongol subjugation"
		debug_log_scopes = yes
	}

	option = { # Wise choice
		name = mongol_invasion.2002.a
	}
}

# Subjugation refused
mongol_invasion.2003 = {
	type = letter_event
	opening = mongol_invasion.2003.opening
	desc = mongol_invasion.2003.desc
	sender = {
		character = scope:demand_recipient
		animation = personality_bold
	}

	immediate = {
		hidden_effect = {
			scope:demand_recipient.primary_title = {
				save_scope_as = target_title
			}
		}
		# Remove from the list blocking war declarations
		remove_list_variable = {
			name = subjugation_offer_under_consideration
			target = scope:demand_recipient
		}

		debug_log = "Someone refused Mongol subjugation"
		debug_log_scopes = yes
	}

	option = { # War it is
		name = mongol_invasion.2003.a
		if = {
			limit = {
				exists = scope:target_title.empire
			}
			start_war = {
				cb = mongol_realm_invasion_war
				target = scope:target_title.holder
				target_title = scope:target_title.empire
			}
		}
		else = {
			debug_log = "Failed to find a target empire for a Mongol invasion!"
			debug_log_scopes = yes

			start_war = {
				cb = mongol_realm_invasion_war
				target = scope:target_title.holder
				target_title = scope:target_title.holder.capital_province.empire
			}
		}
	}
}


######################################
# Subjugation or a Broken Alliance - King or lower
# by Petter Vilberg
######################################

# The Khan demands subjugation
mongol_invasion.2101 = {
	type = letter_event
	opening = mongol_invasion.2001.opening
	desc = mongol_invasion.2101.desc
	sender = {
		character = scope:mongol_emperor
		animation = personality_bold
	}

	trigger = {
		root != scope:mongol_emperor
	}

	immediate = {
		save_scope_as = demand_recipient
	}

	option = { # Submit
		name = mongol_invasion.2101.a
		custom_tooltip = mongol_invasion.2001.a.tt
		hidden_effect = {
			scope:mongol_emperor = {
				trigger_event = mongol_invasion.2102
			}
		}
		ai_chance = {
			base = 100
			# More likely for Altaic group to join the big 'un
			# modifier = {
				# add = 300
				# culture = { has_cultural_pillar = heritage_mongolic }
			# }
			# More likely for orcs to join the big 'un
			modifier = {
				add = 300
				is_orc = yes
			}			
			# More likely if you're Evil
			modifier = {
				add = 500
				faith_is_evil = yes	#LotR
			}
			# Unlikely if you're an elf
			modifier = {
				factor = 0.2
				is_elf = yes
			}			
			# More likely if you're just a count
			modifier = {
				add = 1000
				highest_held_title_tier = tier_county
			}
			# More likely if you're a duke
			modifier = {
				add = 400
				highest_held_title_tier = tier_duchy
			}
			# Unlikely if you're Arrogant
			modifier = {
				factor = 0.2
				has_trait = arrogant
			}
			# Unlikely if you're brave
			modifier = {
				factor = 0.2
				has_trait = brave
			}
			# Likely if you're a Craven
			modifier = {
				factor = 2
				has_trait = craven
			}
			# Lower chance if you're decently large
			modifier = {
				factor = 0.5
				realm_size >= 35 # Poland-sized
			}
			# No chance of accepting if you're large
			modifier = {
				factor = 0
				realm_size >= 55 # Hungary-sized
			}
		}
	}

	option = {
		name = mongol_invasion.2101.b
		add_internal_flag = dangerous
		custom_tooltip = mongol_invasion.2101.b.tt
		hidden_effect = {
			scope:mongol_emperor = {
				trigger_event = mongol_invasion.2103
			}
		}
		ai_chance = {
			base = 100
		}
	}
}

# Subjugation accepted
mongol_invasion.2102 = {
	type = letter_event
	opening = mongol_invasion.2002.opening
	desc = mongol_invasion.2002.desc
	sender = scope:demand_recipient

	immediate = {
		create_title_and_vassal_change = {
			type = swear_fealty
			save_scope_as = title_change
			add_claim_on_loss = no
		}
		scope:demand_recipient = {
			change_liege = {
				liege = root
				change = scope:title_change
			}
		}
		resolve_title_and_vassal_change = scope:title_change
		# Remove from the list blocking war declarations
		remove_list_variable = {
			name = subjugation_offer_under_consideration
			target = scope:demand_recipient
		}

		debug_log = "Someone accepted Mongol subjugation"
		debug_log_scopes = yes
	}

	option = { # Wise choice
		name = mongol_invasion.2002.a
	}
}

# Subjugation refused
mongol_invasion.2103 = {
	type = letter_event
	opening = mongol_invasion.2003.opening
	desc = mongol_invasion.2003.desc
	sender = {
		character = scope:demand_recipient
		animation = personality_bold
	}

	immediate = {
		# Remove from the list blocking war declarations
		remove_list_variable = {
			name = subjugation_offer_under_consideration
			target = scope:demand_recipient
		}
		break_alliance = scope:demand_recipient

		debug_log = "Someone refused Mongol subjugation"
		debug_log_scopes = yes
	}

	# War it is
	option = {
		name = mongol_invasion.2103.a
		start_war = {
			cb = mongol_realm_invasion_war
			target = scope:target_title.holder
			target_title = scope:target_title.empire
		}
		ai_chance = {
			base = 100
		}
	}

	# Just you wait...
	option = {
		name = mongol_invasion.2103.b
		ai_chance = {
			base = 0
		}
	}
}

######################################
# Subjugation or a Broken Alliance - Emperor
# by Petter Vilberg
######################################

# The Khan demands subjugation
mongol_invasion.2111 = {
	type = letter_event
	opening = mongol_invasion.2001.opening
	desc = mongol_invasion.2101.desc
	sender = {
		character = scope:mongol_emperor
		animation = personality_bold
	}

	trigger = {
		root != scope:mongol_emperor
	}

	immediate = {
		save_scope_as = demand_recipient
	}

	# Outrageous!
	option = {
		name = mongol_invasion.2111.b
		custom_tooltip = mongol_invasion.2111.b.tt
		hidden_effect = {
			scope:mongol_emperor = {
				trigger_event = mongol_invasion.2112
			}
		}
	}
}

# Subjugation refused
mongol_invasion.2112 = {
	type = letter_event
	opening = mongol_invasion.2003.opening
	desc = mongol_invasion.2112.desc
	sender = scope:demand_recipient

	immediate = {
		# Remove from the list blocking war declarations
		remove_list_variable = {
			name = subjugation_offer_under_consideration
			target = scope:demand_recipient
		}

		debug_log = "Someone refused Mongol subjugation - Broke alliance"
		debug_log_scopes = yes
	}

	option = { # Our alliance is over
		name = mongol_invasion.2112.a
		break_alliance = scope:demand_recipient
	}
}