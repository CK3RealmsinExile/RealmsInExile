namespace = umbar

# Ar-Adunaim Events
#			umbar.0100 #Ar-Adûnâim introduction
#			umbar.0101- # Ar-Adûnâim reclamation events
#			umbar.0200 #Castimiri Introduction
#			umbar.1000-1 #Castmiri Invasion

umbar.0001 = {
	content_source = realms_dlc
	type = character_event
	title = umbar.0001.t
	desc = umbar.0001.desc
	theme = war

	trigger = {	
		is_landed = yes
		is_alive = yes
	}

	immediate = {
		# find_wildperson_for_umbar_effect = yes
		title:k_umbar.holder = { save_scope_as = black_lord }
	}

	left_portrait = {
		character = root
		animation = worry
	}
	right_portrait = {
		character = scope:wildpeople_ruler
		animation = war_attacker
	}
	option = {
		name = umbar.0001.a
		custom_tooltip = umbar.0001.tt
		add_character_modifier = { modifier = black_lord_of_umbar_modifier years = 10 }
		# fund_wildperson_for_umbar_effect = yes
	}
	option = {
		name = umbar.0001.b
	}
}

umbar.0002 = {
	content_source = realms_dlc
	type = character_event
	title = umbar.0002.t
	desc = umbar.0002.desc
	theme = war

	trigger = {	
		is_landed = yes
		is_alive = yes
	}

	left_portrait = {
		character = root
		animation = worry
	}
	right_portrait = {
		character = title:d_nan_i_feryn.holder
		animation = war_attacker
	}
	option = {
		name = umbar.0002.a
	}
}

umbar.0003 = {
	content_source = realms_dlc
	type = character_event
	title = umbar.0003.t
	desc = umbar.0003.desc
	theme = war

	trigger = {	
		is_landed = yes
		is_alive = yes
	}

	left_portrait = {
		character = root
		animation = sadness
	}
	option = {
		name = umbar.0003.a
		add_gold = 350
	}
}

umbar.0004 = {
	content_source = realms_dlc
	type = character_event
	title = umbar.0004.t
	desc = umbar.0004.desc
	theme = war

	trigger = {	
		is_landed = yes
		is_alive = yes
	}

	left_portrait = {
		character = root
		animation = anger
	}
	right_portrait = {
		character = title:d_nan_i_feryn.holder
		animation = personality_greedy	
	}
	option = {
		name = umbar.0004.a
	}
}

### Ar-Adûnâim Events ###

umbar.0100 = { # Introduction to the Ar-Adunaim
	content_source = realms_dlc
	type = character_event
	title = umbar.0100.t
	desc = umbar.0100.desc
	theme = stewardship_duty_focus
	left_portrait = {
		character = root
		animation = anger
	}
	
	immediate = {
		play_music_cue = lotr_cue_adunai
	}
	
	option = { #
		name = umbar.0100.a
		custom_tooltip = umbar.0100.a.tt
		spawn_army = {		  # "Numenorean" Honor Guard. changing the old numenorean stuff to new Ar-Adunaim and Abrazanim MAA.
			uses_supply = no
			inheritable = yes
			name = ar_ardunaim_event_troops
			men_at_arms = {
				type = narunaru_royal_guard
				stacks = 2
			}
			men_at_arms = {
				type = adunaim_armsmen
				stacks = 2
			}
			men_at_arms = {
				type = abrazanim_warbows
				stacks = 1
			}
			location = capital_province
		}
		title:e_adunaim.holder = {
			trigger_event = { # Check status on Adunaim conquests
				id = umbar.0101
				years = 1
			}
			trigger_event = { # Adunaim Tharbad
				id = adunaim.0001
				years = 2
			}
		}
	}
}

umbar.0101 = { # Check on the Adunaim conquests
	hidden = yes
	option = {
		if = {
			limit = { completely_controls = title:d_umbar }
			title:e_adunaim.holder = {
				save_scope_as = adunaim_conquerer
				trigger_event = {
					id = umbar.0102
				}
			}
			every_player = {
				limit = { 
					NOT = { has_title = title:e_adunaim }
				}
				trigger_event = { # The Ar-Adunaim take Umbar!
					id = umbar.0102
					days = { 30 90 }
				}
			}
		}
		else_if = {
			limit = { 
				NOT = { completely_controls = title:d_umbar } 
			}
			title:e_adunaim.holder = {
				trigger_event = { # Check status on Adunaim conquests
					id = umbar.0101
					years = 1
				}
			}
		}
	}
}

umbar.0102 = { # The Conquest of Umbar
	content_source = realms_dlc
	type = character_event
	title = umbar.0102.t
	desc = {
		first_valid = {
			triggered_desc = {
				trigger = {
					has_title = title:e_adunaim
				}
				desc = umbar.0102.desc.a
			}
		desc = umbar.0102.desc.b
		}
	}
	theme = war
	override_background = {
		reference = black_ship
	}
	left_portrait = {
		character = scope:adunaim_conquerer
		animation = war_attacker
	}
	option = {
		trigger = {
			has_title = title:e_adunaim
		}
		name = umbar.0102.a
		add_prestige = 1000
		title:c_umbar = {
			add_county_modifier = {
				modifier = political_violence
				years = 5
			}
		}
	}
	option = {
		name = umbar.0102.b
		trigger = {
			NOT = {
				has_title = title:e_adunaim
			}
		}
	}
}

umbar.0200 = { # Introduction to Umbar
	content_source = realms_dlc
	type = character_event
	title = umbar.0200.t
	desc = umbar.0200.desc
	theme = stewardship_duty_focus
	left_portrait = {
		character = root
		animation = personality_cynical
	}
	
	immediate = {
		play_music_cue = lotr_cue_adunai
	}

	option = {
		name = umbar.0200.a
		custom_tooltip = umbar.0200.a.tt
		character:lineblackqueen9 = { # Beruthiel's plot
			trigger_event = {
				id = umbar.0201
				days = 720
			}
		}
	}
}

umbar.0201 = { # Beruthiel's plot
	content_source = realms_dlc
	type = character_event
	title = umbar.0201.t
	desc = umbar.0201.desc
	theme = murder_scheme
	left_portrait = {
		character = root
		animation = scheme
	}
	right_portrait = {
		character = character:lineofcassimir22
		animation = disapproval
	}
	option = {
		name = umbar.0201.a
		custom_tooltip = umbar.0201.a.tt
		character:lineofcassimir22 = {
			trigger_event = {
				id = umbar.0202
				days = 14
			}
		}
	}
}

umbar.0202 = { # Beruthiel's plot
	content_source = realms_dlc
	type = character_event
	title = umbar.0202.t
	desc = umbar.0202.desc
	theme = death
	left_portrait = {
		character = root
		animation = fear 
	}
	right_portrait = {
		character = character:lineblackqueen9
		animation = scheme
	}
	option = {
		name = umbar.0202.a
		death = { 		
			death_reason = death_murder	
			killer = character:lineblackqueen9
		}
		character:lineblackqueen9 = {
			trigger_event = {
				id = umbar.0203
			}
		}
	}
}

umbar.0203 = { # Beruthiel's plot
	content_source = realms_dlc
	type = character_event
	title = umbar.0203.t
	desc = umbar.0203.desc
	theme = murder_scheme
	left_portrait = {
		character = root
		animation = scheme 
	}
	right_portrait = {
		character = character:lineofcassimir22
		animation = fear
	}
	option = {
		name = umbar.0203.a
	}
}

umbar.1000 = {
	content_source = realms_dlc
	type = character_event
	title = umbar.1000.t
	desc = umbar.1000.desc
	theme = war
	left_portrait = {
		character = root
		animation = anger
	}
	immediate = {
		play_music_cue = "mx_cue_combat_2"
		add_character_flag = {
			flag = pressed_castamiri_claim
		}
	}

	option = {
		name = umbar.1000.a
		if = {
			limit = { exists = title:e_gondor_steward }
			start_war = {
				casus_belli = castamir_claim_cb
				target = title:e_gondor_steward.holder
				target_title = title:e_gondor_steward
			}
		}
		if = {
		limit = { exists = title:e_gondor }
			start_war = {
				casus_belli = castamir_claim_cb
				target = title:e_gondor.holder
				target_title = title:e_gondor
			}
		}
	}
}

umbar.1001 = {	
	content_source = realms_dlc
	type = character_event
	title = umbar.1001.t
	desc = umbar.1001.desc
	theme = stewardship_duty_focus
	left_portrait = {
		character = root
		animation = personality_rational
	}
	
	trigger = {
		root.dynasty = dynasty:dynasty_kamal
	}

	immediate = {
		dynasty = { # Ancestors
			every_dynasty_member = {
				even_if_dead = yes
				limit = {
					NOT = {
						any_in_list = {
							list = castamirioni_members
							this = prev
						}
					}
				}
				every_ancestor = {
					even_if_dead = yes
					limit = { dynasty = dynasty:dynasty_kamal }
					add_to_list = castamirioni_members
					every_ancestor = {
						even_if_dead = yes
						limit = { dynasty = dynasty:dynasty_kamal }
						add_to_list = castamirioni_members
						every_ancestor = {
							even_if_dead = yes
							limit = { dynasty = dynasty:dynasty_kamal }
							add_to_list = castamirioni_members
							every_ancestor = {
								even_if_dead = yes
								limit = { dynasty = dynasty:dynasty_kamal }
								add_to_list = castamirioni_members
								every_ancestor = {
									even_if_dead = yes
									limit = { dynasty = dynasty:dynasty_kamal }
									add_to_list = castamirioni_members
								}
							}
						}
					}
				}
			}
		}
		dynasty = { # Current alive members
			every_dynasty_member = {
				limit = { 
					NOT = {
						any_in_list = {
							list = castamirioni_members
							this = prev
						}
					}
				}
				add_to_list = castamirioni_members
			}
		}
	}
	
	option = {
		name = umbar.1001.a #The Castamiri become the Kings of Gondor
		hidden_effect = {
			every_in_list = {
				list = castamirioni_members
				set_house = house:dynasty_castamir
			}
		}
		set_house = house:dynasty_castamir

		dynasty = { add_dynasty_prestige_level = 6 }
		dynasty = { add_dynasty_prestige = 6000 }
		
		# set_house = house:house_castamir

		set_culture = culture:gondorian
		every_close_or_extended_family_member = { set_culture = culture:gondorian }

		
		if = {
			limit = { exists = title:e_gondor.holder }
			title:e_gondor.holder = { # Inherits the Throne of Gondor, the Palantir of Minas Tirith and the Crown of Gondor from the King.
				every_character_artifact = {
					limit = {
						OR = {
							has_variable = palantir_minasanor
							has_variable = throne_of_gondor
							has_variable = crown_of_gondor
							has_variable = black_chair_stewards
						}
					}
					set_owner = {
						target = root
						history = {
							type = inherited
							recipient = root
						}
					}
				}
			}
		}
		else_if = {
			limit = { exists = title:e_gondor_steward.holder }
			if = {
				limit = {
					NOT = {
						any_artifact = {
							has_variable = crown_of_gondor
						}
					}
				}
				create_artifact_crown_of_gondor_effect = { OWNER = this }
			}
			title:e_gondor_steward.holder = { # Inherits the Throne of Gondor and the Palantir of Minas Tirith from the steward.
				every_character_artifact = {
					limit = {
						OR = {
							has_variable = palantir_minasanor
							has_variable = black_chair_stewards
							has_variable = throne_of_gondor
							has_variable = crown_of_gondor
						}
					}
					set_owner = {
						target = root
						history = {
							type = inherited
							recipient = root
						}
					}
				}
			}
		}
		every_artifact = { #The Royal Artifacts are now tied to the new title
			limit = { 
				OR = {
					has_variable = throne_of_gondor
					has_variable = crown_of_gondor
					has_variable = black_chair_stewards
				}
			}
			set_variable = {
				name = artifact_succession_title
				value = title:e_castamir
			}
		}
		
		# every_child = {
		# 	limit = {
		# 		OR = {
		# 			mother = {
		# 				AND = {
		# 					dynasty = dynasty:dynasty_kamal
		# 					matrilinear_marriage = yes
		# 				}
		# 			}
		# 			father = {
		# 				AND = {
		# 					dynasty = dynasty:dynasty_kamal
		# 					matrilinear_marriage = no
		# 				}
		# 			}
		# 		}
		# 	}
		# 	set_house = house:house_castamir
		# 	every_child = {
		# 		limit = {
		# 			OR = {
		# 				mother = {
		# 					AND = {
		# 						dynasty = dynasty:dynasty_kamal
		# 						matrilinear_marriage = yes
		# 					}
		# 				}
		# 				father = {
		# 					AND = {
		# 						dynasty = dynasty:dynasty_kamal
		# 						matrilinear_marriage = no
		# 					}
		# 				}
		# 			}
		# 		}
		# 		set_house = house:house_castamir
		# 		every_child = {
		# 			limit = {
		# 				OR = {
		# 					mother = {
		# 						AND = {
		# 							dynasty = dynasty:dynasty_kamal
		# 							matrilinear_marriage = yes
		# 						}
		# 					}
		# 					father = {
		# 						AND = {
		# 							dynasty = dynasty:dynasty_kamal
		# 							matrilinear_marriage = no
		# 						}
		# 					}
		# 				}
		# 			}
		# 			set_house = house:house_castamir
		# 			every_child = {
		# 				limit = {
		# 					OR = {
		# 						mother = {
		# 							AND = {
		# 								dynasty = dynasty:dynasty_kamal
		# 								matrilinear_marriage = yes
		# 							}
		# 						}
		# 						father = {
		# 							AND = {
		# 								dynasty = dynasty:dynasty_kamal
		# 								matrilinear_marriage = no
		# 							}
		# 						}
		# 					}
		# 				}
		# 				set_house = house:house_castamir
		# 			}
		# 		}
		# 	}
		# }
		
		create_title_and_vassal_change = {
			type = created
			save_scope_as = change
			add_claim_on_loss = no
		}
		title:e_castamir = {
			change_title_holder = {
				holder = root
				change = scope:change
			}
		}
		title:e_gondor_steward = {
			every_in_de_jure_hierarchy = {
				limit = { tier = tier_kingdom }
				set_de_jure_liege_title = title:e_castamir
			}
			holder = { add_pressed_claim = title:e_castamir }
			every_claimant = {
				if = {
					limit = {
						has_strong_claim_on = this
					}
					add_pressed_claim = title:e_castamir
				}
				else = { add_unpressed_claim = title:e_castamir }
			}
		}
		title:e_gondor = {
			every_in_de_jure_hierarchy = {
				limit = { tier = tier_kingdom }
				set_de_jure_liege_title = title:e_castamir
			}
			holder = { add_pressed_claim = title:e_castamir }
			every_claimant = {
				if = {
					limit = {
						has_strong_claim_on = this
					}
					add_pressed_claim = title:e_castamir
				}
				else = { add_unpressed_claim = title:e_castamir }
			}
		}
		title:e_umbar = {
			every_in_de_jure_hierarchy = {
				limit = { tier = tier_kingdom }
				set_de_jure_liege_title = title:e_castamir
			}
			every_claimant = {
				if = {
					limit = {
						has_strong_claim_on = this
					}
					add_pressed_claim = title:e_castamir
				}
				else = { add_unpressed_claim = title:e_castamir }
			}
		}
		resolve_title_and_vassal_change = scope:change
		destroy_title = title:e_umbar
		destroy_title = title:e_gondor_steward
		destroy_title = title:e_gondor
		destroy_title = title:e_reunitedkingdom
		
		trigger_event = {
			id = umbar.1003
			days = 0
		}
		ai_chance = {
			base = 0 # LotR: This should be tied to WotR mode.

			modifier = { # Game Rule
				has_game_rule = default_ai_behavior
				add = 100
			}

			modifier = { # Game Rule
				has_game_rule = weighted_ai_behavior
				add = 70
			}

			modifier = { # Game Rule
				has_game_rule = random_ai_behavior
				add = 34
			}
		}
	}
	option = {
		name = umbar.1001.b

		dynasty = { add_dynasty_prestige_level = 1 }
		dynasty = { add_dynasty_prestige = 1000 }

		create_title_and_vassal_change = {
			type = created
			save_scope_as = change
			add_claim_on_loss = no
		}
		title:e_gondor_steward = {
			every_in_de_jure_hierarchy = {
				limit = { tier = tier_kingdom }
				set_de_jure_liege_title = title:e_umbar
			}
		}
		title:e_gondor = {
			every_in_de_jure_hierarchy = {
				limit = { tier = tier_kingdom }
				set_de_jure_liege_title = title:e_umbar
			}
		}
		resolve_title_and_vassal_change = scope:change
		destroy_title = title:e_gondor_steward
		destroy_title = title:e_gondor
		ai_chance = {
			base = 0 # LotR: This should be tied to WotR mode.

			modifier = { # Game Rule
				has_game_rule = default_ai_behavior
				add = 0
			}

			modifier = { # Game Rule
				has_game_rule = weighted_ai_behavior
				add = 30
			}

			modifier = { # Game Rule
				has_game_rule = random_ai_behavior
				add = 66
			}
		}
	}
}

umbar.1002 = {
	content_source = realms_dlc
	type = character_event
	title = umbar.1002.t
	desc = umbar.1002.desc
	theme = war
	left_portrait = {
		character = root
		animation = worry
	}
	right_portrait = {
		character = title:e_umbar.holder
		animation = anger
		}
	option = {
		name = umbar.1002.a
	}
}

umbar.1003 = {	###Chose the capital
	content_source = realms_dlc
	type = character_event
	title = umbar.1003.t
	desc = umbar.1003.desc
	theme = stewardship_duty_focus
	left_portrait = {
		character = root
		animation = personality_rational
	}

	option = { ###Minas Tirith
		name = umbar.1003.a			
		trigger = { completely_controls = title:d_minas_tirith }
		if = {
			limit = {
				title:k_anorien.holder = { is_independent_ruler = no }
				title:k_anorien.holder.liege = root
			}
			get_title=title:k_anorien
		}
		get_title=title:d_minas_tirith
		get_title=title:c_minas_tirith
		title:e_castamir = {
			set_capital_county = title:c_minas_tirith
		}
		#set_culture = culture:gondorian
		#every_close_or_extended_family_member = {
		#	set_culture = culture:gondorian
		#}
		set_realm_capital = title:c_minas_tirith
	}
	option = { ###restored Osgiliath
		name = umbar.1003.b			
		trigger = { 
			completely_controls = title:d_minas_tirith 
			completely_controls = title:c_osgiliath
			is_target_in_global_variable_list = {
				name = unavailable_unique_decisions
				target = flag:decision_osgiliath_capital
			}
		}
		if = {
			limit = {
				title:k_anorien.holder = { is_independent_ruler = no }
				title:k_anorien.holder.liege = root
			}
			get_title=title:k_anorien
		}
		get_title=title:d_minas_tirith
		get_title=title:c_osgiliath
		title:e_castamir = {
			set_capital_county = title:c_osgiliath
		}
		#set_culture = culture:gondorian
		#every_close_or_extended_family_member = {
		#	set_culture = culture:gondorian
		#}
		set_realm_capital = title:c_osgiliath
	}
	option = { ###pelargir
		name = umbar.1003.c
		trigger = { completely_controls = title:d_pelargir }
		if = {
			limit = {
				title:k_lebennin.holder = { is_independent_ruler = no }
				title:k_lebennin.holder.liege = root
			}
			get_title=title:k_lebennin
		}
		get_title=title:d_pelargir
		get_title=title:c_pelargir
		title:e_castamir = {
			set_capital_county = title:c_pelargir
		}
		#set_culture = culture:gondorian
		#every_close_or_extended_family_member = {
		#	set_culture = culture:gondorian
		#}
	}
	option = {
		name = umbar.1003.d
	}
}

umbar.1500 = { # Hidden event to make realm break up
	hidden = yes

	trigger = {	root = { highest_held_title_tier >= tier_kingdom } }

	immediate = {
		root = { save_scope_as = defender }
		
		scope:defender = { # maybe check first if a castamirian member is alive? Kinda like a "Im more powerful than you!" type of effect
			random_powerful_vassal = {
				limit = { NOT = { is_allied_to = scope:defender } }
				save_scope_as = attacker 
			}
		}
		scope:defender = {
			every_vassal = {
				limit = {
					# is_powerful_vassal = no # Already added
					OR = {
						has_vassal_stance = minority
						has_vassal_stance = glory_hound
					}
					
					NOT = { this = scope:attacker } 
					NOT = { is_allied_to = scope:defender }
				}
				add_to_list = vassals_in_umbar
			}
		}

		scope:attacker = {
			start_war = {
				casus_belli = nation_fracturing_faction_war
				target = scope:defender
				target_title = scope:defender.primary_title
			}
			every_character_war = {
				limit = { using_cb = nation_fracturing_faction_war } # In-case the random head of the attackers has other wars hes currently engaged in
				save_scope_as = war_depose_castamir
			}
		}
		every_in_list = {
			list = vassals_in_umbar
			# limit = { prev = { is_attacker = no } } #WIP - throwing an error, so commenting out for now.
			scope:war_depose_castamir = {
				add_attacker = prev
			}
		}
	}
}

umbar.1600 = { # Corsair Conversion Event
	content_source = realms_dlc
	type = character_event
	title = umbar.1600.t
	desc = umbar.1600.desc
	theme = war
	override_background = {
		reference = docks
	}

	left_portrait = {
		character = root
		animation = brave
	}

	#right_portrait = {
	#	character = title:e_umbar.holder
	#	animation = anger
	#}

	option = {
		name = umbar.1600.a
	}
}