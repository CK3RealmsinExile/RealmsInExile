namespace = tamska

tamska.0001 = { # Maintenance event to designate the Tamska's heir with the Tamska elective choice
	hidden = yes

    immediate = {
        if = {
            limit = {
                any_child = {
                    this = title:d_tamska_main.current_heir
                    NOT = {
                        this = root.player_heir
                    }
                }
            }
            random_child = {
                limit = {
                    this = title:d_tamska_main.current_heir
                    NOT = {
                        this = root.player_heir
                    }
                }
                save_scope_as = designated_tamska_heir
            }
            send_interface_toast = {
                title = tamska.new_heir
                left_icon = root
                right_icon = scope:designated_tamska_heir
                set_designated_heir = scope:designated_tamska_heir
            }
        }
    }
}

tamska.0002 = { # A Tamskangi has been found - does the Tamska approve?
	content_source = realms_dlc
	type = character_event
	title = tamska.0002.t
	desc = tamska.0002.desc
	theme = crown
	left_portrait = {
		character = root
		animation = personality_cynical
	}
    lower_center_portrait = scope:discoverer
	right_portrait = {
		character = scope:tamska_heir
		animation = throne_room_bow_1
	}

	immediate = {
		## Find a holy man/woman to discover the Tamskangi
        if = {
            limit = {
                exists = root.cp:councillor_court_chaplain
            }
            root.cp:councillor_court_chaplain = { save_scope_as = discoverer }
        }
        else_if = {
            limit = {
                any_vassal_or_below = {
                    capital_province = { has_holding_type = church_holding }
                    faith = root.faith
                }
            }
            random_vassal_or_below = {
                limit = { 
                    capital_province = { has_holding_type = church_holding }
                    faith = root.faith
                }
                save_scope_as = discoverer
            }
        }
        else = {
            create_character = {
                template = priest_character_template
                gender_female_chance = 65
                culture = root.culture
                faith = root.faith
                location = root.location
                dynasty = none
                save_scope_as = discoverer
            }
        }
        
        ## Find a Tamskangi
        random_list = {
            1 = { #Tamskangi is found from a non-lowborn family
                if = {
                    limit = {
                        any_living_character = {
                            faith = {
                                has_doctrine = tenet_tamska_main
                            }
                            is_female = yes
                            age <= 14
                            age >= 4
                            is_lowborn = no
                            NOT = { has_character_flag = rejected_tamskangi }
                            NOT = { has_trait = tamska_heir }
                            NOT = { mother = root }
                            NOT = { this = root }
                        }
                    }
                    random_living_character = {
                        limit = {
                            faith = {
                                has_doctrine = tenet_tamska_main
                            }
                            is_female = yes
                            age <= 14
                            age >= 4
                            is_lowborn = no
                            NOT = { has_character_flag = rejected_tamskangi }
                            NOT = { has_trait = tamska_heir }
                            NOT = { mother = root }
                            NOT = { this = root }
                        }
                        weight = {
                            base = 1
                            modifier = { # Weight for higher skills, focusing on learning
                                add = {
                                    value = learning
                                    multiply = 2
                                    add = diplomacy
                                    add = martial
                                    add = stewardship
                                    add = intrigue
                                }
                            }
                            modifier = { # Counter-balance as older will have higher skills
                                add = {
                                    subtract = {
                                        value = age
                                    }
                                    multiply = 2
                                }    
                            }
                        }
                        save_scope_as = tamska_heir
                        father = { save_scope_as = tamska_heir_father }
                        mother = { save_scope_as = tamska_heir_mother }
                    }
                }
                else = { # Unless she isn't...
                    create_character = {
                        template = pool_repopulate_learning
                        gender_female_chance = 100
                        age = { 4 9 }
                        culture = root.culture
                        faith = root.faith
                        location = root.location
                        dynasty = none
                        save_scope_as = tamska_heir
                    }
                }
            }
            3 = { #Tamskangi is a lowborn
                if = {
                    limit = {
                        any_living_character = {
                            faith = {
                                has_doctrine = tenet_tamska_main
                            }
                            is_female = yes
                            age <= 14
                            age >= 4
                            is_lowborn = yes
                            NOT = { has_character_flag = rejected_tamskangi }
                            NOT = { has_trait = tamska_heir }
                            NOT = { this = root }
                        }
                    }
                    random_living_character = {
                        limit = {
                            faith = {
                                has_doctrine = tenet_tamska_main
                            }
                            is_female = yes
                            age <= 14
                            age >= 4
                            is_lowborn = yes
                            NOT = { has_character_flag = rejected_tamskangi }
                            NOT = { has_trait = tamska_heir }
                            NOT = { this = root }
                        }
                        weight = {
                            base = 1
                            modifier = { # Weight for higher skills, focusing on learning
                                add = {
                                    value = learning
                                    multiply = 2
                                    add = diplomacy
                                    add = martial
                                    add = stewardship
                                    add = intrigue
                                }
                            }
                            modifier = { # Counter-balance as older will have higher skills
                                add = {
                                    subtract = {
                                        value = age
                                    }
                                    multiply = 2
                                }   
                            }
                        }
                        save_scope_as = tamska_heir
                    }
                }
                else = {
                    create_character = {
                        template = pool_repopulate_learning
                        gender_female_chance = 100
                        age = { 4 9 }
                        culture = root.culture
                        faith = root.faith
                        location = root.location
                        dynasty = none
                        save_scope_as = tamska_heir
                    }
                }
            }
        }

        ## Make sure Tamskangi is not a bastard
        hidden_effect = {
            scope:tamska_heir = {
                if = {
                    limit = {
                        has_trait = bastard
                    }
                    remove_trait = bastard
                }
                if = {
                    limit = {
                        has_trait = legitimized_bastard
                    }
                    remove_trait = legitimized_bastard
                }
                if = {
                    limit = {
                        has_trait = disputed_heritage
                    }
                    remove_trait = disputed_heritage
                }
            }        
        }
	}
	
	option = {
		name = tamska.0002.a
        scope:discoverer ?= {
			add_opinion = {
				target = ROOT
				modifier = relieved_opinion
				opinion = 15
			}
        }
        save_scope_as = current_tamska
        every_vassal_or_below = { # Notify the player vassals
            limit = {
                is_ai = no
            }
            trigger_event = tamska.0003
        }
        add_legitimacy = 400
        if = {
            limit = {
                scope:tamska_heir = {
                    is_lowborn = no
                    NOT = { dynasty = dynasty:dynasty_tamskal }
                }
            }
            scope:tamska_heir.dynasty = {
                save_scope_as = tamska_heir_former_dynasty
                add_dynasty_prestige = 500
                add_dynasty_modifier = {
                    modifier = tamskangi_found_in_dynasty_dynasty_modifier
                    years = 80
                }
            }
        }
        scope:tamska_heir = {
			become_tamskangi_effect = yes
		}
		adopt = scope:tamska_heir
		set_designated_heir = scope:tamska_heir
        create_character_memory = {
            type = adopted_a_child
            participants = {
                child = scope:tamska_heir
            }
        }
	}

    option = {
		name = tamska.0002.b
        trigger = {
            is_ai = no
        }
        scope:discoverer ?= {
			add_opinion = {
				target = ROOT
				modifier = disappointed_opinion
				opinion = -30
			}
        }
       add_legitimacy = -750
        add_piety = -500
        add_piety_level = -1
        add_tyranny = 5
        add_character_modifier = {
            modifier = rejected_tamskangi_character_modifier
            years = 50
        }
        scope:tamska_heir = {
            # add_unpressed_claim = title:e_mag_tumag
            # add_unpressed_claim = title:k_mag
            # add_unpressed_claim = title:k_tumag
            # add_unpressed_claim = title:d_tamska_main
            add_character_flag = rejected_tamskangi
			progress_towards_rival_effect = {
				REASON = rival_humiliated
				CHARACTER = ROOT
				OPINION = default_rival_opinion
			}
        }
        every_held_title = {
            limit = {
                tier >= tier_county
            }
            scope:tamska_heir = {
                add_unpressed_claim = prev
            }
        }
	}
}

tamska.0003 = { # Announcment of new Tamskangi being found
	content_source = realms_dlc
	type = character_event
	title = tamska.0003.t
	desc = tamska.0003.desc
	theme = crown
	left_portrait = {
		character = scope:current_tamska
		animation = happiness
	}
	right_portrait = {
		character = scope:tamska_heir
		animation = personality_bold
	}
	
	option = {
		name = tamska.0003.a
	}
}

tamska.0004 = {
    hidden = yes

    trigger = { is_independent_ruler = yes }
    
    immediate = {
	    create_title_and_vassal_change = {
	    	type = swear_fealty
	    	save_scope_as = change_two
	    	add_claim_on_loss = no
	    }
	    change_liege = {
	    	liege = scope:title_tamska_heir
	    	change = scope:change_two
	    }
	    resolve_title_and_vassal_change = scope:change_two
    }
}

tamska.0100 = { # Become the Tamska - Grand Ceremony (WIP Loc)
	content_source = realms_dlc
	type = character_event
	title = tamska.0100.t
	desc = tamska.0100.desc
	theme = faith
	override_background = {
		reference = temple
	}
	left_portrait = {
		character = ROOT
	}
	right_portrait = {
		character = scope:realm_priest
		animation = prayer
	}

    immediate = {
		cp:councillor_court_chaplain = {
			save_scope_as = realm_priest
		}
    }
	
	option = {
		name = tamska.0100.a
        # Perform the grand ceremony - Do you fumble it?
        duel = {
	    	skills = { diplomacy learning }
	    	value = 10
	    	25 = { # Exceptionary Success
	    		compare_modifier = {
	    			value = scope:duel_value
	    			multiplier = 3
	    		}
	    		desc = tamska.0100.a.toast.good
	    		ROOT = {
	    			send_interface_toast = {
	    				type = event_toast_effect_good
	    				left_icon = ROOT
	    				title = tamska.0100.a.toast.good
                        add_piety_level = 1
	    				add_piety = 500
	    			}
                    show_as_tooltip = { become_tamska_effect = yes }
	    		}
                max = 35
                min = 2
	    	}
	    	55 = { # Success
	    		compare_modifier = {
	    			value = scope:duel_value
	    			multiplier = -3
	    		}
	    		desc = tamska.0100.a.toast.neutral
	    		ROOT = {
	    			send_interface_toast = {
	    				type = event_toast_effect_neutral
	    				left_icon = ROOT
	    				title = tamska.0100.a.toast.neutral
	    				add_piety = 250
	    			}
                    show_as_tooltip = { become_tamska_effect = yes }
	    		}
	    	}
	    	20 = { # You fumble the ceremony
	    		compare_modifier = {
	    			value = scope:duel_value
	    			multiplier = -3
	    		}
	    		desc = tamska.0100.a.toast.bad
	    		ROOT = {
	    			send_interface_toast = {
	    				type = event_toast_effect_bad
	    				left_icon = ROOT
	    				title = tamska.0100.a.toast.bad
                        add_piety_level = -1
	    				add_piety = -500
                        add_legitimacy = -500
	    			}
                    show_as_tooltip = { become_tamska_effect = yes }
	    		}
                max = 40
                min = 1
	    	}
	    }

        # You become Tamska either way
        trigger_event = tamska.0101
	}
}

tamska.0101 = { # Become the Tamska - Coronation (WIP Loc)
	content_source = realms_dlc
	type = character_event
	title = tamska.0101.t
	desc = tamska.0101.desc
	theme = faith
	override_background = {
		reference = temple
	}
	left_portrait = {
		character = ROOT
	}
	right_portrait = {
		character = scope:realm_priest
		animation = prayer
	}
	
    immediate = {
        become_tamska_effect = yes
    }
	option = {
		name = tamska.0101.a
	}
}