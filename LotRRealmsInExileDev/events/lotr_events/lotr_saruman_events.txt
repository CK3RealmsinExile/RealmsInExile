namespace = saruman

# Events about Saruman
#	saruman.0001	The Lord of Isengard - Introduction to Saruman.
#	saruman.0002	The Orthanc Stone
#	saruman.0003	The palantír - Saruman looks into the palantír.
#	saruman.0004	The Orthanc Stone - stressing him out.
#	saruman.0005	A Wizard in the Hall of Kings.
#	saruman.0006	Cult of the White Hand.
#	saruman.0007	Consolidation of Dunland.
#	saruman.000?	The palantír
#	saruman.0010	Saruman becomes the Many Coloured.
#	saruman.0020	Forge a new Ring of Power.
#	saruman.0030	Gandalf seeks Saruman's council, should be a large set of events and duels.
######################################
### ISENGARD UNLEASHED ###
#	saruman.0040	In the Council of Sauron - "Build me an army worthy of Mordor."
#	saruman.0041	The Gardens of Isengard
#	saruman.0042	The Industry of Isengard
#	theodred.0040	Smoke Rises from Isengard.
######################################
#	saruman.0045	Union of the Two Towers - Free Uruk-hai-sies.
#	saruman.0050 - Fangorn (unordered)
#	saruman.0060 - Dunlendings (unordered)
#	saruman.0070 - Burning of the Westfold
#	saruman.0080 - Invasion of the Shire
#	saruman.0090 - Shire goods
#	saruman.0100 - Palantír outcomes
#	Removing Saruman's Influence
#	saruman.0400 to 0402
#	CLEANUP EVENTS FOR ISTARI CULTURE
#	saruman.0500-0502 Fixing Istari culture on spawned characters.
#	saruman.0500 - Fix for court chaplain.
#	saruman.0501 - Big check for vassals and court. Probably not needed.
#	saruman.0502 - Fix for barons.
#	saruman.0510-13 - Evil Istari --> Uruk-hai

saruman.0005 = { # A Wizard in the Hall of Kings
	content_source = realms_dlc
	type = character_event
	title = saruman.0005.t
	desc = saruman.0005.desc
	theme = diplomacy_foreign_affairs_focus
	override_background = { reference = minas_tirith }
	left_portrait = {
		character = root
		animation = personality_honorable
	}
	right_portrait = {
		character = scope:gondor_holder
		animation = war_defender
	}

	trigger = {
		faith_is_good = yes
		title:c_minas_tirith.holder = { faith_is_good = yes }
		trigger_if = {
			limit = { exists = title:e_gondor_steward.holder }
			NOR = {
				has_truce = title:e_gondor_steward.holder
				is_at_war_with = title:e_gondor_steward.holder
				has_relation_rival = title:e_gondor_steward.holder
			}
		}
		trigger_if = {
			limit = { exists = title:e_gondor.holder }
			NOR = {
				has_truce = title:e_gondor.holder
				is_at_war_with = title:e_gondor.holder
				has_relation_rival = title:e_gondor.holder
			}
		}
	}
	on_trigger_fail = {
		if = {
			limit = { is_ai = no }
			trigger_event = {
				id = saruman.0005
				days = { 900 2100 }
			}
		}
	}
	
	immediate = {
		root = { save_scope_as = saruman }
		title:c_minas_tirith.holder = { save_scope_as = gondor_holder }
		title:c_isengard = { save_scope_as = title_c_isengard }
		title:c_minas_tirith = { save_scope_as = title_c_minas_tirith }
		title:k_anorien = { save_scope_as = title_k_anorien }
		event_saruman_gondor_visit_character_effect = yes
	}

	option = { # I remain the chief person in the defence of the West.
		name = saruman.0005.a
		custom_tooltip = saruman.0005.a.tt
		event_saruman_gondor_importance_effect = yes
		ai_chance = {
			base = 1
			modifier = {
				factor = 0
				gold < medium_gold_value_check
			}
		}
	}
	
	option = { # A friend resides in the Ivory Tower.
		name = saruman.0005.b
		custom_tooltip = saruman.0005.b.tt
		event_saruman_gondor_friend_effect = yes
		ai_chance = {
			base = 0
			modifier = { # Game Rule
				has_game_rule = random_ai_behavior
				add = 1
			}
		}
	}
}

saruman.0006 = { # The Cult of the White Hand
	content_source = realms_dlc
	type = character_event
	title = saruman.0006.t
	desc = saruman.0006.desc
	theme = learning_theology_focus
	left_portrait = {
		character = root
		animation = personality_zealous
	}

	trigger = {
		faith_is_evil = yes
		NOT = { faith = faith:white_hand_cult }
		has_character_flag = saruman_accepted_sauron
	}
	on_trigger_fail = {
		if = {
			limit = { is_ai = no }
			trigger_event = {
				id = saruman.0006
				days = { 100 900 }
			}
		}
	}
	
	immediate = { root = { save_scope_as = saruman } }

	option = { # The White Hand shall not be stopped.
		name = saruman.0006.a
		custom_tooltip = saruman.0006.a.tt
		event_saruman_cult_of_white_hand_convert_effect = yes
		ai_chance = { base = 1 }
	}
	
	option = { # I risk showing my hand against Sauron.
		name = saruman.0006.b
		custom_tooltip = saruman.0006.b.tt
		trigger = { faith = faith:lidless_eye }
		event_saruman_cult_of_white_hand_stay_effect = yes
		ai_chance = { base = 0 }
	}
	
	option = { # My great purpose was sung before the world.
		name = saruman.0006.c
		custom_tooltip = saruman.0006.c.tt
		trigger = { faith = faith:lidless_eye }
		event_saruman_cult_of_white_hand_return_effect = yes
		ai_chance = { base = 0 }
	}
}

saruman.0007 = { # Consolidation of Dunland
	content_source = realms_dlc
	type = character_event
	title = saruman.0007.t
	desc = saruman.0007.desc
	theme = diplomacy_foreign_affairs_focus
	override_background = { reference = wilderness_mountains }
	left_portrait = {
		character = root
		animation = personality_bold
	}
	right_portrait = {
		character = scope:dunlandfells_holder
		animation = personality_cynical
	}

	trigger = {
		faith_is_good = yes
		OR = {
			title:d_dunlandfells.holder = {
				OR = {
					faith_is_good = yes
					faith_is_neutral = yes
				}
				lotr_gwathuirim_heritage_trigger = yes
			}
			title:d_dathabha.holder = {
				OR = {
					faith_is_good = yes
					faith_is_neutral = yes
				}
				lotr_gwathuirim_heritage_trigger = yes
			}
			title:d_westmarches.holder = {
				OR = {
					faith_is_good = yes
					faith_is_neutral = yes
				}
				lotr_gwathuirim_heritage_trigger = yes
			}
		}
		NOR = {
			OR = {
				has_truce = title:d_dunlandfells.holder
				is_at_war_with = title:d_dunlandfells.holder
				has_relation_rival = title:d_dunlandfells.holder
			}
			OR = {
				has_truce = title:d_dathabha.holder
				is_at_war_with = title:d_dathabha.holder
				has_relation_rival = title:d_dathabha.holder
			}
			OR = {
				has_truce = title:d_westmarches.holder
				is_at_war_with = title:d_westmarches.holder
				has_relation_rival = title:d_westmarches.holder
			}
		}
	}
	on_trigger_fail = {
		if = {
			limit = { is_ai = no }
			trigger_event = {
				id = saruman.0007
				days = { 900 2100 }
			}
		}
	}
	
	immediate = {
		root = { save_scope_as = saruman }
		title:c_isengard = { save_scope_as = title_c_isengard }
		if = {
			limit = {
				title:d_dunlandfells.holder = {
					OR = {
						faith_is_good = yes
						faith_is_neutral = yes
					}
					lotr_gwathuirim_heritage_trigger = yes
				}
			}
			title:d_dunlandfells.holder = { save_scope_as = dunlandfells_holder }
			title:d_dunlandfells = { save_scope_as = title_d_dunlandfells }
			add_character_flag = event_saruman_frecalund_available
		}
		if = {
			limit = {
				title:d_dathabha.holder = {
					OR = {
						faith_is_good = yes
						faith_is_neutral = yes
					}
					lotr_gwathuirim_heritage_trigger = yes
				}
			}
			title:d_dathabha.holder = { save_scope_as = dathabha_holder }
			title:d_dathabha = { save_scope_as = title_d_dathabha }
			add_character_flag = event_saruman_emyndunendor_available
		}
		if = {
			limit = {
				title:d_westmarches.holder = {
					OR = {
						faith_is_good = yes
						faith_is_neutral = yes
					}
					lotr_gwathuirim_heritage_trigger = yes
				}
			}
			title:d_westmarches.holder = { save_scope_as = westmarches_holder }
			title:d_westmarches = { save_scope_as = title_d_westmarches }
			add_character_flag = event_saruman_tormcaladach_available
		}
		spawn_saruman_dunlending_court_effect = yes
	}

	option = { # Former subjects of Gondor, not of the Istari.
		name = saruman.0007.a
		custom_tooltip = saruman.0007.a.tt
		event_saruman_dismissed_dunland_effect = yes
		ai_chance = {
			base = 0
			modifier = { # Game Rule
				has_game_rule = weighted_ai_behavior
				add = 1
			}
		}
	}
	
	option = { # They are worthy subjects of Isengard.
		name = saruman.0007.b
		custom_tooltip = saruman.0007.b.tt
		event_saruman_gondor_consolidation_of_dunland_effect = yes
		saruman_dunlending_court_effect = yes
		ai_chance = {
			base = 0
			modifier = { # Game Rule
				has_game_rule = random_ai_behavior
				add = 1
			}
		}
	}
}

saruman.0040 = { # In the Council of Sauron. Misty Mountain orcs arrive and start industry.
	content_source = realms_dlc
	type = character_event
	title = saruman.0040.t
	desc = saruman.0040.desc
	theme = intrigue
	left_portrait = {
		character = scope:saruman
		animation = stress
	}
	right_portrait = {
		character = scope:sauron
		animation = personality_greedy
	}
	
	immediate = {
		root = { save_scope_as = saruman }
		character:lineofsauron = { save_scope_as = sauron }
		title:c_isengard = { save_scope_as = isengard }
		spawn_saruman_orc_court_effect = yes
		spawn_saruman_dunlending_court_effect = yes
	}

	option = {
		name = saruman.0040.a
		custom_tooltip = saruman.0040.a.tt
		saruman_orc_court_effect = yes
		# owl_uruk_test_effect = yes
		ai_chance = {
			base = 0

			modifier = { # Game Rule
				has_game_rule = default_ai_behavior
				add = 100
			}

			modifier = { # Game Rule
				has_game_rule = weighted_ai_behavior
				add = 80
			}

			modifier = { # Game Rule
				has_game_rule = random_ai_behavior
				add = 50
			}			
		}
	}
	option = {
		name = saruman.0040.b
		custom_tooltip = saruman.0040.b.tt
		saruman_dunlending_court_effect = yes
		ai_chance = {
			base = 0

			modifier = { # Game Rule
				has_game_rule = default_ai_behavior
				add = 0
			}

			modifier = { # Game Rule
				has_game_rule = weighted_ai_behavior
				add = 20
			}

			modifier = { # Game Rule
				has_game_rule = random_ai_behavior
				add = 50
			}			
		}
	}
}

saruman.0041 = { # The Gardens of Isengard.
	content_source = realms_dlc
	type = character_event
	title = saruman.0041.t
	desc = saruman.0041.desc
	theme = martial_authority_focus
	left_portrait = {
		character = root
		animation = schadenfreude
	}

	trigger = {
		faith_is_evil = yes
		OR = {
			has_character_flag = saruman_invited_orcs
			has_character_flag = saruman_has_urukhai
		}
	}

	option = {
		name = saruman.0041.a
		name = saruman.0041.a.tt
		add_character_flag = saruman_isengard_industry_01
		# ToDo: add event for Théodred for Isengard.
		#		"He has strayed from the light, we must stop him."
		ai_chance = {
			base = 100
		}
	}
	# option = {
	# 	name = saruman.0041.b
	# 	custom_tooltip = saruman.0041.b.tt
	# }
}

saruman.0042 = { # The Industry of Isengard
	content_source = realms_dlc
	type = character_event
	title = saruman.0042.t
	desc = saruman.0042.desc
	theme = martial_authority_focus
	left_portrait = {
		character = root
		animation = disapproval
	}

	trigger = {
		faith_is_evil = yes
		OR = {
			has_character_flag = saruman_invited_orcs
			has_character_flag = saruman_has_urukhai
		}
	}

	immediate = {
		capital_county = {
			change_development_level = -2
			add_county_modifier = county_saruman_not_enough_fuel_modifier 
			#county_opinion_add = -20 - this is a modifier not an effect!
		}
	}

	option = {
		name = saruman.0042.a
		add_character_flag = saruman_isengard_industry_02
		# ToDo: add events for Treebeard and Saruman.
		ai_chance = {
			base = 100
		}
	}
}

saruman.0045 = { # Union of the Two Towers
	content_source = realms_dlc
	type = character_event
	title = saruman.0045.t
	desc = saruman.0045.desc
	theme = intrigue
	left_portrait = {
		character = root
		animation = personality_brave
	}

	trigger = {
		is_independent_ruler = yes
	}
	on_trigger_fail = {
		if = {
			limit = { is_ai = no }
			trigger_event = {
				id = saruman.0045
				days = { 100 900 }
			}
		}
	}

	immediate = {
		# if = {
		# 	# Matt note: this is untested code. It should check if Theodred is alive and then save him as the theodred throw-in character.
		# 	limit = { character:lineofsaruman = { is_alive = yes } }
		# 	character:6000034 = { save_scope_as = theodred }
		# }
		if = {
			limit = { exists = title:d_westfold.holder }
			title:d_westfold.holder = { save_scope_as = theodred }
		}
		# Matt note: as a failsafe this needs a fallback for the theodred throw-in.
		# Candidates: children or relations of title:k_rohan.holder
	}

	option = {
		name = saruman.0045.a
		#ToDo: give title e_isengard_unleashed to Saruman.
		form_isengard_unleashed_effect = yes
		scope:theodred = {
			trigger_event = {
				id = rohan.2200
				days = 4
			}
		}
		# character:lineofsaruman = { # Theodred is dead.
		# 	if = { 
		# 		limit = { 
		# 			is_alive = no
		# 		}
		# 		title:k_rohan.holder = { 
		# 			trigger_event = {
		# 				id = theodred.0117
		# 				days = 4
		# 			}
		# 		}
		# 	}
		# }
		ai_chance = {
			base = 100
		}
		custom_tooltip = saruman.0045.a.tt
	}
}

saruman.0046 = { # Union of the Two Towers - Dunlending variant
	content_source = realms_dlc
	type = character_event
	title = saruman.0046.t
	desc = saruman.0046.desc
	theme = intrigue
	left_portrait = {
		character = root
		animation = personality_brave
	}

	trigger = {
		is_independent_ruler = yes
	}
	on_trigger_fail = {
		if = {
			limit = { is_ai = no }
			trigger_event = {
				id = saruman.0046
				days = { 100 900 }
			}
		}
	}

	option = {
		name = saruman.0046.a
		form_isengard_unleashed_dunlending_effect = yes
		ai_chance = {
			base = 100
		}
	}
}