namespace = abrakhan

# Abrakhân Missions
#	abrakhan.1001	Golden King Starting Event Loredump
#	abrakhan.1002	Mission unlock 1. Choice of initial buff.
#					(A) Dune Sea
#					(B) Nâfarati
#					(C) Mahûd
#	abrakhan.1003	Nearby rulers have choice to submit.
#	abrakhan.1004	Nearby rulers who submit send letter.
#	abrakhan.1005	Hidden, AI Golden King forced to declare war.
#	abrakhan.1006	AI Forced War
#	abrakhan.1010	Mission unlock 2. Choice of initial buff.
#					(A-) Dune Sea, Nâfarati, Mahûd, Rây, Bellakar,
#						 Mardrûak, Near Harad, Umbar.
#						 Depends on unlocked decisions.
#
### Random Events
#	abrakhan.0010	Abrakhân loredump
#	abrakhan.0011	Pûst loredump
#	abrakhan.0020	The Cûl Mahrist
#					(A) Submit to the One!
#						Duel with the critical success giving you the Cûl Mahrist.
#						Failure and B makes it return in 0021.
#					(B) A terrifying monster from an ancient world.
#	abrakhan.0021	The Cûl Mahrist Returns.
#					(A) Rebuild our losses, do not fear the demon.
#					(B) I quake with fear at the thought of it returning.
#	abrakhan.0025	Desert Amber Expedition
#					(A) Gear expedition
#					(B) Tax
#	abrakhan.0030	Nâfarati Council WIP
#					(A-D) Who to side with.
#
### Rewards 
#	abrakhan.1020	Nâfarati reward
#	abrakhan.1021	Dune Sea reward


abrakhan.1001 = { # Golden King Starting Event Loredump
	content_source = realms_dlc
	type = character_event
	title = abrakhan.1001.t
	desc = abrakhan.1001.desc
	theme = martial
	left_portrait = {
		character = scope:goldenking
		animation = personality_greedy
	}
	right_portrait = {
		character = scope:sauron
		animation = dismissal
	}
	override_background = { reference = throne_room_east }
	immediate = {
		play_music_cue = aotr_calm_dolguldur_02
		root = { save_scope_as = goldenking }
		character:lineofsauron = { save_scope_as = sauron }
	}

	trigger = {
		character_is_valid_for_abrakhan_subjugation_mission_trigger = yes
	}
	on_trigger_fail = {
		if = {
			limit = { is_ai = no }
			trigger_event = {
				id = abrakhan.1001
				days = { 100 900 }
			}
		}
	}

	option = {
		name = abrakhan.1001.a
		ai_chance = { base = 100 }
		trigger_event = abrakhan.1002
		if = {
			limit = {
				OR = {
					scope:goldenking.faith = faith:lidless_eye
					scope:goldenking.faith = faith:cult_of_zigur
				}
			}
			add_prestige = massive_prestige_gain
			add_prestige_level = 1
		}
	}
}

abrakhan.1002 = { # Mission unlock 1, Subjugation letters to nafarat
	content_source = realms_dlc
	type = character_event
	title = abrakhan.1002.t
	desc = {
		desc = abrakhan.1002.desc_start
		desc = abrakhan.1002.desc_nafarati
		desc = abrakhan.1002.desc_dune_sea
		desc = abrakhan.1002.desc_end
	}
	theme = martial
	left_portrait = {
		character = scope:goldenking
		animation = map_worry
	}
	override_background = { reference = throne_room_east }

	trigger = { character_is_valid_for_abrakhan_subjugation_mission_trigger = yes }
	on_trigger_fail = {
		if = {
			limit = { is_ai = no }
			trigger_event = {
				id = abrakhan.1002
				days = { 900 1800 }
			}
		}
	}

	option = { # Nâfarati
		name = abrakhan.1002.b
		custom_tooltip = abrakhan.1002.a.tt
		custom_tooltip = abrakhan.1002.a.tt2
		unlock_abrakhan_mission_effect = { MISSION = abrakhan_subjugation_nafarat_decision_unlock }
		every_ruler = {
			limit = {
				is_landed = yes
				is_independent_ruler = yes
				realm_to_title_distance_squared = { title = title:c_abrashadorh value <= 200000 }
				exists = capital_province 
				capital_province = { geographical_region = middleearth_haradwaith_far_abrakhan }
				NOT = { this = character:nazgul3 }
				NOT = { this = root }
			}
			save_scope_as = nearby_ruler
			trigger_event = {
				id = abrakhan.1003
				days = { 30 90 }
			}
		}
		ai_chance = {
			base = 0 # LotR: This should be tied to WotR mode.
			modifier = { # Game Rule
				has_game_rule = default_ai_behavior
				add = 100
			}
			modifier = { # Game Rule
				has_game_rule = weighted_ai_behavior
				add = 80
			}
			modifier = { # Game Rule
				has_game_rule = random_ai_behavior
				add = 50
			}
		}
	}
	option = { # Dune Sea
		name = abrakhan.1002.a
		custom_tooltip = abrakhan.1002.a.tt
		custom_tooltip = abrakhan.1002.a.tt2
		unlock_abrakhan_mission_effect = { MISSION = abrakhan_subjugation_dune_sea_decision_unlock }

		ai_chance = {
			base = 0 # LotR: This should be tied to WotR mode.
			modifier = { # Game Rule
				has_game_rule = default_ai_behavior
				add = 0
			}
			modifier = { # Game Rule
				has_game_rule = weighted_ai_behavior
				add = 20
			}
			modifier = { # Game Rule
				has_game_rule = random_ai_behavior
				add = 50
			}
		}
	}
}

abrakhan.1003 = { # Nearby rulers have choice to submit.
	content_source = realms_dlc
	type = character_event
	title = abrakhan.1003.t
	desc = abrakhan.1003.desc
	theme = realm
	right_portrait = {
		character = scope:goldenking
		animation = nazgul_pose_idle
	}
	left_portrait = {
		character = scope:nearby_ruler
		animation = personality_cynical
	}
	trigger = {
		NOT = { root = character:nazgul3 }
	}
	immediate = {
		play_music_cue = "Influence_of_Sauron"
		if = {
			limit = {
				AND = {
					exists = title:k_abrakhan.holder
					character_is_valid_for_abrakhan_subjugation_mission_trigger = yes
				}
			}
			title:k_abrakhan.holder = {
				save_scope_as = goldenking
			}
		}
		else_if = {
			character:lineofsauron = { save_scope_as = sauron }
		}
		cp:councillor_court_chaplain = {
			save_scope_as = realm_priest
		}
	}

	option = { # Ill omen.
		name = abrakhan.1003.a
		custom_tooltip = abrakhan.1003.a.tt
		ai_chance = { base = 20 }
		abrakhan_carrion_feeder_effect = yes
		scope:nearby_ruler = { save_scope_as = defiant_to_abrakhan }
		scope:goldenking = { trigger_event = abrakhan.1005 }
	}
	option = { # Submit to Abrakhân.
		name = abrakhan.1003.b
		custom_tooltip = abrakhan.1003.b.tt
		submit_to_abrakhan_effect = yes
		scope:nearby_ruler = { save_scope_as = submitted_to_abrakhan }
		scope:goldenking = { trigger_event = abrakhan.1004 }
		ai_chance = {
			base = 0
			modifier = {
				add = 100
				OR = {
					# Worships Sauron.
					has_faith = faith:lidless_eye
					has_faith = faith:sons_of_sauron
					has_faith = faith:red_eye_cult
					has_faith = faith:cult_of_zigur
					has_faith = faith:faith_kanra
					is_undead = yes
					is_orc = yes
					religion = { is_in_family = rf_forcesofevil }
				}
			}
			modifier = {
				add = 10
				NOR = {
					religion = { is_in_family = rf_forcesofevil }
					religion = { is_in_family = rf_eruhini }
				}
			}
			modifier = {
				factor = 0.5
				OR = {
					culture = { has_cultural_pillar = heritage_middle_apysaic }
					culture = { has_cultural_pillar = heritage_ioriag }
					culture = { has_cultural_pillar = heritage_southern_apysaic }
					culture = { has_cultural_pillar = heritage_bellakari }
					culture = { has_cultural_pillar = heritage_druedain }
				}
			}
			modifier = {
				add = 5
				highest_held_title_tier = tier_county
			}
			modifier = {
				factor = 2
				has_game_rule = default_ai_behavior
			}
			modifier = {
				factor = 0
				has_game_rule = random_ai_behavior
			}
			modifier = {
				factor = 0.5
				highest_held_title_tier >= tier_duchy
			}
			modifier = {
				factor = 0.5
				realm_size >= 5
			}
			modifier = {
				factor = 0
				realm_size >= 20
			}
			modifier = {
				factor = 0.5
				OR = {
					has_trait = brave
					has_trait = stubborn
					has_trait = arrogant
				}
			}
			modifier = {
				factor = 2
				any_neighboring_top_liege_realm_owner = {
					this = scope:goldenking
				}
			}
			modifier = {
				add = 10
				scope:nearby_ruler = {
					NOT = { target_is_liege_or_above = scope:goldenking }
					has_dread_level_towards = {
						target = scope:goldenking
						level = 1
					}
				}
			}
			modifier = {
				add = 20
				scope:nearby_ruler = {
					NOT = { target_is_liege_or_above = scope:goldenking }
					has_dread_level_towards = {
						target = scope:goldenking
						level = 2
					}
				}
			}
		}
	}
	option = { # Praise Zigûr!
		name = abrakhan.1003.c
		custom_tooltip = abrakhan.1003.b.tt
		custom_tooltip = abrakhan.1003.b.tt2
		trigger = { religion = { is_in_family = rf_forcesofevil } }
		exclusive = yes
		submit_to_abrakhan_effect = yes
		scope:nearby_ruler = { save_scope_as = submitted_to_abrakhan }
		scope:goldenking = { trigger_event = abrakhan.1004 }
	}
}

abrakhan.1004 = { # Nearby rulers who submit send letter.
	type = letter_event
	opening = abrakhan.1004.opening
	desc = abrakhan.1004.desc
	sender = scope:submitted_to_abrakhan

	option = {
		name = abrakhan.1004.a
	}
}

abrakhan.1005 = { # Hidden, AI Golden King forced to declare war.
	hidden = yes
	scope = none
	immediate = {
		scope:defiant_to_abrakhan.primary_title = {
			save_scope_as = target_title
		}
		random_list = {
			5 = {
				if = {
					# AI Golden King forced to declare war.
					limit = {
						scope:goldenking = { is_ai = yes }
						has_game_rule = default_ai_behavior
					}
					scope:defiant_to_abrakhan.primary_title = {
						save_scope_as = target_title
					}
					scope:goldenking = {
						trigger_event = {
							id = abrakhan.1006
							days = { 300 900 }
						}
					}
				}
				else_if = {
					limit = {
						scope:goldenking = { is_ai = yes }
						has_game_rule = weighted_ai_behavior
					}
					scope:goldenking = {
						trigger_event = {
							id = abrakhan.1006
							days = { 600 2100 }
						}
					}
				}
			}
			5 = {
				add_unpressed_claim = scope:target_title
				make_claim_strong = scope:target_title
			}
		}
	}
	option = {
		name = abrakhan.1004.a
	}
}

abrakhan.1006 = { # AI Forced War
	hidden = yes
	scope = none
	immediate = {
		if = {
			limit = { scope:goldenking = { is_ai = yes } }
			if = {
				limit = {
					exists = scope:target_title.duchy
					scope:goldenking = { is_at_war = no }
				}
				start_war = {
					cb = abrakhan_cb
					target = scope:target_title.holder
					target_title = scope:target_title.duchy
				}
			}
			else = { }
		}
	}
}

abrakhan.1010 = { # Mission unlock 2, Choice of where to send subjugation letters
	content_source = realms_dlc
	type = character_event
	title = abrakhan.1002.t
	desc = {
		desc = abrakhan.1002.desc_start
		triggered_desc = {
			trigger = {
				is_target_in_global_variable_list = {
					name = abrakhan_unlocked_missions
					target = flag:abrakhan_subjugation_nafarat_decision_unlock
				}
				NOT = {
					is_target_in_global_variable_list = {
						name = unavailable_unique_decisions
						target = flag:abrakhan_subjugation_nafarat_decision_complete
					}
				}
			}
			desc = abrakhan.1002.desc_nafarati
		}
		triggered_desc = {
			trigger = {
				is_target_in_global_variable_list = {
					name = abrakhan_unlocked_missions
					target = flag:abrakhan_subjugation_dune_sea_decision_unlock
				}
				NOT = {
					is_target_in_global_variable_list = {
						name = unavailable_unique_decisions
						target = flag:abrakhan_subjugation_dune_sea_decision_complete
					}
				}
			}
			desc = abrakhan.1002.desc_dune_sea
		}
		triggered_desc = {
			trigger = {
				is_target_in_global_variable_list = {
					name = abrakhan_unlocked_missions
					target = flag:abrakhan_subjugation_ray_decision_unlock
				}
				NOT = {
					is_target_in_global_variable_list = {
						name = unavailable_unique_decisions
						target = flag:abrakhan_subjugation_ray_decision_complete
					}
				}
			}
			desc = abrakhan.1002.desc_ray
		}
		triggered_desc = {
			trigger = {
				is_target_in_global_variable_list = {
					name = abrakhan_unlocked_missions
					target = flag:abrakhan_subjugation_bellakar_decision_unlock
				}
				NOT = {
					is_target_in_global_variable_list = {
						name = unavailable_unique_decisions
						target = flag:abrakhan_subjugation_bellakar_decision_complete
					}
				}
			}
			desc = abrakhan.1002.desc_bellakar
		}
		triggered_desc = {
			trigger = {
				is_target_in_global_variable_list = {
					name = abrakhan_unlocked_missions
					target = flag:abrakhan_subjugation_mardruak_decision_unlock
				}
				NOT = {
					is_target_in_global_variable_list = {
						name = unavailable_unique_decisions
						target = flag:abrakhan_subjugation_mardruak_decision_complete
					}
				}
			}
			desc = abrakhan.1002.desc_mardruak
		}
		triggered_desc = {
			trigger = {
				is_target_in_global_variable_list = {
					name = abrakhan_unlocked_missions
					target = flag:abrakhan_subjugation_umbar_decision_unlock
				}
				NOT = {
					is_target_in_global_variable_list = {
						name = unavailable_unique_decisions
						target = flag:abrakhan_subjugation_umbar_decision_complete
					}
				}
			}
			desc = abrakhan.1002.desc_umbar
		}
		triggered_desc = {
			trigger = {
				is_target_in_global_variable_list = {
					name = abrakhan_unlocked_missions
					target = flag:abrakhan_subjugation_near_harad_decision_unlock
				}
				NOT = {
					is_target_in_global_variable_list = {
						name = unavailable_unique_decisions
						target = flag:abrakhan_subjugation_near_harad_decision_complete
					}
				}
			}
			desc = abrakhan.1002.desc_near_harad
		}
		desc = abrakhan.1002.desc_end
	}
	theme = martial
	left_portrait = {
		character = scope:goldenking
		animation = disapproval
	}
	override_background = { reference = throne_room_east }

	trigger = { character_is_valid_for_abrakhan_subjugation_mission_trigger = yes }

	on_trigger_fail = {
		if = {
			limit = { is_ai = no }
			trigger_event = {
				id = abrakhan.1002
				days = { 900 1800 }
			}
		}
	}

	immediate = {
		root = { save_scope_as = goldenking }
		character:lineofsauron = { save_scope_as = sauron }
	}
	
	option = { # Nâfarat
		name = abrakhan.1002.b
		custom_tooltip = abrakhan.1002.a.tt

		trigger = {
			NOR = {
				is_target_in_global_variable_list = {
					name = abrakhan_unlocked_missions
					target = flag:abrakhan_subjugation_nafarat_decision_unlock
				}
				is_target_in_global_variable_list = {
					name = unavailable_unique_decisions
					target = flag:abrakhan_subjugation_nafarat_decision_complete
				}
			}
		}

		every_ruler = {
			limit = {
				is_landed = yes
				is_independent_ruler = yes
				realm_to_title_distance_squared = { title = title:c_abrashadorh value <= 200000 }
				exists = capital_province 
				capital_province = { geographical_region = middleearth_haradwaith_far_abrakhan }
				NOT = { this = character:nazgul3 }
				is_ai = yes
			}
			save_scope_as = nearby_ruler
			trigger_event = {
				id = abrakhan.1003
				days = { 30 60 }
			}
		}
		
		unlock_abrakhan_mission_effect = { MISSION = abrakhan_subjugation_nafarat_decision_unlock }

		ai_chance = {
			base = 1
			modifier = {
				add = 4
				is_ai = yes
			}
		}
	}

	option = { # Dune Sea
		name = abrakhan.1002.a
		custom_tooltip = abrakhan.1002.a.tt
		
		trigger = {
			NOR = {
				is_target_in_global_variable_list = {
					name = unavailable_unique_decisions
					target = flag:abrakhan_subjugation_dune_sea_decision_complete
				}
				is_target_in_global_variable_list = {
					name = abrakhan_unlocked_missions
					target = flag:abrakhan_subjugation_dune_sea_decision_unlock
				}
			}
		}

		every_ruler = {
			limit = {
				is_landed = yes
				is_independent_ruler = yes
				realm_to_title_distance_squared = { title = title:c_abrashadorh value <= 200000 }
				exists = capital_province 
				capital_province = { geographical_region = middleearth_haradwaith_far_dune_sea }
				NOT = { this = character:nazgul3 }
				is_ai = yes
			}
			save_scope_as = nearby_ruler
			trigger_event = {
				id = abrakhan.1003
				days = { 30 60 }
			}
		}

		unlock_abrakhan_mission_effect = { MISSION = abrakhan_subjugation_dune_sea_decision_unlock }
		
		ai_chance = { base = 1 }
	}

	option = { # Rây
		name = abrakhan.1002.d
		custom_tooltip = abrakhan.1002.a.tt
		
		trigger = {
			NOT = {
				is_target_in_global_variable_list = {
					name = abrakhan_unlocked_missions
					target = flag:abrakhan_subjugation_ray_decision_unlock
				}
				is_target_in_global_variable_list = {
					name = unavailable_unique_decisions
					target = flag:abrakhan_subjugation_ray_decision_complete
				}
			}
			OR = {
				is_target_in_global_variable_list = {
					name = unavailable_unique_decisions
					target = flag:abrakhan_subjugation_nafarat_decision_complete
				}
				is_target_in_global_variable_list = {
					name = unavailable_unique_decisions
					target = flag:abrakhan_subjugation_bellakar_decision_complete
				}
			}
		}

		every_ruler = {
			limit = {
				is_landed = yes
				is_independent_ruler = yes
				realm_to_title_distance_squared = { title = title:c_abrashadorh value <= 1000000 }
				exists = capital_province 
				#capital_province = { geographical_region = middleearth_haradwaith_far_bellakar }
				capital_province = { geographical_region = custom_greater_ray }
				NOT = { this = character:nazgul3 }
				is_ai = yes
			}
			save_scope_as = nearby_ruler
			trigger_event = {
				id = abrakhan.1003
				days = { 30 60 }
			}
		}
		
		unlock_abrakhan_mission_effect = { MISSION = abrakhan_subjugation_ray_decision_unlock }
		
		ai_chance = { base = 1 }
	}

	option = { # Bellakar
		name = abrakhan.1002.e
		custom_tooltip = abrakhan.1002.a.tt

		trigger = {
			NOT = { # You shouldn't have unlocked it yet
				is_target_in_global_variable_list = {
					name = abrakhan_unlocked_missions
					target = flag:abrakhan_subjugation_bellakar_decision_unlock
				}
				is_target_in_global_variable_list = {
					name = unavailable_unique_decisions
					target = flag:abrakhan_subjugation_bellakar_decision_complete
				}
			}
			OR = { # You have conquered neighborouing lands
				is_target_in_global_variable_list = {
					name = unavailable_unique_decisions
					target = flag:abrakhan_subjugation_ray_decision_complete
				}
				is_target_in_global_variable_list = {
					name = unavailable_unique_decisions
					target = flag:abrakhan_subjugation_dune_sea_decision_complete
				}
			}
		}

		every_ruler = {
			limit = {
				is_landed = yes
				is_independent_ruler = yes
				exists = capital_province 
				capital_province = { geographical_region = middleearth_haradwaith_far_bellakar }
				NOT = { this = character:nazgul3 }
				is_ai = yes
			}
			save_scope_as = nearby_ruler
			trigger_event = {
				id = abrakhan.1003
				days = { 30 60 }
			}
		}
		
		unlock_abrakhan_mission_effect = { MISSION = abrakhan_subjugation_bellakar_decision_unlock }

		ai_chance = { base = 1 }
	}

	option = { # Mardrûak
		name = abrakhan.1002.f
		custom_tooltip = abrakhan.1002.a.tt

		trigger = {
			NOT = {
				is_target_in_global_variable_list = {
					name = abrakhan_unlocked_missions
					target = flag:abrakhan_subjugation_mardruak_decision_unlock
				}
				is_target_in_global_variable_list = {
					name = unavailable_unique_decisions
					target = flag:abrakhan_subjugation_mardruak_decision_complete
				}
			}
			OR = {
				is_target_in_global_variable_list = {
					name = unavailable_unique_decisions
					target = flag:abrakhan_subjugation_bellakar_decision_complete
				}
				is_target_in_global_variable_list = {
					name = unavailable_unique_decisions
					target = flag:abrakhan_subjugation_umbar_decision_complete
				}
			}
		}

		every_ruler = {
			limit = {
				is_landed = yes
				is_independent_ruler = yes
				exists = capital_province 
				capital_province = { geographical_region = middleearth_haradwaith_far_mardruak }
				NOT = { this = character:nazgul3 }
				is_ai = yes
			}
			save_scope_as = nearby_ruler
			trigger_event = {
				id = abrakhan.1003
				days = { 100 300 }
			}
		}
		
		unlock_abrakhan_mission_effect = { MISSION = abrakhan_subjugation_mardruak_decision_unlock }

		ai_chance = { base = 1 }
	}

	option = { # Near Harad
		name = abrakhan.1002.g
		custom_tooltip = abrakhan.1002.a.tt

		trigger = {
			NOR = {
				is_target_in_global_variable_list = {
					name = abrakhan_unlocked_missions
					target = flag:abrakhan_subjugation_near_harad_decision_unlock
				}
				is_target_in_global_variable_list = {
					name = unavailable_unique_decisions
					target = flag:abrakhan_subjugation_near_harad_decision_complete
				}
			}
			is_target_in_global_variable_list = {
				name = unavailable_unique_decisions
				target = flag:abrakhan_subjugation_dune_sea_decision_complete
			}
			is_target_in_global_variable_list = {
				name = unavailable_unique_decisions
				target = flag:abrakhan_subjugation_umbar_decision_unlock_complete
			}
		}

		every_ruler = {
			limit = {
				is_landed = yes
				is_independent_ruler = yes
				exists = capital_province 
				capital_province = { geographical_region = middleearth_haradwaith_near }
				NOT = { this = character:nazgul3 }
				is_ai = yes
			}
			save_scope_as = nearby_ruler
			trigger_event = {
				id = abrakhan.1003
				days = { 30 60 }
			}
		}

		unlock_abrakhan_mission_effect = { MISSION = abrakhan_subjugation_near_harad_decision_unlock }

		ai_chance = { base = 1 }
	}

	option = { # Umbar
		name = abrakhan.1002.h
		custom_tooltip = abrakhan.1002.a.tt

		trigger = {
			NOR = {
				is_target_in_global_variable_list = {
					name = abrakhan_unlocked_missions
					target = flag:abrakhan_subjugation_umbar_decision_unlock
				}
				is_target_in_global_variable_list = {
					name = unavailable_unique_decisions
					target = flag:abrakhan_subjugation_umbar_decision_complete
				}
			}
			OR = {
				is_target_in_global_variable_list = {
					name = unavailable_unique_decisions
					target = flag:abrakhan_subjugation_mardruak_decision_complete
				}
				is_target_in_global_variable_list = {
					name = unavailable_unique_decisions
					target = flag:abrakhan_subjugation_dune_sea_decision_complete
				}
			}
		}

		every_ruler = {
			limit = {
				is_landed = yes
				is_independent_ruler = yes
				exists = capital_province 
				capital_province = { geographical_region = middleearth_haradwaith_umbar }
				NOT = { this = character:nazgul3 }
				is_ai = yes
			}
			save_scope_as = nearby_ruler
			trigger_event = {
				id = abrakhan.1003
				days = { 30 60 }
			}
		}
		
		unlock_abrakhan_mission_effect = { MISSION = abrakhan_subjugation_umbar_decision_unlock }

		ai_chance = { base = 1 }
	}

	option = { # Fake option/Missions complete
		name = abrakhan.1002.i
		custom_tooltip = abrakhan.1002.i.tt
		trigger = {
			is_target_in_global_variable_list = {
				name = unavailable_unique_decisions
				target = flag:abrakhan_subjugation_dune_sea_decision_complete
			}
			is_target_in_global_variable_list = {
				name = abrakhan_unlocked_missions
				target = flag:abrakhan_subjugation_nafarat_decision_unlock
			}
			is_target_in_global_variable_list = {
				name = abrakhan_unlocked_missions
				target = flag:abrakhan_subjugation_ray_decision_unlock
			}
			is_target_in_global_variable_list = {
				name = abrakhan_unlocked_missions
				target = flag:abrakhan_subjugation_bellakar_decision_unlock
			}
			is_target_in_global_variable_list = {
				name = abrakhan_unlocked_missions
				target = flag:abrakhan_subjugation_mardruak_decision_unlock
			}
			is_target_in_global_variable_list = {
				name = abrakhan_unlocked_missions
				target = flag:abrakhan_subjugation_near_harad_decision_unlock
			}
			is_target_in_global_variable_list = {
				name = abrakhan_unlocked_missions
				target = flag:abrakhan_subjugation_umbar_decision_unlock
			}
		}
	}
}

abrakhan.1020 = { # Nâfarati Subjugation Reward
	content_source = realms_dlc
	type = character_event
	title = abrakhan.1020.t
	desc = abrakhan.1020.desc
	theme = martial

	left_portrait = {
		character = root
		animation = boredom
	}

	override_background = { reference = wilderness_desert }

	immediate = {
		if = {
			limit = {
				exists = title:k_nafarati.holder
				NOT = { root = title:k_nafarati.holder }
			}
			title:k_nafarati.holder ?= { save_scope_as = nafarati_warchief }
		}
		else_if = {
			limit = {
				exists = title:d_sadhradromen.holder
				NOT = { root = title:d_sadhradromen.holder }
			}
			title:d_sadhradromen.holder ?= { save_scope_as = nafarati_warchief }
		}

		trigger_event = {
			id = abrakhan.1010
			days = { 15 30 }
		}
		custom_tooltip = abrakhan.1020.tt
	}
	
	option = { # Under Realm
		name = abrakhan.1020.b
		if = {
			limit = { exists = scope:nafarati_warchief }
			abrakhan_subjugation_nafarat_effect = yes
		}
		ai_chance = { base = 1 }
	}
}

abrakhan.1021 = { # Dune Sea Subjugation Reward
	content_source = realms_dlc
	type = character_event
	title = abrakhan.1021.t
	desc = abrakhan.1021.desc
	theme = martial
	left_portrait = {
		character = scope:goldenking
		animation = scheme
	}
	override_background = { reference = wilderness_desert }
	immediate = {
		root = { save_scope_as = goldenking }
		trigger_event = {
			id = abrakhan.1010
			days = { 15 30 }
		}
	}
	
	option = { # Under Realm
		name = abrakhan.1021.b
		abrakhan_subjugation_dune_sea_effect = yes
		trigger_event = {
			id = abrakhan.1022
			days = { 5 15 }
		}
		ai_chance = { base = 1 }
	}
}

abrakhan.1022 = { # Devastate the Dune Sea Oasis
	content_source = realms_dlc
	type = character_event
	title = abrakhan.1022.t
	desc = abrakhan.1022.desc
	theme = martial
	left_portrait = {
		character = scope:goldenking
		animation = map_worry
	}
	right_portrait = {
		character = scope:sauron
		animation = personality_greedy
	}
	override_background = { reference = wilderness_desert }
	trigger = {
		is_ai = no
		is_available_even_at_war_adult = yes
		character_is_valid_for_abrakhan_subjugation_mission_trigger = yes
		NOT = { has_character_flag = had_event_lotr_yearly_abrakhan_1022 }
	}

	immediate = {
		play_music_cue = "The_Altar_of_Melkor"
		root = { save_scope_as = goldenking }
		character:lineofsauron = { save_scope_as = sauron }
		title:c_mazharath = { save_scope_as = county }
		add_character_flag = had_event_lotr_yearly_abrakhan_1022
		if = {
			limit = {
				exists = title:k_koanoz
				NOT = { this = title:k_koanoz.holder }
			}
			title:k_koanoz.holder = { save_scope_as = scorpion_king }
		}
		else_if = {
			limit = {
				exists = title:d_koanoz
				NOT = { this = title:d_koanoz.holder }
			}
			title:d_koanoz.holder = { save_scope_as = scorpion_king }
		}
		else_if = {
			limit = {
				exists = title:c_mazharath
				NOT = { this = title:c_mazharath.holder }
			}
			title:c_mazharath.holder = { save_scope_as = scorpion_king }
		}
	}
	
	option = { # Devastate the Oasis
		name = abrakhan.1022.a
		add_gold = minor_gold_value
		scope:county = {
			change_development_level = -5
			add_county_modifier = {
				modifier = devastate_oasis_modifier
				years = 25
			}
		}
		ai_chance = { base = 1 }
	}
	option = { # Scorpion Oasis Guard
		name = abrakhan.1022.b
		custom_tooltip = abrakhan.1022.b.tt2
		
		custom_tooltip = abrakhan.1022.b.tt
		spawn_army = {
			uses_supply = no
			inheritable = no
			name = event_scorpion_troops
			men_at_arms = {
				type = giant_scorpions
				stacks = 5
			}
			origin = title:c_mazharath.title_province
			location = capital_province
		}
		scope:county = {
			change_county_control = 100
			add_county_modifier = {
				modifier = scorpion_oasis_guard_modifier
				years = 10
			}
		}
		# ToDo: convert county to scope:goldenking.faith
		hidden_effect = {
			if = {
				limit = {
					exists = scope:scorpion_king
					NOT = { scope:scorpion_king = root }
					is_ai = yes
				}
				add_hook = {
					type = loyalty_hook
					target = scope:scorpion_king
				}
				scope:scorpion_king = {
					set_character_faith = scope:goldenking.faith
					add_gold = medium_gold_value
					add_prestige = medium_prestige_gain
					add_piety = medium_piety_gain
					add_opinion = {
						target = root
						modifier = cruelty_opinion
						opinion = -20
					}
				}
			}
		}
		ai_chance = { base = 0 }
	}
}

### RANDOM EVENTS ###

abrakhan.0010 = { # Abrakhân loredump
	content_source = realms_dlc
	type = character_event
	title = abrakhan.0010.t
	desc = abrakhan.0010.desc
	theme = realm
	left_portrait = {
		character = root
		animation = admiration
	}
	override_background = { reference = wilderness_desert }
	trigger = {
		is_ai = no
		is_available_even_at_war_adult = yes
		NOT = { has_character_flag = had_event_lotr_yearly_abrakhan_0010 }
		OR = {
			culture = { has_cultural_pillar = heritage_southern_apysaic }
			has_trait = nazgul
		}
		capital_province = { geographical_region = middleearth_haradwaith_far_abrakhan }
	}
	immediate = {
		add_character_flag = { flag = had_event_lotr_yearly_abrakhan_0010 }
	}
	option = {
		name = abrakhan.0010.a
		add_character_modifier = {
			modifier = pustic_dreams_modifier
			years = 10
		}
	}
	option = {
		name = abrakhan.0010.b
		trigger = {
			OR = {
				has_culture = culture:pust
				has_title = title:k_abrakhan
			}
		}
		add_character_modifier = {
			modifier = pustic_trade_glory_modifier
			years = 10
		}
	}
	option = {
		name = abrakhan.0010.c
		trigger = { has_title = title:k_abrakhan }
		add_character_modifier = {
			modifier = pustic_dead_kingdom_modifier
			years = 10
		}
	}
}

abrakhan.0011 = { # Pûst loredump
	content_source = realms_dlc
	type = character_event
	title = abrakhan.0011.t
	desc = abrakhan.0011.desc
	theme = realm
	left_portrait = {
		character = root
		animation = personality_rational
	}
	override_background = { reference = wilderness_desert }
	trigger = {
		is_ai = no
		is_available_even_at_war_adult = yes
		NOT = { has_character_flag = had_event_lotr_yearly_abrakhan_0011 }
		OR = {
			has_culture = culture:pust
			has_trait = nazgul
		}
		capital_province = { geographical_region = middleearth_haradwaith_far_abrakhan }
	}
	immediate = {
		add_character_flag = { flag = had_event_lotr_yearly_abrakhan_0011 }
	}
	option = {
		name = abrakhan.0011.a
		add_character_modifier = {
			modifier = pustic_innovation_modifier
			years = 10
		}
		
	}
	option = {
		name = abrakhan.0011.b
		add_character_modifier = {
			modifier = pustic_fossil_water_modifier
			years = 10
		}
	}
	option = {
		name = abrakhan.0011.c
		add_character_modifier = {
			modifier = nafarati_war_council_modifier
			years = 10
		}
	}
}

abrakhan.0020 = { # The Cûl Mahrist (Ancient monster raids county)
	content_source = realms_dlc
	type = character_event
	title = abrakhan.0020.t
	desc = abrakhan.0020.desc
	theme = unfriendly
	left_portrait = {
		character = root
		animation = pain
	}
	override_background = { reference = wilderness_desert }
	trigger = {
		is_ai = no
		is_available_even_at_war_adult = yes
		NOT = { has_character_flag = had_event_lotr_yearly_abrakhan_0020 }
		capital_province = { geographical_region = middleearth_haradwaith_far_abrakhan }
	}
	immediate = {
		add_character_flag = { flag = had_event_lotr_yearly_abrakhan_0020 }
		random_sub_realm_county = {
			limit = {
				title_province = { geographical_region = middleearth_haradwaith_far_abrakhan }
			}
			weight = {
				base = 1
				modifier = {
					add = 10
					OR = {
						title_province = {
							has_building_or_higher = waterfront_plaza_01
							has_building_or_higher = noria_01
							has_building_or_higher = farm_estates_01
							has_building_or_higher = cereal_fields_01
							has_building_or_higher = pastures_01
							has_building_or_higher = plantations_01
							has_building_or_higher = orchards_01
							has_building_or_higher = slave_farms_01
						}
					}
				}
			}
			save_scope_as = raided_county
			change_county_control = -10
			change_development_progress = major_development_progress_loss
			if = {
				limit = { development_towards_level_increase < major_development_progress_gain }
				change_development_level = -1
			}
		}
	}
	option = { # Submit to the One!
		name = abrakhan.0020.a
		trigger = { religion = { is_in_family = rf_forcesofevil } }
		add_piety = major_piety_loss
		duel = {
			skill = martial
			value = 20
			100 = {
				desc = abrakhan.0020.a.critical_success
				compare_modifier = {
					value = scope:duel_value
					multiplier = 0.5
					trigger = { has_trait = zealous }
				}
				send_interface_toast = {
					title = abrakhan.0020.a.critical_success
					left_icon = root
					add_prestige = major_prestige_gain
					spawn_army = {
						men_at_arms = {
							type = dweller_in_the_dark
							stacks = 1
						}
						location = root.capital_province
						name = cul_mahrist_event_troops
					}
					scope:raided_county = {
						add_county_modifier = {
							modifier = cul_mahrist_subdued_modifier
							years = 2
						}
					}
				}
			}
			5 = {
				desc = abrakhan.0020.a.success
				compare_modifier = {
					value = scope:duel_value
					multiplier = 0.5
					trigger = { has_trait = vengeful }	
				}
				compare_modifier = {
					value = scope:duel_value
					multiplier = 0.5
					trigger = { has_trait = desert_warrior }	
				}
				send_interface_toast = {
					title = abrakhan.0020.a.success
					left_icon = root
					add_prestige = medium_prestige_gain
					scope:raided_county = {
						add_county_modifier = {
							modifier = cul_mahrist_subdued_modifier
							years = 2
						}
					}
				}
			}
			10 = {
				desc = abrakhan.0020.a.failure
				compare_modifier = {
					value = scope:duel_value
					multiplier = -0.5
				}
				compare_modifier = {
					value = scope:duel_value
					multiplier = -0.5
					trigger = { has_trait = craven }
				}
				send_interface_toast = {
					title = abrakhan.0020.a.failure
					left_icon = root
					add_prestige = minor_prestige_gain
					scope:raided_county = {
						add_county_modifier = {
							modifier = cul_mahrist_thirsts_modifier
							years = 2
						}
					}
					trigger_event = {
						id = abrakhan.0021
						days = { 300 2100 }
					}
				}
			}
			1 = {
				desc = abrakhan.0020.a.failure
				send_interface_toast = {
					title = abrakhan.0020.a.failure
					left_icon = root
					add_prestige = minor_prestige_gain
					increase_wounds_effect = { REASON = duel }
					scope:raided_county = {
						add_county_modifier = {
							modifier = cul_mahrist_thirsts_modifier
							years = 2
						}
					}
					trigger_event = {
						id = abrakhan.0021
						days = { 300 2100 }
					}
				}
			}
		}
	}
	option = {
		name = abrakhan.0020.b
		scope:raided_county = {
			add_county_modifier = {
				modifier = cul_mahrist_thirsts_modifier
				years = 2
			}
		}
		trigger_event = {
			id = abrakhan.0021
			days = { 300 2100 }
		}
	}
}

abrakhan.0021 = { # The Cûl Mahrist Returns.
	content_source = realms_dlc
	type = character_event
	title = abrakhan.0021.t
	desc = abrakhan.0021.desc
	theme = unfriendly
	left_portrait = {
		character = root
		animation = anger
	}
	override_background = { reference = wilderness_desert }
	trigger = {
		is_ai = no
		is_available_even_at_war_adult = yes
		has_character_flag = had_event_lotr_yearly_abrakhan_0020
		capital_province = { geographical_region = middleearth_haradwaith_far_abrakhan }
	}
	immediate = {
		random_sub_realm_county = {
			limit = { title_province = { geographical_region = middleearth_haradwaith_far_abrakhan } }
			weight = {
				base = 1
				modifier = {
					add = 10
					title_province = {
						OR = {
							has_building_or_higher = waterfront_plaza_01
							has_building_or_higher = noria_01
							has_building_or_higher = farm_estates_01
							has_building_or_higher = cereal_fields_01
							has_building_or_higher = pastures_01
							has_building_or_higher = plantations_01
							has_building_or_higher = orchards_01
							has_building_or_higher = slave_farms_01
						}
					}
				}
			}
			save_scope_as = raided_county
			change_county_control = -10
			change_development_progress = major_development_progress_loss
			if = {
				limit = { development_towards_level_increase < major_development_progress_gain }
				change_development_level = -1
			}
		}
	}
	option = {
		name = abrakhan.0021.a
		trigger = {
			short_term_gold >= activity_medium_gold_value
		}
		show_as_unavailable = {
			short_term_gold < activity_medium_gold_value
		}
		remove_short_term_gold = activity_medium_gold_value
		add_prestige = medium_prestige_gain
	}
	option = {
		name = abrakhan.0021.b
		scope:raided_county = {
			add_county_modifier = {
				modifier = cul_mahrist_thirsts_modifier
				years = 2
			}
		}
	}
}

abrakhan.0025 = { #Desert Amber Expedition
	content_source = realms_dlc
	type = character_event
	title = abrakhan.0025.t
	desc = abrakhan.0025.desc
	theme = stewardship
	left_portrait = {
		character = root
		animation = personality_honorable
	}
	override_background = { reference = wilderness_desert }
	trigger = {
		is_ai = no
		is_available_even_at_war_adult = yes
		capital_province = { geographical_region = middleearth_haradwaith_far_abrakhan }
	}
	immediate = {
		random_sub_realm_county = {
			limit = { title_province = { geographical_region = middleearth_haradwaith_far_abrakhan } }
			weight = {
				base = 1
				modifier = {
					add = 10
					title_province = {
						OR = {
							terrain = red_desert
							terrain = desert_mountains
						}
					}
				}
			}
			save_scope_as = amber_digsite
		}
	}
	option = {
		name = abrakhan.0025.a
		trigger = {
			short_term_gold >= activity_medium_gold_value
		}
		show_as_unavailable = {
			short_term_gold < activity_medium_gold_value
		}
		remove_short_term_gold = activity_medium_gold_value
		add_prestige = medium_prestige_gain
		duel = {
			skill = stewardship
			value = 10
			1 = {
				desc = abrakhan.0025.a.critical_success
				compare_modifier = {
					value = scope:duel_value
					multiplier = 0.5
					trigger = { has_trait = diligent }
				}
				compare_modifier = {
					value = scope:duel_value
					multiplier = 0.5
					trigger = { has_character_modifier = pustic_desert_amber_modifier }
				}
				send_interface_toast = {
					title = abrakhan.0025.a.critical_success
					left_icon = root
					add_prestige = major_prestige_gain
					add_character_modifier = {
						modifier = pustic_desert_amber_modifier
						years = 10
					}
					scope:amber_digsite = {
						add_county_modifier = {
							modifier = pustic_fossil_water_source_modifier
							years = 10
						}
					}
				}
			}
			5 = {
				desc = abrakhan.0025.a.success
				send_interface_toast = {
					title = abrakhan.0025.a.success
					left_icon = root
					add_prestige = medium_prestige_gain
					add_character_modifier = {
						modifier = pustic_desert_amber_modifier
						years = 10
					}
				}
			}
			10 = {
				desc = abrakhan.0025.a.failure
				compare_modifier = {
					value = scope:duel_value
					multiplier = 2
				}
				send_interface_toast = {
					title = abrakhan.0025.a.failure
					left_icon = root
					add_prestige = minor_prestige_gain
				}
			}
		}
	}
	option = {
		name = abrakhan.0025.b
		if = {
			limit = { has_trait = greedy }
			add_gold = medium_gold_value
		}
		else = {
			add_gold = minor_gold_value
		}
	}
}