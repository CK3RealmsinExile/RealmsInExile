namespace = smaug_event_chain

### Smaug Events ### Written by Sakkar
#			smaug_event_chain.00XX		Setup
#			smaug_event_chain.0100		Smaug sacking Erebor and Dale
#			smaug_event_chain.0200		Smaug blocker events

# Setup
smaug_event_chain.0001 = {	# Firing event for all effected rulers
	scope = none
	hidden = yes

	immediate = {
		# Erebor
		if = {
			limit = { title:k_erebor = { is_title_created = yes } }
			title:k_erebor.holder = {
				trigger_event = {
					id = smaug_event_chain.0100 # Smaug sacks rulers holding
				}
			}
		}
		if = {
			limit = { title:d_erebor = { is_title_created = yes } }		
			title:d_erebor.holder = { 
				trigger_event = {
					id = smaug_event_chain.0100 # Smaug sacks rulers holding
				}
			}
		}	
		title:c_throne_of_erebor.holder = { 
			trigger_event = {
				id = smaug_event_chain.0100 # Smaug sacks rulers holding
			}
		}
		title:c_ravenhill.holder = { 
			trigger_event = {
				id = smaug_event_chain.0100 # Smaug sacks rulers holding
			}
		}
		title:c_golddeeps.holder = { 
			trigger_event = {
				id = smaug_event_chain.0100 # Smaug sacks rulers holding
			}
		}
		title:c_golden_hall.holder = { 
			trigger_event = {
				id = smaug_event_chain.0100 # Smaug sacks rulers holding
			}
		}
		title:c_halls_of_steel.holder = {
			trigger_event = {
				id = smaug_event_chain.0100 # Smaug sacks rulers holding
			}
		}
		title:c_great_foundries.holder = {
			trigger_event = {
				id = smaug_event_chain.0100 # Smaug sacks rulers holding
			}
		}
		title:c_arkenhalls.holder = {
			trigger_event = {
				id = smaug_event_chain.0100 # Smaug sacks rulers holding
			}
		}
		
		# Dalelands
		if = {
			limit = { title:d_dalelands = { is_title_created = yes } }	
			title:d_dalelands.holder = {
				trigger_event = {
					id = smaug_event_chain.0100 # Smaug sacks rulers holding
				}
			}
		}	
		title:c_dale.holder = { 
			trigger_event = {
				id = smaug_event_chain.0100 # Smaug sacks rulers holding
			}
		}
		title:c_felagsgard.holder = { 
			trigger_event = {
				id = smaug_event_chain.0100 # Smaug sacks rulers holding
			}
		}
		title:c_lang_marish.holder = { 
			trigger_event = {
				id = smaug_event_chain.0100 # Smaug sacks rulers holding
			}
		}
		# Drakkenvast
		if = {
			limit = { title:d_drakkenvast = { is_title_created = yes } }	
			title:d_drakkenvast.holder = {
				trigger_event = {
					id = smaug_event_chain.0100 # Smaug sacks rulers holding
				}
			}
		}
		title:c_steinholl.holder = { 
			trigger_event = {
				id = smaug_event_chain.0100 # Smaug sacks rulers holding
			}
		}
		title:c_orlmond.holder = { 
			trigger_event = {
				id = smaug_event_chain.0100 # Smaug sacks rulers holding
			}
		}
		title:c_vargurat.holder = { 
			trigger_event = {
				id = smaug_event_chain.0100 # Smaug sacks rulers holding
			}
		}
		
	}
}

# Event chain
smaug_event_chain.0100 = {
    content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0100.title
	#desc = smaug_event_chain.0100.desc
	desc = {
		first_valid = {
			triggered_desc = { #Dwarf desc
				trigger = {
					is_dwarf = yes
				}
				desc = smaug_event_chain.0100.dwarf.desc
			}
			triggered_desc = { #Elf desc
				trigger = {
					is_elf = yes
				}
				desc = smaug_event_chain.0100.elf.desc
			}
			triggered_desc = { #Orc desc
				trigger = {
					is_orc = yes
				}
				desc = smaug_event_chain.0100.orc.desc
			}
			desc = smaug_event_chain.0100.desc
		}
	}
    theme = balrog
	override_background = {
		reference = durins_bane
	}
	cooldown = { days = 10 }

    left_portrait = {
		character = root
		animation = fear
	}

    trigger = {
		is_wastelands = no
		is_independent_ruler = yes
        #OR = {
            # Erebor
        #    has_title = title:k_erebor
        #    has_title = title:d_erebor
		#    has_title = title:c_throne_of_erebor
        #    has_title = title:c_ravenhill
        #    has_title = title:c_golddeeps
        #    has_title = title:c_golden_hall
        #    has_title = title:c_halls_of_steel
        #    has_title = title:c_great_foundries
        #    has_title = title:c_arkenhalls

            # Around Erebor
        #    has_title = title:d_dalelands
        #    has_title = title:c_dale
        #    has_title = title:c_steinholl
        #    has_title = title:c_orlmond
        #    has_title = title:c_vargurat
        #    has_title = title:c_felagsgard
        #    has_title = title:c_lang_marish
        #}
    }
	
    immediate = {
        # Erebor
        title:c_throne_of_erebor = { add_to_list = smaug_desolated_counties }
        title:c_ravenhill = { add_to_list = smaug_desolated_counties }
        title:c_golddeeps = { add_to_list = smaug_desolated_counties }
        title:c_golden_hall = { add_to_list = smaug_desolated_counties }
        title:c_halls_of_steel = { add_to_list = smaug_desolated_counties }
        title:c_great_foundries = { add_to_list = smaug_desolated_counties }
        title:c_arkenhalls = { add_to_list = smaug_desolated_counties }

        # Dale
        title:c_dale = { add_to_list = smaug_desolated_counties }
		title:c_felagsgard = { add_to_list = smaug_desolated_counties }
        title:c_lang_marish = { add_to_list = smaug_desolated_counties }


		# Drakkenvast
        title:c_vargurat = { add_to_list = smaug_desolated_counties }
        title:c_steinholl = { add_to_list = smaug_desolated_counties }
        title:c_orlmond = { add_to_list = smaug_desolated_counties }

		root.primary_title = { save_scope_as = primary_title }
    }


    option = { # Oh no
        name = smaug_event_chain.0100.a

        every_in_list = {
            list = smaug_desolated_counties

			limit = { this.holder.top_liege = root }

			if = {
            	limit = { 
					not = {	this.title_province = { has_holding_type = ruined_holding } }
				}
				
				make_settlement_county_wilderness = { COUNTY = this }
			}

			if = {
				limit = {
					not = {	this.title_province = { has_building = smaug_desolation } } 
				}

            	this.title_province = { add_building = smaug_desolation	}	

            	if = {
                	limit = { 
						AND = {
							this = title:c_throne_of_erebor
							not = {	this.title_province = { has_building = smaug }	}  
						}
					}

                	this.title_province = { add_building = smaug }
            	}
			}	    
        }

        if = {
            limit = { has_title = title:k_erebor }
            destroy_title = title:k_erebor
        }

        if = {
            limit = { has_title = title:d_erebor }
            destroy_title = title:d_erebor
        }

        if = {
            limit = { has_title = title:d_dalelands }
            destroy_title = title:d_dalelands
        }

		if = {
            limit = { has_title = title:d_drakkenvast }
            destroy_title = title:d_drakkenvast
        }

        stress_impact = {
			base = massive_stress_impact_gain
        }    

        if = {
            limit = { # Major News
                NOT = { has_game_rule = no_news }
            }
            every_player = { #Global News Announcement
			    trigger_event = {
                    id = news_event.0035
                    days = 2
                }    
		    }
        }
        trigger_event = {
            id = smaug_event_chain.0101 # makes LAAMPS if unlanded
            days = 4
        }    
    }
}

smaug_event_chain.0101 = {
    content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0101.title
	#desc = smaug_event_chain.0101.desc
	desc = {
		first_valid = {
			triggered_desc = { #Dwarf desc
				trigger = {
					is_dwarf = yes
				}
				desc = smaug_event_chain.0101.dwarf.desc
			}
			triggered_desc = { #Elf desc
				trigger = {
					is_elf = yes
				}
				desc = smaug_event_chain.0101.elf.desc
			}
			triggered_desc = { #Orc desc
				trigger = {
					is_orc = yes
				}
				desc = smaug_event_chain.0101.orc.desc
			}
			desc = smaug_event_chain.0101.desc
		}
	}
    theme = balrog
	override_background = {
		reference = durins_bane
	}

    left_portrait = {
		character = root
		animation = fear
	}

    trigger = {
        is_landed = no
    }

    # You are banished by Smaug (yourself)
    option = {
        name = smaug_event_chain.0101.a

        smaug_become_landless_effect = { BANISHER = root }
    }
}

# Setup event (Hidden magic happens)
smaug_event_chain.0102 = {
	type = character_event
	hidden = yes

	trigger = {
		has_ep3_dlc_trigger = yes
		is_valid_for_laampdom = yes
	}

	on_trigger_fail = {
		#banish = yes
		death = { death_reason = death_disappearance }
	}

	immediate = {
		save_scope_as = adventurer
		if = {
			limit = { exists = liege }

			liege = { save_scope_as = liege }
		}
		add_character_flag = {
			flag = block_for_prison_release_notification
			days = 1
		}
		# AI chance
		if = {
			limit = {
				is_ai = yes
				ai_can_valid_to_create_laamp_trigger = yes
			}

			# Plus for our memory variable.
			add_character_flag = {
				flag = block_for_prison_release_message
				days = 1
			}
			create_title_and_vassal_change = {
				type = revoked
				save_scope_as = change
				add_claim_on_loss = no
			}
			every_held_title = {
				limit = { tier >= tier_county }
				change_title_holder_include_vassals = {
					holder = scope:liege
					change = scope:change
				}
			}
			resolve_title_and_vassal_change = scope:change
			create_landless_adventurer_title_effect = {
				#REASON = flag:exile
				REASON = flag:wanderer
				#FLAVOR_CHAR = scope:actor
				FLAVOR_CHAR = scope:adventurer
			}
			#adventurer_prestige_reset_effect = yes

			if = {
				limit = {
					NOT = {
						government_has_flag = government_is_landless_adventurer
					}
				}
				#banish = yes
				death = { death_reason = death_disappearance }
			}
		}
		# Player event
		else = {
			trigger_event = { id = smaug_event_chain.0103 }
		}
	}
}

# Banished event
smaug_event_chain.0103 = {
	type = character_event
	window = fullscreen_event
	title = smaug_event_chain.0103.t
	#desc = smaug_event_chain.0103.desc
	desc = {
		first_valid = {
			triggered_desc = { #Dwarf desc
				trigger = {
					is_dwarf = yes
				}
				desc = smaug_event_chain.0103.dwarf.desc
			}
			triggered_desc = { #Elf desc
				trigger = {
					is_elf = yes
				}
				desc = smaug_event_chain.0103.elf.desc
			}
			triggered_desc = { #Orc desc
				trigger = {
					is_orc = yes
				}
				desc = smaug_event_chain.0103.orc.desc
			}
			desc = smaug_event_chain.0103.desc
		}
	}
	theme = realm
	left_portrait = {
		character = root
		animation = marshal
	}
	lower_left_portrait = scope:alt_1
	lower_right_portrait = scope:alt_2
	override_background = { reference = ep3_fullscreen_adventurer_negative }
	cooldown = { days = 5 }

	trigger = {
		NOT = { has_character_flag = become_laamp_event_cooldown }
	}

	immediate = {
		add_character_flag = {
			flag = become_laamp_event_cooldown
			days = 5
		}
		save_scope_as = adventurer
		if = {
			limit = { exists = liege }

			liege = { save_scope_as = liege }
		}
		find_playable_relatives_effect = yes
		#adventurer_prestige_reset_effect = yes
	}

	option = {
		name = smaug_event_chain.0103.a
		show_as_tooltip = { banish = yes }
		hidden_effect = {
			create_title_and_vassal_change = {
				type = revoked
				save_scope_as = change
				add_claim_on_loss = no
			}
			every_held_title = {
				limit = { tier >= tier_county }
				change_title_holder_include_vassals = {
					holder = scope:liege
					change = scope:change
				}
			}
			resolve_title_and_vassal_change = scope:change
			# Create Adventurer
			create_landless_adventurer_title_effect = {
				REASON = flag:wanderer
				FLAVOR_CHAR = root
			}
		}
		create_landless_adventurer_title_tooltip_effect = yes
		add_internal_flag = special
	}

	option = {
		name = ep3_laamps.0001.b
		trigger = { exists = scope:alt_1 }
		show_as_tooltip = { banish = yes }
		laamp_switch_playable_character_effect = { NEW_CHARACTER = scope:alt_1 }
		#hidden_effect = { banish = yes }
		hidden_effect = {
			create_title_and_vassal_change = {
				type = revoked
				save_scope_as = change
				add_claim_on_loss = no
			}
			every_held_title = {
				limit = { tier >= tier_county }
				change_title_holder_include_vassals = {
					holder = scope:liege
					change = scope:change
				}
			}
			resolve_title_and_vassal_change = scope:change
			# Create Adventurer
			create_landless_adventurer_title_effect = {
				REASON = flag:wanderer
				FLAVOR_CHAR = root
			}
		}
	}
	option = {
		name = ep3_laamps.0001.c
		trigger = { exists = scope:alt_2 }
		show_as_tooltip = { banish = yes }
		laamp_switch_playable_character_effect = { NEW_CHARACTER = scope:alt_2 }
		#hidden_effect = { banish = yes }
		hidden_effect = {
			create_title_and_vassal_change = {
				type = revoked
				save_scope_as = change
				add_claim_on_loss = no
			}
			every_held_title = {
				limit = { tier >= tier_county }
				change_title_holder_include_vassals = {
					holder = scope:liege
					change = scope:change
				}
			}
			resolve_title_and_vassal_change = scope:change
			# Create Adventurer
			create_landless_adventurer_title_effect = {
				REASON = flag:wanderer
				FLAVOR_CHAR = root
			}
		}
	}
	option = {
		name = ep3_laamps.0001.e
		show_as_tooltip = { death = { death_reason = death_disappearance } }
		laamp_game_over_option_effect = yes
		hidden_effect = { death = { death_reason = death_disappearance } }
	}
}

# Blocker events
smaug_event_chain.0200 = {	#	Desolation of Smaug blocker - Smaug lives
	content_source = realms_dlc
	type = character_event
	title = smaug_event_chain.0200.t
	desc = {
		first_valid = {
			triggered_desc = { #Smaug lives desc
				trigger = {
					title:c_throne_of_erebor.title_province = { has_building = smaug }
				}
				desc = smaug_event_chain.0200.danger.desc
			}
			desc = smaug_event_chain.0200.desc
		}
	}			

	theme = balrog

	left_portrait = {
		character = root
		triggered_animation = {
			trigger = {
				title:c_throne_of_erebor.title_province = { has_building = smaug }
			}
			animation = fear
		}
		triggered_animation = {
			trigger = {
				NOT = { title:c_throne_of_erebor.title_province = { has_building = smaug } }
			}
			animation = personality_rational
		}
		animation = idle
	}

	override_background = {
		reference = wilderness_mountains
	}

	option = { # Settlement cant be further developed
		name = smaug_event_chain.0200.a

		trigger = {
			title:c_throne_of_erebor.title_province = { has_building = smaug }
		}

		send_interface_toast = {
			left_icon = root
			title = smaug_event_chain.0200.a.toast.t
			increase_wounds_effect = { REASON = wild_animal }
			hidden_effect = { scope:obstacle_province = { remove_building = smaug_desolation_cleared } }
			scope:obstacle_province = { add_building = smaug_desolation }
			make_settlement_county_wilderness = {
				COUNTY = scope:obstacle_province.county
			}
		}
		stress_impact = {
			base = major_stress_gain
			craven = major_stress_gain
		}
	}

	option = { # Settlement is further developed
		name = smaug_event_chain.0200.b

		trigger = {
			NOT = { title:c_throne_of_erebor.title_province = { has_building = smaug } }
		}

		send_interface_toast = {
			left_icon = root
			title = smaug_event_chain.0200.b.toast.t
			add_prestige = 50
			hidden_effect = { scope:obstacle_province = { remove_building = smaug_desolation_cleared } }
		}
	}
}