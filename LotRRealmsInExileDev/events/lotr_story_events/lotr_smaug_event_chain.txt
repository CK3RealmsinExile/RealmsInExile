namespace = smaug_event_chain

### Smaug Events ### Written by Sakkar
#			smaug_event_chain.00XX		Setup
#			smaug_event_chain.0100		Smaug sacking Erebor and Dale
#			smaug_event_chain.0200		Smaug blocker events
#			smaug_event_chain.0300		Kill Smaug decision event chain
#			smaug_event_chain.0400		Miscellaneous flavour events


# Setup
smaug_event_chain.0001 = {	# Firing event for all effected rulers
	scope = none
	hidden = yes

	immediate = {
		title:k_durins_dummy = {
			copy_title_history = title:k_longbeards
		}
		
		# Erebor
		title:k_erebor.holder ?= { trigger_event = smaug_event_chain.0100 }
		title:d_erebor = {
			every_de_jure_county_holder = {
				trigger_event = smaug_event_chain.0100 #Smaug sacks rulers holding
			}
		}
		# Dalelands
		title:d_dalelands.holder ?= { trigger_event = smaug_event_chain.0100 }
		title:c_dale.holder ?= { trigger_event = smaug_event_chain.0100 }
		title:c_felagsgard.holder ?= { trigger_event = smaug_event_chain.0100 }
		title:c_lang_marish.holder = { trigger_event = smaug_event_chain.0100 }
	
		# Drakkenvast
		title:d_drakkenvast.holder ?= { trigger_event = smaug_event_chain.0100 }
		title:c_steinholl.holder = { trigger_event = smaug_event_chain.0100 }
		title:c_orlmond.holder = { trigger_event = smaug_event_chain.0100 }
		title:c_vargurat.holder = { trigger_event = smaug_event_chain.0100 }
	}
}

# Event chain
# Fire and Death - Smaug arrives and destruction starts event
smaug_event_chain.0100 = {	
    content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0100.title
	desc = {
		first_valid = {
			triggered_desc = { #Dwarf desc
				trigger = {
					is_dwarf = yes
				}
				desc = smaug_event_chain.0100.dwarf.desc
			}
			triggered_desc = { #Elf desc
				trigger = {
					is_elf = yes
				}
				desc = smaug_event_chain.0100.elf.desc
			}
			triggered_desc = { #Orc desc
				trigger = {
					is_orc = yes
				}
				desc = smaug_event_chain.0100.orc.desc
			}
			desc = smaug_event_chain.0100.desc
		}
	}
    theme = death
	override_background = {
		reference = smaug_arrive
	}
	cooldown = { days = 10 }

    right_portrait = {
		character = root
		animation = fear
	}

    trigger = {
		is_wastelands = no
		is_independent_ruler = yes
    }
	
    immediate = {
        # Erebor
		title:d_erebor = {
			every_de_jure_county = { add_to_list = smaug_desolated_counties }
		}

        # Dale
        title:c_dale = { add_to_list = smaug_desolated_counties }
		title:c_felagsgard = { add_to_list = smaug_desolated_counties }
        title:c_lang_marish = { add_to_list = smaug_desolated_counties }


		# Drakkenvast
        title:c_vargurat = { add_to_list = smaug_desolated_counties }
        title:c_steinholl = { add_to_list = smaug_desolated_counties }
        title:c_orlmond = { add_to_list = smaug_desolated_counties }

		root.primary_title = { save_scope_as = primary_title }

		every_courtier = {
			limit = { is_dwarf = yes } 
			add_to_list = courtiers_list 
		}

		title:d_erebor = { #Add dwarves in Erebor to a list, they become your courtiers after Smaug attacks
			every_de_jure_county_holder = {
				every_courtier = {
					limit = { is_dwarf = yes } 
					add_to_list = courtiers_list 
				}
				if = {
					limit = { is_dwarf = yes }
					add_to_list = courtiers_list 
				}
			}
		}

		title:c_throne_of_erebor.holder = { #Save the Arkenstone if it exists
			every_character_artifact = {
				limit = { has_variable = arkenstone }
				save_scope_as = arkenstone
			}
		}

		if = {
			limit = { 
				AND = {
					NOT = { exists = scope:arkenstone } 
					any_artifact = { has_variable = arkenstone }
				}
			}	

			every_artifact = {
				limit = { 
					AND = {
						has_variable = arkenstone
						artifact_owner.location.county.duchy = title:d_erebor
					}
				}
				save_scope_as = arkenstone		
			}
		}

		save_scope_value_as = { #Thror loses 90% of his gold
			name = lost_gold
			value = {
				value = 0
				add = { 
					value = root.gold
					multiply = 0.9
				}	
			}	
		}

		dynasty:dynasty_aivadiuria = {
			every_dynasty_member = {
				add_character_flag = ai_immune_to_mental_breaks
				add_character_flag = immune_to_disease
			}
		}
    }


    option = {
        name = smaug_event_chain.0100.a

		remove_short_term_gold = scope:lost_gold #Remove 90% of held gold
		custom_tooltip = smaug_event_chain.0100.a.tt

		hidden_effect = { #Handle Tributaries/Destroying Duke/Kingdom titles
			every_tributary = { #Free all tributaries
				limit = { suzerain = root }
				end_tributary = yes
			}

        	every_in_list = {
            	list = smaug_desolated_counties
				limit = { this.holder.top_liege = root }

				if = {
            		limit = { NOT = { title_province = { has_holding_type = ruined_holding } } }
					make_settlement_county_wilderness = { COUNTY = this }
				}

				if = {
					limit = { NOT = { title_province = { has_building = smaug_desolation } } }
            		title_province = { add_building = smaug_desolation	}	

            		if = {
                		limit = { 
							AND = {
								this = title:c_throne_of_erebor
								NOT = {	title_province = { has_building = smaug }	}  
							}
						}
                		title_province = { add_building = smaug }
            		}

					if = { #Dale Destroyed, Special removed
                		limit = { 
							AND = {
								this = title:c_dale
								title_province = { has_building = wonder_market_of_dale }  
							}
						}
                		title_province = { remove_building = wonder_market_of_dale }
            		}

					if = { #Dale Destroyed, Special removed
                		limit = { 
							AND = {
								this = title:c_dale
								this.title_province = { has_building = wonder_market_of_dale }  
							}
						}

                		this.title_province = { remove_building = wonder_market_of_dale }
            		}

					if = {
                		limit = { 
							AND = {
								this = title:c_throne_of_erebor
								title_province = { has_building_or_higher = erebor_mines_01 }  
							}
						}
                		title_province = { remove_building_any_level_max_6 = { BUILDING = erebor_mines } }
            		}

					if = {
                		limit = { 
							AND = {
								this = title:c_throne_of_erebor
								title_province = { has_building_or_higher = economic_specialization_01 }  
							}
						}
						if = {
							limit = { title_province = { has_building = economic_specialization_01 } }
							title_province = { remove_building =  economic_specialization_01 } 
						}
						if = {
							limit = { title_province = { has_building = economic_specialization_02 } }
							title_province = { remove_building =  economic_specialization_02 } 
						}
						if = {
							limit = { title_province = { has_building = economic_specialization_03 } }
							title_province = { remove_building =  economic_specialization_03 } 
						}
            		}
				}	    
        	}
			
			every_held_title = {
				limit = { tier > tier_county }
				holder = { destroy_title = prev }
			}
		}	   

        if = { #Major News
    		limit = {
        	    NOT = { has_game_rule = no_news }
            }
            every_player = { #Global News Announcement
			    trigger_event = {
                    id = news_event.0050
                    days = 2
                }    
		    }
        }

		if = { #Handling Girion of Dale effects
			limit = {
				dynasty = dynasty:dynasty_aivadiuria
				NOT = { this = title:c_esgaroth.holder }
				NOT = { title:c_esgaroth.holder = title:k_wastelands.holder }
				title:c_esgaroth.holder = { is_ai = yes }
			}
			if = { #Effects for AI
				limit = { 
					is_ai = yes
					title:c_esgaroth.holder = { is_ai = yes }
				}
				depose = yes
				every_close_or_extended_family_member = {
					limit = { 
						is_landed = no 
						is_landless_adventurer = no 
						NOT = { employer = title:c_esgaroth.holder }
					}
					set_employer = title:c_esgaroth.holder
				}
				set_employer = title:c_esgaroth.holder
			}
			if = { #Effects for Player
				limit = {
					is_ai = no
					title:c_esgaroth.holder = { is_ai = yes }
				}
				set_designated_heir_unsafe = title:c_harbjarg.holder
				trigger_event = { #Player Girion gets option to play lake town
					id = smaug_event_chain.0402
					days = 3
				}
			}
		}

		#Makes LAAMPs if unlanded
		if = {
			limit = { 
				has_ep3_dlc_trigger = yes
				NOT = {
					any_county = {
						holder.top_liege = root
						NOT = { is_in_list = smaug_desolated_counties }
					}
					AND = {
						is_ai = yes
						dynasty = dynasty:dynasty_aivadiuria
					}
				}	 
			}
			hidden_effect = {
				create_landless_adventurer_title_effect = {
					REASON = flag:wanderer
					FLAVOR_CHAR = root
				}
				
				root.primary_title = {
					set_coa = holder.house
					copy_title_history = title:k_durins_dummy
				}
				if = {
					limit = {
						dynasty = dynasty:dynasty_durin
						is_dynast = yes
					} 
					root.primary_title = {
						set_title_name = Thror_camp_name
					}
				}
			}
			trigger_event = {
				id = smaug_event_chain.0101 
				days = 4
			}  
			custom_tooltip = {
				text = arkenstone_destroyed
				if = {
					limit = {
						exists = scope:arkenstone
					}
					destroy_artifact = scope:arkenstone
				}
			}	
		}

		hidden_effect = {
			character:lineofdale36 ?= { # Makes Girion change house to the Girionsson house his son canonically founds
				if = {
					limit = {
						is_alive = yes
						is_landed = yes
						NOT = { house = house:house_girion } # This event is fired through multiple people, this should ensure this effect isn't being fired multiple times and keeps Girion as the house head
					}
					set_house = house:house_girion

					every_child = {
						set_house = house:house_girion
						if = {
							limit = { age >= 16 }
							every_child = {
								set_house = house:house_girion
							}
						}
					}
				}
			}
		}
	}

	after = {
		hidden_effect = { 
			every_in_list = {
				list = courtiers_list
				limit = {
					is_landed = no
					NOT = { host = root }
				}
				root = { add_courtier = prev }
			}
		}
	}
}

# The Escape - flavour event about escaping from destruction
smaug_event_chain.0101 = {
    content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0101.title
	#desc = smaug_event_chain.0101.desc
	desc = {
		first_valid = {
			triggered_desc = { #Dwarf desc
				trigger = {
					is_dwarf = yes
				}
				desc = smaug_event_chain.0101.dwarf.desc
			}
			triggered_desc = { #Elf desc
				trigger = {
					is_elf = yes
				}
				desc = smaug_event_chain.0101.elf.desc
			}
			triggered_desc = { #Orc desc
				trigger = {
					is_orc = yes
				}
				desc = smaug_event_chain.0101.orc.desc
			}
			desc = smaug_event_chain.0101.desc
		}
	}
    theme = death
	override_background = {
		reference = smaug_destruction
	}

    right_portrait = {
		character = root
		animation = fear
	}

    trigger = {
        is_landed = no
    }

    # You are banished by Smaug (yourself)
    option = {
        name = smaug_event_chain.0101.a

		hidden_effect = {
        	trigger_event = { id = smaug_event_chain.0102 }
		}	
    }
}

# Setup event (setting up landless)
smaug_event_chain.0102 = {
	type = character_event
	hidden = yes

	trigger = {
		has_ep3_dlc_trigger = yes
	}

	on_trigger_fail = {
		#banish = yes
		death = { death_reason = death_disappearance }
	}

	immediate = {
		save_scope_as = adventurer
		if = {
			limit = { exists = liege }

			liege = { save_scope_as = liege }
		}
		add_character_flag = {
			flag = block_for_prison_release_notification
			days = 1
		}
		# AI chance
		if = {
			limit = {
				is_ai = yes
			}

			# Plus for our memory variable.
			add_character_flag = {
				flag = block_for_prison_release_message
				days = 1
			}
			# move camp away from Erebor
			scope:adventurer = {
				trigger_event = { id = smaug_event_chain.0104 }
			}

			if = {
				limit = {
					NOT = {
						government_has_flag = government_is_landless_adventurer
					}
				}
				death = { death_reason = death_disappearance }
			}
		}
		# Player event
		else = {
			trigger_event = { id = smaug_event_chain.0103 }
		}
	}
}

# The Aftermath - base game like event leting player choose if they want to play landless or not
smaug_event_chain.0103 = {
	type = character_event
	window = fullscreen_event
	title = smaug_event_chain.0103.t
	#desc = smaug_event_chain.0103.desc
	desc = {
		first_valid = {
			triggered_desc = { #Dwarf desc
				trigger = {
					is_dwarf = yes
				}
				desc = smaug_event_chain.0103.dwarf.desc
			}
			triggered_desc = { #Elf desc
				trigger = {
					is_elf = yes
				}
				desc = smaug_event_chain.0103.elf.desc
			}
			triggered_desc = { #Orc desc
				trigger = {
					is_orc = yes
				}
				desc = smaug_event_chain.0103.orc.desc
			}
			desc = smaug_event_chain.0103.desc
		}
	}
	theme = realm
	left_portrait = {
		character = root
		animation = marshal
	}
	lower_left_portrait = scope:alt_1
	lower_right_portrait = scope:alt_2
	override_background = { reference = ep3_fullscreen_adventurer_negative }
	cooldown = { days = 5 }

	trigger = {
		NOT = { has_character_flag = become_laamp_event_cooldown }
	}

	immediate = {
		add_character_flag = {
			flag = become_laamp_event_cooldown
			days = 5
		}
		save_scope_as = adventurer
		if = {
			limit = { exists = liege }

			liege = { save_scope_as = liege }
		}
		find_playable_relatives_effect = yes
	}

	option = {
		name = smaug_event_chain.0103.a
		show_as_tooltip = { banish = yes }
		hidden_effect = {
			scope:adventurer = {
				if = {
					limit = { NOT = { this = character:lineofdurin81 } }
						
					trigger_event = { id = smaug_event_chain.0104 }
				}
				else = {
					trigger_event = { id = smaug_event_chain.0105 }
				}
			}
		}
		create_landless_adventurer_title_tooltip_effect = yes
		add_internal_flag = special
	}

	option = {
		name = ep3_laamps.0001.b
		trigger = { exists = scope:alt_1 }
		show_as_tooltip = { banish = yes }
		laamp_switch_playable_character_effect = { NEW_CHARACTER = scope:alt_1 }
		hidden_effect = {
			scope:adventurer = {
				if = {
					limit = { NOT = { this = character:lineofdurin81 } }
						
					trigger_event = { id = smaug_event_chain.0104 }
				}
				else = {
					trigger_event = { id = smaug_event_chain.0105 }
				}
			}
		}
	}
	option = {
		name = ep3_laamps.0001.c
		trigger = { exists = scope:alt_2 }
		show_as_tooltip = { banish = yes }
		laamp_switch_playable_character_effect = { NEW_CHARACTER = scope:alt_2 }
		hidden_effect = {
			scope:adventurer = {
				if = {
					limit = { NOT = { this = character:lineofdurin81 } }
						
					trigger_event = { id = smaug_event_chain.0104 }
				}
				else = {
					trigger_event = { id = smaug_event_chain.0105 }
				}
			}
		}
	}
	option = {
		trigger = { is_ai = no }

		name = ep3_laamps.0001.e
		show_as_tooltip = { death = { death_reason = death_disappearance } }
		laamp_game_over_option_effect = yes
		hidden_effect = { death = { death_reason = death_disappearance } }
	}
}

# moving landless away from Erebor
smaug_event_chain.0104 = {
	type = character_event
	hidden = yes
	
	immediate = {
        title:c_zurkharukh = { add_to_list = target_counties_list }
        title:c_edricsborg = { add_to_list = target_counties_list }
        title:c_cerin_arhendhiril = { add_to_list = target_counties_list }
        title:c_aradhrynd = { add_to_list = target_counties_list }
        title:c_tham_aeldir = { add_to_list = target_counties_list }
        title:c_caras_tilion = { add_to_list = target_counties_list }
        title:c_ulgerstat = { add_to_list = target_counties_list }
		title:c_esgaroth = { add_to_list = target_counties_list }
		title:c_londaroth = { add_to_list = target_counties_list }
		title:c_hrafnvild = { add_to_list = target_counties_list }

		random_in_list = {
			list = target_counties_list
			save_scope_as = target_county
		}

		root = {
			show_as_tooltip = {
				domicile = {
					move_domicile = scope:target_county.title_province
				}
			}
			set_variable = cannot_cancel_travel
			start_travel_plan = {
				destination = scope:target_county.title_province
				travel_with_domicile = yes
				return_trip = no
				players_use_planner = no
				on_arrival_destinations = last
			}	
		}
    }	
}

# Moving Thror away from Erebor
smaug_event_chain.0105 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0105.title
	desc = smaug_event_chain.0105.desc

    theme = realm
	override_background = {
		reference = wilderness_steppe
	}

    left_portrait = {
		character = root
		animation = personality_bold
	}

	immediate = {
		scope:adventurer.primary_title = {
			save_scope_as = camp_name
		}
		hidden_effect = {
			domicile = {
				change_provisions = monumental_provisions_gain
			}
		}
	}

	# Travel to Dunland
	option = {
		name = smaug_event_chain.0105.a

		add_prestige = medium_prestige_gain
		stress_impact = {
			base = minor_stress_impact_loss
        }   
		custom_tooltip = smaug_event_chain.0105.a.tt

		hidden_effect = {
			show_as_tooltip = {
				domicile = {
					move_domicile = title:c_earcnoc.title_province
				}
			}
			set_variable = cannot_cancel_travel
			start_travel_plan = {
				destination = title:c_earcnoc.title_province
				travel_with_domicile = yes
				return_trip = no
				players_use_planner = no
				on_arrival_destinations = last
			}
			trigger_event = { id = smaug_event_chain.0106 }

			# Nar fills food storage
			trigger_event = {
				id = smaug_event_chain.0400
				days = { 150 180 }
			}

			# Fighting brigands with Nar by side
			trigger_event = {
				id = smaug_event_chain.0401
				days = { 90 360 }
			}
		}		
	}

	# Travel to Blue Mountiens
	option = {
		name = smaug_event_chain.0105.b

		trigger = { is_ai = no }
		stress_impact = {
			base = minor_stress_impact_gain
        }
		custom_tooltip = smaug_event_chain.0105.b.tt
		
		custom_tooltip = Thror_end_of_chain.tt

		hidden_effect = {
			show_as_tooltip = {
				domicile = {
					move_domicile = title:c_thorins_hall.title_province
				}
			}
			set_variable = cannot_cancel_travel
			start_travel_plan = {
				destination = title:c_central_high_pass.title_province
				destination = title:c_thorins_hall.title_province
				travel_with_domicile = yes
				return_trip = no
				players_use_planner = no
				on_arrival_destinations = last
			}

			# Nar fills food storage
			trigger_event = {
				id = smaug_event_chain.0400
				days = { 150 220 }
			}

			# Fighting brigands with Nar by side
			trigger_event = {
				id = smaug_event_chain.0401
				days = { 120 450 }
			}
		}		
	}
	
	# Travel to Iron Hills
	option = {
		name = smaug_event_chain.0105.c

		trigger = { is_ai = no }

		add_prestige = medium_prestige_loss
		stress_impact = {
			base = minor_stress_impact_gain
        }
		custom_tooltip = smaug_event_chain.0105.c.tt
		
		custom_tooltip = Thror_end_of_chain.tt

		hidden_effect = {
			show_as_tooltip = {
				domicile = {
					move_domicile = title:c_azanulinbar_dum.title_province
				}
			}
			set_variable = cannot_cancel_travel
			start_travel_plan = {
				destination = title:c_azanulinbar_dum.title_province
				travel_with_domicile = yes
				return_trip = no
				players_use_planner = no
				on_arrival_destinations = last
			}

			trigger_event = {
				id = smaug_event_chain.0400
				days = { 60 90 }
			}
		}		
	}
}	

# Hidden set up event - Thror wandering for 20 years before trying to enter Moria
smaug_event_chain.0106 = {
	type = character_event
	hidden = yes

	immediate = {
		trigger_event = {
			id = smaug_event_chain.0107
			days = 7300
		}
	}
}

# Hidden set up event - Figuring out if Thror is landless adventurer, ruler or landless.
smaug_event_chain.0107 = {
	type = character_event
	hidden = yes

	trigger = {
		character:lineofdurin81 = { is_alive = yes}
	}

	immediate = {
		if = {
			limit = { 
				title:c_east_hall.holder.top_liege = {
					is_orc = yes
				}
			}
			title:c_east_hall.holder.top_liege = {
				save_scope_as = Orc_in_moria
			}
		}

		if = {
			limit = {
				NOT = { 
					exists = scope:Orc_in_moria
				}
				title:c_durins_hall.holder.top_liege = {
					is_orc = yes
				}
			}
			title:c_durins_hall.holder.top_liege = {
				save_scope_as = Orc_in_moria
			}
		}

		if = {
			limit = {
				NOT = { 
					exists = scope:Orc_in_moria
				}
				title:c_endless_stair.holder.top_liege = {
					is_orc = yes
				}
			}
			title:c_endless_stair.holder.top_liege = {
				save_scope_as = Orc_in_moria
			}
		}

		if = {
			limit = {
				NOT = { 
					exists = scope:Orc_in_moria
				}
				title:c_chamber_of_mazarbul.holder.top_liege = {
					is_orc = yes
				}
			}
			title:c_chamber_of_mazarbul.holder.top_liege = {
				save_scope_as = Orc_in_moria
			}
		}

		if = {
			limit = {
				NOT = { 
					exists = scope:Orc_in_moria
				}
				title:c_hall_of_a_thousand_pillars.holder.top_liege = {
					is_orc = yes
				}
			}
			title:c_hall_of_a_thousand_pillars.holder.top_liege = {
				save_scope_as = Orc_in_moria
			}
		}

		if = {
			limit = {
				NOT = { 
					exists = scope:Orc_in_moria
				}
				title:c_central_halls.holder.top_liege = {
					is_orc = yes
				}
			}
			title:c_central_halls.holder.top_liege = {
				save_scope_as = Orc_in_moria
			}
		}

		if = {
			limit = {
				NOT = { 
					exists = scope:Orc_in_moria
				}
				title:c_west_hall.holder.top_liege = {
					is_orc = yes
				}
			}
			title:c_west_hall.holder.top_liege = {
				save_scope_as = Orc_in_moria
			}
		}

		if = {
			limit = {
				NOT = { 
					exists = scope:Orc_in_moria
				}
				title:c_great_mines.holder.top_liege = {
					is_orc = yes
				}
			}
			title:c_great_mines.holder.top_liege = {
				save_scope_as = Orc_in_moria
			}
		}

		if = {
			limit = {
				NOT = { 
					exists = scope:Orc_in_moria
				}
				title:c_zirin_kuk.holder.top_liege = {
					is_orc = yes
				}
			}
			title:c_zirin_kuk.holder.top_liege = {
				save_scope_as = Orc_in_moria
			}
		}
		
		if = {
			limit = {
				#exists = scope:Orc_in_moria
				NOR = {
					title:c_east_hall.holder.top_liege = character:lineofdurin81
					title:c_durins_hall.holder.top_liege = character:lineofdurin81
					title:c_endless_stair.holder.top_liege = character:lineofdurin81
					title:c_chamber_of_mazarbul.holder.top_liege = character:lineofdurin81
					title:c_hall_of_a_thousand_pillars.holder.top_liege = character:lineofdurin81
					title:c_central_halls.holder.top_liege = character:lineofdurin81
					title:c_west_hall.holder.top_liege = character:lineofdurin81
					title:c_great_mines.holder.top_liege = character:lineofdurin81
					title:c_zirin_kuk.holder.top_liege = character:lineofdurin81

					title:c_east_hall.holder = character:lineofdurin81
					title:c_durins_hall.holder = character:lineofdurin81
					title:c_endless_stair.holder = character:lineofdurin81
					title:c_chamber_of_mazarbul.holder = character:lineofdurin81
					title:c_hall_of_a_thousand_pillars.holder = character:lineofdurin81
					title:c_central_halls.holder = character:lineofdurin81
					title:c_west_hall.holder = character:lineofdurin81
					title:c_great_mines.holder = character:lineofdurin81
					title:c_zirin_kuk.holder = character:lineofdurin81
				}
				NOR = {	
					character:lineofdurin81.location.county.kingdom = title:k_khazad_dum
					character:lineofdurin81.location.county.kingdom = title:k_southern_misties
				}
			}

			character:lineofdurin81 = {
				# Thror is landless ruler
				if = {
					limit = { 
						is_landed = no
						#OR = {
							#is_landed = yes
							#is_landless_adventurer = yes
							#is_landed = no
						#}
					}	
					trigger_event = { id = smaug_event_chain.0108 }
				}
				# Thror is not landed nor adventurer
				#else = {
				#	trigger_event = { id = smaug_event_chain.0109 }
				#}
			}
		}
		#else_if = {	# There is on orc in Moria end of chain
		#	limit = { NOT = { exists = scope:Orc_in_moria }}
		#	trigger_event = {
		#		id = smaug_event_chain.0116
		#	}
		#}
		#else_if = {	# You hold county in Moria end of chain
		#	limit = { 
		#		OR = {
		#			title:c_east_hall.holder.top_liege = character:lineofdurin81
		#			title:c_durins_hall.holder.top_liege = character:lineofdurin81
		#			title:c_endless_stair.holder.top_liege = character:lineofdurin81
		#			title:c_chamber_of_mazarbul.holder.top_liege = character:lineofdurin81
		#			title:c_hall_of_a_thousand_pillars.holder.top_liege = character:lineofdurin81
		#			title:c_central_halls.holder.top_liege = character:lineofdurin81
		#			title:c_west_hall.holder.top_liege = character:lineofdurin81
		#			title:c_great_mines.holder.top_liege = character:lineofdurin81
		#			title:c_zirin_kuk.holder.top_liege = character:lineofdurin81

		#			title:c_east_hall.holder = character:lineofdurin81
		#			title:c_durins_hall.holder = character:lineofdurin81
		#			title:c_endless_stair.holder = character:lineofdurin81
		#			title:c_chamber_of_mazarbul.holder = character:lineofdurin81
		#			title:c_hall_of_a_thousand_pillars.holder = character:lineofdurin81
		#			title:c_central_halls.holder = character:lineofdurin81
		#			title:c_west_hall.holder = character:lineofdurin81
		#			title:c_great_mines.holder = character:lineofdurin81
		#			title:c_zirin_kuk.holder = character:lineofdurin81
		#		}
		#	}
		#	trigger_event = {
		#		id = smaug_event_chain.0117
		#	}
		#}
		else_if = {	# You are located in Moria end of chain
			limit = { 
				OR = {	
					character:lineofdurin81.location.county.kingdom = title:k_khazad_dum
					character:lineofdurin81.location.county.kingdom = title:k_southern_misties
				}
			}
			trigger_event = {
				id = smaug_event_chain.0118
			}
		}
	}
}

# Thror moves to Moria
smaug_event_chain.0108 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0108.title
	desc = smaug_event_chain.0108.desc

    theme = realm
	override_background = {
		reference = wilderness
	}

	left_portrait = {
		character = root
		animation = personality_bold
	}

	right_portrait = {
		character = scope:Thror_primary_heir
		animation = personality_rational
	}

	trigger = {
		exists = primary_heir
		primary_heir = {
			dynasty = root.dynasty
			age >= 20
		}
	}

	immediate = {
		primary_heir = {
			save_scope_as = Thror_primary_heir
		}
		save_scope_as = Thror
	}

	option = {
		name = smaug_event_chain.0108.a

		custom_tooltip = smaug_event_chain.0108.a.tt

		hidden_effect = {
			add_character_flag = doesnt_care_about_their_ring

			set_variable = cannot_cancel_travel

			if = {
				limit = { root.location = title:b_celusirannon.title_province }

				start_travel_plan = {
					destination = title:b_agruskub.title_province
					destination = title:b_mirrormere.title_province
					destination = title:c_east_hall.title_province
					travel_with_domicile = no
					return_trip = no
					players_use_planner = no
					on_arrival_event = smaug_event_chain.0111
					on_arrival_destinations = last
				}
			}

			else = {
				start_travel_plan = {
					destination = title:b_mirrormere.title_province
					destination = title:c_east_hall.title_province
					travel_with_domicile = no
					return_trip = no
					players_use_planner = no
					on_arrival_event = smaug_event_chain.0111
					on_arrival_destinations = last
				}
			}	
		}

		every_character_artifact = {
			set_owner = {
				target = scope:Thror_primary_heir
				history = {
					location = character:lineofdurin81.location
					actor = character:lineofdurin81
					recipient = scope:Thror_primary_heir
					type = given
				}
			}
		}

		trigger_event = {
			id = smaug_event_chain.0110
			days = 5
		}
	}
}


# Thror landless advnturer moves to Moria
#smaug_event_chain.0109 = {
#	type = character_event
#	hidden = yes
#
#	immediate = {
#		if = {
#			limit = { character:lineofdurin82 = { is_alive = yes } }
#			character:lineofdurin82 = {
#				save_scope_as = Thror_primary_heir
#			}
#		}
#		else_if = {
#			limit = { character:lineofdurin83 = { is_alive = yes } }
#			character:lineofdurin83 = {
#				save_scope_as = Thror_primary_heir
#			}
#		}
#		else_if = {
#			limit = { 
#				any_child = { is_alive = yes } 
#			}
#			random_child = {
#				limit = { is_alive = yes } 
#				save_scope_as = Thror_primary_heir
#			}
#		}
#		else_if = {
#			limit = { 
#				any_extended_family_member = { is_alive = yes } 
#			}
#			random_extended_family_member= {
#				limit = { is_alive = yes } 
#				save_scope_as = Thror_primary_heir
#			}
#		}
#
#		create_landless_adventurer_title_effect = {
#			REASON = flag:wanderer
#			FLAVOR_CHAR = character:lineofdurin81
#		}
#		this.primary_title = {
#			set_coa = this.holder.house
#		}
#		this.primary_title = {
#			set_title_name = Thror_camp_name_khazad_dum
#		}
#		hidden_effect = {
#			show_as_tooltip = {
#				domicile = {
#					move_domicile = title:c_east_hall.title_province
#				}
#			}
#
#			set_variable = cannot_cancel_travel
#			if = {
#				limit = { root.location = title:b_celusirannon.title_province }
#
#				start_travel_plan = {
#					destination = title:b_agruskub.title_province
#					destination = title:b_mirrormere.title_province
#					destination = title:c_east_hall.title_province
#					travel_with_domicile = no
#					return_trip = no
#					players_use_planner = no
#					on_arrival_event = smaug_event_chain.0111
#					on_arrival_destinations = last
#				}
#			}
#
#			else = {
#				start_travel_plan = {
#					destination = title:b_mirrormere.title_province
#					destination = title:c_east_hall.title_province
#					travel_with_domicile = no
#					return_trip = no
#					players_use_planner = no
#					on_arrival_event = smaug_event_chain.0111
#					on_arrival_destinations = last
#				}
#			}
#		}
#		every_character_artifact = {
#			set_owner = {
#				target = scope:Thror_primary_heir
#				history = {
#					location = character:lineofdurin81.location
#					actor = character:lineofdurin81
#					recipient = scope:Thror_primary_heir
#					type = given
#				}
#			}
#		}
#
#		trigger_event = {
#			id = smaug_event_chain.0110
#			days = 5
#		}
#	}
#}

# Nar joins Thror
smaug_event_chain.0110 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0110.title
	desc = {
		first_valid = {
			triggered_desc = { # Nár is in your camp
				trigger = {
					any_courtier = { this = character:lineofnar1 }
				}
				desc = smaug_event_chain.0110.desc
			}
			desc = smaug_event_chain.0110.no_nar.desc
		}
	}

    theme = realm
	override_background = {
		reference = wilderness
	}

	left_portrait = {
		character = root
		animation = lantern
	}

	right_portrait = {
		character = scope:Nar
		animation = personality_bold
	}

	immediate = {
		hidden_effect = {
			current_travel_plan = {
				every_entourage_character = {
					limit = { NOT = { this = character:lineofdurin81 } }
					current_travel_plan = { remove_character = prev }
				}
			}
		
			if = {
				limit = { any_courtier = { this = character:lineofnar1 } }
				character:lineofnar1 = {
					save_scope_as = Nar
				}
			}
			else = {
				random_courtier = {
					save_scope_as = Nar
				}
			}
		}
	}	

	option = {
		name = smaug_event_chain.0110.a

		trigger = {
			any_courtier = { this = character:lineofnar1 }
		}

		custom_tooltip = smaug_event_chain.0110.a.tt

		hidden_effect = {
			root.current_travel_plan = {
				add_companion = scope:Nar
			}
		}		
	}
	
	option = {
		name = smaug_event_chain.0110.b

		trigger = {
			NOT = { any_courtier = { this = character:lineofnar1 } }
		}

		custom_tooltip = smaug_event_chain.0110.a.tt

		hidden_effect = {
			root.current_travel_plan = {
				add_companion = scope:Nar
			}
		}	
	}
}

# Thror enter Moria
smaug_event_chain.0111 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0111.title
	#desc = smaug_event_chain.0111.desc

	desc = {
		first_valid = {
			triggered_desc = { #There is orc
				trigger = {
					OR = {
						title:c_east_hall.holder.top_liege = {
							is_orc = yes
						}
						title:c_durins_hall.holder.top_liege = {
							is_orc = yes
						}
						title:c_endless_stair.holder.top_liege = {
							is_orc = yes
						}
						title:c_chamber_of_mazarbul.holder.top_liege = {
							is_orc = yes
						}
						title:c_hall_of_a_thousand_pillars.holder.top_liege = {
							is_orc = yes
						}
						title:c_central_halls.holder.top_liege = {
							is_orc = yes
						}
						title:c_west_hall.holder.top_liege = {
							is_orc = yes
						}
						title:c_great_mines.holder.top_liege = {
							is_orc = yes
						}
						title:c_zirin_kuk.holder.top_liege = {
							is_orc = yes
						}
					}
				}
				desc = smaug_event_chain.0111.desc
			}
			desc = smaug_event_chain.0111.no_orc.desc	#No orc in Moria
		}
	}

    theme = realm
	override_background = {
		reference = wilderness
	}

	left_portrait = {
		character = root
		animation = personality_bold
	}

	immediate = {
		hidden_effect = {
			current_travel_plan = { 
				delay_travel_plan = { days = 60 }
			}
		}

		if = {
			limit = { 
				title:c_east_hall.holder.top_liege = {
					is_orc = yes
				}
			}
			title:c_east_hall.holder.top_liege = {
				save_scope_as = Azog
			}
		}

		if = {
			limit = {
				NOT = { 
					exists = scope:Azog
				}
				title:c_durins_hall.holder.top_liege = {
					is_orc = yes
				}
			}
			title:c_durins_hall.holder.top_liege = {
				save_scope_as = Azog
			}
		}

		if = {
			limit = {
				NOT = { 
					exists = scope:Azog
				}
				title:c_endless_stair.holder.top_liege = {
					is_orc = yes
				}
			}
			title:c_endless_stair.holder.top_liege = {
				save_scope_as = Azog
			}
		}

		if = {
			limit = {
				NOT = { 
					exists = scope:Azog
				}
				title:c_chamber_of_mazarbul.holder.top_liege = {
					is_orc = yes
				}
			}
			title:c_chamber_of_mazarbul.holder.top_liege = {
				save_scope_as = Azog
			}
		}

		if = {
			limit = {
				NOT = { 
					exists = scope:Azog
				}
				title:c_hall_of_a_thousand_pillars.holder.top_liege = {
					is_orc = yes
				}
			}
			title:c_hall_of_a_thousand_pillars.holder.top_liege = {
				save_scope_as = Azog
			}
		}

		if = {
			limit = {
				NOT = { 
					exists = scope:Azog
				}
				title:c_central_halls.holder.top_liege = {
					is_orc = yes
				}
			}
			title:c_central_halls.holder.top_liege = {
				save_scope_as = Azog
			}
		}

		if = {
			limit = {
				NOT = { 
					exists = scope:Azog
				}
				title:c_west_hall.holder.top_liege = {
					is_orc = yes
				}
			}
			title:c_west_hall.holder.top_liege = {
				save_scope_as = Azog
			}
		}

		if = {
			limit = {
				NOT = { 
					exists = scope:Azog
				}
				title:c_great_mines.holder.top_liege = {
					is_orc = yes
				}
			}
			title:c_great_mines.holder.top_liege = {
				save_scope_as = Azog
			}
		}

		if = {
			limit = {
				NOT = { 
					exists = scope:Azog
				}
				title:c_zirin_kuk.holder.top_liege = {
					is_orc = yes
				}
			}
			title:c_zirin_kuk.holder.top_liege = {
				save_scope_as = Azog
			}
		}
	}


	option = {
		name = smaug_event_chain.0111.a

		trigger = {
			OR = {
				title:c_east_hall.holder.top_liege = {
					is_orc = yes
				}
				title:c_durins_hall.holder.top_liege = {
					is_orc = yes
				}
				title:c_endless_stair.holder.top_liege = {
					is_orc = yes
				}
				title:c_chamber_of_mazarbul.holder.top_liege = {
					is_orc = yes
				}
				title:c_hall_of_a_thousand_pillars.holder.top_liege = {
					is_orc = yes
				}
				title:c_central_halls.holder.top_liege = {
					is_orc = yes
				}
				title:c_west_hall.holder.top_liege = {
					is_orc = yes
				}
				title:c_great_mines.holder.top_liege = {
					is_orc = yes
				}
				title:c_zirin_kuk.holder.top_liege = {
					is_orc = yes
				}
			}	
		}

		scope:Azog = {
			trigger_event = smaug_event_chain.0113
		}

	}

	option = {
		name = smaug_event_chain.0111.b

		trigger = {
			NOR = {
				title:c_east_hall.holder.top_liege = {
					is_orc = yes
				}
				title:c_durins_hall.holder.top_liege = {
					is_orc = yes
				}
				title:c_endless_stair.holder.top_liege = {
					is_orc = yes
				}
				title:c_chamber_of_mazarbul.holder.top_liege = {
					is_orc = yes
				}
				title:c_hall_of_a_thousand_pillars.holder.top_liege = {
					is_orc = yes
				}
				title:c_central_halls.holder.top_liege = {
					is_orc = yes
				}
				title:c_west_hall.holder.top_liege = {
					is_orc = yes
				}
				title:c_great_mines.holder.top_liege = {
					is_orc = yes
				}
				title:c_zirin_kuk.holder.top_liege = {
					is_orc = yes
				}
			}	
		}

		#custom_tooltip = Thror_end_of_chain_dead_end.tt

		hidden_effect = {
			remove_variable = cannot_cancel_travel
			current_travel_plan = { cancel_travel_plan = yes }

			set_variable = cannot_cancel_travel

			start_travel_plan = {
				destination = root.capital_county.title_province
				travel_with_domicile = no
				return_trip = no
				players_use_planner = no
				on_arrival_event = smaug_event_chain.0119
				on_arrival_destinations = last
			}

			trigger_event = {
				id = smaug_event_chain.0120
				days = 2
			}
		}
	}
}

# End of Thror
smaug_event_chain.0112 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0112.title
	desc = smaug_event_chain.0112.desc

    theme = war
	override_background = {
		reference = wilderness
	}

	left_portrait = {
		character = root
		animation = anger
	}

	right_portrait = {
		character = scope:Azog
		animation = personality_bold
	}	

	option = {
		name = smaug_event_chain.0112.a

		set_relation_nemesis = {
			reason = nemesis_house_feud
			target = scope:Azog
		}	

		death = { death_reason = death_decapitated killer = scope:Azog }
		
		hidden_effect = {
			scope:Thror_primary_heir = {
				trigger_event = {
					id = smaug_event_chain.0114
					days = 7
				}	
			}
		}	
	}
}

# Orc pov of Thror entering Moria
smaug_event_chain.0113 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0113.title
	desc = smaug_event_chain.0113.desc

    theme = war
	override_background = {
		reference = wilderness_underground
	}
	immediate = {
		ordered_ruler = {
			limit = {
				is_dwarf = yes
				is_dynast = yes
				dynasty = dynasty:dynasty_durin
			}
			save_scope_as = Thror
		}
	}
	left_portrait = {
		character = root
		animation = personality_bold
	}

	right_portrait = {
		character = scope:Thror
		animation = fear
	}	

	option = { # Behead and brand the beggar
		name = smaug_event_chain.0113.a	
		custom_tooltip = smaug_event_chain.0113.a.tt
		add_prestige = major_prestige_gain
		show_as_tooltip = {
			scope:Thror = { death = { death_reason = death_decapitated killer = scope:Azog } }
		}
		scope:Thror = {
			trigger_event = smaug_event_chain.0112
		}
		if = {
			limit = { this = character:lineofazog1 }
			give_nickname = nick_the_defiler
		}
		else = { give_nickname = nick_the_defiler_general }
		
		ai_chance = { base = 100 }
	}
	option = { # Shave his beard and send him on his way
		name = smaug_event_chain.0013.b 
		add_dread = massive_dread_gain
		add_stress = -50
		scope:Thror = {
			add_trait = beardless
			add_opinion = {
				modifier = shaved_me
				target = root 
			}
			trigger_event = smaug_event_chain.0115
		}
	}
}

# Nar tells the news about Thrors death
smaug_event_chain.0114 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0114.title
	desc = smaug_event_chain.0114.desc

	left_portrait = {
		character = scope:Thror_primary_heir
		animation = personality_bold
	}

	right_portrait = {
		character = scope:Nar
		animation = sadness
	}

	theme = war
	override_background = {
		reference = wilderness
	}
	
	immediate = {
		add_pressed_claim = title:d_zirakzigil
		add_pressed_claim = title:k_khazad_dum
	}
	
	option = {
		name = smaug_event_chain.0114.a

		set_relation_nemesis = {
			reason = nemesis_house_feud
			target = scope:Azog
		}	

		if = {
            limit = { # Major News
                NOT = { has_game_rule = no_news }
            }
            every_player = { #Global News Announcement
			    trigger_event = {
                    id = news_event.0051
                    days = 5
                }    
		    }
        }
	}
}

# Thrór is shaved and shamed
smaug_event_chain.0115 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0115.title
	desc = smaug_event_chain.0115.desc

    theme = war
	override_background = {
		reference = wilderness_mountains
	}

	left_portrait = {
		character = root
		animation = rage
	}

	right_portrait = {
		character = scope:Azog
		animation = personality_callous
	}	
	
	immediate = {
		primary_heir = {
			save_scope_as = Thror_primary_heir
		}
		save_scope_as = Thror
		title:c_east_hall.holder.top_liege = { save_scope_as = Azog }
		set_relation_nemesis = {
			reason = nemesis_house_feud
			target = scope:Azog
		}	
		root = { save_scope_as = Thror }
		show_as_tooltip = {
			add_trait = beardless
			add_opinion = {
				modifier = shaved_me
				target = scope:Azog 
			}
		}
	}

	trigger = {
		title:c_east_hall.holder.top_liege = {
			is_orc = yes
		}
	}

	option = {
		name = smaug_event_chain.0115.a
		hidden_effect = { scope:Thror_primary_heir = { get_title = title:k_durins_dummy } }
		set_player_character = scope:Thror_primary_heir
		scope:Thror_primary_heir = { get_title = root.primary_title }
		hidden_effect = {
			scope:Thror_primary_heir = {
				trigger_event = {
					id = smaug_event_chain.0114
					days = 7
				}	
			}
			destroy_title = title:k_durins_dummy
		}	
	}
}

# There is no orc in Moria end of chain
#smaug_event_chain.0116 = {
#	content_source = realms_dlc
#    type = character_event
#    title = smaug_event_chain.0116.title
#	desc = smaug_event_chain.0116.desc
#
#   theme = realm
#	override_background = {
#		reference = wilderness
#	}
#
#	left_portrait = {
#		character = root
#		animation = happiness
#	}
#
#	option = {
#		name = smaug_event_chain.0116.a
#		
#		add_piety = medium_piety_gain
#
#		custom_tooltip = Thror_end_of_chain_dead_end.tt
#	}
#}

# You hold county in Moria end of chain
#smaug_event_chain.0117 = {
#	content_source = realms_dlc
#    type = character_event
#    title = smaug_event_chain.0117.title
#	desc = smaug_event_chain.0117.desc
#
#    theme = realm
#
#	override_background = { reference = halls }
#
#	left_portrait = {
#		character = root
#		animation = happiness
#	}
#
#	option = {
#		name = smaug_event_chain.0117.a
#		
#		add_prestige = medium_prestige_gain
#
#		#custom_tooltip = Thror_end_of_chain_dead_end.tt
#	}
#}

# You are located in Moria end of chain
smaug_event_chain.0118 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0118.title
	desc = {
		first_valid = {
			triggered_desc = { # There is no orc in Moria
				trigger = {
					NOT =  { exists = scope:Orc_in_moria }
				}
				desc = smaug_event_chain.0118.desc
			}
			# There are orcs in Moria
			desc = smaug_event_chain.0118.orcs.desc
		}
	}

    theme = realm

	override_background = { reference = wilderness }

	left_portrait = {
		character = root
		animation = lantern
	}

	# There is no orc in Moria
	option = {
		name = smaug_event_chain.0118.a

		trigger = {
			NOT =  { exists = scope:Orc_in_moria }
		}

		stress_impact = {
			base = major_stress_gain
		}

		#custom_tooltip = Thror_end_of_chain_dead_end.tt
	}

	# There are orcs in Moria
	option = {
		name = smaug_event_chain.0118.b

		trigger = {
			exists = scope:Orc_in_moria
		}

		stress_impact = {
			base = major_stress_gain
		}

		#custom_tooltip = Thror_end_of_chain_dead_end.tt
	}
}

# Returning home from Moria
smaug_event_chain.0119 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0119.title
	desc = smaug_event_chain.0119.desc

    theme = realm

	override_background = { reference = wilderness }

	left_portrait = {
		character = root
		animation = personality_bold
	}

	right_portrait = {
		character = scope:Thror_primary_heir
		animation = personality_rational
	}

	# There is no orc in Moria
	option = {
		name = smaug_event_chain.0119.a

		scope:Thror_primary_heir = {
			every_character_artifact = {
				set_owner = {
					target = character:lineofdurin81
					history = {
						location = character:lineofdurin81.location
						actor = scope:Thror_primary_heir
						recipient = character:lineofdurin81
						type = given
					}	
				}
			}
		}
	}
}

# hidden event to remove companions
smaug_event_chain.0120 = {
	type = character_event
	hidden = yes

    immediate = {
		current_travel_plan = {
			every_entourage_character = {
				limit = { 
					NOR = { 
						this = character:lineofdurin81
						this = character:lineofnar1
					} 
				}	
				current_travel_plan = { remove_character = prev }
			}
		}
		return_home = yes
	}
}

###################################
# 		Smaug blocker events	  #
###################################
# Blocker events
smaug_event_chain.0200 = {	#	Desolation of Smaug blocker - Smaug lives
	content_source = realms_dlc
	type = character_event
	title = smaug_event_chain.0200.t
	desc = {
		first_valid = {
			triggered_desc = { #Smaug lives desc, shouldnt be triggered
				trigger = {
					title:c_throne_of_erebor.title_province = { has_building = smaug }
				}
				desc = smaug_event_chain.0200.danger.desc
			}
			desc = smaug_event_chain.0200.desc
		}
	}			

	theme = realm

	left_portrait = {
		character = root
		triggered_animation = {
			trigger = {
				title:c_throne_of_erebor.title_province = { has_building = smaug }
			}
			animation = fear
		}
		triggered_animation = {
			trigger = {
				NOT = { title:c_throne_of_erebor.title_province = { has_building = smaug } }
			}
			animation = personality_rational
		}
		animation = idle
	}

	override_background = {
		reference = wilderness
	}

	option = { # Settlement cant be further developed, fail save option, should never be trigger but just in case its here
		name = smaug_event_chain.0200.a

		trigger = {
			title:c_throne_of_erebor.title_province = { has_building = smaug }
		}

		send_interface_toast = {
			left_icon = root
			title = smaug_event_chain.0200.a.toast.t
			increase_wounds_effect = { REASON = wild_animal }
			hidden_effect = { scope:obstacle_province = { remove_building = smaug_desolation_cleared } }
			scope:obstacle_province = { add_building = smaug_desolation }
			make_settlement_county_wilderness = {
				COUNTY = scope:obstacle_province.county
			}
		}
		stress_impact = {
			base = major_stress_gain
			craven = major_stress_gain
		}
	}

	option = { # Settlement is further developed
		name = smaug_event_chain.0200.b

		trigger = {
			NOT = { title:c_throne_of_erebor.title_province = { has_building = smaug } }
		}

		send_interface_toast = {
			left_icon = root
			title = smaug_event_chain.0200.b.toast.t
			add_prestige = 50
			hidden_effect = { scope:obstacle_province = { remove_building = smaug_desolation_cleared } }
		}
	}
}

###################################
# Kill Smaug Decision Event Chain #
###################################

# Starting the journey
smaug_event_chain.0300 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0300.title
	desc = smaug_event_chain.0300.desc

    theme = realm
	override_background = {
		reference = wilderness
	}

	left_portrait = {
		character = root
		animation = personality_bold
	}

	immediate = {
		save_scope_as = leader
		#play_music_cue = lotr_cue_dwarves
	}

	option = {
		name = smaug_event_chain.0300.a

		custom_tooltip = smaug_event_chain.0300.a.tt

		hidden_effect = {
			start_travel_plan = {
				destination = title:c_throne_of_erebor.title_province
				travel_with_domicile = no
				return_trip = no
				players_use_planner = no
				on_arrival_event = smaug_event_chain.0399
				on_arrival_destinations = last
			}

			every_courtier = {
				limit = {
					is_travelling = no
				}
				root.current_travel_plan ?= {
					if = {
						limit = {
							any_entourage_character = { count <= 17 } 
						}
						add_companion = prev
					}
				}
			}	
		}
	}
}

# Setup event - hidden event firing on arrival
smaug_event_chain.0399 = {
	type = character_event
	hidden = yes

	trigger = {
		title:c_throne_of_erebor.title_province = { has_building = smaug }
	}

	immediate = {
		if = {
			limit = {
				title:c_throne_of_erebor.title_province = { has_building = smaug }
			}
			trigger_event = {
				id = smaug_event_chain.0301
			}
			hidden_effect = {
				current_travel_plan = { 
					delay_travel_plan = { days = 60 }
				}
			}
		}
	}
}

# Arriving at Erebor / Intrigue challange 1
smaug_event_chain.0301 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0301.title
	desc = smaug_event_chain.0301.desc

    theme = intrigue
	override_background = {
		reference = wilderness
	}

	trigger = {
		title:c_throne_of_erebor.title_province = { has_building = smaug }
	}

	left_portrait = {
		character = root
		animation = celebrate_axe
	}

	#immediate = {
	#	hidden_effect = {
	#		current_travel_plan = { 
	#			delay_travel_plan = { days = 90 }
	#		}
	#	}
	#}

	# Sneaking in through main gate
	option = {
		name = smaug_event_chain.0301.a

		duel = {
			skill = intrigue
			value = average_skill_rating
			50 = {	# You succesfully sneak in
				desc = smaug_event_chain.0301.a.success
				modifier = {
					add = {
						value = root.intrigue
						multiply = 1
					}
				}
				modifier = { add = { value = burglar_hobbit_value } }
				trigger_event = {
					id = smaug_event_chain.0302	# Sneaking continues
					days = 5
				}
				add_character_flag = smaug_fight_advantage_1
			}
			50 = {	# Smaug is awakened
				desc = smaug_event_chain.0301.a.failure
				modifier = {
					add = {
						value = root.intrigue
						multiply = -1
					}
				}
				modifier = { add = { value = burglar_hobbit_value.neg } }			
				trigger_event = {
					id = smaug_event_chain.0304	# Smaug awakened
					days = 5
				}
			}
		}
	}

	# Sneaking in through hidden entrance
	option = {
		name = smaug_event_chain.0301.b

		trigger = {
			any_character_artifact = {
				has_variable = key_of_erebor
			}
		}

		custom_tooltip = smaug_event_chain.0301.b.tt

		add_character_flag = smaug_fight_advantage_1
		add_character_flag = smaug_fight_advantage_2	# skipping the sneaking and gaining all bonuses
		#add_character_flag = smaug_fight_advantage_3	# skipping the sneaking and gaining all bonuses
		add_character_flag = smaug_fight_hidden

		#trigger_event = {
		#	id = smaug_event_chain.0302	# Sneaking continues
		#	days = 5
		#}
		
		# skipping to meeting Smaug
		trigger_event = {
			id = smaug_event_chain.0303	# Smaug awakened
			days = 5
		}
	}
}

# Intrigue challange 2
smaug_event_chain.0302 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0302.title
	desc = smaug_event_chain.0302.desc

    theme = intrigue
	override_background = {
		reference = wilderness
	}

	left_portrait = {
		character = root
		animation = celebrate_axe
	}

	# Sneaking in through main gate
	option = {
		name = smaug_event_chain.0302.a

		trigger = {
			NOT = { has_character_flag = smaug_fight_hidden }
		}

		duel = {
			skill = intrigue
			value = average_skill_rating
			30 = {	# You succesfully sneak in
				desc = smaug_event_chain.0302.b.success
				modifier = {
					add = {
						value = root.intrigue
						multiply = 1
					}
				}
				modifier = { add = { value = burglar_hobbit_value } }			
				trigger_event = {
					id = smaug_event_chain.0303	# Sneaking continues
					days = 5
				}
				add_character_flag = smaug_fight_advantage_2
			}
			70 = {	# Smaug is awakened
				desc = smaug_event_chain.0302.b.failure
				modifier = {
					add = {
						value = root.intrigue
						multiply = -1
					}
				}
				modifier = { add = { value = burglar_hobbit_value.neg } }			
				trigger_event = {
					id = smaug_event_chain.0304	# Smaug awakened
					days = 5
				}
			}
		}
	}

	# Sneaking in through hidden entrance
	option = {
		name = smaug_event_chain.0302.b

		trigger = {
			has_character_flag = smaug_fight_hidden
		}

		duel = {
			skill = intrigue
			value = average_skill_rating
			50 = {	# You succesfully sneak in
				desc = smaug_event_chain.0302.b.success
				modifier = {
					add = {
						value = root.intrigue
						multiply = 1
					}
				}
				modifier = { add = { value = burglar_hobbit_value } }			
				trigger_event = {
					id = smaug_event_chain.0303	# Sneaking continues
					days = 5
				}
				add_character_flag = smaug_fight_advantage_2
			}
			50 = {	# Smaug is awakened
				desc = smaug_event_chain.0302.b.failure
				modifier = {
					add = {
						value = root.intrigue
						multiply = -1
					}
				}
				modifier = { add = { value = burglar_hobbit_value.neg } }			
				trigger_event = {
					id = smaug_event_chain.0304	# Smaug awakened
					days = 5
				}
			}
		}
	}
}

# Intrigue challange 3
smaug_event_chain.0303 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0303.title
	desc = smaug_event_chain.0303.desc

    theme = intrigue
	override_background = {
		reference = wilderness
	}

	left_portrait = {
		character = root
		animation = celebrate_axe
	}

	# Sneaking in through main gate
	option = {
		name = smaug_event_chain.0303.a

		trigger = {
			NOT = { has_character_flag = smaug_fight_hidden }
		}

		duel = {
			skill = intrigue
			value = average_skill_rating
			10 = {	# You succesfully sneak in
				modifier = {
					add = {
						value = root.intrigue
						multiply = 1
						max = 90
						min = -90
					}
				}
				modifier = { add = { value = burglar_hobbit_value } }
				desc = smaug_event_chain.0303.a.success
				trigger_event = {
					id = smaug_event_chain.0304	# You suprised Smaug
					days = 5
				}
				add_character_flag = smaug_fight_advantage_3
			}
			90 = {	# Smaug is awakened
				desc = smaug_event_chain.0303.a.failure
				modifier = {
					add = {
						value = root.intrigue
						multiply = -1
						max = 90
						min = -90
					}
				}
				modifier = { add = { value = burglar_hobbit_value } }				
				trigger_event = {
					id = smaug_event_chain.0304	# Smaug awakened
					days = 5
				}
			}
		}
	}

	# Sneaking in through hidden entrance
	option = {
		name = smaug_event_chain.0303.b

		trigger = {
			has_character_flag = smaug_fight_hidden
		}

		duel = {
			skill = intrigue
			value = 5
			40 = {	# You succesfully sneak in
				modifier = {
					add = {
						value = root.intrigue
						multiply = 1
					}
				}
				modifier = { add = { value = burglar_hobbit_value } }
				desc = smaug_event_chain.0303.a.success
				trigger_event = {
					id = smaug_event_chain.0304	# You suprised Smaug
					days = 5
				}
				add_character_flag = smaug_fight_advantage_3
			}
			60 = {	# Smaug is awakened
				desc = smaug_event_chain.0303.a.failure
				modifier = {
					add = {
						value = root.intrigue
						multiply = -1
					}
				}
				modifier = { add = { value = burglar_hobbit_value } }				
				trigger_event = {
					id = smaug_event_chain.0304	# Smaug awakened
					days = 5
				}
			}
		}
	}
}

# Smaug awakeness
smaug_event_chain.0304 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0304.title
	desc = smaug_event_chain.0304.desc

    theme = dread
	override_background = {
		reference = smaug_destruction
	}

	left_portrait = {
		character = root
		animation = fear
	}

	# Flavour text
	option = {
		name = smaug_event_chain.0304.a

		trigger_event = {
			id = smaug_event_chain.0305	# Smaug fight 1
			days = 5
		}
	}
}

# Martial challange 1
smaug_event_chain.0305 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0305.title
	desc = smaug_event_chain.0305.desc

    theme = war
	override_background = {
		reference = smaug_destruction
	}

	left_portrait = {
		character = root
		animation = aggressive_axe
	}

	trigger = {
		scope:leader = {
			is_alive = yes
		}
	}

	immediate = {
		current_travel_plan = {
			if = {
				limit = { any_entourage_character = { count >= 1 } }
				random_entourage_character = {
					save_scope_as = smaug_challange_1_victim_1
				}
			}
			else = { root = { save_scope_as = smaug_challange_1_victim_1 } }
			
			if = {
				limit = { any_entourage_character = { count >= 2 } }
				random_entourage_character = {
					limit = { NOT = { this = scope:smaug_challange_1_victim_1 } }
					save_scope_as = smaug_challange_1_victim_2
				}
			}
			else = { root = { save_scope_as = smaug_challange_1_victim_2 } }

			if = {
				limit = { any_entourage_character = { count >= 3 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_1_victim_1 }
							NOT = { this = scope:smaug_challange_1_victim_2 }  
						}
					}	
					save_scope_as = smaug_challange_1_victim_3
				}
			}
			else = { root = { save_scope_as = smaug_challange_1_victim_3 } }
			
			if = {
				limit = { any_entourage_character = { count >= 4 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_1_victim_1 }
							NOT = { this = scope:smaug_challange_1_victim_2 }
							NOT = { this = scope:smaug_challange_1_victim_3 }   
						}
					}	
					save_scope_as = smaug_challange_1_victim_4
				}
			}
			else = { root = { save_scope_as = smaug_challange_1_victim_4 } }
			
			if = {
				limit = { any_entourage_character = { count >= 5 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_1_victim_1 }
							NOT = { this = scope:smaug_challange_1_victim_2 }
							NOT = { this = scope:smaug_challange_1_victim_3 }
							NOT = { this = scope:smaug_challange_1_victim_4 }     
						}
					}
					save_scope_as = smaug_challange_1_victim_5
				}
			}
			else = { root = { save_scope_as = smaug_challange_1_victim_5 } }
			
			if = {
				limit = { any_entourage_character = { count >= 6 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_1_victim_1 }
							NOT = { this = scope:smaug_challange_1_victim_2 }
							NOT = { this = scope:smaug_challange_1_victim_3 }
							NOT = { this = scope:smaug_challange_1_victim_4 }
							NOT = { this = scope:smaug_challange_1_victim_5 }      
						}
					}
					save_scope_as = smaug_challange_1_victim_6
				}
			}
			else = { root = { save_scope_as = smaug_challange_1_victim_6 } }

			if = {
				limit = { any_entourage_character = { count >= 7 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_1_victim_1 }
							NOT = { this = scope:smaug_challange_1_victim_2 }
							NOT = { this = scope:smaug_challange_1_victim_3 }
							NOT = { this = scope:smaug_challange_1_victim_4 }
							NOT = { this = scope:smaug_challange_1_victim_5 } 
							NOT = { this = scope:smaug_challange_1_victim_6 }      
						}
					}
					save_scope_as = smaug_challange_1_victim_7
				}
			}
			else = { root = { save_scope_as = smaug_challange_1_victim_7 } }
		}
	}

	# Fight
	option = {
		name = smaug_event_chain.0305.a

		duel = {
			skill = prowess
			value = average_skill_rating
			40 = {	# No dwarf dies
				modifier = {
					add = {
						value = root.prowess
						multiply = 0.1
					}
				}
				modifier = {
					has_character_flag = smaug_fight_advantage_1
					add = {
						value = root.prowess
						multiply = 0.5
					}
				}
				modifier = {
					has_character_flag = smaug_fight_advantage_2
					add = {
						value = root.prowess
						multiply = 0.5
					}
				}
				modifier = {
					has_character_flag = smaug_fight_advantage_3
					add = {
						value = root.prowess
						multiply = 0.5
					}
				}

				desc = smaug_event_chain.0305.a.success
				
			}
			60 = {	# Smaug kills dwarves
				desc = smaug_event_chain.0305.a.failure

				modifier = {
					add = {
						value = root.prowess
						multiply = -0.1
					}
				}
				modifier = {
					has_character_flag = smaug_fight_advantage_1
					add = {
						value = root.prowess
						multiply = -0.5
					}
				}
				modifier = {
					has_character_flag = smaug_fight_advantage_2
					add = {
						value = root.prowess
						multiply = -0.5
					}
				}
				modifier = {
					has_character_flag = smaug_fight_advantage_3
					add = {
						value = root.prowess
						multiply = -0.5
					}
				}

				scope:smaug_challange_1_victim_1 = { death = { death_reason = death_burned } }
				if = {
					limit = { NOT = { scope:smaug_challange_1_victim_2 = scope:smaug_challange_1_victim_1 }}
					scope:smaug_challange_1_victim_2 = { death = { death_reason = death_burned } }
				}
				if = {
					limit = { NOT = { scope:smaug_challange_1_victim_3 = scope:smaug_challange_1_victim_2 }}
					scope:smaug_challange_1_victim_3 = { death = { death_reason = death_burned } }
				}
				if = {
					limit = { NOT = { scope:smaug_challange_1_victim_4 = scope:smaug_challange_1_victim_3 }}
					scope:smaug_challange_1_victim_4 = { death = { death_reason = death_burned } }
				}
				if = {
					limit = { NOT = { scope:smaug_challange_1_victim_5 = scope:smaug_challange_1_victim_4 }}
					scope:smaug_challange_1_victim_5 = { death = { death_reason = death_burned } }
				}

				random_list = {
					20 = {
						if = {
							limit = { NOT = { scope:smaug_challange_1_victim_6 = scope:smaug_challange_1_victim_5 }}
							scope:smaug_challange_1_victim_6 = { death = { death_reason = death_burned } }
						}
						if = {
							limit = { NOT = { scope:smaug_challange_1_victim_7 = scope:smaug_challange_1_victim_6 }}
							scope:smaug_challange_1_victim_7 = { death = { death_reason = death_burned } }
						}
					}
					80 = {}
				}
			}
		}
		trigger_event = {
			id = smaug_event_chain.0306	# Smaug fight 2 
			days = 5
		}
	}
}

# Martial challange 2
smaug_event_chain.0306 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0306.title
	desc = smaug_event_chain.0306.desc

    theme = war
	override_background = {
		reference = smaug_destruction
	}

	left_portrait = {
		character = root
		animation = aggressive_axe
	}

	trigger = {
		scope:leader = {
			is_alive = yes
		}
	}

	immediate = {
		current_travel_plan = {
			if = {
				limit = { any_entourage_character = { count >= 1 } }
				random_entourage_character = {
					save_scope_as = smaug_challange_2_victim_1
				}
			}
			else = { root = { save_scope_as = smaug_challange_2_victim_1 } }
			
			if = {
				limit = { any_entourage_character = { count >= 2 } }
				random_entourage_character = {
					limit = { NOT = { this = scope:smaug_challange_2_victim_1 } }
					save_scope_as = smaug_challange_2_victim_2
				}
			}
			else = { root = { save_scope_as = smaug_challange_2_victim_2 } }

			if = {
				limit = { any_entourage_character = { count >= 3 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_2_victim_1 }
							NOT = { this = scope:smaug_challange_2_victim_2 }  
						}
					}	
					save_scope_as = smaug_challange_2_victim_3
				}
			}
			else = { root = { save_scope_as = smaug_challange_2_victim_3 } }
			
			if = {
				limit = { any_entourage_character = { count >= 4 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_2_victim_1 }
							NOT = { this = scope:smaug_challange_2_victim_2 }
							NOT = { this = scope:smaug_challange_2_victim_3 }   
						}
					}	
					save_scope_as = smaug_challange_2_victim_4
				}
			}
			else = { root = { save_scope_as = smaug_challange_2_victim_4 } }

			if = {
				limit = { any_entourage_character = { count >= 5 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_2_victim_1 }
							NOT = { this = scope:smaug_challange_2_victim_2 }
							NOT = { this = scope:smaug_challange_2_victim_3 }
							NOT = { this = scope:smaug_challange_2_victim_4 }   
						}
					}	
					save_scope_as = smaug_challange_2_victim_5
				}
			}
			else = { root = { save_scope_as = smaug_challange_2_victim_5 } }

			if = {
				limit = { any_entourage_character = { count >= 6 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_2_victim_1 }
							NOT = { this = scope:smaug_challange_2_victim_2 }
							NOT = { this = scope:smaug_challange_2_victim_3 }
							NOT = { this = scope:smaug_challange_2_victim_4 }
							NOT = { this = scope:smaug_challange_2_victim_5 }    
						}
					}	
					save_scope_as = smaug_challange_2_victim_6
				}
			}
			else = { root = { save_scope_as = smaug_challange_2_victim_6 } }
		}
	}

	# Fight
	option = {
		name = smaug_event_chain.0306.a

		duel = {
			skill = prowess
			value = average_skill_rating
			30 = {	# No dwarf dies
				modifier = {
					add = {
						value = root.prowess
						multiply = 0.1
					}
				}
				modifier = {
					has_character_flag = smaug_fight_advantage_1
					add = {
						value = root.prowess
						multiply = 0.5
					}
				}
				modifier = {
					has_character_flag = smaug_fight_advantage_2
					add = {
						value = root.prowess
						multiply = 0.5
					}
				}
				modifier = {
					has_character_flag = smaug_fight_advantage_3
					add = {
						value = root.prowess
						multiply = 0.5
					}
				}

				desc = smaug_event_chain.0306.a.success
				
			}
			70 = {	# Smaug kills dwarves
				desc = smaug_event_chain.0306.a.failure

				modifier = {
					add = {
						value = root.prowess
						multiply = -0.1
					}
				}
				modifier = {
					has_character_flag = smaug_fight_advantage_1
					add = {
						value = root.prowess
						multiply = -0.5
					}
				}
				modifier = {
					has_character_flag = smaug_fight_advantage_2
					add = {
						value = root.prowess
						multiply = -0.5
					}
				}
				modifier = {
					has_character_flag = smaug_fight_advantage_3
					add = {
						value = root.prowess
						multiply = -0.5
					}
				}

				scope:smaug_challange_2_victim_1 = { death = { death_reason = death_burned } }
				if = {
					limit = { NOT = { scope:smaug_challange_2_victim_2 = scope:smaug_challange_2_victim_1 }}
					scope:smaug_challange_2_victim_2 = { death = { death_reason = death_burned } }
				}
				if = {
					limit = { NOT = { scope:smaug_challange_2_victim_3 = scope:smaug_challange_2_victim_2 }}
					scope:smaug_challange_2_victim_3 = { death = { death_reason = death_burned } }
				}
				if = {
					limit = { NOT = { scope:smaug_challange_2_victim_4 = scope:smaug_challange_2_victim_3 }}
					scope:smaug_challange_2_victim_4 = { death = { death_reason = death_burned } }
				}

				random_list = {
					60 = {
						if = {
							limit = { NOT = { scope:smaug_challange_2_victim_5 = scope:smaug_challange_2_victim_4 }}
							scope:smaug_challange_2_victim_5 = { death = { death_reason = death_burned } }
						}
						if = {
							limit = { NOT = { scope:smaug_challange_2_victim_6 = scope:smaug_challange_2_victim_5 }}
							scope:smaug_challange_2_victim_6 = { death = { death_reason = death_burned } }
						}
					}
					40 = {}
				}
			}
		}
		trigger_event = {
			id = smaug_event_chain.0307	# Smaug fight 2 
			days = 5
		}
	}
}

# Martial challange 3
smaug_event_chain.0307 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0307.title
	desc = smaug_event_chain.0307.desc

    theme = war
	override_background = {
		reference = smaug_destruction
	}

	left_portrait = {
		character = root
		animation = aggressive_axe
	}

	trigger = {
		scope:leader = {
			is_alive = yes
		}
	}

	immediate = {
		current_travel_plan = {
			if = {
				limit = { any_entourage_character = { count >= 1 } }
				random_entourage_character = {
					save_scope_as = smaug_challange_3_victim_1
				}
			}
			else = { root = { save_scope_as = smaug_challange_3_victim_1 } }
			
			if = {
				limit = { any_entourage_character = { count >= 2 } }
				random_entourage_character = {
					limit = { NOT = { this = scope:smaug_challange_3_victim_1 } }
					save_scope_as = smaug_challange_3_victim_2
				}
			}
			else = { root = { save_scope_as = smaug_challange_3_victim_2 } }
			
			if = {
				limit = { any_entourage_character = { count >= 3 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_3_victim_1 }
							NOT = { this = scope:smaug_challange_3_victim_2 }  
						}
					}	
					save_scope_as = smaug_challange_3_victim_3
				}
			}
			else = { root = { save_scope_as = smaug_challange_3_victim_3 } }
			
			if = {
				limit = { any_entourage_character = { count >= 4 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_3_victim_1 }
							NOT = { this = scope:smaug_challange_3_victim_2 }
							NOT = { this = scope:smaug_challange_3_victim_3 }   
						}
					}	
					save_scope_as = smaug_challange_3_victim_4
				}
			}
			else = { root = { save_scope_as = smaug_challange_3_victim_4 } }
			
			if = {
				limit = { any_entourage_character = { count >= 5 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_3_victim_1 }
							NOT = { this = scope:smaug_challange_3_victim_2 }
							NOT = { this = scope:smaug_challange_3_victim_3 }
							NOT = { this = scope:smaug_challange_3_victim_4 }     
						}
					}
					save_scope_as = smaug_challange_3_victim_5
				}
			}
			else = { root = { save_scope_as = smaug_challange_3_victim_5 } }
			
			if = {
				limit = { any_entourage_character = { count >= 6 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_3_victim_1 }
							NOT = { this = scope:smaug_challange_3_victim_2 }
							NOT = { this = scope:smaug_challange_3_victim_3 }
							NOT = { this = scope:smaug_challange_3_victim_4 }
							NOT = { this = scope:smaug_challange_3_victim_5 }     
						}
					}
					save_scope_as = smaug_challange_3_victim_6
				}
			}
			else = { root = { save_scope_as = smaug_challange_3_victim_6 } }
			
			if = {
				limit = { any_entourage_character = { count >= 7 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_3_victim_1 }
							NOT = { this = scope:smaug_challange_3_victim_2 }
							NOT = { this = scope:smaug_challange_3_victim_3 }
							NOT = { this = scope:smaug_challange_3_victim_4 }
							NOT = { this = scope:smaug_challange_3_victim_5 }
							NOT = { this = scope:smaug_challange_3_victim_6 }      
						}
					}
					save_scope_as = smaug_challange_3_victim_7
				}
			}
			else = { root = { save_scope_as = smaug_challange_3_victim_7 } }
			
			if = {
				limit = { any_entourage_character = { count >= 8 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_3_victim_1 }
							NOT = { this = scope:smaug_challange_3_victim_2 }
							NOT = { this = scope:smaug_challange_3_victim_3 }
							NOT = { this = scope:smaug_challange_3_victim_4 }
							NOT = { this = scope:smaug_challange_3_victim_5 }
							NOT = { this = scope:smaug_challange_3_victim_6 }
							NOT = { this = scope:smaug_challange_3_victim_7 }        
						}
					}
					save_scope_as = smaug_challange_3_victim_8
				}
			}
			else = { root = { save_scope_as = smaug_challange_3_victim_8 } }

			if = {
				limit = { any_entourage_character = { count >= 9 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_3_victim_1 }
							NOT = { this = scope:smaug_challange_3_victim_2 }
							NOT = { this = scope:smaug_challange_3_victim_3 }
							NOT = { this = scope:smaug_challange_3_victim_4 }
							NOT = { this = scope:smaug_challange_3_victim_5 }
							NOT = { this = scope:smaug_challange_3_victim_6 }
							NOT = { this = scope:smaug_challange_3_victim_7 }
							NOT = { this = scope:smaug_challange_3_victim_8 }          
						}
					}
					save_scope_as = smaug_challange_3_victim_9
				}
			}
			else = { root = { save_scope_as = smaug_challange_3_victim_9 } }	
		}
	}

	# Fight
	option = {
		name = smaug_event_chain.0307.a

		duel = {
			skill = prowess
			value = average_skill_rating
			20 = {	# No dwarf dies
				modifier = {
					add = {
						value = root.prowess
						multiply = 0.1
					}
				}
				modifier = {
					has_character_flag = smaug_fight_advantage_1
					add = {
						value = root.prowess
						multiply = 0.5
					}
				}
				modifier = {
					has_character_flag = smaug_fight_advantage_2
					add = {
						value = root.prowess
						multiply = 0.5
					}
				}
				modifier = {
					has_character_flag = smaug_fight_advantage_3
					add = {
						value = root.prowess
						multiply = 0.5
					}
				}

				desc = smaug_event_chain.0307.a.success
				
			}
			80 = {	# Smaug kills dwarves
				desc = smaug_event_chain.0307.a.failure

				modifier = {
					add = {
						value = root.prowess
						multiply = -0.1
					}
				}
				modifier = {
					has_character_flag = smaug_fight_advantage_1
					add = {
						value = root.prowess
						multiply = -0.5
					}
				}
				modifier = {
					has_character_flag = smaug_fight_advantage_2
					add = {
						value = root.prowess
						multiply = -0.5
					}
				}
				modifier = {
					has_character_flag = smaug_fight_advantage_3
					add = {
						value = root.prowess
						multiply = -0.5
					}
				}

				scope:smaug_challange_3_victim_1 = { death = { death_reason = death_burned } }
				if = {
					limit = { NOT = { scope:smaug_challange_3_victim_2 = scope:smaug_challange_3_victim_1 }}
					scope:smaug_challange_3_victim_2 = { death = { death_reason = death_burned } }
				}
				if = {
					limit = { NOT = { scope:smaug_challange_3_victim_3 = scope:smaug_challange_3_victim_2 }}
					scope:smaug_challange_3_victim_3 = { death = { death_reason = death_burned } }
				}
				if = {
					limit = { NOT = { scope:smaug_challange_3_victim_4 = scope:smaug_challange_3_victim_3 }}
					scope:smaug_challange_3_victim_4 = { death = { death_reason = death_burned } }
				}
				if = {
					limit = { NOT = { scope:smaug_challange_3_victim_5 = scope:smaug_challange_3_victim_4 }}
					scope:smaug_challange_3_victim_5 = { death = { death_reason = death_burned } }
				}
				if = {
					limit = { NOT = { scope:smaug_challange_3_victim_6 = scope:smaug_challange_3_victim_5 }}
					scope:smaug_challange_3_victim_6 = { death = { death_reason = death_burned } }
				}

				random_list = {
					80 = {
						if = {
							limit = { NOT = { scope:smaug_challange_3_victim_7 = scope:smaug_challange_3_victim_6 }}
							scope:smaug_challange_3_victim_7 = { death = { death_reason = death_burned } }
						}
						if = {
							limit = { NOT = { scope:smaug_challange_3_victim_8 = scope:smaug_challange_3_victim_7 }}
							scope:smaug_challange_3_victim_8 = { death = { death_reason = death_burned } }
						}
						if = {
							limit = { NOT = { scope:smaug_challange_3_victim_9 = scope:smaug_challange_3_victim_8 }}
							scope:smaug_challange_3_victim_9 = { death = { death_reason = death_burned } }
						}
					}
					20 = {}
				}
			}
		}
		trigger_event = {
			id = smaug_event_chain.0308	# Smaug fight 2 
			days = 5
		}
	}
}

# Martial challange 4
smaug_event_chain.0308 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0308.title
	desc = smaug_event_chain.0308.desc

    theme = war
	override_background = {
		reference = smaug_destruction
	}

	left_portrait = {
		character = root
		animation = aggressive_axe
	}

	trigger = {
		scope:leader = {
			is_alive = yes
		}
	}

	immediate = {
		current_travel_plan = {
			if = {
				limit = { any_entourage_character = { count >= 1 } }
				random_entourage_character = {
					save_scope_as = smaug_challange_4_victim_1
				}
			}
			else = { root = { save_scope_as = smaug_challange_4_victim_1 } }
			
			if = {
				limit = { any_entourage_character = { count >= 2 } }
				random_entourage_character = {
					limit = { NOT = { this = scope:smaug_challange_4_victim_1 } }
					save_scope_as = smaug_challange_4_victim_2
				}
			}
			else = { root = { save_scope_as = smaug_challange_4_victim_2 } }
			
			if = {
				limit = { any_entourage_character = { count >= 3 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_4_victim_1 }
							NOT = { this = scope:smaug_challange_4_victim_2 }  
						}
					}	
					save_scope_as = smaug_challange_4_victim_3
				}
			}
			else = { root = { save_scope_as = smaug_challange_4_victim_3 } }
			
			if = {
				limit = { any_entourage_character = { count >= 4 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_4_victim_1 }
							NOT = { this = scope:smaug_challange_4_victim_2 }
							NOT = { this = scope:smaug_challange_4_victim_3 }   
						}
					}	
					save_scope_as = smaug_challange_4_victim_4
				}
			}
			else = { root = { save_scope_as = smaug_challange_4_victim_4 } }
			
			if = {
				limit = { any_entourage_character = { count >= 5 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_4_victim_1 }
							NOT = { this = scope:smaug_challange_4_victim_2 }
							NOT = { this = scope:smaug_challange_4_victim_3 }
							NOT = { this = scope:smaug_challange_4_victim_4 }     
						}
					}
					save_scope_as = smaug_challange_4_victim_5
				}
			}
			else = { root = { save_scope_as = smaug_challange_4_victim_5 } }
			
			if = {
				limit = { any_entourage_character = { count >= 6 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_4_victim_1 }
							NOT = { this = scope:smaug_challange_4_victim_2 }
							NOT = { this = scope:smaug_challange_4_victim_3 }
							NOT = { this = scope:smaug_challange_4_victim_4 }
							NOT = { this = scope:smaug_challange_4_victim_5 }     
						}
					}
					save_scope_as = smaug_challange_4_victim_6
				}
			}
			else = { root = { save_scope_as = smaug_challange_4_victim_6 } }
			
			if = {
				limit = { any_entourage_character = { count >= 7 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_4_victim_1 }
							NOT = { this = scope:smaug_challange_4_victim_2 }
							NOT = { this = scope:smaug_challange_4_victim_3 }
							NOT = { this = scope:smaug_challange_4_victim_4 }
							NOT = { this = scope:smaug_challange_4_victim_5 }
							NOT = { this = scope:smaug_challange_4_victim_6 }      
						}
					}
					save_scope_as = smaug_challange_4_victim_7
				}
			}
			else = { root = { save_scope_as = smaug_challange_4_victim_7 } }
			
			if = {
				limit = { any_entourage_character = { count >= 8 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_4_victim_1 }
							NOT = { this = scope:smaug_challange_4_victim_2 }
							NOT = { this = scope:smaug_challange_4_victim_3 }
							NOT = { this = scope:smaug_challange_4_victim_4 }
							NOT = { this = scope:smaug_challange_4_victim_5 }
							NOT = { this = scope:smaug_challange_4_victim_6 }
							NOT = { this = scope:smaug_challange_4_victim_7 }        
						}
					}
					save_scope_as = smaug_challange_4_victim_8
				}
			}
			else = { root = { save_scope_as = smaug_challange_4_victim_8 } }

			if = {
				limit = { any_entourage_character = { count >= 9 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_4_victim_1 }
							NOT = { this = scope:smaug_challange_4_victim_2 }
							NOT = { this = scope:smaug_challange_4_victim_3 }
							NOT = { this = scope:smaug_challange_4_victim_4 }
							NOT = { this = scope:smaug_challange_4_victim_5 }
							NOT = { this = scope:smaug_challange_4_victim_6 }
							NOT = { this = scope:smaug_challange_4_victim_7 }
							NOT = { this = scope:smaug_challange_4_victim_8 }          
						}
					}
					save_scope_as = smaug_challange_4_victim_9
				}
			}
			else = { root = { save_scope_as = smaug_challange_4_victim_9 } }

			if = {
				limit = { any_entourage_character = { count >= 10 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_4_victim_1 }
							NOT = { this = scope:smaug_challange_4_victim_2 }
							NOT = { this = scope:smaug_challange_4_victim_3 }
							NOT = { this = scope:smaug_challange_4_victim_4 }
							NOT = { this = scope:smaug_challange_4_victim_5 }
							NOT = { this = scope:smaug_challange_4_victim_6 }
							NOT = { this = scope:smaug_challange_4_victim_7 }
							NOT = { this = scope:smaug_challange_4_victim_8 }
							NOT = { this = scope:smaug_challange_4_victim_9 }           
						}
					}
					save_scope_as = smaug_challange_4_victim_10
				}
			}
			else = { root = { save_scope_as = smaug_challange_4_victim_10 } }
			
			if = {
				limit = { any_entourage_character = { count >= 11 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_4_victim_1 }
							NOT = { this = scope:smaug_challange_4_victim_2 }
							NOT = { this = scope:smaug_challange_4_victim_3 }
							NOT = { this = scope:smaug_challange_4_victim_4 }
							NOT = { this = scope:smaug_challange_4_victim_5 }
							NOT = { this = scope:smaug_challange_4_victim_6 }
							NOT = { this = scope:smaug_challange_4_victim_7 }
							NOT = { this = scope:smaug_challange_4_victim_8 }
							NOT = { this = scope:smaug_challange_4_victim_9 }
							NOT = { this = scope:smaug_challange_4_victim_10 }            
						}
					}
					save_scope_as = smaug_challange_4_victim_11
				}
			}
			else = { root = { save_scope_as = smaug_challange_4_victim_11 }	}
		}
	}

	# Fight
	option = {
		name = smaug_event_chain.0308.a

		duel = {
			skill = prowess
			value = average_skill_rating
			10 = {	# No dwarf dies
				modifier = {
					add = {
						value = root.prowess
						multiply = 0.1
					}
				}
				modifier = {
					has_character_flag = smaug_fight_advantage_1
					add = {
						value = root.prowess
						multiply = 0.5
					}
				}
				modifier = {
					has_character_flag = smaug_fight_advantage_2
					add = {
						value = root.prowess
						multiply = 0.5
					}
				}
				modifier = {
					has_character_flag = smaug_fight_advantage_3
					add = {
						value = root.prowess
						multiply = 0.5
					}
				}

				desc = smaug_event_chain.0308.a.success
				
			}
			90 = {	# Smaug kills dwarves
				desc = smaug_event_chain.0308.a.failure

				modifier = {
					add = {
						value = root.prowess
						multiply = -0.1
					}
				}
				modifier = {
					has_character_flag = smaug_fight_advantage_1
					add = {
						value = root.prowess
						multiply = -0.5
					}
				}
				modifier = {
					has_character_flag = smaug_fight_advantage_2
					add = {
						value = root.prowess
						multiply = -0.5
					}
				}
				modifier = {
					has_character_flag = smaug_fight_advantage_3
					add = {
						value = root.prowess
						multiply = -0.5
					}
				}

				scope:smaug_challange_4_victim_1 = { death = { death_reason = death_burned } }
				if = {
					limit = { NOT = { scope:smaug_challange_4_victim_2 = scope:smaug_challange_4_victim_1 }}
					scope:smaug_challange_4_victim_2 = { death = { death_reason = death_burned } }
				}
				if = {
					limit = { NOT = { scope:smaug_challange_4_victim_3 = scope:smaug_challange_4_victim_2 }}
					scope:smaug_challange_4_victim_3 = { death = { death_reason = death_burned } }
				}
				if = {
					limit = { NOT = { scope:smaug_challange_4_victim_4 = scope:smaug_challange_4_victim_3 }}
					scope:smaug_challange_4_victim_4 = { death = { death_reason = death_burned } }
				}
				if = {
					limit = { NOT = { scope:smaug_challange_4_victim_5 = scope:smaug_challange_4_victim_4 }}
					scope:smaug_challange_4_victim_5 = { death = { death_reason = death_burned } }
				}
				if = {
					limit = { NOT = { scope:smaug_challange_4_victim_6 = scope:smaug_challange_4_victim_5 }}
					scope:smaug_challange_4_victim_6 = { death = { death_reason = death_burned } }
				}
				if = {
					limit = { NOT = { scope:smaug_challange_4_victim_7 = scope:smaug_challange_4_victim_6 }}
					scope:smaug_challange_4_victim_7 = { death = { death_reason = death_burned } }
				}

				random_list = {
					50 = {
						if = {
							limit = { NOT = { scope:smaug_challange_4_victim_8 = scope:smaug_challange_4_victim_7 }}
							scope:smaug_challange_4_victim_8 = { death = { death_reason = death_burned } }
						}
						if = {
							limit = { NOT = { scope:smaug_challange_4_victim_9 = scope:smaug_challange_4_victim_8 }}
							scope:smaug_challange_4_victim_9 = { death = { death_reason = death_burned } }
						}
						if = {
							limit = { NOT = { scope:smaug_challange_4_victim_10 = scope:smaug_challange_4_victim_9 }}
							scope:smaug_challange_4_victim_10 = { death = { death_reason = death_burned } }
						}
						if = {
							limit = { NOT = { scope:smaug_challange_4_victim_11 = scope:smaug_challange_4_victim_10 }}
							scope:smaug_challange_4_victim_11 = { death = { death_reason = death_burned } }
						}
					}
					30 = {
						if = {
							limit = { NOT = { scope:smaug_challange_4_victim_8 = scope:smaug_challange_4_victim_7 }}
							scope:smaug_challange_4_victim_8 = { death = { death_reason = death_burned } }
						}
						if = {
							limit = { NOT = { scope:smaug_challange_4_victim_9 = scope:smaug_challange_4_victim_8 }}
							scope:smaug_challange_4_victim_9 = { death = { death_reason = death_burned } }
						}
						if = {
							limit = { NOT = { scope:smaug_challange_4_victim_11 = scope:smaug_challange_4_victim_10 }}
							scope:smaug_challange_4_victim_11 = { death = { death_reason = death_burned } }
						}
					}
					15 = {
						if = {
							limit = { NOT = { scope:smaug_challange_4_victim_8 = scope:smaug_challange_4_victim_7 }}
							scope:smaug_challange_4_victim_8 = { death = { death_reason = death_burned } }
						}
					}
					5 = {}
				}
			}
		}
		trigger_event = {
			id = smaug_event_chain.0309	# Smaug flies off to lake town
			days = 5
		}
	}
}

# Smaug flies off to lake town
smaug_event_chain.0309 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0309.title
	desc = smaug_event_chain.0309.desc

    theme = war
	override_background = {
		reference = wilderness
	}

	left_portrait = {
		character = root
		animation = fear
	}

	trigger = {
		scope:leader = {
			is_alive = yes
		}
	}

	# Flavour text
	option = {
		name = smaug_event_chain.0309.a

		trigger = {
			NOT = { title:c_esgaroth.holder = character:k_wastelands_holder }
		}

		if = {
			limit = {
				title:c_esgaroth.holder.dynasty ?= dynasty:dynasty_aivadiuria
			}
			title:c_esgaroth.holder = {
				trigger_event = {
					id = smaug_event_chain.0310	# Smaug attacks lake town
					days = 1
				}
			}
		} else_if = {
			limit = {
				title:c_esgaroth.holder.liege.dynasty ?= dynasty:dynasty_aivadiuria
			}
			title:c_esgaroth.holder.liege = {
				trigger_event = {
					id = smaug_event_chain.0310	# Smaug attacks lake town
					days = 1
				}
			}
		} else_if = {
			limit = {
				title:c_esgaroth.holder.top_liege.dynasty ?= dynasty:dynasty_aivadiuria
			}
			title:c_esgaroth.holder.top_liege = {
				trigger_event = {
					id = smaug_event_chain.0310	# Smaug attacks lake town
					days = 1
				}
			}
		} else = {
			title:c_esgaroth.holder = {
				trigger_event = {
					id = smaug_event_chain.0310	# Smaug attacks lake town
					days = 1
				}
			}
		}
	}
	
	option = {
		name = smaug_event_chain.0309.b

		trigger = {
			title:c_esgaroth.holder = character:k_wastelands_holder 
		}

		trigger_event = smaug_event_chain.0315
	}
}


# Smaug in lake town
smaug_event_chain.0310 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0310.title
	desc = smaug_event_chain.0310.desc

    theme = war
	override_background = {
		reference = smaug_destruction
	}

	left_portrait = {
		character = root
		animation = hunting_longbow_aim_arrow_default
	}

	immediate = {
		save_scope_as = owner_of_late_town
		random_courtier = {
			limit = { this.dynasty = dynasty:dynasty_aivadiuria }
			save_scope_as = courtier_girion_dynasty
		}
		if = {
			limit = { root.liege.dynasty = dynasty:dynasty_aivadiuria }
			root.liege = {
				save_scope_as = liege_girion_dynasty
			}
		}
		else_if = {
			limit = { root.top_liege.dynasty = dynasty:dynasty_aivadiuria }
			root.top_liege = {
				save_scope_as = liege_girion_dynasty
			}
		}
	}

	# Owner of Lake town is from Girions dynasty / Smaug will be killed
	option = {
		name = smaug_event_chain.0310.a

		random_list = {
			# You survive.
			0 = {
				modifier = { add = lake_town_final_script_value }

				desc = smaug_event_chain.0310.success
				custom_tooltip = smaug_event_chain.0310.success.tt

				scope:leader ?= {
					trigger_event = {
						id = smaug_event_chain.0311	# Erebor is freed
						days = 5
					}
				}
			}
			# You perish.
			100 = {	
				modifier = { add = lake_town_final_script_value.neg }
				
				title:c_esgaroth = {
					if = {
						limit = { NOT = { this.title_province = { has_holding_type = ruined_holding } } }
						make_settlement_county_wilderness = { COUNTY = this }
					}
				}

				scope:liege_girion_dynasty ?= {
					trigger_event = {
						id = smaug_event_chain.0314	# Liege perspective
					}
				}

				death = { death_reason = death_burned }
				
				scope:leader ?= {
					trigger_event = {
						id = smaug_event_chain.0312	# Smaug returns to Erebor
						days = 5
					}
				}
			}
		}		
	}
}

# Smaug is killed reaction / Company leader gets Erebor
smaug_event_chain.0311 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0311.title
	desc = smaug_event_chain.0311.desc

    theme = crown
	override_background = {
		reference = wilderness
	}

	left_portrait = {
		character = root
		animation = celebrate_axe
	}	

	#immediate = { play_music_cue = lotr_cue_dwarves }
	immediate = {
		if = {
			limit = {
				NOT = { any_artifact = { has_variable = arkenstone } }
			}
			create_artifact_arkenstone_effect = { OWNER = this }
		}	
	}

	# Colonisation of Erebor
	option = {
		name = smaug_event_chain.0311.a

		add_short_term_gold = 2000
		add_prestige = 2000
		add_piety = 250
		dynasty = { add_dynasty_prestige = 1750 }

		title:b_throne_of_erebor = {
			title_province = { set_holding_type = dwarven_holding }
		}

		ai_colonisation_effect = { WASTELANDS = title:b_throne_of_erebor ROOT_SCOPE = root }

		#Create the title and make it primary
		create_title_and_vassal_change = {
			type = created
			save_scope_as = title_change
			add_claim_on_loss = yes
		}
		title:k_erebor = {
			change_title_holder = {
				holder = root
				change = scope:title_change
			}
		}
		title:d_erebor = {
			change_title_holder = {
				holder = root
				change = scope:title_change
			}
		}

		if = {
			limit = {
				is_dwarven_dynast = yes
				dynasty = dynasty:dynasty_durin
			}
			title:k_longbeards = {
				change_title_holder = {
					holder = root
					change = scope:title_change
				}
			}
		}
		resolve_title_and_vassal_change = scope:title_change

		hidden_effect = {
			current_travel_plan = { cancel_travel_plan = yes }

			title:c_golden_hall.title_province = { remove_building = smaug_desolation }
			title:c_great_foundries.title_province = { remove_building = smaug_desolation }
			title:c_arkenhalls.title_province = { remove_building = smaug_desolation }
			title:c_halls_of_steel.title_province = { remove_building = smaug_desolation }
			title:c_golddeeps.title_province = { remove_building = smaug_desolation }
			title:c_ravenhill.title_province = { remove_building = smaug_desolation }

			title:c_throne_of_erebor.title_province = { add_building = erebor_mines_01 }
		}

		if = {
			limit = {
				NOT = { has_title = title:k_longbeards }
				highest_held_title_tier <= tier_kingdom
			}
			set_primary_title_to = title:k_erebor
		}
		else_if = {
			limit = { has_title = title:k_longbeards }
			set_primary_title_to = title:k_longbeards
		}

		if = {
            limit = { # Major News
                NOT = { has_game_rule = no_news }
            }
            every_player = { #Global News Announcement
			    trigger_event = {
                    id = news_event.0053
                    days = 2
                }    
		    }
        }
		trigger_event = smaug_event_chain.0403
	}
}

# Smaug lives and return to erebor
smaug_event_chain.0312 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0312.title
	desc = smaug_event_chain.0312.desc

    theme = death
	override_background = {
		reference = wilderness
	}

	left_portrait = {
		character = root
		animation = fear
	}

	option = {
		name = smaug_event_chain.0312.a

		random_list = {
			# You survive.
			0 = {
				modifier = { add = dwarven_helm_value }
				modifier = { add = elven_sword_value }
				modifier = { add = prowess_value }
				modifier = { add = dragonslayer_artifact_value }
				modifier = { add = entourage_prowess_value_sum }
				desc = smaug_event_chain.0310.success
				custom_tooltip = smaug_event_chain.0310.success.tt
				create_artifact_smaug_skull_effect = { OWNER = this }
				trigger_event = {
					id = smaug_event_chain.0311	# Erebor is freed
				}
			}

			# You perish.
			100 = {
				modifier = { add = dwarven_helm_value.neg }
				modifier = { add = elven_sword_value.neg }
				modifier = { add = prowess_value.neg }
				modifier = { add = dragonslayer_artifact_value.neg }				
				custom_tooltip = smaug_event_chain.0312.a.tt
				death = { death_reason = death_burned }
				hidden_effect = {
					current_travel_plan = {
						every_entourage_character = {
							death = { death_reason = death_burned }
						}
					}
				}
			}
		}
	}
}

# Death of Smaug from lake town perspective (lord of town kills Smaug)
smaug_event_chain.0313 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0313.title
	desc = smaug_event_chain.0313.desc

    theme = battle
	override_background = {
		reference = burning_building
	}

	left_portrait = {
		character = root
		animation = hunting_longbow_rest_arrow_default
	}

	widgets = {
        widget = {
            gui = "lotr_shader_event_sparks"
            container = "lotr_shader_event_foreground"
        }
        widget = {
            gui = "lotr_shader_event_fire"
            container = "lotr_shader_event_background"
        }
    }

	option = {
		name = smaug_event_chain.0313.a

	}
}

# Smaug in lake town from liege/topliege perspective
smaug_event_chain.0314 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0314.title
	desc = smaug_event_chain.0314.desc

    theme = war
	override_background = {
		reference = smaug_destruction
	}

	left_portrait = {
		character = root
		animation = hunting_longbow_aim_arrow_default
	}

	option = {
		name = smaug_event_chain.0314.a

		trigger_event = {
			id = smaug_event_chain.0313	# Death of Smaug
		}
	}
}

smaug_event_chain.0315 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0315.title
	desc = smaug_event_chain.0315.desc

    theme = war
	override_background = {
		reference = smaug_destruction
	}

	left_portrait = {
		character = root
		animation = hunting_longbow_aim_arrow_default
	}

	option = {
		name = smaug_event_chain.0315.a

		random_list = {
			# You survive.
			0 = {
				modifier = { add = dwarven_helm_value }
				modifier = { add = elven_sword_value }
				modifier = { add = prowess_value }
				modifier = { add = dragonslayer_artifact_value }
				desc = smaug_event_chain.0315.success
				custom_tooltip = smaug_event_chain.0315.success.tt
				create_artifact_smaug_skull_effect = { OWNER = this }
				trigger_event = {
					id = smaug_event_chain.0311	# Erebor is freed
				}
			}
			# You perish.
			100 = {
				modifier = { add = dwarven_helm_value.neg }
				modifier = { add = elven_sword_value.neg }
				modifier = { add = prowess_value.neg }
				modifier = { add = dragonslayer_artifact_value.neg }
				custom_tooltip = smaug_event_chain.0312.a.tt
				death = { death_reason = death_burned }
				hidden_effect = {
					current_travel_plan = {
						every_entourage_character = {
							death = { death_reason = death_burned }
						}
					}	
				}
			}
		}
	}
}

################################
# Miscellaneous flavour events #
################################

# Nar fills food storage
smaug_event_chain.0400 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0400.title
	desc = {
		first_valid = {
			triggered_desc = { # Nár is in your camp
				trigger = {
					any_courtier = { this = character:lineofnar1 }
				}
				desc = smaug_event_chain.0400.desc
			}
			desc = smaug_event_chain.0400.no_nar.desc
		}
	}

    theme = travel

	override_background = {
		reference = wilderness
	}

	left_portrait = {
		character = root
		animation = happiness
	}

	right_portrait = {
		character = scope:nar
		animation = steward
	}

	immediate = {
		if = {
			limit = { any_courtier = { this = character:lineofnar1 } }
			character:lineofnar1 = {
				save_scope_as = nar
			}
		}
		else = {
			random_courtier = {
				save_scope_as = nar
			}
		}
	}

	option = {
		name = smaug_event_chain.0400.a

		custom_tooltip = smaug_event_chain.0400.a.tt

		root = {
			if = {
				limit = { NOT = { has_relation_friend = scope:nar } }
				set_relation_friend = scope:nar
				add_opinion = { modifier = friendliness_opinion target = scope:nar opinion = 15 }
			}
			else = {
				add_opinion = { modifier = friendliness_opinion target = scope:nar opinion = 15 }
			}
		}
		
		stress_impact = {
			base = minor_stress_loss
		}
		
		hidden_effect = {
			domicile = {
				if = {
					limit = { provisions < max_provisions }
					change_provisions = max_provisions
				}
			}
		}	
	}
}

# Nar fighting of orcs
smaug_event_chain.0401 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0401.title
	desc = {
		first_valid = {
			triggered_desc = { # Nár is in your camp
				trigger = {
					any_courtier = { this = character:lineofnar1 }
				}
				desc = smaug_event_chain.0401.desc
			}
			desc = smaug_event_chain.0401.no_nar.desc
		}
	}

    theme = war

	override_background = {
		reference = wilderness
	}

	left_portrait = {
		character = root
		animation = celebrate_axe
	}

	right_portrait = {
		character = scope:nar
		animation = aggressive_axe
	}

	immediate = {
		if = {
			limit = { any_courtier = { this = character:lineofnar1 } }
			character:lineofnar1 = {
				save_scope_as = nar
			}
		}
		else = {
			random_courtier = {
				save_scope_as = nar
			}
		}
	}

	option = {
		name = smaug_event_chain.0401.a

		add_prestige = medium_prestige_gain

		root = {
			if = {
				limit = { NOT = { has_relation_friend = scope:nar } }
				set_relation_friend = scope:nar
				add_opinion = { modifier = friendliness_opinion target = scope:nar opinion = 30 }
			}
			else = {
				add_opinion = { modifier = friendliness_opinion target = scope:nar opinion = 30 }
			}
		}

		scope:nar = { add_prestige = medium_prestige_gain }	
	}
}

# Girion player choice
smaug_event_chain.0402 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0402.title
	desc = smaug_event_chain.0402.desc

    theme = realm

	override_background = {
		reference = wilderness
	}

	left_portrait = {
		character = root
		animation = chancellor
	}

	right_portrait = {
		character = scope:esgaroth_holder
		animation = steward
	}

	immediate = {
		title:c_esgaroth.holder = {
			save_scope_as = esgaroth_holder
		}

		save_scope_as = Girion
	}

	# Continue playing Girion
	option = {
		name = smaug_event_chain.0402.a
	}

	# Play as holder of lake town
	option = {
		name = smaug_event_chain.0402.b

		laamp_switch_playable_character_effect = { NEW_CHARACTER = scope:esgaroth_holder }

		custom_tooltip = smaug_event_chain.0402.b.tt

		hidden_effect = {
			scope:Girion = {
				every_close_or_extended_family_member = {
					limit = { 
						is_landed = no
						is_landless_adventurer = no 
					}
					set_employer = scope:esgaroth_holder
				}

				depose = yes
				
				set_employer = scope:esgaroth_holder
			}	
		}	
	}
}

scripted_effect return_lands = {
	create_title_and_vassal_change = {
		type = returned
		save_scope_as = change
		add_claim_on_loss = no
	}
	$TITLE$ = {
		every_in_de_jure_hierarchy = {
		limit = { holder = root }
			change_title_holder = {
				holder = $KING$
				change = scope:change
			}
			hidden_effect = {
				if = {
					limit = { NOT = { county.culture = $KING$.culture } } 
					county = { set_county_culture = $KING$.culture }
				}
				if = {
					limit = { NOT = { county.faith = $KING$.faith } } 
					county = { set_county_faith = $KING$.faith }
				}
			}
		}
	}
	resolve_title_and_vassal_change = scope:change
}

scripted_trigger has_lands = {
	any_held_title = {
		$TITLE$ = {
			any_in_de_jure_hierarchy = {
				NOT = { this = $TITLE$ }
				holder = root
			}
		}
	}
}

smaug_event_chain.0403 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0403.title
	desc = smaug_event_chain.0403.desc

    theme = realm

	override_background = { reference = throne_room_dwarf }

	right_portrait = {
		character = root
		animation = steward
	}

	left_portrait = {
		character = scope:courtier
		animation = martial
	}
	
	lower_left_portrait = scope:belegost_king
	lower_right_portrait = scope:buzra_king
	lower_center_portrait = scope:my_liege

	trigger = { has_lands = { TITLE = title:e_blue_mountains } }

	immediate = {
		if = {
			limit = { has_lands = { TITLE = title:k_belegost } }
			title:k_broadbeams.holder ?= { save_scope_as = belegost_king }
		}
		if = {
			limit = { has_lands = { TITLE = title:k_buzra_dum } }
			title:k_firebeards.holder ?= { save_scope_as = buzra_king }
		}
		if = {
			limit = { is_independent_ruler = no }
			liege = { save_scope_as = my_liege }
		}

		if = {
			limit = { NOT = { exists = scope:courtier } }
			random_courtier = {
				limit = {
					NOT = { 
						dynasty = root.dynasty 
						is_close_family_of = root
					}
					is_dwarf = yes
					is_lotr_adult = yes
				}
				save_scope_as = courtier
			}
		}
	}

	# Turn all lands over to your liege
	option = {
		trigger = { is_independent_ruler = no }
		name = smaug_event_chain.0403.a
		return_lands = { KING = root.liege TITLE = title:e_blue_mountains }
		custom_tooltip = smaug_event_chain.0403.a.tt # these_lands_are_my_lieges
		# Makes them independent if their liege isn't their rightful liege anymore
		if = {
			limit = {
				scope:my_liege = {
					NOR = {
						has_title = title:e_misty_mountains
						has_title = title:e_iron_mountains
					}
				}
			}
			create_title_and_vassal_change = {
				type = independency
				save_scope_as = change
				add_claim_on_loss = no
			}
			becomes_independent = { change = scope:change }
			resolve_title_and_vassal_change = scope:change
		}
		ai_chance = {
			base = 50
			modifier = {	# 0 if lore friendly
				add = -50
				has_game_rule = default_ai_behavior
			}
		}
	}

	# Return Belegost lands to Belegost
	option = {
		trigger = { 
			exists = scope:belegost_king 
			is_independent_ruler = yes 
			has_lands = { TITLE = title:k_belegost } 
		}
		name = smaug_event_chain.0403.b
		return_lands = { KING = scope:belegost_king TITLE = title:k_belegost }
		trigger_event = smaug_event_chain.0403
		custom_tooltip = smaug_event_chain.0403.b.tt # these_lands_are_broady
		ai_chance = {
			base = 50
			modifier = {	# 0 if lore friendly
				add = -50
				has_game_rule = default_ai_behavior
			}
		}
	}

	# Return Buzra-Dum lands to Buzra-Dum
	option = {
		trigger = { 
			exists = scope:buzra_king 
			is_independent_ruler = yes 
			has_lands = { TITLE = title:k_buzra_dum } 
		}
		name = smaug_event_chain.0403.c
		return_lands = { KING = scope:buzra_king TITLE = title:k_buzra_dum }
		trigger_event = smaug_event_chain.0403
		custom_tooltip = smaug_event_chain.0403.c.tt # these_lands_are_firey
		ai_chance = {
			base = 50
			modifier = {	# 0 if lore friendly
				add = -50
				has_game_rule = default_ai_behavior
			}
		}
	}

	# Refuse to return the lands
	option = {
		trigger = {
			OR = {
				exists = scope:buzra_king
				exists = scope:belegost_king
			}
			OR = {
				has_lands = { TITLE = title:k_buzra_dum } 
				has_lands = { TITLE = title:k_belegost } 
			}
		}
		name = smaug_event_chain.0403.d
		custom_tooltip = smaug_event_chain.0403.d.tt # these_lands_are_mine

		if = {
			limit = { exists = scope:buzra_king }
			scope:buzra_king = {
				add_opinion = {
					modifier = refused_to_return_lands
					target = root
				}
			}
		}
		if = {
			limit = { exists = scope:belegost_king }
			scope:belegost_king = {
				add_opinion = {
					modifier = refused_to_return_lands
					target = root
				}
			}
		}
		ai_chance = {
			base = 50
			modifier = {	# 0 if lore friendly
				add = -50
				has_game_rule = default_ai_behavior
			}
		}
	}

	# Give them to a courtier
	option = {
		name = smaug_event_chain.0403.e
		return_lands = { KING = scope:courtier TITLE = title:e_blue_mountains }
		custom_tooltip = smaug_event_chain.0403.e.tt # will_be_vassalised_if_possible

		scope:courtier = {
			if = {
				limit = { exists = scope:belegost_king capital_province.county.duchy.kingdom = title:k_belegost }
				add_character_flag = belegost
			}
			else_if = {
				limit = { exists = scope:buzra_king capital_province.county.duchy.kingdom = title:k_buzra_dum }
				add_character_flag = buzra
			}

			if = {
				limit = {
					OR = {
						has_character_flag = belegost
						has_character_flag = buzra
					}
				}

				create_title_and_vassal_change = {
					type = swear_fealty
					save_scope_as = change
				}
				if = {
					limit = { has_character_flag = belegost }
					change_liege = {
						liege = scope:belegost_king
						change = scope:change
					}
				}
				else_if = {
					limit = { has_character_flag = buzra }
					change_liege = {
						liege = scope:buzra_king
						change = scope:change
					}
				}
				resolve_title_and_vassal_change = scope:change
			}
			else = {
				create_title_and_vassal_change = {
					type = independency
					save_scope_as = change
					add_claim_on_loss = no
				}
				becomes_independent = { change = scope:change }
				resolve_title_and_vassal_change = scope:change
			}
		}
		ai_chance = {
			base = 50
			modifier = {	# 100 if lore friendly
				add = 50
				has_game_rule = default_ai_behavior
			}
		}
	}

	# No one to return them too/returned them all
	option = {
		trigger = {
			OR = {
				NOR = {
					exists = scope:buzra_king
					exists = scope:belegost_king
				}
				NOT = {
					has_lands = { TITLE = title:k_buzra_dum } 
					has_lands = { TITLE = title:k_belegost } 
				}
			}
		}
		name = smaug_event_chain.0403.f

		if = {
			limit = {
				exists = scope:buzra_king
				exists = scope:belegost_king
				NOT = {
					has_lands = { TITLE = title:k_buzra_dum } 
					has_lands = { TITLE = title:k_belegost } 
				}
			}
			custom_tooltip = returned_lands
		}
		else_if = {
			limit = {
				exists = scope:buzra_king
				NOT = { exists = scope:belegost_king }
				NOT = { has_lands = { TITLE = title:k_buzra_dum } }
			}
			custom_tooltip = returned_lands_to_uri
		}
		else_if = {
			limit = {
				exists = scope:belegost_king
				NOT = { exists = scope:buzra_king }
				NOT = { has_lands = { TITLE = title:k_belegost } }
			}
			custom_tooltip = returned_lands_to_belegost
		}
		else_if = {
			limit = {
				NOT = { 
					exists = scope:buzra_king 
					exists = scope:belegost_king
				}
			}
			custom_tooltip = the_kings_are_gone
		}
		ai_chance = {
			base = 50
			modifier = {	# 0 if lore friendly
				add = -50
				has_game_rule = default_ai_behavior
			}
		}
	}
}