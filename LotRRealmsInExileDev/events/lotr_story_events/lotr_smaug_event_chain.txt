namespace = smaug_event_chain

### Smaug Events ### Written by Sakkar
#			smaug_event_chain.00XX		Setup
#			smaug_event_chain.0100		Smaug sacking Erebor and Dale
#			smaug_event_chain.0200		Smaug blocker events
#			smaug_event_chain.0300		Kill Smaug decision event chain


# Setup
smaug_event_chain.0001 = {	# Firing event for all effected rulers
	scope = none
	hidden = yes

	immediate = {
		title:k_durins_dummy = {
			copy_title_history = title:k_longbeards
		}
		
		# Erebor
		if = {
			limit = { title:k_erebor = { is_title_created = yes } }
			title:k_erebor.holder = {
				trigger_event = {
					id = smaug_event_chain.0100 # Smaug sacks rulers holding
				}
			}
		}
		if = {
			limit = { title:d_erebor = { is_title_created = yes } }		
			title:d_erebor.holder = { 
				trigger_event = {
					id = smaug_event_chain.0100 # Smaug sacks rulers holding
				}
			}
		}	
		title:c_throne_of_erebor.holder = { 
			trigger_event = {
				id = smaug_event_chain.0100 # Smaug sacks rulers holding
			}
		}
		title:c_ravenhill.holder = { 
			trigger_event = {
				id = smaug_event_chain.0100 # Smaug sacks rulers holding
			}
		}
		title:c_golddeeps.holder = { 
			trigger_event = {
				id = smaug_event_chain.0100 # Smaug sacks rulers holding
			}
		}
		title:c_golden_hall.holder = { 
			trigger_event = {
				id = smaug_event_chain.0100 # Smaug sacks rulers holding
			}
		}
		title:c_halls_of_steel.holder = {
			trigger_event = {
				id = smaug_event_chain.0100 # Smaug sacks rulers holding
			}
		}
		title:c_great_foundries.holder = {
			trigger_event = {
				id = smaug_event_chain.0100 # Smaug sacks rulers holding
			}
		}
		title:c_arkenhalls.holder = {
			trigger_event = {
				id = smaug_event_chain.0100 # Smaug sacks rulers holding
			}
		}
		
		# Dalelands
		if = {
			limit = { title:d_dalelands = { is_title_created = yes } }	
			title:d_dalelands.holder = {
				trigger_event = {
					id = smaug_event_chain.0100 # Smaug sacks rulers holding
				}
			}
		}	
		title:c_dale.holder = { 
			trigger_event = {
				id = smaug_event_chain.0100 # Smaug sacks rulers holding
			}
		}
		title:c_felagsgard.holder = { 
			trigger_event = {
				id = smaug_event_chain.0100 # Smaug sacks rulers holding
			}
		}
		title:c_lang_marish.holder = { 
			trigger_event = {
				id = smaug_event_chain.0100 # Smaug sacks rulers holding
			}
		}
		# Drakkenvast
		if = {
			limit = { title:d_drakkenvast = { is_title_created = yes } }	
			title:d_drakkenvast.holder = {
				trigger_event = {
					id = smaug_event_chain.0100 # Smaug sacks rulers holding
				}
			}
		}
		title:c_steinholl.holder = { 
			trigger_event = {
				id = smaug_event_chain.0100 # Smaug sacks rulers holding
			}
		}
		title:c_orlmond.holder = { 
			trigger_event = {
				id = smaug_event_chain.0100 # Smaug sacks rulers holding
			}
		}
		title:c_vargurat.holder = { 
			trigger_event = {
				id = smaug_event_chain.0100 # Smaug sacks rulers holding
			}
		}
		
	}
}

# Event chain
# Fire and Death - Smaug arrives and destruction starts event
smaug_event_chain.0100 = {	
    content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0100.title
	desc = {
		first_valid = {
			triggered_desc = { #Dwarf desc
				trigger = {
					is_dwarf = yes
				}
				desc = smaug_event_chain.0100.dwarf.desc
			}
			triggered_desc = { #Elf desc
				trigger = {
					is_elf = yes
				}
				desc = smaug_event_chain.0100.elf.desc
			}
			triggered_desc = { #Orc desc
				trigger = {
					is_orc = yes
				}
				desc = smaug_event_chain.0100.orc.desc
			}
			desc = smaug_event_chain.0100.desc
		}
	}
    theme = death
	override_background = {
		reference = smaug_arrive
	}
	cooldown = { days = 10 }

    right_portrait = {
		character = root
		animation = fear
	}

    trigger = {
		is_wastelands = no
		is_independent_ruler = yes
    }
	
    immediate = {
        # Erebor
        title:c_throne_of_erebor = { add_to_list = smaug_desolated_counties }
        title:c_ravenhill = { add_to_list = smaug_desolated_counties }
        title:c_golddeeps = { add_to_list = smaug_desolated_counties }
        title:c_golden_hall = { add_to_list = smaug_desolated_counties }
        title:c_halls_of_steel = { add_to_list = smaug_desolated_counties }
        title:c_great_foundries = { add_to_list = smaug_desolated_counties }
        title:c_arkenhalls = { add_to_list = smaug_desolated_counties }

        # Dale
        title:c_dale = { add_to_list = smaug_desolated_counties }
		title:c_felagsgard = { add_to_list = smaug_desolated_counties }
        title:c_lang_marish = { add_to_list = smaug_desolated_counties }


		# Drakkenvast
        title:c_vargurat = { add_to_list = smaug_desolated_counties }
        title:c_steinholl = { add_to_list = smaug_desolated_counties }
        title:c_orlmond = { add_to_list = smaug_desolated_counties }

		root.primary_title = { save_scope_as = primary_title }

		every_courtier = { add_to_list = courtiers_list }

		title:c_throne_of_erebor.holder = {
			every_character_artifact = {
				limit = {
					has_variable = arkenstone
				}
				save_scope_as = arkenstone
			}
		}
    }


    option = { # Oh no
        name = smaug_event_chain.0100.a

        every_in_list = {
            list = smaug_desolated_counties

			limit = { this.holder.top_liege = root }

			if = {
            	limit = { 
					not = {	this.title_province = { has_holding_type = ruined_holding } }
				}
				
				make_settlement_county_wilderness = { COUNTY = this }
			}

			if = {
				limit = {
					not = {	this.title_province = { has_building = smaug_desolation } } 
				}

            	this.title_province = { add_building = smaug_desolation	}	

            	if = {
                	limit = { 
						AND = {
							this = title:c_throne_of_erebor
							not = {	this.title_province = { has_building = smaug }	}  
						}
					}

                	this.title_province = { add_building = smaug }
            	}
			}	    
        }

        if = {
            limit = { has_title = title:k_erebor }
            destroy_title = title:k_erebor
        }

        if = {
            limit = { has_title = title:d_erebor }
            destroy_title = title:d_erebor
        }

        if = {
            limit = { has_title = title:d_dalelands }
            destroy_title = title:d_dalelands
        }

		if = {
            limit = { has_title = title:d_drakkenvast }
            destroy_title = title:d_drakkenvast
        }   

        if = {
            limit = { # Major News
                NOT = { has_game_rule = no_news }
            }
            every_player = { #Global News Announcement
			    trigger_event = {
                    id = news_event.0050
                    days = 2
                }    
		    }
        }

		# makes LAAMPS if unlanded
		if = {
			limit = { 
				has_ep3_dlc_trigger = yes
				NOT = {
					any_county = {
						holder.top_liege = root
						NOT = { is_in_list = smaug_desolated_counties }
					}
				}	 
			}
			hidden_effect = {
				create_landless_adventurer_title_effect = {
					REASON = flag:wanderer
					FLAVOR_CHAR = root
				}
				every_in_list = {
					list = courtiers_list
					limit = { NOT = { this.host = root } }
					root = { add_courtier = prev }
				}
				root.primary_title = {
					set_coa = this.holder.house
					copy_title_history = title:k_durins_dummy
				}
				if = {
					limit = {
						dynasty = dynasty:dynasty_durin
						is_dynast = yes
					} 
					root.primary_title = {
						set_title_name = Thror_camp_name
					}
				}
			}
			trigger_event = {
				id = smaug_event_chain.0101 
				days = 4
			}  
			custom_tooltip = {
				text = arkenstone_destroyed
				destroy_artifact = scope:arkenstone
			}	
		}
	}
}

# The Escape - flavour event about escaping from destruction
smaug_event_chain.0101 = {
    content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0101.title
	#desc = smaug_event_chain.0101.desc
	desc = {
		first_valid = {
			triggered_desc = { #Dwarf desc
				trigger = {
					is_dwarf = yes
				}
				desc = smaug_event_chain.0101.dwarf.desc
			}
			triggered_desc = { #Elf desc
				trigger = {
					is_elf = yes
				}
				desc = smaug_event_chain.0101.elf.desc
			}
			triggered_desc = { #Orc desc
				trigger = {
					is_orc = yes
				}
				desc = smaug_event_chain.0101.orc.desc
			}
			desc = smaug_event_chain.0101.desc
		}
	}
    theme = death
	override_background = {
		reference = smaug_destruction
	}

    right_portrait = {
		character = root
		animation = fear
	}

    trigger = {
        is_landed = no
    }

    # You are banished by Smaug (yourself)
    option = {
        name = smaug_event_chain.0101.a

		hidden_effect = {
        	trigger_event = { id = smaug_event_chain.0102 }
		}	
    }
}

# Setup event (setting up landless)
smaug_event_chain.0102 = {
	type = character_event
	hidden = yes

	trigger = {
		has_ep3_dlc_trigger = yes
	}

	on_trigger_fail = {
		#banish = yes
		death = { death_reason = death_disappearance }
	}

	immediate = {
		save_scope_as = adventurer
		if = {
			limit = { exists = liege }

			liege = { save_scope_as = liege }
		}
		add_character_flag = {
			flag = block_for_prison_release_notification
			days = 1
		}
		# AI chance
		if = {
			limit = {
				is_ai = yes
			}

			# Plus for our memory variable.
			add_character_flag = {
				flag = block_for_prison_release_message
				days = 1
			}
			# move camp away from Erebor
			scope:adventurer = {
				trigger_event = { id = smaug_event_chain.0104 }
			}

			if = {
				limit = {
					NOT = {
						government_has_flag = government_is_landless_adventurer
					}
				}
				death = { death_reason = death_disappearance }
			}
		}
		# Player event
		else = {
			trigger_event = { id = smaug_event_chain.0103 }
		}
	}
}

# The Aftermath - base game like event leting player choose if they want to play landless or not
smaug_event_chain.0103 = {
	type = character_event
	window = fullscreen_event
	title = smaug_event_chain.0103.t
	#desc = smaug_event_chain.0103.desc
	desc = {
		first_valid = {
			triggered_desc = { #Dwarf desc
				trigger = {
					is_dwarf = yes
				}
				desc = smaug_event_chain.0103.dwarf.desc
			}
			triggered_desc = { #Elf desc
				trigger = {
					is_elf = yes
				}
				desc = smaug_event_chain.0103.elf.desc
			}
			triggered_desc = { #Orc desc
				trigger = {
					is_orc = yes
				}
				desc = smaug_event_chain.0103.orc.desc
			}
			desc = smaug_event_chain.0103.desc
		}
	}
	theme = realm
	left_portrait = {
		character = root
		animation = marshal
	}
	lower_left_portrait = scope:alt_1
	lower_right_portrait = scope:alt_2
	override_background = { reference = ep3_fullscreen_adventurer_negative }
	cooldown = { days = 5 }

	trigger = {
		NOT = { has_character_flag = become_laamp_event_cooldown }
	}

	immediate = {
		add_character_flag = {
			flag = become_laamp_event_cooldown
			days = 5
		}
		save_scope_as = adventurer
		if = {
			limit = { exists = liege }

			liege = { save_scope_as = liege }
		}
		find_playable_relatives_effect = yes
	}

	option = {
		name = smaug_event_chain.0103.a
		show_as_tooltip = { banish = yes }
		hidden_effect = {
			scope:adventurer = {
				if = {
					limit = { NOT = { this = character:lineofdurin81 } }
						
					trigger_event = { id = smaug_event_chain.0104 }
				}
				else = {
					trigger_event = { id = smaug_event_chain.0105 }
				}
			}
		}
		create_landless_adventurer_title_tooltip_effect = yes
		add_internal_flag = special
	}

	option = {
		name = ep3_laamps.0001.b
		trigger = { exists = scope:alt_1 }
		show_as_tooltip = { banish = yes }
		laamp_switch_playable_character_effect = { NEW_CHARACTER = scope:alt_1 }
		hidden_effect = {
			scope:adventurer = {
				if = {
					limit = { NOT = { this = character:lineofdurin81 } }
						
					trigger_event = { id = smaug_event_chain.0104 }
				}
				else = {
					trigger_event = { id = smaug_event_chain.0105 }
				}
			}
		}
	}
	option = {
		name = ep3_laamps.0001.c
		trigger = { exists = scope:alt_2 }
		show_as_tooltip = { banish = yes }
		laamp_switch_playable_character_effect = { NEW_CHARACTER = scope:alt_2 }
		hidden_effect = {
			scope:adventurer = {
				if = {
					limit = { NOT = { this = character:lineofdurin81 } }
						
					trigger_event = { id = smaug_event_chain.0104 }
				}
				else = {
					trigger_event = { id = smaug_event_chain.0105 }
				}
			}
		}
	}
	option = {
		trigger = { is_ai = no }

		name = ep3_laamps.0001.e
		show_as_tooltip = { death = { death_reason = death_disappearance } }
		laamp_game_over_option_effect = yes
		hidden_effect = { death = { death_reason = death_disappearance } }
	}
}

# moving landless away from Erebor
smaug_event_chain.0104 = {
	type = character_event
	hidden = yes
	
	immediate = {
        title:c_zurkharukh = { add_to_list = target_counties_list }
        title:c_edricsborg = { add_to_list = target_counties_list }
        title:c_cerin_arhendhiril = { add_to_list = target_counties_list }
        title:c_aradhrynd = { add_to_list = target_counties_list }
        title:c_tham_aeldir = { add_to_list = target_counties_list }
        title:c_caras_tilion = { add_to_list = target_counties_list }
        title:c_ulgerstat = { add_to_list = target_counties_list }
		title:c_esgaroth = { add_to_list = target_counties_list }
		title:c_londaroth = { add_to_list = target_counties_list }
		title:c_hrafnvild = { add_to_list = target_counties_list }

		random_in_list = {
			list = target_counties_list
			save_scope_as = target_county
		}

		root = {
			show_as_tooltip = {
				domicile = {
					move_domicile = scope:target_county.title_province
				}
			}
			start_travel_plan = {
				destination = scope:target_county.title_province
				travel_with_domicile = yes
				return_trip = no
				players_use_planner = no
				on_arrival_destinations = last
			}	
		}
    }	
}

# Moving Thror away from Erebor
smaug_event_chain.0105 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0105.title
	desc = smaug_event_chain.0105.desc

    theme = realm
	override_background = {
		reference = wilderness_steppe
	}

    left_portrait = {
		character = root
		animation = personality_bold
	}

	immediate = {
		scope:adventurer.primary_title = {
			save_scope_as = camp_name
		}
		hidden_effect = {
			domicile = {
				change_provisions = monumental_provisions_gain
			}
		}
	}

	# Travel to Dunland
	option = {
		name = smaug_event_chain.0105.a

		add_prestige = medium_prestige_gain
		stress_impact = {
			base = minor_stress_impact_loss
        }   
		custom_tooltip = smaug_event_chain.0105.a.tt

		hidden_effect = {
			show_as_tooltip = {
				domicile = {
					move_domicile = title:c_earcnoc.title_province
				}
			}
			
			start_travel_plan = {
				destination = title:c_earcnoc.title_province
				travel_with_domicile = yes
				return_trip = no
				players_use_planner = no
				on_arrival_destinations = last
			}
			trigger_event = { id = smaug_event_chain.0106 }
		}		
	}

	# Travel to Blue Mountiens
	option = {
		name = smaug_event_chain.0105.b

		trigger = { is_ai = no }
		stress_impact = {
			base = minor_stress_impact_gain
        }
		domicile = {
			custom_tooltip = smaug_event_chain.0105.b.tt
		}	

		hidden_effect = {
			show_as_tooltip = {
				domicile = {
					move_domicile = title:c_thorins_hall.title_province
				}
			}
			start_travel_plan = {
				destination = title:c_central_high_pass.title_province
				destination = title:c_thorins_hall.title_province
				travel_with_domicile = yes
				return_trip = no
				players_use_planner = no
				on_arrival_destinations = last
			}
		}		
	}
	
	# Travel to Iron Hills
	option = {
		name = smaug_event_chain.0105.c

		trigger = { is_ai = no }

		add_prestige = medium_prestige_loss
		stress_impact = {
			base = minor_stress_impact_gain
        }
		custom_tooltip = smaug_event_chain.0105.c.tt   

		hidden_effect = {
			show_as_tooltip = {
				domicile = {
					move_domicile = title:c_azanulinbar_dum.title_province
				}
			}
			start_travel_plan = {
				destination = title:c_azanulinbar_dum.title_province
				travel_with_domicile = yes
				return_trip = no
				players_use_planner = no
				on_arrival_destinations = last
			}
		}		
	}
}	

# Hidden set up event - Thror wandering for 20 years before trying to enter Moria
smaug_event_chain.0106 = {
	type = character_event
	hidden = yes

	immediate = {
		trigger_event = {
			id = smaug_event_chain.0107
			days = 7300
		}
	}
}

# Hidden set up event - Figuring out if Thror is landless adventurer, ruler or landless.
smaug_event_chain.0107 = {
	type = character_event
	hidden = yes

	trigger = {
		character:lineofdurin81 = { is_alive = yes}
	}

	immediate = {
		character:lineofdurin81 = {
			# Thror is ruler or landless ruler
			if = {
				limit = { 
					OR = {
						is_landed = yes
						is_landless_adventurer = yes
					}
				}	
				trigger_event = { id = smaug_event_chain.0108 }
			}
			# Thror is not landed nor adventurer
			else = {
				trigger_event = { id = smaug_event_chain.0109 }
			}
		}
	}
}

# Thror moves to Moria
smaug_event_chain.0108 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0108.title
	desc = smaug_event_chain.0108.desc

    theme = realm
	override_background = {
		reference = wilderness
	}

	left_portrait = {
		character = root
		animation = personality_bold
	}

	right_portrait = {
		character = scope:Thror_primary_heir
		animation = personality_rational
	}

	trigger = {
		exists = primary_heir
		primary_heir = {
			dynasty = root.dynasty
			age >= 20
		}
	}

	immediate = {
		primary_heir = {
			save_scope_as = Thror_primary_heir
		}
		save_scope_as = Thror
	}

	option = {
		name = smaug_event_chain.0108.a

		custom_tooltip = smaug_event_chain.0108.a.tt

		hidden_effect = {
			start_travel_plan = {
				destination = title:c_east_hall.title_province
				travel_with_domicile = no
				return_trip = no
				players_use_planner = no
				on_arrival_event = smaug_event_chain.0111
				on_arrival_destinations = last
			}
		}

		every_character_artifact = {
			set_owner = {
				target = scope:Thror_primary_heir
				history = {
					location = character:lineofdurin81.location
					actor = character:lineofdurin81
					recipient = scope:Thror_primary_heir
					type = given
				}
			}
		}

		trigger_event = {
			id = smaug_event_chain.0110
			days = 2
		}
	}
}


# Thror landless advnturer moves to Moria
smaug_event_chain.0109 = {
	type = character_event
	hidden = yes

	immediate = {
		if = {
			limit = { character:lineofdurin82 = { is_alive = yes } }
			character:lineofdurin82 = {
				save_scope_as = Thror_primary_heir
			}
		}
		else_if = {
			limit = { character:lineofdurin83 = { is_alive = yes } }
			character:lineofdurin83 = {
				save_scope_as = Thror_primary_heir
			}
		}
		else_if = {
			limit = { 
				any_child = { is_alive = yes } 
			}
			random_child = {
				limit = { is_alive = yes } 
				save_scope_as = Thror_primary_heir
			}
		}
		else_if = {
			limit = { 
				any_extended_family_member = { is_alive = yes } 
			}
			random_extended_family_member= {
				limit = { is_alive = yes } 
				save_scope_as = Thror_primary_heir
			}
		}

		create_landless_adventurer_title_effect = {
			REASON = flag:wanderer
			FLAVOR_CHAR = character:lineofdurin81
		}
		this.primary_title = {
			set_coa = this.holder.house
		}
		this.primary_title = {
			set_title_name = Thror_camp_name_khazad_dum
		}
		hidden_effect = {
			show_as_tooltip = {
				domicile = {
					move_domicile = title:c_east_hall.title_province
				}
			}
			start_travel_plan = {
				destination = title:c_east_hall.title_province
				travel_with_domicile = yes
				return_trip = no
				players_use_planner = no
				on_arrival_event = smaug_event_chain.0111
				on_arrival_destinations = last
			}
			current_travel_plan = { add_travel_plan_modifier = travel_alone_with_strangers_modifier }
		}
		every_character_artifact = {
			set_owner = {
				target = scope:Thror_primary_heir
				history = {
					location = character:lineofdurin81.location
					actor = character:lineofdurin81
					recipient = scope:Thror_primary_heir
					type = given
				}
			}
		}

		trigger_event = {
			id = smaug_event_chain.0110
			days = 2
		}
	}
}

# Nar joins Thror
smaug_event_chain.0110 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0110.title
	desc = smaug_event_chain.0110.desc

    theme = realm
	override_background = {
		reference = wilderness
	}

	left_portrait = {
		character = root
		animation = personality_bold
	}

	right_portrait = {
		character = scope:Nar
		animation = personality_rational
	}

	immediate = {
		hidden_effect = {
			current_travel_plan = {
				every_entourage_character = {
					limit = { NOT = { this = character:lineofdurin81 } }
					current_travel_plan = { remove_character = prev }
				}
			}
		
			create_character = {
				name = Nar_dwarf_name
				location = root.location
				culture = root.culture
				faith = root.faith
				dynasty = none
				gender_female_chance = 0
				save_scope_as = Nar
					
				after_creation = {
					if = {
						limit = { is_elf = yes }
						change_age = { 100 6950 }
						replace_unelven_traits = yes
					}
					if = {
						limit = { is_dwarf = yes }
						change_age = { 65 180 }
					}
				}
			}
			scope:Nar = { set_to_lowborn = yes }
		}
	}	

	option = {
		name = smaug_event_chain.0110.a

		scope:Nar = {
			add_to_court_and_entourage_effect = yes
		}	
	}	
}

# Thror enter Moria
smaug_event_chain.0111 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0111.title
	desc = smaug_event_chain.0111.desc

    theme = realm
	override_background = {
		reference = wilderness
	}

	left_portrait = {
		character = root
		animation = personality_bold
	}

	immediate = {
		title:c_east_hall.holder.top_liege = {
			save_scope_as = Azog
		}
	}

	trigger = {
		title:c_east_hall.holder.top_liege = {
			is_orc = yes
		}
	}

	option = {
		name = smaug_event_chain.0111.a
		scope:Azog = {
			trigger_event = smaug_event_chain.0113
		}
	}
}

# End of Thror
smaug_event_chain.0112 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0112.title
	desc = smaug_event_chain.0112.desc

    theme = war
	override_background = {
		reference = wilderness
	}

	left_portrait = {
		character = root
		animation = anger
	}

	right_portrait = {
		character = scope:Azog
		animation = personality_bold
	}	

	trigger = {
		title:c_east_hall.holder.top_liege = {
			is_orc = yes
		}
	}

	option = {
		name = smaug_event_chain.0112.a

		set_relation_nemesis = {
			reason = nemesis_house_feud
			target = scope:Azog
		}	

		death = { death_reason = death_decapitated killer = scope:Azog }
		
		hidden_effect = {
			scope:Thror_primary_heir = {
				trigger_event = {
					id = smaug_event_chain.0114
					days = 7
				}	
			}
		}	
	}
}

# Orc pov of Thror entering Moria
smaug_event_chain.0113 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0113.title
	desc = smaug_event_chain.0113.desc

    theme = war
	override_background = {
		reference = wilderness_underground
	}
	immediate = {
		ordered_ruler = {
			limit = {
				is_dwarf = yes
				is_dynast = yes
				dynasty = dynasty:dynasty_durin
			}
			save_scope_as = Thror
		}
	}
	left_portrait = {
		character = root
		animation = personality_bold
	}

	right_portrait = {
		character = scope:Thror
		animation = fear
	}	

	option = { # Behead and brand the beggar
		name = smaug_event_chain.0113.a	
		custom_tooltip = smaug_event_chain.0113.a.tt
		add_prestige = major_prestige_gain
		show_as_tooltip = {
			scope:Thror = { death = { death_reason = death_decapitated killer = scope:Azog } }
		}
		scope:Thror = {
			trigger_event = smaug_event_chain.0112
		}
		give_nickname = nick_the_defiler
		ai_chance = { base = 100 }
	}
	option = { # Shave his beard and send him on his way
		name = smaug_event_chain.0013.b 
		add_dread = massive_dread_gain
		add_stress = -50
		scope:Thror = {
			add_trait = beardless
			add_opinion = {
				modifier = shaved_me
				target = root 
			}
			trigger_event = smaug_event_chain.0115
		}
	}
}

# Nar tells the news about Thrors death
smaug_event_chain.0114 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0114.title
	desc = smaug_event_chain.0114.desc

	left_portrait = {
		character = scope:Thror_primary_heir
		animation = personality_bold
	}

	right_portrait = {
		character = scope:Nar
		animation = sadness
	}

	theme = war
	override_background = {
		reference = wilderness
	}
	
	immediate = {
		add_pressed_claim = title:d_zirakzigil
		add_pressed_claim = title:k_khazad_dum
	}
	
	option = {
		name = smaug_event_chain.0114.a

		set_relation_nemesis = {
			reason = nemesis_house_feud
			target = scope:Azog
		}	

		if = {
            limit = { # Major News
                NOT = { has_game_rule = no_news }
            }
            every_player = { #Global News Announcement
			    trigger_event = {
                    id = news_event.0051
                    days = 2
                }    
		    }
        }
	}
}

# Thrór is shaved and shamed
smaug_event_chain.0115 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0115.title
	desc = smaug_event_chain.0115.desc

    theme = war
	override_background = {
		reference = wilderness_mountains
	}

	left_portrait = {
		character = root
		animation = rage
	}

	right_portrait = {
		character = scope:Azog
		animation = personality_callous
	}	
	
	immediate = {
		primary_heir = {
			save_scope_as = Thror_primary_heir
		}
		save_scope_as = Thror
		title:c_east_hall.holder.top_liege = { save_scope_as = Azog }
		set_relation_nemesis = {
			reason = nemesis_house_feud
			target = scope:Azog
		}	
		root = { save_scope_as = Thror }
		show_as_tooltip = {
			add_trait = beardless
			add_opinion = {
				modifier = shaved_me
				target = scope:Azog 
			}
		}
	}

	trigger = {
		title:c_east_hall.holder.top_liege = {
			is_orc = yes
		}
	}

	option = {
		name = smaug_event_chain.0115.a
		hidden_effect = { scope:Thror_primary_heir = { get_title = title:k_durins_dummy } }
		set_player_character = scope:Thror_primary_heir
		scope:Thror_primary_heir = { get_title = root.primary_title }
		hidden_effect = {
			scope:Thror_primary_heir = {
				trigger_event = {
					id = smaug_event_chain.0114
					days = 7
				}	
			}
			destroy_title = title:k_durins_dummy
		}	
	}
}

# Blocker events
smaug_event_chain.0200 = {	#	Desolation of Smaug blocker - Smaug lives
	content_source = realms_dlc
	type = character_event
	title = smaug_event_chain.0200.t
	desc = {
		first_valid = {
			triggered_desc = { #Smaug lives desc
				trigger = {
					title:c_throne_of_erebor.title_province = { has_building = smaug }
				}
				desc = smaug_event_chain.0200.danger.desc
			}
			desc = smaug_event_chain.0200.desc
		}
	}			

	theme = balrog

	left_portrait = {
		character = root
		triggered_animation = {
			trigger = {
				title:c_throne_of_erebor.title_province = { has_building = smaug }
			}
			animation = fear
		}
		triggered_animation = {
			trigger = {
				NOT = { title:c_throne_of_erebor.title_province = { has_building = smaug } }
			}
			animation = personality_rational
		}
		animation = idle
	}

	override_background = {
		reference = wilderness_mountains
	}

	option = { # Settlement cant be further developed
		name = smaug_event_chain.0200.a

		trigger = {
			title:c_throne_of_erebor.title_province = { has_building = smaug }
		}

		send_interface_toast = {
			left_icon = root
			title = smaug_event_chain.0200.a.toast.t
			increase_wounds_effect = { REASON = wild_animal }
			hidden_effect = { scope:obstacle_province = { remove_building = smaug_desolation_cleared } }
			scope:obstacle_province = { add_building = smaug_desolation }
			make_settlement_county_wilderness = {
				COUNTY = scope:obstacle_province.county
			}
		}
		stress_impact = {
			base = major_stress_gain
			craven = major_stress_gain
		}
	}

	option = { # Settlement is further developed
		name = smaug_event_chain.0200.b

		trigger = {
			NOT = { title:c_throne_of_erebor.title_province = { has_building = smaug } }
		}

		send_interface_toast = {
			left_icon = root
			title = smaug_event_chain.0200.b.toast.t
			add_prestige = 50
			hidden_effect = { scope:obstacle_province = { remove_building = smaug_desolation_cleared } }
		}
	}
}

###################################
# Kill Smaug Decision Event Chain #
###################################

# Starting the journey
smaug_event_chain.0300 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0300.title
	desc = smaug_event_chain.0300.desc

    theme = realm
	override_background = {
		reference = wilderness
	}

	left_portrait = {
		character = root
		animation = personality_bold
	}

	immediate = {
		save_scope_as = leader
	}

	option = {
		name = smaug_event_chain.0300.a

		custom_tooltip = smaug_event_chain.0300.a.tt

		hidden_effect = {
			start_travel_plan = {
				destination = title:c_throne_of_erebor.title_province
				travel_with_domicile = no
				return_trip = no
				players_use_planner = no
				on_arrival_event = smaug_event_chain.0301
				on_arrival_destinations = last
			}
		}
	}
}

# Arriving at Erebor / Intrigue challange 1
smaug_event_chain.0301 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0301.title
	desc = smaug_event_chain.0301.desc

    theme = intrigue
	override_background = {
		reference = wilderness
	}

	left_portrait = {
		character = root
		animation = celebrate_axe
	}

	# Sneaking in through main gate
	option = {
		name = smaug_event_chain.0301.a

		duel = {
			skill = intrigue
			value = average_skill_rating
			50 = {	# You succesfully sneak in
				desc = smaug_event_chain.0301.a.success
				
				trigger_event = {
					id = smaug_event_chain.0302	# Sneaking continues
				}
				add_character_flag = smaug_fight_advantage_1
			}
			50 = {	# Smaug is awakened
				desc = smaug_event_chain.0301.a.failure
				
				trigger_event = {
					id = smaug_event_chain.0304	# Smaug awakened
				}
			}
		}
	}

	# Sneaking in through hidden entrance
	option = {
		name = smaug_event_chain.0301.b

		trigger = {
			any_character_artifact = {
				has_variable = key_of_erebor
			}
		}

		custom_tooltip = smaug_event_chain.0301.b.tt

		add_character_flag = smaug_fight_advantage_1
		add_character_flag = smaug_fight_hidden

		trigger_event = {
			id = smaug_event_chain.0302	# Sneaking continues
		}
	}
}

# Intrigue challange 2
smaug_event_chain.0302 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0302.title
	desc = smaug_event_chain.0302.desc

    theme = intrigue
	override_background = {
		reference = wilderness
	}

	left_portrait = {
		character = root
		animation = celebrate_axe
	}

	# Sneaking in through main gate
	option = {
		name = smaug_event_chain.0302.a

		trigger = {
			NOT = { has_character_flag = smaug_fight_hidden }
		}

		duel = {
			skill = intrigue
			value = average_skill_rating
			30 = {	# You succesfully sneak in
				desc = smaug_event_chain.0302.a.success
				
				trigger_event = {
					id = smaug_event_chain.0303	# Sneaking continues
				}
				add_character_flag = smaug_fight_advantage_2
			}
			70 = {	# Smaug is awakened
				desc = smaug_event_chain.0302.a.failure
				
				trigger_event = {
					id = smaug_event_chain.0304	# Smaug awakened
				}
			}
		}
	}

	# Sneaking in through hidden entrance
	option = {
		name = smaug_event_chain.0302.b

		trigger = {
			has_character_flag = smaug_fight_hidden
		}

		duel = {
			skill = intrigue
			value = average_skill_rating
			50 = {	# You succesfully sneak in
				desc = smaug_event_chain.0302.b.success
				
				trigger_event = {
					id = smaug_event_chain.0303	# Sneaking continues
				}
				add_character_flag = smaug_fight_advantage_2
			}
			50 = {	# Smaug is awakened
				desc = smaug_event_chain.0302.b.failure
				
				trigger_event = {
					id = smaug_event_chain.0304	# Smaug awakened
				}
			}
		}
	}
}

# Intrigue challange 3
smaug_event_chain.0303 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0303.title
	desc = smaug_event_chain.0303.desc

    theme = intrigue
	override_background = {
		reference = wilderness
	}

	left_portrait = {
		character = root
		animation = celebrate_axe
	}

	# Sneaking in through main gate
	option = {
		name = smaug_event_chain.0303.a

		trigger = {
			NOT = { has_character_flag = smaug_fight_hidden }
		}

		duel = {
			skill = intrigue
			value = average_skill_rating
			10 = {	# You succesfully sneak in
				desc = smaug_event_chain.0303.a.success
				
				trigger_event = {
					id = smaug_event_chain.0304	# You suprised Smaug
				}
				add_character_flag = smaug_fight_advantage_3
			}
			90 = {	# Smaug is awakened
				desc = smaug_event_chain.0303.a.failure
				
				trigger_event = {
					id = smaug_event_chain.0304	# Smaug awakened
				}
			}
		}
	}

	# Sneaking in through hidden entrance
	option = {
		name = smaug_event_chain.0303.b

		trigger = {
			has_character_flag = smaug_fight_hidden
		}

		duel = {
			skill = intrigue
			value = average_skill_rating
			30 = {	# You succesfully sneak in
				desc = smaug_event_chain.0303.b.success
				
				trigger_event = {
					id = smaug_event_chain.0304	# You suprised Smaug
				}
				add_character_flag = smaug_fight_advantage_3
			}
			70 = {	# Smaug is awakened
				desc = smaug_event_chain.0303.b.failure
				
				trigger_event = {
					id = smaug_event_chain.0304	# Smaug awakened
				}
			}
		}
	}
}

# Smaug awakeness
smaug_event_chain.0304 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0304.title
	desc = smaug_event_chain.0304.desc

    theme = intrigue
	override_background = {
		reference = smaug_destruction
	}

	left_portrait = {
		character = root
		animation = fear
	}

	# Flavour text
	option = {
		name = smaug_event_chain.0304.a

		trigger_event = {
			id = smaug_event_chain.0305	# Smaug fight 1
		}
	}
}

# Martial challange 1
smaug_event_chain.0305 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0305.title
	desc = smaug_event_chain.0305.desc

    theme = intrigue
	override_background = {
		reference = smaug_destruction
	}

	left_portrait = {
		character = root
		animation = aggressive_axe
	}

	trigger = {
		scope:leader = {
			is_alive = yes
		}
	}

	immediate = {
		current_travel_plan = {
			if = {
				limit = { any_entourage_character = { count >= 1 } }
				random_entourage_character = {
					save_scope_as = smaug_challange_1_victim_1
				}
			}
			else = { root = { save_scope_as = smaug_challange_1_victim_1 } }
			
			if = {
				limit = { any_entourage_character = { count >= 2 } }
				random_entourage_character = {
					limit = { NOT = { this = scope:smaug_challange_1_victim_1 } }
					save_scope_as = smaug_challange_1_victim_2
				}
			}
			else = { root = { save_scope_as = smaug_challange_1_victim_2 } }

			if = {
				limit = { any_entourage_character = { count >= 3 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_1_victim_1 }
							NOT = { this = scope:smaug_challange_1_victim_2 }  
						}
					}	
					save_scope_as = smaug_challange_1_victim_3
				}
			}
			else = { root = { save_scope_as = smaug_challange_1_victim_3 } }
			
			if = {
				limit = { any_entourage_character = { count >= 4 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_1_victim_1 }
							NOT = { this = scope:smaug_challange_1_victim_2 }
							NOT = { this = scope:smaug_challange_1_victim_3 }   
						}
					}	
					save_scope_as = smaug_challange_1_victim_4
				}
			}
			else = { root = { save_scope_as = smaug_challange_1_victim_4 } }
			
			if = {
				limit = { any_entourage_character = { count >= 5 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_1_victim_1 }
							NOT = { this = scope:smaug_challange_1_victim_2 }
							NOT = { this = scope:smaug_challange_1_victim_3 }
							NOT = { this = scope:smaug_challange_1_victim_4 }     
						}
					}
					save_scope_as = smaug_challange_1_victim_5
				}
			}
			else = { root = { save_scope_as = smaug_challange_1_victim_5 } }
			
			if = {
				limit = { any_entourage_character = { count >= 6 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_1_victim_1 }
							NOT = { this = scope:smaug_challange_1_victim_2 }
							NOT = { this = scope:smaug_challange_1_victim_3 }
							NOT = { this = scope:smaug_challange_1_victim_4 }
							NOT = { this = scope:smaug_challange_1_victim_5 }      
						}
					}
					save_scope_as = smaug_challange_1_victim_6
				}
			}
			else = { root = { save_scope_as = smaug_challange_1_victim_6 } }

			if = {
				limit = { any_entourage_character = { count >= 7 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_1_victim_1 }
							NOT = { this = scope:smaug_challange_1_victim_2 }
							NOT = { this = scope:smaug_challange_1_victim_3 }
							NOT = { this = scope:smaug_challange_1_victim_4 }
							NOT = { this = scope:smaug_challange_1_victim_5 } 
							NOT = { this = scope:smaug_challange_1_victim_6 }      
						}
					}
					save_scope_as = smaug_challange_1_victim_7
				}
			}
			else = { root = { save_scope_as = smaug_challange_1_victim_7 } }
		}
	}

	# Fight
	option = {
		name = smaug_event_chain.0305.a

		duel = {
			skill = prowess
			value = average_skill_rating
			40 = {	# No dwarf dies
				modifier = {
					add = {
						value = root.prowess
						multiply = 0.01
					}
				}
				modifier = {
					has_character_flag = smaug_fight_advantage_1
					add = {
						value = root.prowess
						multiply = 0.5
					}
				}
				modifier = {
					has_character_flag = smaug_fight_advantage_2
					add = {
						value = root.prowess
						multiply = 0.5
					}
				}
				modifier = {
					has_character_flag = smaug_fight_advantage_3
					add = {
						value = root.prowess
						multiply = 1
					}
				}

				desc = smaug_event_chain.0305.a.success
				
			}
			60 = {	# Smaug kills dwarves
				desc = smaug_event_chain.0305.a.failure

				scope:smaug_challange_1_victim_1 = { death = { death_reason = death_burned } }
				if = {
					limit = { NOT = { scope:smaug_challange_1_victim_2 = scope:smaug_challange_1_victim_1 }}
					scope:smaug_challange_1_victim_2 = { death = { death_reason = death_burned } }
				}
				if = {
					limit = { NOT = { scope:smaug_challange_1_victim_3 = scope:smaug_challange_1_victim_2 }}
					scope:smaug_challange_1_victim_3 = { death = { death_reason = death_burned } }
				}
				if = {
					limit = { NOT = { scope:smaug_challange_1_victim_4 = scope:smaug_challange_1_victim_3 }}
					scope:smaug_challange_1_victim_4 = { death = { death_reason = death_burned } }
				}
				if = {
					limit = { NOT = { scope:smaug_challange_1_victim_5 = scope:smaug_challange_1_victim_4 }}
					scope:smaug_challange_1_victim_5 = { death = { death_reason = death_burned } }
				}

				random_list = {
					20 = {
						if = {
							limit = { NOT = { scope:smaug_challange_1_victim_6 = scope:smaug_challange_1_victim_5 }}
							scope:smaug_challange_1_victim_6 = { death = { death_reason = death_burned } }
						}
						if = {
							limit = { NOT = { scope:smaug_challange_1_victim_7 = scope:smaug_challange_1_victim_6 }}
							scope:smaug_challange_1_victim_7 = { death = { death_reason = death_burned } }
						}
					}
					80 = {}
				}
			}
		}
		trigger_event = {
			id = smaug_event_chain.0306	# Smaug fight 2 
		}
	}
}

# Martial challange 2
smaug_event_chain.0306 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0306.title
	desc = smaug_event_chain.0306.desc

    theme = intrigue
	override_background = {
		reference = smaug_destruction
	}

	left_portrait = {
		character = root
		animation = aggressive_axe
	}

	trigger = {
		scope:leader = {
			is_alive = yes
		}
	}

	immediate = {
		current_travel_plan = {
			if = {
				limit = { any_entourage_character = { count >= 1 } }
				random_entourage_character = {
					save_scope_as = smaug_challange_2_victim_1
				}
			}
			else = { root = { save_scope_as = smaug_challange_2_victim_1 } }
			
			if = {
				limit = { any_entourage_character = { count >= 2 } }
				random_entourage_character = {
					limit = { NOT = { this = scope:smaug_challange_2_victim_1 } }
					save_scope_as = smaug_challange_2_victim_2
				}
			}
			else = { root = { save_scope_as = smaug_challange_2_victim_2 } }

			if = {
				limit = { any_entourage_character = { count >= 3 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_2_victim_1 }
							NOT = { this = scope:smaug_challange_2_victim_2 }  
						}
					}	
					save_scope_as = smaug_challange_2_victim_3
				}
			}
			else = { root = { save_scope_as = smaug_challange_2_victim_3 } }
			
			if = {
				limit = { any_entourage_character = { count >= 4 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_2_victim_1 }
							NOT = { this = scope:smaug_challange_2_victim_2 }
							NOT = { this = scope:smaug_challange_2_victim_3 }   
						}
					}	
					save_scope_as = smaug_challange_2_victim_4
				}
			}
			else = { root = { save_scope_as = smaug_challange_2_victim_4 } }

			if = {
				limit = { any_entourage_character = { count >= 5 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_2_victim_1 }
							NOT = { this = scope:smaug_challange_2_victim_2 }
							NOT = { this = scope:smaug_challange_2_victim_3 }
							NOT = { this = scope:smaug_challange_2_victim_4 }   
						}
					}	
					save_scope_as = smaug_challange_2_victim_5
				}
			}
			else = { root = { save_scope_as = smaug_challange_2_victim_5 } }

			if = {
				limit = { any_entourage_character = { count >= 6 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_2_victim_1 }
							NOT = { this = scope:smaug_challange_2_victim_2 }
							NOT = { this = scope:smaug_challange_2_victim_3 }
							NOT = { this = scope:smaug_challange_2_victim_4 }
							NOT = { this = scope:smaug_challange_2_victim_5 }    
						}
					}	
					save_scope_as = smaug_challange_2_victim_6
				}
			}
			else = { root = { save_scope_as = smaug_challange_2_victim_6 } }
		}
	}

	# Fight
	option = {
		name = smaug_event_chain.0306.a

		duel = {
			skill = prowess
			value = average_skill_rating
			30 = {	# No dwarf dies
				modifier = {
					add = {
						value = root.prowess
						multiply = 0.01
					}
				}
				modifier = {
					has_character_flag = smaug_fight_advantage_1
					add = {
						value = root.prowess
						multiply = 0.5
					}
				}
				modifier = {
					has_character_flag = smaug_fight_advantage_2
					add = {
						value = root.prowess
						multiply = 0.5
					}
				}
				modifier = {
					has_character_flag = smaug_fight_advantage_3
					add = {
						value = root.prowess
						multiply = 1
					}
				}

				desc = smaug_event_chain.0306.a.success
				
			}
			70 = {	# Smaug kills dwarves
				desc = smaug_event_chain.0306.a.failure

				scope:smaug_challange_2_victim_1 = { death = { death_reason = death_burned } }
				if = {
					limit = { NOT = { scope:smaug_challange_2_victim_2 = scope:smaug_challange_2_victim_1 }}
					scope:smaug_challange_2_victim_2 = { death = { death_reason = death_burned } }
				}
				if = {
					limit = { NOT = { scope:smaug_challange_2_victim_3 = scope:smaug_challange_2_victim_2 }}
					scope:smaug_challange_2_victim_3 = { death = { death_reason = death_burned } }
				}
				if = {
					limit = { NOT = { scope:smaug_challange_2_victim_4 = scope:smaug_challange_2_victim_3 }}
					scope:smaug_challange_2_victim_4 = { death = { death_reason = death_burned } }
				}

				random_list = {
					60 = {
						if = {
							limit = { NOT = { scope:smaug_challange_2_victim_5 = scope:smaug_challange_2_victim_4 }}
							scope:smaug_challange_2_victim_5 = { death = { death_reason = death_burned } }
						}
						if = {
							limit = { NOT = { scope:smaug_challange_2_victim_6 = scope:smaug_challange_2_victim_5 }}
							scope:smaug_challange_2_victim_6 = { death = { death_reason = death_burned } }
						}
					}
					40 = {}
				}
			}
		}
		trigger_event = {
			id = smaug_event_chain.0307	# Smaug fight 2 
		}
	}
}

# Martial challange 3
smaug_event_chain.0307 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0307.title
	desc = smaug_event_chain.0307.desc

    theme = intrigue
	override_background = {
		reference = smaug_destruction
	}

	left_portrait = {
		character = root
		animation = aggressive_axe
	}

	trigger = {
		scope:leader = {
			is_alive = yes
		}
	}

	immediate = {
		current_travel_plan = {
			if = {
				limit = { any_entourage_character = { count >= 1 } }
				random_entourage_character = {
					save_scope_as = smaug_challange_3_victim_1
				}
			}
			else = { root = { save_scope_as = smaug_challange_3_victim_1 } }
			
			if = {
				limit = { any_entourage_character = { count >= 2 } }
				random_entourage_character = {
					limit = { NOT = { this = scope:smaug_challange_3_victim_1 } }
					save_scope_as = smaug_challange_3_victim_2
				}
			}
			else = { root = { save_scope_as = smaug_challange_3_victim_2 } }
			
			if = {
				limit = { any_entourage_character = { count >= 3 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_3_victim_1 }
							NOT = { this = scope:smaug_challange_3_victim_2 }  
						}
					}	
					save_scope_as = smaug_challange_3_victim_3
				}
			}
			else = { root = { save_scope_as = smaug_challange_3_victim_3 } }
			
			if = {
				limit = { any_entourage_character = { count >= 4 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_3_victim_1 }
							NOT = { this = scope:smaug_challange_3_victim_2 }
							NOT = { this = scope:smaug_challange_3_victim_3 }   
						}
					}	
					save_scope_as = smaug_challange_3_victim_4
				}
			}
			else = { root = { save_scope_as = smaug_challange_3_victim_4 } }
			
			if = {
				limit = { any_entourage_character = { count >= 5 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_3_victim_1 }
							NOT = { this = scope:smaug_challange_3_victim_2 }
							NOT = { this = scope:smaug_challange_3_victim_3 }
							NOT = { this = scope:smaug_challange_3_victim_4 }     
						}
					}
					save_scope_as = smaug_challange_3_victim_5
				}
			}
			else = { root = { save_scope_as = smaug_challange_3_victim_5 } }
			
			if = {
				limit = { any_entourage_character = { count >= 6 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_3_victim_1 }
							NOT = { this = scope:smaug_challange_3_victim_2 }
							NOT = { this = scope:smaug_challange_3_victim_3 }
							NOT = { this = scope:smaug_challange_3_victim_4 }
							NOT = { this = scope:smaug_challange_3_victim_5 }     
						}
					}
					save_scope_as = smaug_challange_3_victim_6
				}
			}
			else = { root = { save_scope_as = smaug_challange_3_victim_6 } }
			
			if = {
				limit = { any_entourage_character = { count >= 7 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_3_victim_1 }
							NOT = { this = scope:smaug_challange_3_victim_2 }
							NOT = { this = scope:smaug_challange_3_victim_3 }
							NOT = { this = scope:smaug_challange_3_victim_4 }
							NOT = { this = scope:smaug_challange_3_victim_5 }
							NOT = { this = scope:smaug_challange_3_victim_6 }      
						}
					}
					save_scope_as = smaug_challange_3_victim_7
				}
			}
			else = { root = { save_scope_as = smaug_challange_3_victim_7 } }
			
			if = {
				limit = { any_entourage_character = { count >= 8 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_3_victim_1 }
							NOT = { this = scope:smaug_challange_3_victim_2 }
							NOT = { this = scope:smaug_challange_3_victim_3 }
							NOT = { this = scope:smaug_challange_3_victim_4 }
							NOT = { this = scope:smaug_challange_3_victim_5 }
							NOT = { this = scope:smaug_challange_3_victim_6 }
							NOT = { this = scope:smaug_challange_3_victim_7 }        
						}
					}
					save_scope_as = smaug_challange_3_victim_8
				}
			}
			else = { root = { save_scope_as = smaug_challange_3_victim_8 } }

			if = {
				limit = { any_entourage_character = { count >= 9 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_3_victim_1 }
							NOT = { this = scope:smaug_challange_3_victim_2 }
							NOT = { this = scope:smaug_challange_3_victim_3 }
							NOT = { this = scope:smaug_challange_3_victim_4 }
							NOT = { this = scope:smaug_challange_3_victim_5 }
							NOT = { this = scope:smaug_challange_3_victim_6 }
							NOT = { this = scope:smaug_challange_3_victim_7 }
							NOT = { this = scope:smaug_challange_3_victim_8 }          
						}
					}
					save_scope_as = smaug_challange_3_victim_9
				}
			}
			else = { root = { save_scope_as = smaug_challange_3_victim_9 } }	
		}
	}

	# Fight
	option = {
		name = smaug_event_chain.0307.a

		duel = {
			skill = prowess
			value = average_skill_rating
			20 = {	# No dwarf dies
				modifier = {
					add = {
						value = root.prowess
						multiply = 0.01
					}
				}
				modifier = {
					has_character_flag = smaug_fight_advantage_1
					add = {
						value = root.prowess
						multiply = 0.5
					}
				}
				modifier = {
					has_character_flag = smaug_fight_advantage_2
					add = {
						value = root.prowess
						multiply = 0.5
					}
				}
				modifier = {
					has_character_flag = smaug_fight_advantage_3
					add = {
						value = root.prowess
						multiply = 1
					}
				}

				desc = smaug_event_chain.0307.a.success
				
			}
			80 = {	# Smaug kills dwarves
				desc = smaug_event_chain.0307.a.failure

				scope:smaug_challange_3_victim_1 = { death = { death_reason = death_burned } }
				if = {
					limit = { NOT = { scope:smaug_challange_3_victim_2 = scope:smaug_challange_3_victim_1 }}
					scope:smaug_challange_3_victim_2 = { death = { death_reason = death_burned } }
				}
				if = {
					limit = { NOT = { scope:smaug_challange_3_victim_3 = scope:smaug_challange_3_victim_2 }}
					scope:smaug_challange_3_victim_3 = { death = { death_reason = death_burned } }
				}
				if = {
					limit = { NOT = { scope:smaug_challange_3_victim_4 = scope:smaug_challange_3_victim_3 }}
					scope:smaug_challange_3_victim_4 = { death = { death_reason = death_burned } }
				}
				if = {
					limit = { NOT = { scope:smaug_challange_3_victim_5 = scope:smaug_challange_3_victim_4 }}
					scope:smaug_challange_3_victim_5 = { death = { death_reason = death_burned } }
				}
				if = {
					limit = { NOT = { scope:smaug_challange_3_victim_6 = scope:smaug_challange_3_victim_5 }}
					scope:smaug_challange_3_victim_6 = { death = { death_reason = death_burned } }
				}

				random_list = {
					80 = {
						if = {
							limit = { NOT = { scope:smaug_challange_3_victim_7 = scope:smaug_challange_3_victim_6 }}
							scope:smaug_challange_3_victim_7 = { death = { death_reason = death_burned } }
						}
						if = {
							limit = { NOT = { scope:smaug_challange_3_victim_8 = scope:smaug_challange_3_victim_7 }}
							scope:smaug_challange_3_victim_8 = { death = { death_reason = death_burned } }
						}
						if = {
							limit = { NOT = { scope:smaug_challange_3_victim_9 = scope:smaug_challange_3_victim_8 }}
							scope:smaug_challange_3_victim_9 = { death = { death_reason = death_burned } }
						}
					}
					20 = {}
				}
			}
		}
		trigger_event = {
			id = smaug_event_chain.0308	# Smaug fight 2 
		}
	}
}

# Martial challange 4
smaug_event_chain.0308 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0308.title
	desc = smaug_event_chain.0308.desc

    theme = intrigue
	override_background = {
		reference = smaug_destruction
	}

	left_portrait = {
		character = root
		animation = aggressive_axe
	}

	trigger = {
		scope:leader = {
			is_alive = yes
		}
	}

	immediate = {
		current_travel_plan = {
			if = {
				limit = { any_entourage_character = { count >= 1 } }
				random_entourage_character = {
					save_scope_as = smaug_challange_4_victim_1
				}
			}
			else = { root = { save_scope_as = smaug_challange_4_victim_1 } }
			
			if = {
				limit = { any_entourage_character = { count >= 2 } }
				random_entourage_character = {
					limit = { NOT = { this = scope:smaug_challange_4_victim_1 } }
					save_scope_as = smaug_challange_4_victim_2
				}
			}
			else = { root = { save_scope_as = smaug_challange_4_victim_2 } }
			
			if = {
				limit = { any_entourage_character = { count >= 3 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_4_victim_1 }
							NOT = { this = scope:smaug_challange_4_victim_2 }  
						}
					}	
					save_scope_as = smaug_challange_4_victim_3
				}
			}
			else = { root = { save_scope_as = smaug_challange_4_victim_3 } }
			
			if = {
				limit = { any_entourage_character = { count >= 4 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_4_victim_1 }
							NOT = { this = scope:smaug_challange_4_victim_2 }
							NOT = { this = scope:smaug_challange_4_victim_3 }   
						}
					}	
					save_scope_as = smaug_challange_4_victim_4
				}
			}
			else = { root = { save_scope_as = smaug_challange_4_victim_4 } }
			
			if = {
				limit = { any_entourage_character = { count >= 5 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_4_victim_1 }
							NOT = { this = scope:smaug_challange_4_victim_2 }
							NOT = { this = scope:smaug_challange_4_victim_3 }
							NOT = { this = scope:smaug_challange_4_victim_4 }     
						}
					}
					save_scope_as = smaug_challange_4_victim_5
				}
			}
			else = { root = { save_scope_as = smaug_challange_4_victim_5 } }
			
			if = {
				limit = { any_entourage_character = { count >= 6 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_4_victim_1 }
							NOT = { this = scope:smaug_challange_4_victim_2 }
							NOT = { this = scope:smaug_challange_4_victim_3 }
							NOT = { this = scope:smaug_challange_4_victim_4 }
							NOT = { this = scope:smaug_challange_4_victim_5 }     
						}
					}
					save_scope_as = smaug_challange_4_victim_6
				}
			}
			else = { root = { save_scope_as = smaug_challange_4_victim_6 } }
			
			if = {
				limit = { any_entourage_character = { count >= 7 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_4_victim_1 }
							NOT = { this = scope:smaug_challange_4_victim_2 }
							NOT = { this = scope:smaug_challange_4_victim_3 }
							NOT = { this = scope:smaug_challange_4_victim_4 }
							NOT = { this = scope:smaug_challange_4_victim_5 }
							NOT = { this = scope:smaug_challange_4_victim_6 }      
						}
					}
					save_scope_as = smaug_challange_4_victim_7
				}
			}
			else = { root = { save_scope_as = smaug_challange_4_victim_7 } }
			
			if = {
				limit = { any_entourage_character = { count >= 8 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_4_victim_1 }
							NOT = { this = scope:smaug_challange_4_victim_2 }
							NOT = { this = scope:smaug_challange_4_victim_3 }
							NOT = { this = scope:smaug_challange_4_victim_4 }
							NOT = { this = scope:smaug_challange_4_victim_5 }
							NOT = { this = scope:smaug_challange_4_victim_6 }
							NOT = { this = scope:smaug_challange_4_victim_7 }        
						}
					}
					save_scope_as = smaug_challange_4_victim_8
				}
			}
			else = { root = { save_scope_as = smaug_challange_4_victim_8 } }

			if = {
				limit = { any_entourage_character = { count >= 9 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_4_victim_1 }
							NOT = { this = scope:smaug_challange_4_victim_2 }
							NOT = { this = scope:smaug_challange_4_victim_3 }
							NOT = { this = scope:smaug_challange_4_victim_4 }
							NOT = { this = scope:smaug_challange_4_victim_5 }
							NOT = { this = scope:smaug_challange_4_victim_6 }
							NOT = { this = scope:smaug_challange_4_victim_7 }
							NOT = { this = scope:smaug_challange_4_victim_8 }          
						}
					}
					save_scope_as = smaug_challange_4_victim_9
				}
			}
			else = { root = { save_scope_as = smaug_challange_4_victim_9 } }

			if = {
				limit = { any_entourage_character = { count >= 10 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_4_victim_1 }
							NOT = { this = scope:smaug_challange_4_victim_2 }
							NOT = { this = scope:smaug_challange_4_victim_3 }
							NOT = { this = scope:smaug_challange_4_victim_4 }
							NOT = { this = scope:smaug_challange_4_victim_5 }
							NOT = { this = scope:smaug_challange_4_victim_6 }
							NOT = { this = scope:smaug_challange_4_victim_7 }
							NOT = { this = scope:smaug_challange_4_victim_8 }
							NOT = { this = scope:smaug_challange_4_victim_9 }           
						}
					}
					save_scope_as = smaug_challange_4_victim_10
				}
			}
			else = { root = { save_scope_as = smaug_challange_4_victim_10 } }
			
			if = {
				limit = { any_entourage_character = { count >= 11 } }
				random_entourage_character = {
					limit = { 
						AND = {
							NOT = { this = scope:smaug_challange_4_victim_1 }
							NOT = { this = scope:smaug_challange_4_victim_2 }
							NOT = { this = scope:smaug_challange_4_victim_3 }
							NOT = { this = scope:smaug_challange_4_victim_4 }
							NOT = { this = scope:smaug_challange_4_victim_5 }
							NOT = { this = scope:smaug_challange_4_victim_6 }
							NOT = { this = scope:smaug_challange_4_victim_7 }
							NOT = { this = scope:smaug_challange_4_victim_8 }
							NOT = { this = scope:smaug_challange_4_victim_9 }
							NOT = { this = scope:smaug_challange_4_victim_10 }            
						}
					}
					save_scope_as = smaug_challange_4_victim_11
				}
			}
			else = { root = { save_scope_as = smaug_challange_4_victim_11 }	}
		}
	}

	# Fight
	option = {
		name = smaug_event_chain.0308.a

		duel = {
			skill = prowess
			value = average_skill_rating
			10 = {	# No dwarf dies
				modifier = {
					add = {
						value = root.prowess
						multiply = 0.01
					}
				}
				modifier = {
					has_character_flag = smaug_fight_advantage_1
					add = {
						value = root.prowess
						multiply = 0.5
					}
				}
				modifier = {
					has_character_flag = smaug_fight_advantage_2
					add = {
						value = root.prowess
						multiply = 0.5
					}
				}
				modifier = {
					has_character_flag = smaug_fight_advantage_3
					add = {
						value = root.prowess
						multiply = 1
					}
				}

				desc = smaug_event_chain.0308.a.success
				
			}
			90 = {	# Smaug kills dwarves
				desc = smaug_event_chain.0308.a.failure

				scope:smaug_challange_4_victim_1 = { death = { death_reason = death_burned } }
				if = {
					limit = { NOT = { scope:smaug_challange_4_victim_2 = scope:smaug_challange_4_victim_1 }}
					scope:smaug_challange_4_victim_2 = { death = { death_reason = death_burned } }
				}
				if = {
					limit = { NOT = { scope:smaug_challange_4_victim_3 = scope:smaug_challange_4_victim_2 }}
					scope:smaug_challange_4_victim_3 = { death = { death_reason = death_burned } }
				}
				if = {
					limit = { NOT = { scope:smaug_challange_4_victim_4 = scope:smaug_challange_4_victim_3 }}
					scope:smaug_challange_4_victim_4 = { death = { death_reason = death_burned } }
				}
				if = {
					limit = { NOT = { scope:smaug_challange_4_victim_5 = scope:smaug_challange_4_victim_4 }}
					scope:smaug_challange_4_victim_5 = { death = { death_reason = death_burned } }
				}
				if = {
					limit = { NOT = { scope:smaug_challange_4_victim_6 = scope:smaug_challange_4_victim_5 }}
					scope:smaug_challange_4_victim_6 = { death = { death_reason = death_burned } }
				}
				if = {
					limit = { NOT = { scope:smaug_challange_4_victim_7 = scope:smaug_challange_4_victim_6 }}
					scope:smaug_challange_4_victim_7 = { death = { death_reason = death_burned } }
				}

				random_list = {
					50 = {
						if = {
							limit = { NOT = { scope:smaug_challange_4_victim_8 = scope:smaug_challange_4_victim_7 }}
							scope:smaug_challange_4_victim_8 = { death = { death_reason = death_burned } }
						}
						if = {
							limit = { NOT = { scope:smaug_challange_4_victim_9 = scope:smaug_challange_4_victim_8 }}
							scope:smaug_challange_4_victim_9 = { death = { death_reason = death_burned } }
						}
						if = {
							limit = { NOT = { scope:smaug_challange_4_victim_10 = scope:smaug_challange_4_victim_9 }}
							scope:smaug_challange_4_victim_10 = { death = { death_reason = death_burned } }
						}
						if = {
							limit = { NOT = { scope:smaug_challange_4_victim_11 = scope:smaug_challange_4_victim_10 }}
							scope:smaug_challange_4_victim_11 = { death = { death_reason = death_burned } }
						}
					}
					30 = {
						if = {
							limit = { NOT = { scope:smaug_challange_4_victim_8 = scope:smaug_challange_4_victim_7 }}
							scope:smaug_challange_4_victim_8 = { death = { death_reason = death_burned } }
						}
						if = {
							limit = { NOT = { scope:smaug_challange_4_victim_9 = scope:smaug_challange_4_victim_8 }}
							scope:smaug_challange_4_victim_9 = { death = { death_reason = death_burned } }
						}
						if = {
							limit = { NOT = { scope:smaug_challange_4_victim_11 = scope:smaug_challange_4_victim_10 }}
							scope:smaug_challange_4_victim_11 = { death = { death_reason = death_burned } }
						}
					}
					15 = {
						if = {
							limit = { NOT = { scope:smaug_challange_4_victim_8 = scope:smaug_challange_4_victim_7 }}
							scope:smaug_challange_4_victim_8 = { death = { death_reason = death_burned } }
						}
					}
					5 = {}
				}
			}
		}
		trigger_event = {
			id = smaug_event_chain.0309	# Smaug flies off to lake town
		}
	}
}

# Smaug flies off to lake town
smaug_event_chain.0309 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0309.title
	desc = smaug_event_chain.0309.desc

    theme = intrigue
	override_background = {
		reference = wilderness
	}

	left_portrait = {
		character = root
		animation = fear
	}

	trigger = {
		scope:leader = {
			is_alive = yes
		}
	}

	# Flavour text
	option = {
		name = smaug_event_chain.0309.a

		trigger = {
			NOT = { title:c_esgaroth.holder = character:k_wastelands_holder }
		}

		title:c_esgaroth.holder = {
			trigger_event = {
				id = smaug_event_chain.0310	# Smaug attacks lake town
			}
		}
	}
	
	option = {
		name = smaug_event_chain.0309.b

		trigger = {
			title:c_esgaroth.holder = character:k_wastelands_holder 
		}

		death = { death_reason = death_burned }
	}
}


# Smaug in lake town
smaug_event_chain.0310 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0310.title
	desc = smaug_event_chain.0310.desc

    theme = intrigue
	override_background = {
		reference = smaug_destruction
	}

	left_portrait = {
		character = root
		animation = hunting_longbow_aim_arrow_default
	}

	immediate = {
		save_scope_as = owner_of_late_town
		random_courtier = {
			limit = { this.dynasty = character:lineofdale36.dynasty }
			save_scope_as = courtier_girion_dynasty
		}
		if = {
			limit = { root.liege.dynasty = character:lineofdale36.dynasty }
			root.liege = {
				save_scope_as = liege_girion_dynasty
			}
		}
		else_if = {
			limit = { root.top_liege.dynasty = character:lineofdale36.dynasty }
			root.top_liege = {
				save_scope_as = liege_girion_dynasty
			}
		}
	}

	# Owner of Lake town is from Girions dynasty / Smaug will be killed
	option = {
		name = smaug_event_chain.0310.a

		trigger = {
			scope:owner_of_late_town.dynasty = character:lineofdale36.dynasty
		}

        hidden_effect = {
			title:c_throne_of_erebor.title_province = { remove_building = smaug }
		}
		custom_tooltip = smaug_event_chain.0310.success.tt

		scope:leader = {
			trigger_event = {
				id = smaug_event_chain.0311	# Erebor is freed
			}
		}
	}

	# Liege of Lake town is from Girions dynasty / Smaug will be killed
	option = {
		name = smaug_event_chain.0310.b

		trigger = {
			NOT = {scope:owner_of_late_town.dynasty = character:lineofdale36.dynasty}
			scope:liege_girion_dynasty = {
				exists = yes
			}
	
		}

        hidden_effect = {
			title:c_throne_of_erebor.title_province = { remove_building = smaug }
		}
		custom_tooltip = smaug_event_chain.0310.success.tt

		scope:leader = {
			trigger_event = {
				id = smaug_event_chain.0311	# Erebor is freed
			}
		}
	}

	# Courtier of Lake town is from Girions dynasty / chance that Smaug i killed
	option = {
		name = smaug_event_chain.0310.c

		trigger = {
			NOT = { scope:owner_of_late_town.dynasty = character:lineofdale36.dynasty }
			NOT = { root.liege.dynasty = character:lineofdale36.dynasty }
			NOT = { root.top_liege.dynasty = character:lineofdale36.dynasty }
			scope:courtier_girion_dynasty = {
				exists = yes
			}
		}

		scope:courtier_girion_dynasty = {
			duel = {
				skill = prowess
				value = average_skill_rating
				50 = {	# Smaug is killed
					desc = smaug_event_chain.0308.a.success

					hidden_effect = {
						title:c_throne_of_erebor.title_province = { remove_building = smaug }
					}
					custom_tooltip = smaug_event_chain.0310.success.tt

					scope:leader = {
						trigger_event = {
							id = smaug_event_chain.0311	# Erebor is freed
						}
					}
				}
				50 = {	# Smaug is alive
					desc = smaug_event_chain.0308.a.failure

					root = {
						death = { death_reason = death_burned }
					}
					scope:courtier_girion_dynasty = {
						death = { death_reason = death_burned }
					}
					title:c_esgaroth = {
						if = {
							limit = { 
								not = {	this.title_province = { has_holding_type = ruined_holding } }
							}
							
							make_settlement_county_wilderness = { COUNTY = this }
						}
					}
					
					scope:leader = {
						trigger_event = {
							id = smaug_event_chain.0312	# Smaug returns to Erebor
						}
					}
				}
			}
		}
	}
	
	# There is noone from Girions dynasty / death and destriction
	option = {
		name = smaug_event_chain.0310.d

		trigger = {
			NOT = { scope:owner_of_late_town.dynasty = character:lineofdale36.dynasty }
			NOT = { root.liege.dynasty = character:lineofdale36.dynasty }
			NOT = { root.top_liege.dynasty = character:lineofdale36.dynasty }
			NOT = {
				any_courtier = {
					this.dynasty = character:lineofdale36.dynasty 
				}
			}	
		}

		title:c_esgaroth = {
			if = {
				limit = { 
					not = {	this.title_province = { has_holding_type = ruined_holding } }
				}
				
				make_settlement_county_wilderness = { COUNTY = this }
			}
		}

		death = { death_reason = death_burned }

		scope:leader = {
			trigger_event = {
				id = smaug_event_chain.0312	# Smaug returns to Erebor
			}
		}
	}
}

# Smaug is killed reaction / Company leader gets Erebor
smaug_event_chain.0311 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0311.title
	desc = smaug_event_chain.0311.desc

    theme = intrigue
	override_background = {
		reference = wilderness
	}

	left_portrait = {
		character = root
		animation = celebrate_axe
	}

	# Colonisation of Erebor
	option = {
		name = smaug_event_chain.0311.a

		ai_colonisation_effect = { WASTELANDS = title:b_throne_of_erebor }

		add_prestige = major_prestige_gain

		if = {
            limit = { # Major News
                NOT = { has_game_rule = no_news }
            }
            every_player = { #Global News Announcement
			    trigger_event = {
                    id = news_event.0053
                    days = 2
                }    
		    }
        }
	}
}

# Smaug lives and return to erebor
smaug_event_chain.0312 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0312.title
	desc = smaug_event_chain.0312.desc

    theme = intrigue
	override_background = {
		reference = wilderness
	}

	left_portrait = {
		character = root
		animation = celebrate_axe
	}

	# Colonisation of Erebor
	option = {
		name = smaug_event_chain.0312.a

		current_travel_plan = {
			every_entourage_character = {
				death = { death_reason = death_burned }
			}
		}
	}
}