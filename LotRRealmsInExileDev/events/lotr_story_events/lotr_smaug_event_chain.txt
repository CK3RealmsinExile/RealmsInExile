namespace = smaug_event_chain

### Smaug Events ### Written by Sakkar
#			smaug_event_chain.00XX		Setup
#			smaug_event_chain.0100		Smaug sacking Erebor and Dale
#			smaug_event_chain.0200		Smaug blocker events

# Setup
smaug_event_chain.0001 = {	# Firing event for all effected rulers
	scope = none
	hidden = yes

	immediate = {
		# Erebor
		if = {
			limit = { title:k_erebor = { is_title_created = yes } }
			title:k_erebor.holder = {
				trigger_event = {
					id = smaug_event_chain.0100 # Smaug sacks rulers holding
				}
			}
		}
		if = {
			limit = { title:d_erebor = { is_title_created = yes } }		
			title:d_erebor.holder = { 
				trigger_event = {
					id = smaug_event_chain.0100 # Smaug sacks rulers holding
				}
			}
		}	
		title:c_throne_of_erebor.holder = { 
			trigger_event = {
				id = smaug_event_chain.0100 # Smaug sacks rulers holding
			}
		}
		title:c_ravenhill.holder = { 
			trigger_event = {
				id = smaug_event_chain.0100 # Smaug sacks rulers holding
			}
		}
		title:c_golddeeps.holder = { 
			trigger_event = {
				id = smaug_event_chain.0100 # Smaug sacks rulers holding
			}
		}
		title:c_golden_hall.holder = { 
			trigger_event = {
				id = smaug_event_chain.0100 # Smaug sacks rulers holding
			}
		}
		title:c_halls_of_steel.holder = {
			trigger_event = {
				id = smaug_event_chain.0100 # Smaug sacks rulers holding
			}
		}
		title:c_great_foundries.holder = {
			trigger_event = {
				id = smaug_event_chain.0100 # Smaug sacks rulers holding
			}
		}
		title:c_arkenhalls.holder = {
			trigger_event = {
				id = smaug_event_chain.0100 # Smaug sacks rulers holding
			}
		}
		
		# Dalelands
		if = {
			limit = { title:d_dalelands = { is_title_created = yes } }	
			title:d_dalelands.holder = {
				trigger_event = {
					id = smaug_event_chain.0100 # Smaug sacks rulers holding
				}
			}
		}	
		title:c_dale.holder = { 
			trigger_event = {
				id = smaug_event_chain.0100 # Smaug sacks rulers holding
			}
		}
		title:c_felagsgard.holder = { 
			trigger_event = {
				id = smaug_event_chain.0100 # Smaug sacks rulers holding
			}
		}
		title:c_lang_marish.holder = { 
			trigger_event = {
				id = smaug_event_chain.0100 # Smaug sacks rulers holding
			}
		}
		# Drakkenvast
		if = {
			limit = { title:d_drakkenvast = { is_title_created = yes } }	
			title:d_drakkenvast.holder = {
				trigger_event = {
					id = smaug_event_chain.0100 # Smaug sacks rulers holding
				}
			}
		}
		title:c_steinholl.holder = { 
			trigger_event = {
				id = smaug_event_chain.0100 # Smaug sacks rulers holding
			}
		}
		title:c_orlmond.holder = { 
			trigger_event = {
				id = smaug_event_chain.0100 # Smaug sacks rulers holding
			}
		}
		title:c_vargurat.holder = { 
			trigger_event = {
				id = smaug_event_chain.0100 # Smaug sacks rulers holding
			}
		}
		
	}
}

# Event chain
# Fire and Death - Smaug arrives and destruction starts event
smaug_event_chain.0100 = {	
    content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0100.title
	#desc = smaug_event_chain.0100.desc
	desc = {
		first_valid = {
			triggered_desc = { #Dwarf desc
				trigger = {
					is_dwarf = yes
				}
				desc = smaug_event_chain.0100.dwarf.desc
			}
			triggered_desc = { #Elf desc
				trigger = {
					is_elf = yes
				}
				desc = smaug_event_chain.0100.elf.desc
			}
			triggered_desc = { #Orc desc
				trigger = {
					is_orc = yes
				}
				desc = smaug_event_chain.0100.orc.desc
			}
			desc = smaug_event_chain.0100.desc
		}
	}
    theme = death
	override_background = {
		reference = smaug_arrive
	}
	cooldown = { days = 10 }

    right_portrait = {
		character = root
		animation = fear
	}

    trigger = {
		is_wastelands = no
		is_independent_ruler = yes
    }
	
    immediate = {
        # Erebor
        title:c_throne_of_erebor = { add_to_list = smaug_desolated_counties }
        title:c_ravenhill = { add_to_list = smaug_desolated_counties }
        title:c_golddeeps = { add_to_list = smaug_desolated_counties }
        title:c_golden_hall = { add_to_list = smaug_desolated_counties }
        title:c_halls_of_steel = { add_to_list = smaug_desolated_counties }
        title:c_great_foundries = { add_to_list = smaug_desolated_counties }
        title:c_arkenhalls = { add_to_list = smaug_desolated_counties }

        # Dale
        title:c_dale = { add_to_list = smaug_desolated_counties }
		title:c_felagsgard = { add_to_list = smaug_desolated_counties }
        title:c_lang_marish = { add_to_list = smaug_desolated_counties }


		# Drakkenvast
        title:c_vargurat = { add_to_list = smaug_desolated_counties }
        title:c_steinholl = { add_to_list = smaug_desolated_counties }
        title:c_orlmond = { add_to_list = smaug_desolated_counties }

		root.primary_title = { save_scope_as = primary_title }

		every_courtier = { add_to_list = courtiers_list }
    }


    option = { # Oh no
        name = smaug_event_chain.0100.a

        every_in_list = {
            list = smaug_desolated_counties

			limit = { this.holder.top_liege = root }

			if = {
            	limit = { 
					not = {	this.title_province = { has_holding_type = ruined_holding } }
				}
				
				make_settlement_county_wilderness = { COUNTY = this }
			}

			if = {
				limit = {
					not = {	this.title_province = { has_building = smaug_desolation } } 
				}

            	this.title_province = { add_building = smaug_desolation	}	

            	if = {
                	limit = { 
						AND = {
							this = title:c_throne_of_erebor
							not = {	this.title_province = { has_building = smaug }	}  
						}
					}

                	this.title_province = { add_building = smaug }
            	}
			}	    
        }

        if = {
            limit = { has_title = title:k_erebor }
            destroy_title = title:k_erebor
        }

        if = {
            limit = { has_title = title:d_erebor }
            destroy_title = title:d_erebor
        }

        if = {
            limit = { has_title = title:d_dalelands }
            destroy_title = title:d_dalelands
        }

		if = {
            limit = { has_title = title:d_drakkenvast }
            destroy_title = title:d_drakkenvast
        }

        stress_impact = {
			base = massive_stress_impact_gain
        }    

        if = {
            limit = { # Major News
                NOT = { has_game_rule = no_news }
            }
            every_player = { #Global News Announcement
			    trigger_event = {
                    id = news_event.0050
                    days = 2
                }    
		    }
        }

		# makes LAAMPS if unlanded
		if = {
			limit = { 
				has_ep3_dlc_trigger = yes
				NOT = {
					any_county = {
						holder.top_liege = root
						NOT = { is_in_list = smaug_desolated_counties }
					}
				}	 
			}
			hidden_effect = {
				create_landless_adventurer_title_effect = {
					REASON = flag:wanderer
					FLAVOR_CHAR = root
				}
				every_in_list = {
					list = courtiers_list
					limit = { NOT = { this.host = root } }
					root = { add_courtier = prev }
				}
				root.primary_title = {
					set_coa = this.holder.house
				}
				if = {
					limit = { this = character:lineofdurin81 } 
					root.primary_title = {
						set_title_name = Thror_camp_name
					}
				}
			}
			trigger_event = {
				id = smaug_event_chain.0101 
				days = 4
			}  
		}	
    }
}

# The Escape - flavour event about escaping from destruction
smaug_event_chain.0101 = {
    content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0101.title
	#desc = smaug_event_chain.0101.desc
	desc = {
		first_valid = {
			triggered_desc = { #Dwarf desc
				trigger = {
					is_dwarf = yes
				}
				desc = smaug_event_chain.0101.dwarf.desc
			}
			triggered_desc = { #Elf desc
				trigger = {
					is_elf = yes
				}
				desc = smaug_event_chain.0101.elf.desc
			}
			triggered_desc = { #Orc desc
				trigger = {
					is_orc = yes
				}
				desc = smaug_event_chain.0101.orc.desc
			}
			desc = smaug_event_chain.0101.desc
		}
	}
    theme = death
	override_background = {
		reference = smaug_destruction
	}

    right_portrait = {
		character = root
		animation = fear
	}

    trigger = {
        is_landed = no
    }

    # You are banished by Smaug (yourself)
    option = {
        name = smaug_event_chain.0101.a

		hidden_effect = {
        	trigger_event = { id = smaug_event_chain.0102 }
		}	
    }
}

# Setup event (setting up landless)
smaug_event_chain.0102 = {
	type = character_event
	hidden = yes

	trigger = {
		has_ep3_dlc_trigger = yes
	}

	on_trigger_fail = {
		#banish = yes
		death = { death_reason = death_disappearance }
	}

	immediate = {
		save_scope_as = adventurer
		if = {
			limit = { exists = liege }

			liege = { save_scope_as = liege }
		}
		add_character_flag = {
			flag = block_for_prison_release_notification
			days = 1
		}
		# AI chance
		if = {
			limit = {
				is_ai = yes
			}

			# Plus for our memory variable.
			add_character_flag = {
				flag = block_for_prison_release_message
				days = 1
			}
			# move camp away from Erebor
			scope:adventurer = {
				trigger_event = { id = smaug_event_chain.0104 }
			}

			if = {
				limit = {
					NOT = {
						government_has_flag = government_is_landless_adventurer
					}
				}
				death = { death_reason = death_disappearance }
			}
		}
		# Player event
		else = {
			trigger_event = { id = smaug_event_chain.0103 }
		}
	}
}

# The Aftermath - base game like event leting player choose if they want to play landless or not
smaug_event_chain.0103 = {
	type = character_event
	window = fullscreen_event
	title = smaug_event_chain.0103.t
	#desc = smaug_event_chain.0103.desc
	desc = {
		first_valid = {
			triggered_desc = { #Dwarf desc
				trigger = {
					is_dwarf = yes
				}
				desc = smaug_event_chain.0103.dwarf.desc
			}
			triggered_desc = { #Elf desc
				trigger = {
					is_elf = yes
				}
				desc = smaug_event_chain.0103.elf.desc
			}
			triggered_desc = { #Orc desc
				trigger = {
					is_orc = yes
				}
				desc = smaug_event_chain.0103.orc.desc
			}
			desc = smaug_event_chain.0103.desc
		}
	}
	theme = realm
	left_portrait = {
		character = root
		animation = marshal
	}
	lower_left_portrait = scope:alt_1
	lower_right_portrait = scope:alt_2
	override_background = { reference = ep3_fullscreen_adventurer_negative }
	cooldown = { days = 5 }

	trigger = {
		NOT = { has_character_flag = become_laamp_event_cooldown }
	}

	immediate = {
		add_character_flag = {
			flag = become_laamp_event_cooldown
			days = 5
		}
		save_scope_as = adventurer
		if = {
			limit = { exists = liege }

			liege = { save_scope_as = liege }
		}
		find_playable_relatives_effect = yes
	}

	option = {
		name = smaug_event_chain.0103.a
		show_as_tooltip = { banish = yes }
		hidden_effect = {
			scope:adventurer = {
				if = {
					limit = { NOT = { this = character:lineofdurin81 } }
						
					trigger_event = { id = smaug_event_chain.0104 }
				}
				else = {
					trigger_event = { id = smaug_event_chain.0105 }
				}
			}
		}
		create_landless_adventurer_title_tooltip_effect = yes
		add_internal_flag = special
	}

	option = {
		name = ep3_laamps.0001.b
		trigger = { exists = scope:alt_1 }
		show_as_tooltip = { banish = yes }
		laamp_switch_playable_character_effect = { NEW_CHARACTER = scope:alt_1 }
		hidden_effect = {
			scope:adventurer = {
				if = {
					limit = { NOT = { this = character:lineofdurin81 } }
						
					trigger_event = { id = smaug_event_chain.0104 }
				}
				else = {
					trigger_event = { id = smaug_event_chain.0105 }
				}
			}
		}
	}
	option = {
		name = ep3_laamps.0001.c
		trigger = { exists = scope:alt_2 }
		show_as_tooltip = { banish = yes }
		laamp_switch_playable_character_effect = { NEW_CHARACTER = scope:alt_2 }
		hidden_effect = {
			scope:adventurer = {
				if = {
					limit = { NOT = { this = character:lineofdurin81 } }
						
					trigger_event = { id = smaug_event_chain.0104 }
				}
				else = {
					trigger_event = { id = smaug_event_chain.0105 }
				}
			}
		}
	}
	option = {
		trigger = { is_ai = no }

		name = ep3_laamps.0001.e
		show_as_tooltip = { death = { death_reason = death_disappearance } }
		laamp_game_over_option_effect = yes
		hidden_effect = { death = { death_reason = death_disappearance } }
	}
}

smaug_event_chain.0104 = {
	type = character_event
	hidden = yes
	
	immediate = {
        title:c_zurkharukh = { add_to_list = target_counties_list }
        title:c_edricsborg = { add_to_list = target_counties_list }
        title:c_cerin_arhendhiril = { add_to_list = target_counties_list }
        title:c_aradhrynd = { add_to_list = target_counties_list }
        title:c_tham_aeldir = { add_to_list = target_counties_list }
        title:c_caras_tilion = { add_to_list = target_counties_list }
        title:c_ulgerstat = { add_to_list = target_counties_list }
		title:c_esgaroth = { add_to_list = target_counties_list }
		title:c_londaroth = { add_to_list = target_counties_list }
		title:c_hrafnvild = { add_to_list = target_counties_list }

		random_in_list = {
			list = target_counties_list
			save_scope_as = target_county
		}

		root = {
			show_as_tooltip = {
				domicile = {
					move_domicile = scope:target_county.title_province
				}
			}
			start_travel_plan = {
				destination = scope:target_county.title_province
				travel_with_domicile = yes
				return_trip = no
				players_use_planner = no
				on_arrival_destinations = last
			}	
		}
    }	
}

smaug_event_chain.0105 = {
	content_source = realms_dlc
    type = character_event
    title = smaug_event_chain.0105.title
	desc = smaug_event_chain.0105.desc

    theme = realm
	override_background = {
		reference = wilderness_steppe
	}

    left_portrait = {
		character = root
		animation = personality_bold
	}

	immediate = {
		scope:adventurer.primary_title = {
			save_scope_as = camp_name
		}
	}

	# Travel to Dunland
	option = {
		name = smaug_event_chain.0105.a

		add_prestige = medium_prestige_gain
		stress_impact = {
			base = minor_stress_impact_loss
        }   
		custom_tooltip = smaug_event_chain.0105.a.tt

		hidden_effect = {
			show_as_tooltip = {
				domicile = {
					move_domicile = title:c_earcnoc.title_province
				}
			}
			
			start_travel_plan = {
				destination = title:c_earcnoc.title_province
				travel_with_domicile = yes
				return_trip = no
				players_use_planner = no
				on_arrival_destinations = last
			}
		}		
	}

	# Travel to Blue Mountiens
	option = {
		name = smaug_event_chain.0105.b

		trigger = { is_ai = no }
		stress_impact = {
			base = minor_stress_impact_gain
        }
		domicile = {
			custom_tooltip = smaug_event_chain.0105.b.tt
		}	

		hidden_effect = {
			show_as_tooltip = {
				domicile = {
					move_domicile = title:c_thorins_hall.title_province
				}
			}
			start_travel_plan = {
				destination = title:c_central_high_pass.title_province
				destination = title:c_thorins_hall.title_province
				travel_with_domicile = yes
				return_trip = no
				players_use_planner = no
				on_arrival_destinations = last
			}
		}		
	}
	
	# Travel to Iron Hills
	option = {
		name = smaug_event_chain.0105.c

		trigger = { is_ai = no }

		add_prestige = medium_prestige_loss
		stress_impact = {
			base = minor_stress_impact_gain
        }
		custom_tooltip = smaug_event_chain.0105.c.tt   

		hidden_effect = {
			show_as_tooltip = {
				domicile = {
					move_domicile = title:c_azanulinbar_dum.title_province
				}
			}
			start_travel_plan = {
				destination = title:c_azanulinbar_dum.title_province
				travel_with_domicile = yes
				return_trip = no
				players_use_planner = no
				on_arrival_destinations = last
			}
		}		
	}
}	


# Blocker events
smaug_event_chain.0200 = {	#	Desolation of Smaug blocker - Smaug lives
	content_source = realms_dlc
	type = character_event
	title = smaug_event_chain.0200.t
	desc = {
		first_valid = {
			triggered_desc = { #Smaug lives desc
				trigger = {
					title:c_throne_of_erebor.title_province = { has_building = smaug }
				}
				desc = smaug_event_chain.0200.danger.desc
			}
			desc = smaug_event_chain.0200.desc
		}
	}			

	theme = balrog

	left_portrait = {
		character = root
		triggered_animation = {
			trigger = {
				title:c_throne_of_erebor.title_province = { has_building = smaug }
			}
			animation = fear
		}
		triggered_animation = {
			trigger = {
				NOT = { title:c_throne_of_erebor.title_province = { has_building = smaug } }
			}
			animation = personality_rational
		}
		animation = idle
	}

	override_background = {
		reference = wilderness_mountains
	}

	option = { # Settlement cant be further developed
		name = smaug_event_chain.0200.a

		trigger = {
			title:c_throne_of_erebor.title_province = { has_building = smaug }
		}

		send_interface_toast = {
			left_icon = root
			title = smaug_event_chain.0200.a.toast.t
			increase_wounds_effect = { REASON = wild_animal }
			hidden_effect = { scope:obstacle_province = { remove_building = smaug_desolation_cleared } }
			scope:obstacle_province = { add_building = smaug_desolation }
			make_settlement_county_wilderness = {
				COUNTY = scope:obstacle_province.county
			}
		}
		stress_impact = {
			base = major_stress_gain
			craven = major_stress_gain
		}
	}

	option = { # Settlement is further developed
		name = smaug_event_chain.0200.b

		trigger = {
			NOT = { title:c_throne_of_erebor.title_province = { has_building = smaug } }
		}

		send_interface_toast = {
			left_icon = root
			title = smaug_event_chain.0200.b.toast.t
			add_prestige = 50
			hidden_effect = { scope:obstacle_province = { remove_building = smaug_desolation_cleared } }
		}
	}
}