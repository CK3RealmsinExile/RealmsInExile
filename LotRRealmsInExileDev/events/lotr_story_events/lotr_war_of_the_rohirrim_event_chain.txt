namespace = war_of_the_rohirrim

## Introductory Event Chain
# Freca: A Call to Council
war_of_the_rohirrim.0100 = {
	content_source = realms_dlc
	type = character_event
	title =  war_of_the_rohirrim.0100.t
	desc =  war_of_the_rohirrim.0100.desc
	theme = realm
	override_background = {
		reference = edoras
	}
	left_portrait = {
		character = root
		animation = scheme
	}
	right_portrait = {
		character = scope:helm
		animation = anger
	}
	lower_left_portrait = scope:wulf
	lower_right_portrait = scope:freawine

	immediate = {
		play_music_cue = lotr_cue_rohan
		character:lineofeorl9 = { save_scope_as = helm }
		character:lineoffreca3 = { save_scope_as = wulf }
		character:linegeanmar9 = { save_scope_as = targg }
		character:lineofeorl5 = { save_scope_as = freawine }
		hidden_effect = {
			create_character = {
				template = foreign_architect_template
				employer = root
				save_scope_as = caravan_master
			}
			if = {
				limit = { NOT = { employs_court_position = travel_leader_court_position } }
				appoint_court_position = {
					recipient = scope:caravan_master
					court_position = travel_leader_court_position
				}
			}
		}
	}

	option = {
		name =  war_of_the_rohirrim.0100.a
		set_variable = cannot_cancel_travel
		custom_tooltip = war_of_the_rohirrim.0100.a.effects
		add_prestige = 150
		stress_impact = {
			arrogant = minor_stress_impact_loss
			ambitious = minor_stress_impact_loss
		}
		custom_tooltip = war_of_the_rohirrim.0100.a.effects2
		save_scope_as = bold_approach
		start_travel_plan = {
			destination = title:c_kingstead.title_province
			companion = scope:wulf
			companion = scope:targg
			on_arrival_event = war_of_the_rohirrim.0101
			return_trip = no
			players_use_planner = no
			on_arrival_destinations = last
		}
		ai_chance = {
			base = 100
		}
	}

	option = {
		name =  war_of_the_rohirrim.0100.b
		set_variable = cannot_cancel_travel
		custom_tooltip = war_of_the_rohirrim.0100.b.effects
		add_prestige = -150
		stress_impact = {
			arrogant = medium_stress_impact_gain
		}
		custom_tooltip = war_of_the_rohirrim.0100.b.effects2
		save_scope_as = calm_approach
		start_travel_plan = {
			destination = title:c_kingstead.title_province
			companion = scope:wulf
			on_arrival_event = war_of_the_rohirrim.0101
			return_trip = no
			players_use_planner = no
			on_arrival_destinations = last
		}
		ai_chance = {
			base = 0
		}
	}

	option = {
		name =  war_of_the_rohirrim.0100.c
		# Trigger refusal event for Helm
		custom_tooltip = freca_helm_opt_out_of_story_content
		add_prestige = 100
		stress_impact = {
			arrogant = minor_stress_impact_loss
		}
		scope:helm = {
			custom_tooltip =  war_of_the_rohirrim.0100.c.effects
			add_opinion = {
				target = root
				modifier = rebellious_vassal_opinion
			}
			set_relation_rival = { reason = rival_age_old_rivalry target = root }
		}
		ai_chance = {
			base = 0
		}
	}
}

# Freca: Freca's Proposal
war_of_the_rohirrim.0101 = {
	type = character_event
	title = war_of_the_rohirrim.0101.t
	desc = {
		first_valid = {
			triggered_desc = {
				trigger = {
					exists = scope:calm_approach
				}
				desc = war_of_the_rohirrim.0101.desc.calm
			}
			desc = war_of_the_rohirrim.0101.desc.bold
		}
	}
	theme = realm
	
	left_portrait = {
		character = root
		triggered_animation = {
			trigger = {
				exists = scope:calm_approach
			}
			animation = debating
		}
		animation = anger
	}

	right_portrait = {
		character = scope:helm
		animation = disapproval
	}

	lower_left_portrait = scope:wulf
	lower_right_portrait = scope:hera
	
	option = { 
		name = war_of_the_rohirrim.0101.a
		custom_tooltip = war_of_the_rohirrim.0101.a.effect
		character:lineofeorl9 = { 
			trigger_event = {
				id = war_of_the_rohirrim.0102
				days = { 1 2 }
			}
		}
	}
	
}

# Helm: Freca makes his proposal
war_of_the_rohirrim.0102 = {
	type = character_event
	title = war_of_the_rohirrim.0102.t
	desc = {
		first_valid = {
			triggered_desc = {
				trigger = {
					exists = scope:calm_approach
				}
				desc = war_of_the_rohirrim.0102.desc.calm
			}
			desc = war_of_the_rohirrim.0102.desc.bold
		}
	}
	theme = realm
	
	left_portrait = {
		character = root
		animation = disapproval
	}
	
	right_portrait = {
		character = scope:freca
		triggered_animation = {
			trigger = {
				exists = scope:calm_approach
			}
			animation = debating
		}
		animation = anger
	}

	lower_left_portrait = scope:hera
	lower_center_portrait = scope:frealaf
	lower_right_portrait = scope:wulf

	immediate = {
		character:6000010 = { save_scope_as = frealaf }
	}
	
	option = { 
		name = war_of_the_rohirrim.0102.a
		custom_tooltip = war_of_the_rohirrim.0102.a.effects
		scope:freca = { 
			trigger_event = war_of_the_rohirrim.0103
		}
		ai_chance = {
			base = 100
	   }
	}
	option = { 
		name = war_of_the_rohirrim.0102.b
		custom_tooltip = freca_helm_opt_out_of_story_content
		scope:hera = {
			hidden_effect = {
				remove_trait = cannot_marry
			}
			marry = scope:wulf
		}
		scope:wulf = {
			add_pressed_claim = title:k_rohan
		}
		create_alliance = {			
			target = scope:freca		
			allied_through_owner = scope:wulf
			allied_through_target = scope:hera
		}
		ai_chance = {
			base = 0
	   }
	}
	
}

# Freca: The Fight
war_of_the_rohirrim.0103 = {
	type = character_event
	title = war_of_the_rohirrim.0103.t
	desc = war_of_the_rohirrim.0103.desc
	theme = martial
	
	left_portrait = {
		character = root
		animation = rage
	}
	right_portrait = {
		character = scope:helm
		animation = anger
	}

	lower_center_portrait = scope:frealaf

	override_background = {
		reference = alley_night
	}

	override_effect_2d = {
		reference = rain
	}
	
	option = {
		name = war_of_the_rohirrim.0103.a
		custom_tooltip = war_of_the_rohirrim.0103.a.effects
		scope:helm = {
			trigger_event = war_of_the_rohirrim.0104
		}
		ai_chance = {
 			base = 0
		}
	}
	
}

# Helm: The Punch
war_of_the_rohirrim.0104 = {
	type = character_event
	title = war_of_the_rohirrim.0104.t
	desc = war_of_the_rohirrim.0104.desc
	theme = martial
	
	left_portrait = {
		character = root
		animation = rage
	}
	right_portrait = {
		character = scope:freca
		animation = anger
	}

	override_background = {
		reference = alley_night
	}

	override_effect_2d = {
		reference = rain
	}
	
	option = { 
		name = war_of_the_rohirrim.0104.a
		scope:freca = {
			trigger_event = war_of_the_rohirrim.0105
		}
	}
	
}

# Freca: The Death of Freca
war_of_the_rohirrim.0105 = {
	type = character_event
	title = war_of_the_rohirrim.0105.t
	desc = war_of_the_rohirrim.0105.desc
	theme = death
	
	left_portrait = {
		character = root
		animation = pain
	}
	
	right_portrait = {
		character = scope:wulf
		animation = grief
	}

	override_background = {
		reference = alley_night
	}

	override_effect_2d = {
		reference = rain
	}

	immediate = {
		hidden_effect = {
			add_trait = wounded_3
		}
	}
	
	option = { 
		name = war_of_the_rohirrim.0105.a
		death = {
			killer = scope:helm
			death_reason = death_one_punched
		}
		scope:helm = {
			trigger_event = war_of_the_rohirrim.0106
		}
	}
	
}

# Helm: The Banishment of Wulf
war_of_the_rohirrim.0106 = {
	type = character_event
	title = war_of_the_rohirrim.0106.t
	desc = war_of_the_rohirrim.0106.desc
	theme = martial
	
	left_portrait = {
		character = root
		animation = disgust
	}
	
	right_portrait = {
		character = scope:wulf
		animation = rage
	}

	lower_center_portrait = scope:freca

	override_background = {
		reference = alley_night
	}

	override_effect_2d = {
		reference = rain
	}

	immediate = {
		show_as_tooltip = {
			scope:freca = {
				death = {
					killer = root
					death_reason = death_one_punched
				}
			}
		}
	}
	
	option = { 
		name = war_of_the_rohirrim.0106.a
		scope:wulf = {
			trigger_event = war_of_the_rohirrim.0107
			show_as_tooltip = {
				set_relation_nemesis = { reason = rival_killed_parent target = scope:helm }
				add_pressed_claim = title:k_rohan
				create_title_and_vassal_change = {
					type = granted
					save_scope_as = change
				}
				title:c_tormcaladach = {
					change_title_holder = {
						holder = root
						change = scope:change
					}
				}
				resolve_title_and_vassal_change = scope:change
				create_title_and_vassal_change = {
					type = revoked
					save_scope_as = change2
					add_claim_on_loss = yes
				}
				every_held_title = {
					limit = {
						tier >= tier_county
						OR = {
							kingdom = title:k_rohan
							duchy = title:d_westmarches
							duchy = title:d_drulad
						}
					}
					change_title_holder = {
						holder = scope:helm
						change = scope:change2
					}
				}
				scope:targg = {
					if = {
						limit = {
							is_ai = yes
						}
						every_held_title = {
							limit = {
								tier >= tier_county
								OR = {
									kingdom = title:k_rohan
									duchy = title:d_westmarches
									duchy = title:d_drulad
								}
							}
							change_title_holder = {
								holder = scope:helm
								change = scope:change2
							}
						}
					}
				}
				resolve_title_and_vassal_change = scope:change2
				create_title_and_vassal_change = {
					type = swear_fealty
					save_scope_as = change3
				}
				change_liege = {
					liege = character:lineurthain52
					change = scope:change3
				}
				resolve_title_and_vassal_change = scope:change3
			}
		}
	}
	
}

# Wulf: Banished
war_of_the_rohirrim.0107 = {
	type = character_event
	title = war_of_the_rohirrim.0107.t
	desc = war_of_the_rohirrim.0107.desc
	theme = martial
	
	left_portrait = {
		character = root
		animation = rage
	}
	
	right_portrait = {
		character = scope:helm
		animation = disgust
	}

	lower_left_portrait = scope:freca
	lower_right_portrait = scope:cerith

	override_background = {
		reference = alley_night
	}

	override_effect_2d = {
		reference = rain
	}

	immediate = {
		character:lineurthain52 = { save_scope_as = cerith }
	}
	
	option = { 
		name = war_of_the_rohirrim.0107.a
		scope:helm = { set_relation_nemesis = { reason = rival_killed_parent target = root } }
		add_pressed_claim = title:k_rohan
		create_title_and_vassal_change = {
			type = granted
			save_scope_as = change
		}
		title:c_tormcaladach = {
			change_title_holder = {
				holder = root
				change = scope:change
			}
		}
		resolve_title_and_vassal_change = scope:change
		create_title_and_vassal_change = {
			type = revoked
			save_scope_as = change2
			add_claim_on_loss = yes
		}
		every_held_title = {
			limit = {
				tier >= tier_county
				OR = {
					kingdom = title:k_rohan
					duchy = title:d_westmarches
					duchy = title:d_drulad
				}
			}
			change_title_holder = {
				holder = scope:helm
				change = scope:change2
			}
		}
		scope:targg = {
			if = {
				limit = {
					is_ai = yes
				}
				every_held_title = {
					limit = {
						tier >= tier_county
						OR = {
							kingdom = title:k_rohan
							duchy = title:d_westmarches
							duchy = title:d_drulad
						}
					}
					change_title_holder = {
						holder = scope:helm
						change = scope:change2
					}
				}
			}
		}
		resolve_title_and_vassal_change = scope:change2
	}

	after = {
		create_title_and_vassal_change = {
			type = swear_fealty
			save_scope_as = change3
		}
		change_liege = {
			liege = scope:cerith
			change = scope:change3
		}
		resolve_title_and_vassal_change = scope:change3
		scope:targg = {
			set_employer = root
		}
		scope:helm = {
			trigger_event = {
				id = war_of_the_rohirrim.0108
				days = 6
			}
		}
		trigger_event = {
			id = war_of_the_rohirrim.0109
			days = 7
		}
	}
	
}

# Helm: The Aftermath
war_of_the_rohirrim.0108 = {
	type = character_event
	title = war_of_the_rohirrim.0108.t
	desc = war_of_the_rohirrim.0108.desc
	theme = realm
	
	right_portrait = {
		character = root
		animation = personality_honorable
	}

	immediate = {
		give_nickname = nick_hammerhand
        add_character_flag = {
			flag = had_nickname_event
		}
	}
	
	option = { 
		name = war_of_the_rohirrim.0108.a
	}
	
}

# Wulf: A Life in Exile
war_of_the_rohirrim.0109 = {
	type = character_event
	title = war_of_the_rohirrim.0109.t
	desc = war_of_the_rohirrim.0109.desc
	theme = feast_activity
	
	left_portrait = {
		character = root
		animation = personality_honorable
	}
	
	right_portrait = {
		character = scope:cerith
		animation = debating
	}

	lower_left_portrait = scope:targg
	lower_right_portrait = root.mother
	
	option = { 
		name = war_of_the_rohirrim.0109.a
		add_character_flag = wulf_in_exile
		if = {
			limit = {
				exists = scope:calm_approach
			}
			spawn_army = {
				men_at_arms = {
					type = dunlending_huscarl
					stacks = 1
				}
				inheritable = yes
				location = root.location
				name = frecas_men
			}
		}
		else = {
			spawn_army = {
				men_at_arms = {
					type = dunlending_huscarl
					stacks = 2
				}
				inheritable = yes
				location = root.location
				name = frecas_men
			}
		}
	}
	
}

# Freca Conversion Decision - Turthalis - Lead Up
war_of_the_rohirrim.0210 = {
	content_source = realms_dlc
	type = character_event
	title =  war_of_the_rohirrim.0210.t
	desc =  war_of_the_rohirrim.0210.desc
	theme = faith
	
	left_portrait = {
		character = root
		animation = personality_honorable
	}

	override_background = {
		reference = fp1_runestone_circle
	}

	immediate = {
		add_character_flag = wulf_faith_question_resolved
	}

	option = {
		name =  war_of_the_rohirrim.0210.a
		trigger_event = war_of_the_rohirrim.0211
	}
}

# Freca Conversion Decision - Turthalis - Trial
war_of_the_rohirrim.0211 = {
	content_source = realms_dlc
	type = character_event
	title =  war_of_the_rohirrim.0211.t
	desc =  war_of_the_rohirrim.0211.desc
	theme = faith
	
	left_portrait = {
		character = root
		animation = paranoia
	}

	override_background = {
		reference = on_river
	}

	override_effect_2d = {
		reference = fog
	}

	immediate = {
	}

	option = {
		name =  war_of_the_rohirrim.0211.a
		trigger_event = war_of_the_rohirrim.0212
	}
}

# Freca Conversion Decision - Khrabnazerh - Triumph
war_of_the_rohirrim.0212 = {
	content_source = realms_dlc
	type = character_event
	title =  war_of_the_rohirrim.0212.t
	desc =  war_of_the_rohirrim.0212.desc
	theme = faith
	
	left_portrait = {
		character = root
		animation = happiness
	}

	override_background = {
		reference = ep2_hunt_foggy_forest
	}

	immediate = {
	}

	option = {
		name =  war_of_the_rohirrim.0212.a
		set_character_faith_with_conversion = faith:faith_dunlending_turthalis
		if = {
			limit = {
				NOT = {
					has_perk = befriend_perk
				}
			}
			add_perk = befriend_perk
		}
		add_character_modifier = {
			modifier = wulf_diplomatic_faith_character_modifier
			years = 10
		}
	}
}

# Freca Conversion Decision - Khrabnazerh - Lead Up
war_of_the_rohirrim.0213 = {
	content_source = realms_dlc
	type = character_event
	title =  war_of_the_rohirrim.0213.t
	desc =  war_of_the_rohirrim.0213.desc
	theme = faith
	
	left_portrait = {
		character = root
		animation = personality_bold
	}

	override_background = {
		reference = fp1_runestone_circle
	}

	override_effect_2d = {
		reference = smoke
	}

	immediate = {
		add_character_flag = wulf_faith_question_resolved
	}

	option = {
		name =  war_of_the_rohirrim.0213.a
		trigger_event = war_of_the_rohirrim.0214
	}
}

# Freca Conversion Decision - Khrabnazerh - Trial
war_of_the_rohirrim.0214 = {
	content_source = realms_dlc
	type = character_event
	title =  war_of_the_rohirrim.0214.t
	desc =  war_of_the_rohirrim.0214.desc
	theme = faith
	
	left_portrait = {
		character = root
		animation = wrestling_yield_start
	}

	override_background = {
		reference = fp1_runestone
	}

	override_effect_2d = {
		reference = smoke
	}

	immediate = {
		increase_wounds_effect = { REASON = fight }
	}

	option = {
		name =  war_of_the_rohirrim.0214.a
		trigger_event = war_of_the_rohirrim.0215
	}
}

# Freca Conversion Decision - Khrabnazerh - Triumph
war_of_the_rohirrim.0215 = {
	content_source = realms_dlc
	type = character_event
	title =  war_of_the_rohirrim.0215.t
	desc =  war_of_the_rohirrim.0215.desc
	theme = faith
	
	left_portrait = {
		character = root
		animation = wedding_drunk
	}

	override_background = {
		reference = fp1_runestone
	}

	override_effect_2d = {
		reference = smoke
	}

	immediate = {
	}

	option = {
		name =  war_of_the_rohirrim.0215.a
		set_character_faith_with_conversion = faith:faith_dunlending_khrabnazerh
		spawn_army = {
			men_at_arms = {
				type = dunlending_axe_hunters
				stacks = 1
			}
			inheritable = yes
			uses_supply = yes
			location = capital_province
			name = raven_guard
		}
		add_character_modifier = {
			modifier = wulf_martial_faith_character_modifier
			years = 10
		}
	}
}

# Freca Conversion Decision - Rohirric - A Quiet Resolve
war_of_the_rohirrim.0216 = {
	content_source = realms_dlc
	type = character_event
	title =  war_of_the_rohirrim.0216.t
	desc =  war_of_the_rohirrim.0216.desc
	theme = faith
	
	left_portrait = {
		character = root
		animation = holding_staff
	}

	override_background = {
		reference = fp1_runestone
	}

	immediate = {
		add_character_flag = wulf_faith_question_resolved
	}

	option = {
		name =  war_of_the_rohirrim.0216.a
		add_character_modifier = {
			modifier = wulf_middle_ground_faith_character_modifier
			years = 10
		}
	}
}

# Freca Saralain Marriage Decision - Initial
war_of_the_rohirrim.0300 = {
	content_source = realms_dlc
	type = character_event
	title =  war_of_the_rohirrim.0300.t
	desc =  war_of_the_rohirrim.0300.desc
	theme = martial
	
	left_portrait = {
		character = root
		animation = war_attacker
	}

	right_portrait = {
		character = scope:pedrogh
		animation = marshal_mace
	}

	lower_center_portrait = scope:guin

	override_background = {
		reference = wilderness
	}

	immediate = {
		add_character_flag = wulf_saralain_marriage_opportunity_taken
		character:lineofmorcad2 = {
			save_scope_as = pedrogh
		}
		character:lineofmorcad3sister = {
			save_scope_as = guin
		}
	}

	option = {
		name = war_of_the_rohirrim.0300.a
		character:lineofmorcad2 = {
			every_character_war = {
				add_attacker = root
			}
		}
		trigger_event = {
			id = war_of_the_rohirrim.0301
			days = 7
		}
	}
}

# Freca Saralain Marriage Decision - Ongoing war maintenance checks
war_of_the_rohirrim.0301 = {
	hidden = yes
	scope = none
	
	immediate = {
		if = { # If I'm still in a war alongside Pedrogh, check again in a week.
			limit = { any_war_ally = { this = scope:pedrogh } }
			trigger_event = {
				id = war_of_the_rohirrim.0301
				days = 7
			}
		}
		else_if = { # If wars are over and Pedrogh has the 3 duchy counties in his realm, trigger success event
			limit = {
				scope:pedrogh = {
					any_realm_county = {
						count = 3
						OR = {
							this = title:c_lond_daer
							this = title:c_fadairigh
							this = title:c_colgrin
						}
					}
				}
			}
			trigger_event = war_of_the_rohirrim.0302
		}
		else = { # Otherwise trigger failure event
			trigger_event = war_of_the_rohirrim.0303
		}
	}
}

# Freca Saralain Marriage Decision - Success
war_of_the_rohirrim.0302 = {
	content_source = realms_dlc
	type = character_event
	title =  war_of_the_rohirrim.0302.t
	desc =  war_of_the_rohirrim.0302.desc
	theme = marriage
	
	left_portrait = {
		character = root
		animation = flirtation
	}

	right_portrait = {
		character = scope:guin
		animation = personality_content
	}

	lower_center_portrait = scope:pedrogh

	immediate = {
		create_title_and_vassal_change = {
			type = created
			save_scope_as = change
		}
		title:d_nen_gwathlo = {
			change_title_holder = {
				holder = scope:pedrogh
				change = scope:change
			}
		}
		resolve_title_and_vassal_change = scope:change
	}

	option = { # Marry her and secure the alliance
		name = war_of_the_rohirrim.0302.a
		trigger = {
			is_married = no
			is_betrothed = no
		}
		marry = scope:guin
		custom_tooltip = {
			text = war_of_the_rohirrim.0302.a.effect
			create_alliance = {			
				target = scope:pedrogh	
				allied_through_owner = root
				allied_through_target = scope:guin
			}
		}
	}

	option = { # On second thoughts, can you thank me in some other way?
		name = war_of_the_rohirrim.0302.b
		add_gold = 200
		scope:pedrogh = {
			remove_short_term_gold = 200
			add_opinion = {
				target = root
				modifier = insulted_family_opinion
				opinion = -50
			}
		}
	}
}

# Freca Saralain Marriage Decision - Failure
war_of_the_rohirrim.0303 = {
	content_source = realms_dlc
	type = character_event
	title =  war_of_the_rohirrim.0303.t
	desc =  war_of_the_rohirrim.0303.desc
	theme = diplomacy
	
	left_portrait = {
		character = root
		animation = war_over_loss
	}

	right_portrait = {
		character = scope:guin
		animation = personality_forgiving
	}

	lower_center_portrait = scope:pedrogh

	override_background = {
		reference = throne_room_tribal
	}

	option = { # Well shit.
		name = war_of_the_rohirrim.0303.a
		add_gold = 50
		add_prestige = -50
		scope:pedrogh = {
			remove_short_term_gold = 50
			add_opinion = {
				target = root
				modifier = disappointed_opinion
				opinion = -20
			}
		}
	}

}