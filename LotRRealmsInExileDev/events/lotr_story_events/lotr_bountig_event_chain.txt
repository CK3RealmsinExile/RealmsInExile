namespace = bountig_event_chain

#	bountig_event_chain.0001 - 4999 ~ Bountig's events
#	bountig_event_chain.5000 - 5100 ~ Khand & Ovatha
# 	bountig_event_chain.9000 - 9999 ~ Management events



### BOUNTIG EVENTS ###

bountig_event_chain.0001 = {
	hidden = yes 

	on_trigger_fail = { #Trigger invitation again if it was blocked because the character was handling another invitation
		trigger_event = { id = bountig_event_chain.0001 days = 1 }
	}

	immediate = {
		pan_camera_to_province = scope:rhun_attacker.location
		trigger_event = {
			id = bountig_event_chain.9999
			days = 1
		}
	}
}

bountig_event_chain.0002 = {
	hidden = yes 

	trigger = {
		is_available = yes
	}

	on_trigger_fail = { #Trigger invitation again if it was blocked because the character was handling another invitation
		trigger_event = { id = bountig_event_chain.0002 days = 1 }
	}

	immediate = {
		pan_camera_to_province = title:c_minas_tirith.title_province
		scope:task_contract = { open_view_data = task_contract }
	}
}

bountig_event_chain.0010 = { # Eastern Rohan vassals get opportunity to join war
	type = character_event
	title = bountig_event_chain.0010.t
	desc = bountig_event_chain.0010.desc
	theme = martial
	
	right_portrait = {
		character = root
		animation = personality_rational
	}
	
	option = {
		name = bountig_event_chain.0010.a
		if = {
			limit = {
				NOT = { any_character_war = { this = scope:story_war } }
			}
			scope:story_war = { add_defender = root }
			set_variable = joined_war
		}
		ai_chance = {
 			base = 90
			ai_value_modifier = {
				ai_boldness = 0.5
			}
 			modifier = {
 				add = 100
 				OR = {
 					has_trait = ambitious
					has_trait = honest
 				}
 			}
		}
	}

	option = {
		name = bountig_event_chain.0010.b
		
		ai_chance = {
 			base = 0
 			modifier = {
 				add = 100
 				has_trait = craven
 			}
		}
	}

	after = {
		if = {
			limit = { has_variable = joined_war }
			trigger_event = {
				id = bountig_event_chain.0011
				days = 30
			}
			remove_variable = joined_war
		}
		
	}
}

bountig_event_chain.0011 = {
	hidden = yes

	immediate = {
		ordered_army = {
			order_by = army_size
			assign_commander = root
			set_army_location = scope:employer.location
		}

		scope:bountig = {
			trigger_event = {
				id = bountig_event_chain.0015
				days = 15
			}
		}
	}
}

bountig_event_chain.0015 = {
	type = character_event
	title = bountig_event_chain.0015.t
	desc = bountig_event_chain.0015.desc
	theme = martial
	
	right_portrait = {
		character = root
		animation = personality_rational
	}

	trigger = { NOT = { has_character_flag = abandon_easterling_war } }

	immediate = { add_character_flag = { flag = abandon_easterling_war } }

	option = {
		name = bountig_event_chain.0015.a
		custom_tooltip = {
			text = bountig_event_chain.0015.a.tt
			random_character_war = {
				limit = { primary_defender = title:k_rohan.holder }
				remove_participant = root
			}
		}
		add_trait = bountig_story_trait
		set_variable = bountig_story_visit_minas_tirith
	}
}

### KHAND & OVATHA EVENTS ###

# Check if Bountig is alive and has returned to Mistrand
bountig_event_chain.5000 = {  
	hidden = yes
	orphan = yes # Placeholder, this will need to be triggered by Bountig's return to Rhûn
	immediate = {
		if = {
			limit = {
				character:bountigmedlokan = { # Bountig
					is_alive = yes
				}
			}
			character:bountigmedlokan = { save_scope_as = bountigmedlokan }
		}
		
		title:c_ubesesh.holder = { # Make sure this is Ovatha!
			trigger_event = bountig_event_chain.5001 
		}
	}
}

# Receive news of a rhunnic adventurer on the rise, serving as an important advisor to the quarreling easterlings
bountig_event_chain.5001 = {
	type = character_event
	title = bountig_event_chain.5001.t
	desc = bountig_event_chain.5001.desc
	theme = diplomacy_foreign_affairs_focus
	override_background = {
		reference = council_chamber
	}
	
	left_portrait = {
		character = root
		animation = personality_rational
	}

	option = { # Let us investigate this new threat
		name = bountig_event_chain.5001.a
		custom_tooltip = bountig_event_chain.5001.a.tt # Send spies to Mistrand
		remove_short_term_gold = tiny_gold_value
		trigger_event = {
			id = bountig_event_chain.5002
			days = { 60 90 }
		}
	}
	
	option = { # I'll ignore this fool.
		name = bountig_event_chain.5001.b
		custom_tooltip = bountig_event_chain.5001.b.tt # Do nothing
		# Trigger the next event once Bountig unites Rhûn
	}
}

# Spies return from Mistrand with more details
bountig_event_chain.5002 = {
	type = character_event
	title = bountig_event_chain.5002.t
	desc = bountig_event_chain.5002.desc
	theme = diplomacy_foreign_affairs_focus
	override_background = {
		reference = council_chamber
	}
	
	left_portrait = {
		character = root
		animation = worry
	}
	
	right_portrait = {
		character = scope:bountigmedlokan
		animation = marshal_shield
	}

	option = { # It is time to unite
		name = bountig_event_chain.5002.a
		custom_tooltip = bountig_event_chain.5002.a.tt # Unlock the decision to unite Upper Khand
		add_character_flag = { flag = ovatha_unite_upper_khand }
	}
}

# Uniting the Kingdom of Upper Khand (triggered by decision)
bountig_event_chain.5003 = {
	type = character_event
	title = bountig_event_chain.5003.t
	desc = bountig_event_chain.5003.desc
	theme = realm
	override_background = {
		reference = throne_room
	}
	
	left_portrait = {
		character = root
		animation = personality_bold
	}
	
	lower_right_portrait = {
		character = scope:bountigmedlokan
	}
	
	immediate = {
		show_as_tooltip = {
			get_title = title:k_upper_khand
		}
	}

	option = { # Let the Lords of Upper Khand bend the knee before me!
		name = bountig_event_chain.5003.a
		custom_tooltip = bountig_event_chain.5003.a.tt
		title:k_upper_khand = {
			every_de_jure_county_holder = {
            	limit = {
					is_independent_ruler = yes
					is_landed = yes
					NOT = { is_orc = yes }
				}
				trigger_event = {
					id = bountig_event_chain.5004
					days = { 2 7 }
				}
			}
		}
	}
}

bountig_event_chain.5004 = { # Receive the order to submit to Ovatha
	type = letter_event
	sender = scope:sender
	opening = bountig_event_chain.5004.opening
	desc = bountig_event_chain.5004.desc

	trigger = {
		NOT = { is_at_war_with = title:k_upper_khand.holder }
		NOT = { root = title:k_upper_khand.holder }
		NOT = { is_vassal_or_below_of = title:k_upper_khand.holder }
	}

	on_trigger_fail = { #Trigger invitation again if it was blocked because the character was handling another invitation
		trigger_event = {
			id = bountig_event_chain.5004
			days = 1
		}
	}

	immediate = {
		title:k_upper_khand.holder = {
			save_scope_as = sender
		}
		ROOT = {
			save_scope_as = recipient
		}
	}

	option = { # It would be best to submit...
		name = bountig_event_chain.5004.a 
		show_as_tooltip = {
			create_title_and_vassal_change = {
				type = swear_fealty
				save_scope_as = change
				add_claim_on_loss = no
			}
			change_liege = {
				liege = scope:sender
				change = scope:change
			}
			resolve_title_and_vassal_change = scope:change
		}
		hidden_effect = {
			scope:sender = { trigger_event = bountig_event_chain.5005 }
		}

		ai_chance = { # Canonically they do bend the knee out of fear 
			base = 100
		}
	}

	option = { # I will remain independent
		name = bountig_event_chain.5004.a
		trigger = { is_ai = no }
		show_as_tooltip = {
			if = {
				limit = {
					scope:recipient.primary_title.kingdom ?= title:k_upper_khand
				}
				scope:sender = {
					add_unpressed_claim = scope:recipient.primary_title
				}
			}
			add_prestige = medium_prestige_gain
		}
		hidden_effect = {
			scope:sender = { trigger_event = bountig_event_chain.5006 }
		}
	}
}

bountig_event_chain.5005 = { # Subjugation accepted
	type = letter_event
	opening = bountig_event_chain.5005.opening
	desc = bountig_event_chain.5005.desc
	sender = scope:recipient

	immediate = {
		scope:recipient = {
			create_title_and_vassal_change = {
				type = swear_fealty
				save_scope_as = change
				add_claim_on_loss = no
			}
			change_liege = {
				liege = scope:sender
				change = scope:change
			}
			resolve_title_and_vassal_change = scope:change
		}
	}

	option = { # Wise choice
		name = bountig_event_chain.5005.a
	}
}

bountig_event_chain.5006 = { # Subjugation refused
	type = letter_event
	opening = bountig_event_chain.5006.opening
	desc = bountig_event_chain.5006.desc
	sender = {
		character = scope:recipient
		animation = personality_bold
	}

	immediate = {
		if = {
			limit = {
				scope:recipient.primary_title.kingdom ?= title:k_upper_khand
			}
			scope:sender = {
				add_unpressed_claim = scope:recipient.primary_title
			}
		}
		scope:recipient = { add_prestige = 75 }
	}

	option = { # I must use force...
		name = bountig_event_chain.5006.a
		start_war = {
			casus_belli = claim_cb
			target = scope:recipient
			claimant = root
			target_title = scope:recipient.primary_title
		}
		ai_chance = {
			base = 100 
		}
	}
	
	option =  { # I'll ignore them
		name = bountig_event_chain.5006.b 
		add_pressed_claim = scope:recipient.primary_title
	}
}


### MANAGEMENT EVENTS ###

bountig_event_chain.9999 = { #Open the contract 
	hidden = yes
	immediate = {
		random_task_contract = {
			limit = { has_task_contract_type = lotr_story }
			save_scope_as = task_contract
		}
		scope:task_contract = { open_view_data = task_contract }
	}
}