namespace = bountig_event_chain

#	bountig_event_chain.0001 - 4999 ~ Bountig's events
#	bountig_event_chain.5000 - 5100 ~ Khand & Ovatha
# 	bountig_event_chain.9000 - 9999 ~ Management events

scripted_effect set_contract_scopes_effect = {
	scope:task_contract.task_contract_taker ?= { save_scope_as = task_contract_taker }
	scope:task_contract.task_contract_employer ?= { save_scope_as = task_contract_employer }
	if = {
		limit = { exists = scope:task_contract.task_contract_destination }
		scope:task_contract.task_contract_destination = { save_scope_as = task_contract_destination }
	}
	else = {
		scope:task_contract.var:task_contract_destination ?= { save_scope_as = task_contract_destination }
	}
	if = {
		limit = { exists = scope:task_contract.task_contract_target }
		scope:task_contract.task_contract_target ?= { save_scope_as = task_contract_target }
	}
	else = {
		scope:task_contract.var:task_contract_target ?= { save_scope_as = task_contract_target }
	}
	scope:task_contract.var:task_contract_war ?= { save_scope_as = task_contract_war }
	if = {
		limit = { exists = scope:task_contract.var:task_contract_object }
		scope:task_contract.var:task_contract_object = { save_scope_as = task_contract_object }
	}
	if = {
		limit = { exists = scope:task_contract.var:escorted_artifact }
		scope:task_contract.var:escorted_artifact = { save_scope_as = escorted_artifact }
	}
	if = {
		limit = { exists = scope:task_contract.var:escorted_gold }
		scope:task_contract.var:escorted_gold = { save_scope_as = escorted_gold }
	}
	if = {
		limit = { exists = scope:task_contract.var:escorted_story }
		scope:task_contract.var:escorted_story = { save_scope_as = escorted_story }
	}
}

### BOUNTIG EVENTS ###

bountig_event_chain.0001 = {
	hidden = yes 

	on_trigger_fail = { #Trigger invitation again if it was blocked because the character was handling another invitation
		trigger_event = { id = bountig_event_chain.0001 days = 1 }
	}

	immediate = {
		# pan_camera_to_province = scope:rhun_attacker.location
		trigger_event = {
			id = bountig_event_chain.9999
			days = 1
		}
	}
}

bountig_event_chain.0002 = {
	hidden = yes 

	trigger = {
		is_available = yes
	}

	on_trigger_fail = { #Trigger invitation again if it was blocked because the character was handling another invitation
		trigger_event = { id = bountig_event_chain.0002 days = 1 }
	}

	immediate = {
		pan_camera_to_province = title:c_minas_tirith.title_province
		scope:task_contract = { open_view_data = task_contract }
	}
}

bountig_event_chain.0003 = { #Bountig accepts the contract in the East
	type = character_event
	title = bountig_event_chain.0003.t
	desc = bountig_event_chain.0003.desc
	theme = martial
	
	right_portrait = {
		character = root
		animation = personality_rational
	}

	immediate = {
		# scope:task_contract = { save_scope_as = task_contract }
		set_contract_scopes_effect = yes 
	}

	option = { # Travel with full domicile
		name = bountig_event_chain.0003.a
		set_variable = cannot_cancel_travel
		start_travel_plan = {
			destination = scope:task_contract_destination
			travel_with_domicile = yes
			return_trip = no
			players_use_planner = no
			on_arrival_event = bountig_event_chain.0004
			on_arrival_destinations = all
		}
	}
}

bountig_event_chain.0004 = {
	hidden = yes
	# Saved scopes:
	## employer
	## task_contract_taker
	## task_contract_destination
	## task_contract
	immediate = {
		remove_variable = cannot_cancel_travel
		save_scope_as = bountig
		title:k_rohan.holder ?= { save_scope_as = war_target }

		if = {
			limit = { exists = scope:war_target }
			scope:employer = {
				start_war = {
					casus_belli = bountig_special_raid_for_captives_cb
					target = scope:war_target
					target_title = scope:war_target.primary_title
				}
			}
		} else = {
			title:k_south_rhovanion = { # Start a war between a Ioriag duke and Rohan
				random_de_jure_county = {
					limit = {
						is_wastelands = no
						culture = { has_cultural_pillar = heritage_ioriag }
						holder = { highest_held_title_tier > tier_county }
						holder = { is_at_war = no }
						NOT = { holder = scope:employer }
					}
					alternative_limit = {
						is_wastelands = no
						culture = { has_cultural_pillar = heritage_ioriag }
						holder = { highest_held_title_tier > tier_barony }
						holder = { is_at_war = no }
						NOT = { holder = scope:employer }
					}
					alternative_limit = {
						is_wastelands = no
						culture = { has_cultural_pillar = heritage_ioriag }
						holder = { highest_held_title_tier > tier_county }
						NOT = { holder = scope:employer }
					}
					holder = { save_scope_as = war_target }
				}
			}
			scope:employer = {
				start_war = {
					casus_belli = bountig_special_raid_for_captives_cb
					target = scope:war_target
					target_title = scope:war_target.primary_title
				}
			}
		}

		scope:employer = {
			random_character_war = {
				limit = { primary_defender = scope:war_target }
				set_called_to = scope:bountig
				add_attacker = scope:bountig
				save_scope_as = story_war
			}
			set_variable = {
				name = bountig
				value = scope:bountig 
			}
		}
		scope:war_target = {
			every_vassal = { trigger_event = bountig_event_chain.0010 }
		}
	}
}

bountig_event_chain.0005 = { # Bountig gets offered land or gold, either ending or boosting his story line
	type = character_event
	title = bountig_event_chain.0005.t
	desc = bountig_event_chain.0005.desc
	theme = martial
	
	right_portrait = {
		character = root
		animation = personality_rational
	}

	left_portrait = {
		character = scope:attacker
		animation = personality_rational
	}

	immediate = { save_scope_as = bountigmedlokan }

	option = { # Travel with full domicile
		name = bountig_event_chain.0005.a
		set_variable = cannot_cancel_travel
		title:c_minas_tirith.empire.holder ?= { save_scope_as = gondor_ruler }
		add_gold = 500
		add_prestige = 500
		start_travel_plan = {
			destination = scope:gondor_ruler.capital_province
			travel_with_domicile = yes
			return_trip = no
			players_use_planner = no
			on_arrival_event = bountig_event_chain.0012
			on_arrival_destinations = all
		}
	}

	option = { #Decide to end story line, stay in Rhun
		name = bountig_event_chain.0005.b
		custom_tooltip = bountig_event_chain.0005.b.tt

		trigger = {
			scope:attacker = {
				any_held_county = { count > 1 }
			}
		}
		random_owned_story = {
			limit = { story_type = story_cycle_bountig_medlokan }
			end_story = yes
		}
		scope:attacker = {
			random_held_county = {
				limit = { NOT = { this = scope:attacker.capital_county } }
				save_scope_as = handed_out_county
			}
		}
		create_title_and_vassal_change = {
			type = granted
			save_scope_as = change
			add_claim_on_loss = no
		}
		scope:handed_out_county = {
			change_title_holder = {
				holder = root
				change = scope:change
			}
		}
		resolve_title_and_vassal_change = scope:change

		create_title_and_vassal_change = {
			type = swear_fealty
			save_scope_as = change
			add_claim_on_loss = no
		}
		change_liege = {
			liege = scope:attacker
			change = scope:change
		}
		resolve_title_and_vassal_change = scope:change
	}
}

bountig_event_chain.0010 = { # Eastern Rohan vassals get opportunity to join war
	type = character_event
	title = bountig_event_chain.0010.t
	desc = bountig_event_chain.0010.desc
	theme = martial
	
	right_portrait = {
		character = root
		animation = personality_rational
	}

	trigger = {
		any_held_county = {
			any_neighboring_county = {
				exists = holder
				OR = {
					holder = { is_wastelands = yes }
					holder = { faith_is_good = no }
				}
			}
		}
	}
	
	option = {
		name = bountig_event_chain.0010.a
		trigger = {
			NOT = {
				any_character_war = {
					is_defender = scope:war_target
					is_attacker = root
				}
			}
		}

		if = {
			limit = {
				NOT = { any_character_war = { this = scope:story_war } }
			}
			scope:story_war = { add_defender = root }
		}
		ai_chance = {
 			base = 90
			ai_value_modifier = {
				ai_boldness = 0.5
			}
 			modifier = {
 				add = 100
 				OR = {
 					has_trait = ambitious
					has_trait = honest
 				}
 			}
			modifier = {
				factor = 0.5
				OR = {
					has_any_bad_relationship_with_character_trigger = { CHARACTER = scope:war_target }
				}
			}
		}
	}

	option = {
		name = bountig_event_chain.0010.b
		
		ai_chance = {
 			base = 0
 			modifier = {
 				add = 100
 				has_trait = craven
 			}
		}
	}
}

bountig_event_chain.0011 = { #Bountig is forced to travel southwards
	type = character_event
	title = bountig_event_chain.0011.t
	desc = bountig_event_chain.0011.desc
	theme = martial
	
	right_portrait = {
		character = root
		animation = personality_rational
	}

	immediate = { title:c_minas_tirith.empire.holder ?= { save_scope_as = gondor_ruler } }

	option = { # Travel with full domicile
		name = bountig_event_chain.0011.a
		set_variable = cannot_cancel_travel
		custom_tooltip = bountig_event_chain.0011.a.tt
		start_travel_plan = {
			destination = scope:gondor_ruler.capital_province
			travel_with_domicile = yes
			return_trip = no
			players_use_planner = no
			on_arrival_event = bountig_event_chain.0012
			on_arrival_destinations = all
		}
	}
}

bountig_event_chain.0012 = { #Bountig arrives in Minas Tirith
	type = character_event
	title = bountig_event_chain.0012.t
	desc = bountig_event_chain.0012.desc
	theme = martial
	
	right_portrait = {
		character = root
		animation = personality_rational
	}

	option = { # Travel with full domicile
		name = bountig_event_chain.0012.a
		remove_variable = cannot_cancel_travel
	}
}

#############################
### KHAND & OVATHA EVENTS ###
#############################

# Check if Bountig is alive and has returned to Mistrand
bountig_event_chain.5000 = {  
	hidden = yes
	orphan = yes # Placeholder, this will need to be triggered by Bountig's return to Rhûn
	immediate = {
		if = {
			limit = {
				character:bountigmedlokan = { # Bountig
					is_alive = yes
				}
			}
			character:bountigmedlokan = { save_scope_as = bountigmedlokan }
		}
		
		title:c_ubesesh.holder = { # Make sure this is Ovatha!
			trigger_event = bountig_event_chain.5001 
		}
	}
}

# Receive news of a rhunnic adventurer on the rise, serving as an important advisor to the quarreling easterlings
bountig_event_chain.5001 = {
	type = character_event
	title = bountig_event_chain.5001.t
	desc = bountig_event_chain.5001.desc
	theme = diplomacy_foreign_affairs_focus
	override_background = {
		reference = council_chamber
	}
	
	left_portrait = {
		character = root
		animation = personality_rational
	}

	option = { # Let us investigate this new threat
		name = bountig_event_chain.5001.a
		custom_tooltip = bountig_event_chain.5001.a.tt # Send spies to Mistrand
		remove_short_term_gold = tiny_gold_value
		trigger_event = {
			id = bountig_event_chain.5002
			days = { 60 90 }
		}
	}
	
	option = { # I'll ignore this fool.
		name = bountig_event_chain.5001.b
		custom_tooltip = bountig_event_chain.5001.b.tt # Do nothing
		# Trigger the next event once Bountig unites Rhûn
	}
}

# Spies return from Mistrand with more details
bountig_event_chain.5002 = {
	type = character_event
	title = bountig_event_chain.5002.t
	desc = bountig_event_chain.5002.desc
	theme = diplomacy_foreign_affairs_focus
	override_background = {
		reference = council_chamber
	}
	
	left_portrait = {
		character = root
		animation = worry
	}
	
	right_portrait = {
		character = scope:bountigmedlokan
		animation = marshal_shield
	}

	option = { # It is time to unite
		name = bountig_event_chain.5002.a
		custom_tooltip = bountig_event_chain.5002.a.tt # Unlock the decision to unite Upper Khand
		add_character_flag = { flag = ovatha_unite_upper_khand }
	}
}

# Uniting the Kingdom of Upper Khand (triggered by decision)
bountig_event_chain.5003 = {
	type = character_event
	title = bountig_event_chain.5003.t
	desc = bountig_event_chain.5003.desc
	theme = realm
	override_background = {
		reference = throne_room
	}
	
	left_portrait = {
		character = root
		animation = personality_bold
	}
	
	lower_right_portrait = {
		character = scope:bountigmedlokan
	}
	
	immediate = {
		show_as_tooltip = {
			get_title = title:k_upper_khand
		}
	}

	option = { # Let the Lords of Upper Khand bend the knee before me!
		name = bountig_event_chain.5003.a
		custom_tooltip = bountig_event_chain.5003.a.tt
		title:k_upper_khand = {
			every_de_jure_county_holder = {
            	limit = {
					is_independent_ruler = yes
					is_landed = yes
					NOT = { is_orc = yes }
				}
				trigger_event = {
					id = bountig_event_chain.5004
					days = { 2 7 }
				}
			}
		}
	}
}

bountig_event_chain.5004 = { # Receive the order to submit to Ovatha
	type = letter_event
	sender = scope:sender
	opening = bountig_event_chain.5004.opening
	desc = bountig_event_chain.5004.desc

	trigger = {
		NOT = { is_at_war_with = title:k_upper_khand.holder }
		NOT = { root = title:k_upper_khand.holder }
		NOT = { is_vassal_or_below_of = title:k_upper_khand.holder }
	}

	on_trigger_fail = { #Trigger invitation again if it was blocked because the character was handling another invitation
		trigger_event = {
			id = bountig_event_chain.5004
			days = 1
		}
	}

	immediate = {
		title:k_upper_khand.holder = {
			save_scope_as = sender
		}
		ROOT = {
			save_scope_as = recipient
		}
	}

	option = { # It would be best to submit...
		name = bountig_event_chain.5004.a 
		show_as_tooltip = {
			create_title_and_vassal_change = {
				type = swear_fealty
				save_scope_as = change
				add_claim_on_loss = no
			}
			change_liege = {
				liege = scope:sender
				change = scope:change
			}
			resolve_title_and_vassal_change = scope:change
		}
		hidden_effect = {
			scope:sender = { trigger_event = bountig_event_chain.5005 }
		}

		ai_chance = { # Canonically they do bend the knee out of fear 
			base = 100
		}
	}

	option = { # I will remain independent
		name = bountig_event_chain.5004.a
		trigger = { is_ai = no }
		show_as_tooltip = {
			if = {
				limit = {
					scope:recipient.primary_title.kingdom ?= title:k_upper_khand
				}
				scope:sender = {
					add_unpressed_claim = scope:recipient.primary_title
				}
			}
			add_prestige = medium_prestige_gain
		}
		hidden_effect = {
			scope:sender = { trigger_event = bountig_event_chain.5006 }
		}
	}
}

bountig_event_chain.5005 = { # Subjugation accepted
	type = letter_event
	opening = bountig_event_chain.5005.opening
	desc = bountig_event_chain.5005.desc
	sender = scope:recipient

	immediate = {
		scope:recipient = {
			create_title_and_vassal_change = {
				type = swear_fealty
				save_scope_as = change
				add_claim_on_loss = no
			}
			change_liege = {
				liege = scope:sender
				change = scope:change
			}
			resolve_title_and_vassal_change = scope:change
		}
	}

	option = { # Wise choice
		name = bountig_event_chain.5005.a
	}
}

bountig_event_chain.5006 = { # Subjugation refused
	type = letter_event
	opening = bountig_event_chain.5006.opening
	desc = bountig_event_chain.5006.desc
	sender = {
		character = scope:recipient
		animation = personality_bold
	}

	immediate = {
		if = {
			limit = {
				scope:recipient.primary_title.kingdom ?= title:k_upper_khand
			}
			scope:sender = {
				add_unpressed_claim = scope:recipient.primary_title
			}
		}
		scope:recipient = { add_prestige = 75 }
	}

	option = { # I must use force...
		name = bountig_event_chain.5006.a
		start_war = {
			casus_belli = claim_cb
			target = scope:recipient
			claimant = root
			target_title = scope:recipient.primary_title
		}
		ai_chance = {
			base = 100 
		}
	}
	
	option =  { # I'll ignore them
		name = bountig_event_chain.5006.b 
		add_pressed_claim = scope:recipient.primary_title
	}
}


### MANAGEMENT EVENTS ###

bountig_event_chain.9999 = { #Open the contract 
	hidden = yes
	immediate = {
		random_task_contract = {
			limit = { has_task_contract_type = lotr_bountig_story_eastern_rhovanion_war }
			save_scope_as = task_contract
		}
		scope:task_contract = { open_view_data = task_contract }
	}
}