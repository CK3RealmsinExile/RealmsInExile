namespace = maglor_event_chain

### Elven Events ###

scripted_effect grant_himring_away = {
	## Grant Himring to Maglor Friend

	create_title_and_vassal_change = {
		type = granted
		save_scope_as = title_change
		add_claim_on_loss = no
	}

	title:c_himring = {
		change_title_holder = {
			holder = character:lineoflauriel
			change = scope:title_change
		}
	}
	
	resolve_title_and_vassal_change = scope:title_change
}

scripted_effect upgrade_edhellond_province = {
	title:c_edhellond = { change_development_level = 5 } 
	province:420 = { add_building = elven_settlement_03 }
}

scripted_effect elven_settlement_add_building_effect = {
	if = {
		limit = {
			NOT = { has_building_or_higher = elven_settlement_01 }
		}
		add_building = elven_settlement_01
	}
	else_if = {
		limit = { has_building = elven_settlement_01 }
		add_building = elven_settlement_02
	}
	else_if = {
		limit = { has_building = elven_settlement_02 }
		add_building = elven_settlement_03
	}
	else_if = {
		limit = { has_building = elven_settlement_03 }
		add_building = elven_settlement_04
	}
	else_if = {
		limit = { has_building = elven_settlement_04 }
		add_building = elven_settlement_05
	}
	else_if = {
		limit = { has_building = elven_settlement_05 }
		add_building = elven_settlement_06
	}
	else_if = {
		limit = { has_building = elven_settlement_06 }
		add_building = elven_settlement_07
	}
}

scripted_effect maglor_wins_balrog = {
	set_variable = unlock_underground_cb
	custom_tooltip = maglor_event_chain.0056.cb_unlock
	send_interface_toast = {
		title = maglor_event_chain.0056.toast

		add_character_modifier = {
			modifier = warlord_modifier
			years = 15
		}
		if = { # Juke note: comment out if we dont want maglor gettin a legend seed for it. Thought it'd be neat
			limit = {
				has_dlc_feature = legends
			}
			custom_tooltip = balrog_slayer_legend.tt
			hidden_effect = {
				create_legend_seed = {
					type = heroic
					quality = illustrious
					chronicle = beast_slayer
					properties = {
						beast = flag:balrog
						location = province:4913 # Endless Stairs
					}
				}
			}
		}
	}
	struggle:balrog_struggle = { end_struggle = yes }
	character:linefinwe11 = { 
		save_scope_as = balrog_contender
	}
	if = {
		limit = { # Major News
			NOT = { has_game_rule = no_news }
		}
		every_player = { # Global News Announcement
			trigger_event = balrog_struggle.0002
		}
	}
}

scripted_effect give_amon_lanc_to_elf = {
	create_title_and_vassal_change = {
		type = granted
		save_scope_as = title_change
		add_claim_on_loss = no
	}

	$TITLE$ = {
		change_title_holder = {
			holder = $HOLDER$
			change = scope:title_change
		}
	}

	if = {
		limit = { $TITLE$.tier = tier_county }
		$TITLE$ = {
			set_county_culture = $HOLDER$.culture
			set_county_faith = $HOLDER$.faith
		}
		if = {
			limit = {
				NOT = { title_province = { has_holding_type = elven_holding } }
			}
			every_county_province = { set_holding_type = elven_holding }
		}

	}
	
	resolve_title_and_vassal_change = scope:title_change
}

scripted_effect give_back_himring = {
	create_title_and_vassal_change = {
		type = granted
		save_scope_as = change
		add_claim_on_loss = no
	}
	title:c_himring = {
		change_title_holder = {
			holder = root
			change = scope:change
		}
	}
	resolve_title_and_vassal_change = scope:change
}

maglor_event_chain.0001 = { # Rouse from slumber
	content_source = realms_dlc
	type = character_event
	title = maglor_event_chain.0001.t
	desc = maglor_event_chain.0001.desc
	theme = mental_health

	right_portrait = {
		character = root
		animation = marshal
	}

	option = { # Crusade Against Darkness
		name = maglor_event_chain.0001.a
		custom_tooltip = maglor_event_chain.0001.a.tt
		set_variable = crusade_against_darkness
		
		ai_chance = {
			base = 0 # LotR: This should be tied to WotR mode.
			modifier = { # Game Rule
				has_game_rule = default_ai_behavior
				add = 100
			}
			modifier = { # Game Rule
				has_game_rule = weighted_ai_behavior
				add = 70
			}
			modifier = { # Game Rule
				has_game_rule = random_ai_behavior
				add = 50
			}
		}
	}

	option = { # Kingship by Seniority
		name = maglor_event_chain.0001.b
		custom_tooltip = maglor_event_chain.0001.b.tt
		
		set_variable = fourth_kin_slaying
		
		ai_chance = {
			base = 0 # LotR: This should be tied to WotR mode.
			modifier = { # Game Rule
				has_game_rule = default_ai_behavior
				add = 0
			}
			modifier = { # Game Rule
				has_game_rule = weighted_ai_behavior
				add = 30
			}
			modifier = { # Game Rule
				has_game_rule = random_ai_behavior
				add = 50
			}
		}
	}
}

### 4th Kin-slaying route | Crusade against darkness, elven.1600 onwards ###
maglor_event_chain.0005 = { # Send letter to loyalist asking for support
	type = letter_event
	sender = character:linefinwe11

	opening = {
		desc = maglor_event_chain.0005.opening
	}

	desc = maglor_event_chain.0005.desc


	on_trigger_fail = { #Trigger invitation again if it was blocked because the character was handling another invitation
		trigger_event = {
			id = maglor_event_chain.0005
			days = 1
		}
	}

	option = { # Accept | Join Maglor
		name = maglor_event_chain.0005.a
		set_variable = joined_maglor
		
		ai_chance = {
			base = 100
		}
	}	
	
	option = { # Decline
		name = maglor_event_chain.0005.b

		
		ai_chance = {
			base = 0 
		}
	}
}

maglor_event_chain.0006 = { # Start war against Lindon
	content_source = realms_dlc
	type = character_event
	title = maglor_event_chain.0006.t
	desc = maglor_event_chain.0006.desc
	theme = death

	right_portrait = {
		character = root
		animation = marshal
	}

	override_background = { reference = kinslaying }
	
	immediate = { play_music_cue = mx_cue_murder }

	widgets = {
		widget = {
			gui = "lotr_shader_event_sparks"
			container = "lotr_shader_event_foreground"
		}
		widget = {
			gui = "lotr_shader_event_fire"
			container = "lotr_shader_event_background"
		}
	}
	
	option = { 
		name = maglor_event_chain.0006.a

		start_war = {
			casus_belli = fourth_kinslaying_cb
			target = title:e_lindon.holder
			target_title = title:e_lindon
		}
		title:e_lindon.holder = {
			every_character_war = {
				limit = { using_cb = fourth_kinslaying_cb }
				add_to_list = war_to_join
			}
			every_vassal_or_below = {
				limit = { has_variable = joined_maglor }
				every_in_list = {
					list = war_to_join
					limit = { NOT = { is_defender = prev } }
					hidden_effect = { set_called_to = prev }
					add_attacker = prev
				}
			}
			every_vassal_or_below = {
				limit = { culture = culture:sindar }
				every_in_list = {
					list = war_to_join
					limit = { NOT = { is_attacker = prev } }
					hidden_effect = { set_called_to = prev }
					add_defender = prev
				}
			}
		}
	}
}

maglor_event_chain.0010 = { # The Fourth Kinslaying | Maglor wins the war against Cirdan
	content_source = realms_dlc
	type = character_event
	title = maglor_event_chain.0010.t
	desc = maglor_event_chain.0010.desc
	theme = death
	right_portrait = {
		character = root
		animation = fear
	}
	
	option = { 
		name = maglor_event_chain.0010.a
		add_trait = ambitious
		add_stress = 1000
	}
}

maglor_event_chain.0015 = { # Maglor loses the war against Cirdan
	content_source = realms_dlc
	type = character_event
	title = maglor_event_chain.0010.t
	desc = maglor_event_chain.0010.desc
	theme = death
	right_portrait = {
		character = root
		animation = fear
	}
	
	immediate = {
		character:linefinwe11 = {
			save_scope_as = maglor
		}
	}
	
	option = { 
		name = maglor_event_chain.0010.a
		
		death = { 
			death_reason = death_execution # Executed 
			killer = character:lineofcirdan		
		}
	}
}

maglor_event_chain.0020 = { # Shield of the Free Peoples starting event | Go to Eregion
	content_source = realms_dlc
	type = character_event
	title = maglor_event_chain.0020.t
	desc = maglor_event_chain.0020.desc
	theme = martial_authority_focus
	right_portrait = {
		character = root
		animation = personality_bold
	}

	immediate = {
		set_variable = no_return_event
		set_variable = temp_maglor_var

		hidden_effect = {
			create_character = {
				template = foreign_architect_template
				employer = root
				save_scope_as = caravan_master
			}
			if = {
				limit = { NOT = { employs_court_position = travel_leader_court_position } }
				appoint_court_position = {
					recipient = scope:caravan_master
					court_position = travel_leader_court_position
				}
			}
		}
	}
	
	option = { 
		name = maglor_event_chain.0020.a
		set_variable = cannot_cancel_travel

		send_interface_toast = {
			title = maglor_event_chain.0024.toast 
			custom_tooltip = {
				text = maglor_event_chain.0020.a.tt
				give_maglor_elven_warriors_effect = yes
			}
		}
		
		start_travel_plan = {
			destination = title:c_ost_in_edhil.title_province
			on_arrival_event  = maglor_event_chain.0026
			return_trip = no
			players_use_planner = no
			on_arrival_destinations = all
		}
	}
}

maglor_event_chain.0021 = { # Strike the Heart of the Enemy starting event | Go to Edhellond
	content_source = realms_dlc
	type = character_event
	title = maglor_event_chain.0021.t
	desc = maglor_event_chain.0021.desc
	theme = martial_authority_focus
	right_portrait = {
		character = root
		animation = fear
	}

	immediate = { 
		set_variable = no_return_event 
		hidden_effect = {
			create_character = {
				template = foreign_architect_template
				employer = root
				save_scope_as = caravan_master
			}
			if = {
				limit = { NOT = { employs_court_position = travel_leader_court_position } }
				appoint_court_position = {
					recipient = scope:caravan_master
					court_position = travel_leader_court_position
				}
			}
		}
	}
	
	option = { 
		name = maglor_event_chain.0021.a
		set_variable = cannot_cancel_travel
		
		send_interface_toast = {
			title = maglor_event_chain.0024.toast 
			give_maglor_elven_warriors_effect = yes
		}

		start_travel_plan = {
			destination = title:c_edhellond.title_province
			on_arrival_event = maglor_event_chain.0022
			return_trip = no
			players_use_planner = no
			on_arrival_destinations = first
		}
	}
}

maglor_event_chain.0022 = { # Hidden event | Swap titles for Edhellond
	hidden = yes

	immediate = {
		remove_variable = cannot_cancel_travel

		title:c_edhellond = { # Remove any human buildings
			remove_building_any_level = { BUILDING = caravanserai }
			remove_building_any_level = { BUILDING = watermills }
			remove_building_any_level = { BUILDING = windmills }
			remove_building_any_level = { BUILDING = common_tradeport }
			remove_building_any_level = { BUILDING = pastures }
			remove_building_any_level = { BUILDING = hunting_grounds }
			remove_building_any_level = { BUILDING = orchards }
			remove_building_any_level = { BUILDING = farm_estates }
			remove_building_any_level = { BUILDING = cereal_fields }
			remove_building_any_level = { BUILDING = logging_camps }
			remove_building_any_level = { BUILDING = peat_quarries }
			remove_building_any_level = { BUILDING = hill_farms }
			remove_building_any_level = { BUILDING = elephant_pens }
			remove_building_any_level = { BUILDING = plantations }
			remove_building_any_level = { BUILDING = quarries }
			remove_building_any_level = { BUILDING = guild_halls }
			remove_building_any_level = { BUILDING = ramparts }
			remove_building_any_level = { BUILDING = curtain_walls }
			remove_building_any_level = { BUILDING = watchtowers }
			remove_building_any_level = { BUILDING = hill_forts }
			remove_building_any_level = { BUILDING = wind_furnace }
			remove_building_any_level = { BUILDING = workshops }
			remove_building_any_level = { BUILDING = horse_pastures }
			remove_building_any_level = { BUILDING = hillside_grazing }
			remove_building_any_level = { BUILDING = warrior_lodges }
			remove_building_any_level = { BUILDING = military_camps }
			remove_building_any_level = { BUILDING = regimental_grounds }
			remove_building_any_level = { BUILDING = outposts }
			remove_building_any_level = { BUILDING = barracks }
			remove_building_any_level = { BUILDING = camel_farms }
			remove_building_any_level = { BUILDING = stables }
			remove_building_any_level = { BUILDING = smiths }
			remove_building_any_level = { BUILDING = hillside_grazing }
		}
		every_province = { # Changes province to elven holding
			limit = { 
				county = title:c_edhellond
				has_holding = yes
			}
			set_holding_type = elven_holding			
		}
		
		## Grant Maglor Edhellond

		create_title_and_vassal_change = {
			type = usurped
			save_scope_as = title_change
			add_claim_on_loss = no
		}

		title:c_edhellond = {
			change_title_holder = {
				holder = root
				change = scope:title_change
			}
		}
		
		becomes_independent = { change = scope:title_change }

		resolve_title_and_vassal_change = scope:title_change

		title:c_edhellond = {
			set_county_culture = root.culture
			set_county_faith = root.faith
		}
		province:420 = {
			add_building = elven_forges_02
			add_building = wonder_edhellond_03
			add_building = elven_settlement_02
		}
		## Grant Himring to Maglor Friend

		create_title_and_vassal_change = {
			type = granted
			save_scope_as = title_change
			add_claim_on_loss = no
		}

		title:c_himring = {
			change_title_holder = {
				holder = character:lineoflauriel
				change = scope:title_change
			}
		}
		
		resolve_title_and_vassal_change = scope:title_change

		get_title = title:k_feanor_host

		remove_variable = no_return_event
		
		set_location = root.capital_province

		every_knight = {
			limit = { is_ruler = no }
			set_location = root.capital_province
		}
		every_councillor = {
			limit = { is_ruler = no }
			set_location = root.capital_province
		}
		every_courtier_or_guest = {
			set_location = root.capital_province
		}
		
		add_truce_both_ways = { 
			character = title:k_anfalas.holder
			years = 3
			name = TRUCE_TRADE_DEAL
		}
	}
}

maglor_event_chain.0023 = { # Hidden event | Swap titles for Eregion
	hidden = yes

	immediate = {
		remove_variable = cannot_cancel_travel
		
		## Grant Maglor Eregion

		create_title_and_vassal_change = {
			type = usurped
			save_scope_as = title_change
			add_claim_on_loss = no
		}

		title:c_ost_in_edhil = {
			change_title_holder = {
				holder = root
				change = scope:title_change
			}
			set_county_culture = root.culture
			set_county_faith = root.faith
			change_development_level = 5
			title_province = {
				add_special_building_slot = wonder_mirdairond
				add_special_building = wonder_mirdairond
			}
		}

		if = {
			limit = {
				title:e_lindon.holder = {
					any_vassal_or_below = {
						is_elf = yes 
						has_variable = volunteers_sent
						count > 7
					}
				}
			}
			every_province = { # Changes province to elven holding
				limit = { 
					county = title:c_sirannon
					has_holding = yes
				}
				set_holding_type = elven_holding			
			}
			title:c_sirannon = {
				change_title_holder = {
					holder = root
					change = scope:title_change
				}
				set_county_culture = root.culture
				set_county_faith = root.faith
				change_development_level = 5
			}
		}

		if = {
			limit = {
				title:e_lindon.holder = {
					has_variable = volunteers_sent
					is_elf = yes 
					any_vassal_or_below = {
						is_elf = yes 
						has_variable = volunteers_sent
						count > 11
					}
				}
			}
			every_province = { # Changes province to elven holding
				limit = { 
					county = title:c_arabrand
					has_holding = yes
				}
				set_holding_type = elven_holding			
			}
			title:c_arabrand = {
				change_title_holder = {
					holder = root
					change = scope:title_change
				}
				set_county_culture = root.culture
				set_county_faith = root.faith
				change_development_level = 5
			}
			get_title = title:d_eregion
		}

		becomes_independent = { change = scope:title_change }

		resolve_title_and_vassal_change = scope:title_change
		
		grant_himring_away = yes

		trigger_event = {
			id = maglor_event_chain.0050
			days = { 15 30 }
		}
		get_title = title:k_feanor_host

		every_held_county = {
			every_province = { # Changes province to elven holding
				limit = {
					has_holding = yes
					NOT = { has_holding_Type = elven_holding }
				}
				set_holding_type = elven_holding			
			}
			change_government = elven_government
		}
		change_government = elven_government
		
		set_location = root.capital_province

		every_knight = {
			limit = { is_ruler = no }
			set_location = root.capital_province
		}
		every_councillor = {
			limit = { is_ruler = no }
			set_location = root.capital_province
		}
		every_courtier_or_guest = {
			set_location = root.capital_province
		}

	}
}

maglor_event_chain.0024 = { # Letter Event, Request troops from Lindon
	type = letter_event
	sender = character:linefinwe11

	opening = {
		desc = maglor_event_chain.0024.opening
	}

	desc = maglor_event_chain.0024.desc

	immediate = {
		root = { save_scope_as = elven_ruler }
		primary_title = { save_scope_as = elven_ruler_title }
	}

	on_trigger_fail = { #Trigger invitation again if it was blocked because the character was handling another invitation
		trigger_event = {
			id = maglor_event_chain.0024
			days = 1
		}
	}
	
	option = {
		name = maglor_event_chain.0024.a

		character:linefinwe11 = {
			# send_interface_toast = {
			# 	title = maglor_event_chain.0024.toast
				
				maglor_crusade_elven_warriors = { SUPPORT = 2 }
			# }
		}

		ai_chance = {
			base = 25
			
			modifier = { # Noldor are bloodthirsty
				culture = culture:noldor
				add = 20
			}
		}
	}
	
	option = {
		name = maglor_event_chain.0024.b

		character:linefinwe11 = {
			# send_interface_toast = {
			# 	title = maglor_event_chain.0024.toast

				maglor_crusade_elven_warriors = { SUPPORT = 1 }
			# }
		}

		ai_chance = {
			base = 15
			
			modifier = { # Noldor are bloodthirsty
				culture = culture:noldor
				add = 10
			}
		}
	}
	
	option = {
		name = maglor_event_chain.0024.c

		ai_chance = {
			base = 35
			
			modifier = { # Noldor are bloodthirsty
				culture = culture:noldor
				add = -5
			}
		}
	}
}

maglor_event_chain.0025 = { # Hidden event | Give Maglor songsmiths, to help him siege down counties in his war
	hidden = yes

	immediate = {
		send_interface_toast = {
			title = maglor_event_chain.0024.toast
			random_list = {
				5 = {
					spawn_army = {
						name = elven.maglor_help_songsmiths
						men_at_arms = {
							type = song_smiths
							stacks = 3
						}
						location = root.capital_province
					}
				}
				2 = {
					spawn_army = {
						name = elven.maglor_help_songsmiths
						men_at_arms = {
							type = song_smiths
							stacks = 4
						}
						location = root.capital_province
					}
				}
				1 = {
					spawn_army = {
						name = elven.maglor_help_songsmiths
						men_at_arms = {
							type = song_smiths
							stacks = 5
						}
						location = root.capital_province
					}
				}
			}
		}
	}
}

maglor_event_chain.0026 = { # Event for Eregion | If Eregion already occupied, get an event to either move more northwards or fight the current occupants
	hidden = yes

	immediate = {
		if = {
			limit = { title:c_ost_in_edhil.holder = character:k_wastelands_holder }
			trigger_event = maglor_event_chain.0023
		}
		else = { trigger_event = maglor_event_chain.0027 }
	}
}

maglor_event_chain.0027 = { # Event that Maglor gets to either move north or fight Eregion holders
	content_source = realms_dlc
	type = character_event
	title = maglor_event_chain.0027.t
	desc = maglor_event_chain.0027.desc
	theme = martial_authority_focus
	right_portrait = {
		character = root
		animation = personality_bold
	}

	immediate = {
		title:k_eregion = {
			random_de_jure_county = {
				limit = {
					holder = character:k_wastelands_holder
					NOT = { any_neighboring_county = { NOT = { holder = character:k_wastelands_holder } } }
				}
				save_scope_as = selected_county
			}
		}
	}
	
	option = { # Lets rather settle towards the north
		name = maglor_event_chain.0027.a
		remove_variable = no_return_event

		start_travel_plan = {
			destination = scope:selected_county.title_province
			on_arrival_event = maglor_event_chain.0028
			return_trip = no
			players_use_planner = no
			on_arrival_destinations = first
		}
	}

	option = { # Fight the current occupants
		name = maglor_event_chain.0027.b

		set_variable = war_for_eregion
		remove_variable = no_return_event
		start_war = {
			casus_belli = elven_homelands_duchy_conquest_cb
			target = title:c_ost_in_edhil.holder
			target_title = title:d_eregion
		}
		spawn_army = {
			name = maglor_event_chain.0027.noldor_army
			men_at_arms = {
				type = high_elven_heavy_infantry
				stacks = 4
			}
			men_at_arms = {
				type = high_elven_heavy_cavalry
				stacks = 4
			}
			men_at_arms = {
				type = high_elven_archers
				stacks = 4
			}
			men_at_arms = {
				type = high_elven_heavy_infantry
				stacks = 4
			}
			men_at_arms = {
				type = song_smiths
				stacks = 4
			}
			location = root.location
		}
	}
}

maglor_event_chain.0028 = {
	hidden = yes

	immediate = {
		remove_variable = cannot_cancel_travel

		every_province = { # Changes province to elven holding
			limit = { 
				county = scope:selected_county
				has_holding = yes
			}
			set_holding_type = elven_holding			
		}
		
		## Grant Maglor Edhellond

		create_title_and_vassal_change = {
			type = usurped
			save_scope_as = title_change
			add_claim_on_loss = no
		}

		scope:selected_county = {
			change_title_holder = {
				holder = root
				change = scope:title_change
			}
			set_county_culture = root.culture
			set_county_faith = root.faith
			change_development_level = 5
		}

		if = {
			limit = {
				title:e_lindon.holder = {
					any_vassal_or_below = {
						is_elf = yes 
						has_variable = volunteers_sent
						count > 8
					}
				}
			}
			scope:selected_county = {
				random_connected_county = {
					limit = { holder = character:k_wastelands_holder }
					save_scope_as = secondary_county
					every_province = { # Changes province to elven holding
						limit = { 
							county = scope:secondary_county
							has_holding = yes
						}
						set_holding_type = elven_holding			
					}
				}
			}
			scope:secondary_county = {
				change_title_holder = {
					holder = root
					change = scope:title_change
				}
				set_county_culture = root.culture
				set_county_faith = root.faith
				change_development_level = 5
			}
		}

		if = {
			limit = {
				title:e_lindon.holder = {
					has_variable = volunteers_sent
					is_elf = yes 
					any_vassal_or_below = {
						is_elf = yes 
						has_variable = volunteers_sent
						count > 16
					}
				}
			}
			scope:selected_county = {
				random_connected_county = {
					limit = {
						holder = character:k_wastelands_holder
						NOT = { this = scope:secondary_county }
					}
					save_scope_as = tertiary_county
					every_province = { # Changes province to elven holding
						limit = { 
							county = scope:tertiary_county
							has_holding = yes
						}
						set_holding_type = elven_holding			
					}
				}
			}
			scope:tertiary_county = {
				change_title_holder = {
					holder = root
					change = scope:title_change
				}
				set_county_culture = root.culture
				set_county_faith = root.faith
				change_development_level = 5
			}
		}

		becomes_independent = { change = scope:title_change }

		resolve_title_and_vassal_change = scope:title_change

		grant_himring_away = yes

		get_title = title:k_feanor_host

		set_location = root.capital_province

		every_knight = {
			limit = { is_ruler = no }
			set_location = root.capital_province
		}
		every_councillor = {
			limit = { is_ruler = no }
			set_location = root.capital_province
		}
		every_courtier_or_guest = {
			set_location = root.capital_province
		}
		
		trigger_event = {
			id = maglor_event_chain.0050
			days = { 15 30 }
		}
	}
}

### Strike the Heart of the Enemy event line ###

maglor_event_chain.0030 = { # Letter to gondorian ruler to contribute troops to Maglor Umbar war
	type = letter_event
	sender = character:linefinwe11

	opening = {
		desc = maglor_event_chain.0030.opening
	}

	desc = maglor_event_chain.0030.desc

	immediate = {
		root = { save_scope_as = gondor_ruler }
	}

	on_trigger_fail = { #Trigger invitation again if it was blocked because the character was handling another invitation
		trigger_event = {
			id = maglor_event_chain.0030
			days = 1
		}
	}
	
	option = { 
		name = maglor_event_chain.0030.a

		add_to_global_variable_list = {
			name = gondorian_ruler_supported_maglor
			target = root
		}

		character:linefinwe11 = { trigger_event = maglor_event_chain.0031 }

		ai_chance = {
			base = 0
			
			modifier = { 
				has_trait = brave
				add = 20
			}
			modifier = { 
				has_trait = zealous
				add = 20
			}
			modifier = { 
				OR = {
					title:k_belfalas = {
						any_de_jure_county = {
							holder = scope:gondor_ruler
						}
					}
					title:k_anfalas = {
						any_de_jure_county = {
							holder = scope:gondor_ruler
						}
					}
				}
				add = 20
			}
			modifier = { 
				has_trait = greedy
				add = 20
			}
			modifier = { 
				has_trait = vengeful
				add = 20
			}
		}
	}
	
	option = { 
		name = maglor_event_chain.0030.b

		
		ai_chance = {
			base = 0
			
			modifier = { 
				has_trait = craven
				add = 10
			}
			modifier = { 
				has_trait = lazy
				add = 10
			}
			modifier = { 
				has_trait = paranoid
				add = 10
			}
		}
	}
}

maglor_event_chain.0031 = { # Spawns armies for Maglor
	hidden = yes
	
	immediate = {
		if = {
			limit = {
				scope:gondor_ruler = { has_title = title:k_belfalas }
			}
			character:linefinwe11 = {
				send_interface_toast = {
					title = maglor_event_chain.0031.event_troops.toast
	
					random_list = {
						1 = {
							spawn_army = {
								name = maglor_event_chain.0031.event_troops
								men_at_arms = {
									type = wardens_tirith_aear
									stacks = 1
								}
								location = root.capital_county.title_province
								origin = scope:gondor_ruler.capital_county.title_province
							}
							spawn_army = {
								name = maglor_event_chain.0031.event_troops
								men_at_arms = {
									type = swan_knights
									stacks = 1
								}
								location = root.capital_county.title_province
								origin = scope:gondor_ruler.capital_county.title_province
							}
						}
						2 = {
							spawn_army = {
								name = maglor_event_chain.0031.event_troops
								levies = 100
								location = root.capital_county.title_province
								origin = scope:gondor_ruler.capital_county.title_province
							}
						}
					}

					random = {
						chance = 50

						if = {
							limit = {
								any_in_global_list = {
									variable = gondorian_ruler_supported_maglor

									this = {
										any_knight = {
											maglor_aggresive_gondorian_knight_trigger = { SAVED_SCOPE = gondor_ruler }
										}
									}
								}
							}
							every_in_global_list = {
								variable = gondorian_ruler_supported_maglor

								random_knight = {
									limit = {
										maglor_aggresive_gondorian_knight_trigger = { SAVED_SCOPE = gondor_ruler }
									}
									set_employer = character:linefinwe11
									add_to_global_variable_list = {
										name = potential_gondorian_governors
										target = this
									}
								}
							}
						}
					}
				}
			}
		}
		else = {
			character:linefinwe11 = {
				send_interface_toast = {
					title = maglor_event_chain.0031.event_troops.toast

					random_list = {
						1 = {
							spawn_army = {
								name = maglor_event_chain.0031.event_troops
								men_at_arms = {
									type = gondorian_footmen
									stacks = 1
								}
								location = root.capital_county.title_province
								origin = scope:gondor_ruler.capital_county.title_province
							}
							spawn_army = {
								name = maglor_event_chain.0031.event_troops
								men_at_arms = {
									type = gondorian_bowmen
									stacks = 1
								}
								location = root.capital_county.title_province
								origin = scope:gondor_ruler.capital_county.title_province
							}
						}
						2 = {
							spawn_army = {
								name = maglor_event_chain.0031.event_troops
								levies = 100
								location = root.capital_county.title_province
								origin = scope:gondor_ruler.capital_county.title_province
							}
						}
					}
					
					random = {
						chance = 33

						if = {
							limit = {
								any_in_global_list = {
									variable = gondorian_ruler_supported_maglor

									any_knight = {
										maglor_aggresive_gondorian_knight_trigger = { SAVED_SCOPE = gondor_ruler }
									}
								}
							}
							every_in_global_list = {
								variable = gondorian_ruler_supported_maglor

								random_knight = {
									limit = {
										maglor_aggresive_gondorian_knight_trigger = { SAVED_SCOPE = gondor_ruler }
									}
									set_employer = character:linefinwe11
									add_to_global_variable_list = {
										name = potential_gondorian_governors
										target = this
									}
								}
							}
						}
					}
				}
			}
		}
	}
}

maglor_event_chain.0032 = { # Starts war against Umbar
	content_source = realms_dlc
	type = character_event
	title = maglor_event_chain.0032.t
	desc = maglor_event_chain.0032.desc
	theme = war
	right_portrait = {
		character = root
		animation = marshal
	}
	override_background = {
		reference = docks_elven
	}
	
	option = { 
		name = maglor_event_chain.0032.a

		if = {
			limit = { exists = title:e_umbar.holder }
			start_war = {
				casus_belli = maglor_umbar_cb
				target = title:e_umbar.holder
				target_title = title:d_umbar
			}
		} else = {
			start_war = {
				casus_belli = maglor_umbar_cb
				target = title:k_umbar.holder
				target_title = title:d_umbar
			}
		}
	}
}

maglor_event_chain.0033 = { # Event if win against Umbar
	content_source = realms_dlc
	type = character_event
	title = maglor_event_chain.0033.t
	desc = maglor_event_chain.0033.desc
	theme = war
	right_portrait = {
		character = root
		animation = marshal
	}
	override_background = {
		reference = docks_adunai
	}
	widgets = {
		widget = {
			gui = "lotr_shader_event_sparks"
			container = "lotr_shader_event_foreground"
		}
		widget = {
			gui = "lotr_shader_event_fire"
			container = "lotr_shader_event_background"
		}
		widget = {
			is_shown = {}
			
			gui = "umbar_maglor_option_select_widget"
			container = "custom_widgets_container"  
			controller = event_chain_progress
		}
	}
	

	immediate = {
		send_interface_toast = {
			title = maglor_event_chain.0033.toast

			add_character_modifier = {
				modifier = warlord_modifier
				years = 15
			}
		}
	}
	
	option = {
		name = maglor_event_chain.0033.a
		set_variable = CB_region_locked
		set_variable = won_against_umbar 
		if = {
			limit = {
				has_variable = appoint_governor
				NOT = { has_variable = raze_umbar } 
			}
			custom_tooltip = "maglor_event_chain.0033.a.event_troops_full.tt"
		}
		else_if = {
			limit = {
				has_variable = appoint_governor
				has_variable = raze_umbar
			}
			custom_tooltip = "maglor_event_chain.0033.a.event_troops_half.tt"
		}
		else = { custom_tooltip = "maglor_event_chain.0033.a.event_troops_none.tt" }
		if = {
			limit = { has_variable = raze_umbar }
			custom_tooltip = "maglor_event_chain.0033.a.upgrade_edhellond.tt"
		}


		if = {
			limit = { has_variable = appoint_governor }
			trigger_event = maglor_event_chain.0034
		}
		if = {
			limit = { has_variable = raze_umbar }
			trigger_event = maglor_event_chain.0036
			upgrade_edhellond_province = yes # Upgrades Edhellond
		}
		else = { trigger_event = maglor_event_chain.0035 }
		
		remove_variable = maglor_umbar_event

		add_prestige = 1000
	}
}

maglor_event_chain.0034 = { # hidden event to appoint governors
	hidden = yes 
	immediate = {
		every_in_global_list = { # Someone from appropriate house that supported Maglor
			variable = gondorian_ruler_supported_maglor
			limit = {
				any_in_global_list = {
					variable = gondorian_ruler_supported_maglor 
					this = prev
				}
			}
			save_temporary_scope_as = gondor_ruler
			dynasty = {
				random_dynasty_member = {
					limit = {
						NOT = {
							any_in_global_list = {
								variable = potential_gondorian_governors 
								this = prev
							}
						}
						is_ruler = no
						is_adult = yes
						NOT = { is_primary_heir_of = scope:gondor_ruler }
					}
					save_temporary_scope_as = new_gondor_ruler
				}
			}
			
			add_to_global_variable_list = {
				name = replacement_governors
				target = scope:new_gondor_ruler
			}
		}

		create_title_and_vassal_change = {
			type = granted
			save_scope_as = title_change
			add_claim_on_loss = no
		}

		title:e_umbar = {
			every_in_de_jure_hierarchy = {
				limit = {
					tier = tier_duchy
					NOT = {
						any_in_de_jure_hierarchy = {
							tier = tier_county
							NOT = { holder ?= character:linefinwe11 }
						}
					}
				}
				add_to_list = duchy_titles_in_umbar
			}
		}

		title:e_umbar = {
			every_in_de_jure_hierarchy = {
				limit = {
					tier = tier_county
					holder ?= character:linefinwe11
					duchy = {
						any_in_de_jure_hierarchy = {
							tier = tier_county
							NOT = { holder ?= character:linefinwe11 }
						}
					}
				}
				add_to_list = county_titles_in_umbar
			}
		}

		every_in_global_list = {
			variable = potential_gondorian_governors
			limit = { is_alive = no }
			remove_list_global_variable = { # Remove knight from available governors
				name = potential_gondorian_governors
				target = this
			}
		}

		while = { # While loop that gives out duchy titles to Gondor knights until list is exhausted
			limit = {
				any_in_global_list = {
					variable = potential_gondorian_governors
					exists = this
				}
			}
			random_in_list = { # Take random duchy to be handed out
				list = duchy_titles_in_umbar
				random_in_global_list = { # Take random gondorian knight to hand duchy too
					variable = potential_gondorian_governors
					limit = { is_alive = yes }
					save_scope_as = new_holder
					add_opinion = {
						modifier = recieved_title
						opinion = 40
						target = character:linefinwe11
					}
					character:linefinwe11 = {
						add_hook = {
							type = loyalty_hook
							target = scope:new_holder
						}
					}
					remove_list_global_variable = { # Remove knight from available governors
						name = potential_gondorian_governors
						target = this
					}
				}
				every_de_jure_county = { # Give every de jure title of duchy to knight
					limit = { de_jure_liege = prev }
					
					change_title_holder = {
						holder = scope:new_holder
						change = scope:title_change
					}
				}
				change_title_holder = {
					holder = scope:new_holder
					change = scope:title_change
				}
				remove_from_list = duchy_titles_in_umbar # Remove current duchy from available duchies
			}
		}

		if = { # Generate some random gondorian rulers
			limit = { any_in_list = { list = duchy_titles_in_umbar } }
			every_in_list = {
				list = duchy_titles_in_umbar
				random_in_global_list = {
					variable = replacement_governors
					save_scope_as = new_holder
					add_opinion = {
						modifier = recieved_title
						opinion = 40
						target = character:linefinwe11
					}
					character:linefinwe11 = {
						add_hook = {
							type = loyalty_hook
							target = scope:new_holder
						}
					}
					remove_list_global_variable = {
						name = replacement_governors
						target = this
					}
				}
				every_de_jure_county = { # Associated county titles
					limit = { de_jure_liege = prev }
					
					change_title_holder = {
						holder = scope:new_holder
						change = scope:title_change
					}
				}
				change_title_holder = {
					holder = scope:new_holder
					change = scope:title_change
				}
			}
		}

		if = { # Generate some random gondorian rulers
			limit = { any_in_list = { list = county_titles_in_umbar } }
			every_in_list = {
				list = county_titles_in_umbar
				random_in_global_list = { # List of Gondorian governors
					variable = replacement_governors
					save_scope_as = new_holder
					add_opinion = {
						modifier = recieved_title
						opinion = 40
						target = character:linefinwe11
					}
					character:linefinwe11 = {
						add_hook = {
							type = loyalty_hook
							target = scope:new_holder
						}
					}
					remove_list_global_variable = {
						name = replacement_governors
						target = this
					}
				}
				change_title_holder = {
					holder = scope:new_holder
					change = scope:title_change
				}
			}
		}
		resolve_title_and_vassal_change = scope:title_change
	}
}

maglor_event_chain.0035 = { # hidden event to recieve all troops from umbar
	hidden = yes 
	
	trigger = {
		trigger_if = {
			limit = { has_variable = maglor_umbar_event_troops }
			var:maglor_umbar_event_troops < 4
		}
	}

	immediate = {
		send_interface_toast = {
			title = maglor_event_chain.0035.toast

			spawn_army = {
				name = elven.umbar_marines
				men_at_arms = {
					type = gondorian_marines
					stacks = 2
				}
				location = root.capital_province
			}
		}

		if = {
			limit = { 
				NOT = { has_variable = maglor_umbar_event_troops }
			}
			set_variable = {
				name = maglor_umbar_event_troops
				value = 1
			}
		}
		else = {
			change_variable = {
				name = maglor_umbar_event_troops
				add = 1
			}
		}

		trigger_event = {
			id = maglor_event_chain.0035
			months = 6
		}
	}
}

maglor_event_chain.0036 = { # hidden event to recieve half troops form umbar
	hidden = yes 
	
	trigger = {
		trigger_if = {
			limit = { has_variable = maglor_umbar_event_troops }
			var:maglor_umbar_event_troops < 4
		}
		sauron_is_alive = yes
	}

	immediate = {
		send_interface_toast = {
			title = maglor_event_chain.0035.toast

			spawn_army = {
				name = elven.umbar_marines
				men_at_arms = {
					type = gondorian_marines
					stacks = 1
				}
				location = root.capital_province
			}
		}

		if = {
			limit = { 
				NOT = { has_variable = maglor_umbar_event_troops }
			}
			set_variable = {
				name = maglor_umbar_event_troops
				value = 1
			}
		}
		else = {
			change_variable = {
				name = maglor_umbar_event_troops
				add = 1
			}
		}

		trigger_event = {
			id = maglor_event_chain.0036
			months = 6
		}
	}
}

maglor_event_chain.0037 = { # Letter event to ask for troops from Gondor Lords
	type = letter_event
	sender = character:linefinwe11

	opening = {
		desc = maglor_event_chain.0037.opening
	}

	desc = maglor_event_chain.0037.desc

	immediate = { save_scope_as = gondor_ruler }

	on_trigger_fail = { #Trigger invitation again if it was blocked because the character was handling another invitation
		trigger_event = {
			id = maglor_event_chain.0037
			days = 1
		}
	}
	
	option = {
		name = maglor_event_chain.0037.a

		character:linefinwe11 = {
			send_interface_toast = {
				title = maglor_event_chain.0037.event_troops.toast

				random_list = {
					1 = {
						spawn_army = {
							name = maglor_event_chain.0037.event_troops
							men_at_arms = {
								type = gondorian_footmen
								stacks = 1
							}
							location = root.capital_province
							origin = scope:gondor_ruler.capital_province
						}
						spawn_army = {
							name = maglor_event_chain.0037.event_troops
							men_at_arms = {
								type = gondorian_bowmen
								stacks = 1
							}
							location = root.capital_province
							origin = scope:gondor_ruler.capital_province
						}
					}
					3 = {
						spawn_army = {
							name = maglor_event_chain.0037.event_troops
							location = root.capital_province
							levies = 100
							origin = scope:gondor_ruler.capital_province
						}
					}
				}
			}
		}
	}
	
	option = {
		name = maglor_event_chain.0037.b
	}
}

maglor_event_chain.0038 = { # Dynasty Rises in Amrun | Demands sent to current Amrun ruler
	content_source = realms_dlc
	type = character_event
	title = maglor_event_chain.0038.t
	desc = maglor_event_chain.0038.desc
	theme = stewardship_duty_focus

	right_portrait = {
		character = root
		animation = personality_proud
	}
	
	left_portrait = {
		character = scope:nadi_manye_leader
		animation = marshal
	}

	immediate = {
		title:c_amrun.holder = { set_variable = maglor_faction }
		# Adding all county tier titles to list
		every_held_title = {
			limit = { tier = tier_county }
			add_to_list = target_titles_county
		}

		# Adding all duchy tier titles to a list (if any exist)
		every_held_title = {	
			limit = { tier = tier_duchy }
			add_to_list = target_titles_duchy
		}

		# Creating Nadi-Manye peasant leader
		create_character = {
			template = maglor_nadi_manye_leader
			location = root.capital_province
			save_scope_as = nadi_manye_leader
		}
		scope:nadi_manye_leader = { set_variable = nadi_manye_war_leader }

		hidden_effect = {
			title:c_amrun = {
				add_county_modifier = {
					modifier = heretic_faction_rose_against_me_modifier
					years = 5
				}
			}
		}
		
	}

	option = { # Give all of your titles to new dynasty
		name = maglor_event_chain.0038.a
		
		create_title_and_vassal_change = {
			type = granted
			save_scope_as = title_change
			add_claim_on_loss = no
		}

		every_in_list = {
			list = target_titles_county
			
			change_title_holder = {
				holder = scope:nadi_manye_leader
				change = scope:title_change
			}
		}
		every_in_list = {
			list = target_titles_duchy
			
			change_title_holder = {
				holder = scope:nadi_manye_leader
				change = scope:title_change
			}
		}
		resolve_title_and_vassal_change = scope:title_change

		character:linefinwe11 = {
			trigger_event = {
				id = maglor_event_chain.0041
				days = { 10 15 }
			} 
		}
	}

	option = { # Give all duchy titles + Amrun away
		trigger = { # Have more than 2 counties
			any_in_list = {
				list = target_titles_county
				count > 1
			}
		}
		
		random_in_list = {
			list = target_titles_county
			limit = {
				NOT = { this = title:c_amrun }
			}
			remove_from_list = target_titles_county
		}

		create_title_and_vassal_change = {
			type = granted
			save_scope_as = title_change
			add_claim_on_loss = no
		}

		every_in_list = {
			list = target_titles_county

			limit = {
				holder = { any_held_title = { count > 1 } }
			}
			change_title_holder = {
				holder = scope:nadi_manye_leader
				change = scope:title_change
			}
		}
		every_in_list = {
			list = target_titles_duchy
			
			change_title_holder = {
				holder = scope:nadi_manye_leader
				change = scope:title_change
			}
		}
		
		change_liege = {
			liege = scope:nadi_manye_leader
			change = scope:title_change
		}
		resolve_title_and_vassal_change = scope:title_change

		character:linefinwe11 = {
			trigger_event = {
				id = maglor_event_chain.0041
				days = { 10 15 }
			} 
		}

		name = maglor_event_chain.0038.b
	}

	option = { # Resist against dynasty
		name = maglor_event_chain.0038.c
		custom_tooltip = {
			text = maglor_event_chain.0038.c.tt
			hidden_effect = {
				title:c_amrun = {
					change_county_control = medium_county_control_loss
					title_create_faction = {
						type = maglor_nadi_manye_faction
						target = title:c_amrun.holder
					}
					holder = {
						every_targeting_faction = {  # go through all existing factions
							if = {
								limit = { any_faction_county_member = { this = title:c_amrun } }
								save_scope_as = amrun_peasant_faction
							}
						}
					}
				}
				scope:amrun_peasant_faction = {
					title:c_amrun = { save_scope_as = peasant_county }
					scope:nadi_manye_leader = { save_scope_as = peasant_leader }
					setup_nadi_manye_leader_effect = yes
					add_faction_discontent = 100
				}
			}
		}
		

		# Make the faction declare war on the person holding c_amrun
		if = {
			limit = { exists = scope:amrun_peasant_faction }
			title:c_amrun = { save_scope_as = peasant_county }
			scope:nadi_manye_leader = { save_scope_as = peasant_leader }

			scope:amrun_peasant_faction = {
				faction_start_war = {}
			
				# This needs to run after 'faction_start_war' or the troops won't spawn correctly.
				faction_spawn_member_county_armies_effect = {
					FACTION = scope:amrun_peasant_faction
					ARMY_OWNER = scope:nadi_manye_leader
					PEASANT_ARMY_NAME = maglor_event_chain.0038.army
				}
			}
		}

		# For use in later events
		scope:nadi_manye_leader = { random_character_war = { save_scope_as = harad_special_war } }

		# Call Maglor to war
		character:linefinwe11 = {
			trigger_event = {
				id = maglor_event_chain.0040
				days = { 5 10 }
			} 
		}
	}

	after = { scope:nadi_manye_leader = { trigger_event = maglor_event_chain.0039 } }
}

maglor_event_chain.0039 = {
	hidden = yes

	immediate = {
		title:c_amrun.holder = { remove_variable = maglor_faction }
		spawn_army = {
			name = maglor_event_chain.0038.army
			men_at_arms = {
				type = desert_javelineers
				stacks = 6
			}
			men_at_arms = {
				type = haradrim_radiers
				stacks = 6
			}
			men_at_arms = {
				type = desert_screamers 
				stacks = 6
			}
			men_at_arms = {
				type = mangonel
				stacks = 8
			}
			location = root.location
		}
	}
}

maglor_event_chain.0040 = { # Maglor gets message to join war with Nadi-Manye rebels
	type = letter_event
	sender = scope:nadi_manye_leader

	opening = {
		desc = maglor_event_chain.0040.opening
	}

	desc = maglor_event_chain.0040.desc


	on_trigger_fail = { #Trigger invitation again if it was blocked because the character was handling another invitation
		trigger_event = {
			id = maglor_event_chain.0040
			days = 1
		}
	}

	option = { # Accept | Join War as attacker
		name = maglor_event_chain.0040.a

		title:c_amrun.holder = {
			every_character_war = {
				limit = {
					primary_defender = title:c_amrun.holder
					any_war_attacker = { has_variable = nadi_manye_war_leader }
				}
				primary_attacker = { set_variable = maglor_joined_war }
				add_attacker = root
			}
		}
		
		ai_chance = {
			base = 100
		}
	}	
	
	option = { # Decline | Decline War
		name = maglor_event_chain.0040.b
		
		ai_chance = {
			base = 0 
		}
	}
}

maglor_event_chain.0041 = { # Maglor gets choice to make Nadi-Manye tributaries
	content_source = realms_dlc
	type = character_event
	title = maglor_event_chain.0041.t
	desc = {
		triggered_desc = {
			trigger = { scope:nadi_manye_leader = { has_variable = nadi_manye_war_leader } }
			desc = maglor_event_chain.0041.desc.1
		}
		triggered_desc = {
			trigger = { scope:nadi_manye_leader = { NOT = { has_variable = nadi_manye_war_leader } } }
			desc = maglor_event_chain.0041.desc.2
		}
	}
	theme = stewardship_duty_focus

	right_portrait = {
		character = root
		animation = personality_bold
	}

	left_portrait = {
		character = scope:nadi_manye_leader
		animation = personality_zealous
	}

	immediate = {
		hidden_effect = {
			scope:nadi_manye_leader = {
				spawn_army = {
					name = maglor_event_chain.0038.army
					men_at_arms = {
						type = desert_javelineers
						stacks = 8
					}
					men_at_arms = {
						type = haradrim_radiers
						stacks = 8
					}
					men_at_arms = {
						type = desert_screamers 
						stacks = 6
					}
					men_at_arms = {
						type = mangonel
						stacks = 5
					}
					location = root.location
				}
			}
		}
	}
	
	option = { # Accept Rebel Leader tributary status
		name = maglor_event_chain.0041.a

		trigger = { NOT = { has_variable = already_good_haruzan } }

		custom_tooltip = maglor_event_chain.0041.a.tt_1
		custom_tooltip = maglor_event_chain.0041.a.tt_2
		make_tributary = {
			TYPE = tributary_permanent
			SUZERAIN = character:linefinwe11
			TRIBUTARY = scope:nadi_manye_leader
		}
		set_variable = nadi_manye_tributary
	}
	option = { # Decline, take resources back to Edhellond
		name = {
			text = maglor_event_chain.0041.b.1
		}
		name = {
			text = maglor_event_chain.0041.b.2
			trigger = { scope:nadi_manye_leader = { has_variable = nadi_manye_war_leader } }
		}

		custom_tooltip = maglor_event_chain.0041.b.tt_1
		province:420 = { elven_settlement_add_building_effect = yes }
	}

	after = {
		trigger_event = maglor_event_chain.0042
	}
}

maglor_event_chain.0042 = { # Toast event to give Maglor Haruzan Event Troops
	hidden = yes

	trigger = {
		trigger_if = {
			limit = { has_variable = maglor_haruzan_event_troops }
			var:maglor_haruzan_event_troops < 6
		}
		sauron_is_alive = yes
	}

	immediate = {
		if = {
			limit = { 
				NOT = { has_variable = maglor_haruzan_event_troops }
			}
			set_variable = {
				name = maglor_umbar_event_troops
				value = 1
			}
		}
		else = {
			change_variable = {
				name = maglor_umbar_event_troops
				add = 1
			}
		}

		send_interface_toast = {
			title = maglor_event_chain.0040.event_troops
			
			if = {
				limit = { has_variable = nadi_manye_tributary }
				random_list = {
					1 = {
						spawn_army = {
							name = maglor_event_chain.0040.event_troops
							men_at_arms = {
								type = desert_javelineers
								stacks = 1
							}
							location = root.capital_province
						}
					}
					1 = {
						spawn_army = {
							name = maglor_event_chain.0040.event_troops
							men_at_arms = {
								type = desert_spearmen
								stacks = 1
							}
							location = root.capital_province
						}
					}
				}
			}
			else = {
				random_list = {
					2 = {
						spawn_army = {
							name = maglor_event_chain.0040.event_troops
							levies = 50
							location = root.capital_province
						}
					}
					1 = {
						spawn_army = {
							name = maglor_event_chain.0040.event_troops
							men_at_arms = {
								type = desert_javelineers
								stacks = 1
							}
							location = root.capital_province
						}
					}
					1 = {
						spawn_army = {
							name = maglor_event_chain.0040.event_troops
							men_at_arms = {
								type = desert_spearmen
								stacks = 1
							}
							location = root.capital_province
						}
					}
				}
			}
		}
	}

	after = {
		trigger_event = {
			id = maglor_event_chain.0042
			days = { 5 15 }
		}
	}
}

### Shield of the Free Peoples ###

maglor_event_chain.0050 = { # Probing investigation into Khazad-dum
	content_source = realms_dlc
	type = character_event
	title = maglor_event_chain.0050.t
	desc = {
		triggered_desc = {
			trigger = { has_title = title:c_ost_in_edhil }
			desc = maglor_event_chain.0050.desc
		}
		desc = maglor_event_chain.0050.fallback_desc
	}
	theme = intrigue

	right_portrait = {
		character = root
		animation = personality_bold
	}

	override_background = {
		reference = durins_door
	}
	
	option = { 
		name = maglor_event_chain.0050.a
		custom_tooltip = maglor_event_chain.0050.a.tt
		trigger_event = {
			id = maglor_event_chain.0052
			days = { 45 60 }
		}
	}
}

maglor_event_chain.0051 = { # Maglor senses the Balrog
	content_source = realms_dlc
	type = character_event
	title = maglor_event_chain.0051.t
	desc = maglor_event_chain.0051.desc
	theme = skull
	right_portrait = {
		character = root
		animation = personality_bold
	}

	override_background = {
		reference = halls
	}

	option = { 
		name = maglor_event_chain.0051.a
		
		set_variable = cannot_cancel_travel
		# destination = title:c_edhellond.title_province
		start_travel_plan = {
			destination = title:c_imladris.title_province
			destination = title:c_hall_of_a_thousand_pillars.title_province
			destination = root.capital_county.title_province
			on_arrival_on_action = maglor_khazad_dum_on_action
			return_trip = no
			players_use_planner = no
			on_arrival_destinations = all
		}
	}
}

maglor_event_chain.0052 = { # Generic event while searching Khazad-dum as Maglor
	content_source = realms_dlc
	type = character_event
	title = maglor_event_chain.0052.t
	desc = maglor_event_chain.0052.desc
	theme = skull
	right_portrait = {
		character = root
		animation = personality_bold
	}

	left_portrait = {
		character = scope:dwarven_leader
		animation = sick
	}

	override_background = {
		reference = halls
	}

	immediate = {
		create_character = {
			template = mag_beard_leader
			location = root.capital_province
			save_scope_as = dwarven_leader
		}

		if = {
			limit = { 
				NOT = { has_variable = searched_khazad_dum }
			}
			set_variable = {
				name = searched_khazad_dum
				value = 1
			}
		}
		else = {
			change_variable = {
				name = searched_khazad_dum
				add = 1
			}
		}
	}

	option = { 
		name = maglor_event_chain.0052.a

		random_list = {
			33 = {	
				custom_tooltip = maglor_event_chain.0052.a.tt.1
				
				send_interface_toast = {
					title = maglor_event_chain.0052.a.tt.1
	
					scope:dwarven_leader = {
						hidden_effect = { set_employer = root }
						set_knight_status = force
					}
				}
			}
			33 = {
				custom_tooltip = maglor_event_chain.0052.a.tt.2
				
				character:linefinwe11 = {
					send_interface_toast = {
						title = maglor_event_chain.0052.event_troops
		
						spawn_army = {
							name = maglor_event_chain.0052.event_troops
							men_at_arms = {
								type = longbeard_heavy_infantry
								stacks = 1
							}
							location = root.capital_province
						}
					}
				}
			}
			33 = {
				custom_tooltip = maglor_event_chain.0052.a.tt.3
				send_interface_toast = {
					title = maglor_event_chain.0052.a.tt.3
	
					title:c_ost_in_edhil = {
						add_county_modifier = {
							modifier = rebuilding_ost_in_edhil
							years = 5
						}
					}
				}
			}
		}
	}

	after = {
		hidden_effect = {
			random_list = {
				20 = {
					modifier = {
						add = {
							value = 20
							multiply = var:searched_khazad_dum
						}
					}
					trigger_event = {
						id = maglor_event_chain.0051
						days = { 10 20 }
					}
				}
				80 = {
					modifier = {
						add = {
							value = -25
							multiply = var:searched_khazad_dum
						}
					}
					trigger_event = {
						id = maglor_event_chain.0052
						days = { 10 20 }
					}
				}
			}
		}
	}
}

maglor_event_chain.0053 = { # Maglor goes to Rivendell to seek Elrond and Glorfindel's aid
	content_source = realms_dlc
	type = character_event
	title = maglor_event_chain.0053.t
	desc = maglor_event_chain.0053.desc
	theme = family
	right_portrait = {
		character = scope:elf_1
		animation = personality_honorable
	}

	left_portrait = {
		character = scope:elf_2
		animation = marshal
	}

	override_background = {
		reference = throne_room
	}

	immediate = {
		if = {
			limit = { character:linefinwe27 = { is_alive = yes } }
			character:linefinwe27 = { save_scope_as = elf_1 }
		}
		else = {
			create_character = {
				template = noldor_feanorian
				employer = title:c_imladris.holder
				save_scope_as = elf_1
			}
		}
		if = {
			limit = { character:lineofglorfindel = { is_alive = yes } }
			character:lineofglorfindel = { save_scope_as = elf_2 }
		}
		else = {
			create_character = {
				template = noldor_feanorian
				employer = title:c_imladris.holder
				save_scope_as = elf_2
			}
		}
		
		root.current_travel_plan ?= {
			add_companion = scope:elf_1
			add_companion = scope:elf_2
		}
	}

	option = { 
		name = maglor_event_chain.0053.a
	}
}

maglor_event_chain.0054  = { # ROYAL COURT EVENT | Elrond recieves Maglor in his court
	content_source = realms_dlc
	type = character_event
	title = maglor_event_chain.0054.t
	desc = maglor_event_chain.0054.desc
	type = court_event
	theme = realm
	override_sound = { reference = event:/SFX/Events/Themes/sfx_event_theme_type_generic }
	court_scene = {
		button_position_character = character:linefinwe11
		court_event_force_open = yes
		show_timeout_info = no
		should_pause_time = yes
		roles = {
			character:linefinwe11 = {
				group = petitioners_group
				animation = happiness
			}
			scope:elf_2 = {
				group = petitioners_group
				animation = happiness
			}
		}
	}
	immediate = {
		if = {
			limit = { character:linefinwe27 = { is_alive = yes } }
			character:linefinwe27 = { save_scope_as = elf_1 }
		}
		else = {
			create_character = {
				template = noldor_feanorian
				employer = title:c_imladris.holder
				save_scope_as = elf_1
			}
		}
		if = {
			limit = { character:lineofglorfindel = { is_alive = yes } }
			character:lineofglorfindel = { save_scope_as = elf_2 }
		}
		else = {
			create_character = {
				template = noldor_feanorian
				employer = title:c_imladris.holder
				save_scope_as = elf_2
			}
		}
		
		root.current_travel_plan ?= {
			add_companion = scope:elf_1
			add_companion = scope:elf_2
		}
	}
	option = { # Go with Maglor to face Balrog
		name = maglor_event_chain.0054.a
		character:linefinwe11 = { set_variable = elrond_on_journey }
		ai_chance = {
			base = 100
		}
	}
	option = { # Choose to send another elf
		name = maglor_event_chain.0054.b
		create_character = {
			template = noldor_feanorian
			employer = title:c_imladris.holder
			save_scope_as = elf_1
		}
		current_travel_plan = { save_scope_as = travel_to_balrog }
		scope:travel_to_balrog = { add_companion = scope:elf_1 }
		start_travel_plan = {
			destination = capital_province
			return_trip = no
			players_use_planner = no
			save_scope_as = return_trip
		}

		ai_chance = {
			base = 0
		}
	}
}

maglor_event_chain.0055 = { # NON-ROYAL COURT EVENT | Elrond recieves Maglor in his court
	content_source = realms_dlc
	type = character_event
	title = maglor_event_chain.0054.t
	desc = maglor_event_chain.0054.desc
	type = court_event
	theme = realm
	override_sound = { reference = event:/SFX/Events/Themes/sfx_event_theme_type_generic }
	immediate = {
		create_character = {
			template = noldor_feanorian
			employer = title:c_imladris.holder
			save_scope_as = elf_1
		}
	}
	option = { # Go with Maglor to face Balrog
		name = maglor_event_chain.0054.a
		character:linefinwe11 = { set_variable = elrond_on_journey }
		ai_chance = {
			base = 100
		}
	}
	option = { # Choose to send another elf
		name = maglor_event_chain.0054.b
		current_travel_plan = { save_scope_as = travel_to_balrog }
		scope:travel_to_balrog = { add_companion = scope:elf_1 }
		start_travel_plan = {
			destination = capital_province
			return_trip = no
			players_use_planner = no
			save_scope_as = return_trip
		}
		ai_chance = {
			base = 0
		}
	}
}

maglor_event_chain.0056 = { # Fight Balrog
	content_source = realms_dlc
	type = character_event
	window = fullscreen_event_with_portrait # tour_arrival_event
	title = maglor_event_chain.0056.t
	desc = maglor_event_chain.0056.desc
	theme = stewardship_duty_focus

	right_portrait = {
		character = root
		animation = aggressive_sword
		camera = camera_event_right_wedding
	}

	left_portrait = {
		character = scope:portrait_elf
		animation = aggressive_spear
		camera = camera_event_left_wedding
	}

	override_background = {
		reference = durins_bane
	}

	immediate = {
		current_travel_plan ?= {
			every_entourage_character = {
				limit = { is_elf = yes }
				add_to_list = elf_characters
				root = { add_to_list = elf_characters }

				if = {
					limit = {
						this = character:lineofglorfindel
					}
					this = { save_scope_as = portrait_elf }
				}
			}
			if = {
				limit = { NOT = { exists = scope:portrait_elf } } 
				random_entourage_character = {
					limit = { is_elf = yes }
					save_scope_as = portrait_elf
				}
			}
		}
	}

	option = { 
		name = maglor_event_chain.0056.a
		if = {
			limit = {
				AND = {
					any_in_list = {
						list = elf_characters
						this = character:linefinwe27
					}
					any_in_list = {
						list = elf_characters
						this = character:lineofglorfindel
					}
				}
			}
			random_list = { # Both Elrond AND Glorfindel joined Maglor
				90 = { # Wins against a Balrog
					maglor_wins_balrog = yes
					set_global_variable = maglor_killed_balrog
				}
				10 = { # Loses against a Balrog
					every_in_list = {
						list = elf_characters
						death = { death_reason = death_durins_bane }
					}
				}
			}
			title:c_ost_in_edhil.holder = {
				trigger_event = {
					id = maglor_event_chain.0058
					days = 1
				}
			}
		}
		else_if = {
			limit = {
				OR = {
					AND = {
						any_in_list = {
							list = elf_characters
							this = character:linefinwe27
						}
						NOT = {
							any_in_list = {
								list = elf_characters
								this = character:lineofglorfindel
							}
						}
					}
					AND = {
						any_in_list = {
							list = elf_characters
							this = character:lineofglorfindel
						}
						NOT = {
							any_in_list = {
								list = elf_characters
								this = character:linefinwe27
							}
						}
					}
				}
			}
			random_list = { # Either Elrod OR Glorfindel joined Maglor
				70 = { # Wins against a Balrog
					maglor_wins_balrog = yes
				}
				30 = { # Loses against a Balrog 
					every_in_list = {
						list = elf_characters
						death = { death_reason = death_durins_bane }
					}
				}
			}
			title:c_ost_in_edhil.holder = {
				trigger_event = {
					id = maglor_event_chain.0058
					days = 1
				}
			}
		}
		else = {
			random_list = { # Elrond/Glorfindel didn't join Maglor
				50 = { # Wins against a Balrog
					maglor_wins_balrog = yes
				}
				50 = { # Loses against a Balrog
					every_in_list = {
						list = elf_characters
						death = { death_reason = death_durins_bane }
					}
				}
			}
			title:c_ost_in_edhil.holder = {
				trigger_event = {
					id = maglor_event_chain.0058
					days = 1
				}
			}
		}

		add_prestige = 1250
		add_piety = 750
	}

	after = {
		remove_variable = searched_khazad_dum
		if = {
			limit = { has_variable = elrond_on_journey }
			trigger_event = {
				id = maglor_event_chain.0059
				days = { 15 30 }
			}
			remove_variable = elrond_on_journey
		}
	}
}

maglor_event_chain.0057 = { # Hidden Event to recieve dwarven troops
	hidden = yes 

	trigger = {
		trigger_if = {
			limit = { has_variable = maglor_khazad_dum_event_troops }
			var:maglor_khazad_dum_event_troops < 6
		}
		sauron_is_alive = yes
	}

	immediate = {
		increase_variable = {
			NAME = maglor_khazad_dum_event_troops
			AMOUNT = 1
		}

		send_interface_toast = {
			title = maglor_event_chain.0057.toast

			if = { # Longbeard
				limit = {
					OR = {
						title:k_khazad_dum.holder.culture = culture:longbeards
						title:k_khazad_dum.holder.culture = { any_parent_culture_or_above = { this = culture:longbeards } }
						title:k_khazad_dum.holder.culture = culture:iron_hills
						title:k_khazad_dum.holder.culture = { any_parent_culture_or_above = { this = culture:iron_hills } }
					}
					title:k_khazad_dum.holder = { is_dwarf = yes }
				}
				random_list = {
					1 = { # Special Longbeard unit
						spawn_army = {
							name = maglor_event_chain.0057.toast
							men_at_arms = {
								type = longbeard_horse_archers
								stacks = 1
							}
							location = root.capital_province
						}
					}
					5 = { # Skirmishers
						spawn_army = {
							name = maglor_event_chain.0057.toast
							men_at_arms = {
								type = longbeard_skirmishers
								stacks = 1
							}
							location = root.capital_province
						}
					}
					5 = { # Archers
						spawn_army = {
							name = maglor_event_chain.0057.toast
							men_at_arms = {
								type = longbeard_crossbowmen
								stacks = 1
							}
							location = root.capital_province
						}
					}
					5 = { # Heavy Infantry
						spawn_army = {
							name = maglor_event_chain.0057.toast
							men_at_arms = {
								type = longbeard_heavy_infantry
								stacks = 1
							}
							location = root.capital_province
						}
					}
					5 = { # Pikemen
						spawn_army = {
							name = maglor_event_chain.0057.toast
							men_at_arms = {
								type = longbeard_pikemen
								stacks = 1
							}
							location = root.capital_province
						}
					}
				}
			}
			else_if = { # Broadbeam
				limit = {
					OR = {
						title:k_khazad_dum.holder.culture = culture:broadbeams
						title:k_khazad_dum.holder.culture = { any_parent_culture_or_above = { this = culture:broadbeams } }
					}
					title:k_khazad_dum.holder = { is_dwarf = yes }
				}
				random_list = {
					1 = { # Special Firebeard unit
						spawn_army = {
							name = maglor_event_chain.0057.toast
							men_at_arms = {
								type = firebeard_monsters
								stacks = 1
							}
							location = root.capital_province
						}
					}
					5 = { # Skirmishers
						spawn_army = {
							name = maglor_event_chain.0057.toast
							men_at_arms = {
								type = firebeard_skirmishers
								stacks = 1
							}
							location = root.capital_province
						}
					}
					5 = { # Archers
						spawn_army = {
							name = maglor_event_chain.0057.toast
							men_at_arms = {
								type = firebeard_archers
								stacks = 1
							}
							location = root.capital_province
						}
					}
					5 = { # Heavy Infantry
						spawn_army = {
						name = maglor_event_chain.0057.toast
							men_at_arms = {
								type = firebeard_heavy_infantry
								stacks = 1
							}
							location = root.capital_province
						}
					}
					5 = { # Pikemen
						spawn_army = {
							name = maglor_event_chain.0057.toast
							men_at_arms = {
								type = firebeard_pikemen
								stacks = 1
							}
							location = root.capital_province
						}
					}
				}
			}
			else_if = { # Firebeard
				limit = {
					OR = {
						title:k_khazad_dum.holder.culture = culture:firebeards
						title:k_khazad_dum.holder.culture = { any_parent_culture_or_above = { this = culture:firebeards } }
					}
					title:k_khazad_dum.holder = { is_dwarf = yes }
				}
				random_list = {
					1 = { # Special Firebeard unit
						spawn_army = {
							name = maglor_event_chain.0057.toast
							men_at_arms = {
								type = firebeard_monsters
								stacks = 1
							}
							location = root.capital_province
						}
					}
					5 = { # Skirmishers
						spawn_army = {
							name = maglor_event_chain.0057.toast
							men_at_arms = {
								type = firebeard_skirmishers
								stacks = 1
							}
							location = root.capital_province
						}
					}
					5 = { # Archers
						spawn_army = {
							name = maglor_event_chain.0057.toast
							men_at_arms = {
								type = firebeard_archers
								stacks = 1
							}
							location = root.capital_province
						}
					}
					5 = { # Heavy Infantry
						spawn_army = {
						name = maglor_event_chain.0057.toast
							men_at_arms = {
								type = firebeard_heavy_infantry
								stacks = 1
							}
							location = root.capital_province
						}
					}
					5 = { # Pikemen
						spawn_army = {
							name = maglor_event_chain.0057.toast
							men_at_arms = {
								type = firebeard_pikemen
								stacks = 1
							}
							location = root.capital_province
						}
					}
				}
			}
			else_if = { # Blacklock
				limit = {
					OR = {
						title:k_khazad_dum.holder.culture = culture:blacklocks_nargubraz
						title:k_khazad_dum.holder.culture = { any_parent_culture_or_above = { this = culture:blacklocks_nargubraz } }
						title:k_khazad_dum.holder.culture = culture:blacklocks
						title:k_khazad_dum.holder.culture = { any_parent_culture_or_above = { this = culture:blacklocks } }
					}
					title:k_khazad_dum.holder = { is_dwarf = yes }
				}
				random_list = {
					1 = { # Special Firebeard unit
						spawn_army = {
							name = maglor_event_chain.0057.toast
							men_at_arms = {
								type = blacklock_engineers
								stacks = 1
							}
							location = root.capital_province
						}
					}
					5 = { # Skirmishers
						spawn_army = {
							name = maglor_event_chain.0057.toast
							men_at_arms = {
								type = blacklock_skirmishers
								stacks = 1
							}
							location = root.capital_province
						}
					}
					5 = { # Archers
						spawn_army = {
							name = maglor_event_chain.0057.toast
							men_at_arms = {
								type = blacklock_crossbowmen
								stacks = 1
							}
							location = root.capital_province
						}
					}
					5 = { # Heavy Infantry
						spawn_army = {
						name = maglor_event_chain.0057.toast
							men_at_arms = {
								type = blacklock_heavy_infantry
								stacks = 1
							}
							location = root.capital_province
						}
					}
					5 = { # Pikemen
						spawn_army = {
							name = maglor_event_chain.0057.toast
							men_at_arms = {
								type = blacklock_pikemen
								stacks = 1
							}
							location = root.capital_province
						}
					}
				}
			}
			else_if = { # Stiffbeard
				limit = {
					OR = {
						title:k_khazad_dum.holder.culture = culture:stiffbeards
						title:k_khazad_dum.holder.culture = { any_parent_culture_or_above = { this = culture:stiffbeards } }
					}
					title:k_khazad_dum.holder = { is_dwarf = yes }
				}
				random_list = {
					5 = { # Skirmishers
						spawn_army = {
							name = maglor_event_chain.0057.toast
							men_at_arms = {
								type = stiffbeard_skirmishers
								stacks = 1
							}
							location = root.capital_province
						}
					}
					5 = { # Archers
						spawn_army = {
							name = maglor_event_chain.0057.toast
							men_at_arms = {
								type = stiffbeard_crossbowmen
								stacks = 1
							}
							location = root.capital_province
						}
					}
					5 = { # Heavy Infantry
						spawn_army = {
						name = maglor_event_chain.0057.toast
							men_at_arms = {
								type = stiffbeard_heavy_infantry
								stacks = 1
							}
							location = root.capital_province
						}
					}
					5 = { # Pikemen
						spawn_army = {
							name = maglor_event_chain.0057.toast
							men_at_arms = {
								type = stiffbeard_pikemen
								stacks = 1
							}
							location = root.capital_province
						}
					}
				}
			}
			
			trigger_event = {
				id = maglor_event_chain.0057
				days = { 60 120 }
			}
		}
	}
}

maglor_event_chain.0058 = { # Event if Maglor dies
	hidden = yes

	immediate = {
		if = {
			limit = { 
				character:linefinwe11 = { is_alive = no }
			}
			create_title_and_vassal_change = {
				type = swear_fealty
				save_scope_as = change
			}
			title:c_ost_in_edhil.holder = { 
				change_liege = {
					liege = title:k_imladris.holder
					change = scope:change
				}
			}
			resolve_title_and_vassal_change = scope:change
		}
	}
}

maglor_event_chain.0059 = { # Recieve Noldor elves from Rivendell
	hidden = yes

	trigger = {
		trigger_if = {
			limit = { has_variable = rivendell_troops }
			var:rivendell_troops < 4
		}
		sauron_is_alive = yes
	}

	immediate = {
		increase_variable = {
			NAME = rivendell_troops
			AMOUNT = 1
		}
		
		send_interface_toast = {
			title = maglor_event_chain.0059.toast
			random_list = {
				1 = {
					spawn_army = {
						name = maglor_event_chain.0059.toast
						men_at_arms = {
							type = high_elven_heavy_infantry
							stacks = 1
						}
						location = root.capital_county.title_province
						origin = scope:gondor_ruler.capital_county.title_province
					}
				}
				1 = {
					spawn_army = {
						name = maglor_event_chain.0059.toast
						men_at_arms = {
							type = high_elven_archers
							stacks = 1
						}
						location = root.capital_county.title_province
						origin = scope:gondor_ruler.capital_county.title_province
					}
				}
				1 = {
					spawn_army = {
						name = maglor_event_chain.0059.toast
						men_at_arms = {
							type = high_elven_heavy_cavalry
							stacks = 1
						}
						location = root.capital_county.title_province
						origin = scope:gondor_ruler.capital_county.title_province
					}
				}
				1 = {
					spawn_army = {
						name = maglor_event_chain.0059.toast
						men_at_arms = {
							type = noldor_veterans
							stacks = 1
						}
						location = root.capital_county.title_province
						origin = scope:gondor_ruler.capital_county.title_province
					}
				}
				1 = {
					spawn_army = {
						name = maglor_event_chain.0059.toast
						men_at_arms = {
							type = noldor_cavalry
							stacks = 1
						}
						location = root.capital_county.title_province
						origin = scope:gondor_ruler.capital_county.title_province
					}
				}
			}
		}

		trigger_event = {
			id = maglor_event_chain.0062
			days = { 10 20 }
		}
	}
}

maglor_event_chain.0060 = { # Event to highlight CB unlocked
	content_source = realms_dlc
	type = character_event
	title = maglor_event_chain.0060.t
	desc = maglor_event_chain.0060.desc
	theme = realm
	override_sound = { reference = event:/SFX/Events/Themes/sfx_event_theme_type_generic }
	immediate = {
		create_character = {
			template = noldor_feanorian
			employer = title:c_imladris.holder
			save_scope_as = elf_1
		}
		
		remove_variable = cannot_cancel_travel
	}
	option = { 
		name = maglor_event_chain.0060.a

		ai_chance = {
			base = 100
		}
	}
}

maglor_event_chain.0061 = { # Event to give Lothlorien/Lasgalen elf Amon Lanc
	content_source = realms_dlc
	type = character_event
	title = maglor_event_chain.0061.t
	desc = maglor_event_chain.0061.desc
	theme = realm

	override_sound = { reference = event:/SFX/Events/Themes/sfx_event_theme_type_generic }

	right_portrait = {
		character = title:k_lasgalen.holder
		animation = personality_bold
	}

	left_portrait = {
		character = title:k_lothlorien.holder
		animation = personality_honorable
	}

	immediate = {
		title:k_amon_lanc = {
			every_de_jure_county = {
				limit = { holder = root }
				add_to_list = titles_in_amon_lanc

				if = {
					limit = {
						exists = duchy.holder
						NOT = {
							any_in_list = {
								list = duchy_titles_in_amon_lanc
								this = prev.duchy
							}
						}
					}
					duchy = { add_to_list = duchy_titles_in_amon_lanc }
				}
			}
		}
	}

	option = { # Give lands to Lothlorien ruler
		name = maglor_event_chain.0061.a
		custom_tooltip = {
			text = maglor_event_chain.0061.a.tt
			every_in_list = {
				list = titles_in_amon_lanc
				limit = { holder = root }
				give_amon_lanc_to_elf = { TITLE = this HOLDER = title:k_lothlorien.holder }
			}
			every_in_list = {
				list = duchy_titles_in_amon_lanc
				holder = { destroy_title = prev }
			}
		}
		
		title:k_lothlorien.holder = {
			add_opinion = {
				modifier = respect_opinion
				target = root 
				opinion = 30
			}
		}
		title:k_lasgalen.holder = {
			add_opinion = {
				modifier = disappointed_opinion
				target = root 
				opinion = -15
			}
		}

		set_variable = lothlorien_given_title

		ai_chance = { base = 50 }
	}
	option = { # Give lands to Lasgalen ruler
		name = maglor_event_chain.0061.b
		custom_tooltip = {
			text = maglor_event_chain.0061.b.tt
			every_in_list = {
				list = titles_in_amon_lanc
				limit = { holder = root }
				give_amon_lanc_to_elf = { TITLE = this HOLDER = title:k_lasgalen.holder }
			}
			every_in_list = {
				list = duchy_titles_in_amon_lanc
				holder = { destroy_title = prev }
			}
		}
		title:k_lasgalen.holder = {
			add_opinion = {
				modifier = respect_opinion
				target = root
				opinion = 30
			}
		}
		title:k_lothlorien.holder = {
			add_opinion = {
				modifier = disappointed_opinion
				target = root 
				opinion = -15
			}
		}

		set_variable = lasgalen_given_title

		ai_chance = { base = 50 }
	}

	option = { # keep lands to self
		name = maglor_event_chain.0061.c
		custom_tooltip = maglor_event_chain.0061.c.tt

		title:k_lasgalen.holder = {
			add_opinion = {
				modifier = disappointed_opinion
				target = root 
				opinion = -15
			}
		}

		title:k_lothlorien.holder = {
			add_opinion = {
				modifier = disappointed_opinion
				target = root 
				opinion = -15
			}
		}

		set_variable = kept_amon_lanc

		ai_chance = { base = 0 }
	}

	after = {
		if = {
			limit = { 
				OR = {
					has_variable = lothlorien_given_title
					has_variable = lasgalen_given_title
				}
			}
			trigger_event = maglor_event_chain.0062
		}
	}
}

maglor_event_chain.0062 = { # Hidden event to give elven MaA event troops to Maglor
	hidden = yes

	trigger = {
		trigger_if = {
			limit = { has_variable = amon_lanc_troops }
			var:amon_lanc_troops < 7
		}
		sauron_is_alive = yes
	}

	immediate = {
		increase_variable = {
			NAME = amon_lanc_troops
			AMOUNT = 1
		}

		if = {
			limit = { has_variable = lothlorien_given_title }
			random_list = {
				1 = {
					spawn_army = {
						name = maglor_event_chain.0059.lothlorien
						men_at_arms = {
							type = high_elven_heavy_infantry
							stacks = 1
						}
						location = root.capital_county.title_province
						origin = scope:gondor_ruler.capital_county.title_province
					}
				}
				1 = {
					spawn_army = {
						name = maglor_event_chain.0059.lothlorien
						men_at_arms = {
							type = high_elven_heavy_cavalry
							stacks = 1
						}
						location = root.capital_county.title_province
						origin = scope:gondor_ruler.capital_county.title_province
					}
				}
				1 = {
					spawn_army = {
						name = maglor_event_chain.0059.lothlorien
						men_at_arms = {
							type = grey_elven_pikemen
							stacks = 1
						}
						location = root.capital_county.title_province
						origin = scope:gondor_ruler.capital_county.title_province
					}
				}
				1 = {
					spawn_army = {
						name = maglor_event_chain.0059.lothlorien
						men_at_arms = {
							type = galadhrim_archers
							stacks = 1
						}
						location = root.capital_county.title_province
						origin = scope:gondor_ruler.capital_county.title_province
					}
				}
				1 = {
					spawn_army = {
						name = maglor_event_chain.0059.lothlorien
						men_at_arms = {
							type = grey_elven_heavy_cavalry
							stacks = 1
						}
						location = root.capital_county.title_province
						origin = scope:gondor_ruler.capital_county.title_province
					}
				}
			}
		}
		else_if = {
			limit = { has_variable = lasgalen_given_title }
			random_list = {
				1 = {
					spawn_army = {
						name = maglor_event_chain.0059.lasgalen
						men_at_arms = {
							type = high_elven_archers
							stacks = 1
						}
						location = root.capital_county.title_province
						origin = scope:gondor_ruler.capital_county.title_province
					}
				}
				1 = {
					spawn_army = {
						name = maglor_event_chain.0059.lasgalen
						men_at_arms = {
							type = grey_elven_heavy_cavalry
							stacks = 1
						}
						location = root.capital_county.title_province
						origin = scope:gondor_ruler.capital_county.title_province
					}
				}
				1 = {
					spawn_army = {
						name = maglor_event_chain.0059.lasgalen
						men_at_arms = {
							type = grey_elven_archers
							stacks = 1
						}
						location = root.capital_county.title_province
						origin = scope:gondor_ruler.capital_county.title_province
					}
				}
				1 = {
					spawn_army = {
						name = maglor_event_chain.0059.lasgalen
						men_at_arms = {
							type = grey_elven_pikemen
							stacks = 1
						}
						location = root.capital_county.title_province
						origin = scope:gondor_ruler.capital_county.title_province
					}
				}
				1 = {
					spawn_army = {
						name = maglor_event_chain.0059.lasgalen
						men_at_arms = {
							type = royal_elk_riders
							stacks = 1
						}
						location = root.capital_county.title_province
						origin = scope:gondor_ruler.capital_county.title_province
					}
				}
				1 = {
					spawn_army = {
						name = maglor_event_chain.0059.lasgalen
						men_at_arms = {
							type = theladagnyr
							stacks = 1
						}
						location = root.capital_county.title_province
						origin = scope:gondor_ruler.capital_county.title_province
					}
				}
			}
		}

		trigger_event = {
			id = maglor_event_chain.0062
			days = { 15 30 }
		}
	}
}

maglor_event_chain.0063 = { # Call in members of northern alliance into destroy Mordor  war
	content_source = realms_dlc
	type = character_event
	title = maglor_event_chain.0063.t
	desc = maglor_event_chain.0063.desc
	theme = realm
	override_sound = { reference = event:/SFX/Events/Themes/sfx_event_theme_type_generic }
	right_portrait = {
		character = title:k_lasgalen.holder
		animation = personality_bold
		trigger = { exists = title:k_lasgalen.holder }
	}
	left_portrait = {
		character = title:k_lothlorien.holder
		animation = personality_honorable
		trigger = { exists = title:k_lothlorien.holder }
	}
	lower_center_portrait = {
		character = title:k_khazad_dum.holder
		animation = personality_honorable
		trigger = { exists = title:k_khazad_dum.holder }
	}

	immediate = {
		if = {
			limit = { exists = title:k_lasgalen.holder }
			title:k_lasgalen.holder = { add_to_list = northern_alliance }
		}
		if = {
			limit = { exists = title:k_lothlorien.holder }
			title:k_lothlorien.holder = { add_to_list = northern_alliance }
		}
		if = {
			limit = { exists = title:k_khazad_dum.holder }
			title:k_khazad_dum.holder = { add_to_list = northern_alliance }
		}
	}

	option = {
		name = maglor_event_chain.0063.a

		# if = {
		# 	limit = {
		# 		is_target_in_global_variable_list = {
		# 			name = unavailable_unique_decisions
		# 			target = flag:decision_annihilate_dol_guldur
		# 		}
		# 	}
		# }

		every_in_list = {
			list = northern_alliance 
			save_temporary_scope_as = current_char
			root = {
				random_character_war = {
					limit = { using_cb = final_battle_maglor_cb }
					add_attacker = scope:current_char
				}
			}
			
		}
	}
}

maglor_event_chain.0064 = { # Maglor sends letter to Gondor to ask for help
	content_source = realms_dlc
	type = character_event
	title = maglor_event_chain.0064.t
	desc = maglor_event_chain.0064.desc
	theme = realm

	right_portrait = {
		character = root
		animation = personality_bold
	}

	left_portrait = {
		character = scope:gondor_ruler
		animation = personality_honorable
	}

	immediate = {
		if = {
			limit = { exists = title:e_gondor_steward.holder }
			title:e_gondor_steward.holder = { save_scope_as = gondor_ruler }
		}
		else_if = {
			limit = { exists = title:e_gondor.holder }
			title:e_gondor.holder = { save_scope_as = gondor_ruler }
		}
		else_if = {
			limit = { exists = title:e_reunitedkingdom.holder }
			title:e_reunitedkingdom.holder = { save_scope_as = gondor_ruler }
		}
	}

	option = { # Seek help from Gondor
		name = maglor_event_chain.0064.a

		scope:gondor_ruler = { trigger_event = maglor_event_chain.0065 }

		ai_chance = {
			base = 1 
		}
	}

	option = { # We can do it on our own
		name = maglor_event_chain.0064.b

		ai_chance = {
			base = 0
		}
	}
}

maglor_event_chain.0065 = { # Receive a letter to join Maglor in war against Sauron
	type = letter_event
	sender = character:linefinwe11

	opening = {
		desc = maglor_event_chain.0065.t
	}

	desc = maglor_event_chain.0065.desc

	on_trigger_fail = { #Trigger invitation again if it was blocked because the character was handling another invitation
		trigger_event = {
			id = maglor_event_chain.0065
			days = 1
		}	
	}

	option = { # Join Maglor in his war
		name = maglor_event_chain.0065.a

		character:linefinwe11 = {
			random_character_war = {
				limit = { using_cb = final_battle_maglor_cb }
				add_attacker = root
			}
		}

		ai_chance = {
			base = 1 
		}
	}

	option = { # Refuse to join war
		name = maglor_event_chain.0065.b

		ai_chance = {
			base = 0
		}
	}
}

maglor_event_chain.0066 = { # Event to notify of clearing high pass
	content_source = realms_dlc
	type = character_event
	title = maglor_event_chain.0066.t
	desc = maglor_event_chain.0066.desc
	theme = realm

	right_portrait = {
		character = root
		animation = personality_bold
	}

	left_portrait = {
		character = title:d_carrock_vale.holder
		animation = personality_honorable
	}

	option = {
		name = maglor_event_chain.0066.a

		trigger_event = maglor_event_chain.0067
	}
}

maglor_event_chain.0067 = { # Hidden event to recieve Beorning event MaA
	hidden = yes

	trigger = {
		trigger_if = {
			limit = { has_variable = beorning_event_troops }
			var:beorning_event_troops < 9
		}
		sauron_is_alive = yes
	}

	immediate = {
		increase_variable = { NAME = beorning_event_troops	AMOUNT = 1 }

		send_interface_toast = {
			title = maglor_event_chain.0024.toast

			random_list = {
				1 = { # Vale MaA unit
					spawn_army = {
						name = maglor_event_chain.0067.toast
						men_at_arms = {
							type = vale_nenedain_pikemen
							stacks = 1
						}
						location = root.capital_province
					}
				}
				1 = { # Vale MaA unit
					spawn_army = {
						name = maglor_event_chain.0067.toast
						men_at_arms = {
							type = woodmen_huntsmen
							stacks = 1
						}
						location = root.capital_province
					}
				}
				1 = { # Vale MaA unit
					spawn_army = {
						name = maglor_event_chain.0067.toast
						men_at_arms = {
							type = woodmen_widulingas
							stacks = 1
						}
						location = root.capital_province
					}
				}
			}
		}

		trigger_event = {
			id = maglor_event_chain.0067
			days = { 60 90 }
		}
	}
}

maglor_event_chain.0068 = { # Sauron is attacked by Maglor
	content_source = realms_dlc
	type = character_event
	title = maglor_event_chain.0068.t
	desc = maglor_event_chain.0068.desc
	theme = realm

	right_portrait = {
		character = root
		animation = personality_bold
	}

	left_portrait = {
		character = character:linefinwe11
		animation = aggressive_sword
	}

	option = { name = maglor_event_chain.0068.a }
}

maglor_event_chain.0069 = { # First Song Battle Event between Maglor/Sauron
	content_source = realms_dlc
	type = character_event
	title = maglor_event_chain.0069.t
	desc = maglor_event_chain.0069.desc
	theme = realm
	window = duel_event

	left_portrait = {
		character = character:linefinwe11
		scripted_animation = duel_wield_weapon
		outfit_tags = { elven_war }
	}
	right_portrait = {
		character = character:lineofsauron
		scripted_animation = duel_wield_weapon
		outfit_tags = { vasa }
	}

	override_background = { reference = throne_room_sauron }

	widgets = {
		widget = {
			gui = "lotr_shader_event_sparks"
			container = "lotr_shader_event_foreground"
		}
	}

	immediate = {
		play_music_cue = lotr_cue_sauron
	}

	option = {
		name = maglor_event_chain.0069.a

		trigger_event = maglor_event_chain.0070
	}

}

maglor_event_chain.0070 = { # Second Song Battle Event between Maglor/Sauron
	content_source = realms_dlc
	type = character_event
	title = maglor_event_chain.0070.t
	desc = maglor_event_chain.0070.desc
	theme = realm
	window = duel_event

	left_portrait = {
		character = character:linefinwe11
		scripted_animation = duel_wield_weapon
		outfit_tags = { elven_war }
	}
	right_portrait = {
		character = character:lineofsauron
		scripted_animation = duel_wield_weapon
		outfit_tags = { vasa }
	}

	override_background = { reference = barad_dur }
	
	widgets = {
		widget = {
			gui = "lotr_shader_event_sparks"
			container = "lotr_shader_event_foreground"
		}
	}

	option = {
		name = maglor_event_chain.0070.a
		
		trigger_event = maglor_event_chain.0071
	}
}

maglor_event_chain.0071 = { # Third Song Battle Event between Maglor/Sauron
	content_source = realms_dlc
	type = character_event
	title = maglor_event_chain.0071.t
	desc = maglor_event_chain.0071.desc
	theme = realm
	window = duel_event

	left_portrait = {
		character = character:linefinwe11
		scripted_animation = duel_wield_weapon
		outfit_tags = { elven_war }
	}
	right_portrait = {
		character = character:lineofsauron
		scripted_animation = duel_wield_weapon
		outfit_tags = { vasa }
	}
	
	override_background = { reference = barad_dur }
	
	widgets = {
		widget = {
			gui = "lotr_shader_event_sparks"
			container = "lotr_shader_event_foreground"
		}
	}

	option = {
		name = maglor_event_chain.0071.a
		if = { # Last Flame of Fëanor | Achievement
			limit = { 
				NOT = { exists = global_var:lotr_achievement_80 }
				is_ai = no
			}
			set_global_variable = lotr_achievement_80
		}

		character:lineofsauron = {
			show_as_tooltip = {
				death = {
					killer = character:linefinwe11
					death_reason = death_duel
				}
			}
		}
		kill_nazgul_effect = yes

		if = {
			limit = { root = character:linefinwe11 }
			character:linefinwe11 = { trigger_event = maglor_event_chain.0072 }
		}
	}
}

maglor_event_chain.0072 = { # Maglor receives Saurons palantir/relics when he wins the song battle
	hidden = yes

	immediate = {
		character:lineofsauron = {
			every_character_artifact = {
				limit = { 
					OR = {
						has_variable = palantir 
						has_variable = relic
					}
				}
				set_owner = {
					target = root
					history = {
						type = inherited
						recipient = root
					}
				}
			}
			death = { death_reason = death_sauron }
		}
		trigger_event = {
			id = maglor_event_chain.0073
			months = { 1 2 }
		}
	}
}

maglor_event_chain.0073 = { # Maglor recieives event to go back to Himring
	content_source = realms_dlc
	type = character_event
	title = maglor_event_chain.0073.t
	desc = maglor_event_chain.0073.desc
	theme = realm

	left_portrait = {
		character = root
		animation = personality_proud
	}

	option = { # Stay, continouing personal conquest
		name = maglor_event_chain.0073.a

		set_variable = unlock_retire_to_himring_decision
	}

	option = { # Retire to Himring
		name = maglor_event_chain.0073.b

		if = {
			limit = { has_variable = maglor_defensive }
			trigger_event = maglor_event_chain.0073
		}
		else_if = {
			limit = { has_variable = maglor_aggresive }
			trigger_event = maglor_event_chain.0074
		}
	}
}

maglor_event_chain.0073 = { # Travels back to Himring
	hidden = yes

	immediate = {
		every_in_list = {
			list = target_titles
			remove_from_list = target_titles
		}
		every_in_list = {
			list = attackers
			remove_from_list = attackers
		}
		every_in_list = {
			list = defenders
			remove_from_list = defenders
		}

		give_back_himring = yes

		# Create elf to inherit titles
		create_character = {
			template = noldor_feanorian
			employer = root
			save_scope_as = elf_1
		}

		# Add all personally held titles to list
		every_held_title = {
			limit = {
				tier = tier_county
				NOR = {
					de_jure_liege = title:e_orrostar
					de_jure_liege.de_jure_liege = title:e_orrostar
					de_jure_liege.de_jure_liege.de_jure_liege = title:e_orrostar
					this = title:c_edhellond
					this = title:c_himring
				}
			}
			add_to_list = targeted_titles
		}

		create_title_and_vassal_change = {
			type = granted
			save_scope_as = change
			add_claim_on_loss = no
		}

		every_in_list = {
			list = targeted_titles

			change_title_holder = {
				holder = scope:elf_1
				change = scope:change
			}
		}
		resolve_title_and_vassal_change = scope:change

		### Freeing every vassal
		every_vassal = {
			limit = { 
				NOT = {
					any_held_title = {
						OR = {
							de_jure_liege = title:e_orrostar
							de_jure_liege.de_jure_liege = title:e_orrostar
							de_jure_liege.de_jure_liege.de_jure_liege = title:e_orrostar
							this = title:c_edhellond
						}
					}
				}
			}
			add_to_list = targeted_vassals
		}

		create_title_and_vassal_change = {
			type = independency
			save_scope_as = change
			add_claim_on_loss = no
		}
		every_in_list = {
			list = targeted_vassals
			becomes_independent = { change = scope:change }
		}
		resolve_title_and_vassal_change = scope:change
		
		start_travel_plan = {
			destination = title:c_himring.title_province
			on_arrival_event = maglor_event_chain.0075
			return_trip = no
			players_use_planner = no
			on_arrival_destinations = last
		}
		add_truce_both_ways = { 
			character = character:lineofcirdan
			years = 3
			name = TRUCE_GRANT_INDEPENDENCE
		}
		set_variable = cannot_cancel_travel
	}
}

maglor_event_chain.0074 = { # Travels back to Himring
	hidden = yes

	immediate = {
		give_back_himring = yes

		# Create elf to inherit titles
		create_character = {
			template = noldor_feanorian
			employer = root
			save_scope_as = elf_1
		}

		# Add all personally held titles to list
		every_held_title = {
			limit = {
				tier = tier_county
				NOR = {
					de_jure_liege = title:e_orrostar
					de_jure_liege.de_jure_liege = title:e_orrostar
					de_jure_liege.de_jure_liege.de_jure_liege = title:e_orrostar
					this = title:c_edhellond
					this = title:c_himring
				}
			}
			add_to_list = targeted_titles
		}

		create_title_and_vassal_change = {
			type = granted
			save_scope_as = change
			add_claim_on_loss = no
		}

		every_in_list = {
			list = targeted_titles

			change_title_holder = {
				holder = scope:elf_1
				change = scope:change
			}
		}
		resolve_title_and_vassal_change = scope:change

		### Freeing every vassal
		every_vassal = {
			limit = { 
				NOT = {
					any_held_title = {
						OR = {
							de_jure_liege = title:e_orrostar
							de_jure_liege.de_jure_liege = title:e_orrostar
							de_jure_liege.de_jure_liege.de_jure_liege = title:e_orrostar
							this = title:c_edhellond
						}
					}
				}
				is_human = yes
				faith_is_good = yes
			}
			add_to_list = human_vassals
		}

		create_title_and_vassal_change = {
			type = granted
			save_scope_as = change
			add_claim_on_loss = no
		}
		every_in_list = {
			list = human_vassals
			change_liege = {
				liege = title:c_minas_tirith.holder
				change = scope:change
			}
		}
		resolve_title_and_vassal_change = scope:change

		
		### Freeing every vassal
		every_vassal = {
			limit = { 
				NOT = {
					any_held_title = {
						OR = {
							de_jure_liege = title:e_orrostar
							de_jure_liege.de_jure_liege = title:e_orrostar
							de_jure_liege.de_jure_liege.de_jure_liege = title:e_orrostar
							this = title:c_edhellond
						}
					}
				}
			}
			add_to_list = vassals
		}

		create_title_and_vassal_change = {
			type = independency
			save_scope_as = change
			add_claim_on_loss = no
		}
		every_in_list = {
			list = vassals
			becomes_independent = { change = scope:change }
		}
		resolve_title_and_vassal_change = scope:change
		
		start_travel_plan = {
			destination = title:c_himring.title_province
			on_arrival_event = maglor_event_chain.0075
			return_trip = no
			players_use_planner = no
			on_arrival_destinations = last
		}
		add_truce_both_ways = { 
			character = character:lineofcirdan
			years = 3
			name = TRUCE_GRANT_INDEPENDENCE
		}
		set_variable = cannot_cancel_travel
	}
}

maglor_event_chain.0075 = { # DUN DUN DUN, Maglor recieves Silmaril
	content_source = realms_dlc
	type = character_event
	title = maglor_event_chain.0075.t
	desc = maglor_event_chain.0075.desc
	theme = realm

	override_background = { reference = ulmo }

	left_portrait = {
		character = root
		animation = shame
	}

	artifact = {
		position = lower_right_portrait
		target = scope:newly_created_artifact
		trigger = { exists = scope:newly_created_artifact }
	}

	immediate = {
		if = {
			limit = { has_variable = cannot_cancel_travel }
			remove_variable = cannot_cancel_travel
		}
		set_realm_capital = title:c_himring
		create_artifact_silmaril_effect = { OWNER = root }
	}

	option = {
		name = maglor_event_chain.0075.a
		remove_character_modifier = valar_ban_modifier
		trigger_event = maglor_event_chain.0076
	}
}

maglor_event_chain.0076 = { # DUN DUN DUN, Maglor recieves Silmaril
	content_source = realms_dlc
	type = character_event
	title = maglor_event_chain.0076.t
	desc = maglor_event_chain.0076.desc
	theme = realm

	override_background = { reference = ulmo }

	left_portrait = {
		character = root
		animation = shame
	}

	artifact = {
		position = lower_right_portrait
		target = scope:silmaril_artifact
		trigger = { exists = scope:silmaril_artifact }
	}

	immediate = {
		random_equipped_character_artifact = {
			limit = { has_variable = silmaril }
			save_scope_as = silmaril_artifact
		}
	}

	option = {
		name = maglor_event_chain.0076.a
	}
}