namespace = pledge_loyalty_to_liege


scripted_effect grant_legitimacy_from_unique_house_pledges_effect = {
	if = {
		limit = {
			NOT = {
				has_variable_list = loyalty_pledged_powerful_dominant_houses
				is_target_in_variable_list = {
	 				name = loyalty_pledged_powerful_dominant_houses
	   				target = scope:pledge_loyalty_to_liege_vassal.house
	   			}
			}
		}
		add_legitimacy = scope:pledge_loyalty_to_liege_vassal.pledge_loyalty_to_liege_grant_legitimacy_value
		add_to_variable_list = {
	 		name = loyalty_pledged_powerful_dominant_houses
	   		target = scope:pledge_loyalty_to_liege_vassal.house
		}
	}
}

scripted_effect pledge_loyalty_to_liege_clear_variable_effect = {
	current_travel_plan ?= {
		if = {
			limit = { is_paused = yes }
			resume_travel_plan = yes
		}
	}
	# Always
	if = {
		limit = { has_variable = homage_type }
		remove_variable = homage_type
	}
	# Contract
	if = {
		limit = { has_variable = pledge_loyalty_to_liege_contract_type }
		remove_variable = pledge_loyalty_to_liege_contract_type
	}
	# Liege
	if = {
		limit = { has_variable = pledge_loyalty_to_liege_scope }
		remove_variable = pledge_loyalty_to_liege_scope
	}
}

pledge_loyalty_to_liege.9000 = {
	hidden = yes
	immediate = {
		var:pledge_loyalty_to_liege_scope = {
			save_scope_as = pledge_loyalty_to_liege_scope
		}
		if = {
			limit = {
				scope:pledge_loyalty_to_liege_scope ?= {
					OR = {
						is_alive = no
						is_imprisoned = yes
					}
				}
			}
			send_interface_toast = {
				title = pledge_loyalty_to_liege_costs_refunded
				left_icon = root
				# Remove variable preventing you from Pledging Loyalty to your liege again
				if = {
					limit = {
						has_variable = pledge_loyalty_to_liege_grace
						exists = liege
						var:pledge_loyalty_to_liege_grace = liege
					}
					remove_variable = pledge_loyalty_to_liege_grace
				}
				# refund any costs
				if = {
					limit = {
						has_variable = pledge_loyalty_to_liege_gold_value
					}
					add_gold = var:pledge_loyalty_to_liege_gold_value
				}
			}
			trigger_event = pledge_loyalty_to_liege.0601
		}
		else_if = {
			limit = {
				scope:pledge_loyalty_to_liege_vassal.var:homage_type = flag:pledge_loyalty_to_liege_submission
			}
			liege = {
				add_opinion = {
			 		target = scope:pledge_loyalty_to_liege_vassal
			 		modifier = pledged_loyalty_to_me_opinion
			 		opinion = 10
			 	}
				send_interface_toast = {
					type = msg_pledged_loyalty_to_liege
					left_icon = this
					right_icon = scope:pledge_loyalty_to_liege_subject
					grant_legitimacy_from_unique_house_pledges_effect = yes
					custom_tooltip = msg_pledged_loyalty_to_liege.liege.desc
				}
			}
			send_interface_toast = {
				type = msg_pledged_loyalty_to_liege
				left_icon = this
				right_icon = liege
				custom_tooltip = msg_pledged_loyalty_to_liege.subject.desc
			}
			pledge_loyalty_to_liege_clear_variable_effect = yes
			current_travel_plan ?= {
				delay_travel_plan = { days = 14 }
			}
		}
		else = {
			liege = {
				trigger_event = pledge_loyalty_to_liege.0001
			}
			current_travel_plan ?= {
				delay_travel_plan = { days = 90 }
			}
		}
	}
}

scripted_trigger pledge_loyalty_to_liege_valid_trigger = { # Pledging Loyalty is still valid
	is_alive = yes
	is_imprisoned = no
	liege ?= var:pledge_loyalty_to_liege_scope
	var:pledge_loyalty_to_liege_scope = {
		is_alive = yes
		is_imprisoned = no
		has_royal_court = yes
	}
}

scripted_effect pledge_loyalty_to_liege_0001_refused_effect = {
	scope:pledge_loyalty_to_liege_scope = {
		add_prestige = minor_prestige_loss
		add_tyranny = petition_liege_refusal_tyranny_value
	}
	scope:pledge_loyalty_to_liege_vassal = {
		add_opinion = {
			modifier = refusal_opinion
			target = scope:pledge_loyalty_to_liege_scope
			opinion = -20
		}
		progress_towards_rival_effect = {
			CHARACTER = scope:pledge_loyalty_to_liege_scope
			REASON = rival_refuse_homage
			OPINION = default_rival_opinion
		}
	}
}

# Vassal arrives with offerings, not just a formal loyalty pledge
pledge_loyalty_to_liege.0001 = {
	type = letter_event
	opening = pledge_loyalty_to_liege.0001.opening
	desc = {
		desc = pledge_loyalty_to_liege.0001.desc
		first_valid = {
		    triggered_desc = {
		        trigger = { scope:pledge_loyalty_to_liege_vassal.var:homage_type = flag:pledge_loyalty_to_liege_gold }
		        desc = pledge_loyalty_to_liege.0001.desc.gold
		    }
		    triggered_desc = {
		        trigger = { scope:pledge_loyalty_to_liege_vassal.var:homage_type = flag:pledge_loyalty_to_liege_hook }
		        desc = pledge_loyalty_to_liege.0001.desc.hook
		    }
		    desc = pledge_loyalty_to_liege.0001.desc.submission
		}
	}
	sender = scope:pledge_loyalty_to_liege_vassal

	trigger ={
		scope:pledge_loyalty_to_liege_vassal = {
			is_alive = yes
			is_imprisoned = no
		}
	}

	on_trigger_fail = {
		scope:pledge_loyalty_to_liege_vassal = {
			if = {
				limit = { is_alive = no }
				trigger_event = pledge_loyalty_to_liege.9000
			}
		}
	}

	immediate = {
		grant_legitimacy_from_unique_house_pledges_effect = yes
	}

	option = {
		name = pledge_loyalty_to_liege.0001.a
		if = {
			limit = { scope:pledge_loyalty_to_liege_vassal.var:homage_type = flag:pledge_loyalty_to_liege_gold }
			save_scope_value_as = {
				name = pledge_loyalty_to_liege_gifts_received
				value = {
					value = scope:pledge_loyalty_to_liege_vassal.medium_gold_value
					divide = 2
				}
			}
			show_as_tooltip = {
				add_gold = scope:pledge_loyalty_to_liege_gifts_received
				scope:pledge_loyalty_to_liege_vassal = {
					add_gold = scope:pledge_loyalty_to_liege_gifts_received
				}
			}
		}
		else_if = {
			limit = { scope:pledge_loyalty_to_liege_vassal.var:homage_type = flag:pledge_loyalty_to_liege_hook }
			show_as_tooltip = {
				add_hook = {
					type = favor_hook
					target = scope:pledge_loyalty_to_liege_vassal
				}
			}
		}
		else_if = {
			limit = { scope:pledge_loyalty_to_liege_vassal.var:homage_type = flag:pledge_loyalty_to_liege_contract }
			scope:pledge_loyalty_to_liege_vassal = {
				if = {
					limit = { var:pledge_loyalty_to_liege_contract_type = 0 }
					vassal_contract_increase_obligation_level = feudal_government_levies
				}
				else = { vassal_contract_increase_obligation_level = feudal_government_taxes }
			}
		}
		scope:pledge_loyalty_to_liege_scope = { trigger_event = pledge_loyalty_to_liege.0101 }
		ai_chance = {
			base = 100
			ai_value_modifier = {
				ai_rationality = 0.5
			}
		}
	}

	option = {
		name = pledge_loyalty_to_liege.0001.b
		if = {
			limit = { scope:pledge_loyalty_to_liege_vassal.var:homage_type = flag:pledge_loyalty_to_liege_gold }
			save_scope_value_as = {
				name = pledge_loyalty_to_liege_gifts_received
				value = -1 # Received nothing in return
			}
			show_as_tooltip = {
				add_gold = scope:pledge_loyalty_to_liege_vassal.medium_gold_value
				scope:pledge_loyalty_to_liege_vassal = {
					add_opinion = {
						target = scope:pledge_loyalty_to_liege_scope
						modifier = insulted_opinion
					}
				}
			}
		}
		else_if = {
			limit = { scope:pledge_loyalty_to_liege_vassal.var:homage_type = flag:pledge_loyalty_to_liege_hook }
			show_as_tooltip = {
				add_hook = {
					type = favor_hook
					target = scope:pledge_loyalty_to_liege_vassal
				}
			}
		}
		else_if = {
			limit = { scope:pledge_loyalty_to_liege_vassal.var:homage_type = flag:pledge_loyalty_to_liege_contract }
			scope:pledge_loyalty_to_liege_vassal = {
				if = {
					limit = { var:pledge_loyalty_to_liege_contract_type = 0 }
					vassal_contract_increase_obligation_level = feudal_government_levies
				}
				else = { vassal_contract_increase_obligation_level = feudal_government_taxes }
			}
		}
		add_legitimacy = {
			value = pledge_loyalty_to_liege_grant_legitimacy_value
			subtract = 2
			multiply = -1
		}
		scope:pledge_loyalty_to_liege_scope = { trigger_event = pledge_loyalty_to_liege.0101 }
		stress_impact = {
			greedy = minor_stress_impact_loss
			generous = minor_stress_impact_gain
		}
		ai_chance = {
			base = 0
			ai_value_modifier = {
				ai_greed = 0.5
				ai_honor = 0.5
			}
			modifier = {
				add = 20
				gold < scope:pledge_loyalty_to_liege_vassal.medium_gold_value
			}
			modifier = {
				add = 40
				has_relation_rival = scope:pledge_loyalty_to_liege_vassal
			}
		}
	}

	option = {
		name = pledge_loyalty_to_liege.0001.c
		if = {
			limit = { scope:pledge_loyalty_to_liege_vassal.var:homage_type = flag:pledge_loyalty_to_liege_gold }
			save_scope_value_as = {
				name = pledge_loyalty_to_liege_gifts_received
				value = {
					value = scope:pledge_loyalty_to_liege_vassal.medium_gold_value
					multiply = 2
				}
			}
			show_as_tooltip = {
				remove_short_term_gold = scope:pledge_loyalty_to_liege_vassal.medium_gold_value
				grant_legitimacy_from_unique_house_pledges_effect = yes
				scope:pledge_loyalty_to_liege_vassal = {
					add_gold = scope:pledge_loyalty_to_liege_gifts_received
					if = {
						limit = {
							opinion = {
								target = liege
								value < -30
							}
						}
						custom_tooltip = pledge_loyalty_to_liege.0001.c.insulted
						add_opinion = {
							target = scope:pledge_loyalty_to_liege_scope
							modifier = insulted_opinion
						}
					}
					else_if = {
						limit = {
							opinion = {
								target = liege
								value > 30
							}
						}
						custom_tooltip = pledge_loyalty_to_liege.0001.c.honored
						add_opinion = {
							target = scope:pledge_loyalty_to_liege_scope
							modifier = honored_me_opinion
						}
					}
					else = {
						random_list = {
							1 = {
								add_opinion = {
									target = scope:pledge_loyalty_to_liege_scope
									modifier = honored_me_opinion
								}
							}
							1 = {
								add_opinion = {
									target = scope:pledge_loyalty_to_liege_scope
									modifier = insulted_opinion
								}
							}
						}
					}
				}
			}
		}
		else_if = {
			limit = { scope:pledge_loyalty_to_liege_vassal.var:homage_type = flag:pledge_loyalty_to_liege_hook }
			show_as_tooltip = {
				add_hook = {
					type = favor_hook
					target = scope:pledge_loyalty_to_liege_vassal
				}
			}
		}
		else_if = {
			limit = { scope:pledge_loyalty_to_liege_vassal.var:homage_type = flag:pledge_loyalty_to_liege_contract }
			scope:pledge_loyalty_to_liege_vassal = {
				if = {
					limit = { var:pledge_loyalty_to_liege_contract_type = 0 }
					vassal_contract_increase_obligation_level = feudal_government_levies
				}
				else = { vassal_contract_increase_obligation_level = feudal_government_taxes }
			}
		}
		scope:pledge_loyalty_to_liege_scope = { trigger_event = pledge_loyalty_to_liege.0101 }
		stress_impact = {
			greedy = medium_stress_impact_gain
			generous = medium_stress_impact_loss
		}
		ai_chance = {
			base = 0
			ai_value_modifier = {
				ai_greed = -0.5
				ai_boldness = 0.25
			}
			modifier = {
				add = 20
				legitimacy_level < 3
			}
			modifier = {
				factor = 0
				gold < scope:pledge_loyalty_to_liege_vassal.gold
				gold < scope:pledge_loyalty_to_liege_vassal.medium_gold_value
			}
		}
	}
}

pledge_loyalty_to_liege.0009 = {
	type = letter_event
	opening = pledge_loyalty_to_liege.0009.opening
	desc = pledge_loyalty_to_liege.0009.desc
	sender = scope:pledge_loyalty_to_liege_scope

	trigger = { pledge_loyalty_to_liege_valid_trigger = yes }

	immediate = {
		show_as_tooltip = { pledge_loyalty_to_liege_0001_refused_effect = yes }
		if = {
			limit = { has_variable = pledge_loyalty_to_liege_contract_type }
			hidden_effect = { set_vassal_contract_modification_blocked = no }
		}
	}

	option = {
		name = pledge_loyalty_to_liege.0009.a
		if = {
			limit = { var:homage_type = flag:pledge_loyalty_to_liege_gold }
			add_gold = medium_gold_value
		}
	}

	after = { pledge_loyalty_to_liege_clear_variable_effect = yes }
}

scripted_effect pledge_loyalty_to_liege_liege_reward_effect = {
	scope:pledge_loyalty_to_liege_scope = {
		add_prestige = miniscule_prestige_gain
		if = { # Give hook
			limit = { scope:pledge_loyalty_to_liege_vassal.var:homage_type = flag:pledge_loyalty_to_liege_hook }
			add_hook = {
				type = favor_hook
				target = scope:pledge_loyalty_to_liege_vassal
			}
		}
		else_if = { # Increase lowest contract
			limit = { scope:pledge_loyalty_to_liege_vassal.var:homage_type = flag:pledge_loyalty_to_liege_contract }
			scope:pledge_loyalty_to_liege_vassal = {
				if = {
					limit = { var:pledge_loyalty_to_liege_contract_type = 0 }
					vassal_contract_increase_obligation_level = feudal_government_levies
				}
				else = { vassal_contract_increase_obligation_level = feudal_government_taxes }
			}
		}
	}
}

scripted_effect pledge_loyalty_to_liege_vassal_reward_effect = {
	scope:pledge_loyalty_to_liege_vassal = {
		if = {
			limit = { scope:pledge_loyalty_to_liege_gifts_received > 0 } # Ensures we don't add negative gold in case the liege refused any gifts in-kind
			add_gold = scope:pledge_loyalty_to_liege_gifts_received
		}

		if = {
			limit = { var:homage_type = flag:pledge_loyalty_to_liege_contract }
			if = {
				limit = {
					scope:pledge_loyalty_to_liege_scope = { is_ai = yes }
				}
				reverse_add_opinion = {
					target = scope:pledge_loyalty_to_liege_scope
					modifier = respect_opinion
					opinion = 10
				}
				add_prestige = minor_prestige_gain
			}
		}
		pledge_loyalty_to_liege_clear_variable_effect = yes
	}
}

scripted_effect pledge_loyalty_to_liege_nickname_toast_effect = {
	scope:pledge_loyalty_to_liege_vassal = {
		send_interface_toast = {
			title = msg_gain_nickname
			left_icon = scope:pledge_loyalty_to_liege_vassal
			right_icon = scope:pledge_loyalty_to_liege_scope
			scope:pledge_loyalty_to_liege_vassal = { give_nickname = nick_$NICKNAME$ }
		}
	}
	scope:pledge_loyalty_to_liege_scope = {
		send_interface_toast = {
			title = msg_gain_nickname
			left_icon = scope:pledge_loyalty_to_liege_vassal
			right_icon = scope:pledge_loyalty_to_liege_scope
			show_as_tooltip = {
				scope:pledge_loyalty_to_liege_vassal = { give_nickname = nick_$NICKNAME$ }
			}
		}
	}
}

# Liege recieves homagee
pledge_loyalty_to_liege.0101 = {
	type = character_event # to avoid too much in the court for ruler
	title = pledge_loyalty_to_liege.0101.t
	desc = {
		desc = pledge_loyalty_to_liege.0101.desc
		first_valid = {
			triggered_desc = {
				trigger = { scope:pledge_loyalty_to_liege_vassal.var:homage_type = flag:pledge_loyalty_to_liege_submission }
				desc = pledge_loyalty_to_liege.0101.desc.submission
			}
			triggered_desc = {
				trigger = { scope:pledge_loyalty_to_liege_vassal.var:homage_type = flag:pledge_loyalty_to_liege_gold }
				desc = pledge_loyalty_to_liege.0101.desc.gold
			}
			triggered_desc = {
				trigger = { scope:pledge_loyalty_to_liege_vassal.var:homage_type = flag:pledge_loyalty_to_liege_hook }
				desc = pledge_loyalty_to_liege.0101.desc.hook
			}
			triggered_desc = {
				trigger = { scope:pledge_loyalty_to_liege_vassal.var:homage_type = flag:pledge_loyalty_to_liege_contract }
				desc = pledge_loyalty_to_liege.0101.desc.contract
			}
		}
		desc = pledge_loyalty_to_liege.0101.desc.success
	}
	theme = realm
	override_sound = { reference = "event:/SFX/Events/Themes/sfx_event_theme_type_duty" }
	left_portrait = {
		character = scope:pledge_loyalty_to_liege_scope
		animation = acknowledging
	}
	right_portrait = {
		character = scope:pledge_loyalty_to_liege_vassal
		triggered_animation = {
			trigger = { "opinion(liege)" > 0 }
			animation = personality_honorable
		}
		animation = personality_dishonorable
	}

	trigger ={
		scope:pledge_loyalty_to_liege_vassal = {
			is_alive = yes
			is_imprisoned = no
		}
	}

	option = {
		name = {
			trigger = { scope:pledge_loyalty_to_liege_vassal.var:homage_type = flag:pledge_loyalty_to_liege_submission }
			text = pledge_loyalty_to_liege.0101.smooth.submission
		}
		name = {
			trigger = { scope:pledge_loyalty_to_liege_vassal.var:homage_type = flag:pledge_loyalty_to_liege_gold }
			text = pledge_loyalty_to_liege.0101.smooth.gold
		}
		name = {
			trigger = { scope:pledge_loyalty_to_liege_vassal.var:homage_type = flag:pledge_loyalty_to_liege_hook }
			text = pledge_loyalty_to_liege.0101.smooth.hook
		}
		name = {
			trigger = { scope:pledge_loyalty_to_liege_vassal.var:homage_type = flag:pledge_loyalty_to_liege_contract }
			text = pledge_loyalty_to_liege.0101.smooth.contract
		}
		show_as_tooltip = {
			scope:pledge_loyalty_to_liege_vassal = { add_prestige = minor_prestige_gain }
		}
	}

	after = {
		pledge_loyalty_to_liege_liege_reward_effect = yes
		scope:pledge_loyalty_to_liege_vassal = { trigger_event = pledge_loyalty_to_liege.0201 }
	}
}

# Vassal learns of result (end)
pledge_loyalty_to_liege.0201 = {
	type = court_event
	title = pledge_loyalty_to_liege.0201.t
	desc = {
		desc = pledge_loyalty_to_liege.0201.desc
		first_valid = {
			triggered_desc = {
				trigger = { scope:pledge_loyalty_to_liege_vassal.var:homage_type = flag:pledge_loyalty_to_liege_submission }
				desc = pledge_loyalty_to_liege.0201.desc.submission
			}
			triggered_desc = {
				trigger = { scope:pledge_loyalty_to_liege_vassal.var:homage_type = flag:pledge_loyalty_to_liege_gold }
				desc = {
					desc = pledge_loyalty_to_liege.0201.desc.gold
					triggered_desc = {
						trigger = { scope:pledge_loyalty_to_liege_gifts_received < 0 }
						desc = pledge_loyalty_to_liege.0201.desc.gold.received_nothing
					}
					triggered_desc = {
						trigger = { scope:pledge_loyalty_to_liege_gifts_received > medium_gold_value }
						desc = pledge_loyalty_to_liege.0201.desc.gold.received_more
					}
					triggered_desc = {
						trigger = {
							scope:pledge_loyalty_to_liege_gifts_received > 0
							scope:pledge_loyalty_to_liege_gifts_received < medium_gold_value
						}
						desc = pledge_loyalty_to_liege.0201.desc.gold.received_as_expected
					}
				}
			}
			triggered_desc = {
				trigger = { scope:pledge_loyalty_to_liege_vassal.var:homage_type = flag:pledge_loyalty_to_liege_hook }
				desc = pledge_loyalty_to_liege.0201.desc.hook
			}
			triggered_desc = {
				trigger = { scope:pledge_loyalty_to_liege_vassal.var:homage_type = flag:pledge_loyalty_to_liege_contract }
				desc = pledge_loyalty_to_liege.0201.desc.contract
			}
		}
		desc = pledge_loyalty_to_liege.0201.desc.outro
	}
	theme = realm
	override_sound = { reference = "event:/SFX/Events/Themes/sfx_event_theme_type_duty" }
	court_scene = {
		button_position_character = scope:pledge_loyalty_to_liege_scope
		court_owner = scope:pledge_loyalty_to_liege_scope
		show_timeout_info = no
		roles = {
		    scope:pledge_loyalty_to_liege_vassal = {
				group = petitioners_group
				animation = seiza
		    }
		}
	}

	trigger = { pledge_loyalty_to_liege_valid_trigger = yes }

	immediate = {
		scope:pledge_loyalty_to_liege_scope = {
			open_view_data = {
				view = royal_court
				secondary_actor = scope:pledge_loyalty_to_liege_vassal
				player = scope:pledge_loyalty_to_liege_vassal
			}
		}
		show_as_tooltip = {
			if = {
				limit = { var:homage_type = flag:pledge_loyalty_to_liege_gold }
				scope:pledge_loyalty_to_liege_scope = { add_gold = scope:pledge_loyalty_to_liege_vassal.medium_gold_value }
			}
			else_if = {
				limit = { var:homage_type = flag:pledge_loyalty_to_liege_hook }
				scope:pledge_loyalty_to_liege_scope = {
					add_hook = {
						type = favor_hook
						target = scope:pledge_loyalty_to_liege_vassal
					}
				}
			}
			else_if = {
				limit = { var:homage_type = flag:pledge_loyalty_to_liege_contract }
				if = {
					limit = { var:pledge_loyalty_to_liege_contract_type = 0 }
					vassal_contract_increase_obligation_level = feudal_government_levies
				}
				else = { vassal_contract_increase_obligation_level = feudal_government_taxes }
			}
		}
	}

	option = { # Smooth
		name = {
			trigger = { scope:pledge_loyalty_to_liege_vassal.var:homage_type = flag:pledge_loyalty_to_liege_submission }
			text = pledge_loyalty_to_liege.0201.smooth.submission
		}
		name = {
			trigger = { scope:pledge_loyalty_to_liege_vassal.var:homage_type = flag:pledge_loyalty_to_liege_gold }
			text = pledge_loyalty_to_liege.0201.smooth.gold
		}
		name = {
			trigger = { scope:pledge_loyalty_to_liege_vassal.var:homage_type = flag:pledge_loyalty_to_liege_hook }
			text = pledge_loyalty_to_liege.0201.smooth.hook
		}
		name = {
			trigger = { scope:pledge_loyalty_to_liege_vassal.var:homage_type = flag:pledge_loyalty_to_liege_contract }
			text = pledge_loyalty_to_liege.0201.smooth.contract
		}
	}

	after = {
		pledge_loyalty_to_liege_vassal_reward_effect = yes
		close_view = {
			view = royal_court
		    player = scope:pledge_loyalty_to_liege_vassal
		}
	}
}

# No longer available
pledge_loyalty_to_liege.0601 = {
	type = character_event
	title = pledge_loyalty_to_liege.0601.t
	desc = {
		first_valid = {
			triggered_desc = {
				trigger = { has_royal_court = yes }
				desc = pledge_loyalty_to_liege.0601.desc.court
			}
			triggered_desc = {
				trigger = { is_imprisoned = yes }
				desc = pledge_loyalty_to_liege.0601.desc.imprisoned
			}
			triggered_desc = {
				trigger = {
					scope:pledge_loyalty_to_liege_scope = {
						is_alive = no
						exists = killer
						killer = root
					}
				}
				desc = pledge_loyalty_to_liege.0601.desc.liege_dead_me
			}
			triggered_desc = {
				trigger = {
					scope:pledge_loyalty_to_liege_scope = { is_alive = no }
				}
				desc = pledge_loyalty_to_liege.0601.desc.liege_dead
			}
			triggered_desc = {
				trigger = {
					scope:pledge_loyalty_to_liege_scope = {
						is_imprisoned = yes
						exists = imprisoner
						imprisoner = root
					}
				}
				desc = pledge_loyalty_to_liege.0601.desc.liege_imprisoned_me
			}
			triggered_desc = {
				trigger = {
					scope:pledge_loyalty_to_liege_scope = { is_imprisoned = yes }
				}
				desc = pledge_loyalty_to_liege.0601.desc.liege_imprisoned
			}
		}
		triggered_desc = {
			trigger = {
				exists = liege
				NOR = {
					liege = root
					liege = scope:pledge_loyalty_to_liege_scope
				}
			}
			desc = pledge_loyalty_to_liege.0601.desc.new_liege
		}
		triggered_desc = {
			trigger = {
				scope:pledge_loyalty_to_liege_scope = { is_alive = yes }
				exists = liege
				NOT = { liege = root }
			}
			desc = pledge_loyalty_to_liege.0601.desc
		}
	}
	theme = realm
	left_portrait = {
		character = scope:pledge_loyalty_to_liege_scope
		triggered_animation = {
			trigger = { is_imprisoned = yes }
			animation = prisondungeon
		}
		triggered_animation = {
			trigger = { is_alive = no }
			animation = idle
		}
		triggered_animation = {
			trigger = { is_available = no }
			animation = dismissal
		}
	}
	right_portrait = {
		character = liege
		trigger = {
			NOT = { liege = scope:pledge_loyalty_to_liege_scope }
		}
		animation = idle
	}

	trigger = { pledge_loyalty_to_liege_valid_trigger = no }

	immediate = {
		# Transfer the variable to a scope for loc & such.
		var:pledge_loyalty_to_liege_scope ?= { save_scope_as = pledge_loyalty_to_liege }
	}

	option = {
		name = {
			text = pledge_loyalty_to_liege.0601.a_court
			trigger = { has_royal_court = yes }
		}
		name = {
			text = pledge_loyalty_to_liege.0601.a_prison
			trigger = { is_imprisoned = yes }
		}
		name = {
			text = pledge_loyalty_to_liege.0601.a_liege
			trigger = {
				scope:pledge_loyalty_to_liege_scope = {
					is_alive = yes
					is_imprisoned = no
				}
			}
		}
		name = {
			text = pledge_loyalty_to_liege.0601.a
			trigger = { always = yes }
		}
	}

	after = { pledge_loyalty_to_liege_clear_variable_effect = yes }
}


namespace = pledge_loyalty_to_liege_overdue

# Event for a liege to force characters to bow to them if they haven't already
pledge_loyalty_to_liege_overdue.1000 = {
	type = character_event
	title = pledge_loyalty_to_liege_overdue.1000.t
	desc = {
		desc = pledge_loyalty_to_liege_overdue.1000.desc.1
		triggered_desc = {
			trigger = {
				scope:pledge_loyalty_to_liege_offender = {
					any_owned_story = {
						type = story_cycle_pledge_loyalty_to_liege_overdue
						has_variable = new_liege_variant
					}
				}
			}
			desc = pledge_loyalty_to_liege_overdue.1000.desc.new_liege
		}
		triggered_desc = {
			trigger = {
				scope:pledge_loyalty_to_liege_offender = {
					any_owned_story = {
						type = story_cycle_pledge_loyalty_to_liege_overdue
						has_variable = new_title_variant
					}
				}
			}
			desc = pledge_loyalty_to_liege_overdue.1000.desc.new_title
		}
		desc = pledge_loyalty_to_liege_overdue.1000.desc.2
	}
	theme = realm

	left_portrait = {
		character = root
		animation = disbelief
	}
	right_portrait = {
		character = scope:pledge_loyalty_to_liege_offender
		animation = dismissal
	}

	# Demand their presence
	option = {
		name = pledge_loyalty_to_liege_overdue.1000.a
		custom_tooltip = pledge_loyalty_to_liege_overdue.1000.a.tt
		save_scope_as = spurned_liege
		scope:pledge_loyalty_to_liege_offender = {
			trigger_event = {
				id = pledge_loyalty_to_liege_overdue.1020
				days = 14
			}
		}

		ai_chance = {
			base = 100
		}
	}

	# Let it slide
	option = {
		name = pledge_loyalty_to_liege_overdue.1000.b
		add_legitimacy = {
			value = scope:pledge_loyalty_to_liege_offender.pledge_loyalty_to_liege_grant_legitimacy_value
			multiply = -2
		}
		custom_tooltip = pledge_loyalty_to_liege_overdue.1000.b.tt
		scope:pledge_loyalty_to_liege_offender = {
			trigger_event = pledge_loyalty_to_liege_overdue.1030
		}

		ai_chance = {
			base = 0
			modifier = {
				add = 10
				scope:pledge_loyalty_to_liege_offender.max_military_strength > { # if the vassal does not have at least 50% of our military strength, never pick this
					value = root.max_military_strength
					multiply = 0.5
				}
			}
			modifier = {
				add = 20
				scope:pledge_loyalty_to_liege_offender.max_military_strength > {
					value = root.max_military_strength
					multiply = 0.8
				}
			}
			modifier = {
				add = 20
				scope:pledge_loyalty_to_liege_offender.max_military_strength > {
					value = root.max_military_strength
					multiply = 1.0
				}
			}
			modifier = {
				add = 50
				scope:pledge_loyalty_to_liege_offender.max_military_strength > {
					value = root.max_military_strength
					multiply = 1.5
				}
			}
			modifier = {
				add = -40
				legitimacy < 100 # despite military strength balance, rarely do this if you have very low legitimacy already
			}
			ai_value_modifier = {
				ai_zeal = 1.2
				ai_boldness = 1.2
			}
		}
	}
}

# Intro event to prompt characters to bow to their liege if they haven't already
pledge_loyalty_to_liege_overdue.1010 = {
	type = character_event
	title = pledge_loyalty_to_liege_overdue.1010.t
	desc = {
		triggered_desc = {
			trigger = {
				any_owned_story = {
					type = story_cycle_pledge_loyalty_to_liege_overdue
					has_variable = new_liege_variant
				}
			}
			desc = pledge_loyalty_to_liege_overdue.1010.desc.new_liege
		}
		triggered_desc = {
			trigger = {
				any_owned_story = {
					type = story_cycle_pledge_loyalty_to_liege_overdue
					has_variable = new_title_variant
				}
			}
			desc = pledge_loyalty_to_liege_overdue.1010.desc.new_title
		}
		desc = pledge_loyalty_to_liege_overdue.1010.desc
	}
	theme = realm

	left_portrait = {
		character = root
		triggered_animation = {
			trigger = { "opinion(liege)" > 0 }
			animation = personality_honorable
		}
		animation = eyeroll
	}
	right_portrait = {
		character = liege
		animation = acknowledging
	}

	# Embark immediately
	option = {
		name = pledge_loyalty_to_liege_overdue.1010.a
		trigger = { can_execute_decision = pledge_loyalty_to_liege_decision }
		show_as_unavailable = { always = yes }
		custom_tooltip = pledge_loyalty_to_liege_overdue.1010.a.tt
		decision:pledge_loyalty_to_liege_decision = {
			open_view_data = {
				view = decision_detail
				player = root
			}
		}
	}

	# No time!
	option = {
		name = pledge_loyalty_to_liege_overdue.1010.b
		custom_tooltip = pledge_loyalty_to_liege_overdue.1010.b.tt
	}
}

# Letter event the liege sends to characters who have failed to show up
pledge_loyalty_to_liege_overdue.1020 = {
	type = letter_event
	opening = pledge_loyalty_to_liege_overdue.1020.t
	desc = pledge_loyalty_to_liege_overdue.1020.desc

	sender = {
		character = scope:spurned_liege
		animation = rage
	}

	# Embark immediately
	option = {
		name = pledge_loyalty_to_liege_overdue.1020.a
		trigger = { can_execute_decision = pledge_loyalty_to_liege_decision }
		show_as_unavailable = { always = yes }
		custom_tooltip = pledge_loyalty_to_liege_overdue.1020.a.tt
		decision:pledge_loyalty_to_liege_decision = {
			open_view_data = {
				view = decision_detail
				player = root
			}
		}
	}

	# No time!
	option = {
		name = pledge_loyalty_to_liege_overdue.1020.b
		reverse_add_opinion = {
			target = scope:spurned_liege
			modifier = angry_opinion
			opinion = -20
		}
		custom_tooltip = pledge_loyalty_to_liege_overdue.1020.b.tt
	}

	# Snub!
	option = {
		name = pledge_loyalty_to_liege_overdue.1020.c
		scope:spurned_liege = {
			add_legitimacy = {
				value = root.pledge_loyalty_to_liege_grant_legitimacy_value
				multiply = -2
			}
		}
		reverse_add_opinion = {
	 		target = scope:spurned_liege
	 		modifier = refused_pledge_loyalty_to_liege_opinion
	 	}
	 	custom_tooltip = pledge_loyalty_to_liege_overdue.1020.c.tt
	}
}

# Liege forgives the offense
pledge_loyalty_to_liege_overdue.1030 = {
	type = character_event
	title = pledge_loyalty_to_liege_overdue.1030.t
	desc = pledge_loyalty_to_liege_overdue.1030.desc
	theme = realm

	left_portrait = {
		character = root
		animation = personality_content
	}
	right_portrait = {
		character = liege
		triggered_animation = {
			trigger = { root = { has_trait = reckless } }
			animation = beg
		}
		animation = personality_forgiving
	}

	immediate = {
		random_owned_story = {
			type = story_cycle_pledge_loyalty_to_liege_overdue
			end_story = yes
		}
	}

	# OK
	option = {
		name = pledge_loyalty_to_liege_overdue.1030.a
		add_stress = minor_stress_loss
	}

	# They're probably afraid!
	option = {
		name = pledge_loyalty_to_liege_overdue.1030.b
		trait = reckless
		#add_unpressed_claim = title:e_japan #LotR
	}
}
