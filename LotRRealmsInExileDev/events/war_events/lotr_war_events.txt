namespace = lotr_war_events

lotr_war_events.0001 = {
    hidden = yes

    immediate = {
        scope:defender = {
            random_character_war = {
                limit = { primary_attacker = scope:attacker }
                save_scope_as = interested_war
            }
        }
    }

    option = { # Join the war on the side of the defender
        scope:interested_war = { add_defender = root }

		ai_chance = {
			base = 100
			
            modifier = { # Defender isn't an involved ruler in Struggle of TH
                add = 100
                
                NOT = { 
                    scope:attacker = {
                        any_character_struggle = { 
                            is_struggle_type = thani_hazad_struggle 
                            involvement = involved
                            is_struggle_phase = struggle_thani_hazad_phase_confederation
                        } 
                    }
                }
            }

            modifier = { # If Attackers Realms Size > Defenders Realm Size; Both are involved
                scope:defender = {
                    any_character_struggle = { 
                        is_struggle_type = thani_hazad_struggle 
                        involvement = involved
                        is_struggle_phase = struggle_thani_hazad_phase_confederation
                    } 
                }
                scope:attacker = {
                    any_character_struggle = { 
                        is_struggle_type = thani_hazad_struggle 
                        involvement = involved
                        is_struggle_phase = struggle_thani_hazad_phase_confederation
                    } 
                }
                add = 30
            }

            modifier = { # If you're allied with the attackers, don't join
                OR = {
                    is_allied_to = scope:attacker
                    is_defensive_allied_to = { RECIPIENT = scope:attacker }
                    NOT = { scope:interested_war = { any_war_defender = { this = root } } }
                }
                factor = 0
            }

            modifier = { # If the defender is an involved ruler and their troops already outweigh the attacker
                scope:defender = {
                    any_character_struggle = { 
                        is_struggle_type = thani_hazad_struggle 
                        involvement = involved
                        is_struggle_phase = struggle_thani_hazad_phase_confederation
                    } 
                }
                NOT = { # Attacker isn't an involved ruler in Struggle of TH
                    scope:attacker = {
                        any_character_struggle = { 
                            is_struggle_type = thani_hazad_struggle 
                            involvement = involved
                            is_struggle_phase = struggle_thani_hazad_phase_confederation
                        } 
                    }
                }
                scope:interested_war = {
                    war_attacker_total_strength_value < war_defender_total_strength_value
                }

                factor = 0
            }
		}
    }

    option = { # Don't join the war of the defender

		ai_chance = {
			base = 10

            modifier = { # Defender isn't an involved ruler in Struggle of TH
                scope:attacker = {
                    any_character_struggle = { 
                        is_struggle_type = thani_hazad_struggle 
                        involvement = involved
                        is_struggle_phase = struggle_thani_hazad_phase_confederation
                    } 
                }
                NOT = { 
                    scope:defender = {
                        any_character_struggle = { 
                            is_struggle_type = thani_hazad_struggle 
                            involvement = involved
                            is_struggle_phase = struggle_thani_hazad_phase_confederation
                        } 
                    }
                }
                factor = 0
            }
		}
    }
}

# Hidden event to stop defensive allies from raiding each other
lotr_war_events.0002 = { 
	hidden = yes
	scope = army

    trigger = {
		exists = scope:barony
        scope:raider = { is_defensive_allied_to = { RECIPIENT = scope:county.holder } }
    }

    immediate = {
		scope:raider = {
			add_truce_both_ways = {
				character = scope:county.holder.top_liege
				years = 10
				name = TRUCE_TRADE_DEAL
			}
		}
    }
}