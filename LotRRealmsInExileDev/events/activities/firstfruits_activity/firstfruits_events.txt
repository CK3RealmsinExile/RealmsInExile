namespace = firstfruits

######################################################################################
# 
# FESTIVAL OF FIRST-FRUITS ACTIVITY
# 
# firstfruits.0030-firstfruits.0049
# 
######################################################################################
# Bôzishnara festival giving praise to Ladnôca / Erû
# Celebrated in Bellakar and the Rây
# Based on RICE Bema festival

scripted_trigger may_ascend_izindutarik_trigger = {
	this = scope:activity.activity_host
	scope:activity.activity_location = {
		has_building_or_higher = wonder_nilulonde_01
	}
	faith.religion = { is_in_family = rf_eruhini } #Bellakari Faithful
	highest_held_title_tier >= tier_kingdom #King or Emperor
	is_independent_ruler = yes
}

# Festival Preparations - Start fasting
firstfruits.0030 = {
	type = activity_event
	content_source = realms_dlc
	title = firstfruits.0030.t
	desc = firstfruits.0030.desc
	theme = faith
	override_background = { reference = relaxing_room }
	
	right_portrait = root
	
	option = { # Ok
		name = firstfruits.0030.a
		if = {
			limit = {
				scope:activity = {
					has_activity_option = {
						category = lotr_firstfruits_fasting_length_type
						option = lotr_firstfruits_fasting_length_type_month
					}
				}
			}
			trigger_event = {
				id = firstfruits.0031
				days = 30
			}
		}
		else_if = {
			limit = {
				scope:activity = {
					has_activity_option = {
						category = lotr_firstfruits_fasting_length_type
						option = lotr_firstfruits_fasting_length_type_week
					}
				}
			}
			trigger_event = {
				id = firstfruits.0031
				days = 7
			}
		}
		else = {
			# Have it trigger as a failsafe in case you don't have a length option for some reason
			# limit = {
			# 	scope:activity = {
			# 		has_activity_option = {
			# 			category = lotr_firstfruits_fasting_length_type
			# 			option = lotr_firstfruits_fasting_length_type_day
			# 		}
			# 	}
			# }
			trigger_event = {
				id = firstfruits.0031
				days = 1
			}
		}
	}
}

# Fasting done - prepare for the ceremony/ascent
firstfruits.0031 = {
	type = activity_event
	content_source = realms_dlc
	title = {
		first_valid = {
			triggered_desc = {
				trigger = { may_ascend_izindutarik_trigger = yes }
				desc = firstfruits.0031.t.izindutarik
			}
			desc = firstfruits.0031.t.generic
		}
	}
	desc = {
		desc = firstfruits.0031.desc.intro
		first_valid = {
			triggered_desc = {
				trigger = { may_ascend_izindutarik_trigger = yes }
				desc = firstfruits.0031.desc.izindutarik
			}
			desc = firstfruits.0031.desc.generic
		}
	}
	theme = faith
	override_background = { reference = relaxing_room }
	
	right_portrait = {
		character = root
		animation = personality_honorable
	}

	immediate = {
		# Stress impact
		firstfruits_festival_fasting_effect = yes

		# Overfasting debuff chance
		random = {
			chance = firstfruits_fast_health_malus_chance
			firstfruits_festival_overfasted_effect = yes
		}
	}
	
	option = { # Ok
		name = {
			text = {
				first_valid = {
					triggered_desc = {
						trigger = { may_ascend_izindutarik_trigger = yes }
						desc = firstfruits.0031.a.izindutarik
					}
					desc = firstfruits.0031.a.generic
				}
			}
		}
		trigger_event = {
			id = firstfruits.0032
			days = { 3 5 }
		}	
	}
}

# Ascent done/Ceremony begins - start prayers and rituals
firstfruits.0032 = {
	type = activity_event
	content_source = realms_dlc
	title = {
		first_valid = {
			triggered_desc = {
				trigger = { may_ascend_izindutarik_trigger = yes }
				desc = firstfruits.0032.t.izindutarik
			}
			desc = firstfruits.0032.t.generic
		}
	}
	desc = {
		first_valid = {
			triggered_desc = {
				trigger = { may_ascend_izindutarik_trigger = yes }
				desc = firstfruits.0032.desc.izindutarik
			}
			desc = firstfruits.0032.desc.generic
		}
	}
	theme = lotr_theme_firstfruits_festival
	
	right_portrait = {
		character = root
		animation = prayer
	}
	
	option = { # Ok
		name = {
			text = {
				first_valid = {
					triggered_desc = {
						trigger = { may_ascend_izindutarik_trigger = yes }
						desc = firstfruits.0032.a.izindutarik
					}
					desc = firstfruits.0032.a.generic
				}
			}
		}
		trigger_event = {
			id = firstfruits.0033
			days = { 3 5 }
		}	
	}
}

# Ceremony concludes, descend
firstfruits.0033 = {
	type = activity_event
	content_source = realms_dlc
	title = {
		first_valid = {
			triggered_desc = {
				trigger = { may_ascend_izindutarik_trigger = yes }
				desc = firstfruits.0033.t.izindutarik
			}
			desc = firstfruits.0033.t.generic
		}
	}
	desc = {
		first_valid = {
			triggered_desc = {
				trigger = { may_ascend_izindutarik_trigger = yes }
				desc = firstfruits.0033.desc.izindutarik
			}
			desc = firstfruits.0033.desc.generic
		}
	}
	theme = lotr_theme_firstfruits_festival
	
	left_portrait = {
		character = scope:chaplain
		animation = wedding_priest
		trigger = {
			exists = scope:chaplain
		}
	}	

	right_portrait = {
		character = root
		animation = personality_content
	}

	immediate = {
		if = {
			limit = {
				exists = cp:councillor_court_chaplain
			}
			cp:councillor_court_chaplain ?= { save_scope_as = chaplain }
		}
	}
	
	option = { # Ok
		name = {
			text = {
				first_valid = {
					triggered_desc = {
						trigger = { may_ascend_izindutarik_trigger = yes }
						desc = firstfruits.0033.a.izindutarik
					}
					desc = firstfruits.0033.a.generic
				}
			}
		}
		trigger_event = {
			id = firstfruits.0034
			days = { 3 5 }
		}	
	}
}

# Festival of First-Fruits - feast and end event
firstfruits.0034 = {
	type = activity_event
	content_source = realms_dlc
	title = firstfruits.0034.t
	desc = firstfruits.0034.desc
	theme = lotr_theme_firstfruits_festival
	
	right_portrait = root
	
	option = { # Ok
		name = firstfruits.0034.a
		firstfruits_festival_completed_log_entry_effect = yes
	}

	after = {
		if = {
			limit = {
				root = scope:host
			}
			scope:activity = {
				hidden_effect = { skip_activity_phase = yes }
			}
		}
	}

}
