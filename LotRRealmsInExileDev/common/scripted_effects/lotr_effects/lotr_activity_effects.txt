###############
### SAILING ###
###############
damage_ship = { #ISSUE WITH BOAT HIRE DURATIONS
	if = {
		limit = {
			has_character_modifier = small_boat_modifier
			has_character_flag = hired_a_boat
		}
		remove_character_modifier = small_boat_modifier
		add_character_modifier = {
			modifier = small_damaged_boat_modifier
			years = boat_hire_duration_years
		}
	}
	else_if = {
		limit = {
			has_character_modifier = medium_boat_modifier
			has_character_flag = hired_a_boat
		}
		remove_character_modifier = medium_boat_modifier
		add_character_modifier = {
			modifier = medium_damaged_boat_modifier
			years = boat_hire_duration_years
		}
	}
	else_if = {
		limit = {
			has_character_modifier = large_boat_modifier
			has_character_flag = hired_a_boat
		}
		remove_character_modifier = large_boat_modifier
		add_character_modifier = {
			modifier = large_damaged_boat_modifier
			years = boat_hire_duration_years
		}
	}
	else_if = {
		limit = {
			has_character_modifier = small_boat_modifier
		}
		remove_character_modifier = small_boat_modifier
		add_character_modifier = small_damaged_boat_modifier
	}
	else_if = {
		limit = {
			has_character_modifier = medium_boat_modifier
		}
		remove_character_modifier = medium_boat_modifier
		add_character_modifier = medium_damaged_boat_modifier
	}
	else_if = {
		limit = {
			has_character_modifier = large_boat_modifier
		}
		remove_character_modifier = large_boat_modifier
		add_character_modifier = large_damaged_boat_modifier
	}
}

repair_ship = { #ISSUE WITH BOAT HIRE DURATIONS
	if = {
		limit = {
			has_character_modifier = small_damaged_boat_modifier
			has_character_flag = hired_a_boat
		}
		remove_character_modifier = small_damaged_boat_modifier
		add_character_modifier = {
			modifier = small_boat_modifier
			years = boat_hire_duration_years
		}
	}
	else_if = {
		limit = {
			has_character_modifier = medium_damaged_boat_modifier
			has_character_flag = hired_a_boat
		}
		remove_character_modifier = medium_damaged_boat_modifier
		add_character_modifier = {
			modifier = medium_boat_modifier
			years = boat_hire_duration_years
		}
	}
	else_if = {
		limit = {
			has_character_modifier = large_damaged_boat_modifier
			has_character_flag = hired_a_boat
		}
		remove_character_modifier = large_damaged_boat_modifier
		add_character_modifier = {
			modifier = large_boat_modifier
			years = boat_hire_duration_years
		}
	}
	else_if = {
		limit = {
			has_character_modifier = small_damaged_boat_modifier
		}
		remove_character_modifier = small_damaged_boat_modifier
		add_character_modifier = small_boat_modifier
	}
	else_if = {
		limit = {
			has_character_modifier = medium_damaged_boat_modifier
		}
		remove_character_modifier = medium_damaged_boat_modifier
		add_character_modifier = medium_boat_modifier
	}
	else_if = {
		limit = {
			has_character_modifier = large_damaged_boat_modifier
		}
		remove_character_modifier = large_damaged_boat_modifier
		add_character_modifier = large_boat_modifier
	}
}

remove_boat = {
	if = {
		limit = {
			has_character_modifier = small_damaged_boat_modifier
		}
		remove_character_modifier = small_damaged_boat_modifier
	}
	else_if = {
		limit = {
			has_character_modifier = medium_damaged_boat_modifier
		}
		remove_character_modifier = medium_damaged_boat_modifier
	}
	else_if = {
		limit = {
			has_character_modifier = large_damaged_boat_modifier
		}
		remove_character_modifier = large_damaged_boat_modifier
	}
	if = {
		limit = {
			has_character_modifier = small_boat_modifier
		}
		remove_character_modifier = small_boat_modifier
	}
	else_if = {
		limit = {
			has_character_modifier = medium_boat_modifier
		}
		remove_character_modifier = medium_boat_modifier
	}
	else_if = {
		limit = {
			has_character_modifier = large_boat_modifier
		}
		remove_character_modifier = large_boat_modifier
	}
	if = {
		limit = {
			has_character_flag = hired_a_boat
		}
		remove_character_flag = hired_a_boat
	}
}

return_charter = {
	if = {
		limit = {
			has_character_flag = hired_a_boat
		}
		remove_boat = yes
	}
}

####################
## YULE ACTIVITY ###
####################
lotr_yule_completed_log_entry_effect = {
	scope:activity = {
		add_activity_log_entry = {
			key = lotr_yule_completed_log
			tags = { completed }
			# this line below adds the entry to the Effects section of the conclusion UI
			show_in_conclusion = yes
			character = root
			scope:host = {
				capital_county = {
					add_county_modifier = {
						modifier = lotr_yule_celebrated_modifier
						years = 5
					}
				}
				if = {
					limit = {
						has_activity_intent = lotr_yule_festive_intent
					}
					stress_impact = {
						base = minor_stress_impact_loss
						gregarious = minor_stress_impact_loss
						gluttonous = minor_stress_impact_loss
					}
				}
				else_if = {
					limit = {
						has_activity_intent = lotr_yule_devotion_intent
					}						
					add_piety = lotr_yule_piety_gain
					stress_impact = {
						base = miniscule_stress_impact_loss
						zealous = minor_stress_impact_loss
						diligent = minor_stress_impact_loss
					}
				}
				else_if = {
					limit = {
						has_activity_intent = lotr_yule_generosity_intent
					}
					stress_impact = {
						base = miniscule_stress_impact_loss
						generous = minor_stress_impact_loss
						compassionate = minor_stress_impact_loss
					}
				}
				if = {
					limit = {
						scope:activity = {
							has_activity_option = {
								category = lotr_yule_gift_size_option
								option = lotr_yule_gift_small
							}
						}
					}
					add_prestige = lotr_yule_gift_gain_small_base
				}
				else_if = {
					limit = {
						scope:activity = {
							has_activity_option = {
								category = lotr_yule_gift_size_option
								option = lotr_yule_gift_medium
							}
						}
					}
					add_prestige = lotr_yule_gift_gain_medium_base
				}
				else_if = {
					limit = {
						scope:activity = {
							has_activity_option = {
								category = lotr_yule_gift_size_option
								option = lotr_yule_gift_large
							}
						}
					}
					add_prestige = lotr_yule_gift_gain_large_base
				}
				add_character_modifier = {
					modifier = lotr_yule_modifier
					years = 5
				}
			}
			every_attending_character = {
				limit = { NOT = { this = scope:host } }
				custom = EVERY_ACTIVITY_PARTICIPANT_EFFECT
				stress_impact = {
					base = minor_stress_impact_loss
				}
				if = {
					limit = {
						scope:activity = {
							has_activity_option = {
								category = lotr_yule_gift_size_option
								option = lotr_yule_gift_small
							}
						}
					}
					if = {
						limit = {
							scope:host = {
								has_activity_intent = lotr_yule_generosity_intent
							}
						}
						add_opinion = {
							target = scope:host
							modifier = lotr_yule_opinion
							opinion = 8
						}
					}
					else = {						
						add_opinion = {
							target = scope:host
							modifier = lotr_yule_opinion
							opinion = 4
						}
					}
				}
				else_if = {
					limit = {
						scope:activity = {
							has_activity_option = {
								category = lotr_yule_gift_size_option
								option = lotr_yule_gift_medium
							}
						}
					}
					if = {
						limit = {
							scope:host = {
								has_activity_intent = lotr_yule_generosity_intent
							}
						}
						add_opinion = {
							target = scope:host
							modifier = lotr_yule_opinion
							opinion = 16
						}
					}
					else = {						
						add_opinion = {
							target = scope:host
							modifier = lotr_yule_opinion
							opinion = 8
						}
					}
				}
				else_if = {
					limit = {
						scope:activity = {
							has_activity_option = {
								category = lotr_yule_gift_size_option
								option = lotr_yule_gift_large
							}
						}
					}
					if = {
						limit = {
							scope:host = {
								has_activity_intent = lotr_yule_generosity_intent
							}
						}
						add_opinion = {
							target = scope:host
							modifier = lotr_yule_opinion
							opinion = 24
						}
					}
					else = {						
						add_opinion = {
							target = scope:host
							modifier = lotr_yule_opinion
							opinion = 12
						}
					}
				}
				add_character_modifier = {
					modifier = lotr_yule_modifier
					years = 5
				}
			}
		}
	}
}


############################
## FIRST-FRUITS ACTIVITY ###
############################
firstfruits_festival_fasting_effect = { # Fasting stress impact
	# Fast Length Bonuses
	if = { # Short Fast
		limit = {
			scope:activity = {
				has_activity_option = {
					category = lotr_firstfruits_fasting_length_type
					option = lotr_firstfruits_fasting_length_type_day
				}
			}
		}
		stress_impact = {
			base = 5
			gluttonous = -25
			temperate = 15
			comfort_eater = -15
			inappetetic = 10
			zealous = 5
			cynical = -10
			fickle = -5
		}
	}
	else_if = { # Normal Fast
		limit = {
			scope:activity = {
				has_activity_option = {
					category = lotr_firstfruits_fasting_length_type
					option = lotr_firstfruits_fasting_length_type_week
				}
			}
		}
		stress_impact = {
			base = -5
		}
	}
	else = { # Long Fast
		limit = {
			scope:activity = {
				has_activity_option = {
					category = lotr_firstfruits_fasting_length_type
					option = lotr_firstfruits_fasting_length_type_month
				}
			}
		}
		stress_impact = {
			base = 5
			gluttonous = 15
			temperate = -25
			comfort_eater = 10
			inappetetic = -15
			zealous = -10
			cynical = 5
			fickle = 5
		}
	}
}

firstfruits_festival_overfasted_effect = { # Overfasted health debuff
	scope:activity = {
		add_activity_log_entry = {
			key = firstfruits_festival_fasting_effect_log
			tags = { bad }
			# this line below adds the entry to the Effects section of the conclusion UI
			show_in_conclusion = yes
			character = scope:host
			scope:host = {
				send_interface_toast = {
					type = event_toast_effect_bad
					left_icon = scope:host
					title = firstfruits.0031.a.toast
					change_current_weight = -25
					add_character_modifier = {
						modifier = firstfruits_fast_health_malus_modifier
						years = 3
					}
				}
			}
		}
	}
}

firstfruits_festival_completed_log_entry_effect = {
	scope:activity = {
		add_activity_log_entry = {
			key = firstfruits_festival_completed_log
			tags = { completed }
			# this line below adds the entry to the Effects section of the conclusion UI
			show_in_conclusion = yes
			character = root

			scope:host = {
				# Intent Bonuses
				if = {
					limit = {
						has_activity_intent = firstfruits_festival_celebration_intent
					}
					stress_impact = {
						base = minor_stress_impact_loss
						gregarious = miniscule_stress_impact_loss
						lifestyle_reveler = miniscule_stress_impact_loss
					}
				}
				else_if = {
					limit = {
						has_activity_intent = firstfruits_festival_reflection_intent
					}
					every_courtier = {
						limit = {
							faith = { has_doctrine = tenet_bellakari_syncretism }
							OR = {
								is_clergy = yes
								has_vassal_stance = zealot
							}
						}
						custom = EVERY_ZEALOT_AND_THEOCRAT_VASSAL_AND_COURTIER_EFFECT
						add_opinion = {
							target = root
							modifier = pious_opinion
							opinion = 10
						}			
					}
					hidden_effect = {
						every_vassal = {
							limit = {
								faith = { has_doctrine = tenet_bellakari_syncretism }
								OR = {
									is_clergy = yes
									has_vassal_stance = zealot
								}
							}
							custom = EVERY_ZEALOT_AND_THEOCRAT_VASSAL_AND_COURTIER_EFFECT
							add_opinion = {
								modifier = pious_opinion
								target = root
								opinion = 10
							}
						}
					}
				}
				# Artifact Bonuses
				if = {
					limit = {
						any_equipped_character_artifact = { has_variable = kathasaptha_artifact_urenanvale_variable }
					}
					random_equipped_character_artifact = {
						limit = { has_variable = kathasaptha_artifact_urenanvale_variable }
						save_scope_as = artifact_urenanvale
					}
					custom_description_no_bullet = {
						text = activity_firstfruits_because_of_artifact_urenanvale
					}
					every_attending_character = {
						limit = { NOT = { this = scope:host } }
						custom = EVERY_ACTIVITY_PARTICIPANT_EFFECT	
						add_opinion = {
							modifier = impressed_opinion
							target = scope:host
							opinion = 10
						}
					}
				}
				if = {
					limit = {
						any_equipped_character_artifact = { has_variable = kathasaptha_artifact_missingmountain_variable }
					}
					random_equipped_character_artifact = {
						limit = { has_variable = kathasaptha_artifact_missingmountain_variable }
						save_scope_as = artifact_missingmountain
					}
					custom_description_no_bullet = {
						text = activity_firstfruits_because_of_artifact_missingmountain
					}
					add_legitimacy = {
						value = 25
						multiply = piety_level
					}
				}
				if = {
					limit = {
						any_equipped_character_artifact = { has_variable = kathasaptha_artifact_gatarazay_variable }
					}
					random_equipped_character_artifact = {
						limit = { has_variable = kathasaptha_artifact_gatarazay_variable }
						save_scope_as = artifact_gatarazay
					}
					custom_description_no_bullet = {
						text = activity_firstfruits_because_of_artifact_gatarazay
					}
					stress_impact = {
						base = minor_stress_impact_loss
					}
				}
				if = {
					limit = {
						any_equipped_character_artifact = { has_variable = kathasaptha_artifact_emissariesinnature_variable }
					}
					random_equipped_character_artifact = {
						limit = { has_variable = kathasaptha_artifact_emissariesinnature_variable }
						save_scope_as = artifact_emissariesinnature
					}
					custom_description_no_bullet = {
						text = activity_firstfruits_because_of_artifact_emissariesinnature
					}
					RICE_minor_lifestyle_experience_gain_effect = yes
				}
				# Piety Rewards
				firstfruits_festival_piety_reward = yes
				# Prestige Rewards
				firstfruits_festival_prestige_reward = yes
				# Apply county effects
				firstfruits_festival_apply_county_buffs_effect = yes
				# Other attendee bonuses
				every_attending_character = {
					limit = { NOT = { this = scope:host } }
					custom = EVERY_ACTIVITY_PARTICIPANT_EFFECT
					add_piety = firstfruits_festival_base_piety_small
					add_prestige = firstfruits_festival_base_prestige_small
					stress_impact = {
						base = minor_stress_impact_loss
					}
				}	
			}
		}
	}
}

firstfruits_festival_apply_county_buffs_effect = {
	every_held_county = {
		custom = custom.every_firstfruits_domain_county
		limit = {
			faith = { has_doctrine = tenet_bellakari_syncretism }
		}
		if = { # Reset the timer if its already there
			limit = {
				has_county_modifier = firstfruits_festival_county_modifier
			}
			hidden_effect = {
				remove_county_modifier = firstfruits_festival_county_modifier
			}
		}

		# Fruit Alms Bonuses
		if = {
			limit = {
				scope:activity = {
					has_activity_option = {
						category = lotr_firstfruits_fruit_alms_type
						option = lotr_firstfruits_fruit_alms_type_small
					}
				}
			}
			custom_description_no_bullet = {
				text = activity_firstfruits_because_of_alms_type_small
			}
		}
		else_if = {
			limit = {
				scope:activity = {
					has_activity_option = {
						category = lotr_firstfruits_fruit_alms_type
						option = lotr_firstfruits_fruit_alms_type_medium
					}
				}
			}
			custom_description_no_bullet = {
				text = activity_firstfruits_because_of_alms_type_medium
			}
		}
		else_if = {
			limit = {
				scope:activity = {
					has_activity_option = {
						category = lotr_firstfruits_fruit_alms_type
						option = lotr_firstfruits_fruit_alms_type_large
					}
				}
			}
			custom_description_no_bullet = {
				text = activity_firstfruits_because_of_alms_type_large
			}
		}
		else_if = {
			limit = {
				scope:activity = {
					has_activity_option = {
						category = lotr_firstfruits_fruit_alms_type
						option = lotr_firstfruits_fruit_alms_type_huge
					}
				}
			}
			custom_description_no_bullet = {
				text = activity_firstfruits_because_of_alms_type_huge
			}
		}
		add_county_modifier = {
			modifier = firstfruits_festival_county_modifier
			years = {
				value = 5
				if = {
					limit = {
						scope:host = { any_equipped_character_artifact = { has_variable = kathasaptha_artifact_katpolozay_variable } }
					}
					add = 1
				}
			}
		}

		# Artifact Modifier - Scolding the Flames
		if = { # Having this Artifact equipped improves control in affected counties
			limit = {
				scope:host = { any_equipped_character_artifact = { has_variable = kathasaptha_artifact_scoldingtheflames_variable } }
			}
			random_equipped_character_artifact = {
				limit = { has_variable = kathasaptha_artifact_scoldingtheflames_variable }
				save_scope_as = artifact_scoldingtheflames
			}
			custom_description_no_bullet = {
				text = activity_firstfruits_because_of_artifact_scoldingtheflames
			}
			change_county_control = firstfruits_festival_control_gain
		}
	}
}
