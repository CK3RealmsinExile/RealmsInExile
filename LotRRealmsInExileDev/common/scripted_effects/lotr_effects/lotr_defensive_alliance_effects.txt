lotr_create_defensive_alliance = {
	save_scope_as = primary_defender
	$DEFENSIVE_ALLY$ = { save_scope_as = secondary_defender }
	add_character_flag = {
		flag = $LOC_KEY$
		days = 7
	}
	scope:primary_defender = {
		add_character_flag = {
			flag = lotr_new_defensive_alliance
			days = 7
		}
	}
	scope:secondary_defender = {
		add_character_flag = {
			flag = lotr_new_defensive_alliance
			days = 7
		}
	}
	create_confederation = {
		name = DEFENSIVE_ALLIANCE_GENERIC_NAME
		type = confederation_type:defensive_alliance
	}
	scope:new_confederation ?= {
		set_variable = defensive_alliance
		set_variable = lotr_can_not_elevate_confederation
		add_confederation_member = scope:secondary_defender

		set_variable = { #Save for localization reasons
			name = primary_defender
			value = scope:primary_defender
		}
		set_variable = {
			name = secondary_defender
			value = scope:secondary_defender
		}
	}
	switch = {
		trigger = has_character_flag
		two_realm_name = {
			scope:new_confederation ?= {
				set_confederation_name = DEFENSIVE_ALLIANCE_DYNAMIC_TWO_REALM_NAME
			}
		}
		balan_lai = {
			scope:new_confederation ?= {
				set_confederation_name = DEFENSIVE_ALLIANCE_BALAN_LAI_NAME
				set_coa = d_balan_lai_leader
				set_variable = balan_lai_confederation
			}
		}
	}
}

lotr_disband_defensive_alliance = {
	if = {
		limit = { has_defensive_alliance = yes }
		confederation ?= {
			limit = { has_variable = defensive_alliance }
			disband_confederation = yes
		}
	}
}

lotr_disband_defensive_alliance_character_check = {
	if = {
		limit = {
			has_defensive_alliance = yes
			$ALLY$ = { has_defensive_alliance = yes }
		}
		confederation ?= {
			limit = {
				has_variable = defensive_alliance
				NOT = { has_variable = balan_lai_confederation }
				any_confederation_member = { this = $ALLY$ }
			}
			disband_confederation = yes
		}
	}
}