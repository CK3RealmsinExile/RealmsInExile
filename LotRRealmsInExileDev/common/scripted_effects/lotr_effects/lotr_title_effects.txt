##########################
### LOTR TITLE EFFECTS ###
##########################
# Title related scripted effects

lotr_set_court_language_effect = { # Set court tongue to $LANGUAGE$
	# For use in title history
	if = {
		limit = {
			has_dlc_feature = royal_court
			exists = holder
			holder = { has_royal_court = yes }
			this = holder.primary_title
		}
		holder = {
			set_court_language = $LANGUAGE$
		}
	}
}

lotr_move_dejure_capital_effect = { # Sets title dejure capital to $COUNTY$
	# For use in title history and effects
	# Only use for duchy, kingdom, empire scopes
	# Based on vanilla's set_de_jure_capital_decision

	# Save current title scope
	save_scope_as = current_de_jure_scope
	# Save new capital scope
	title:$COUNTY$ = {
		save_scope_as = current_capital_scope
	}

	# Additional code to get duchy capital buildings to move properly
	# PDX notes its very jank
	if = {
		limit = {
			tier = tier_duchy
			this = title_capital_county.duchy
		}
		custom_tooltip = { text = set_de_jure_capital_warning }
		hidden_effect = {
			title_capital_county = { save_scope_as = old_capital }
			set_capital_county = scope:current_capital_scope
			scope:old_capital ?= {
				duchy = { save_scope_as = current_duchy }
				random_duchy = {
					limit = {
						NOT = { this = scope:current_duchy }
						is_noble_family_title = no
						is_mercenary_company = no
					}
					save_scope_as = placeholder_duchy
				}
				scope:current_duchy = {
					every_de_jure_county = {
						limit = {
							NOT = { this = scope:current_capital_scope }
						}
						set_de_jure_liege_title = scope:placeholder_duchy
						add_to_list = correction_list
					}
				}
				every_in_list = {
					list = correction_list
					set_de_jure_liege_title = scope:current_duchy
				}
			}
		}
	}
	else = {
		custom_tooltip = {
			text = set_de_jure_capital_effect_tooltip
		}
		hidden_effect = {
			set_capital_county = scope:current_capital_scope
		}
	}

	if = {
		limit = {
			exists = holder
			this = holder.primary_title
			holder ?= { has_title = scope:current_capital_scope }
		}
		holder ?= { set_realm_capital = scope:current_capital_scope }
	}
}

form_pharazain_effect = { # Effects for proclaim_pharazain_decision
	if = { # Make it Phara-Rain | Achievement
		limit = {
			NOT = {
				exists = global_var:lotr_achievement_67
			}
			is_ai = no
			realms_achievements_enabled = yes
			has_primary_title = title:e_bellakar
		}
		set_global_variable = lotr_achievement_67
	}
	save_scope_as = founder
	#Create the title and make it primary
	create_title_and_vassal_change = {
		type = created
		save_scope_as = title_change
		add_claim_on_loss = yes
	}
	title:h_pharazain = {
		change_title_holder = {
			holder = root
			change = scope:title_change
		}
	}
	resolve_title_and_vassal_change = scope:title_change
	set_primary_title_to = title:h_pharazain
	
	every_county_in_region = { # Works
		region = special_pharazain
		add_to_list = pharazain_counties
	}
	every_empire = {
		limit = {
			OR = {
				AND = { # Others if you hold them
					this.holder ?= root
					any_de_jure_county = {
						count > 0
						is_in_list = pharazain_counties
					}
				}
				# Automatically add these two
				this = title:e_bellakar
				this = title:e_thani_hazad 
			}
		}
		set_de_jure_liege_title = title:h_pharazain
	}

	# End Thani Struggle if ongoing
	if = {
		limit = {
			exists = struggle:thani_hazad_struggle
		}
		custom_tooltip = numenor_in_exile_thani_struggle_tt
		hidden_effect = {
			struggle:thani_hazad_struggle ?= {
				every_involved_ruler = {
					send_interface_toast = {
						type = event_toast_effect_neutral
						title = numenor_in_exile_thani_struggle_toast
						left_icon = scope:founder
						custom_tooltip = numenor_in_exile_thani_struggle_toast_desc
						if = {
							limit = {
								has_trait = balan_lai_member
							}
							remove_trait = balan_lai_member
						}
						if = {
							limit = {
								has_title = title:d_balan_lai_leader
							}
							destroy_title = title:d_balan_lai_leader
						}
					}
				}
				every_interloper_ruler = {
					send_interface_toast = {
						type = event_toast_effect_neutral
						title = numenor_in_exile_thani_struggle_toast
						left_icon = scope:founder
						custom_tooltip = numenor_in_exile_thani_struggle_toast_desc
					}
				}
			}
			struggle:thani_hazad_struggle ?= {
				end_struggle = yes
			}
		}
	}

	hidden_effect = {
		random_confederation = {
			limit = { has_variable = balan_lai_confederation }
			every_confederation_member = { remove_trait = balan_lai_member }
			disband_confederation = yes
		}
		if = {
			limit = {
				exists = title:d_balan_lai_leader.holder
			}
			title:d_balan_lai_leader.holder = { destroy_title = title:d_balan_lai_leader }
		}
	}
}

lotr_create_hegemony_effect = { # Makes a hegemony from scratch
	save_scope_as = founder
	primary_title = {
		save_scope_as = old_title
	}

	create_dynamic_title = {
		tier = hegemony
		name = $TITLE$
		article = $TITLE$_article
	}
	create_title_and_vassal_change = {
		type = created
		save_scope_as = change
		add_claim_on_loss = no
	}

	scope:new_title = {
		change_title_holder = {
			holder = root
			change = scope:change
		}
	}

	resolve_title_and_vassal_change = scope:change

	every_held_title = {
		title_tier = empire
		set_de_jure_liege_title = scope:new_title
	}

	every_sub_realm_county = {
		limit = {
			exists = empire
			NOT = { exists = empire.holder }
			holder.top_liege = root
			empire = {
				save_temporary_scope_as = test_kingdom
			}
			holder.top_liege = {
				completely_controls = scope:test_kingdom
			}
		}
		if = {
			limit = {
				NOT = {
					empire = {
						is_in_list = additional_de_jure_kingdoms
					}
				}
			}
			empire = {
				set_de_jure_liege_title = scope:new_title
				add_to_list = additional_de_jure_kingdoms
			}
		}
	}

	scope:new_title = {
		set_coa = scope:old_title
		set_color_from_title = scope:old_title
		set_capital_county = scope:old_title.title_capital_county
	}
	set_primary_title_to = scope:new_title
}