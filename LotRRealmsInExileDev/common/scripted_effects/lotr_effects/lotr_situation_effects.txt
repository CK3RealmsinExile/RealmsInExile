 ###################################
###								  ###
###		Elven Situation Effects	  ###
###								  ###
 ###################################

# Move situation to the next phase according to current hope threshold
update_lorien_phase_effect = { # Lorien & Imladris
	if = {
		limit = {
			var:lorien_hope_value <= elven_fading_limit
		}
		every_situation_sub_region = {
			limit = {							
				situation_sub_region_has_county = title:c_caras_galadhon
			}
			change_phase = { phase = situation_elven_fading }
		}
	}
	else_if = {
		limit = {
			AND = {
				var:lorien_hope_value <= elven_fading_limit
				var:lorien_hope_value > elven_waning_limit
			}
		}
		every_situation_sub_region = {
			limit = {							
				situation_sub_region_has_county = title:c_caras_galadhon
			}
			change_phase = { phase = situation_elven_waning }
		}
	}
	else_if = {
		limit = {
			AND = {
				var:lorien_hope_value <= elven_enduring_limit
				var:lorien_hope_value > elven_waning_limit
			}
		}
		every_situation_sub_region = {
			limit = {							
				situation_sub_region_has_county = title:c_caras_galadhon
			}
			change_phase = { phase = situation_elven_enduring }
		}
	}
	else_if = {
		limit = {
			AND = {
				var:lorien_hope_value <= elven_renewing_limit
				var:lorien_hope_value > elven_enduring_limit
			}
		}
		every_situation_sub_region = {
			limit = {							
				situation_sub_region_has_county = title:c_caras_galadhon
			}
			change_phase = { phase = situation_elven_renewing }
		}
	}
	else_if = {
		limit = {
			AND = {
				var:lorien_hope_value <= elven_thriving_limit
				var:lorien_hope_value > elven_renewing_limit
			}
		}
		every_situation_sub_region = {
			limit = {							
				situation_sub_region_has_county = title:c_caras_galadhon
			}
			change_phase = { phase = situation_elven_thriving }
		}
	}
}

update_lindon_phase_effect = { # Lindon
	if = {
		limit = {
			var:lindon_hope_value <= elven_fading_limit
		}
		every_situation_sub_region = {
			limit = {							
				situation_sub_region_has_county = title:c_mithrhulond
			}
			change_phase = { phase = situation_elven_fading }
		}
	}
	else_if = {
		limit = {
			AND = {
				var:lindon_hope_value <= elven_waning_limit
				var:lindon_hope_value > elven_fading_limit
			}
		}
		every_situation_sub_region = {
			limit = {							
				situation_sub_region_has_county = title:c_mithrhulond
			}
			change_phase = { phase = situation_elven_waning }
		}
	}
	else_if = {
		limit = {
			AND = {
				var:lindon_hope_value <= elven_enduring_limit
				var:lindon_hope_value > elven_waning_limit
			}
		}
		every_situation_sub_region = {
			limit = {							
				situation_sub_region_has_county = title:c_mithrhulond
			}
			change_phase = { phase = situation_elven_enduring }
		}
	}
	else_if = {
		limit = {
			AND = {
				var:lindon_hope_value <= elven_renewing_limit
				var:lindon_hope_value > elven_enduring_limit
			}
		}
		every_situation_sub_region = {
			limit = {							
				situation_sub_region_has_county = title:c_mithrhulond
			}
			change_phase = { phase = situation_elven_renewing }
		}
	}
	else_if = {
		limit = {
			AND = {
				var:lindon_hope_value <= elven_thriving_limit
				var:lindon_hope_value > elven_renewing_limit
			}
		}
		every_situation_sub_region = {
			limit = {							
				situation_sub_region_has_county = title:c_mithrhulond
			}
			change_phase = { phase = situation_elven_thriving }
		}
	}
}

update_greenwood_phase_effect = { # Greenwood
	if = {
		limit = {
			var:greenwood_hope_value <= elven_fading_limit
		}
		every_situation_sub_region = {
			limit = {							
				situation_sub_region_has_county = title:c_aradhrynd
			}
			change_phase = { phase = situation_elven_fading }
		}
	}
	else_if = {
		limit = {
			AND = {
				var:greenwood_hope_value <= elven_waning_limit
				var:greenwood_hope_value > elven_fading_limit
			}
		}
		every_situation_sub_region = {
			limit = {							
				situation_sub_region_has_county = title:c_aradhrynd
			}
			change_phase = { phase = situation_elven_waning }
		}
	}
	else_if = {
		limit = {
			AND = {
				var:greenwood_hope_value <= elven_enduring_limit
				var:greenwood_hope_value > elven_waning_limit
			}
		}
		every_situation_sub_region = {
			limit = {							
				situation_sub_region_has_county = title:c_aradhrynd
			}
			change_phase = { phase = situation_elven_enduring }
		}
	}
	else_if = {
		limit = {
			AND = {
				var:greenwood_hope_value <= elven_renewing_limit
				var:greenwood_hope_value > elven_enduring_limit
			}
		}
		every_situation_sub_region = {
			limit = {							
				situation_sub_region_has_county = title:c_aradhrynd
			}
			change_phase = { phase = situation_elven_renewing }
		}
	}
	else_if = {
		limit = {
			AND = {
				var:greenwood_hope_value <= elven_thriving_limit
				var:greenwood_hope_value > elven_renewing_limit
			}
		}
		every_situation_sub_region = {
			limit = {							
				situation_sub_region_has_county = title:c_aradhrynd
			}
			change_phase = { phase = situation_elven_thriving }
		}
	}
}

update_ormal_phase_effect = { # Bay of Ormal
	if = {
		limit = {
			var:ormal_hope_value <= elven_fading_limit
		}
		every_situation_sub_region = {
			limit = {							
				situation_sub_region_has_county = title:c_carnesra
			}
			change_phase = { phase = situation_elven_fading }
		}
	}
	else_if = {
		limit = {
			AND = {
				var:ormal_hope_value <= elven_waning_limit
				var:ormal_hope_value > elven_fading_limit
			}
		}
		every_situation_sub_region = {
			limit = {							
				situation_sub_region_has_county = title:c_carnesra
			}
			change_phase = { phase = situation_elven_waning }
		}
	}
	else_if = {
		limit = {
			AND = {
				var:ormal_hope_value <= elven_enduring_limit
				var:ormal_hope_value > elven_waning_limit
			}
		}
		every_situation_sub_region = {
			limit = {							
				situation_sub_region_has_county = title:c_carnesra
			}
			change_phase = { phase = situation_elven_enduring }
		}
	}
	else_if = {
		limit = {
			AND = {
				var:ormal_hope_value <= elven_renewing_limit
				var:ormal_hope_value > elven_enduring_limit
			}
		}
		every_situation_sub_region = {
			limit = {							
				situation_sub_region_has_county = title:c_carnesra
			}
			change_phase = { phase = situation_elven_renewing }
		}
	}
	else_if = {
		limit = {
			AND = {
				var:ormal_hope_value <= elven_thriving_limit
				var:ormal_hope_value > elven_renewing_limit
			}
		}
		every_situation_sub_region = {
			limit = {							
				situation_sub_region_has_county = title:c_carnesra
			}
			change_phase = { phase = situation_elven_thriving }
		}
	}
}

update_kinnlai_phase_effect = { # Lands of the Kinn-lai
	if = {
		limit = {
			var:kinnlai_hope_value <= elven_fading_limit
		}
		every_situation_sub_region = {
			limit = {							
				situation_sub_region_has_county = title:c_ayahopa
			}
			change_phase = { phase = situation_elven_fading }
		}
	}
	else_if = {
		limit = {
			AND = {
				var:kinnlai_hope_value <= elven_waning_limit
				var:kinnlai_hope_value > elven_fading_limit
			}
		}
		every_situation_sub_region = {
			limit = {							
				situation_sub_region_has_county = title:c_ayahopa
			}
			change_phase = { phase = situation_elven_waning }
		}
	}
	else_if = {
		limit = {
			AND = {
				var:kinnlai_hope_value <= elven_enduring_limit
				var:kinnlai_hope_value > elven_waning_limit
			}
		}
		every_situation_sub_region = {
			limit = {							
				situation_sub_region_has_county = title:c_ayahopa
			}
			change_phase = { phase = situation_elven_enduring }
		}
	}
	else_if = {
		limit = {
			AND = {
				var:kinnlai_hope_value <= elven_renewing_limit
				var:kinnlai_hope_value > elven_enduring_limit
			}
		}
		every_situation_sub_region = {
			limit = {							
				situation_sub_region_has_county = title:c_ayahopa
			}
			change_phase = { phase = situation_elven_renewing }
		}
	}
	else_if = {
		limit = {
			AND = {
				var:kinnlai_hope_value <= elven_thriving_limit
				var:kinnlai_hope_value > elven_renewing_limit
			}
		}
		every_situation_sub_region = {
			limit = {							
				situation_sub_region_has_county = title:c_ayahopa
			}
			change_phase = { phase = situation_elven_thriving }
		}
	}
}

# Remove excess hope 
remove_excess_hope_effect = {
	if = {
		limit = {
			var:lorien_hope_value > elven_thriving_limit
		}
		set_variable = {
			name = lorien_hope_value
			value = elven_thriving_limit
		}
	}
	if = {
		limit = {
			var:lindon_hope_value > elven_thriving_limit
		}
		set_variable = {
			name = lindon_hope_value
			value = elven_thriving_limit
		}
	}
	if = {
		limit = {
			var:greenwood_hope_value > elven_thriving_limit
		}
		set_variable = {
			name = greenwood_hope_value
			value = elven_thriving_limit
		}
	}
	if = {
		limit = {
			var:ormal_hope_value > elven_thriving_limit
		}
		set_variable = {
			name = ormal_hope_value
			value = elven_thriving_limit
		}
	}	
	if = {
		limit = {
			var:kinnlai_hope_value > elven_thriving_limit
		}
		set_variable = {
			name = kinnlai_hope_value
			value = elven_thriving_limit
		}
	}
}

# Add hope through effect 
add_elven_hope_effect = {
	every_character_situation = {
		limit = { has_variable = lorien_hope_value }
		save_scope_as = lorien_situation
	}
	every_character_situation = {
		limit = { has_variable = lindon_hope_value }
		save_scope_as = lindon_situation
	}
	every_character_situation = {
		limit = { has_variable = greenwood_hope_value }
		save_scope_as = greenwood_situation
	}
	every_character_situation = {
		limit = { has_variable = ormal_hope_value }
		save_scope_as = ormal_situation
	}
	every_character_situation = {
		limit = { has_variable = kinnlai_hope_value }
		save_scope_as = kinnlai_situation
	}
	
	if = {
		limit = {
			capital_county.title_province = {
				OR = {
					geographical_region = middleearth_west_rhovanion_lothlorien
					geographical_region = middleearth_west_eregion
				}
			}
		}
		scope:lorien_situation = {
			change_variable = {
				name = lorien_hope_value
				add = $VALUE$
			}
		}
		create_elven_catalyst_for_history = { 
			VALUE = $VALUE$ 
			HOPE_EFFECT = $HOPE_EFFECT$ 
			SITUATION_REGION = lorien_situation
			POSITIVE_OR_NEGATIVE = positive_effect
		}
	}
	else_if = {
		limit = {
			capital_county.title_province = {
				geographical_region = middleearth_west_beleriand
			}
		}
		scope:lindon_situation = {
			change_variable = {
				name = lindon_hope_value
				add = $VALUE$
			}
		}
		create_elven_catalyst_for_history = { 
			VALUE = $VALUE$ 
			HOPE_EFFECT = $HOPE_EFFECT$ 
			SITUATION_REGION = lindon_situation
			POSITIVE_OR_NEGATIVE = positive_effect
		}
	}
	else_if = {
		limit = {
			capital_county.title_province = {
				geographical_region = middleearth_west_rhovanion_mirkwood
			}
		}
		scope:greenwood_situation = {
			change_variable = {
				name = greenwood_hope_value
				add = $VALUE$
			}
		}
		create_elven_catalyst_for_history = { 
			VALUE = $VALUE$ 
			HOPE_EFFECT = $HOPE_EFFECT$ 
			SITUATION_REGION = greenwood_situation
			POSITIVE_OR_NEGATIVE = positive_effect
		}
	}
	else_if = {
		limit = {
			capital_county.title_province = {
				OR = {
					geographical_region = middleearth_harad_bayoformal
					geographical_region = middleearth_uttersouth_shayn
				}
			}
		}
		scope:ormal_situation = {
			change_variable = {
				name = ormal_hope_value
				add = $VALUE$
			}
		}
		create_elven_catalyst_for_history = { 
			VALUE = $VALUE$ 
			HOPE_EFFECT = $HOPE_EFFECT$ 
			SITUATION_REGION = ormal_situation
			POSITIVE_OR_NEGATIVE = positive_effect
		}
	}
	else_if = {
		limit = {
			capital_county.title_province = {
				OR = {
					geographical_region = middleearth_uttersouth_mumakan
					geographical_region = middleearth_uttersouth_usakan
					geographical_region = middleearth_uttersouth_twinkingdoms
					geographical_region = middleearth_mountains_yellow
				}
			}
		}
		scope:kinnlai_situation = {
			change_variable = {
				name = kinnlai_hope_value
				add = $VALUE$
			}
		}
		create_elven_catalyst_for_history = { 
			VALUE = $VALUE$ 
			HOPE_EFFECT = $HOPE_EFFECT$ 
			SITUATION_REGION = kinnlai_situation
			POSITIVE_OR_NEGATIVE = positive_effect
		}
	}
	custom_description = { text = add_elven_hope_desc value = $VALUE$ }
}

# Subtract hope through effect 
subtract_elven_hope_effect = {
	every_character_situation = {
		limit = { has_variable = lorien_hope_value }
		save_scope_as = lorien_situation
	}
	every_character_situation = {
		limit = { has_variable = lindon_hope_value }
		save_scope_as = lindon_situation
	}
	every_character_situation = {
		limit = { has_variable = greenwood_hope_value }
		save_scope_as = greenwood_situation
	}
	every_character_situation = {
		limit = { has_variable = ormal_hope_value }
		save_scope_as = ormal_situation
	}
	every_character_situation = {
		limit = { has_variable = kinnlai_hope_value }
		save_scope_as = kinnlai_situation
	}
	
	if = {
		limit = {
			capital_county.title_province = {
				OR = {
					geographical_region = middleearth_west_rhovanion_lothlorien
					geographical_region = middleearth_west_eregion
				}
			}
		}
		scope:lorien_situation = {
			change_variable = {
				name = lorien_hope_value
				subtract = $VALUE$
			}
		}
		create_elven_catalyst_for_history = { 
			VALUE = $VALUE$ 
			HOPE_EFFECT = $HOPE_EFFECT$ 
			SITUATION_REGION = lorien_situation
			POSITIVE_OR_NEGATIVE = negative_effect
		}
	}
	else_if = {
		limit = {
			capital_county.title_province = {
				geographical_region = middleearth_west_beleriand
			}
		}
		scope:lindon_situation = {
			change_variable = {
				name = lindon_hope_value
				subtract = $VALUE$
			}
		}
		create_elven_catalyst_for_history = { 
			VALUE = $VALUE$ 
			HOPE_EFFECT = $HOPE_EFFECT$ 
			SITUATION_REGION = lindon_situation
			POSITIVE_OR_NEGATIVE = negative_effect
		}
	}
	else_if = {
		limit = {
			capital_county.title_province = {
				geographical_region = middleearth_west_rhovanion_mirkwood
			}
		}
		scope:greenwood_situation = {
			change_variable = {
				name = greenwood_hope_value
				subtract = $VALUE$
			}
			add_to_variable_list = {
				name = greenwood_hope_changes
				target = $HOPE_EFFECT$
			}
		}
		create_elven_catalyst_for_history = { 
			VALUE = $VALUE$ 
			HOPE_EFFECT = $HOPE_EFFECT$ 
			SITUATION_REGION = greenwood_situation
			POSITIVE_OR_NEGATIVE = negative_effect
		}
	}
	else_if = {
		limit = {
			capital_county.title_province = {
				OR = {
					geographical_region = middleearth_harad_bayoformal
					geographical_region = middleearth_uttersouth_shayn
				}
			}
		}
		scope:ormal_situation = {
			change_variable = {
				name = ormal_hope_value
				subtract = $VALUE$
			}
		}
		create_elven_catalyst_for_history = { 
			VALUE = $VALUE$ 
			HOPE_EFFECT = $HOPE_EFFECT$ 
			SITUATION_REGION = ormal_situation
			POSITIVE_OR_NEGATIVE = negative_effect
		}
	}
	else_if = {
		limit = {
			capital_county.title_province = {
				OR = {
					geographical_region = middleearth_uttersouth_mumakan
					geographical_region = middleearth_uttersouth_usakan
					geographical_region = middleearth_uttersouth_twinkingdoms
					geographical_region = middleearth_mountains_yellow
				}
			}
		}
		scope:kinnlai_situation = {
			change_variable = {
				name = kinnlai_hope_value
				subtract = $VALUE$
			}
		}
		create_elven_catalyst_for_history = { 
			VALUE = $VALUE$ 
			HOPE_EFFECT = $HOPE_EFFECT$ 
			SITUATION_REGION = kinnlai_situation
			POSITIVE_OR_NEGATIVE = negative_effect
		}
	}
	custom_description = { text = subtract_elven_hope_desc value = $VALUE$ }
}

# Apply development penalty when hope is low
check_elven_development_penalties_effect = {
	every_situation_sub_region = {
		every_situation_sub_region_participant = {
			limit = { is_independent_ruler = yes }
			trigger_event = {
				id = elven_hope.0020
				months = { 2 10 }
			}
		}
	}
}

create_elven_catalyst_for_history = {
	set_variable = {
		name = elven_hope_catalyst_loc_value
		value = $VALUE$
	}
	set_variable = {
		name = elven_hope_catalyst_loc_key
		value = flag:$HOPE_EFFECT$
	}
	set_variable = {
		name = elven_hope_catalyst_specific_situation
		value = scope:$SITUATION_REGION$
	}
	set_variable = {
		name = elven_hope_catalyst_positive_or_negative
		value = flag:$POSITIVE_OR_NEGATIVE$
	}
	
	create_story = story_elven_hope_catalyst
	random_owned_story = {
		limit = {
			save_temporary_scope_as = this_story 
			
			NOT = {
				scope:$SITUATION_REGION$ = {
					is_target_in_variable_list = {
						name = region_$SITUATION_REGION$_localization
						target = scope:this_story
					}
				}
			}
		}
		scope:$SITUATION_REGION$ = {
			add_to_variable_list = {
				name = region_$SITUATION_REGION$_localization
				target = prev
				years = 5
			}
		}
	}
	remove_variable = elven_hope_catalyst_loc_key
	remove_variable = elven_hope_catalyst_loc_value
	remove_variable = elven_hope_catalyst_specific_situation
}

### Debug Effects ###

add_elven_hope_debug = {
	subtract_elven_hope_effect = { VALUE = 100 HOPE_EFFECT = effect_elven_very_high_hope }
}