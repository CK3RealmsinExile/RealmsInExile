####################
# Wastelands: effects
####################

# Returns colony to a Wilderness / Wastelands
make_settlement_county_wilderness = {
	# Struggle Catalyst
	if = {
		limit = {
			$COUNTY$.holder = {
				any_character_struggle = {
					involvement = involved
					phase_has_catalyst = catalyst_destroyed_colony_in_moria
				}
			}
			$COUNTY$ = {
				kingdom = title:k_khazad_dum
				NOT = {
					var:abandoned_moria_colony ?= flag:abandoned
				}
			}
		}
		$COUNTY$ = {
			set_variable = {
				name = abandoned_moria_colony
				value = flag:abandoned
				years = 2
			}
		}
		$COUNTY$.holder = {
			every_character_struggle = {
				involvement = involved
				activate_struggle_catalyst = {
					catalyst = catalyst_destroyed_colony_in_moria
					character = prev
				}
			}
		}
	}
	# Abandonment effect
	$COUNTY$ = {
		# Decrease settlement upkeep modifier
		if = {
			limit = { holder = { has_variable = num_settled_wilderness } }
			if = {
				limit = { holder = { var:num_settled_wilderness > 0 } }
				holder = { trigger_event = wastelands.0007 }
			}
			else = { holder = { remove_wastelands_tracker_variable = yes } }
		}

		hidden_effect = {
			create_title_and_vassal_change = {
				type = revoked
				save_scope_as = change
			}
			change_title_holder = {
				holder = character:k_wastelands_holder
				change = scope:change
				take_baronies = yes
			}
			resolve_title_and_vassal_change = scope:change
			set_county_faith = faith:faith_wastelands_pagan
			set_county_culture = culture:wastelands
			generate_coa = yes

		}
		every_county_province = {
			limit = {
				is_county_capital = no
				has_holding = yes
			}
			remove_holding = yes
		}
		every_county_province = {
			limit = {
				is_county_capital = yes
				has_holding = yes
			}
			if = {
				limit = { NOT = { has_holding_type = wastelands_holding } }
				set_holding_type = wastelands_holding
			}
		}
		change_development_level = -100
	}
}

# Removes traits from wastelands
# Makes wasteland rulers almost immortal
# Makes sure it's an adult, since non-adult always have clothes by default that can't be hidden
# Make sure wasteland holders don't have gold to create titles
remove_traits_wastelands_effect = {
    every_excess_wasteland_character = {
        clear_traits = yes
        add_trait = wastelands
        if = {
            limit = {
                age < 25
            }
            set_age = 25
        }
        remove_short_term_gold = gold
    }
}

# Destroy "Wilderness" characters that are created
# They can't be sent to anywhere else, since they don't have portrait
empty_wastelands_inhabitants_effect = {
	every_excess_wasteland_character = {
		limit = {
			NOT = { this = character:k_wastelands_holder }
		}
		death = {
			death_reason = death_vanished
		}
		every_traveling_family_member = {
			limit = {
				is_alive = yes
			}
			death = {
				death_reason = death_vanished
			}
		}
	}
}

# Sends visitors somewhere else (a neighbouring capital county)
empty_foreign_visitors_to_wastelands_effect = {
	if = {
		limit = {
			exists = scope:host
			scope:host = { has_culture = culture:wastelands }
		}
		random_neighboring_and_across_water_top_liege_realm_owner = { #Select realm
			limit = {
				exists = capital_province
				capital_province = { local_pool_is_full_trigger = no }
				NOT = {
					has_culture = culture:wastelands
				}
			}
			capital_province = { save_scope_as = destination }
		}
		every_traveling_family_member = {
			if = {
				limit = {
					exists = scope:destination
					NOT = { is_in_pool_at = scope:destination }
				}
				move_to_pool_at = scope:destination
			}
			else = {
				fallback_move_to_pool_effect = yes
			}
		}
	}
}

# Colonise a wastelands county
ai_colonisation_effect = {
	$WASTELANDS$ = { save_scope_as = wastelands }
	$ROOT_SCOPE$ = { save_scope_as = new_holder }
	# debug_log = "lotr_wastelands_effects: -- COLONISATION STARTED!" # Only needed for testing

	scope:wastelands.county = { save_scope_as = wastelands_holder_title }
	scope:wastelands_holder_title.holder = { save_scope_as = wastelands_holder }

	create_title_and_vassal_change = {
		type = returned
		save_scope_as = change
	}

	scope:wastelands_holder_title = {
		change_title_holder = {
			holder = scope:new_holder
			change = scope:change
			take_baronies = yes
		}
		set_county_faith = scope:new_holder.faith
		if = { # If Dol Guldur settles
			limit = {
				scope:new_holder = {
					AND = {
						OR = {
							is_maiar_fallen = yes
							is_nazgul = yes
						}
						capital_county = title:c_amon_lanc
					}
				}
			}
			set_county_culture = culture:kazgumhoth
		}
		else_if = { # If nazgul settles
			limit = {
				scope:new_holder = { is_nazgul = yes }
			}
			set_county_culture = culture:ungurhai
		}
		else_if = { # If Gandalf settles
			limit = {
				scope:new_holder = { has_character_flag = gandalf }
			}
			set_county_culture = culture:dunedain_ranger
		}
		else_if = { # If Saruman settles
			limit = {
				scope:new_holder = { 
					AND = {
						has_character_flag = is_saruman
						NOR = {
							has_character_flag = saruman_dunlendings_bent
							has_character_flag = saruman_dunlendings_crushed
							has_character_flag = saruman_uruk_hai_created
						}
					} 
				}
			}
			set_county_culture = culture:isengard_dunlending
		}
		else_if = { # If evil Saruman (before creating the uruk-hai and bending the dunlendings) settles
			limit = {
				scope:new_holder = { has_character_flag = saruman_dunlendings_bent }
			}
			set_county_culture = culture:dunlending
		}
		else_if = { # If evil Saruman (before creating the uruk-hai and invading the dunlendings) settles
			limit = {
				scope:new_holder = { has_character_flag = saruman_dunlendings_crushed }
			}
			set_county_culture = culture:morlughai
		}
		else_if = { # If evil Saruman (After creating the uruk-hai) settles
			limit = {
				scope:new_holder = { has_character_flag = saruman_uruk_hai_created }
			}
			set_county_culture = culture:isengard_urukhai
		}
		else_if = { # If Sauron settles
			limit = {
				scope:new_holder = { has_character_flag = is_sauron }
			}
			set_county_culture = culture:morlughai
		}
		else = { # Otherwise set to root culture
			set_county_culture = scope:new_holder.culture
		}
	}

	resolve_title_and_vassal_change = scope:change

	scope:wastelands_holder_title = {
		generate_coa = yes
		#set_color_from_title = scope:wastelands_holder_title.de_jure_liege
		scope:wastelands_holder_title = { # Swap holding type to settlement holding as soon as county is colonised
			every_county_province = {
				limit = {
					has_holding = yes
					has_holding_type = wastelands_holding
				}
				set_holding_type = settlement_holding
			}
			every_county_province = {
				limit = {
					has_holding = yes
					is_county_capital = no
					has_holding_type = wastelands_holding
				}
				remove_holding = yes
			}
			every_county_province = {
				barony = { generate_coa = yes }
			}
		}
	}

	scope:wastelands_holder_title.holder = {
		if = {
			limit = { NOT = { any_owned_story = { story_type = story_conqueror } } NOT = { has_character_flag = dwarf_in_moria } this = character:k_wastelands_holder }
			hidden_effect = { remove_short_term_gold = colonise_cost_val }
		}
		else_if = {
			limit = { NOT = { any_owned_story = { story_type = story_conqueror } } NOT = { has_character_flag = dwarf_in_moria } }
			remove_short_term_gold = colonise_cost_val
		}
		if = {
			limit = {
				exists = dynasty
				dynasty = { has_dynasty_modifier = easy_arnor_settle }
			}
			scope:wastelands_holder_title = {
				add_county_modifier = {
					modifier = arnor_settler_influx
					years = 3
				}
			}
		}
		increase_variable = {
			NAME = num_settled_wilderness
			AMOUNT = 1
		}
		trigger_event = wastelands.0007
	}

	if = {
		limit = {
			scope:wastelands_holder_title = title:c_durins_hall
			game_start_date < 7033.1.1
			scope:wastelands_holder_title.holder = { is_dwarf = yes }
		}
		finding_durins_gear_effect = { HOLDER = scope:wastelands_holder_title.holder }
	}

	# Struggle catalyst
	if = {
		limit = {
			exists = scope:wastelands_holder_title
			scope:wastelands_holder_title.holder = {
				any_character_struggle = {
					involvement = involved
					phase_has_catalyst = catalyst_new_colony_in_moria
				}
			}
			scope:wastelands_holder_title = {
				any_county_struggle = {
					this = struggle:balrog_struggle
				}
			}
		}
		scope:wastelands_holder_title.holder = {
			every_character_struggle = {
				involvement = involved
				activate_struggle_catalyst = {
					catalyst = catalyst_new_colony_in_moria
					character = root
				}
			}
		}
	}

	# scope:wastelands_holder_title.holder = { debug_log_scopes = no } # Only needed for testing
	# debug_log = "lotr_wastelands_effects: -- COLONISATION FINISHED!" # Only needed for testing
}

halve_development = {
	change_development_level = {
		subtract = county.development_level
		divide = 2
	}
}

# If a character has settlement holdings at the start of the game, use this effect
add_settlement_upkeep_in_history = {
	every_ruler = {
		limit = { NOT = { this = character:k_wastelands_holder }}
		every_held_title = {
			limit = {
				tier = tier_county
				title_province = { has_holding_type = settlement_holding }
			}
			if = {
				limit = {
					holder = { NOT = { has_variable = num_settled_wilderness } }
				}
				holder = { set_variable = { name = num_settled_wilderness value = 0 } }
			}
			holder = {
				change_variable = {
					name = num_settled_wilderness
					add = 1
				}
			}
			holder = { trigger_event = wastelands.0007 }
		}
	}
}

# Remove upkeep modifier
remove_upkeep_modifier = {
	remove_character_modifier ?= holding_one_settlements
	remove_character_modifier ?= holding_two_settlements
	remove_character_modifier ?= holding_three_settlements
	remove_character_modifier ?= holding_four_settlements
	remove_character_modifier ?= holding_five_settlements
	remove_character_modifier ?= holding_more_than_five_settlements
}

remove_wastelands_tracker_variable = {
	if = {
		limit = { exists = var:num_settled_wilderness }
		if = {
			limit = { var:num_settled_wilderness < 0 }
			remove_variable = num_settled_wilderness
		}
	}
}

correct_wastelands_tracker = {
	if = {
		limit = { any_held_county = { title_province ?= { has_holding_type = settlement_holding } } }
		if = {
			limit = { has_variable = correct_settlement_count }
			remove_variable = correct_settlement_count
		}
		every_held_county = {
			limit = { title_province ?= { has_holding_type = settlement_holding } }
			holder = {
				increase_variable = {
					NAME = correct_settlement_count
					AMOUNT = 1
				}
			}
		}
		if = {
			limit = {
				exists = var:num_settled_wilderness
				exists = var:correct_settlement_count
				NOT = { var:num_settled_wilderness = var:correct_settlement_count }
			}
			set_variable = {
				name = num_settled_wilderness
				value = var:correct_settlement_count
			}
		}
		remove_variable = correct_settlement_count
		remove_upkeep_modifier = yes
		trigger_event = wastelands.0007
	}
	else_if = { # Remove the upkeep modifier in-case
		limit = {
			is_alive = yes
			has_variable = num_settled_wilderness
			NOT = {
				any_held_county = { title_province ?= { has_holding_type = settlement_holding } }
			}
		}
		remove_variable = num_settled_wilderness
		remove_upkeep_modifier = yes
	}
}

cleanup_cleared_blockers_effect = {
	county.title_province = {
		save_scope_as = obstacle_province
	}
	county.holder = {
		trigger_event = {
			id = wastelands.9000
			days = 2
		}
	}
}

lotr_upgrade_settlement_to_full_holding_effect = {
	$COUNTY$ = { save_scope_as = target_county }

	scope:target_county = {
		if = {
			limit = { holder = { is_elf = yes } }
			title_province = { set_holding_type = elven_holding }
		} else_if = {
			limit = { title_province = { terrain = halls } }
			title_province = { set_holding_type = dwarven_holding }
		} else_if = {
			limit = { holder = { is_hobbit = yes } }
			title_province = { set_holding_type = city_holding }
		} else = {
			if = {
				limit = { holder = { has_government = tribal_government } }
				title_province = { set_holding_type = tribal_holding }
			} else = {
				title_province = { set_holding_type = castle_holding }
			}
		}
	}
}

lotr_increase_settler_maa = {
	$CHARACTER$ = {
		if = {
			limit = { any_maa_regiment = { is_maa_type = laamp_settler_maa } }
			random_maa_regiment = {
				limit = { is_maa_type = laamp_settler_maa }
				change_maa_regiment_size = {
					size = $SIZE$
					reinforce = no
				}
			}
		}
		else = {
			create_maa_regiment = {
				type = laamp_settler_maa
				check_can_recruit = no
				size = 1
			}
			random_maa_regiment = {
				limit = { is_maa_type = laamp_settler_maa }
				change_maa_regiment_size = {
					size = 1
					reinforce = no
				}
				change_maa_troops_count = -100
			}
		}
	}
}

pirate_adventurer_start_war_effect = {
	$PIRATE$ = { save_scope_as = pirate_adventurer }
	$TARGET$ = { save_scope_as = adventurer_target }

	#Give the adventurer a dynamic title to tide them over.
	create_dynamic_title = {
		tier = duchy
		name = PIRATE_ARMY_NEUTRAL_NAME
	}
	create_title_and_vassal_change = {
		type = created
		save_scope_as = change
		add_claim_on_loss = no
	}
	scope:new_title = {
		set_capital_county = scope:adventurer_target
		set_landless_title = yes
		set_destroy_on_gain_same_tier = yes
		set_no_automatic_claims = yes
		set_can_be_named_after_dynasty = no
		change_title_holder = {
			holder = scope:pirate_adventurer
			change = scope:change
		}
	}
	resolve_title_and_vassal_change = scope:change
	scope:new_title = {
		generate_coa = yes
		set_variable = {
			name = temporary_title
			value = yes
		}
	}
	#Declare the war.
	scope:pirate_adventurer = {
		start_war = {
			casus_belli = fp1_scandi_adventurer_conquest
			target = scope:adventurer_target.holder.top_liege
			target_title = scope:adventurer_target.duchy
		}
	}
	# Setup event troops.
	scope:pirate_adventurer = {
		add_character_modifier = pirate_adventurer_modifier
		add_trait = adventurer
		# Work out how many event troops we should give the adventurer for a 60:40 fight.
		spawn_army = {
			levies = {
				add = {
					#Base of 400.
					add = scope:adventurer_target.holder.top_liege.max_military_strength
					#Multiply that by the realm size of the target's top_liege.
					multiply = 1.5
					#Account for allies, adding more without just nullifying them.
					scope:adventurer_target.holder.top_liege = {
						every_ally = { add = this.max_military_strength }
					}
					#Cut it off so things don't get too ridiculous.
					max = 8000
					#Make sure all adventurers have a moderately respectable force.
					min = 1000
				}
			}
			inheritable = no
			location = scope:adventurer_target.title_province
			name = pirate_adventurer_event_troops
		}
		spawn_army = {
			men_at_arms = {
				type = corsair_warriors
				stacks = {
					value = 1
					multiply = scope:adventurer_target.holder.top_liege.primary_title.tier
				}
			}
			inheritable = yes
			location = scope:adventurer_target.title_province
			name = pirate_adventurer_event_troops
		}
		spawn_army = {
			men_at_arms = {
				type = mardrukan_pikemen
				stacks = {
					value = 1
					multiply = scope:adventurer_target.holder.top_liege.primary_title.tier
				}
			}
			inheritable = yes
			location = scope:adventurer_target.title_province
			name = pirate_adventurer_event_troops
		}
		spawn_army = {
			men_at_arms = {
				type = mangonel
				stacks = 2
			}
			inheritable = yes
			location = scope:adventurer_target.title_province
			name = pirate_adventurer_event_troops
		}
	}
	# Loan a little gold in case they're in debt/to keep them going.
	scope:pirate_adventurer = { add_gold = medium_gold_value }
}

############################################
### Wastelands for on-game start effects ###
############################################

set_every_county_wilderness = {
	$SELECTED_TITLE$.holder ?= {
		every_tributary = {
			limit = { 
				OR = {
					suzerain = character:k_wastelands_holder
					suzerain = { is_landed = no } 
				}
			}
			end_tributary = yes
		}
	}

	create_title_and_vassal_change = {
		type = granted
		save_scope_as = change
		add_claim_on_loss = no
	}

	if = {
		limit = { NOT = { exists = global_var:used_wastelands_gui } }
		set_global_variable = used_wastelands_gui 
	}

	if = {
		limit = {
			OR = {
				$SELECTED_TITLE$ = title:e_rhovanion
				$SELECTED_TITLE$ = title:e_rhun
			}
		}
		title:e_golden_realm_rhun = { holder ?= { destroy_title = prev } }
	}
	if = {
		limit = { $SELECTED_TITLE$ = title:e_bozisha_miraz }
		title:e_thon_an_kharlokh = { holder ?= { destroy_title = prev } } 
	}
	if = {
		limit = { $SELECTED_TITLE$ = title:e_calenardhon }
		title:d_isengard = {
			every_de_jure_county = {
				if = {
					limit = { exists = global_var:wastelands_colonisable }
               		add_county_modifier = block_settlement_ability
				}
				if = {
					limit = {
						NOT = {
							any_in_list = {
								list = prev_title_holder
								this = holder
							}
							holder = character:k_wastelands_holder
						}
					}
					holder = { add_to_list = prev_title_holder }
				}
	
				every_county_province = {
					limit = {
						is_county_capital = yes
						OR = {
							has_holding_type = city_holding
							has_holding_type = church_holding
							has_holding_type = settlement_holding
							has_holding_type = tribal_holding
							has_holding_type = castle_holding
							has_holding_type = elven_holding
						}
					}
					set_holding_type = wastelands_holding
				}
				every_county_province = {
					limit = {
						is_county_capital = no
						OR = {
							has_holding_type = city_holding
							has_holding_type = church_holding
							has_holding_type = settlement_holding
							has_holding_type = tribal_holding
							has_holding_type = castle_holding
							has_holding_type = elven_holding
						}
					}
					remove_holding = yes
				}
				
				change_title_holder = {
					holder = character:k_wastelands_holder
					change = scope:change
					take_baronies = yes
				}
				change_development_level = -100
			}
		}
		
	}

	$SELECTED_TITLE$ = {
		every_de_jure_county = {
			if = {
				limit = { exists = global_var:wastelands_colonisable }
            	add_county_modifier = block_settlement_ability

				set_color_from_title = title:k_invisible_title
				set_title_name = k_wastelands
			}
			if = {
				limit = {
					NOT = {
						any_in_list = {
							list = prev_title_holder
							this = holder
						}
						holder = { 
							any_held_title = {
								tier = tier_county
								count > 0 
							}
						}
						holder = character:k_wastelands_holder
					}
				}
				holder = { add_to_list = prev_title_holder }
			}

			every_county_province = {
				limit = {
					is_county_capital = yes
					NOT = { has_holding_type = wastelands_holding }
				}
				set_holding_type = wastelands_holding
			}
			every_county_province = {
				limit = {
					is_county_capital = no
					has_holding = yes
				}
				remove_holding = yes
			}
			
			change_title_holder = {
				holder = character:k_wastelands_holder
				change = scope:change
				take_baronies = yes
			}
			change_development_level = -100
		}
	}

	resolve_title_and_vassal_change = scope:change

	# Kills off all the previous rulers, stops courtier bloat
	every_in_list = {
		list = prev_title_holder
		if = {
			limit = {
				NOR = {
					this = character:lineofsauron
					this = character:nazgul1
					this = character:nazgul2
					this = character:nazgul7
					this = character:nazgul4
					this = character:nazgul5
					this = character:nazgul6
					this = character:nazgul3
					this = character:nazgul8
					this = character:nazgul9
					this = character:lineofsaruman
					this = character:lineofgandalf
					this = character:lineofradagast
				}
			}
			death = { death_reason = death_disappearance }

			every_close_family_member = {
				limit = { is_ruler = no }
				death = { death_reason = death_disappearance }
			}
		}
		else = {
			set_character_faith_with_conversion = faith:faith_ainur
			set_location = province:3900
		}
	}
		
	character:k_wastelands_holder = {
		every_held_county = {
			set_county_faith = faith:faith_wastelands_pagan
			set_county_culture = culture:wastelands
			change_development_level = -100
			generate_coa = yes

			if = {
				limit = {
					kingdom = {
						any_in_de_jure_hierarchy = {
							tier = tier_county
							NOT = { holder = character:k_wastelands_holder }
						}
					}
				}
			} 
			else_if = { 
				limit = {
					trigger_if = {
						limit = {
							NOT = { $SELECTED_TITLE$ = title:k_eregion }
						}
						NOT = { kingdom = title:k_eregion }
					}
				}
			}
		}
	}
	kill_random_courtiers = yes
	stop_wastelands_wars = yes
}

add_empires_to_global_list = {
	every_empire = {
		limit = {
			NOT = { this = title:e_valinor }
			any_de_jure_county = { count > 0 }
		}
		add_to_global_variable_list = {
			name = all_empires_in_game
			target = this
		}
	}
}

add_kingdom_titles_to_list = {
	every_in_global_list = {
		variable = all_empires_in_game
		save_scope_as = curr_empire
		every_de_jure_county = {
			duchy = { save_scope_as = curr_duchy }
			duchy.kingdom = {
				if = {
					limit = {
						NOT = {
							scope:curr_empire = {
								is_target_in_variable_list = {
									name = de_jure_kingdoms
									target = prev
								}
							}
						}
					}
					scope:curr_empire = {
						add_to_variable_list = {
							name = de_jure_kingdoms
							target = prev
						}
					}
				}
			}
			if = {
				limit = {
					NOT = {
						kingdom = {
							is_target_in_variable_list = {
								name = de_jure_duchies
								target = scope:curr_duchy
							}
						}
					}
				}
				
				kingdom = {
					add_to_variable_list = {
						name = de_jure_duchies
						target = scope:curr_duchy
					}
				}
			}
		}
	}
}

canon_area_empires = {
	every_in_global_list = {
		variable = all_empires_in_game
		limit = {
			NOT = {
				title_capital_county.title_province = { # Juke note: Tried to improve code so we dont have to update this list repeatedly
					OR = {
						geographical_region = middleearth_mountains_blue
						geographical_region = middleearth_mountains_misty
						geographical_region = middleearth_mountains_iron
						geographical_region = middleearth_mountains_white

						geographical_region = middleearth_west
						geographical_region = middleearth_forodwaith
						geographical_region = middleearth_harad_near
						geographical_region = middleearth_mordor
						geographical_region = middleearth_rhun_dorwinion
						geographical_region = middleearth_rhun_seaofrhun
						geographical_region = middleearth_rhun_khand
						geographical_region = middleearth_rhun_nurunkizdin
					}
				}
			}
		}
		add_to_global_variable_list = {
			name = non_canon_areas
			target = this
		}
	}
}

kill_random_courtiers = {
	every_living_character = {
		limit = {
			NOR = {
				exists = top_liege
				top_liege ?= title:k_wastelands.holder
				is_sauron = yes
				is_nazgul = yes
				is_maiar_fallen = yes
				is_maiar = yes
				is_istari = yes
			}
		}
		save_scope_as = lore_char
		if = {
			limit = { has_variable = lotr_type_of_content }
			title:k_wastelands = {
				remove_list_variable = {
					name = lore_character_list
					target = scope:lore_char
				}
			}
			remove_variable = lotr_type_of_content
		}
		scope:lore_char = { death = { death_reason = death_disappearance } }
	}

}

stop_wastelands_wars = {
	character:k_wastelands_holder = { every_character_war = { end_war = white_peace } }
}

remove_kingdom_and_duchy_variables_from_empires = {
	every_in_global_list = {
		variable = all_empires_in_game
		save_scope_as = curr_empire
		every_de_jure_county = {
			duchy = { save_scope_as = curr_duchy }
			duchy.kingdom = {
				if = {
					limit = {
						scope:curr_empire = {
							is_target_in_variable_list = {
								name = de_jure_kingdoms
								target = prev
							}
						}
					}
					scope:curr_empire = {
						remove_list_variable = {
							name = de_jure_kingdoms
							target = prev
						}
					}
				}
			}
			if = {
				limit = {
					kingdom = {
						is_target_in_variable_list = {
							name = de_jure_duchies
							target = scope:curr_duchy
						}
					}
				}
				
				kingdom = {
					remove_list_variable = {
						name = de_jure_duchies
						target = scope:curr_duchy
					}
				}
			}
		}
	}
}