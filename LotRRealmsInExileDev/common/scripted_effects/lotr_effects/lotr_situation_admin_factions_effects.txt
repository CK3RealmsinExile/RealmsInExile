##################
# Admin Factions #
##################

# Determines which faction has the most power - Scope: situation
determine_dominant_factions_effect = {
	
	# Initialize highest and second highest tracking variables
	set_variable = { name = highest_faction_power value = 0 }
	set_variable = { name = second_highest_faction_power value = 0 }

	# Check Militarists vs Absolutists
	if = {
		limit = {
			var:militarists_faction_power > var:absolutists_faction_power
		}
		set_variable = { name = highest_faction_power value = var:militarists_faction_power }
		set_variable = { name = second_highest_faction_power value = var:absolutists_faction_power }
		random_participant_group = {
			limit = { participant_group_type = militarists }
			save_scope_as = strongest_faction
		}
		random_participant_group = {
			limit = { participant_group_type = absolutists }
			save_scope_as = second_strongest_faction
		}
	}
	else = {
		set_variable = { name = highest_faction_power value = var:absolutists_faction_power }
		set_variable = { name = second_highest_faction_power value = var:militarists_faction_power }
		random_participant_group = {
			limit = { participant_group_type = absolutists }
			save_scope_as = strongest_faction
		}
		random_participant_group = {
			limit = { participant_group_type = militarists }
			save_scope_as = second_strongest_faction
		}
	}

	## Check each remaining faction and update tracking variables
	# Uniformists
	if = {
		limit = { var:uniformists_faction_power > var:highest_faction_power }
		set_variable = { name = second_highest_faction_power value = var:highest_faction_power }
		scope:strongest_faction = {
			save_scope_as = second_strongest_faction
		}
		set_variable = { name = highest_faction_power value = var:uniformists_faction_power }
		random_participant_group = {
			limit = { participant_group_type = uniformists }
			save_scope_as = strongest_faction
		}
	}
	else_if = {
		limit = { var:uniformists_faction_power > var:second_highest_faction_power }
		set_variable = { name = second_highest_faction_power value = var:uniformists_faction_power }
		random_participant_group = {
			limit = { participant_group_type = uniformists }
			save_scope_as = second_strongest_faction
		}
	}
	# Pacifists
	if = {
		limit = { var:pacifists_faction_power > var:highest_faction_power }
		set_variable = { name = second_highest_faction_power value = var:highest_faction_power }
		scope:strongest_faction = {
			save_scope_as = second_strongest_faction
		}
		set_variable = { name = highest_faction_power value = var:pacifists_faction_power }
		random_participant_group = {
			limit = { participant_group_type = pacifists }
			save_scope_as = strongest_faction
		}
	}
	else_if = {
		limit = { var:pacifists_faction_power > var:second_highest_faction_power }
		set_variable = { name = second_highest_faction_power value = var:pacifists_faction_power }
		random_participant_group = {
			limit = { participant_group_type = pacifists }
			save_scope_as = second_strongest_faction
		}
	}
	# Provincialists
	if = {
		limit = { var:provincialists_faction_power > var:highest_faction_power }
		set_variable = { name = second_highest_faction_power value = var:highest_faction_power }
		scope:strongest_faction = {
			save_scope_as = second_strongest_faction
		}
		set_variable = { name = highest_faction_power value = var:provincialists_faction_power }
		random_participant_group = {
			limit = { participant_group_type = provincialists }
			save_scope_as = strongest_faction
		}
	}
	else_if = {
		limit = { var:provincialists_faction_power > var:second_highest_faction_power }
		set_variable = { name = second_highest_faction_power value = var:provincialists_faction_power }
		random_participant_group = {
			limit = { participant_group_type = provincialists }
			save_scope_as = second_strongest_faction
		}
	}
	# Pluralists
	if = {
		limit = { var:pluralists_faction_power > var:highest_faction_power }
		set_variable = { name = second_highest_faction_power value = var:highest_faction_power }
		scope:strongest_faction = {
			save_scope_as = second_strongest_faction
		}
		set_variable = { name = highest_faction_power value = var:pluralists_faction_power }
		random_participant_group = {
			limit = { participant_group_type = pluralists }
			save_scope_as = strongest_faction
		}
	}
	else_if = {
		limit = { var:pluralists_faction_power > var:second_highest_faction_power }
		set_variable = { name = second_highest_faction_power value = var:pluralists_faction_power }
		random_participant_group = {
			limit = { participant_group_type = pluralists }
			save_scope_as = second_strongest_faction
		}
	}
	# Dissolutionists
	if = {
		limit = { var:dissolutionists_faction_power > var:highest_faction_power }
		set_variable = { name = second_highest_faction_power value = var:highest_faction_power }
		scope:strongest_faction = {
			save_scope_as = second_strongest_faction
		}
		set_variable = { name = highest_faction_power value = var:dissolutionists_faction_power }
		random_participant_group = {
			limit = { participant_group_type = dissolutionists }
			save_scope_as = strongest_faction
		}
	}
	else_if = {
		limit = { var:dissolutionists_faction_power > var:second_highest_faction_power }
		set_variable = { name = second_highest_faction_power value = var:dissolutionists_faction_power }
		random_participant_group = {
			limit = { participant_group_type = dissolutionists }
			save_scope_as = second_strongest_faction
		}
	}
	# Centrists
	if = {
		limit = { var:centrists_faction_power > var:highest_faction_power }
		set_variable = { name = second_highest_faction_power value = var:highest_faction_power }
		scope:strongest_faction = {
			save_scope_as = second_strongest_faction
		}
		set_variable = { name = highest_faction_power value = var:centrists_faction_power }
		random_participant_group = {
			limit = { participant_group_type = centrists }
			save_scope_as = strongest_faction
		}
	}
	else_if = {
		limit = { var:centrists_faction_power > var:second_highest_faction_power }
		set_variable = { name = second_highest_faction_power value = var:centrists_faction_power }
		random_participant_group = {
			limit = { participant_group_type = centrists }
			save_scope_as = second_strongest_faction
		}
	}

	# Save the two dominant factions as variables on the situation
	set_variable = {
		name = strongest_faction
		value = scope:strongest_faction
	}
	set_variable = {
		name = second_strongest_faction
		value = scope:second_strongest_faction
	}

	# Clear the tracking variables (though these might be useful in gui perhaps, so might want to keep them)
	remove_variable	= highest_faction_power
	remove_variable	= second_highest_faction_power
}

# Update phase if dominant factions change - Scope: situation
update_admin_factions_situation_phase_effect = { # NEED TO UPDATE TO CONSIDER CENTRALISTS
	if = {
		limit = {
			OR = {
				var:strongest_faction = { participant_group_type = absolutists }
				var:second_strongest_faction = { participant_group_type = absolutists }
			}
			OR = {
				var:strongest_faction = { participant_group_type = uniformists }
				var:second_strongest_faction = { participant_group_type = uniformists }
			}
		}
		every_situation_sub_region = {
			change_phase = { phase = absolutist_uniformist }
		}
	}
	else_if = {
		limit = {
			OR = {
				var:strongest_faction = { participant_group_type = absolutists }
				var:second_strongest_faction = { participant_group_type = absolutists }
			}
			OR = {
				var:strongest_faction = { participant_group_type = militarists }
				var:second_strongest_faction = { participant_group_type = militarists }
			}
		}
		every_situation_sub_region = {
			change_phase = { phase = absolutist_militarist }
		}
	}
	else_if = {
		limit = {
			OR = {
				var:strongest_faction = { participant_group_type = absolutists }
				var:second_strongest_faction = { participant_group_type = absolutists }
			}
			OR = {
				var:strongest_faction = { participant_group_type = pacifists }
				var:second_strongest_faction = { participant_group_type = pacifists }
			}
		}
		every_situation_sub_region = {
			change_phase = { phase = absolutist_pacifist }
		}
	}
	else_if = {
		limit = {
			OR = {
				var:strongest_faction = { participant_group_type = absolutists }
				var:second_strongest_faction = { participant_group_type = absolutists }
			}
			OR = {
				var:strongest_faction = { participant_group_type = provincialists }
				var:second_strongest_faction = { participant_group_type = provincialists }
			}
		}
		every_situation_sub_region = {
			change_phase = { phase = absolutist_provincialist }
		}
	}
	else_if = {
		limit = {
			OR = {
				var:strongest_faction = { participant_group_type = absolutists }
				var:second_strongest_faction = { participant_group_type = absolutists }
			}
			OR = {
				var:strongest_faction = { participant_group_type = pluralists }
				var:second_strongest_faction = { participant_group_type = pluralists }
			}
		}
		every_situation_sub_region = {
			change_phase = { phase = absolutist_pluralist }
		}
	}
	else_if = {
		limit = {
			OR = {
				var:strongest_faction = { participant_group_type = uniformists }
				var:second_strongest_faction = { participant_group_type = uniformists }
			}
			OR = {
				var:strongest_faction = { participant_group_type = militarists }
				var:second_strongest_faction = { participant_group_type = militarists }
			}
		}
		every_situation_sub_region = {
			change_phase = { phase = uniformist_militarist }
		}
	}
	else_if = {
		limit = {
			OR = {
				var:strongest_faction = { participant_group_type = uniformists }
				var:second_strongest_faction = { participant_group_type = uniformists }
			}
			OR = {
				var:strongest_faction = { participant_group_type = pacifists }
				var:second_strongest_faction = { participant_group_type = pacifists }
			}
		}
		every_situation_sub_region = {
			change_phase = { phase = uniformist_pacifist }
		}
	}
	else_if = {
		limit = {
			OR = {
				var:strongest_faction = { participant_group_type = uniformists }
				var:second_strongest_faction = { participant_group_type = uniformists }
			}
			OR = {
				var:strongest_faction = { participant_group_type = provincialists }
				var:second_strongest_faction = { participant_group_type = provincialists }
			}
		}
		every_situation_sub_region = {
			change_phase = { phase = uniformist_provincialist }
		}
	}
	else_if = {
		limit = {
			OR = {
				var:strongest_faction = { participant_group_type = uniformists }
				var:second_strongest_faction = { participant_group_type = uniformists }
			}
			OR = {
				var:strongest_faction = { participant_group_type = pluralists }
				var:second_strongest_faction = { participant_group_type = pluralists }
			}
		}
		every_situation_sub_region = {
			change_phase = { phase = uniformist_pluralist }
		}
	}
	else_if = {
		limit = {
			OR = {
				var:strongest_faction = { participant_group_type = militarists }
				var:second_strongest_faction = { participant_group_type = militarists }
			}
			OR = {
				var:strongest_faction = { participant_group_type = pacifists }
				var:second_strongest_faction = { participant_group_type = pacifists }
			}
		}
		every_situation_sub_region = {
			change_phase = { phase = militarist_pacifist }
		}
	}
	else_if = {
		limit = {
			OR = {
				var:strongest_faction = { participant_group_type = militarists }
				var:second_strongest_faction = { participant_group_type = militarists }
			}
			OR = {
				var:strongest_faction = { participant_group_type = provincialists }
				var:second_strongest_faction = { participant_group_type = provincialists }
			}
		}
		every_situation_sub_region = {
			change_phase = { phase = militarist_provincialist }
		}
	}
	else_if = {
		limit = {
			OR = {
				var:strongest_faction = { participant_group_type = militarists }
				var:second_strongest_faction = { participant_group_type = militarists }
			}
			OR = {
				var:strongest_faction = { participant_group_type = pluralists }
				var:second_strongest_faction = { participant_group_type = pluralists }
			}
		}
		every_situation_sub_region = {
			change_phase = { phase = militarist_pluralist }
		}
	}
	else_if = {
		limit = {
			OR = {
				var:strongest_faction = { participant_group_type = pacifists }
				var:second_strongest_faction = { participant_group_type = pacifists }
			}
			OR = {
				var:strongest_faction = { participant_group_type = provincialists }
				var:second_strongest_faction = { participant_group_type = provincialists }
			}
		}
		every_situation_sub_region = {
			change_phase = { phase = pacifist_provincialist }
		}
	}
	else_if = {
		limit = {
			OR = {
				var:strongest_faction = { participant_group_type = pacifists }
				var:second_strongest_faction = { participant_group_type = pacifists }
			}
			OR = {
				var:strongest_faction = { participant_group_type = pluralists }
				var:second_strongest_faction = { participant_group_type = pluralists }
			}
		}
		every_situation_sub_region = {
			change_phase = { phase = pacifist_pluralist }
		}
	}
	else_if = {
		limit = {
			OR = {
				var:strongest_faction = { participant_group_type = provincialists }
				var:second_strongest_faction = { participant_group_type = provincialists }
			}
			OR = {
				var:strongest_faction = { participant_group_type = pluralists }
				var:second_strongest_faction = { participant_group_type = pluralists }
			}
		}
		every_situation_sub_region = {
			change_phase = { phase = provincialist_pluralist }
		}
	}
	else_if = {
		limit = {
			OR = {
				var:strongest_faction = { participant_group_type = dissolutionists }
				var:second_strongest_faction = { participant_group_type = dissolutionists }
			}
		}
		every_situation_sub_region = {
			change_phase = { phase = dissolutionist }
		}
	}
}

# Determines who should be the faction leader - Scope: situation_participant_group
set_faction_leader_effect = {
	ordered_situation_group_participant = {
		order_by = admin_factions_character_power_value
		scope:situation_participant_group = {
			set_variable = {
				name = faction_leader
				value = prev
			}
		}
	}
}

# Updates the Total Faction Power saved on a given Faction - Scope: situation_participant_group
update_faction_power_effect = {
	scope:situation = {
		set_variable = {
			name = faction_power
			value = participant_group_faction_power_value
		}
	}
}

# Updates Individual Faction Power - Scope: situation_participant_group
update_character_faction_power_individual_effect = {
	set_variable = {
		name = faction_power_individual
		value = admin_factions_character_power_value
	}
}

# Updates the saved character faction power - Scope: situation_participant_group
update_character_faction_power_effect = {
	update_character_faction_power_individual_effect = yes
	set_variable = {
		name = faction_power
		value = {
			add = {
				value = var:faction_power_individual
			}
		}
	}
}

# Updates Faction Power and Leader - Scope: character (requires saved situation_participant_group)
set_faction_leader_and_power_effect = {
	save_scope_as = char
	scope:situation = {
		#Grab the most powerful member to be faction leader
		ordered_in_list = { 
			variable = $PARTICIPANT_GROUP_NAME$_top_four
			max = 1
			order_by = {
				value = 0
				add = var:faction_power_individual
			}
			save_scope_as = faction_leader
		}
		set_variable = {
			name = $PARTICIPANT_GROUP_NAME$_faction_leader
			value = scope:faction_leader
		}

		#Set variable on situation of specific factions total power
		set_variable = {
			name = $PARTICIPANT_GROUP_NAME$_faction_power
			value = participant_group_faction_power_value
		}
	}
}

# Updates Faction Power and Leader - Scope: character (requires saved situation_participant_group)
set_top_four_faction_members_effect = {
	save_scope_as = char
	# Clear variable list on situation keeping track of the faction groups 
	scope:situation = { clear_variable_list = $PARTICIPANT_GROUP_NAME$_top_four }

	scope:situation_participant_group = {
		ordered_situation_group_participant = {
			limit = { #Block faction leader from getting added twice
				trigger_if = {
					limit = { scope:situation = { has_variable = $PARTICIPANT_GROUP_NAME$_faction_leader } }
					NOT = { this = scope:situation.var:$PARTICIPANT_GROUP_NAME$_faction_leader }
				}
			} 
			order_by = {
				value = 0
				add = admin_factions_character_power_value
			}
			max = 3
			check_range_bounds = no
			save_scope_as = char
			if = {
				limit = {
					scope:situation = { 
						trigger_if = {
							limit = { 
								any_in_list = {
									variable = $PARTICIPANT_GROUP_NAME$_top_four
									exists = this
								}
							}
							variable_list_size = { name = $PARTICIPANT_GROUP_NAME$_top_four value < 5 }
						}
					}
				}
				if = { #Check if faction leader needs to get added to the list
					limit = { 
						scope:situation = { 
							has_variable = $PARTICIPANT_GROUP_NAME$_faction_leader
							trigger_if = {
								limit = { 
									any_in_list = {
										variable = $PARTICIPANT_GROUP_NAME$_top_four
										exists = this
									}
								}
								NOT = {
									any_in_list = {
										variable = $PARTICIPANT_GROUP_NAME$_top_four
										exists = var:$PARTICIPANT_GROUP_NAME$_faction_leader
									}
								}
							}
						}
					}
					scope:situation = {
						add_to_variable_list = {
							name = $PARTICIPANT_GROUP_NAME$_top_four
							target = var:$PARTICIPANT_GROUP_NAME$_faction_leader
						}
					}
				}

				scope:situation = { #Add top 3 members that are _NOT_ faction leader
					add_to_variable_list = {
						name = $PARTICIPANT_GROUP_NAME$_top_four
						target = scope:char
					}
				}
			}
		}
	}
	lotr_sort_faction_members_effect = { PARTICIPANT_GROUP_NAME = $PARTICIPANT_GROUP_NAME$ }
}

# Sorts the top four members according to their individual power
lotr_sort_faction_members_effect = {
	scope:situation = {
		if = {
			limit = { 
				trigger_if = {
					limit = { 
						any_in_list = {
							variable = $PARTICIPANT_GROUP_NAME$_top_four
							exists = this
						}
					}
					variable_list_size = { name = $PARTICIPANT_GROUP_NAME$_top_four value > 0 }
				}
			}
			ordered_in_list = {
				variable = $PARTICIPANT_GROUP_NAME$_top_four
				max = 1
				order_by = {
					value = 0
					add = var:faction_power_individual
				}
				save_scope_as = char_1
			}
			if = {
				limit = { exists = scope:char_1 }
				remove_list_variable = {
					name = $PARTICIPANT_GROUP_NAME$_top_four
					target = scope:char_1
				}
			}
		}
		if = {
			limit = { 
				trigger_if = {
					limit = { 
						any_in_list = {
							variable = $PARTICIPANT_GROUP_NAME$_top_four
							exists = this
						}
					}
					variable_list_size = { name = $PARTICIPANT_GROUP_NAME$_top_four value > 0 }
				}
			}
			ordered_in_list = {
				variable = $PARTICIPANT_GROUP_NAME$_top_four
				max = 1
				order_by = {
					value = 0
					add = var:faction_power_individual
				}
				save_scope_as = char_2
			}
			if = {
				limit = { exists = scope:char_2 }
				remove_list_variable = {
					name = $PARTICIPANT_GROUP_NAME$_top_four
					target = scope:char_2
				}
			}
		}
		if = {
			limit = { 
				trigger_if = {
					limit = { 
						any_in_list = {
							variable = $PARTICIPANT_GROUP_NAME$_top_four
							exists = this
						}
					}
					variable_list_size = { name = $PARTICIPANT_GROUP_NAME$_top_four value > 0 }
				}
			}
			ordered_in_list = {
				variable = $PARTICIPANT_GROUP_NAME$_top_four
				max = 1
				order_by = {
					value = 0
					add = var:faction_power_individual
				}
				save_scope_as = char_3
			}
			if = {
				limit = { exists = scope:char_3 }
				remove_list_variable = {
					name = $PARTICIPANT_GROUP_NAME$_top_four
					target = scope:char_3
				}
			}
		}
		if = {
			limit = { 
				trigger_if = {
					limit = { 
						any_in_list = {
							variable = $PARTICIPANT_GROUP_NAME$_top_four
							exists = this
						}
					}
					variable_list_size = { name = $PARTICIPANT_GROUP_NAME$_top_four value > 0 }
				}
			}
			ordered_in_list = {
				variable = $PARTICIPANT_GROUP_NAME$_top_four
				max = 1
				order_by = {
					value = 0
					add = var:faction_power_individual
				}
				save_scope_as = char_4
			}
			if = {
				limit = { exists = scope:char_4 }
				remove_list_variable = {
					name = $PARTICIPANT_GROUP_NAME$_top_four
					target = scope:char_4
				}
			}
		}

		if = {
			limit = { exists = scope:char_1 }
			add_to_variable_list = {
				name = $PARTICIPANT_GROUP_NAME$_top_four
				target = scope:char_1
			}
		}
		if = {
			limit = { exists = scope:char_2 }
			add_to_variable_list = {
				name = $PARTICIPANT_GROUP_NAME$_top_four
				target = scope:char_2
			}
		}
		if = {
			limit = { exists = scope:char_3 }
			add_to_variable_list = {
				name = $PARTICIPANT_GROUP_NAME$_top_four
				target = scope:char_3
			}
		}
		if = {
			limit = { exists = scope:char_4 }
			add_to_variable_list = {
				name = $PARTICIPANT_GROUP_NAME$_top_four
				target = scope:char_4
			}
		}
	}
}

update_total_member_count_effect = {
	save_scope_as = char
	if = {
		limit = { $CHANGE$ = flag:positive }
		increase_variable = {
			NAME = $PARTICIPANT_GROUP_NAME$_member_count
			AMOUNT = 1
		}
	} else_if = {
		limit = { $CHANGE$ = flag:negative }
		decrease_variable = {
			NAME = $PARTICIPANT_GROUP_NAME$_member_count
			AMOUNT = 1
		}
	}
}