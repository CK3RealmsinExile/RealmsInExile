### ELVEN EFFECTS ###
define_elven_homelands = {
	##Greenwood
	title:e_greenwood = {
		every_de_jure_county = {
			add_county_modifier = elven_homeland_county_modifier
		}
	}

	##Lothlorien
	title:d_lorien = {
		every_de_jure_county = {
			add_county_modifier = elven_homeland_county_modifier
		}
	}
	title:d_iathglan = {
		every_de_jure_county = {
			add_county_modifier = elven_homeland_county_modifier
		}
	}

	##Nelornieth
	title:d_nimbregardh = {
		every_de_jure_county = {
			add_county_modifier = elven_homeland_county_modifier
		}
	}
	title:d_dor_banath = {
		every_de_jure_county = {
			add_county_modifier = elven_homeland_county_modifier
		}
	}
	title:d_naergurthardh = {
		every_de_jure_county = {
			add_county_modifier = elven_homeland_county_modifier
		}
	}

	##Gondor
	title:c_edhellond = {
		add_county_modifier = elven_homeland_county_modifier
	}

	##Suza Sumar
	title:d_suza_sumar = {
		every_de_jure_county = {
			add_county_modifier = elven_homeland_county_modifier
		}
	}

	## Imladris
	title:e_orrostar = {
		every_de_jure_county = {
			add_county_modifier = elven_homeland_county_modifier
		}
	}

	# Lindon
	title:e_lindon = {
		every_de_jure_county = {
			add_county_modifier = elven_homeland_county_modifier
		}
	}

	# Drel
	title:d_chelayana = {
		every_de_jure_county = {
			add_county_modifier = elven_homeland_county_modifier
		}
	}
	title:d_cuindore = {
		every_de_jure_county = {
			add_county_modifier = elven_homeland_county_modifier
		}
	}
	title:d_galadartaure = {
		every_de_jure_county = {
			add_county_modifier = elven_homeland_county_modifier
		}
	}

	#c_baranagath
	title:c_baranagath = {
		add_county_modifier = elven_homeland_county_modifier
	}

	#Kinn-Lai Usakan
	title:d_gard_kinn = {
		every_de_jure_county = {
			add_county_modifier = elven_homeland_county_modifier
		}
	}

	title:d_unnalgald = {
		every_de_jure_county = {
			add_county_modifier = elven_homeland_county_modifier
		}
	}
	
	# Kinn-Lai Mumakan
	title:d_ulador = {
		every_de_jure_county = {
			add_county_modifier = elven_homeland_county_modifier
		}
	}

	title:d_tauldol = {
		every_de_jure_county = {
			add_county_modifier = elven_homeland_county_modifier
		}
	}

	title:c_etedor = {
		add_county_modifier = elven_homeland_county_modifier
	}

	title:c_miliglat = {
		add_county_modifier = elven_homeland_county_modifier
	}

	title:c_ankil = {
		add_county_modifier = elven_homeland_county_modifier
	}
}

initialise_elven_holdings = {
	every_county = {
		limit = {
			holder = {
				is_ai = no
				is_elf = yes
			}
		}
		set_county_culture = holder.culture
		set_county_faith = holder.faith
		every_province = {
			limit = { county = prev }
			if = {
				limit = {
					has_holding = yes
					NOT = { has_holding_type = elven_holding }
				}
				set_holding_type = elven_holding
			}
			if = {
				limit = { barony.holder = { NOT = { is_elf = yes } } }
				create_character = {
					gender = male
					age = { 120 7030 }
					culture = root.culture
					faith = root.faith
					save_scope_as = new_holder
					location = barony.holder.location
				}
				barony = {
					create_title_and_vassal_change = {
						type = usurped
						save_scope_as = change
						add_claim_on_loss = no
					}
					change_title_holder = {
						holder = scope:new_holder
						change = scope:change
					}
					resolve_title_and_vassal_change = scope:change
				}
			}
		}
	}
}

convert_elven_holdings_effect = { #naugrim04
	every_sub_realm_county = {
		limit = {
			holder = {
				is_elf = yes
			}
		}
		set_county_culture = holder.culture
		set_county_faith = holder.faith
		every_province = {
			limit = { county = prev }
			if = {
				limit = {
					has_holding = yes
					NOT = { has_holding_type = elven_holding }
				}
				set_holding_type = elven_holding
			}
			if = {
				limit = { barony.holder = { NOT = { is_elf = yes } } }
				create_character = {
					gender = male
					age = { 120 7030 }
					culture = root.culture
					faith = root.faith
					save_scope_as = new_holder
					location = barony.holder.location
				}
				barony = {
					create_title_and_vassal_change = {
						type = usurped
						save_scope_as = change
						add_claim_on_loss = no
					}
					change_title_holder = {
						holder = scope:new_holder
						change = scope:change
					}
					resolve_title_and_vassal_change = scope:change
				}
			}
		}
	}
	every_sub_realm_barony = {
		limit = { 
			is_leased_out = yes
		}
		revoke_lease = yes
	}
	change_government = elven_government
}

vanquish_darkness_generate_new_holder_culture_and_faith = { #In Title Scope
	title_capital_county = { # Effects fire in county scope
		generate_new_good_faith = yes
		generate_new_good_culture = yes
	}
	scope:new_faith = {
		save_scope_as = holder_faith
	}
	scope:new_culture = {
		save_scope_as = holder_culture
	}
}

generate_new_good_faith = { # Fires from county scope, generates scope:new_faith
	if = { #Leofrings convert to Fey Court
		limit = {
			OR = {
				culture = culture:leofring 
				culture = { any_parent_culture_or_above = { this = culture:leofring } }
			}
		}
		faith:faith_fey_court = { save_scope_as = new_faith }
	}
	else_if = { #Framlings convert to Liffrea
		limit = {
			OR = {
				culture = culture:framling 
				culture = { any_parent_culture_or_above = { this = culture:framling } }
			}
		}
		faith:faith_framling = { save_scope_as = new_faith }
	}
	else_if = { #Dalringi convert to Celdunic
		limit = {
			OR = {
				culture = culture:dalemen 
				culture = { any_parent_culture_or_above = { this = culture:dalemen } }
			}
		}
		faith:faith_dale = { save_scope_as = new_faith }
	}
	else_if = { #Dorwinrim convert to Aldenan
		limit = {
			OR = {
				culture = culture:dorwinionrim 
				culture = { any_parent_culture_or_above = { this = culture:dorwinionrim } }
			}
		}
		faith:faith_dorwinion = { save_scope_as = new_faith }
	}
	else_if = { #Logath convert to Dasimayai
		limit = {
			OR = {
				culture = culture:logath 
				culture = { any_parent_culture_or_above = { this = culture:logath } }
			}
		}
		faith:faith_logath = { save_scope_as = new_faith }
	}
	else_if = { #Mardrukan convert to Kolir
		limit = {
			OR = {
				culture = culture:mardrukan 
				culture = { any_parent_culture_or_above = { this = culture:mardrukan } }
			}
		}
		faith:faith_kolir = { save_scope_as = new_faith }
	}
	else_if = { #Felayan convert to Path of Wisdom
		limit = {
			OR = {
				culture = culture:felayan 
				culture = { any_parent_culture_or_above = { this = culture:felayan } }
			}
		}
		faith:faith_path_of_wisdom = { save_scope_as = new_faith }
	}
	else_if = { #Honin convert to Onu
		limit = {
			OR = {
				culture = culture:honnin 
				culture = { any_parent_culture_or_above = { this = culture:honnin } }
			}
		}
		faith:faith_honnin = { save_scope_as = new_faith }
	}
	else_if = { #Chaialla Chaialla Chaialla
		limit = { 
			OR = {
				culture = culture:chaialla 
				culture = { any_parent_culture_or_above = { this = culture:chaialla } }
			}
		}
		faith:faith_chaialla = { save_scope_as = new_faith }
	}
	else_if = { #Bellakarani convert to Eruben
		limit = {
			culture = { is_hybrid_culture = no } #To account for their "Conservative Eruism"
			OR = {
				culture = culture:bellakarani 
				culture = { any_parent_culture_or_above = { this = culture:bellakarani } }
			}
		}
		faith:faith_conservative_eruism = { save_scope_as = new_faith }
	}
	else_if = { #Jelut convert to Nade-Manye
		limit = {
			OR = {
				culture = culture:jelut 
				culture = { any_parent_culture_or_above = { this = culture:jelut } }
			}
		}
		faith:faith_chelkar = { save_scope_as = new_faith }
	}
	else_if = { #Lom'chy convert to Uzdava
		limit = {
			OR = {
				culture = culture:lomchy 
				culture = { any_parent_culture_or_above = { this = culture:lomchy } }
			}
		}
		faith:faith_uzdava = { save_scope_as = new_faith }
	}
	else_if = { #Woodmen and Valemen convert to Widumannas
		limit = {
			OR = {
				culture = culture:woodmen 
				culture = { any_parent_culture_or_above = { this = culture:woodmen } }
			}
		}
		faith:faith_woodmen = { save_scope_as = new_faith }
	}
	else_if = { #Enedhwaithrim and Saralain convert to Mordhamoraire
		limit = {
			OR = {
				culture = culture:enedhwaithrim 
				culture = { any_parent_culture_or_above = { this = culture:enedhwaithrim } }
			}
		}
		faith:faith_saralain = { save_scope_as = new_faith }
	}
	else_if = { #Lynerians and Danak convert to Markur
		limit = {
			OR = {
				culture = culture:lynerian 
				culture = { any_parent_culture_or_above = { this = culture:lynerian } }
				culture = culture:danak 
				culture = { any_parent_culture_or_above = { this = culture:danak } }
			}
		}
		faith:faith_markur = { save_scope_as = new_faith }
	}
	else_if = { #Usukani and Sederi conver to Ascuru Hudari
		limit = {
			OR = {
				culture = culture:usakani
				culture = {  any_parent_culture_or_above = { this = culture:usakani } }
			}
		}
		faith:faith_sederi = { save_scope_as = new_faith } 
	}
	else_if = { #Hybrid Northman and Easterling convert to Phaon Afod
		limit = {
			culture = { is_hybrid_culture = yes } 
			AND = {
				culture = { 
					any_parent_culture = { 
						this = { 
							OR = {
								has_cultural_pillar = heritage_ioriag 
								has_cultural_pillar = heritage_igath 
								has_cultural_pillar = heritage_north_khailuza
							} 
						} 
					} 
				}
				culture = { 
					any_parent_culture = { 
						this = { 
							OR = {
								has_cultural_pillar = heritage_northron 
								has_cultural_pillar = heritage_eotheod 
							} 
						} 
					} 
				}
			}
			#Variags are the exception, Araw makes more sense for them
			NOT = { culture = culture:variag }
		}
		faith:faith_phaon_afod = { save_scope_as = new_faith }
	}
	else_if = { #Northern Adunaic Heritage
		limit = { 
			culture = { has_cultural_pillar = heritage_northern_adunaic }
		}
		faith:faith_kolir = { save_scope_as = new_faith }
	}
	else_if = { #Southern Adunaic Heritage
		limit = {
			culture = { has_cultural_pillar = heritage_southern_adunaic }
		}
		faith:faith_gimileth = { save_scope_as = new_faith }
	}
	else_if = { #Baradhrim Heritage
		limit = {
			culture = { has_cultural_pillar = heritage_baradhrim }
		}
		faith:faith_westward_waves = { save_scope_as = new_faith }
	}
	else_if = { #Bellakari Heritage
		limit = {
			culture = { has_cultural_pillar = heritage_bellakari }
		}
		faith:faith_infinite_wisdom = { save_scope_as = new_faith }
	}
	else_if = { #Daen Lintis Heritage
		limit = {
			culture = { has_cultural_pillar = heritage_daen_lintis }
		}
		faith:faith_dunlending_turthalis = { save_scope_as = new_faith }
	}
	else_if = { #Daen Coentis Heritage
		limit = {
			culture = { has_cultural_pillar = heritage_daen_coentis }
		}
		faith:faith_daen_coentis = { save_scope_as = new_faith }
	}
	else_if = { #Danan Lin Heritage
		limit = {
			culture = { has_cultural_pillar = heritage_danan_lin }
		}
		faith:faith_nurn_good = { save_scope_as = new_faith }
	}
	else_if = { #Druedain Heritage
		limit = {
			culture = { has_cultural_pillar = heritage_druedain }
		}
		faith:faith_druedain = { save_scope_as = new_faith }
	}
	else_if = { #Dunadain Heritage
		limit = {
			culture = { has_cultural_pillar = heritage_dunedain }
		}
		faith:faith_edain = { save_scope_as = new_faith }
	}
	else_if = { #Firebeard and Broadbeam Heritage
		limit = {
			OR = {
				culture = { has_cultural_pillar = heritage_firebeard }  
				culture = { has_cultural_pillar = heritage_broadbeam } 
			}
		}
		 
		faith:faith_broadbeams = { save_scope_as = new_faith }
	}
	else_if = { #Blacklocks Nargubraz Culture
		limit = { 
			OR = {
				culture = culture:blacklocks_nargubraz 
				culture = { any_parent_culture_or_above = { this = culture:blacklocks_nargubraz } }
			}
		}
		 
		faith:faith_blacklocks = { save_scope_as = new_faith }
	}
	else_if = { #Blacklock and Stonefoot Heritage
		limit = {
			OR = {
				culture = { has_cultural_pillar = heritage_blacklock } 
				culture = { has_cultural_pillar = heritage_stonefoot } 
			}
		}
		faith:faith_eastern_khazad = { save_scope_as = new_faith }
	}
	else_if = { #Stiffbeard Heritage
		limit = {
			culture = { has_cultural_pillar = heritage_stiffbeard }
		}
		faith:faith_stiffbeards = { save_scope_as = new_faith }
	}
	else_if = { #Ironfist Heritage
		limit = {
			culture = { has_cultural_pillar = heritage_ironfist }
		}
		faith:faith_ironfists = { save_scope_as = new_faith }
	}
	else_if = { #Longbeard and other Dwarves falback
		limit = {
			culture = { is_dwarf_culture = yes }
		}
		faith:faith_khazad = { save_scope_as = new_faith }
	}
	else_if = { #Ioriag, Igath and North Khailuza Heritage
		limit = {
			OR = {
				culture = { has_cultural_pillar = heritage_ioriag }
				culture = { has_cultural_pillar = heritage_igath } 
				culture = { has_cultural_pillar = heritage_north_khailuza }
			}
		}
		faith:faith_rhun_araw_triumvirate = { save_scope_as = new_faith }
	}
	else_if = { #Tedjin Heritage
		limit = {
			culture = { has_cultural_pillar = heritage_tedjin }
		}
		faith:faith_path_of_wisdom = { save_scope_as = new_faith }
	}
	else_if = { #Hobbits and Breemen
		limit = {
			OR = {
				culture = { has_cultural_pillar = heritage_eriadorim } # Adjust when Eriadorrim faith made
				culture = { has_cultural_pillar = heritage_periannath }
			}
		}
		faith:faith_hobbit = { save_scope_as = new_faith }
	}
	else_if = { #Bozishnarudi, Arani and Tulwangi Heritage
		limit = {
			OR = {
				culture = { has_cultural_pillar = heritage_middle_apysaic }
				culture = { has_cultural_pillar = heritage_southern_apysaic }
				culture = { has_cultural_pillar = heritage_tulwangi }
			}
		} 
		faith:faith_iunast = { save_scope_as = new_faith }
	}
	else_if = { #Harwani Heritage
		limit = {
			culture = { has_cultural_pillar = heritage_northern_apysaic }
		}
		faith:faith_chelkar = { save_scope_as = new_faith }
	}
	else_if = { #Mayitu Heritage
		limit = {
			culture = { has_cultural_pillar = heritage_thani_native }
		}
		faith:faith_good_pel = { save_scope_as = new_faith }
	}
	else_if = { #Noi Trevan Heritage
		limit = {
			culture = { has_cultural_pillar = heritage_hillmen }
		}
		faith:faith_westmen = { save_scope_as = new_faith }
	}
	else_if = { #Magrin Heritage
		limit = {
			culture = { has_cultural_pillar = heritage_magri }
		}
		faith:faith_good_pel = { save_scope_as = new_faith } #No native Magrin good faiths
	}
	else_if = { #Geshen Heritage
		limit = {
			culture = {  has_cultural_pillar = heritage_geshan  }
		}
		faith:faith_tyar = { save_scope_as = new_faith } 
	}
	else_if = { #Mumakani, Kirani, Hathorim, and Shayn Heritage
		limit = {
			OR = {
				culture = { has_cultural_pillar = heritage_mumakani }
				culture = { has_cultural_pillar = heritage_kirani }
				culture = { has_cultural_pillar = heritage_shayn } # Really need to find closer
				culture = { has_cultural_pillar = heritage_hathorim }
				culture = { has_cultural_pillar = heritage_sare } # TEMP until Archipelago
			}
		}
		faith:faith_koronande = { save_scope_as = new_faith }
	}
	else_if = { #Eotheod Heritage
		limit = {
			culture = { has_cultural_pillar = heritage_eotheod }
		}
		faith:faith_rohirric = { save_scope_as = new_faith }
	}
	else_if = { #Northmen Heritage
		limit = {
			culture = { has_cultural_pillar = heritage_northron }
		}
		faith:faith_northmen = { save_scope_as = new_faith }
	}
	else_if = { #South Khailuza Heritage
		limit = {
			culture = { has_cultural_pillar = heritage_south_khailuza }
		}
		faith:faith_arienism = { save_scope_as = new_faith }
	}
	else_if = { #Harshandatti Heritage
		limit = {
			culture = { has_cultural_pillar = heritage_harshandatt }
		}
		faith:faith_saath = { save_scope_as = new_faith }
	}
	else_if = { #Siryani Heritage
		limit = {
			culture = { has_cultural_pillar = heritage_new_sirayni }
		}
		faith:faith_markur = { save_scope_as = new_faith }
	}
	else_if = { #Narne Heritage
		limit = {
			culture = { has_cultural_pillar = heritage_elinse }
		}
		faith:faith_iarandel = { save_scope_as = new_faith }
	}
	else_if = { #Womawrin Heritage
		limit = {
			culture = { has_cultural_pillar = heritage_womaw }
		}
		faith:faith_iarandel = { save_scope_as = new_faith } #Replace when Womaw added
	}

	#Fallback for any heritages missed and for Orcs and Goblins (only works for county scope)
	#Underground first for surface races don't get it.
	else_if = { # Misty, Iron and White Mountains
		limit = { 
			OR = {
				empire = title:e_misty_mountains 
				empire = title:e_iron_mountains
				empire = title:e_white_mountains
			}
		}
		faith:faith_khazad = { save_scope_as = new_faith }
	}
	else_if = { # Nogrod/Belegost
	# Assigned the Blue Mountains by kingdom
		limit = { 
			OR = {
				kingdom = title:k_belegost
				kingdom = title:k_nogrod 
			}
		}
		faith:faith_broadbeams = { save_scope_as = new_faith }
	}
	else_if = { # Buzra-dum
		limit = {
			kingdom = title:k_buzra_dum
		}
		faith:faith_firebeards = { save_scope_as = new_faith }
	}
	else_if = { # Yellow, Western Yellow
		limit = { 
			OR = {
				empire = title:e_yellow_mountains
				empire = title:e_western_yellow_mountains
			}
		}
		faith:faith_blacklocks = { save_scope_as = new_faith }
	}
	else_if = { #Nurunkhizdin
		limit = {
			kingdom = title:k_nurunkizdin
		}
		faith:faith_ironfists = { save_scope_as = new_faith	}
	}
	else_if = { # Gondor
		limit = {
			OR = {
				empire = title:e_gondor_steward
				empire = title:e_gondor
				empire = title:e_castamir
			}
		}
		faith:faith_edain = { save_scope_as = new_faith }
	}
	else_if = { #Arnor or Orrostar or Lindon
		limit = { 
			OR = {
				empire = title:e_arnor
				empire = title:e_orrostar
				empire = title:e_lindon
			}
		}
		faith:faith_edain = { save_scope_as = new_faith }
	}
	else_if = { #Calenardhon
		limit = { empire = title:e_calenardhon } # Adjust when Rise of Angmar added
		faith:faith_rohirric = { save_scope_as = new_faith }
	}
	else_if = { # Enedhwaith
		limit = { empire = title:e_enedhwaith }
		faith:faith_dunlending_turthalis = { save_scope_as = new_faith }
	}
	else_if = { # Lothlorien/Greenwood
		limit = {
			OR = {
				empire = title:e_laurelindorenan
				empire = title:e_greenwood
			}
		}
		faith:faith_woodmen = { save_scope_as = new_faith }
	}
	else_if = { # Anduin Vale
		limit = { empire = title:e_anduin_vale }
		faith:faith_woodmen = { save_scope_as = new_faith }
	}
	else_if = { # Rhovanion
		limit = { empire = title:e_rhovanion }
		faith:faith_northmen = { save_scope_as = new_faith }
	}
	else_if = { # Rhun
		limit = { empire = title:e_rhun }
		faith:faith_rhun_araw_triumvirate = { save_scope_as = new_faith }
	}
	else_if = { # Mordor
		limit = { empire = title:e_mordor }
		faith:faith_nurn_good = { save_scope_as = new_faith }
	}
	else_if = { # Khand
		limit = { empire = title:e_khand }
		faith:faith_rhun_araw_triumvirate = { save_scope_as = new_faith }
	}
	else_if = { # Haradwaith
		limit = { empire = title:e_haradwaith }
		faith:faith_chelkar = { save_scope_as = new_faith }
	}
	else_if = { # Dune Sea
		limit = { empire = title:e_dune_sea }
		faith:faith_iunast = { save_scope_as = new_faith }
	}
	else_if = { # Umbar
		limit = { empire = title:e_umbar }
		faith:faith_edain = { save_scope_as = new_faith }
	}
	else_if = { # Bellakar
		limit = { empire = title:e_bellakar }
		faith:faith_infinite_wisdom = { save_scope_as = new_faith }
	}
	else_if = { # Bozisha-Miraz
		limit = { empire = title:e_bozisha_miraz }
		faith:faith_iunast = { save_scope_as = new_faith }
	}
	else_if = { # Thani-Hazad
		limit = { empire = title:e_thani_hazad }
		faith:faith_gimileth = { save_scope_as = new_faith }
	}
	else_if = { # Mag Tumag
		limit = { empire = title:e_mag_tumag }
		faith:faith_good_pel = { save_scope_as = new_faith } #No Magrin good faiths
	}
	else_if = { # Usakan
		limit = { empire = title:e_usakan }
		faith:faith_sederi = { save_scope_as = new_faith }
	}
	else_if = { # Forodwaith
		limit = { empire = title:e_forodwaith }
		faith:faith_westward_waves = { save_scope_as = new_faith }
	}		
	else_if = { # Sirayn
		limit = {empire = title:e_sirayn}
		faith:faith_markur = { save_scope_as = new_faith }
	}
	else_if = { # Harshandatt
		limit = {empire = title:e_harshandatt}
		faith:faith_saath = { save_scope_as = new_faith }
	}
	else_if = { # Khy
		limit = {empire = title:e_khy}
		faith:faith_arienism = { save_scope_as = new_faith }
	}
	else_if = { # Shayn
		limit = {empire = title:e_shayn}
		faith:faith_markur = { save_scope_as = new_faith } # Replace when Mumakan added
	}
	else = { #Fallback of the Fallback
		faith:faith_edain = { save_scope_as = new_faith }
	}
}

generate_new_good_culture = { # Fires from county scope, generates scope:new_culture
	if = { # Non-orcs and non-immortals keep their culture. (Humans, Dwarves, Elves, etc)
		limit = {
			culture = {
				NOT = {
					is_orc_culture = yes
					is_maiar_culture = yes
					is_undead_culture = yes
					is_wastelands_culture = yes
				}
			}
		}
		culture = { save_scope_as = new_culture }
	}
	# Underground
	else_if = { # Misty, Iron and White Mountains
		limit = { 
			OR = {
				empire = title:e_misty_mountains 
				empire = title:e_iron_mountains
				empire = title:e_white_mountains
			}
		}
		culture:longbeards = { save_scope_as = new_culture }
	}
	# Assigned the Blue mountains by kingdom
	else_if = { # Nogrod/Belegost
		limit = { 
			OR = {
				kingdom = title:k_belegost
				kingdom = title:k_nogrod 
			}
		}
		culture:broadbeams = { save_scope_as = new_culture }
	}
	else_if = { # Buzra-dum
		limit = {
			kingdom = title:k_buzra_dum
		}
		culture:firebeards = { save_scope_as = new_culture }
	}
	else_if = { # Yellow, Western Yellow
		limit = { 
			OR = {
				empire = title:e_yellow_mountains
				empire = title:e_western_yellow_mountains
			}
		}
		culture:blacklocks = { save_scope_as = new_culture }
	}
	else_if = { #Nurunkhizdin
		limit = {
			kingdom = title:k_nurunkizdin
		}
		culture:ironfists = { save_scope_as = new_culture }
	}
	else_if = { #Underground fallback
		limit = {
			is_underground_county = yes
		}
		culture:longbeards = { save_scope_as = new_culture }
	}
	else_if = { #Mordor Nurnoth assigned manually, otherwise it will generate Nurniags due to proximity
		limit = {
			empire = title:e_mordor
		}
		culture:nurnoth = { save_scope_as = new_culture }
	}
	# Assign local culture based on proximity
	else_if = {
		limit = {
			any_neighboring_county = {
				NOR = {
					is_orc = yes
					is_elf = yes
					is_wastelands = yes
				}
			}
		}
		random_neighboring_county = {
			limit = {
				NOR = {
					is_orc = yes
					is_elf = yes
					is_wastelands = yes
				}
			}
			culture = { save_scope_as = new_culture }
		}
	}
	else_if = { # Check de jure duchy
		limit = {
			duchy = {
				any_de_jure_county = {
					NOR = {
						is_orc = yes
						is_elf = yes
						is_wastelands = yes
					}
				}
			}
		}
		duchy = {
			ordered_de_jure_county = {
				order_by = development_level
				limit = {
					NOR = {
						is_orc = yes
						is_elf = yes
						is_wastelands = yes
					}
				}
				culture = { save_scope_as = new_culture }
			}
		}
	}
	else_if = { # Check de jure kingdom
		limit = {
			kingdom = {
				any_de_jure_county = {
					NOR = {
						is_orc = yes
						is_elf = yes
						is_wastelands = yes
					}
				}
			}
		}
		kingdom = {
			ordered_de_jure_county = {
				order_by = development_level
				limit = {
					NOR = {
						is_orc = yes
						is_elf = yes
						is_wastelands = yes
					}
				}
				culture = { save_scope_as = new_culture }
			}
		}
	}
	else_if = { # Check de jure empire
		limit = {
			empire = {
				any_de_jure_county = {
					NOR = {
						is_orc = yes
						is_elf = yes
						is_wastelands = yes
					}
				}
			}
		}
		empire = {
			ordered_de_jure_county = {
				order_by = development_level
				limit = {
					NOR = {
						is_orc = yes
						is_elf = yes
						is_wastelands = yes
					}
				}
				culture = { save_scope_as = new_culture }
			}
		}
	}
	else = { #Fallback of the Fallback
		culture:gondorian = { save_scope_as = new_culture }
	}
}

vanquish_darkness_convert_specific_county = { # Fires from county scope. Converts any non-holder cultured counties to their relevant faith
	generate_new_good_faith = yes
	set_county_faith = scope:new_faith
}

dynasty_legacy_of_oropher_effects = {
	dynasty = {
		add_dynasty_modifier = {
			modifier = legacy_of_oropher_modifier
		}
		custom_tooltip = legacy_of_oropher_conversion_bonus
		add_dynasty_prestige = excessive_dynasty_prestige_gain
	}
}

dynasty_light_of_the_forest = {
	dynasty = {
		add_dynasty_modifier = {
			modifier = light_of_the_forest_modifier
			years = 50
		}
		add_dynasty_prestige = excessive_dynasty_prestige_gain
	}
}

add_new_elf_friendly_trait = {
	random_list = {
		1 = {
			trigger = {
				NOR = {
					has_trait = brave
					has_trait = craven
				}
			}
			add_trait = brave
		}
		1 = {
			trigger = {
				NOR = {
					has_trait = brave
					has_trait = craven
				}
			}
			add_trait = craven
		}

		1 = {
			trigger = {
				NOR = {
					has_trait = calm
					has_trait = wrathful
				}
			}
			add_trait = calm
		}

		1 = {
			trigger = {
				NOR = {
					has_trait = chaste
					has_trait = lustful
				}
			}
			add_trait = chaste
		}

		1 = {
			trigger = {
				NOR = {
					has_trait = ambitious
					has_trait = content
				}
			}
			add_trait = content
		}
		1 = {
			trigger = {
				NOR = {
					has_trait = ambitious
					has_trait = content
				}
			}
			add_trait = ambitious
		}

		1 = {
			trigger = {
				NOR = {
					has_trait = diligent
					has_trait = lazy
				}
			}
			add_trait = diligent
		}
		1 = {
			trigger = {
				NOR = {
					has_trait = diligent
					has_trait = lazy
				}
			}
			add_trait = lazy
		}

		1 = {
			trigger = {
				NOR = {
					has_trait = fickle
					has_trait = stubborn
					has_trait = eccentric
				}
			}
			add_trait = fickle
		}
		1 = {
			trigger = {
				NOR = {
					has_trait = fickle
					has_trait = stubborn
					has_trait = eccentric
				}
			}
			add_trait = stubborn
		}
		1 = {
			trigger = {
				NOR = {
					has_trait = fickle
					has_trait = stubborn
					has_trait = eccentric
				}
			}
			add_trait = eccentric
		}

		1 = {
			trigger = {
				NOR = {
					has_trait = forgiving
					has_trait = vengeful
				}
			}
			add_trait = forgiving
		}
		1 = {
			trigger = {
				NOR = {
					has_trait = forgiving
					has_trait = vengeful
				}
			}
			add_trait = vengeful
		}

		1 = {
			trigger = {
				NOR = {
					has_trait = generous
					has_trait = greedy
				}
			}
			add_trait = generous
		}
		1 = {
			trigger = {
				NOR = {
					has_trait = generous
					has_trait = greedy
				}
			}
			add_trait = greedy
		}

		1 = {
			trigger = {
				NOR = {
					has_trait = gregarious
					has_trait = shy
				}
			}
			add_trait = gregarious
		}
		1 = {
			trigger = {
				NOR = {
					has_trait = gregarious
					has_trait = shy
				}
			}
			add_trait = shy
		}

		1 = {
			trigger = {
				NOR = {
					has_trait = honest
					has_trait = deceitful
				}
			}
			add_trait = honest
		}

		1 = {
			trigger = {
				NOR = {
					has_trait = humble
					has_trait = arrogant
				}
			}
			add_trait = humble
		}
		1 = {
			trigger = {
				NOR = {
					has_trait = humble
					has_trait = arrogant
				}
			}
			add_trait = arrogant
		}

		1 = {
			trigger = {
				NOR = {
					has_trait = just
					has_trait = arbitrary
				}
			}
			add_trait = just
		}
		1 = {
			trigger = {
				NOR = {
					has_trait = just
					has_trait = arbitrary
				}
			}
			add_trait = arbitrary
		}

		1 = {
			trigger = {
				NOR = {
					has_trait = patient
					has_trait = impatient
				}
			}
			add_trait = patient
		}
		1 = {
			trigger = {
				NOR = {
					has_trait = patient
					has_trait = impatient
				}
			}
			add_trait = impatient
		}

		1 = {
			trigger = {
				NOR = {
					has_trait = temperate
					has_trait = gluttonous
				}
			}
			add_trait = temperate
		}

		1 = {
			trigger = {
				NOR = {
					has_trait = trusting
					has_trait = paranoid
				}
			}
			add_trait = trusting
		}
		1 = {
			trigger = {
				NOR = {
					has_trait = trusting
					has_trait = paranoid
				}
			}
			add_trait = paranoid
		}

		1 = {
			trigger = {
				NOR = {
					has_trait = zealous
					has_trait = cynical
				}
			}
			add_trait = zealous
		}

		1 = {
			trigger = {
				NOR = {
					has_trait = compassionate
					has_trait = callous
					has_trait = sadistic
				}
			}
			add_trait = compassionate
		}
		1 = {
			trigger = {
				NOR = {
					has_trait = compassionate
					has_trait = callous
					has_trait = sadistic
				}
			}
			add_trait = callous
		}
	}
}

replace_unelven_traits = {
	### Deformities
	if = {
		limit = { has_trait = bleeder }
		remove_trait = bleeder
	}
	if = {
		limit = { has_trait = clubfooted }
		remove_trait = clubfooted
	}
	if = {
		limit = { has_trait = hunchbacked }
		remove_trait = hunchbacked
	}
	if = {
		limit = { has_trait = scaly }
		remove_trait = scaly
	}
	if = {
		limit = { has_trait = spindly }
		remove_trait = spindly
	}
	if = {
		limit = { has_trait = wheezing }
		remove_trait = wheezing
	}
	### Illnesses
	if = {
		limit = { has_trait = sickly }
		remove_trait = sickly
	}
	if = {
		limit = { has_trait = bubonic_plague }
		remove_trait = bubonic_plague
	}
	if = {
		limit = { has_trait = cancer }
		remove_trait = cancer
	}
	if = {
		limit = { has_trait = consumption }
		remove_trait = consumption
	}
	if = {
		limit = { has_trait = dysentery }
		remove_trait = dysentery
	}
	if = {
		limit = { has_trait = ergotism }
		remove_trait = ergotism
	}
	if = {
		limit = { has_trait = gout_ridden }
		remove_trait = gout_ridden
	}
	if = {
		limit = { has_trait = great_pox }
		remove_trait = great_pox
	}
	if = {
		limit = { has_trait = leper }
		remove_trait = leper
	}
	if = {
		limit = { has_trait = lovers_pox }
		remove_trait = lovers_pox
	}
	if = {
		limit = { has_trait = measles }
		remove_trait = measles
	}
	if = {
		limit = { has_trait = pneumonic }
		remove_trait = pneumonic
	}
	if = {
		limit = { has_trait = smallpox }
		remove_trait = smallpox
	}
	if = {
		limit = { has_trait = typhus }
		remove_trait = typhus
	}

	### Personality Traits
	if = {
		limit = { has_trait = deceitful }
		remove_trait = deceitful
		add_new_elf_friendly_trait = yes
	}
	if = {
		limit = { has_trait = lustful }
		remove_trait = lustful
		add_new_elf_friendly_trait = yes
	}
	if = {
		limit = { has_trait = gluttonous }
		remove_trait = gluttonous
		add_new_elf_friendly_trait = yes
	}
	if = {
		limit = { has_trait = cynical }
		remove_trait = cynical
		add_new_elf_friendly_trait = yes
	}
	if = {
		limit = { has_trait = sadistic }
		remove_trait = sadistic
		add_new_elf_friendly_trait = yes
	}
	
	### Congenital Traits
	if = {
		limit = { has_trait = beauty_bad }
		remove_trait = beauty_bad_1
		remove_trait = beauty_bad_2
		remove_trait = beauty_bad_3
	}

	if = {
		limit = { has_trait = giant }
		remove_trait = giant
	}

	if = {
		limit = { has_trait = dwarf }
		remove_trait = dwarf
	}

	### Criminal Traits

	if = {
		limit = { has_trait = gallowsbait }
		remove_trait = gallowsbait
	}
}

###############################################
### Scripted Effects for Maglor Event Chain ###
###############################################

maglor_crusade_elven_warriors = {
	if = {
		limit = { scope:elven_ruler.culture = culture:noldor }
		random_list = { # Noldor
			1 = { increase_variable = { NAME = noldor_veterans AMOUNT = $SUPPORT$ } }
			1 = { increase_variable = { NAME = noldor_cavalry AMOUNT = $SUPPORT$ } }
		}
	}
	else_if = {
		limit = { scope:elven_ruler.culture = culture:sindar }
		random_list = { # Sindar
			1 = { increase_variable = { NAME = falathrim_haven_guard AMOUNT = $SUPPORT$ } }
			1 = { increase_variable = { NAME = marchwardens AMOUNT = $SUPPORT$ } }
		}
	}
	else_if = {
		limit = { scope:elven_ruler.culture = culture:falathrim }
		random_list = { # Falathrim
			1 = { increase_variable = { NAME = hir_hathol AMOUNT = $SUPPORT$ } }
			1 = { increase_variable = { NAME = grey_elven_heavy_cavalry AMOUNT = $SUPPORT$ } }
		}
	}
	else_if = {
		limit = { scope:elven_ruler.culture = culture:laiquendi }
		random_list = { # Laiquendi
			1 = { increase_variable = { NAME = ossiriand_rangers AMOUNT = $SUPPORT$ } }
			1 = { increase_variable = { NAME = laiquendi_scouts AMOUNT = $SUPPORT$ } }
		}
	}
	else = {
		random_list = { # Noldor troops ||| Fallback
			1 = { increase_variable = { NAME = high_elven_heavy_cavalry AMOUNT = 1 } }
			1 = { increase_variable = { NAME = high_elven_archers AMOUNT = 1 } }
		}
	}
}

give_maglor_elven_warriors_effect = {
	if = {
		limit = { has_variable = noldor_veterans }
		spawn_army = {
			name = maglor_event_chain.0020.noldor_troops

			men_at_arms = {
				type = noldor_veterans
				stacks = var:noldor_veterans
			}
			location = root.capital_province
		}
		remove_variable = noldor_veterans
	}
	if = {
		limit = { has_variable = noldor_cavalry }
		spawn_army = {
			name = maglor_event_chain.0020.noldor_troops

			men_at_arms = {
				type = noldor_cavalry
				stacks = var:noldor_cavalry
			}
			location = root.capital_province
		}
		remove_variable = noldor_cavalry
	}
	if = {
		limit = { has_variable = falathrim_haven_guard }
		spawn_army = {
			name = maglor_event_chain.0020.falathrim_troops

			men_at_arms = {
				type = falathrim_haven_guard
				stacks = var:falathrim_haven_guard
			}
			location = root.capital_province
		}
	}
	if = {
		limit = { has_variable = marchwardens }
		spawn_army = {
			name = maglor_event_chain.0020.falathrim_troops

			men_at_arms = {
				type = marchwardens
				stacks = var:marchwardens
			}
			location = root.capital_province
		}
		remove_variable = marchwardens
	}
	if = {
		limit = { has_variable = hir_hathol }
		spawn_army = {
			name = maglor_event_chain.0020.sindar_troops

			men_at_arms = {
				type = hir_hathol
				stacks = var:hir_hathol
			}
			location = root.capital_province
		}
		remove_variable = hir_hathol
	}
	if = {
		limit = { has_variable = grey_elven_heavy_cavalry }
		spawn_army = {
			name = maglor_event_chain.0020.sindar_troops

			men_at_arms = {
				type = grey_elven_heavy_cavalry
				stacks = var:grey_elven_heavy_cavalry
			}
			location = root.capital_province
		}
		remove_variable = grey_elven_heavy_cavalry
	}
	if = {
		limit = { has_variable = ossiriand_rangers }
		spawn_army = {
			name = maglor_event_chain.0020.laiquendi_troops

			men_at_arms = {
				type = ossiriand_rangers
				stacks = var:ossiriand_rangers
			}
			location = root.capital_province
		}
		remove_variable = ossiriand_rangers
	}
	if = {
		limit = { has_variable = laiquendi_scouts }
		spawn_army = {
			name = maglor_event_chain.0020.laiquendi_troops

			men_at_arms = {
				type = laiquendi_scouts
				stacks = var:laiquendi_scouts
			}
			location = root.capital_province
		}
		remove_variable = laiquendi_scouts
	}
	if = {
		limit = { has_variable = high_elven_heavy_cavalry }
		spawn_army = {
			name = maglor_event_chain.0020.noldor_troops

			men_at_arms = {
				type = high_elven_heavy_cavalry
				stacks = var:high_elven_heavy_cavalry
			}
			location = root.capital_province
		}
		remove_variable = high_elven_heavy_cavalry
	}
	if = {
		limit = { has_variable = high_elven_archers }
		spawn_army = {
			name = maglor_event_chain.0020.noldor_troops

			men_at_arms = {
				type = high_elven_archers
				stacks = var:high_elven_archers
			}
			location = root.capital_province
		}
		remove_variable = high_elven_archers
	}
}

maglor_reclaim_moria = {
	create_title_and_vassal_change = {
		type = granted
		save_scope_as = change
		add_claim_on_loss = yes
	}
	title:d_zirakzigil = {
		change_title_holder = {
			holder = $NEW_HOLDER$
			change = scope:change
		}
		every_in_de_jure_hierarchy = {
			title_province = { set_holding_type = castle_holding }
			change_title_holder = {
				holder = $NEW_HOLDER$
				change = scope:change
			}
			set_county_faith = $NEW_HOLDER$.faith
			set_county_culture = $NEW_HOLDER$.culture
		}
	}
	title:d_barazinbar = {
		change_title_holder = {
			holder = $NEW_HOLDER$
			change = scope:change
		}
		every_in_de_jure_hierarchy = {
			title_province = { set_holding_type = castle_holding }
			change_title_holder = {
				holder = $NEW_HOLDER$
				change = scope:change
			}
			set_county_faith = $NEW_HOLDER$.faith
			set_county_culture = $NEW_HOLDER$.culture
		}
	}
	title:d_bundushathur = {
		change_title_holder = {
			holder = $NEW_HOLDER$
			change = scope:change
		}
		every_in_de_jure_hierarchy = {
			title_province = { set_holding_type = castle_holding }
			change_title_holder = {
				holder = $NEW_HOLDER$
				change = scope:change
			}
			set_county_faith = $NEW_HOLDER$.faith
			set_county_culture = $NEW_HOLDER$.culture
		}
	}
	resolve_title_and_vassal_change = scope:change

	$NEW_HOLDER$ = {
		every_held_title = { generate_coa = yes }
		get_title = title:k_khazad_dum
	}
}

lotr_define_new_character_faith_effect = {
	if = { #Good Elves and Istari don't convert to their own faith (Elves can convert other Elves)
		limit = {
			$ACTOR$ = {
				faith_is_good = yes
				OR = {
					is_elf = yes
					is_istari = yes 
				}
			}
			$TARGET$ = { is_elf = no }
		}
		$TARGET$ = {
			if = {
				limit = { 
					faith.religion = {
						is_in_family = rf_darkness
						any_faith = {
							OR = { 
								has_doctrine = doctrine_echoes_of_the_ainur
								has_doctrine = special_doctrine_is_freepeople_faith
							}
						}
					}
				}
				faith.religion = {
					ordered_faith = { #Find a good faith to convert to in the same religion
						limit = {
							OR = { 
								has_doctrine = doctrine_echoes_of_the_ainur
								has_doctrine = special_doctrine_is_freepeople_faith
							}
						}
						order_by = num_character_followers
						save_scope_as = conversion_faith
					}	
				}
			}
			else = { #If forces of evil, find an appropriate local faith
				if = {
					limit = { is_dwarf = yes }
					faith:faith_khazad = { save_scope_as = conversion_faith }
				}
				else_if = {
					limit = { is_hobbit = yes }
					faith:faith_hobbit = { save_scope_as = conversion_faith }
				}
				else_if = {
					limit = { is_druedain = yes }
					faith:faith_druedain = { save_scope_as = conversion_faith }
				}
				else_if = {
					limit = { location = { geographical_region = middleearth_west_rohan } }
					faith:faith_rohirric = { save_scope_as = conversion_faith }
				}
				else_if = {
					limit = { location = { geographical_region = middleearth_west_enedhwaith } }
					faith:faith_dunlending_turthalis = { save_scope_as = conversion_faith }
				}
				else_if = {
					limit = { location = { geographical_region = middleearth_west_rhovanion } }
					faith:faith_woodmen = { save_scope_as = conversion_faith }
				}
				else_if = {
					limit = { location = { geographical_region = middleearth_west } }
					faith:faith_edain = { save_scope_as = conversion_faith }
				}
				else_if = {
					limit = { location = { geographical_region = middleearth_rhun_dorwinion } }
					faith:faith_dorwinion = { save_scope_as = conversion_faith }
				}
				else_if = {
					limit = { location = { geographical_region = middleearth_rhun } }
					faith:faith_rhun_araw_triumvirate = { save_scope_as = conversion_faith }
				}
				else_if = {
					limit = { location = { geographical_region = middleearth_mordor } }
					faith:faith_nurn_good = { save_scope_as = conversion_faith }
				}
				else_if = {
					limit = { location = { geographical_region = middleearth_harad_near } }
					faith:faith_chelkar = { save_scope_as = conversion_faith }
				}
				else_if = {
					limit = { location = { geographical_region = middleearth_harad_far } }
					faith:faith_infinite_wisdom = { save_scope_as = conversion_faith }
				}
				else_if = {
					limit = { location = { geographical_region = middleearth_uttersouth } }
					faith:faith_good_pel = { save_scope_as = conversion_faith }
				}
				else_if = {
					limit = { location = { geographical_region = middleearth_harad_bayoformal } }
					faith:faith_arienism = { save_scope_as = conversion_faith }
				}
				else = { #Own faith as ultimate backup
					$ACTOR$.faith = { save_scope_as = conversion_faith }
				}
			}
			# SOW Added - hijack the process
			if = {
				limit = {
					faith.religion = { is_in_family = rf_darkness }
					any_ancestor = {
						even_if_dead = yes
						this.culture = $TARGET$.culture
						faith = {
							OR = { 
								has_doctrine = doctrine_echoes_of_the_ainur
								has_doctrine = special_doctrine_is_freepeople_faith
							}
						}
					}
				}
				random_ancestor = {
					even_if_dead = yes
					limit = {
						this.culture = $TARGET$.culture
						faith = {
							OR = { 
								has_doctrine = doctrine_echoes_of_the_ainur
								has_doctrine = special_doctrine_is_freepeople_faith
							}
						}
					}
					this.faith = { save_scope_as = conversion_faith } 
				}
			}
		}
	}
	else = { $ACTOR$.faith = { save_scope_as = conversion_faith } } #Everyone else uses vanilla mechanics
}

lotr_define_new_location_faith_effect = {
	if = { #Good Elves and Istari don't convert to their own faith (Elves can convert other Elves)
		limit = { 
			$ACTOR$ = {
				faith_is_good = yes
				OR = {
					is_elf = yes
					is_istari = yes 
				}
			}
			$TARGET$ = { is_elf = no }
		}
		$TARGET$ = {
			if = {
				limit = {
					faith.religion = { 
						is_in_family = rf_darkness
						any_faith = {
							OR = {
								has_doctrine = doctrine_echoes_of_the_ainur
								has_doctrine = special_doctrine_is_freepeople_faith
							}
						}
					}
				}
				faith.religion = {
					random_faith = { #Find a good faith to convert to in the same religion
						limit = {
							OR = {
								has_doctrine = doctrine_echoes_of_the_ainur
								has_doctrine = special_doctrine_is_freepeople_faith
							}
						}
						save_scope_as = new_faith
					}
				}
			}
			else = { #If no good faith exists in their religion, find an appropriate local faith
				if = {
					limit = { is_dwarf = yes }
					faith:faith_khazad = { save_scope_as = new_faith }
				}
				else_if = {
					limit = {is_hobbit = yes }
					faith:faith_hobbit = { save_scope_as = new_faith }
				}
				else_if = {
					limit = { is_druedain = yes }
					faith:faith_druedain = { save_scope_as = new_faith }
				}
				else_if = {
					limit = { geographical_region = middleearth_west_rohan }
					faith:faith_rohirric = { save_scope_as = new_faith }
				}
				else_if = {
					limit = { geographical_region = middleearth_west_enedhwaith }
					faith:faith_dunlending_turthalis = { save_scope_as = new_faith }
				}
				else_if = {
					limit = { geographical_region = middleearth_west_rhovanion }
					faith:faith_woodmen = { save_scope_as = new_faith }
				}
				else_if = {
					limit = { geographical_region = middleearth_west }
					faith:faith_edain = { save_scope_as = new_faith }
				}
				else_if = {
					limit = { geographical_region = middleearth_rhun_dorwinion }
					faith:faith_dorwinion = { save_scope_as = new_faith }
				}
				else_if = {
					limit = { geographical_region = middleearth_rhun }
					faith:faith_rhun_araw_triumvirate = { save_scope_as = new_faith }
				}
				else_if = {
					limit = { geographical_region = middleearth_mordor }
					faith:faith_rhun_araw_triumvirate = { save_scope_as = new_faith }
				}
				else_if = {
					limit = { geographical_region = middleearth_harad_near }
					faith:faith_chelkar = { save_scope_as = new_faith }
				}
				else_if = {
					limit = { geographical_region = middleearth_harad_far }
					faith:faith_conservative_eruism = { save_scope_as = new_faith }
				}
				else_if = {
					limit = { geographical_region = middleearth_uttersouth }
					faith:faith_gimileth = { save_scope_as = new_faith }
				}
				else_if = {
					limit = { geographical_region = middleearth_harad_bayoformal }
					faith:faith_arienism = { save_scope_as = new_faith }
				}
				else = { #Own faith as ultimate backup
					$ACTOR$.faith = { save_scope_as = new_faith }
				}
			}
		}
	}
	else = { $ACTOR$.faith = { save_scope_as = new_faith } } #Everyone else uses vanilla mechanics
}