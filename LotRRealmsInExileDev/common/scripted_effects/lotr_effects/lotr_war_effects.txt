lotr_delete_all_maa_regiments = { # Deletes all MAA regiments this has
	every_maa_regiment = {
		destroy_maa_regiment = yes
	}
}

lotr_transfer_all_maa_regiments = { # Transfers all MAA regiments from this to NEW_OWNER
	if = {
		limit = { number_of_maa_regiments >= 1 }
		$NEW_OWNER$ = { save_scope_as = new_owner }
		custom_description_no_bullet = {
			text = lotr_transfer_all_maa_regiments
			subject = this
			object = scope:new_owner
			every_maa_regiment = {
				save_scope_as = regiment

				scope:new_owner = {
					if = {
						limit = {
							exists = scope:regiment
							ep3_governor_yearly_3050_regiment_size_value = 1
						}
						create_maa_regiment = {
							type_of = scope:regiment
							check_can_recruit = no
							size = 1
						}
					}
					else_if = {
						limit = {
							exists = scope:regiment
							ep3_governor_yearly_3050_regiment_size_value = 2
						}
						create_maa_regiment = {
							type_of = scope:regiment
							check_can_recruit = no
							size = 2
						}
					}
					else_if = {
						limit = {
							exists = scope:regiment
							ep3_governor_yearly_3050_regiment_size_value = 3
						}
						create_maa_regiment = {
							type_of = scope:regiment
							check_can_recruit = no
							size = 3
						}
					}
					else_if = {
						limit = {
							exists = scope:regiment
							ep3_governor_yearly_3050_regiment_size_value = 4
						}
						create_maa_regiment = {
							type_of = scope:regiment
							check_can_recruit = no
							size = 4
						}
					}
					else_if = {
						limit = {
							exists = scope:regiment
							ep3_governor_yearly_3050_regiment_size_value = 5
						}
						create_maa_regiment = {
							type_of = scope:regiment
							check_can_recruit = no
							size = 5
						}
					}
					else_if = {
						limit = {
							exists = scope:regiment
							ep3_governor_yearly_3050_regiment_size_value = 6
						}
						create_maa_regiment = {
							type_of = scope:regiment
							check_can_recruit = no
							size = 6
						}
					}
					else_if = {
						limit = {
							exists = scope:regiment
							ep3_governor_yearly_3050_regiment_size_value = 7
						}
						create_maa_regiment = {
							type_of = scope:regiment
							check_can_recruit = no
							size = 7
						}
					}
					else_if = {
						limit = {
							exists = scope:regiment
							ep3_governor_yearly_3050_regiment_size_value = 8
						}
						create_maa_regiment = {
							type_of = scope:regiment
							check_can_recruit = no
							size = 8
						}
					}
					else_if = {
						limit = {
							exists = scope:regiment
							ep3_governor_yearly_3050_regiment_size_value = 9
						}
						create_maa_regiment = {
							type_of = scope:regiment
							check_can_recruit = no
							size = 9
						}
					}
					else_if = {
						limit = {
							exists = scope:regiment
							ep3_governor_yearly_3050_regiment_size_value = 10
						}
						create_maa_regiment = {
							type_of = scope:regiment
							check_can_recruit = no
							size = 10
						}
					}
					else_if = {
						limit = {
							exists = scope:regiment
							ep3_governor_yearly_3050_regiment_size_value = 11
						}
						create_maa_regiment = {
							type_of = scope:regiment
							check_can_recruit = no
							size = 11
						}
					}
					else_if = {
						limit = {
							exists = scope:regiment
							ep3_governor_yearly_3050_regiment_size_value = 12
						}
						create_maa_regiment = {
							type_of = scope:regiment
							check_can_recruit = no
							size = 12
						}
					}
					else_if = {
						limit = {
							exists = scope:regiment
							ep3_governor_yearly_3050_regiment_size_value = 13
						}
						create_maa_regiment = {
							type_of = scope:regiment
							check_can_recruit = no
							size = 13
						}
					}
					else_if = {
						limit = {
							exists = scope:regiment
							ep3_governor_yearly_3050_regiment_size_value = 14
						}
						create_maa_regiment = {
							type_of = scope:regiment
							check_can_recruit = no
							size = 14
						}
					}
					else_if = {
						limit = {
							exists = scope:regiment
							ep3_governor_yearly_3050_regiment_size_value >= 16
						}
						create_maa_regiment = {
							type_of = scope:regiment
							check_can_recruit = no
							size = 15
						}
					}
					else_if = {
						limit = {
							exists = scope:regiment
							ep3_governor_yearly_3050_regiment_size_value >= 16
						}
						create_maa_regiment = {
							type_of = scope:regiment
							check_can_recruit = no
							size = 16
						}
					}
				}
				hidden_effect = {
					destroy_maa_regiment = yes
				}
			}
		}
	}
}

pay_short_term_gold_raze_effect = {
	pay_short_term_gold = {
		gold = $GOLD_VALUE$
		target = scope:attacker
		yearly_income = yes
	}
}

decrease_building_or_development = {
	if = { ### Checks whether county should be made wilderness
		limit = {
			any_in_list = {
				list = $LIST$ 
				tier = tier_county
				OR = {
					county.development_level = 0
					county = { title_province = { has_building = dwarven_depths_01 } }
					county = { title_province = { has_building = settlement_01 } }
				}	
				OR = {
					scope:defender = county.holder
					scope:defender = county.holder.top_liege
				}
			}
		}
		every_in_list = { 
			list = $LIST$ 
			limit = {
				OR = {
					county.development_level = 0
					county = { title_province = { has_building = dwarven_depths_01 } }
				}
				OR = {
					scope:defender = county.holder
					scope:defender = county.holder.top_liege
				}
			}
			change_development_level = county.development_level.neg
			make_settlement_county_wilderness = { COUNTY = county }
		}
	}
	if = { ### Decrease development + buildings | Dwarves
		limit = { scope:defender = { is_dwarf = yes } }
		every_in_list = { 
			list = $LIST$ 
			limit = {
				OR = {
					scope:defender = county.holder
					scope:defender = county.holder.top_liege
				}
			}
			title_province = { remove_building_tier_ten_effect = { BUILDING = dwarven_ale_house } } 
			title_province = { remove_building_tier_ten_effect = { BUILDING = dwarven_fungal_farm } } 
			title_province = { remove_building_tier_ten_effect = { BUILDING = dwarven_terrace_farm } } 
			title_province = { remove_building_tier_ten_effect = { BUILDING = iron_mines } }
			title_province = { remove_building_tier_ten_effect = { BUILDING = tin_mines } }
			title_province = { remove_building_tier_ten_effect = { BUILDING = copper_mines } }
			title_province = { remove_building_tier_ten_effect = { BUILDING = lead_mines } }
			title_province = { remove_building_tier_ten_effect = { BUILDING = silver_mines } }
			title_province = { remove_building_tier_ten_effect = { BUILDING = gold_mines } }
			title_province = { remove_building_tier_ten_effect = { BUILDING = mithril_mines } }
			title_province = { remove_building_tier_ten_effect = { BUILDING = quartz_mines } }
			title_province = { remove_building_tier_ten_effect = { BUILDING = peridot_mines } }
			title_province = { remove_building_tier_ten_effect = { BUILDING = onyx_mines } }
			title_province = { remove_building_tier_ten_effect = { BUILDING = amethyst_mines } }
			title_province = { remove_building_tier_ten_effect = { BUILDING = ruby_mines } }
			title_province = { remove_building_tier_ten_effect = { BUILDING = sapphire_mines } }
			title_province = { remove_building_tier_ten_effect = { BUILDING = emerald_mines } }
			title_province = { remove_building_tier_ten_effect = { BUILDING = diamond_mines } }
			title_province = { remove_building_tier_ten_effect = { BUILDING = dwarven_quarry } } 
			title_province = { remove_building_tier_ten_effect = { BUILDING = dwarven_crafts } } 
			title_province = { remove_building_tier_ten_effect = { BUILDING = dwarven_toolmaker_guild } } 
			title_province = { remove_building_tier_ten_effect = { BUILDING = dwarven_vaults } } 
			title_province = { remove_building_tier_ten_effect = { BUILDING = dwarven_roads } } 
			title_province = { remove_building_tier_ten_effect = { BUILDING = dwarven_armory } } 
			title_province = { remove_building_tier_ten_effect = { BUILDING = dwarven_skirmisher_barracks } } 
			### Buildings with only 5 tiers
			title_province = { remove_building_tier_five_effect = { BUILDING = dwarven_siege_workshop } } 
			title_province = { remove_building_tier_five_effect = { BUILDING = dwarven_hoard } } 
			### Duchy Buildings
			title_province = { destroy_or_downgrade_duchy_effect_lotr = { BUILDING = military_specialization } } 
			title_province = { destroy_or_downgrade_duchy_effect_lotr = { BUILDING = economic_specialization } } 
			title_province = { destroy_or_downgrade_duchy_effect_lotr = { BUILDING = glory_specialization } } 
			### Holding
			title_province = { downgrade_tier_ten_holding = { HOLDING = dwarven_depths } }
		}
	}
	else = { ### Decrease development + buildings | Goblins
		if = {
			limit = { scope:defender = { is_orc = yes } }
			every_in_list = { 
				list = $LIST$ 
				limit = {
					OR = {
						scope:defender = county.holder
						scope:defender = county.holder.top_liege
					}
				}
				### In-case underground county has dwarven buildings, due to being conquered earlier
				title_province = { remove_building_tier_ten_effect = { BUILDING = dwarven_ale_house } } 
				title_province = { remove_building_tier_ten_effect = { BUILDING = dwarven_fungal_farm } } 
				title_province = { remove_building_tier_ten_effect = { BUILDING = dwarven_terrace_farm } } 
				title_province = { remove_building_tier_ten_effect = { BUILDING = iron_mines } }
				title_province = { remove_building_tier_ten_effect = { BUILDING = tin_mines } }
				title_province = { remove_building_tier_ten_effect = { BUILDING = copper_mines } }
				title_province = { remove_building_tier_ten_effect = { BUILDING = lead_mines } }
				title_province = { remove_building_tier_ten_effect = { BUILDING = silver_mines } }
				title_province = { remove_building_tier_ten_effect = { BUILDING = gold_mines } }
				title_province = { remove_building_tier_ten_effect = { BUILDING = mithril_mines } }
				title_province = { remove_building_tier_ten_effect = { BUILDING = quartz_mines } }
				title_province = { remove_building_tier_ten_effect = { BUILDING = peridot_mines } }
				title_province = { remove_building_tier_ten_effect = { BUILDING = onyx_mines } }
				title_province = { remove_building_tier_ten_effect = { BUILDING = amethyst_mines } }
				title_province = { remove_building_tier_ten_effect = { BUILDING = ruby_mines } }
				title_province = { remove_building_tier_ten_effect = { BUILDING = sapphire_mines } }
				title_province = { remove_building_tier_ten_effect = { BUILDING = emerald_mines } }
				title_province = { remove_building_tier_ten_effect = { BUILDING = diamond_mines } }
				title_province = { remove_building_tier_ten_effect = { BUILDING = dwarven_quarry } } 
				title_province = { remove_building_tier_ten_effect = { BUILDING = dwarven_crafts } } 
				title_province = { remove_building_tier_ten_effect = { BUILDING = dwarven_toolmaker_guild } } 
				title_province = { remove_building_tier_ten_effect = { BUILDING = dwarven_vaults } } 
				title_province = { remove_building_tier_ten_effect = { BUILDING = dwarven_roads } } 
				title_province = { remove_building_tier_ten_effect = { BUILDING = dwarven_armory } } 
				title_province = { remove_building_tier_ten_effect = { BUILDING = dwarven_skirmisher_barracks } } 
				### Buildings with only 5 tiers
				title_province = { remove_building_tier_five_effect = { BUILDING = dwarven_siege_workshop } } 
				title_province = { remove_building_tier_five_effect = { BUILDING = dwarven_hoard } } 

				### Duchy Buildings
				title_province = { destroy_or_downgrade_duchy_effect_lotr = { BUILDING = military_specialization } } 
				title_province = { destroy_or_downgrade_duchy_effect_lotr = { BUILDING = economic_specialization } } 
				title_province = { destroy_or_downgrade_duchy_effect_lotr = { BUILDING = glory_specialization } }

				### Orc Buildings
				title_province = { remove_building_any_level = { BUILDING = raiding_camps } } 
				title_province = { remove_building_any_level = { BUILDING = uruk_pits } } 
				title_province = { remove_building_any_level = { BUILDING = furnaces } } 
				title_province = { remove_building_any_level = { BUILDING = scouting_posts } } 
				title_province = { remove_building_any_level = { BUILDING = warg_pits } } 
				title_province = { remove_building_any_level = { BUILDING = orc_siege_works } } 
				
				### Orc Duchy Buildings
				title_province = { destroy_or_downgrade_duchy_effect_lotr = { BUILDING = liquor_stills } } 
				title_province = { destroy_or_downgrade_duchy_effect_lotr = { BUILDING = orc_barracks } } 
				title_province = { destroy_or_downgrade_duchy_effect_lotr = { BUILDING = loot_houses } }
				title_province = { destroy_or_downgrade_duchy_effect_lotr = { BUILDING = proving_ground } }
				title_province = { destroy_or_downgrade_duchy_effect_lotr = { BUILDING = tunnel_network } }
				title_province = { destroy_or_downgrade_duchy_effect_lotr = { BUILDING = slaughterhouses } }
				title_province = { destroy_or_downgrade_duchy_effect_lotr = { BUILDING = experimental_workshop } }
				title_province = { destroy_or_downgrade_duchy_effect_lotr = { BUILDING = heavy_armoury } }
				title_province = { destroy_or_downgrade_duchy_effect_lotr = { BUILDING = snaga_warrens } }
				### Holding
				title_province = { downgrade_tier_ten_holding = { HOLDING = dwarven_depths } }
			}
		}
	}
}

decrease_county_development = {
	if = {
		limit = { $COUNTY$ = { development_level > 25 } }
		$COUNTY$ = { change_development_level = -5 }
	}
	else_if = { 
		limit = { $COUNTY$ = { development_level > 20 } }
		$COUNTY$ = { change_development_level = -4 }
	}
	else_if = { 
		limit = { $COUNTY$ = { development_level > 15 } }
		$COUNTY$ = { change_development_level = -3 }
	}
	else_if = { 
		limit = { $COUNTY$ = { development_level > 10 } }
		$COUNTY$ = { change_development_level = -2 }
	}
	else = {
		$COUNTY$ = { change_development_level = -1 }
	}
}

lotr_invite_non_evil_claimants_effect = {
	save_scope_as = the_temporary_ruler
	every_held_title = {
		title_tier = county
		save_scope_as = the_county
		ordered_claimant = {
			limit = {
				faith_is_evil = no
				trigger_if = {
					limit = { 
						is_ruler = yes
						top_liege != scope:the_temporary_ruler 
						NOT = { is_in_list = participants_of_split }
					}
					is_landless_adventurer = yes
				}
			}
			order_by = {
				value = this.age
				save_temporary_scope_as = the_claimant
				if = {
					limit = { is_landless_ruler = yes }
					multiply = 2
				}
				# Prioritize people with closer ties to last rulers
				if = {
					limit = {
						scope:the_county = { any_past_holder = { this = scope:the_claimant } }
					}
					multiply = 2
				}
				if = {
					limit = { 
						scope:the_county = { any_past_holder = { is_parent_of = scope:the_claimant } }
					}
					multiply = 2
				}
				if = {
					limit = { 
						scope:the_county = { any_past_holder = { is_grandparent_of = scope:the_claimant } }
					}
					multiply = 2
				}
				if = {
					limit = { 
						scope:the_county = { any_past_holder = { is_great_grandparent_of = scope:the_claimant } }
					}
					multiply = 2
				}
				# Prioritize people being senior party in marriage 
				if = {
					limit = { 
						is_married = yes 
						trigger_if = {
							limit = { is_male = yes }
							matrilinear_marriage = yes
						}
						trigger_else = {
							patrilinear_marriage = yes
						}
					}
					divide = 2
				}
				# Inheritance
				if = {
					limit = { is_female = yes }
					if = {
						limit = { faith = { has_doctrine = doctrine_gender_male_dominated } }
						multiply = 0
					}
					else_if = {
						limit = { faith = { has_doctrine = doctrine_gender_male_orientated } }
						divide = 2
					}
				}
				else = {
					if = {
						limit = { faith = { has_doctrine = doctrine_gender_female_dominated }  }
						multiply = 0
					}
					else_if = {
						limit = { faith = { has_doctrine = doctrine_gender_female_orientated } }
						divide = 2
					}
				}
			}
			save_scope_as = the_new_ruler
			
			if = { # Don't force players to accept the titles, give them an event where they can choose
				limit = { is_ai = no }
				scope:the_new_ruler = {
					add_to_variable_list = {
						name = vanquish_darkness_titles_to_offer
						target = scope:the_county
					}
				}
			}
			else = {
				# Make vassal if ranks work
				every_held_title = { # Get rid of Laamp
					limit = { is_landless_type_title = yes }
					scope:the_new_ruler = { destroy_title = PREV }
				}
				get_title = scope:the_county
				if = {
					limit = {
						scope:the_temporary_ruler.primary_title.tier >= tier_duchy
					}
					create_title_and_vassal_change = {
						type = swear_fealty
						save_scope_as = change
					}
					change_liege = {
						liege = scope:the_temporary_ruler
						change = scope:change
					}
					resolve_title_and_vassal_change = scope:change
				}
				add_to_temporary_list = participants_of_split
			}
		}
	}
	# Mop up the bordergore, copied from exclave independence game rule
	trigger_event = game_rule.2
	
	# Fire an event for every player that is being offered titles 
	every_player = {
		limit = { has_variable_list = vanquish_darkness_titles_to_offer }
		trigger_event = elven_racial.0202
	}
}

lotr_make_berserker_effect = {
	if = { #LotR
		limit = {
			culture = culture:isengard_urukhai
		}
		add_trait = urukhai_berserker
	}
	else = {
		add_trait = berserker
	}
}

################################
### Valinor Invasion Effects ###
################################

swear_holder_fealty_to_eonwe = {
	create_title_and_vassal_change = {
		type = swear_fealty
		save_scope_as = change
		add_claim_on_loss = yes
	}
	holder = {
		change_liege = {
			liege = scope:attacker
			change = scope:change
		}
	}
	resolve_title_and_vassal_change = scope:change
}

transfer_conquerred_titles_to_sunset_invader = {
	create_title_and_vassal_change = {
		type = conquest
		save_scope_as = change
		add_claim_on_loss = yes
	}
	change_title_holder = {
		holder = scope:attacker
		change = scope:change
	}
	resolve_title_and_vassal_change = scope:change
}

sunset_invasion_settle_local_people_effect = {

	every_in_de_jure_hierarchy = {
		limit = {
			tier < tier_empire
			exists = holder
			NOR = { 
				holder = scope:defender
				holder = title:k_wastelands.holder
				holder = scope:attacker
			}
			holder.liege = scope:defender
			holder = { faith_is_evil = no }
		}
		swear_holder_fealty_to_eonwe = yes
	}
	
	every_in_de_jure_hierarchy = {
		limit = {
			tier < tier_empire
			exists = holder
			NOR = { 
				holder = scope:defender
				holder = title:k_wastelands.holder
				holder = scope:attacker
			}
			holder.liege = scope:defender
			holder = { faith_is_evil = yes }
			NOR = { 
				holder.liege = scope:attacker
				holder.top_liege = scope:attacker
			}
		}
		transfer_conquerred_titles_to_sunset_invader = yes
	}
}

###
# GEOGRAPHICAL_REGION 	--> Area in which the invading party appears
# $GRAB_LANDING_COUNTY_EFFECT$ = yes 	--> 
#							GRAB_LANDING_COUNTY_EFFECT => The effect which grabs the specific landing county. 
#									 Needs to save the county to a scope called landing_county
#
# $REVIVE_DEAD_CHARACTER_EFFECT$ = yes		-->
#							REVIVE_DEAD_CHARACTER_EFFECT => The effect which grabs the character that needs to be revived
#
# $INVASION_LANDING_EFFECT$ = yes		-->
#							INVASION_LANDING_EFFECT => Additional scripted effect which can be used
#
# $START_INVASION_WAR_EFFECT$ = yes		-->
#							START_INVASION_WAR_EFFECT => Additional scripted effect which can be used
#
#
# NOTES: 	If there are no scripted effects the coder wants to add, simply do START_INVASION_WAR_EFFECT = "#" (WITH the quotation marks)
#			This will effectively comment out that line.
###

sunset_invasion_general_effect = {
	if = { #Eonwe
		limit = { geographical_region:$GEOGRAPHICAL_REGION$ = geographical_region:valinor_invasion_region }
		character:lineofeonwe = { save_scope_as = invader_char }
	}
	else_if = { #Pharazon
		limit = { geographical_region:$GEOGRAPHICAL_REGION$ = geographical_region:pharazon_invasion_region }
		character:lineofelros28 = { save_scope_as = invader_char }
	}

	### Grab county at which conqueror will land at. 
	### Needs to save the county to a scope called landing_county
	$GRAB_LANDING_COUNTY_EFFECT$ = yes
	
	### Effect that can be fired to re-create a character, such as Pharazon
	$REVIVE_DEAD_CHARACTER_EFFECT$ = yes

	scope:invader_char = {
		$INVASION_LANDING_EFFECT$ = yes
		$START_INVASION_WAR_EFFECT$ = yes
	}
}

###########################################
### Sunset Invasion General Sub-effects ###
###########################################

sunset_invasion_cb_add_titles_to_list = {
	every_sub_realm_county = {
		limit = {
			is_wastelands = no
			any_in_list = {
				list = initial_invasion_titles
				this = prev
			}
		}
		add_to_list = targeted_titles
	}
}

sunset_invasion_opposite_alignment_vassal_transfer_effect = {
	scope:defender = {
		every_subject = { #To account for tributaries
			limit = { 
				sunset_invasion_subject_has_opposite_alignment_and_land_in_region = yes
			}
			every_sub_realm_county = {
				limit = {
					is_wastelands = no
					any_in_list = {
						list = initial_invasion_titles
						this = prev
					}
				}
				add_to_list = targeted_titles
			}
		}
	}

	create_title_and_vassal_change = {
		type = conquest
		save_scope_as = opposite_alignment_change
		add_claim_on_loss = yes
	}
	every_in_list = {
		list = targeted_titles
		limit = {
			holder != scope:attacker
			is_wastelands = no
		}
		change_title_holder = {
			holder = scope:attacker
			change = scope:opposite_alignment_change
		}
	}
	resolve_title_and_vassal_change = scope:opposite_alignment_change
}

sunset_invasion_same_alignment_vassal_transfer_effect = {
	scope:defender = {
		every_subject = {
			limit = { 
				sunset_invasion_subject_has_same_alignment_and_land_in_region = yes
			}
			sunset_invasion_cb_add_titles_to_list = yes
		}
	}
	create_title_and_vassal_change = {
		type = swear_fealty
		save_scope_as = same_alignment_change
		add_claim_on_loss = yes
	}
	every_in_list = {
		list = targeted_titles
		limit = { 
			is_wastelands = no
			holder != scope:attacker
		}
		holder = {
			if = {
				limit = { 
					is_wastelands = no
					is_tributary = yes
				}
				end_tributary = yes
			}
			change_liege = {
				liege = scope:attacker
				change = scope:same_alignment_change
			}
		}
	}
	resolve_title_and_vassal_change = scope:same_alignment_change
}

sunset_invasion_neutral_faith_vassal_transfer_effect = {
	scope:defender = {
		every_subject = {
			limit = { 
				is_wastelands = no
				faith_is_neutral = yes
				# Check for any held counties inside the region
				any_held_county = {
					any_in_list = {
						list = initial_invasion_titles
						this = prev
					}
					NOT = {
						any_in_list = {
							list = targeted_titles
							this = prev
						}
					}
				}
			}
			sunset_invasion_cb_add_titles_to_list = yes
		}
	}
	create_title_and_vassal_change = {
		type = swear_fealty
		save_scope_as = neutral_alignment_change
		add_claim_on_loss = yes
	}
	every_in_list = {
		list = targeted_titles
		limit = { 
			is_wastelands = no
			holder != scope:attacker
		}
		holder = {
			if = {
				limit = { 
					is_wastelands = no
					is_tributary = yes
				}
				end_tributary = yes
			}
			change_liege = {
				liege = scope:attacker
				change = scope:neutral_alignment_change
			}
		}
	}
	resolve_title_and_vassal_change = scope:neutral_alignment_change
}

sunset_invasion_take_titles_held_by_defender_effect = {
	create_title_and_vassal_change = {
		type = conquest
		save_scope_as = change
		add_claim_on_loss = yes
	}
	every_in_list = {
		list = initial_invasion_titles
		limit = {
			NOR = {
				holder = scope:attacker
				holder.top_liege = scope:attacker
				holder.suzerain ?= scope:attacker
			}
		}
		change_title_holder = {
			holder = scope:attacker
			change = scope:change
		}
	}
	resolve_title_and_vassal_change = scope:change
}

sunset_invasion_general_variables_effect = {
	scope:invader_char = {
		trigger_event = { # Need to do it with slight delay, otherwise event doesn't fire
			id = lotr_war_events.0005
			days = 1
		}
	}
	
	scope:invader_char = {
		set_variable = invisible_conqueror_story
		create_story = story_conqueror
	}
}

sunset_invasion_defender_loses_initial_invasion_war_effect = {
	scope:attacker = {
		every_held_county = {
			add_to_list = transfer_titles
		}
	}

	create_title_and_vassal_change = {
		type = conquest
		save_scope_as = change
		add_claim_on_loss = yes
	}
	
	every_in_list = {
		list = transfer_titles
		change_title_holder = {
			holder = scope:defender
			change = scope:change
		}
	}
	resolve_title_and_vassal_change = scope:change

	scope:attacker = {
		remove_variable = invasion_cb_unlock
		remove_variable = invisible_conqueror_story
		remove_variable = conqueror
	}
}

sunset_invasion_add_subjects_as_attackers_and_defenders_effect = {
	### Add same alignment rulers as defenders ###
	every_county_in_region = {
		region = $GEOGRAPHICAL_REGION$
		limit = { 
			OR = {
				holder.top_liege = scope:largest_realm_ruler
				holder.suzerain ?= scope:largest_realm_ruler
				holder.top_liege.suzerain ?= scope:largest_realm_ruler
			}
			holder = { same_alignment = { TARGET = scope:largest_realm_ruler } }
			holder = { is_wastelands = no }
			is_wastelands = no
		}
		holder = { add_to_list = call_to_invasion_war_defender_side }
	}

	every_in_list = {
		list = call_to_invasion_war_defender_side
		save_temporary_scope_as = curr_char
		scope:invader_char = {
			every_character_war = {
				limit = { NOT = { is_defender = scope:curr_char } }
				add_defender = scope:curr_char
			}
		}
	}

	
	### Add opposite alignment rulers as defenders ###
	every_county_in_region = {
		region = $GEOGRAPHICAL_REGION$
		limit = { 
			OR = {
				holder.top_liege = scope:largest_realm_ruler
				holder.suzerain ?= scope:largest_realm_ruler
				holder.top_liege.suzerain ?= scope:largest_realm_ruler
			}
			holder = { same_alignment = { TARGET = scope:invader_char } }
			holder = { is_wastelands = no }
			is_wastelands = no
		}
		holder = { add_to_list = call_to_invasion_war_attacker_side }
	}

	every_in_list = {
		list = call_to_invasion_war_attacker_side
		save_temporary_scope_as = curr_char
		scope:invader_char = {
			every_character_war = {
				limit = { NOT = { is_attacker = scope:curr_char } }
				add_attacker = scope:curr_char
			}
		}
	}
}

sunset_invasion_general_landing_effect = {
	create_title_and_vassal_change = {
		type = independency
		save_scope_as = change
	}
	scope:landing_county = {
		every_county_province = {
			limit = { 
				NOT = { has_holding_type = castle_holding }
			}
			set_holding_type = castle_holding
		}
		change_title_holder = {
			holder = scope:invader_char
			change = scope:change
		}
	}
	resolve_title_and_vassal_change = scope:change

	scope:invader_char = {
		create_title_and_vassal_change = {
			type = independency
			save_scope_as = independent_change
		}
		becomes_independent = {
			change = scope:independent_change
		}
		resolve_title_and_vassal_change = scope:independent_change
	}

	scope:invader_char = { get_title = $TITLE_TO_SPAWN_WITH$ }

	scope:invader_char = {
		add_piety_level = 5
		add_prestige_level = 5
		if = {
			limit = { is_landed = yes }
			add_legitimacy = 3000
		}
		add_prestige = 5000
		add_piety = 5000
		add_gold = 1500
		set_variable = invasion_cb_unlock
	}

	scope:landing_county = {
		set_county_faith = $LANDING_COUNTY_FAITH$
		set_county_culture = $LANDING_COUNTY_CULTURE$
		
		every_county_province = {
			if = {
				limit = {
					free_building_slots > 0
					NOT = { has_building = castle_04 }
				}
				add_building = castle_04
			}

			add_province_modifier = {
				modifier = $PROVINCE_MODIFIER$
				years = 10
			}
		}
		every_county_province = {
			if = {
				limit = {
					free_building_slots > 0
					NOT = { has_building = curtain_walls_08 }
				}
				add_building = curtain_walls_08
			}
		}
		every_county_province = {
			if = {
				limit = {
					free_building_slots > 0
					NOT = { has_building = barracks_05 }
				}
				add_building = barracks_05
			}
		}
		every_county_province = {
			if = {
				limit = {
					free_building_slots > 0
					NOT = { has_building = pastures_05 }
				}
				add_building = pastures_05
			}
		}
		if = {
			limit = { has_county_modifier = marauding_orc_drags_modifier }
			remove_county_modifier = marauding_orc_drags_modifier
		}
		if = {
			limit = { has_county_modifier = hidden_elven_refugees_modifier }
			remove_county_modifier = hidden_elven_refugees_modifier
		}
		change_county_control = 100
		change_development_level = -100 
		change_development_level = 25
	}

	scope:invader_char = {
		every_courtier_or_guest = {
			limit = { is_wastelands = yes }
			silent_disappearance_effect = yes
		}
	}
}

####################################
### Valinor Invasion Sub-effects ###
####################################

valinor_invasion_grab_landing_county = {
	title:e_lindon = { # Lindon
		ordered_in_de_jure_hierarchy = { # Check the main harbours first
			limit = {
				tier = tier_county
				is_coastal_county = yes
			}
			order_by = {
				value = 1
				if = {
					limit = { 
						OR = {
							title_province = { has_building_or_higher = wonder_mithlond_north_01 }
							title_province = { has_building_or_higher = wonder_mithlond_south_01 }
						}
					}
					add = 200
				}
				if = {
					limit = { 
						OR = {
							title_province = { has_building_or_higher = wonder_harlond_01 }
							title_province = { has_building_or_higher = wonder_forlond_01 }
							title_province = { has_building_or_higher = wonder_forlond_02 }
						}
					}
					add = 100
				}
			}
			save_scope_as = landing_county
		}
	}
}

valinor_invasion_landing_effect = {
	sunset_invasion_general_landing_effect = {
		TITLE_TO_SPAWN_WITH = title:h_eonwe_host
		LANDING_COUNTY_FAITH = faith:faith_eldar
		LANDING_COUNTY_CULTURE = culture:noldor
		PROVINCE_MODIFIER = landing_of_valinor_host_modifier
	}

	valinor_invasion_host_effect = yes
}

valinor_invasion_host_effect = {
	# Evil of Middle Earth Scopes
	character:lineofsauron = { save_scope_as = sauron }
	# Valinorian Maia Invader Scopes
	character:lineofmakar = { save_scope_as = makar }
	character:lineofmeasse = { save_scope_as = measse }
	# Valinorian Elven Invader Commander Scopes
	character:lineofingwe4 = { save_scope_as = ingwion }
	character:lineoffinarfin1 = { save_scope_as = finrod_felagund }
	character:lineofolwe3 = { save_scope_as = elulindo }
	# Valinorian Elven Invader Knight Scopes
	character:lineofingwe3 = { save_scope_as = indiel }
	character:lineofmalantur8 = { save_scope_as = astaldo }
	character:lineofgaldortree = { save_scope_as = galdor_of_the_tree }
	character:lineofaranwe2 = { save_scope_as = voronwe_the_mariner }
	character:lineofnellas2 = { save_scope_as = bardir }
	character:lineofnellas3 = { save_scope_as = oronel }
	character:lineofhador10 = { save_scope_as = tuor }

	### Courtiers + Councillors ###
	valinor_invasion_set_courtier_councillor_effect = { # Measse
		TARGET = scope:makar
		TYPE = councillor_marshal
	}

	valinor_invasion_set_courtier_councillor_effect = { # Measse
		TARGET = scope:measse
		TYPE = councillor_court_chaplain
	}

	scope:ingwion = { # Ingwion
		if = {
			limit = { is_alive = yes }
			if = {
				limit = { is_landed = yes }

				### Title changes
				create_title_and_vassal_change = {
					type = usurped
					save_scope_as = change
				}
				every_held_title = {
					change_title_holder = {
						holder = character:lineofingwe7
						change = scope:change
					}
				}
				resolve_title_and_vassal_change = scope:change
				create_title_and_vassal_change = {
					type = swear_fealty
					save_scope_as = change
				}
				scope:ingwion = { 
					change_liege = { 
						liege = scope:invader_char 
						change = scope:change
					}
				}
				resolve_title_and_vassal_change = scope:change
				
				valinor_invasion_set_courtier_employer_effect = { # Ingwion
					CHARACTER = scope:ingwion
				}
			}
			else = {
				valinor_invasion_set_courtier_employer_effect = { # Ingwion
					CHARACTER = scope:ingwion
				}
			}
		}
	}

	valinor_invasion_set_courtier_councillor_effect = { # Finrod Felagund
		TARGET = scope:finrod_felagund
		TYPE = councillor_chancellor
	}

	valinor_invasion_set_courtier_councillor_effect = { # Elulindo
		TARGET = scope:elulindo
		TYPE = councillor_steward
	}

	valinor_invasion_set_courtier_employer_effect = { # Indiel
		CHARACTER = scope:indiel
	}

	valinor_invasion_set_courtier_councillor_effect = { # Astaldo
		TARGET = scope:ingwion
		TYPE = councillor_spymaster
	}
	
	valinor_invasion_set_courtier_employer_effect = { # 
		CHARACTER = scope:astaldo
	}

	valinor_invasion_set_courtier_employer_effect = { # Galdor of the Tree
		CHARACTER = scope:galdor_of_the_tree
	}

	valinor_invasion_set_courtier_employer_effect = { # Voronwe the Mariner
		CHARACTER = scope:voronwe_the_mariner
	}

	valinor_invasion_set_courtier_employer_effect = { # Bardir
		CHARACTER = scope:bardir
	}

	valinor_invasion_set_courtier_employer_effect = { # Oronel
		CHARACTER = scope:oronel
	}

	valinor_invasion_set_courtier_employer_effect = { # Tuor
		CHARACTER = scope:tuor
	}

	scope:invader_char = {
		every_courtier_or_guest = { trigger_event = race.0001 }
	}

	### Army ###
	spawn_army = {
		levies = 0
		men_at_arms = {
			type = high_elven_pikemen
			stacks = sunset_invasion_troop_amount
		}
		men_at_arms = {
			type = high_elven_archers
			stacks = sunset_invasion_troop_amount
		}
		men_at_arms = {
			type = high_elven_heavy_cavalry
			stacks = sunset_invasion_troop_amount
		}
		men_at_arms = {
			type = high_elven_skirmishers
			stacks = sunset_invasion_troop_amount
		}
		men_at_arms = {
			type = high_elven_light_cavalry
			stacks = sunset_invasion_troop_amount
		}
		men_at_arms = {
			type = high_elven_heavy_infantry
			stacks = sunset_invasion_troop_amount
		}
		men_at_arms = {
			type = song_smiths
			stacks = sunset_invasion_troop_amount
		}
		location = scope:landing_county.title_province
		origin = scope:landing_county.title_province
		inheritable = yes
		uses_supply = no
		name = valinorian_invasion_army_name
	}

	# Global News Event
	if = {
		limit = { # Major News
			NOT = { has_game_rule = no_news }
		}
		every_player = { #Global News Announcement
			trigger_event = news_event.0034
		}
	}

	# Effect on elven hope
	add_elven_hope_global_effect = { VALUE = monumental_elven_hope_gain HOPE_EFFECT = effect_elven_hope_good_realm_rises }

	scope:finrod_felagund ?= { remove_variable = override_valinor_trigger }
	scope:ingwion ?= { remove_variable = override_valinor_trigger }
	scope:finrod_felagund ?= { remove_variable = override_valinor_trigger }
	scope:elulindo ?= { remove_variable = override_valinor_trigger }

	sunset_invasion_general_variables_effect = yes
}

valinor_invasion_set_courtier_employer_effect = {
	$CHARACTER$ = { # Bardir
        if = {
            limit = { is_alive = yes } 
            set_variable = override_valinor_trigger
			if = {
				limit = { has_trait = sailed_west }
				remove_trait = sailed_west
			}
			if = {
				limit = { NOT = { scope:invader_char = { is_employer_of = $CHARACTER$ } } }
				set_employer = scope:invader_char
			}
			
			set_location = scope:invader_char.location
        }
	}
	
}

valinor_invasion_set_courtier_councillor_effect = {
	valinor_invasion_set_courtier_employer_effect = { CHARACTER = $TARGET$ } 

	scope:invader_char = {
		assign_councillor_type = {
			type = $TYPE$
			remove_existing_councillor = yes
			target = $TARGET$
		}
	}
}

valinor_invasion_start_invasion_war = {
	scope:invader_char = {
		start_war = {
			cb = lotr_valinor_invasion_cb
			target = scope:largest_realm_ruler
		}

		sunset_invasion_add_subjects_as_attackers_and_defenders_effect = { GEOGRAPHICAL_REGION = valinor_invasion_region }

		create_story = story_conqueror
	}
}

#####################################
### Pharazon Invasion Sub-effects ###
#####################################

pharazon_invasion_revive_pharazon = {
	character:lineofelros28 = { save_scope_as = dead_pharazon }
	
	create_character = {
		gender = male
		culture = scope:dead_pharazon.culture
		faith = scope:dead_pharazon.faith
		location = root.location
		dynasty = generate
		age = 5000
		save_scope_as = fake_father
		after_creation = { 
			death = {
		 		death_reason = death_disappearance
		 	}	
		}
	}

	create_character = { ### Pharazon
		age = 201
		name = "Pharazo_o_n"
		gender_female_chance = 0
		random_traits = no
		location = root.location
		father = scope:dead_pharazon.father
		dynasty = inherit

		faith = faith:melkorite
		culture = culture:numenorean


		trait = callous				
		trait = arrogant				
		trait = ambitious
		
		trait = education_martial_5
		trait = lifestyle_mariner
		trait = conqueror
		trait = legend
		trait = strategist
		trait = august
		trait = overseer
	
		trait = born_on_numenor
		trait = blood_of_numenor_6
	
		diplomacy = 5
		martial = 7
		stewardship = 4
		intrigue = 5
		learning = 5
		prowess = 7
		save_scope_as = pharazon_reborn

		after_creation = {
			copy_inheritable_appearance_from = scope:dead_pharazon
			give_nickname = nick_the_golden_pharazon
			add_trait_xp = {
				trait = lifestyle_mariner
				value = 100
			}
			set_variable = pharazon_reborn
		}
	}

	scope:dead_pharazon = { set_father = scope:fake_father set_house = scope:fake_father.house } #Replace rela Pharazon with fake pharazon
	scope:pharazon_reborn = { save_scope_as = invader_char }
}

pharazon_invasion_grab_landing_county = {
	title:e_umbar = { # Lindon
		ordered_in_de_jure_hierarchy = { # Check the main harbours first
			limit = {
				tier = tier_county
				is_coastal_county = yes
			}
			order_by = {
				value = 1
				if = {
					limit = { 
						title_province = { has_building_or_higher = wonder_umbar_01 }
					}
					add = 200
				}
				if = {
					limit = { 
						title_province = { has_building_or_higher = wonder_citadel_hyarmendacil_01 }
					}
					add = 100
				}
			}
			save_scope_as = landing_county
		}
	}
}

pharazon_invasion_landing_effect = {
	sunset_invasion_general_landing_effect = {
		TITLE_TO_SPAWN_WITH = title:h_numenor
		LANDING_COUNTY_FAITH = scope:invader_char.faith
		LANDING_COUNTY_CULTURE = scope:invader_char.culture
		PROVINCE_MODIFIER = landing_of_pharazon_host_modifier
	}

	sunset_invasion_general_variables_effect = yes

	random_list = {
		999 = { }
		1 = {
			character:linepharazon1 = {
				set_father = character:lineofelros27
			}
			character:linepharazon1.dynasty = {
				every_dynasty_member = {
					set_house = character:lineofelros27.house
					every_child = {
						even_if_dead = yes
						limit = { exists = dynasty }
						set_house = character:lineofelros27.house
					}
					every_ancestor = {
						even_if_dead = yes
						limit = { exists = dynasty }
						set_house = character:lineofelros27.house
					}
					every_close_family_member = {
						even_if_dead = yes
						limit = { exists = dynasty }
						set_house = character:lineofelros27.house
					}
				}
			}
			character:linepharazon1 = { set_house = character:lineofelros27.house }
		}
	}
	### Army ###
	spawn_army = {
		levies = 0
		men_at_arms = {
			type = numenorean_elites
			stacks = sunset_invasion_troop_amount.div2
		}
		men_at_arms = {
			type = numenorean_marines
			stacks = sunset_invasion_troop_amount
		}
		men_at_arms = {
			type = numenorean_archers
			stacks = sunset_invasion_troop_amount
		}
		men_at_arms = {
			type = numenorean_soldiers
			stacks = sunset_invasion_troop_amount
		}
		men_at_arms = {
			type = trebuchet
			stacks = sunset_invasion_troop_amount
		}
		location = scope:landing_county.title_province
		origin = scope:landing_county.title_province
		inheritable = yes
		uses_supply = no
		name = pharazon_invasion_army_name
	}

	create_artifact_statue_of_pharazon_effect = { OWNER = scope:invader_char }
	create_artifact_aranruth_effect = { OWNER = scope:invader_char }
	scope:newly_created_artifact = { equip_artifact_to_owner = yes }
}

pharazon_invasion_start_invasion_war = {
	scope:invader_char = {
		start_war = {
			cb = lotr_pharazon_invasion_cb
			target = scope:largest_realm_ruler
		}
		sunset_invasion_add_subjects_as_attackers_and_defenders_effect = { GEOGRAPHICAL_REGION = pharazon_invasion_region }

		create_story = story_conqueror
	}
}

#################################
### Amav Invasion Sub-effects ###
#################################

amav_invasion_grab_landing_county = { #amav_invasion_region
	title:c_gaven = { save_scope_as = landing_county }
}

amav_invasion_revive_amav = {
	character:lineofamav1 = { save_scope_as = dead_amav }
	
	create_character = {
		gender = male
		culture = scope:dead_amav.culture
		faith = scope:dead_amav.faith
		location = root.location
		dynasty = generate
		age = 8500
		save_scope_as = fake_father
		after_creation = { 
			death = {
		 		death_reason = death_disappearance
		 	}	
		}
	}

	create_character = { ### Pharazon
		age = 45
		name = "amav"
		gender_female_chance = 0
		random_traits = no
		location = root.location
		dynasty = none

		faith = faith:faith_amav
		culture = culture:akanali

		trait = just
		trait = compassionate
		trait = lustful
		trait = education_learning_5
		trait = beauty_good_3
		trait = saint
		trait = lifestyle_mystic
		trait = paragon
	
		diplomacy = 10
		martial = 7
		stewardship = 6
		intrigue = 8
		learning = 10
		prowess = 12

		save_scope_as = amav_reborn

		after_creation = {
			copy_inheritable_appearance_from = scope:dead_amav
			set_variable = amav_reborn
		}
	}
	scope:amav_reborn = { set_house = scope:dead_amav.dynasty }
	scope:dead_amav = { set_father = scope:fake_father set_house = scope:fake_father.house } #Replace rela Pharazon with fake pharazon
	scope:amav_reborn = { save_scope_as = invader_char }
}

amav_invasion_landing_effect = {
	sunset_invasion_general_landing_effect = {
		TITLE_TO_SPAWN_WITH = title:h_utter_south
		LANDING_COUNTY_FAITH = scope:invader_char.faith
		LANDING_COUNTY_CULTURE = scope:invader_char.culture
		PROVINCE_MODIFIER = landing_of_amav_host_modifier
	}

	sunset_invasion_general_variables_effect = yes

	### Army ###
	spawn_army = {
		levies = 0
		men_at_arms = {
			type = royal_mumakil
			stacks = sunset_invasion_troop_amount
		}
		men_at_arms = {
			type = mumakani_skirmishers
			stacks = sunset_invasion_troop_amount
		}
		men_at_arms = {
			type = mumakani_spears
			stacks = sunset_invasion_troop_amount
		}
		men_at_arms = {
			type = mubadar_berserkers
			stacks = sunset_invasion_troop_amount
		}
		men_at_arms = {
			type = mahud_headhunters
			stacks = sunset_invasion_troop_amount
		}
		men_at_arms = {
			type = nafarati_marauders
			stacks = sunset_invasion_troop_amount
		}
		men_at_arms = {
			type = trebuchet
			stacks = sunset_invasion_troop_amount
		}
		location = scope:landing_county.title_province
		origin = scope:landing_county.title_province
		inheritable = yes
		uses_supply = no
		name = amav_invasion_army_name
	}
}

amav_invasion_start_invasion_war = {
	scope:invader_char = {
		start_war = {
			cb = lotr_amav_invasion_cb
			target = scope:largest_realm_ruler
		}
		sunset_invasion_add_subjects_as_attackers_and_defenders_effect = { GEOGRAPHICAL_REGION = amav_invasion_region }

		create_story = story_conqueror
	}
}