#######################
### ANGMAR WARS CBs ###
#######################

# Planned CBs

# Raid
# Seize border county
# Devestate County
# Devestate Duchy
# Invasion Arnor
# Invasion Angmar 
# Final Battle Arnor 
# Final Battle Angmar 

angmar_wars_raid_cb = {
	group = angmar_wars
	icon = struggle
	
	allow_hostages = no

	interface_priority = 110

	allowed_for_character = {
		is_in_angmar_wars = yes 
	}

	allowed_against_character = {
		is_in_angmar_wars = yes
		scope:defender = {
			NOR = {
				government_has_flag = government_is_landless_adventurer
				government_has_flag = government_is_wastelands
			}
		}
		# The Necromancer is hidden
		NOT = { has_character_flag = unknown_sauron_flag } # LOTR
	}

	allowed_against_character_display_regardless = {
		scope:defender = {
			angmar_wars_is_opposite_side = { CHARACTER = scope:atacker }
		}
	}

	cost = {
		piety = {
			add = {
				value = 100
				desc = CB_BASE_COST
			}
			multiply = common_cb_piety_cost_multiplier
		}
	}

	should_invalidate = {
		OR = {
			scope:attacker = {
				has_culture = culture:wastelands
			}
			scope:defender = {
				has_culture = culture:wastelands
			}
		}
	}

	# on_invalidated_desc = 

	on_invalidated = {
		
	}

	on_declaration = {
		on_declared_war = yes
	}

	on_victory_desc = {
		desc = angmar_wars_raid_cb_desc
	}

	on_victory = {
		scope:attacker = { show_pow_release_message_effect = yes }
		
		# Legitimacy
		add_legitimacy_attacker_victory_effect = yes

		#EP2 Accolade glory gain from winning against higher ranked enemy
		scope:attacker = { accolade_attacker_war_end_glory_gain_low_effect = yes }
		
		# Hope 
		scope:attacker = { # LotR 
			if = { 
				limit = { is_elf = yes }
				add_elven_hope_effect = { VALUE = major_elven_hope_gain HOPE_EFFECT = effect_elven_hope_major_war_won }
			}
		}
		scope:defender = { # LotR 
			if = { 
				limit = { is_elf = yes }
				add_elven_hope_effect = { VALUE = massive_elven_hope_loss HOPE_EFFECT = effect_elven_hope_major_war_lost }
			}
		}

		#Rework when devestation effect added
		every_in_list = {
			list = target_titles
			save_scope_as = raid_county
			# Set raided province modifier
			title_province = {
				add_province_modifier = { # TODO_CD_FP2 (JP) change to border raid modifier?
					modifier = recently_looted_modifier
					years = 5
				}
			}
			show_as_tooltip = {
				every_in_list = {
					list = target_titles
					fp2_border_raid_damage_effect = yes
				}
			}
			# Find province for building destruction
			ordered_county_province = {
				order_by = num_buildings
				random = {
					chance = 25
					modifier = { factor = destroy_building_soldier_multiplier_value } # chance increases with more soldiers
					modifier = { add = destroy_building_development_multiplier_value } # chance increases with development
					custom_tooltip = destroy_random_building_tt
					destroy_random_building_variable_effect = yes
				}
			}
		}

		hidden_effect = {
			scope:attacker = {
				send_interface_message = {
					type = msg_border_raid_good
					title = border_raid_message_title
					show_as_tooltip = {
						every_in_list = {
							list = target_titles
							fp2_border_raid_damage_effect = yes
						}
					}
				}
			}
			scope:defender = {
				send_interface_message = {
					type = msg_border_raid_bad
					title = border_raid_message_title
					every_in_list = {
						list = target_titles
						fp2_border_raid_damage_effect = yes
					}
				}
			}
		}

		scope:attacker = {
			if = {
				limit = { scope:defender.primary_title.tier = tier_county }
				add_prestige = { value = minor_prestige_gain }
			}
			else_if = {
				limit = { scope:defender.primary_title.tier = tier_duchy }
				add_prestige = { value = medium_prestige_gain }
			}
			else_if = {
				limit = { scope:defender.primary_title.tier = tier_kingdom }
				add_prestige = { value = major_prestige_gain }
			}
			else_if = {
				limit = { scope:defender.primary_title.tier = tier_empire }
				add_prestige = { value = massive_prestige_gain }
			}
		}
		scope:defender = {
			if = {
				limit = { scope:defender.primary_title.tier = tier_county }
				add_prestige = { value = minor_prestige_loss }
			}
			else_if = {
				limit = { scope:defender.primary_title.tier = tier_duchy }
				add_prestige = { value = medium_prestige_loss }
			}
			else_if = {
				limit = { scope:defender.primary_title.tier = tier_kingdom }
				add_prestige = { value = major_prestige_loss }
			}
			else_if = {
				limit = { scope:defender.primary_title.tier = tier_empire }
				add_prestige = { value = massive_prestige_loss }
			}
		}
		
		# Allies on both sides get full prestige value for helping in the war, based on their war participation.
		modify_allies_of_participants_fame_values = {
			WINNER = scope:attacker
			FAME_BASE = major_prestige_value
			IS_RELIGIOUS_WAR = no
			WINNER_ALLY_FAME_SCALE = 1
			LOSER_ALLY_FAME_SCALE = 1
		}

		# Truce
		add_truce_attacker_victory_effect = yes

		# EP3: note gold gained from military assistance/join war contracts and their war contribution threshold
		laamp_as_mercenary_payout_tooltip_effect = yes

		#Mandalas gain or lose piety/devotion depending on Decree
		mandala_war_victory_effects = yes

	}

	on_white_peace_desc = {
		desc = angmar_wars_raid_cb_white_peace_desc
	}

	on_white_peace = {
		scope:attacker = { 
			show_pow_release_message_effect = yes
			stress_impact = {
				ambitious = medium_stress_impact_gain
				arrogant = medium_stress_impact_gain
			}
		}
		scope:attacker = {	#Piety loss for the attacker if appropriate, otherwise prestige loss.
			add_prestige = {
				value = medium_prestige_loss
			}
		}

		# Allies on both sides get full prestige value for helping in the war, based on their war participation.
		modify_allies_of_participants_fame_values = {
			WINNER = scope:attacker # not important as the scales are identical
			FAME_BASE = major_prestige_value
			IS_RELIGIOUS_WAR = no
			WINNER_ALLY_FAME_SCALE = 1
			LOSER_ALLY_FAME_SCALE = 1
		}

		scope:defender = {
			stress_impact = {
				arrogant = medium_stress_impact_gain
			}
			add_prestige = {
				value = medium_prestige_gain
			}
		}

		# Truce
		add_truce_attacker_victory_effect = yes

		# EP3: note gold gained from military assistance/join war contracts and their war contribution threshold
		laamp_as_mercenary_payout_tooltip_effect = yes
	}

	on_defeat_desc = {
		desc = angmar_wars_raid_cb_defeat_desc
	}

	on_defeat = {
		scope:attacker = { show_pow_release_message_effect = yes }
		
		# Hope 
		scope:attacker = { # LotR 
			if = { 
				limit = { is_elf = yes }
				add_elven_hope_effect = { VALUE = major_elven_hope_loss HOPE_EFFECT = effect_elven_hope_major_war_lost }
			}
		}
		scope:defender = { # LotR 
			if = { 
				limit = { is_elf = yes }
				add_elven_hope_effect = { VALUE = major_elven_hope_gain HOPE_EFFECT = effect_elven_hope_kingdom_war_won }
			}
		}
		
		# Legitimacy
		add_legitimacy_attacker_defeat_effect = yes

		scope:defender = { 
			mandala_peacemaker_perk_serenity_effect = yes
			#EP2 accolade glory gain for winning against higher ranked enemy
			accolade_defender_war_end_glory_gain_high_effect = yes
		}

		scope:attacker = {
			if = {
				limit = { scope:attacker.primary_title.tier = tier_county }
				add_prestige = { value = minor_prestige_loss }
			}
			else_if = {
				limit = { scope:attacker.primary_title.tier = tier_duchy }
				add_prestige = { value = medium_prestige_loss }
			}
			else_if = {
				limit = { scope:attacker.primary_title.tier = tier_kingdom }
				add_prestige = { value = major_prestige_loss }
			}
			else_if = {
				limit = { scope:attacker.primary_title.tier = tier_empire }
				add_prestige = { value = massive_prestige_loss }
			}
		}
		scope:defender = {
			if = {
				limit = { scope:attacker.primary_title.tier = tier_county }
				add_prestige = { value = minor_prestige_gain }
			}
			else_if = {
				limit = { scope:attacker.primary_title.tier = tier_duchy }
				add_prestige = { value = medium_prestige_gain }
			}
			else_if = {
				limit = { scope:attacker.primary_title.tier = tier_kingdom }
				add_prestige = { value = major_prestige_gain }
			}
			else_if = {
				limit = { scope:attacker.primary_title.tier = tier_empire }
				add_prestige = { value = massive_prestige_gain }
			}
		}
	
		# Allies on both sides get full prestige value for helping in the war, based on their war participation.
		modify_allies_of_participants_fame_values = {
			WINNER = scope:defender
			FAME_BASE = major_prestige_value
			IS_RELIGIOUS_WAR = no
			WINNER_ALLY_FAME_SCALE = 1
			LOSER_ALLY_FAME_SCALE = 1
		}

		# Truce
		add_truce_attacker_defeat_effect = yes

		scope:attacker = { save_temporary_scope_as = loser }
		on_lost_aggression_war_discontent_loss = yes

		# EP3: note gold gained from military assistance/join war contracts and their war contribution threshold
		laamp_as_mercenary_payout_tooltip_effect = yes

		#Mandalas gain or lose piety/devotion depending on Decree
		mandala_war_defeat_effects = yes
	}
}