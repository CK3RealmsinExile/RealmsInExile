#Decisions for and to Tributaries

#Pay Tribute Decision - triggers different hidden Character Interactions to determine your tribute
tribute_mission_decision = {
	picture = {
		trigger = {
			is_tributary_or_independent_neighbor_of_china_trigger = yes
		}
		reference = "gfx/interface/illustrations/event_story/tgp_dynastic_cycle_stability.dds"
	}
	picture = {
		trigger = {
			top_overlord ?= {
				NOT = { has_title = title:h_china }
				government_is_japanese_trigger = yes
			}
		}
		reference = "gfx/interface/illustrations/event_story/tgp_japanese_shogunate.dds"
	}
	picture = {
		reference = "gfx/interface/illustrations/decisions/tgp_projects_mandala_capital.dds"
	}
	decision_group_type = realm

	should_create_alert = { always = yes }

	desc = {
		first_valid = {
			triggered_desc = {
				trigger = { is_tributary_or_independent_neighbor_of_china_trigger = yes }
				desc = tribute_mission_decision_desc_china
			}
			desc = tribute_mission_decision_desc
		}
	}

	is_shown = {
		has_tgp_dlc_trigger = yes

		trigger_if = {
			limit = {
				is_tributary_or_independent_neighbor_of_china_trigger = yes
			}
			NOT = { government_has_flag = government_is_mandala }
		}
		OR = {
			is_tributary = yes
			is_tributary_or_independent_neighbor_of_china_trigger = yes
		}
	}

	is_valid_showing_failures_only = {

		is_available_adult = yes
		
		trigger_if = {
			limit = { is_tributary = yes }
			NOT = { is_at_war_with = overlord } #Pretty obvious
		}

		#And we're not already either doing a Tribute Mission or are on cooldown
		custom_tooltip = {
			text = tribute_mission_decision.already_on_mission
			is_already_tribute_missioning_trigger = no
		}

		custom_tooltip = {
			text = qualifies_for_tribute_mission_trigger
			OR = { # Must be able to offer something
				has_gold_tribute_trigger = yes
				has_herd_tribute_trigger = yes
				has_artifact_tribute_trigger = yes
				AND = {
					has_concubine_tribute_trigger = yes
					trigger_if = {
						limit = { is_tributary = yes }
						can_have_concubines_trigger = { CHAR = overlord }
					}
					trigger_else_if = {
						limit = { is_tributary_or_independent_neighbor_of_china_trigger = yes }
						can_have_concubines_trigger = { CHAR = title:h_china.holder }
					}
					trigger_else = { always = no } # We should never get here, the above is a sanity check
				}
				AND = {
					has_eunuch_tribute_trigger = yes
					trigger_if = {
						limit = { is_tributary = yes }
						can_employ_court_eunuchs_trigger = { CHAR = overlord }
					}
					trigger_else_if = {
						limit = { is_tributary_or_independent_neighbor_of_china_trigger = yes }
						can_employ_court_eunuchs_trigger = { CHAR = title:h_china.holder }
					}
					trigger_else = { always = no } # We should never get here, the above is a sanity check
				}
			}
		}

		#Only triggered by AI
		trigger_if = {
			limit = { 
				is_ai = yes
				is_tributary_or_independent_neighbor_of_china_trigger = yes
			}
			NOT = {
				title:h_china.holder ?= { has_variable = china_has_ai_tribute_mission_cooldown }
			}
		}
		
	}

	widget = {
		gui = "decision_view_widget_pay_tribute"
		controller = decision_option_list_controller
		decision_to_second_step_button = "CHOOSE_TRIBUTE_DECISION_NEXT_STEP_BUTTON"

		item = { # Gold
			value = tribute_mission_gold
			is_valid = { has_gold_tribute_trigger = yes }
			localization = tribute_mission_decision_option_gold
			icon = "gfx/interface/icons/message_feed/money.dds"
			ai_chance = {
				value = 20 
				if = {
					limit = { short_term_gold >= excessive_gold_tribute_value }
					add = 20 
				}
				if = {
					limit = { short_term_gold >= adequate_gold_tribute_value }
					add = 20 
				}
			}
		}
		item = { # Herd
			value = tribute_mission_herd
			is_valid = { has_herd_tribute_trigger = yes }
			localization = tribute_mission_decision_option_herd
			icon = "gfx/interface/icons/icon_herd.dds"
			ai_chance = {
				value = 20 
				if = {
					limit = { 
						domicile ?= { herd >= excessive_herd_tribute_value }
					}
					add = 20 
				}
				if = {
					limit = { 
						domicile ?= { herd >= adequate_herd_tribute_value }
					}
					add = 20 
				}
			}
		}

		item = { # Artifact
			value = tribute_mission_artifact
			is_valid = { has_artifact_tribute_trigger = yes }
			localization = tribute_mission_decision_option_artifact
			icon = "gfx/interface/icons/message_feed/artifact.dds"
			ai_chance = { value = 20 }
		}

		item = { # Concubine 
			value = tribute_mission_concubine
			is_valid = { 
				has_concubine_tribute_trigger = yes
				trigger_if = {
					limit = {
						is_ai = yes
						is_tributary_or_independent_neighbor_of_china_trigger = yes
					}
					highest_held_title_tier >= tier_kingdom
				}
				trigger_if = {
					limit = { is_tributary = yes }
					can_have_concubines_trigger = { CHAR = overlord }
				}
				trigger_else_if = {
					limit = { is_tributary_or_independent_neighbor_of_china_trigger = yes }
					can_have_concubines_trigger = { CHAR = title:h_china.holder }
				}
				trigger_else = { always = no } # We should never get here, the above is a sanity check
			}
			localization = tribute_mission_decision_option_concubine
			icon = "gfx/interface/icons/concubine_icon.dds"
			ai_chance = { value = 50 } #The AI can do it? Do it!
		}

		item = { # Eunuch
			value = tribute_mission_eunuch
			is_valid = { 
				has_eunuch_tribute_trigger = yes
				trigger_if = {
					limit = { is_tributary = yes }
					can_employ_court_eunuchs_trigger = { CHAR = overlord }
				}
				trigger_else_if = {
					limit = { is_tributary_or_independent_neighbor_of_china_trigger = yes }
					can_employ_court_eunuchs_trigger = { CHAR = title:h_china.holder }
				}
				trigger_else = { always = no } # We should never get here, the above is a sanity check
			}
			localization = tribute_mission_decision_option_eunuch
			icon = "gfx/interface/icons/character_interactions/eunuch.dds"
			ai_chance = { value = 50 } #The AI can do it? Do it!
		}
	}

	effect = {
		hidden_effect = { 
			tribute_mission_clean_up_variables_effect = yes
			save_tribute_mission_target_scope_effect = yes
			overlord ?= {
				add_character_flag = {
					flag = pay_tribute_cooldown
					years = 3
				}
			}
		}
		custom_tooltip = tribute_mission_decision_effects_tt
		show_as_tooltip = {
			#China
			if = {
				limit = { subject_standing >= 0 } # we use imperial grace
				custom_tooltip = tribute_mission_interaction_anticipated_rewards_tt_imperial_grace
			}
			#Everyone else
			else = {
				custom_tooltip = tribute_mission_interaction_anticipated_rewards_tt
			}
		}

		#Your Suzerain requested this specifically
		if = {
			limit = {	
				has_variable = requested_tribute_mission
				is_ai = yes
			}
			switch = {
				trigger = has_variable
				requested_tribute_mission_type_gold = { # Gold
					run_interaction = {
						interaction = tribute_mission_gold_interaction
						actor = root
						recipient = scope:tribute_mission_target
						execute_threshold = accept
					}
				}
				requested_tribute_mission_type_herd = { # Herd
					run_interaction = {
						interaction = tribute_mission_herd_interaction
						actor = root
						recipient = scope:tribute_mission_target
						execute_threshold = accept
					}
				}
				requested_tribute_mission_type_artifact = { # Artifact
					var:predetermined_artifact_tribute ?= { save_scope_as = predetermined_artifact_tribute_scope }
					#Do the things from the interaction
					scope:predetermined_artifact_tribute_scope = {
						set_variable = is_tribute_mission_artifact
					}
					#Save the Artifact
					set_variable = {
						name = tribute_mission_type
						value = flag:artifact_tribute
					}
					set_variable = {
						name = offered_artifact
						value = scope:predetermined_artifact_tribute_scope
					}
					#Travel
					tribute_mission_set_up_tribute_travel_effect = yes
				}
				requested_tribute_mission_type_concubine = { # Concubine
					var:predetermined_concubine_tribute ?= { 
						save_scope_as = predetermined_concubine_tribute_scope 
					}
					scope:predetermined_concubine_tribute_scope = {
						add_character_flag = {
							flag = cannot_be_diarch # just enough to make sure they don't succeed to the diarchy while en route
							years = 2
						}
					}
					run_interaction = {
						interaction = tribute_mission_concubine_interaction
						actor = root
						recipient = scope:tribute_mission_target
						secondary_recipient = scope:predetermined_concubine_tribute_scope
						execute_threshold = accept
					}
				}
				requested_tribute_mission_type_eunuch = { # Eunuch	
					var:predetermined_eunuch_tribute ?= { save_scope_as = predetermined_eunuch_tribute_scope }
					run_interaction = {
						interaction = tribute_mission_eunuch_interaction
						actor = root
						recipient = scope:tribute_mission_target
						secondary_recipient = scope:predetermined_eunuch_tribute_scope
						execute_threshold = accept
					}
				}
			}
		}
		else_if = {
			limit = { is_ai = yes }
			switch = {
				trigger = yes

				scope:tribute_mission_gold = { # Gold
					run_interaction = {
						interaction = tribute_mission_gold_interaction
						actor = root
						recipient = scope:tribute_mission_target
						execute_threshold = accept
					}
				}
				
				scope:tribute_mission_herd = { # Herd
					run_interaction = {
						interaction = tribute_mission_herd_interaction
						actor = root
						recipient = scope:tribute_mission_target
						execute_threshold = accept
					}
				}

				scope:tribute_mission_artifact = { # Artifact
					random_character_artifact = { 
						limit = { is_suitable_artifact_tribute_trigger = yes }
						save_scope_as = decision_predetermined_artifact_tribute
					}
					#Do the things from the interaction
					scope:decision_predetermined_artifact_tribute = {
						set_variable = is_tribute_mission_artifact
					}
					#Save the Artifact
					set_variable = {
						name = tribute_mission_type
						value = flag:artifact_tribute
					}
					set_variable = {
						name = offered_artifact
						value = scope:decision_predetermined_artifact_tribute
					}
					#Travel
					tribute_mission_set_up_tribute_travel_effect = yes
				}

				scope:tribute_mission_concubine = { # Concubine
					every_courtier_or_guest = {
						limit = {
							can_be_offered_as_concubine_to_character_trigger = {
								GIVER = root
								CHARACTER = scope:tribute_mission_target
							}
							has_any_disease_trigger = no
							has_easily_mocked_physical_attribute_trigger = no
						}
						add_to_list = potential_concubine_tribute_list
						random_in_list = {
							list = potential_concubine_tribute_list
							weight = {
								#Let's try to make a sane choice here
								base = 0
								#No marginally relevant court people
								modifier = {
									add = 10
									NOR = {
										is_councillor = yes
										has_any_court_position = yes
									}
								}
								#No knights
								modifier = {
									add = 5
									is_knight = no
								}
								#No inspired people?
								modifier = {
									add = 20
									NOT = { exists = inspiration }
								}
								#No close family
								modifier = {
									add = 15
									NOT = { is_close_or_extended_family_of = root }
								}
								#No friends?
								modifier = {
									add = 20
									NOT = { has_relation_friend = root }
								}
								#No children
								modifier = {
									add = 25
									NOT = { is_child_of = root }
								}
							}
							save_scope_as = decision_predetermined_concubine_tribute
						}
					}
					scope:decision_predetermined_concubine_tribute = {
						add_character_flag = {
							flag = cannot_be_diarch # just enough to make sure they don't succeed to the diarchy while en route
							years = 2
						}
					}
					run_interaction = {
						interaction = tribute_mission_concubine_interaction
						actor = root
						recipient = scope:tribute_mission_target
						secondary_recipient = scope:decision_predetermined_concubine_tribute
						execute_threshold = accept
					}
				}

				scope:tribute_mission_eunuch = { # Eunuch
					every_courtier = {
						limit = { 
							tribute_mission_is_available_eunuch_trigger = yes
						}
						add_to_list = potential_eunuch_tribute_list
						random_in_list = {
							list = potential_eunuch_tribute_list
							weight = {
								#Let's try to make a sane choice here
								base = 0
								#No marginally relevant court people
								modifier = {
									add = 10
									NOR = {
										is_councillor = yes
										has_any_court_position = yes
									}
								}
								#No knights
								modifier = {
									add = 5
									is_knight = no
								}
								#No inspired people?
								modifier = {
									add = 20
									NOT = { exists = inspiration }
								}
								#No close family
								modifier = {
									add = 15
									NOT = { is_close_or_extended_family_of = scope:tribute_mission_target }
								}
								#No friends?
								modifier = {
									add = 20
									NOT = { has_relation_friend = scope:tribute_mission_target }
								}
								#No children
								modifier = {
									add = 25
									NOT = { is_child_of = scope:tribute_mission_target }
								}
							}
							save_scope_as = decision_predetermined_eunuch_tribute
						}
					}
					run_interaction = {
						interaction = tribute_mission_eunuch_interaction
						actor = root
						recipient = scope:tribute_mission_target
						secondary_recipient = scope:decision_predetermined_eunuch_tribute
						execute_threshold = accept
					}
				}
			}
		}
		#Natural flow of the decision
		else_if = {
			limit = { is_ai = no }
			switch = {
				trigger = yes

				scope:tribute_mission_gold = { # Gold
					open_interaction_window = {
						interaction = tribute_mission_gold_interaction
						actor = root
						recipient = scope:tribute_mission_target
					}
				}
				
				scope:tribute_mission_herd = { # Herd
					open_interaction_window = {
						interaction = tribute_mission_herd_interaction
						actor = root
						recipient = scope:tribute_mission_target
					}
				}

				scope:tribute_mission_artifact = { # Artifact
					open_interaction_window = {
						interaction = tribute_mission_artifact_interaction
						actor = root
						recipient = scope:tribute_mission_target
					}
				}

				scope:tribute_mission_concubine = { # Concubine 
					open_interaction_window = {
						interaction = tribute_mission_concubine_interaction
						actor = root
						recipient = scope:tribute_mission_target
					}
				}

				scope:tribute_mission_eunuch = { # Eunuch
					open_interaction_window = {
						interaction = tribute_mission_eunuch_interaction
						actor = root
						recipient = scope:tribute_mission_target
					}
				}
			}
		}
		else = { # for AIs
			random_list = {
				20 = {
					run_interaction = {
						interaction = tribute_mission_gold_interaction
						actor = root
						recipient = scope:tribute_mission_target
						execute_threshold = accept
					}
				}
				20 = {
					run_interaction = {
						interaction = tribute_mission_herd_interaction
						actor = root
						recipient = scope:tribute_mission_target
						execute_threshold = accept
					}
				}
				20 = {
					run_interaction = {
						interaction = tribute_mission_artifact_interaction
						actor = root
						recipient = scope:tribute_mission_target
						execute_threshold = accept
					}
				}
				20 = {
					run_interaction = {
						interaction = tribute_mission_concubine_interaction
						actor = root
						recipient = scope:tribute_mission_target
						execute_threshold = accept
					}
				}
				20 = {
					run_interaction = {
						interaction = tribute_mission_eunuch_interaction
						actor = root
						recipient = scope:tribute_mission_target
						execute_threshold = accept
					}
				}
			}
		}
		scope:tribute_mission_target = {
			if = {
				limit = { 
					this = title:h_china.holder
					root = { is_ai = yes }
				}
				set_variable = {
					name = china_has_ai_tribute_mission_cooldown
					years = 1
				}
			}
		}
	}
	
	ai_goal = yes

	ai_potential = {
		is_at_war = no
		OR = {
			is_tributary = yes
			is_tributary_or_independent_neighbor_of_china_trigger = yes
		}

		#Pace the AI
		trigger_if = {
			limit = { 
				is_tributary = yes
				NOT = { has_variable = requested_tribute_mission }
			}
			suzerain = { NOT = { has_character_flag = pay_tribute_cooldown } }
			NOT = { has_variable = tribute_mission_grace }
		}
		NOR = {
			any_owned_story = {
				OR = {
					story_type = story_mongol_invasion
					story_type = story_greatest_of_khans
				}
			}
			mpo_has_gok_mongol_empire_trigger = yes
			has_trait = conqueror
			has_trait = greatest_of_khans
			is_gurkhan = yes
		}
	}

	ai_will_do = {
		base = 20

		modifier = {
			subject_standing >= 0 
			add = {
				add = "opinion(overlord)"
				subtract = subject_standing
				min = 0
			}
			desc = ai_will_do_debug
		}

		modifier = { # AI's who can give gold are more likely
			add = 50
			gold >= small_gold_tribute_value
			ai_greed < 50
			primary_title.tier > tier_county
			desc = ai_will_do_debug
		}
		modifier = { # AI's who can give herd are more likely
			add = 50
			domicile ?= { herd >= small_herd_tribute_value }
			ai_greed < 50
			primary_title.tier > tier_county
			desc = ai_will_do_debug
		}

		modifier = {
			add = -50
			has_relation_rival = overlord
			desc = ai_will_do_debug
		}

		modifier = {
			add = -25
			opinion = {
				target = overlord
				value < 0
			}
			desc = ai_will_do_debug
		}

		modifier = { # Dukes and above should be more weighted
			add = 25
			primary_title.tier >= tier_duchy
			desc = ai_will_do_debug
		}
	}
}
