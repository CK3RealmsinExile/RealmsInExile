### ACTIVITY INVITE RULES ###

# Friends, Best Friends
activity_invite_rule_friends = {
	effect = {
		every_relation = {
			type = friend
			limit = {
				# Remove diarchs from the list.
				bannable_serving_diarch_trigger = no
			}
			add_to_list = characters
		}
	}
}

# Potential Friends
activity_invite_rule_potential_friends = {
	effect = {
		every_relation = {
			type = potential_friend
			limit = {
				# Remove diarchs from the list.
				bannable_serving_diarch_trigger = no
			}
			add_to_list = characters
		}
	}
}

# Rivals, Nemeses
activity_invite_rule_rivals = {
	effect = {
		every_relation = {
			type = rival
			limit = {
				# Remove diarchs from the list.
				bannable_serving_diarch_trigger = no
			}
			add_to_list = characters
		}
	}
}
activity_invite_rule_rivals_if_appropriate = {
	effect = {
		if = {
			limit = {
				# Some characters are willing to have rivals over.
				OR = {
					# Players are eclectic.
					is_ai = no
					# Such as folks they _really_ want dead.
					AND = {
						has_activity_intent = murder_attendee_intent
						intent_target = { has_relation_rival = root }
					}
					involved_activity = {
						has_activity_option = {
							category = special_type
							option = feast_type_murder
						}
					}
					# Or if they're just someone who tries to build bridges.
					has_trait = forgiving
					# Or someone who might prefer the company regardless.
					AND = {
						NOT = { has_trait = vengeful }
						# Because they like people.
						has_trait = gregarious
						has_trait = compassionate
						# Because they can be a bit arbitrary.
						has_trait = fickle
						has_trait = arbitrary
						# Or because they like to gloat.
						has_trait = arrogant
					}
				}
			}
			every_relation = {
				type = rival
				limit = {
					# Remove diarchs from the list.
					bannable_serving_diarch_trigger = no
				}
				add_to_list = characters
			}
		}
	}
}

# Lovers, Soulmates
activity_invite_rule_lovers = {
	effect = {
		every_relation = {
			type = lover
			limit = {
				# Remove diarchs from the list.
				bannable_serving_diarch_trigger = no
			}
			add_to_list = characters
		}
	}
}

# Potential Lovers
activity_invite_rule_potential_lovers = {
	effect = {
		every_relation = {
			type = potential_lover
			limit = {
				# Remove diarchs from the list.
				bannable_serving_diarch_trigger = no
			}
			add_to_list = characters
		}
	}
}

# Children, Grandchildren, Parents, Grandparents
activity_invite_rule_close_family = {
	effect = {
		every_close_family_member = {
			limit = {
				# Remove diarchs from the list.
				bannable_serving_diarch_trigger = no
			}
			add_to_list = characters
		}
	}
}

# Uncles, Aunts, Niblings, Cousins
activity_invite_rule_extended_family = {
	effect = {
		every_extended_family_member = {
			limit = {
				# Remove diarchs from the list.
				bannable_serving_diarch_trigger = no
			}
			add_to_list = characters
		}
	}
}

# Liege
activity_invite_rule_liege = {
	effect = {
		liege ?= {
			if = {
				limit = {
					# Remove diarchs from the list.
					bannable_serving_diarch_trigger = no
				}
				add_to_list = characters
			}
		}
	}
}

# Suzerain
activity_invite_rule_suzerain = {
	effect = {
		suzerain ?= {
			if = {
				limit = {
					# Remove diarchs from the list.
					bannable_serving_diarch_trigger = no
				}
				add_to_list = characters
			}
		}
	}
}

#Confederates
activity_invite_rule_confederates = {
	effect = {
		confederation ?= {
			if = {
				limit = { is_house_based = no } # any_confederation_member is not performant for house blocs
			}
			every_confederation_member = {
				limit = {
					# Remove diarchs from the list.
					bannable_serving_diarch_trigger = no
				}
				add_to_list = characters
			}
		}
	}
}

# Direct Vassals
activity_invite_rule_vassals = {
	effect = {
		every_vassal = {
			limit = {
				trigger_if = { # Prevent AI's from inviting too many barons to save performance
					limit = {
						root = {
							is_ai = yes
						}
					}
					highest_held_title_tier >= tier_county
				}
				# Remove diarchs from the list.
				bannable_serving_diarch_trigger = no
			}
			add_to_list = characters
		}
	}
}

# Tributaries
activity_invite_rule_tributaries = {
	effect = {
		every_tributary = {
			limit = {
				# Remove diarchs from the list.
				bannable_serving_diarch_trigger = no
			}
			add_to_list = characters
		}
	}
}

# Fellow Vassals
activity_invite_rule_fellow_vassals = {
	effect = {
		if = {
			limit = {
				top_liege != this
			}
			liege = {
				every_vassal = {
					limit = {
						trigger_if = { # Prevent AI's from inviting too many barons to save performance
							limit = {
								root = {
									is_ai = yes
								}
							}
							highest_held_title_tier >= tier_county
						}
						# Remove diarchs from the list.
						bannable_serving_diarch_trigger = no
					}
					add_to_list = characters
				}
			}
		}
	}
}

# Neighbouring Rulers
activity_invite_neighbouring_rulers = {
	effect = {
		top_liege ?= {
			every_neighboring_and_across_water_top_liege_realm_owner = {
				limit = {
					# Remove diarchs from the list.
					bannable_serving_diarch_trigger = no
				}
				add_to_list = characters
			}
		}
		if = { #LotR
			limit = { is_elf = yes }
			every_independent_ruler = {
				limit = {
					is_elf = yes
				}
				add_to_list = characters
			}
		}
	}
}

# Knights
activity_invite_rule_knights = {
	effect = {
		every_knight = {
			limit = {
				trigger_if = { # Prevent AI's from inviting too many barons to save performance
					limit = {
						is_ruler = yes
						root = {
							is_ai = yes
						}
					}
					highest_held_title_tier >= tier_county
				}
				is_playable_character = no
				# Remove diarchs from the list.
				bannable_serving_diarch_trigger = no
			}
			add_to_list = characters
		}
	}
}

# Non-Knight Courtiers
activity_invite_rule_courtiers = {
	effect = {
		every_courtier = {
			limit = {
				is_knight = no
				is_playable_character = no
				# Remove diarchs from the list.
				bannable_serving_diarch_trigger = no
			}
			add_to_list = characters
		}
	}
}

# Pool Guests, Foreign Guests
activity_invite_rule_guests = {
	effect = {
		every_pool_guest = {
			limit = {
				# Remove diarchs from the list.
				bannable_serving_diarch_trigger = no
			}
			add_to_list = characters
		}
		every_foreign_court_guest = {
			limit = {
				# Remove diarchs from the list.
				bannable_serving_diarch_trigger = no
			}
			add_to_list = characters
		}
	}
}

# Known House Witches
activity_invite_rule_house_witches = {
	effect = {
		house ?= {
			every_house_member = {
				limit = {
					has_trait = witch
					# Remove diarchs from the list.
					bannable_serving_diarch_trigger = no
				}
				add_to_list = characters
			}
		}
	}
}

# Known non-House Witches
activity_invite_rule_other_witches = {
	effect = {
		# Vassals
		every_vassal_or_below = {
			limit = {
				has_trait = witch
				# Remove diarchs from the list.
				bannable_serving_diarch_trigger = no
			}
			add_to_list = characters
		}
		# Non-House Family
		every_close_or_extended_family_member = {
			limit = {
				has_trait = witch
				# Remove diarchs from the list.
				bannable_serving_diarch_trigger = no
			}
			add_to_list = characters
		}
		# Spouses
		every_spouse = {
			limit = {
				has_trait = witch
				# Remove diarchs from the list.
				bannable_serving_diarch_trigger = no
			}
			add_to_list = characters
		}
		# Liege
		liege ?= {
			if = {
				limit = {
					has_trait = witch
					# Remove diarchs from the list.
					bannable_serving_diarch_trigger = no
				}
				add_to_list = characters
			}
		}
		# Lovers
		every_relation = {
			type = lover
			limit = {
				has_trait = witch
				# Remove diarchs from the list.
				bannable_serving_diarch_trigger = no
			}
			add_to_list = characters
		}
		# Friends
		every_relation = {
			type = friend
			limit = {
				has_trait = witch
				# Remove diarchs from the list.
				bannable_serving_diarch_trigger = no
			}
			add_to_list = characters
		}
		# Courtiers
		every_courtier_or_guest = {
			limit = {
				has_trait = witch
				# Remove diarchs from the list.
				bannable_serving_diarch_trigger = no
			}
			add_to_list = characters
		}
		# Foreign Guests
		every_foreign_court_guest = {
			limit = {
				has_trait = witch
				# Remove diarchs from the list.
				bannable_serving_diarch_trigger = no
			}
			add_to_list = characters
		}
		# Other Known Secrets
		every_known_secret = {
			limit = {
				secret_type = secret_witch
				# Remove diarchs from the list.
				secret_owner = { bannable_serving_diarch_trigger = no }
			}
			secret_owner = { add_to_list = characters }
		}
	}
}

# All lieges and above
activity_invite_rule_all_lieges = {
	effect = {
		every_liege_or_above = {
			limit = {
				# Remove diarchs from the list.
				bannable_serving_diarch_trigger = no
			}
			add_to_list = characters
		}
	}
}

# Head of Faith
activity_invite_rule_hof = {
	effect = {
		faith.religious_head ?= {
			if = {
				limit = {
					# Remove diarchs from the list.
					bannable_serving_diarch_trigger = no
				}
				add_to_list = characters
			}
		}
		if = { #LotR
			limit = { 
				faith.religion = { is_in_family = rf_eruhini }
				character:lineofgandalf = { 
					AND = {
						is_alive = yes
						faith_is_good = yes
						bannable_serving_diarch_trigger = no
					}
				}
			}
			character:lineofgandalf = { add_to_list = characters }
		}
	}
}

# Player Heir
activity_invite_rule_player_heir = {
	effect = {
		player_heir ?= {
			if = {
				limit = {
					# Remove diarchs from the list.
					bannable_serving_diarch_trigger = no
				}
				add_to_list = characters
			}
		}
	}
}

activity_invite_rule_hunters = {
	effect = {
		court_position:master_of_hunt_court_position ?= {
			if = {
				limit = {
					# Remove diarchs from the list.
					bannable_serving_diarch_trigger = no
				}
				add_to_list = characters
			}
		}
		every_vassal = {
			limit = {
				has_trait = lifestyle_hunter
				# Remove diarchs from the list.
				bannable_serving_diarch_trigger = no
			}
			add_to_list = characters
		}
		every_courtier_or_guest = {
			limit = {
				has_trait = lifestyle_hunter
				# Remove diarchs from the list.
				bannable_serving_diarch_trigger = no
			}
			add_to_list = characters
		}
	}
}

activity_invite_rule_glory_hounds = {
	effect = {
		every_vassal = {
			vassal_stance = glory_hound
			limit = {
				# Remove diarchs from the list.
				bannable_serving_diarch_trigger = no
			}
			add_to_list = characters
		}
	}
}

#Close family of both spouses in a Grand Wedding
activity_invite_spouses_close_family = {
	effect = {
		var:promised_grand_wedding_marriage_countdown ?= {
			every_close_family_member = {
				limit = {
					# Remove diarchs from the list.
					bannable_serving_diarch_trigger = no
				}
				add_to_list = characters
			}
			betrothed = {
				every_close_family_member = {
					limit = {
						# Remove diarchs from the list.
						bannable_serving_diarch_trigger = no
					}
					add_to_list = characters
				}
			}
		}
	}
}

#Extended family of both spouses in a Grand Wedding
activity_invite_spouses_extended_family = {
	effect = {
		var:promised_grand_wedding_marriage_countdown ?= {
			every_extended_family_member = {
				limit = {
					# Remove diarchs from the list.
					bannable_serving_diarch_trigger = no
				}
				add_to_list = characters
			}
			betrothed = {
				every_extended_family_member = {
					limit = {
						# Remove diarchs from the list.
						bannable_serving_diarch_trigger = no
					}
					add_to_list = characters
				}
			}
		}
	}
}

activity_invite_rule_siblings = {
	effect = {
		every_sibling = {
			limit = {
				# Remove diarchs from the list.
				bannable_serving_diarch_trigger = no
			}
			add_to_list = characters
		}
	}	
}

activity_invite_rule_crushes = {
	effect = {
		every_relation = {
			type = crush
			limit = {
				# Remove diarchs from the list.
				bannable_serving_diarch_trigger = no
			}
			add_to_list = characters
		}
	}
}

activity_invite_rule_personal_scheme_targets = {
	effect = {
		every_scheme = {
			limit = {
				OR = {
					scheme_type = befriend
					scheme_type = sway
					scheme_type = learn_language
				}
				# Remove diarchs from the list.
				## I mean they shouldn't ever be in here but on the off chance that they _are_ let's not compound the bugs.
				scheme_target_character = { bannable_serving_diarch_trigger = no }
			}
			scheme_target_character ?= { add_to_list = characters }
		}
	}
}

activity_invite_rule_powerful_vassals_children = {
	effect = {
		every_powerful_vassal = { #Prioritize powerful vassal's children, and heirs
			every_child = { add_to_list = characters }
		}
	}
}

# Fellow Vassals
activity_invite_rule_fellow_vassals_children = {
	effect = {
		liege ?= {
			every_vassal = {
				every_child = { add_to_list = characters }
			}
		}
	}
}

activity_invite_rule_vassals_children = {
	effect = {
		every_vassal = {
			limit = {
				trigger_if = { # Prevent AI's from inviting too many barons to save performance
					limit = {
						root = {
							is_ai = yes
						}
					}
					highest_held_title_tier >= tier_county
				}
				NOT = { is_powerful_vassal = yes }
			}
			every_child = { add_to_list = characters }
		}
	}
}

activity_invite_spouses = {
	effect = {
		every_spouse = {
			add_to_list = characters
		}
	}
}

activity_invite_mp = {
	effect = {
		every_player = {
			add_to_list = characters
		}
	}
}

activity_invite_rule_vassals_and_below = {
	effect = {
		every_vassal_or_below = {
			limit = {
				trigger_if = { # Prevent AI's from inviting too many barons to save performance
					limit = {
						root = {
							is_ai = yes
						}
					}
					highest_held_title_tier >= tier_county
				}
			}
			add_to_list = characters
		}
	}
}

activity_invite_rule_charioteers = {
	effect = {
		every_vassal = {
			court_position:charioteer_court_position ?= { add_to_list = characters }
		}
		every_pool_character = {
			province = root.capital_province
			limit = {
				has_any_charioteer_trait = yes
			}
			add_to_list = characters
		}
	}
}

activity_invite_rule_landless_adventurers = {
	effect = {
		every_independent_ruler = {
			limit = {
				has_government = landless_adventurer_government
			}
			add_to_list = characters
		}
	}
}

activity_invite_rule_landless_adventurers_restricted_range = {
	effect = {
		every_in_global_list = {
			variable = laamps_tally
			limit = {
				holder.capital_province ?= {
					squared_distance = {
						target = root.capital_province
						value < define:NTaskContract|ADVENTURER_DISTANCE_RESTRICTION
					}
				}
			}
			holder = { add_to_list = characters }
		}
	}
}

activity_invite_rule_landless_adventurers_restricted_range_opinion = {
	effect = {
		every_in_global_list = {
			variable = laamps_tally
			limit = {
				holder.capital_province ?= {
					squared_distance = {
						target = root.capital_province
						value < define:NTaskContract|ADVENTURER_DISTANCE_RESTRICTION
					}
				}
				holder = { save_temporary_scope_as = adventurer_scope }
				root = {
					OR = {
						has_any_good_relationship_with_character_trigger = { CHARACTER = scope:adventurer_scope }
						has_opinion_modifier = {
							modifier = laamp_used_contact_opinion_special
							target = scope:adventurer_scope
						}
						opinion = {
							target = scope:adventurer_scope
							value >= 50
						}
					}
				}
			}
			holder = { add_to_list = characters }
		}
	}
}
# Every follower, for landless
activity_invite_rule_followers = {
	effect = {
		if = {
			limit = {
				has_government = landless_adventurer_government
			}
			every_courtier = {
				limit = {
					# Ensure they're with you
					location = root.location
				}
				add_to_list = characters
			}
		}
	}
}

# Local lord, for landless
activity_invite_rule_local_lord = {
	effect = {
		if = {
			limit = {
				has_government = landless_adventurer_government
			}
			every_ruler = {
				limit = {
					location = root.location
				}
				add_to_list = characters
			}
		}
	}
}

activity_invite_rule_councillors = {
	effect = {
		every_councillor = {
			add_to_list = characters
		}
	}
}

# IE - Children, Grandchildren, Parents, Grandparents
activity_invite_rule_imperial_exam_close_family = {
	effect = {
		every_close_family_member = {
			limit = {
				is_landed = no
				# Remove diarchs from the list.
				bannable_serving_diarch_trigger = no
				# Exclude children, unless they are exceptional.
				is_adult = yes
				NOR = {
					# You should get as many shots at the Palace Exam as you want.
					has_character_flag = passed_palace_exam
					has_trait = devoted
					has_trait = eunuch
				}
			}
			add_to_list = characters
		}
	}
}

# Applicable entrants for Imperial Examinations
activity_invite_rule_imperial_exam_entrants = {
	effect = {
		situation:dynastic_cycle = {
			every_participant_group = {
				limit = {
					NOT = { participant_group_type = other_rulers }
				}
				every_situation_group_participant = {
					limit = {
						is_landed = no
						tgp_root_gender_can_be_exam_entrant_trigger = yes
						is_available = yes
						is_adult = yes
						NOR = {
							# You should get as many shots at the Palace Exam as you want.
							has_character_flag = passed_palace_exam
							has_trait = devoted
							has_trait = eunuch
						}
					}
					add_to_list = potential_exam_entrants_list
				}
				imperial_examination_entrants_sort_effect = yes
			}
		}
	}
}

# Applicable entrants for Local Examinations
activity_invite_rule_local_exam_entrants = {
	effect = {
		if = {
			limit = {
				government_allows = merit
			}
			root.top_liege = {
				every_vassal_or_below = {
					limit = {
						capital_county.kingdom = root.capital_county.kingdom
						is_landed = no
						NOR = {
							# Has not passed this exam before
							has_character_flag = passed_provincial_exam
							# Or higher level exams
							has_character_flag = passed_metropolitan_exam
						}
						tgp_root_gender_can_be_exam_entrant_trigger = yes
						is_available = yes
						is_adult = yes
					}
					add_to_list = characters
				}
			}
		}
	}
}

activity_invite_rule_landless_family_heads_entrants = {
    effect = {
        if = {
            limit = {
                government_allows = merit
            }
            root.top_liege = {
                every_vassal_or_below = {
                    limit = {
                        is_landed = no
                        OR = {
                            is_ai = no # Players
                            NOT = { # Landless AI's that need to pass provincial
                                has_character_flag = passed_provincial_exam
                            }
                            static_group_filter = { # And a handful of rulers who can act as examiners
                                group = valid_examiners
                                match = 0.05
                            }
                        }
                        trigger_if = {
                            limit = {
                                is_ai = no
                                has_character_flag = passed_provincial_exam
                            }
                            static_group_filter = {
                                group = player_examiner
                                match = 0.15
                            }
                        }
                        tgp_gender_can_be_exam_entrant_trigger = yes
                        trigger_if = {
                        	limit = {
                        		exists = primary_title
                        	}
                        	primary_title = {
								is_mercenary_company = no
								is_holy_order = no
                        	}
                        }
                        is_available = yes
                        is_adult = yes
                    }
                    add_to_list = characters
                }
            }
        }
    }
}

# Local Exam - Children, Grandchildren, Parents, Grandparents
activity_invite_rule_local_exam_close_family = {
	effect = {
		every_close_family_member = {
			limit = {
				is_landed = no
				tgp_root_gender_can_be_exam_entrant_trigger = yes
				# Remove diarchs from the list.
				bannable_serving_diarch_trigger = no
				is_adult = yes
				NOR = {
					# Exclude characters who either passed the exam or exams at a higher level.
					has_character_flag = passed_provincial_exam
					has_character_flag = passed_metropolitan_exam
					has_trait = devoted
					has_trait = eunuch
				}
			}
			add_to_list = characters
		}
	}
}

# IE - Characters who might wish to support their disciples/family
activity_invite_rule_imperial_exam_guests = {
	effect = {
		if = {
			limit = {
				government_allows = merit
			}
			root.top_liege = {
				every_vassal_or_below = {
					limit = {
						has_character_flag = passed_metropolitan_exam
						OR = {
							any_close_family_member = {
								is_landed = no
								tgp_root_gender_can_be_exam_entrant_trigger = yes
								is_available_ai = yes
								# Exclude characters who either passed the exam or exams at a higher level.
								NOT = { has_character_flag = passed_palace_exam }
								court_owner = prev
								# Remove diarchs from the list.
								bannable_serving_diarch_trigger = no
								is_adult = yes
							}
							any_relation = {
								type = disciple
								is_landed = no
								is_available_ai = yes
								# Exclude characters who either passed the exam or exams at a higher level.
								NOT = {
									has_character_flag = passed_metropolitan_exam
								}
								court_owner = prev
							}
							any_spouse = {
								is_landed = no
								tgp_root_gender_can_be_exam_entrant_trigger = yes
								# Exclude characters who either passed the exam or exams at a higher level.
								NOT = {
									has_character_flag = passed_metropolitan_exam
								}
								court_owner = prev
							}					
						}
					}
					add_to_list = potential_exam_guest_list
				}
			}
			imperial_examination_guest_sort_effect = yes
		}
	}
}

# Local Examination - Characters who might wish to support their disciples/family
activity_invite_rule_local_exam_guests = {
	effect = {
		if = {
			limit = {
				government_allows = merit
			}
			root.top_liege = {
				every_vassal_or_below = {
					limit = {
						capital_county.kingdom = root.capital_county.kingdom
						has_character_flag = passed_provincial_exam
						OR = {
							any_close_family_member = {
								tgp_root_gender_can_be_exam_entrant_trigger = yes
								is_landed = no
								is_available_ai = yes
								# Exclude characters who either passed the exam or exams at a higher level.
								NOR = {
									has_character_flag = passed_metropolitan_exam
									has_character_flag = passed_provincial_exam
								}
								court_owner = prev
								is_adult = yes
							}
							any_relation = {
								type = disciple
								is_landed = no
								is_available_ai = yes
								# Exclude characters who either passed the exam or exams at a higher level.
								NOR = {
									has_character_flag = passed_metropolitan_exam
									has_character_flag = passed_provincial_exam
								}
								court_owner = prev
							}
							any_spouse = {
								is_landed = no
								tgp_root_gender_can_be_exam_entrant_trigger = yes
								# Exclude characters who either passed the exam or exams at a higher level.
								NOR = {
									has_character_flag = passed_metropolitan_exam
									has_character_flag = passed_provincial_exam
								}
								court_owner = prev
							}					
						}
					}
					add_to_list = characters
				}
			}
		}
	}
}

# Bloc house heads
activity_invite_rule_bloc_house_heads = {
	effect = {
		house.house_confederation ?= {
			every_confederation_member_house = {
				limit = {
					NOT = { house_head ?= root }
					# Remove diarchs from the list.
					house_head ?= { bannable_serving_diarch_trigger = no }
				}
				house_head = {
					add_to_list = characters
					primary_spouse ?= { add_to_list = characters }
				}
			}
		}
	}
}

# Bloc members
activity_invite_rule_bloc_members = {
	effect = {
		house.house_confederation ?= {
			every_confederation_member_house = {
				every_house_member = {
					limit = {
						is_house_head = no
						is_landed = yes
						top_liege = root.top_liege
						# Remove diarchs from the list.
						bannable_serving_diarch_trigger = no
					}
					add_to_list = characters
					primary_spouse ?= { add_to_list = characters }
				}
			}
		}
	}
}

# Members of your own movement
activity_invite_rule_debate_movement_members = {
	effect = {
		every_ruler = {
			limit = {
				is_available_adult = yes
				government_has_flag = government_is_celestial
				top_participant_group:dynastic_cycle ?= root.top_participant_group:dynastic_cycle
			}
			add_to_list = characters
		}
	}
}

# Members of another movement
activity_invite_rule_debate_movement_other_members = {
	effect = {
		every_ruler = {
			limit = {
				is_available_adult = yes
				government_has_flag = government_is_celestial
				NOR = {
					top_participant_group:dynastic_cycle ?= {
						participant_group_type = undecided_movement
					}
					top_participant_group:dynastic_cycle ?= root.top_participant_group:dynastic_cycle
				}
			}
			add_to_list = characters
		}
	}
}

# Player Family, if opted in: Applicable entrants for Local Examinations
activity_invite_rule_player_family_opt_in_local_exam = {
	effect = {
		if = {
			limit = {
				government_allows = merit
			}
			every_player = {
				limit = {
					top_liege = root.top_liege
					has_character_flag = command_to_attend_flag
				}
				every_close_or_extended_family_member = {
					limit = {
						top_liege = root.top_liege
						NOR = {
							this = prev
							# Has not passed this exam before
							has_character_flag = passed_provincial_exam
							# Or higher level exams
							has_character_flag = passed_metropolitan_exam
							has_trait = devoted
							has_trait = eunuch
						}
						tgp_gender_can_be_exam_entrant_trigger = yes
						is_available = yes
						is_adult = yes
					}
					add_to_list = characters
				}
			}
		}
	}
}

# Player Family, if opted in: Applicable entrants for Imperial Palace Examinations
activity_invite_rule_player_family_opt_in_imperial_exam = {
	effect = {
		if = {
			limit = {
				government_allows = merit
			}
			every_player = {
				limit = {
					top_liege = root.top_liege
					has_character_flag = command_to_attend_flag
				}
				every_close_or_extended_family_member = {
					limit = {
						top_liege = root.top_liege
						NOR = {
							this = prev
							# You should get as many shots at the Palace Exam as you want.
							has_character_flag = passed_palace_exam
							has_trait = devoted
							has_trait = eunuch
						}
						tgp_gender_can_be_exam_entrant_trigger = yes
						is_available = yes
						is_adult = yes
					}
					add_to_list = characters
				}
			}
		}
	}
}
