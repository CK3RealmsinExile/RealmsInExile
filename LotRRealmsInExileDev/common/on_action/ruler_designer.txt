# Root = New character after being made
#
# scope:ruler_designer - ruler type being designed. Possible values:
#	flag:landed_title			Default landed ruler that overrides previous title holder
#								They already have all titles transferred to them
#	flag:landless_adventurer	landless adventurer
#	flag:landless_noble_family	landless noble family inside administrative or other realm that allows landless vassals
#
on_ruler_designer_finished = {
	effect = {
		# Don't fire marriage notification events.
		if = {
			limit = { faith = { has_doctrine_parameter = marriage_event } }
			add_character_flag = ignore_marriage_event
		}
		# Do we need to fire a regency for this character?
		if = {
			limit = {
				OR = {
					is_adult = no
					is_incapable = yes
				}
			}
			add_to_global_variable_list = {
				name = rd_chars_needing_regencies
				target = root
			}
		}
		# If your capital on game start is Mecca, you get the Hajjaj trait (since you can't Hajj to your capital)
		#if = {
		#	limit = {
		#		this = title:b_makka.county.holder
		#		faith = { has_doctrine_parameter = mandatory_hajj }
		#		NOT = { has_trait = hajjaj }
		#	}
		#	# Have some Hajjaj
		#	add_trait = hajjaj
		#}
		
		## Landless adventurer
		if = {
			limit = {
				scope:ruler_designer = flag:landless_adventurer
			}
			create_landless_adventurer_title_effect = {
				REASON = flag:voluntary
				FLAVOR_CHAR = root
			}
		}
		else_if = {
			limit = {
				scope:ruler_designer = flag:landless_noble_family
			}
			location.county.holder.top_liege = { save_scope_as = government_giver }
			set_employer = scope:government_giver
			create_noble_family_effect = { GOVERNMENT_GIVER = scope:government_giver }
			debug_log_scopes = yes
			## remove the script below after TIT-64172 is fixed
			if = {
				limit = {
					scope:government_giver != root.top_liege
				}
	            create_title_and_vassal_change = {
	                type = swear_fealty
	                save_scope_as = change
	            }
	            change_liege = {
	                liege = scope:government_giver
	                change = scope:change
	            }
	            resolve_title_and_vassal_change = scope:change
			}
			add_gold = 100
		}
		add_prestige = {
			value = root.prestige
			multiply = -1 # if you're making a custom character, starting_prestige won't calculate correctly, so we reset here and perform the same calculation again
			add = {
				value = medium_prestige_value
				multiply = {
					value = 0

					# Bonus for older characters (who have presumably accomplished more).
					if = {
						limit = { age > 60 }
						add = 5
					}
					else_if = {
						limit = { age > 48 }
						add = 4
					}
					else_if = {
						limit = { age > 36 }
						add = 3
					}
					else_if = {
						limit = { age > 24 }
						add = 2
					}
					else_if = {
						limit = { age > 12 }
						add = 1
					}

					# Bonus/penalty for traits.
					if = {
						limit = {
							OR = {
								has_trait = arrogant
								has_trait = ambitious
							}
						}
						add = 1
					}
					else_if = {
						limit = {
							OR = {
								has_trait = humble
								has_trait = content
							}
						}
						add = -1
					}

					# Humble/content children shouldn't have a prestige penalty!
					min = 0
				}
			}

			# Rulers also gain bonus prestige based on their tier.
			add = {
				value = medium_prestige_value
				multiply = highest_held_title_tier
			}
		}
	}
}
