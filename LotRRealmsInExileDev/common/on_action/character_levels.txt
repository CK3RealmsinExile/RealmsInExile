on_piety_level_gain = {
	effect = {
		if = {
			limit = { government_has_flag = government_is_mandala }
			send_interface_toast = {
				type = msg_character_level_increase
				title = piety_level_gain.message
				desc = piety_level_gain.mandala.desc
				left_icon = root
			}
			if = {
				limit = {
					NOT = { has_character_flag = notified_about_max_piety_level }
				}
				if = {
					limit = { 
						piety_level = max_piety_level
						NOR = {
							has_character_modifier = budding_divinity_modifier
							has_character_modifier = budding_deity_modifier 
							has_character_modifier = budding_godhood_modifier 
						}
					}
					send_interface_toast = {
						type = msg_mandala_neutral_text
						title = maximum_devotion_reached_msg
						desc = maximum_devotion_reached_msg_desc
						left_icon = root
						add_character_flag = {
							flag = notified_about_max_piety_level
							days = 5
						}
					}
				}
				if = {
					limit = { piety_level = max_piety_level_plus_1 }
					create_character_memory = { type = past_max_piety_level_memory }
					scope:new_memory ?= {
						set_variable = {
							name = past_max_piety_level_var
							value = 1
						}
						if = {
							limit = { exists = var:past_max_piety_level_var }
							#To prevent 'unused except in loc' errors :catto:
						}
					}
					if = {
						limit = {
							NOR = {
								has_character_modifier = budding_deity_modifier 
								has_character_modifier = budding_godhood_modifier 
							}
						}
						send_interface_toast = {
							type = msg_mandala_neutral_text
							title = maximum_devotion_reached_msg
							desc = maximum_devotion_reached_msg_desc
							left_icon = root
							add_character_flag = {
								flag = notified_about_max_piety_level
								days = 5
							}
						}
					}
				}
				if = {
					limit = { piety_level = max_piety_level_plus_2 }
					create_character_memory = { type = past_max_piety_level_memory }
					scope:new_memory ?= {
						set_variable = {
							name = past_max_piety_level_var
							value = 2
						}
						if = {
							limit = { exists = var:past_max_piety_level_var }
							#To prevent 'unused except in loc' errors :catto:
						}
					}
					if = {
						limit = {
							NOT = { has_character_modifier = budding_godhood_modifier }
						}
						send_interface_toast = {
							type = msg_mandala_neutral_text
							title = maximum_devotion_reached_msg
							desc = maximum_devotion_reached_msg_desc
							left_icon = root
							add_character_flag = {
								flag = notified_about_max_piety_level
								days = 5
							}
						}
					}
				}
				if = {
					limit = { piety_level = max_piety_level_plus_3 }
					create_character_memory = { type = past_max_piety_level_memory }
					scope:new_memory ?= {
						set_variable = {
							name = past_max_piety_level_var
							value = 3
						}
						if = {
							limit = { exists = var:past_max_piety_level_var }
							#To prevent 'unused except in loc' errors :catto:
						}
					}
				}
			}

		}
		else = {
			send_interface_toast = {
				type = msg_character_level_increase
				title = piety_level_gain.message
				desc = piety_level_gain.desc
				left_icon = root
			}
		}

		every_child ?= {  #bp2_yearly.4020 event chain piety tracker
			limit = {
				any_memory = {
					memory_type = pious_parent_became_very_pious
					any_memory_participant = {
						this = root
					}
				}
				has_variable = parent_piety_lvl
			}
			change_variable = {
				name = parent_piety_lvl
				add = 1
			}
		}
		
		# Holy Legend Seed drop
		if = {
			limit = {
				has_dlc_feature = legends
				piety_level >= max_piety_level
				NOT = { has_variable = saintly_deed_var }
				is_ruler = yes
				NOR = { 
					has_game_rule = historical_legends_only 
					has_personal_legend_seed = holy
				}
			}
			random = {
				chance = 50
				send_interface_toast = {
					type = msg_legend_seed_created
					title = holy_seed_toast 
					left_icon = root
					set_variable = saintly_deed_var
					create_legend_seed = {
						type = holy
						quality = famed
						chronicle = saintly_life
						properties = {
							religion = root.religion
						}
					}
				}
			}
		}
	}
}

on_piety_level_loss = {
	effect = {
		if = {
			limit = {
				NOT = { has_variable = busy_in_mandala_succession }
			}
			send_interface_toast = {
				type = msg_character_level_decrease
				title = piety_level_loss.message
				desc = piety_level_loss.desc
				left_icon = root
			}
		}	

		every_child ?= {  #bp2_yearly.4020 event chain piety tracker
			limit = {
				any_memory = {
					memory_type = pious_parent_became_very_pious
					any_memory_participant = {
						this = root
					}
				}
				has_variable = parent_piety_lvl
			}
			change_variable = {
				name = parent_piety_lvl
				subtract = 1
			}
		}
	}
}

on_prestige_level_gain = {
	effect = {
		send_interface_toast = {
			type = msg_character_level_increase
			title = prestige_level_gain.message
			desc = prestige_level_gain.desc
			left_icon = root
		}

		if = { # But you have heard of me? | Achievement
			limit = {
				NOT = { exists = global_var:lotr_achievement_65 }
				realms_achievements_enabled = yes
				OR = {
					culture = culture:umbarean
					culture = culture:corsair
					culture = { any_parent_culture_or_above = { this = culture:umbarean } }
					culture = { any_parent_culture_or_above = { this = culture:corsair } }
				}
				prestige_level = 5
			}
			set_global_variable = lotr_achievement_65
		}
	
		every_child ?= {  #bp2_yearly.4010 event chain fame tracker
			limit = {
				any_memory = {
					memory_type = famed_parent_became_very_famous
					any_memory_participant = {
						this = root
					}
				}
				has_variable = parent_fame_lvl
			}
			change_variable = {
				name = parent_fame_lvl
				add = 1
			}
		}
	}

}

on_prestige_level_loss = {
	effect = {
		send_interface_toast = {
			type = msg_character_level_decrease
			title = prestige_level_loss.message
			desc = prestige_level_loss.desc
			left_icon = root
		}

		every_child ?= {  #bp2_yearly.4010 event chain fame tracker
			limit = {
				any_memory = {
					memory_type = famed_parent_became_very_famous
					any_memory_participant = {
						this = root
					}
				}
				has_variable = parent_fame_lvl
			}
			change_variable = {
				name = parent_fame_lvl
				add = 1
			}
		}
	}
}

on_influence_level_gain = {
	effect = {
		if = {
			limit = {
				government_allows = administrative
			}
			send_interface_toast = {
				type = msg_character_level_increase
				title = influence_level_gain.message
				desc = influence_level_gain.desc
				left_icon = root
			}
		}
	}
}

on_influence_level_loss = {
	effect = {
		if = {
			limit = {
				government_allows = administrative
			}
			send_interface_toast = {
				type = msg_character_level_decrease
				title = influence_level_loss.message
				desc = influence_level_loss.desc
				left_icon = root
			}
		}
	}
}

on_merit_level_gain = {
	effect = {
		if = {
			limit = {
				government_allows = merit
				# Not the top lieges of celestial or meritocratic government.
				this != top_liege
			}
			# Notify of level increase
			send_interface_toast = {
				type = msg_character_level_increase
				title = merit_level_gain.message
				desc = merit_level_gain.desc
				left_icon = root
				
				# Domicile buildings
				if = {
					limit = {
						exists = domicile
					}
					if = {
						limit = {
							domicile = { has_domicile_parameter = estate_merit_rank_increase_bonus_6 }
						}
						add_prestige = estate_merit_rank_increase_bonus_6_value
						add_piety = estate_merit_rank_increase_bonus_6_value
						change_influence = estate_merit_rank_increase_bonus_6_value
					}
					else_if = {
						limit = {
							domicile = { has_domicile_parameter = estate_merit_rank_increase_bonus_5 }
						}
						add_prestige = estate_merit_rank_increase_bonus_5_value
						add_piety = estate_merit_rank_increase_bonus_5_value
						change_influence = estate_merit_rank_increase_bonus_5_value
					}
					else_if = {
						limit = {
							domicile = { has_domicile_parameter = estate_merit_rank_increase_bonus_4 }
						}
						add_prestige = estate_merit_rank_increase_bonus_4_value
						add_piety = estate_merit_rank_increase_bonus_4_value
						change_influence = estate_merit_rank_increase_bonus_4_value
					}
					else_if = {
						limit = {
							domicile = { has_domicile_parameter = estate_merit_rank_increase_bonus_3 }
						}
						add_prestige = estate_merit_rank_increase_bonus_3_value
						add_piety = estate_merit_rank_increase_bonus_3_value
						change_influence = estate_merit_rank_increase_bonus_3_value
					}
					else_if = {
						limit = {
							domicile = { has_domicile_parameter = estate_merit_rank_increase_bonus_2 }
						}
						add_prestige = estate_merit_rank_increase_bonus_2_value
						add_piety = estate_merit_rank_increase_bonus_2_value
						change_influence = estate_merit_rank_increase_bonus_2_value
					}
					else_if = {
						limit = {
							domicile = { has_domicile_parameter = estate_merit_rank_increase_bonus_1 }
						}
						add_prestige = estate_merit_rank_increase_bonus_1_value
						add_piety = estate_merit_rank_increase_bonus_1_value
						change_influence = estate_merit_rank_increase_bonus_1_value
					}
				}
			}
			
			# When advancing a merit level for the first time - Get an event telling you about it
			if = {
				limit = {
					is_ai = no
				}
				trigger_event = { id = tgp_china_career.0010 days = { 2 10 } }
			}
		}
		# Remove the elder relation if the elder has lower merit level than the disciple
		every_relation = {
			type = elder
			limit = {
				merit_level <= root.merit_level
			}
			remove_relation_disciple = root
		}
		if = {
			limit = {
				culture = {
					has_cultural_parameter = family_shares_merit
				}
				merit_level = 5
				any_close_family_member = {
					culture = {
						has_cultural_parameter = family_shares_merit
					}
					is_faith_dominant_gender = yes
					merit_level < 5
					top_liege = root.top_liege
				}
			}
			send_interface_toast = {
				type = event_toast_effect_good
				title = tradition_stratified_society_toast_title
				left_icon = root
				custom_tooltip = tradition_stratified_society_toast_desc
			}
			save_temporary_scope_as = family_success
			every_close_family_member = {
				limit = {
					culture = {
						has_cultural_parameter = family_shares_merit
					}
					is_faith_dominant_gender = yes
					merit_level < 5
					top_liege = root.top_liege
				}
				change_merit = stratified_society_merit_gain_value
				if = {
					limit = {
						NOT = {
							has_character_flag = passed_provincial_exam
						}
					}
					add_character_flag = passed_provincial_exam
					if = {
						limit = {
							NOR = { 
								has_character_modifier = tgp_passed_provincial_exam_modifier
								has_character_modifier = tgp_bypassed_provincial_exam_modifier
								has_character_modifier = tgp_nepotism_bypass_exams_modifier
							}
						}
						add_character_modifier = {
							modifier = tgp_nepotism_bypass_exams_modifier
						}
					}
				}
				send_interface_toast = {
					type = event_toast_effect_good
					title = tradition_stratified_society_family_member_toast_title
					left_icon = this
					right_icon = root
					custom_tooltip = tradition_stratified_society_family_member_toast_desc
				}
			}
		}
	}
}

on_merit_level_loss = {
	effect = {
		if = {
			limit = {
				government_allows = merit
			}
			send_interface_toast = {
				type = msg_character_level_decrease
				title = merit_level_loss.message
				desc = merit_level_loss.desc
				left_icon = root
			}
		}
		# Remove the elder relation if the elder has lower merit level than the disciple
		every_relation = {
			type = disciple
			limit = {
				merit_level >= root.merit_level
			}
			remove_relation_elder = root
		}
	}
}
