mirkwood_corruption_situation = {
    gui_window_name = "lotr_window_mirkwood_corruption_situation"
    map_mode = sub_regions
    is_unique = yes
    migration = no

    ### Regions ###
    sub_regions = {
        aradhrynd = {
            map_color = { 20 60 30 }
            geographical_regions = { custom_aradhrynd }
        }
        taurduin = {
            map_color = { 25 65 35 }
            geographical_regions = { custom_taurduin }
        }
        taur_nu_fuin = {
            map_color = { 30 70 40 }
            geographical_regions = { custom_taur_nu_fuin }
        }
        emyn_i_firith = {
            map_color = { 35 75 45 }
            geographical_regions = { custom_emyn_i_firith }
        }
        nivrim = {
            map_color = { 40 80 50 }
            geographical_regions = { custom_nivrim }
        }
        dundaedelu = {
            map_color = { 45 85 55 }
            geographical_regions = { custom_dundaedelu }
        }
        angaladh_rhunen = {
            map_color = { 50 90 60 }
            geographical_regions = { custom_angaladh_rhunen }
        }
        men_i_naugrim = {
            map_color = { 55 95 65 }
            geographical_regions = { custom_men_i_naugrim }
        }
        gwath_anglennol = {
            map_color = { 60 100 70 }
            geographical_regions = { custom_gwath_anglennol }
        }
        taur_e_ndaedlos = {
            map_color = { 65 105 75 }
            geographical_regions = { custom_taur_e_ndaedlos }
        }
        amon_lanc = {
            map_color = { 70 110 80 }
            geographical_regions = { custom_amon_lanc }
        }
    }

    ### Participants ###
    participant_groups = {
        corruption_spreaders = {
            icon = "gfx/interface/icons/situations/mirkwood_corruption/mirkwood_situation_web_of_night.dds"
            require_capital_in_sub_region = no
            require_realm_in_sub_region = no
            require_domain_in_sub_region = no
            is_character_valid = {
                OR = {
                    has_character_flag = unknown_sauron_flag
                    is_nazgul = yes
                }
                has_title = title:c_amon_lanc
            }
        }
        corruption_vassals = {
            icon = "gfx/interface/icons/situations/mirkwood_corruption/mirkwood_situation_web_of_night.dds"
            require_capital_in_sub_region = yes
            require_realm_in_sub_region = yes
            is_character_valid = {
                top_liege = {
                    OR = {
                        has_character_flag = unknown_sauron_flag
                        is_nazgul = yes
                    }
                    has_title = title:c_amon_lanc
                }
            }
        }
        ruler_of_lasgalen = {
            icon = "gfx/interface/icons/situations/mirkwood_corruption/mirkwood_situation_untainted_wood.dds"
            require_capital_in_sub_region = no
            require_realm_in_sub_region = no
            require_domain_in_sub_region = no
            is_character_valid = {
                has_character_flag = ruler_of_lasgalen
            }

            on_join = {
                if = {
                    limit = {
                        is_ai = no
                    }
                    trigger_event = mirkwood_corruption.0001
                }
            }

            map_color = { 255 127 80 }
        }
        elves = {
            icon = "gfx/interface/icons/situations/mirkwood_corruption/mirkwood_situation_untainted_wood.dds"
            require_capital_in_sub_region = yes
            require_realm_in_sub_region = no
            is_character_valid = {
                NOT = { has_character_flag = ruler_of_lasgalen }
                has_government = elven_government
                highest_held_title_tier >= tier_county
            }

            on_join = {
                if = {
                    limit = {
                        is_ai = no
                    }
                    trigger_event = mirkwood_corruption.0001
                }
            }

            map_color = { 255 127 80 }
        }

        radagast = {
            icon = "gfx/interface/icons/situations/mirkwood_corruption/mirkwood_situation_untainted_wood.dds"
            require_capital_in_sub_region = no
            require_realm_in_sub_region = no
            require_domain_in_sub_region = no
            is_character_valid = {
                has_character_flag = radagast
            }

            on_join = {
                if = {
                    limit = {
                        is_ai = no
                    }
                    trigger_event = mirkwood_corruption.0001
                }
            }

            map_color = { 173 216 230 }
        }
        mirkwood_inhabitants = {
            icon = "gfx/interface/icons/situations/mirkwood_corruption/mirkwood_situation_untainted_wood.dds"
            require_capital_in_sub_region = yes
            require_realm_in_sub_region = yes
            is_character_valid = {
                NOT = { has_character_flag = radagast }
                NOT = { has_character_flag = ruler_of_lasgalen }
                NOT = { has_character_flag = unknown_sauron_flag }
                NOT = { has_character_flag = khamul }
                NOT = { has_government = elven_government}
                highest_held_title_tier >= tier_county
            }

            on_join = {
                if = {
                    limit = {
                        is_ai = no
                    }
                    trigger_event = mirkwood_corruption.0001
                }
            }

            map_color = { 34 139 34 }
        }
        mirkwood_laamp = {
            icon = "gfx/interface/icons/situations/mirkwood_corruption/mirkwood_situation_untainted_wood.dds"
            require_capital_in_sub_region = no
            require_realm_in_sub_region = no
            require_domain_in_sub_region = yes
            is_character_valid = {
                has_government = landless_adventurer_government
                domicile.domicile_location ?= { geographical_region = middleearth_west_rhovanion_mirkwood }
            }

            on_join = {
                if = {
                    limit = {
                        is_ai = no
                    }
                    trigger_event = mirkwood_corruption.0001
                }
            }

            map_color = { 255 140 0 }
        }
    }



    ### On Actions ###
    on_start = {
        save_scope_as = mirkwood_situation
    }
    on_monthly = {
        save_scope_as = mirkwood_situation
        update_mirkwood_monthly_phase_effect = yes
        mkw_refresh_active_subregions_effect = yes
        remove_excess_corruption_effect = yes
    }

    on_yearly = {

    }

    ### Phases ###

    phases = { # Untainted Wood, Whispers in the Leaves, The Withering Shade, Shadow’s Grasp, The Web of Night

        untainted_wood = {
            icon = "gfx/interface/icons/situations/mirkwood_corruption/mirkwood_situation_untainted_wood.dds"
            on_start = {}

            future_phases = {
                whispers_in_the_leaves = {}
            }
        }

        whispers_in_the_leaves = {
            icon = "gfx/interface/icons/situations/mirkwood_corruption/mirkwood_situation_whispers_in_the_leaves.dds"
            on_start = {}

            future_phases = {
                untainted_wood = {}
                the_withering_shade = {}
            }
        }

        the_withering_shade = {
            icon = "gfx/interface/icons/situations/mirkwood_corruption/mirkwood_situation_the_withering_shade.dds"
            on_start = {}
            future_phases = {
                whispers_in_the_leaves = {}
                shadows_grasp = {}
            }
        }

        shadows_grasp = {
            icon = "gfx/interface/icons/situations/mirkwood_corruption/mirkwood_situation_shadows_grasp.dds"
            on_start = {}
            future_phases = {
                the_withering_shade = {}
                the_web_of_night = {}
            }
        }

        the_web_of_night = {
            icon = "gfx/interface/icons/situations/mirkwood_corruption/mirkwood_situation_web_of_night.dds"
            on_start = {
                scope:situation_sub_region = {
                    save_scope_as = my_subregion
                    every_situation_sub_region_participant_group = {
                        limit = {
                            NOT = {
                                participant_group_type = corruption_spreaders
                                participant_group_type = corruption_vassals
                            }
                        }
                        every_situation_group_participant = {
                            trigger_event = mirkwood_corruption.0015
                        }
                    }
                    every_situation_sub_region_county = {
                        if = {
                            limit = {
                                title_province = { has_holding_type = wastelands_holding }
                                NOT = { title_province = { has_building = shadow_of_mirkwood } }
                            }
                            if = {
                                limit = {
                                    title_province = { has_free_building_slot = yes }
                                }
                                title_province = { add_building = shadow_of_mirkwood }
                            }
                            else = {
                                title_province = { add_province_modifier = mirkwood_wilderness_modifier }
                                title_province = { add_building = shadow_of_mirkwood }
                            }
                        }
                    }
                }
            }
            future_phases = {
                shadows_grasp = {}
            }
        }
    }
}