@msg_completion_effect_natural_disaster = "event:/DLC/EP4/SFX/Stingers/China/tgp_mx_sting_finishing_great_project_disaster"

@disaster_relief_asian_illustration = "gfx/interface/illustrations/great_projects/asia_great_project_default.dds"
@disaster_relief_generic = "gfx/interface/illustrations/activity_header_backgrounds/activity_survey.dds"

@icon_asian_great_project = "gfx/interface/icons/great_projects/city_china.dds"
@icon_generic_great_project = "gfx/interface/icons/great_projects/_default.dds"

great_project_earthquake = {
	icon = {
		trigger = {
			scope:province ?= {
				geographical_region = world_asia
			}
		}
		reference = @icon_asian_great_project
	}
	icon = {
		reference = @icon_generic_great_project
	}

	illustration = {
		trigger = {
			scope:province ?= {
				geographical_region = world_asia
			}
		}
		reference = @disaster_relief_asian_illustration
	}
	illustration = {
		reference = @disaster_relief_generic
	}

	is_shown = {
		tgp_natural_disaster_great_project_trigger = { TYPE = earthquake }
	}

	can_start_planning = {
		always = no
	}

	can_cancel = {
		always = no
	}

	is_valid = {
		exists = var:situation
	}

	construction_time = 60
	contributor_cooldown = standard_contributor_cooldown_value

	on_complete = {
		natural_disaster_great_project_save_scopes_effect = yes
		scope:owner = {
			trigger_event = natural_disaster.4001
		}
		scope:situation = {							
			situation_participant_group:affected_vassal = {
				every_situation_group_participant = {
					limit = { 
						is_ai = no
						is_vassal_or_below_of = scope:owner
					}
					trigger_event = natural_disaster.4002
				}
			}
		}
	}

	on_start_build = {
		natural_disaster_great_project_save_scopes_effect = yes
		scope:owner = {
			add_prestige = minor_prestige_value 
		}
	}

	allowed_contributor_filter = {
		vassals = yes
	}

	is_important = yes
	show_in_list = no
	group = environmental_project
	completion_sound_effect = @msg_completion_effect_natural_disaster

	project_contributions = {
		recovery = {
			contributor_cooldown = natural_disaster_individual_contribution_cooldown_value
			is_required = yes
			
			context_allows_contributions = {
				tpg_great_project_disaster_in_recovery_phase_trigger = yes
			}

			contributor_is_valid = {
				tgp_natural_disaster_is_valid_contributor_trigger = yes
			}

			cost = { 
				gold = {
					value = 0
					if = {
						limit = { has_treasury = no }
						add = natural_disaster_contributions_cost_value
						add = natural_disaster_contributions_cost_base_discount
						multiply = {
							add = 0.5
							multiply = scope:great_project.var:situation.var:severity
							desc = great_project_contribution_cost_situation_severity
						}
						# Innovation-based cost discounts
						if = {
							limit = { culture = { has_innovation = innovation_ledger } }
							multiply = {
								add = 0.9
								desc = great_project_contribution_cost_innovation_ledger
							}
						}
						if = {
							limit = { culture = { has_innovation = innovation_seigneurialism } }
							multiply = {
								add = 0.85
								desc = great_project_contribution_cost_innovation_seigneurialism
							}
						}
					}
				}
				treasury = {
					value = 0
					if = {
						limit = { has_treasury = yes }
						add = natural_disaster_contributions_cost_treasury_value
						add = natural_disaster_contributions_cost_base_discount
						multiply = {
							add = 0.5
							multiply = scope:great_project.var:situation.var:severity
							desc = great_project_contribution_cost_situation_severity
						}
						# Innovation-based cost discounts
						if = {
							limit = { culture = { has_innovation = innovation_ledger } }
							multiply = {
								add = 0.9
								desc = great_project_contribution_cost_innovation_ledger
							}
						}
						if = {
							limit = { culture = { has_innovation = innovation_seigneurialism } }
							multiply = {
								add = 0.85
								desc = great_project_contribution_cost_innovation_seigneurialism
							}
						}
					}
				}
			}

			on_contribution_funded = {
				natural_disaster_great_project_save_scopes_effect = yes
				if = {
					limit = { culture = { has_innovation = innovation_court_officials } }
					custom_tooltip = great_project_contribution_cost_innovation_court_officials
				}
				else_if = {
					limit = { culture = { has_innovation = innovation_baliffs } }
					custom_tooltip = great_project_contribution_cost_innovation_baliffs
					add_character_modifier = {
						modifier = tgp_natural_disaster_recovery_tax_burden_reduced
					}
				}
				else = {
					add_character_modifier = {
						modifier = tgp_natural_disaster_recovery_tax_burden
					}
				}
				if = {
					limit = { culture = { has_innovation = innovation_double_entry_bookkeeping } }
					custom_tooltip = great_project_contribution_cost_innovation_double_entry_bookkeeping
					add_character_modifier = {
						modifier = tgp_natural_disaster_recovery_popular_hero
						years = 20
					}
				}
				else = {
					add_character_modifier = {
						modifier = tgp_natural_disaster_recovery_popular_hero
						years = 10
					}
				}
				great_project_notify_contribution = yes
				great_project_contribution_catalyst_effect = yes
			}

			on_complete = {
				natural_disaster_great_project_save_scopes_effect = yes
				
				send_interface_toast = {
					type = event_toast_effect_good
					title = great_project_contribution_msg_t
					left_icon = root
					right_icon = scope:great_project.great_project_location.duchy

					if = {
						limit = { is_alive = yes }
						natural_disaster_great_project_mandatory_investment_reward_effect = yes
						if = {
							limit = { 
								culture = { 
									has_innovation = innovation_baliffs
									NOT = { has_innovation = innovation_court_officials } 
								}
							}
							remove_character_modifier = tgp_natural_disaster_recovery_tax_burden_reduced
						}
						else_if = {
							limit = { culture = { NOT = { has_innovation = innovation_court_officials } } }
							remove_character_modifier = tgp_natural_disaster_recovery_tax_burden
						}
					}
				}
			}

			ai_will_do = {
				add = -50
				if = { # nobody better than me to deal with this
					limit = { this = top_liege }
					add = 100
				}
				add = {
					value = 0.5
					multiply = ai_honor
				}
				add = {
					value = -0.5
					multiply = ai_greed
				}
				add = {
					value = 0.25
					multiply = ai_rationality
				}
				add = {
					value = 0.25
					multiply = ai_energy
				}
				add = {
					value = 0.5
					multiply = ai_boldness
				}
				add = {
					value = 0.25
					multiply = ai_zeal
				}
				add = {
					value = -0.25
					multiply = ai_vengefulness
				}
				add = {
					value = 0.75
					multiply = ai_compassion
				}
				add = {
					value = 0.25
					multiply = ai_sociability
				}
				if = {
					limit = {
						is_at_war = yes
					}
					multiply = 0
				}
			}

			ai_check_interval_by_tier = {							
				barony = 0
				county = 6
				duchy = 2
				kingdom = 1
				empire = 1
				hegemony = 1
			}
		}
		cleanup = {
			contributor_cooldown = natural_disaster_individual_contribution_cooldown_value
			is_required = yes

			context_allows_contributions = {
				tpg_great_project_disaster_in_recovery_phase_trigger = yes
			}

			contributor_is_valid = {
				tgp_natural_disaster_is_valid_contributor_trigger = yes
			}

			cost = { 
				gold = {
					value = 0
					if = {
						limit = { has_treasury = no }
						add = natural_disaster_contributions_cost_value
						add = natural_disaster_contributions_cost_base_discount
						# Innovation-based cost discounts
						if = {
							limit = { culture = { has_innovation = innovation_bannus } }
							multiply = {
								add = 0.95
								desc = great_project_contribution_cost_innovation_bannus
							}
						}
						if = {
							limit = { culture = { has_innovation = innovation_elephantry } }
							multiply = {
								add = 0.9
								desc = great_project_contribution_cost_innovation_elephantry
							}
						}
						if = {
							limit = { culture = { has_innovation = innovation_development_02 } }
							multiply = {
								add = 0.85
								desc = great_project_contribution_cost_innovation_development_02
							}
						}
						if = {
							limit = { culture = { has_innovation = innovation_cranes } }
							multiply = 0.8
							desc = great_project_contribution_cost_innovation_cranes
						}
					}
				}
				treasury = {
					value = 0
					if = {
						limit = { has_treasury = yes }
						add = natural_disaster_contributions_cost_treasury_value
						add = natural_disaster_contributions_cost_base_discount
						# Innovation-based cost discounts
						if = {
							limit = { culture = { has_innovation = innovation_bannus } }
							multiply = {
								add = 0.95
								desc = great_project_contribution_cost_innovation_bannus
							}
						}
						if = {
							limit = { culture = { has_innovation = innovation_elephantry } }
							multiply = {
								add = 0.9
								desc = great_project_contribution_cost_innovation_elephantry
							}
						}
						if = {
							limit = { culture = { has_innovation = innovation_development_02 } }
							multiply = {
								add = 0.85
								desc = great_project_contribution_cost_innovation_development_02
							}
						}
						if = {
							limit = { culture = { has_innovation = innovation_cranes } }
							multiply = 0.8
							desc = great_project_contribution_cost_innovation_cranes
						}
					}
				}
			}

			on_contribution_funded = {
				natural_disaster_great_project_save_scopes_effect = yes
				add_character_modifier = {
					modifier = tgp_natural_disaster_keeper_of_order
				}
				if = {
					limit = { culture = { has_innovation = innovation_city_planning } }
					if = {
						limit = { culture = { has_innovation = innovation_wierdijks } }
						custom_tooltip = great_project_contribution_cost_innovation_wierdijks
						add_character_modifier = {
							modifier = tgp_natural_disaster_cleanup_material_recovery
							years = 15
						}
					}
					else_if = {
						limit = { culture = { has_innovation = innovation_guilds } }
						custom_tooltip = great_project_contribution_cost_innovation_guilds
						add_character_modifier = {
							modifier = tgp_natural_disaster_cleanup_material_recovery
							years = 10
						}
					}
					else = {
						custom_tooltip = great_project_contribution_cost_innovation_city_planning
						add_character_modifier = {
							modifier = tgp_natural_disaster_cleanup_material_recovery
							years = 5
						}
					}
				}
				great_project_notify_contribution = yes
				great_project_contribution_catalyst_effect = yes
			}

			on_complete = {
				natural_disaster_great_project_save_scopes_effect = yes

				send_interface_toast = {
					type = event_toast_effect_good
					title = great_project_contribution_msg_t
					left_icon = root
					right_icon = scope:great_project.great_project_location.duchy

					if = {
						limit = { is_alive = yes }
						natural_disaster_great_project_mandatory_investment_reward_effect = yes
					}
				}
			}

			ai_will_do = {
				add = -50
				if = { # nobody better than me to deal with this
					limit = { this = top_liege }
					add = 100
				}
				add = {
					value = 0.25
					multiply = ai_honor
				}
				add = {
					value = -0.5
					multiply = ai_greed
				}
				add = {
					value = 0.5
					multiply = ai_rationality
				}
				add = {
					value = 0.5
					multiply = ai_energy
				}
				add = {
					value = 0.25
					multiply = ai_boldness
				}
				add = {
					value = 0.25
					multiply = ai_zeal
				}
				add = {
					value = -0.5
					multiply = ai_vengefulness
				}
				add = {
					value = 0.25
					multiply = ai_compassion
				}
				add = {
					value = 0.25
					multiply = ai_sociability
				}
				if = {
					limit = {
						is_at_war = yes
					}
					multiply = 0
				}
			}

			ai_check_interval_by_tier = {							
				barony = 0
				county = 6
				duchy = 2
				kingdom = 1
				empire = 1
				hegemony = 1
			}
		}
		reconstruction = {
			contributor_cooldown = natural_disaster_individual_contribution_cooldown_value
			is_required = yes

			context_allows_contributions = {
				tpg_great_project_disaster_in_recovery_phase_trigger = yes
			}

			contributor_is_valid = {
				tgp_natural_disaster_is_valid_contributor_trigger = yes
				tgp_natural_disaster_councillor_available_to_manage_trigger = yes
			}

			cost = {
				gold = {
					value = 0
					if = {
						limit = { has_treasury = no }
						add = natural_disaster_contributions_cost_value
						add = natural_disaster_contributions_cost_base_discount
						multiply = {
							value = 1
							add = {
								add = 0.02
								multiply = natural_disaster_realm_counties_total_development_contributions_cost_factor
							}
							desc = great_project_contribution_total_development_factor
						}
						multiply = { # +/- 10% per steward's Stewardship skill difference from medium_skill_rating
							value = 1
							add = {
								add = medium_skill_rating
								subtract = {
									value = 0
									if = {
										limit = { exists = cp:minister_works }
										add = cp:minister_works.stewardship
									}
									else_if = {
										limit = { exists = cp:councillor_steward }
										add = cp:councillor_steward.stewardship
									}
								}
								multiply = 0.1
							}
							min = 0.5
							max = 2
							desc = natural_disaster_realm_counties_steward_stewardship_skill_cost_factor
						}
						# Innovation-based cost discounts
						if = {
							limit = { culture = { has_innovation = innovation_development_01 } }
							multiply = {
								add = 0.9
								desc = great_project_contribution_cost_innovation_development_01
							}
						}
						if = {
							limit = { culture = { has_innovation = innovation_currency_02 } }
							multiply = {
								add = 0.85
								desc = great_project_contribution_cost_innovation_currency_02
							}
						}
						if = {
							limit = { culture = { has_innovation = innovation_currency_03 } }
							multiply = {
								add = 0.8
								desc = great_project_contribution_cost_innovation_currency_03
							}
						}
						if = {
							limit = { culture = { has_innovation = fp3_innovation_mural_sextant } }
							multiply = {
								add = 0.75
								desc = great_project_contribution_cost_innovation_fp3_innovation_mural_sextant
							}
						}
					}
				}
				treasury = {
					value = 0
					if = {
						limit = { has_treasury = yes }
						add = natural_disaster_contributions_cost_treasury_value
						add = natural_disaster_contributions_cost_base_discount
						multiply = {
							value = 1
							add = {
								add = 0.02
								multiply = natural_disaster_realm_counties_total_development_contributions_cost_factor
							}
							desc = great_project_contribution_total_development_factor
						}
						multiply = { # +/- 10% per steward's Stewardship skill difference from medium_skill_rating
							value = 1
							add = {
								add = medium_skill_rating
								subtract = {
									value = 0
									if = {
										limit = { exists = cp:minister_works }
										add = cp:minister_works.stewardship
									}
									else_if = {
										limit = { exists = cp:councillor_steward }
										add = cp:councillor_steward.stewardship
									}
								}
								multiply = 0.1
							}
							min = 0.5
							max = 2
							desc = natural_disaster_realm_counties_steward_stewardship_skill_cost_factor
						}
						# Innovation-based cost discounts
						if = {
							limit = { culture = { has_innovation = innovation_development_01 } }
							multiply = {
								add = 0.9
								desc = great_project_contribution_cost_innovation_development_01
							}
						}
						if = {
							limit = { culture = { has_innovation = innovation_currency_02 } }
							multiply = {
								add = 0.85
								desc = great_project_contribution_cost_innovation_currency_02
							}
						}
						if = {
							limit = { culture = { has_innovation = innovation_currency_03 } }
							multiply = {
								add = 0.8
								desc = great_project_contribution_cost_innovation_currency_03
							}
						}
						if = {
							limit = { culture = { has_innovation = fp3_innovation_mural_sextant } }
							multiply = {
								add = 0.75
								desc = great_project_contribution_cost_innovation_fp3_innovation_mural_sextant
							}
						}
					}
				}
			}

			on_contribution_funded = {
				natural_disaster_great_project_save_scopes_effect = yes
				natural_disaster_assign_councillor_to_manage_effect = { GREAT_PROJECT = scope:great_project }
				if = {
					limit = { exists = var:managing_councillor }
					var:managing_councillor ?= { # try to effectively cancel current task
						custom_tooltip = {
							text = councillor_assigned_to_manage_disaster
							start_default_task = yes
							finish_council_task = yes
						}
					}
				}
				else = {
					scope:councillor ?= {
						custom_tooltip = {
							text = councillor_assigned_to_manage_disaster
							start_default_task = yes
							finish_council_task = yes
						}
					}
				}
				# Economic activity duration by innovation
				if = {
					limit = { culture = { has_innovation = innovation_currency_04 } }
					custom_tooltip = great_project_contribution_cost_innovation_currency_04
					natural_disaster_all_counties_investment_modifier_effect = { 
						OPERATION = add
						MODIFIER = tgp_natural_disaster_reconstruction_economic_activity
						YEARS = 20
					}
				}
				else_if = {
					limit = { culture = { has_innovation = innovation_development_03 } }
					custom_tooltip = great_project_contribution_cost_innovation_development_03
					natural_disaster_all_counties_investment_modifier_effect = { 
						OPERATION = add
						MODIFIER = tgp_natural_disaster_reconstruction_economic_activity
						YEARS = 15
					}
				}
				else = {
					natural_disaster_all_counties_investment_modifier_effect = { 
						OPERATION = add
						MODIFIER = tgp_natural_disaster_reconstruction_economic_activity
						YEARS = 10
					}
				}
				great_project_notify_contribution = yes
				great_project_contribution_catalyst_effect = yes
			}

			on_complete = {
				natural_disaster_great_project_save_scopes_effect = yes
				send_interface_toast = {
					type = event_toast_effect_good
					title = great_project_contribution_msg_t
					left_icon = root
					right_icon = scope:great_project.great_project_location.duchy

					if = {
						limit = { is_alive = yes }
						natural_disaster_great_project_mandatory_investment_reward_effect = yes
					}
					natural_disaster_all_counties_investment_modifier_effect = { 
						OPERATION = add
						MODIFIER = tgp_natural_disaster_reconstruction_development_growth
						YEARS = 25
					}
				}
			}

			ai_will_do = {
				add = -50
				if = { # nobody better than me to deal with this
					limit = { this = top_liege }
					add = 100
				}
				add = {
					value = 0.25
					multiply = ai_honor
				}
				add = {
					value = -0.75
					multiply = ai_greed
				}
				add = {
					value = 0.25
					multiply = ai_rationality
				}
				add = {
					value = 0.5
					multiply = ai_energy
				}
				add = {
					value = 0.25
					multiply = ai_boldness
				}
				add = {
					value = 0.25
					multiply = ai_zeal
				}
				add = {
					value = -0.25
					multiply = ai_vengefulness
				}
				add = {
					value = 0.33
					multiply = ai_compassion
				}
				add = {
					value = 0.5
					multiply = ai_sociability
				}
				if = {
					limit = {
						is_at_war = yes
					}
					multiply = 0
				}
			}

			ai_check_interval_by_tier = {							
				barony = 0
				county = 6
				duchy = 2
				kingdom = 1
				empire = 1
				hegemony = 1
			}
		}
		resettlement = {
			contributor_cooldown = natural_disaster_individual_contribution_cooldown_value
			is_required = no

			context_allows_contributions = {
				tpg_great_project_disaster_in_recovery_phase_trigger = yes
			}

			contributor_is_valid = {
				tgp_natural_disaster_is_valid_contributor_trigger = yes
			}

			cost = {
				gold = {
					value = 0
					if = {
						limit = { has_treasury = no }
						add = natural_disaster_contributions_cost_value
						add = natural_disaster_contributions_cost_base_discount
						multiply = {
							value = 1
							add = {
								add = 0.03
								multiply = natural_disaster_realm_counties_total_development_contributions_cost_factor
							}
							desc = great_project_contribution_total_development_factor
						}
					}
				}
				treasury = {
					value = 0
					if = {
						limit = { has_treasury = yes }
						add = natural_disaster_contributions_cost_treasury_value
						add = natural_disaster_contributions_cost_base_discount
						multiply = {
							value = 1
							add = {
								add = 0.03
								multiply = natural_disaster_realm_counties_total_development_contributions_cost_factor
							}
							desc = great_project_contribution_total_development_factor
						}
					}
				}
			}

			on_contribution_funded = {
				natural_disaster_great_project_save_scopes_effect = yes
				# Domain burden (Muladi removes entirely; Court Officials shortens)
				if = {
					limit = { culture = { has_innovation = innovation_muladi } }
					# No domain burden for Muladi cultures
				}
				else_if = {
					limit = { culture = { has_innovation = innovation_court_officials } }
					add_character_modifier = {
						modifier = tgp_natural_disaster_resettlement_domain_burden
						years = 5
					}
				}
				else = {
					add_character_modifier = {
						modifier = tgp_natural_disaster_resettlement_domain_burden
						years = 10
					}
				}

				# Taxation loss duration (Bailiffs -10y, Seigneurialism -5y)
				if = {
					limit = { culture = { has_innovation = innovation_baliffs } }
					# Reduced by 10 years from 10: skip applying
				}
				else_if = {
					limit = { culture = { has_innovation = innovation_seigneurialism } }
					natural_disaster_all_counties_investment_modifier_effect = { 
						OPERATION = add
						MODIFIER = tgp_natural_disaster_resettlement_taxation_loss
						YEARS = 5
					}
				}
				else = {
					natural_disaster_all_counties_investment_modifier_effect = { 
						OPERATION = add
						MODIFIER = tgp_natural_disaster_resettlement_taxation_loss
						YEARS = 10
					}
				}

				# Levy growth duration (Muladi or Manorialism +10y)
				if = {
					limit = { OR = { culture = { has_innovation = innovation_muladi } culture = { has_innovation = innovation_manorialism } } }
					natural_disaster_all_counties_investment_modifier_effect = { 
						OPERATION = add
						MODIFIER = tgp_natural_disaster_resettlement_levy_growth
						YEARS = 35
					}
				}
				else = {
					natural_disaster_all_counties_investment_modifier_effect = { 
						OPERATION = add
						MODIFIER = tgp_natural_disaster_resettlement_levy_growth
						YEARS = 25
					}
				}
				great_project_notify_contribution = yes
				great_project_contribution_catalyst_effect = yes
			}

			on_complete = {
				natural_disaster_great_project_save_scopes_effect = yes

				send_interface_toast = {
					type = event_toast_effect_good
					title = great_project_contribution_msg_t
					left_icon = root
					right_icon = scope:great_project.great_project_location.duchy

					if = {
						limit = { is_alive = yes }
						natural_disaster_great_project_optional_investment_reward_effect = yes
						remove_character_modifier = tgp_natural_disaster_resettlement_domain_burden
					}
					# County resettlement buff duration (Muladi +10y, East Settling +10y, Rightful Ownership +5y)
					if = {
						limit = { culture = { has_innovation = innovation_muladi } }
						natural_disaster_all_counties_investment_modifier_effect = { 
							OPERATION = add
							MODIFIER = tgp_natural_disaster_resettlement_county_modifier
							YEARS = 20
						}
					}
					else_if = {
						limit = { culture = { has_innovation = innovation_east_settling } }
						natural_disaster_all_counties_investment_modifier_effect = { 
							OPERATION = add
							MODIFIER = tgp_natural_disaster_resettlement_county_modifier
							YEARS = 20
						}
					}
					else_if = {
						limit = { culture = { has_innovation = innovation_rightful_ownership } }
						natural_disaster_all_counties_investment_modifier_effect = { 
							OPERATION = add
							MODIFIER = tgp_natural_disaster_resettlement_county_modifier
							YEARS = 15
						}
					}
					else = {
						natural_disaster_all_counties_investment_modifier_effect = { 
							OPERATION = add
							MODIFIER = tgp_natural_disaster_resettlement_county_modifier
							YEARS = 10
						}
					}
				}
			}

			ai_will_do = {
				add = -75
				if = { # nobody better than me to deal with this
					limit = { this = top_liege }
					add = 100
				}
				add = {
					value = 0.75
					multiply = ai_honor
				}
				add = {
					value = -0.75
					multiply = ai_greed
				}
				add = {
					value = -0.25
					multiply = ai_rationality
				}
				add = {
					value = 0.25
					multiply = ai_energy
				}
				add = {
					value = 0.5
					multiply = ai_boldness
				}
				add = {
					value = -0.25
					multiply = ai_zeal
				}
				add = {
					value = -0.5
					multiply = ai_vengefulness
				}
				add = {
					value = 0.75
					multiply = ai_compassion
				}
				add = {
					value = 0.75
					multiply = ai_sociability
				}
				if = {
					limit = { domain_limit_available < 1 } # AI will never give up domain they don't have
					add = -1000 
				}
				if = {
					limit = {
						is_at_war = yes
					}
					multiply = 0
				}
			}

			ai_check_interval_by_tier = {							
				barony = 0
				county = 6
				duchy = 2
				kingdom = 1
				empire = 1
				hegemony = 1
			}
		}
		aid = {
			contributor_cooldown = natural_disaster_individual_contribution_cooldown_value
			is_required = no

			context_allows_contributions = {
				tpg_great_project_disaster_in_recovery_phase_trigger = yes
			}

			contributor_is_valid = {
				tgp_natural_disaster_is_valid_contributor_trigger = yes
			}

			cost = { 
				gold = {
					value = 0
					if = {
						limit = { has_treasury = no }
						add = natural_disaster_contributions_cost_value
						add = natural_disaster_contributions_cost_base_discount
						multiply = {
							add = 1
							multiply = scope:great_project.var:situation.var:severity
							desc = great_project_contribution_cost_situation_severity
						}
					}
				}
				treasury = {
					value = 0
					if = {
						limit = { has_treasury = yes }
						add = natural_disaster_contributions_cost_treasury_value
						add = natural_disaster_contributions_cost_base_discount
						multiply = {
							add = 1
							multiply = scope:great_project.var:situation.var:severity
							desc = great_project_contribution_cost_situation_severity
						}
					}
				}
			}
			
			on_contribution_funded = {
				natural_disaster_great_project_save_scopes_effect = yes
				add_character_modifier = {
					modifier = tgp_natural_disaster_relief_savior
				}
				# Innovation: Divine Right extends the piety/opinion window
				if = {
					limit = { culture = { has_innovation = innovation_divine_right } }
					custom_tooltip = great_project_contribution_cost_innovation_divine_right
					add_character_modifier = {
						modifier = tgp_natural_disaster_relief_savior
						years = 5
					}
				}
				great_project_notify_contribution = yes
				great_project_contribution_catalyst_effect = yes
			}

			on_complete = {
				natural_disaster_great_project_save_scopes_effect = yes
				
				send_interface_toast = {
					type = event_toast_effect_good
					title = great_project_contribution_msg_t
					left_icon = root
					right_icon = scope:great_project.great_project_location.duchy

					if = {
						limit = { is_alive = yes }
						natural_disaster_great_project_optional_investment_reward_effect = yes
						# Big opinion boost with Head of Faith for humanitarian aid
						if = {
							limit = { 
								faith.religious_head ?= { is_alive = yes }
								NOT = { faith.religious_head = root }
							}
							faith.religious_head = {
								add_opinion = {
									opinion = 30
									modifier = disaster_relief_charitable_aid_opinion
									target = root
								}
							}
						}
					}
					# Innovation gating: Sanitation (35y), Pharmacopoeia (30y), else 25y
					if = {
						limit = { culture = { has_innovation = innovation_sanitation } }
						custom_tooltip = great_project_contribution_cost_innovation_sanitation
						natural_disaster_all_counties_investment_modifier_effect = { 
							OPERATION = add
							MODIFIER = tgp_natural_disaster_aid_county_modifier
							YEARS = 35
						}
					}
					else_if = {
						limit = { culture = { has_innovation = innovation_pharmacopoeia } }
						custom_tooltip = great_project_contribution_cost_innovation_pharmacopoeia
						natural_disaster_all_counties_investment_modifier_effect = { 
							OPERATION = add
							MODIFIER = tgp_natural_disaster_aid_county_modifier
							YEARS = 30
						}
					}
					else = {
						natural_disaster_all_counties_investment_modifier_effect = { 
							OPERATION = add
							MODIFIER = tgp_natural_disaster_aid_county_modifier
							YEARS = 25
						}
					}
				}
			}

			ai_will_do = {
				add = -75
				if = { # nobody better than me to deal with this
					limit = { this = top_liege }
					add = 100
				}
				add = {
					value = 0.75
					multiply = ai_honor
				}
				add = {
					value = -0.75
					multiply = ai_greed
				}
				add = {
					value = -0.25
					multiply = ai_rationality
				}
				add = {
					value = 0.25
					multiply = ai_energy
				}
				add = {
					value = 0.25
					multiply = ai_boldness
				}
				add = {
					value = 0.75
					multiply = ai_zeal
				}
				add = {
					value = -0.75
					multiply = ai_vengefulness
				}
				add = {
					value = 0.75
					multiply = ai_compassion
				}
				add = {
					value = 0.5
					multiply = ai_sociability
				}
				if = {
					limit = {
						is_at_war = yes
					}
					multiply = 0
				}
			}

			ai_check_interval_by_tier = {							
				barony = 0
				county = 6
				duchy = 2
				kingdom = 1
				empire = 1
				hegemony = 1
			}
		}
		memorial = {
			contributor_cooldown = natural_disaster_individual_contribution_cooldown_value
			is_required = no

			context_allows_contributions = {
				tpg_great_project_disaster_in_recovery_phase_trigger = yes
			}

			contributor_is_valid = {
				tgp_natural_disaster_is_valid_contributor_trigger = yes
			}

			cost = { 
				gold = {
					value = 0
					if = {
						limit = { has_treasury = no }
						add = {
							add = natural_disaster_contributions_cost_value
							multiply = 2
							desc = great_project_contribution_cost_num_affected_realm_counties
						}
						add = natural_disaster_contributions_cost_base_discount
						# Innovation-based cost discounts
						if = { 
							limit = { culture = { has_innovation = innovation_currency_03 } }
							multiply = {
								add = 0.9 
								desc = great_project_contribution_cost_innovation_currency_03
							}
						}
						if = { 
							limit = { culture = { has_innovation = innovation_cranes } } 
							multiply = {
								add = 0.85
								desc = great_project_contribution_cost_innovation_cranes
							}
						}
						if = { 
							limit = { culture = { has_innovation = fp3_innovation_mural_sextant } } 
							multiply = {
								add = 0.8
								desc = great_project_contribution_cost_innovation_fp3_innovation_mural_sextant
							}
						}
					}
				}
				treasury = {
					value = 0
					if = {
						limit = { has_treasury = yes }
						add = {
							add = natural_disaster_contributions_cost_treasury_value
							multiply = 2
							desc = great_project_contribution_cost_num_affected_realm_counties
						}
						add = natural_disaster_contributions_cost_base_discount
						# Innovation-based cost discounts
						if = { 
							limit = { culture = { has_innovation = innovation_currency_03 } }
							multiply = {
								add = 0.9 
								desc = great_project_contribution_cost_innovation_currency_03
							}
						}
						if = { 
							limit = { culture = { has_innovation = innovation_cranes } } 
							multiply = {
								add = 0.85
								desc = great_project_contribution_cost_innovation_cranes
							}
						}
						if = { 
							limit = { culture = { has_innovation = fp3_innovation_mural_sextant } } 
							multiply = {
								add = 0.8
								desc = great_project_contribution_cost_innovation_fp3_innovation_mural_sextant
							}
						}
					}
				}
			}
			
			on_contribution_funded = {
				great_project_notify_contribution = yes
				great_project_contribution_catalyst_effect = yes
			}

			on_complete = {
				natural_disaster_great_project_save_scopes_effect = yes
				
				send_interface_toast = {
					type = event_toast_effect_good
					title = great_project_contribution_msg_t
					left_icon = root
					right_icon = scope:great_project.great_project_location.duchy

					if = {
						limit = { is_alive = yes }
						natural_disaster_great_project_optional_investment_reward_effect = yes
						add_character_modifier = tgp_natural_disaster_built_memorial_fortifications
					}
					# Innovation: Wierdijks adds +1 fort level permanently
					if = {
						limit = { culture = { has_innovation = innovation_wierdijks } }
						custom_tooltip = great_project_contribution_cost_innovation_wierdijks
						natural_disaster_all_counties_investment_modifier_effect = { 
							OPERATION = add
							MODIFIER = tgp_natural_disaster_memorial_fortifications_wierdijks
							YEARS = -1
						}
					}
					else = {
						natural_disaster_all_counties_investment_modifier_effect = { 
							OPERATION = add
							MODIFIER = tgp_natural_disaster_memorial_fortifications
							YEARS = -1
						}
					}
				}
			}

			ai_will_do = {
				add = -75
				if = { # nobody better than me to deal with this
					limit = { this = top_liege }
					add = 100
				}
				add = {
					value = 0.5
					multiply = ai_honor
				}
				add = {
					value = -0.75
					multiply = ai_greed
				}
				add = {
					value = 0.5
					multiply = ai_rationality
				}
				add = {
					value = 0.25
					multiply = ai_energy
				}
				add = {
					value = 0.75
					multiply = ai_boldness
				}
				add = {
					value = 0.25
					multiply = ai_zeal
				}
				add = {
					value = 0.25
					multiply = ai_vengefulness
				}
				add = {
					value = -0.25
					multiply = ai_compassion
				}
				add = {
					value = -0.25
					multiply = ai_sociability
				}
				if = {
					limit = {
						is_at_war = yes
					}
					multiply = 0
				}
			}

			ai_check_interval_by_tier = {							
				barony = 0
				county = 6
				duchy = 2
				kingdom = 1
				empire = 1
				hegemony = 1
			}
		}
	}
}

great_project_flood = {
	icon = {
		trigger = {
			scope:province ?= {
				geographical_region = world_asia
			}
		}
		reference = @icon_asian_great_project
	}
	icon = {
		reference = @icon_generic_great_project
	}

	illustration = {
		trigger = {
			scope:province ?= {
				geographical_region = world_asia
			}
		}
		reference = @disaster_relief_asian_illustration
	}
	illustration = {
		reference = @disaster_relief_generic
	}

	is_shown = {
		tgp_natural_disaster_great_project_trigger = { TYPE = flood }
	}

	can_start_planning = {
		always = no
	}

	can_cancel = {
		always = no
	}

	is_valid = {
		exists = var:situation
	}

	construction_time = 60
	contributor_cooldown = standard_contributor_cooldown_value

	on_complete = {
		natural_disaster_great_project_save_scopes_effect = yes
		scope:owner = {
			trigger_event = natural_disaster.4001
		}
		scope:situation = {							
			situation_participant_group:affected_vassal = {
				every_situation_group_participant = {
					limit = { 
						is_ai = no
						is_vassal_or_below_of = scope:owner
					}
					trigger_event = natural_disaster.4002
				}
			}
		}
		show_as_tooltip = {
			natural_disaster_all_counties_investment_modifier_effect = { 
				OPERATION = add
				MODIFIER = tgp_natural_disaster_flood_fertility_county_modifier
				YEARS = 10
			}
		}
	}

	on_start_build = { 
		scope:owner = {
			add_prestige = minor_prestige_value 
		}
	}

	allowed_contributor_filter = {
		vassals = yes
	}

	is_important = yes
	show_in_list = no
	group = environmental_project
	completion_sound_effect = @msg_completion_effect_natural_disaster

	project_contributions = {
		recovery = {
			contributor_cooldown = natural_disaster_individual_contribution_cooldown_value
			is_required = yes
			
			context_allows_contributions = {
				tpg_great_project_disaster_in_recovery_phase_trigger = yes
			}

			contributor_is_valid = {
				tgp_natural_disaster_is_valid_contributor_trigger = yes
			}

			cost = { 
				gold = {
					value = 0
					if = {
						limit = { has_treasury = no }
						add = natural_disaster_contributions_cost_value
						add = natural_disaster_contributions_cost_base_discount
						multiply = {
							add = 0.5
							multiply = scope:great_project.var:situation.var:severity
							desc = great_project_contribution_cost_situation_severity
						}
						# Innovation-based cost discounts
						if = {
							limit = { culture = { has_innovation = innovation_ledger } }
							multiply = {
								add = 0.9
								desc = great_project_contribution_cost_innovation_ledger
							}
						}
						if = {
							limit = { culture = { has_innovation = innovation_seigneurialism } }
							multiply = {
								add = 0.85
								desc = great_project_contribution_cost_innovation_seigneurialism
							}
						}
					}
				}
				treasury = {
					value = 0
					if = {
						limit = { has_treasury = yes }
						add = natural_disaster_contributions_cost_treasury_value
						add = natural_disaster_contributions_cost_base_discount
						multiply = {
							add = 0.5
							multiply = scope:great_project.var:situation.var:severity
							desc = great_project_contribution_cost_situation_severity
						}
						# Innovation-based cost discounts
						if = {
							limit = { culture = { has_innovation = innovation_ledger } }
							multiply = {
								add = 0.9
								desc = great_project_contribution_cost_innovation_ledger
							}
						}
						if = {
							limit = { culture = { has_innovation = innovation_seigneurialism } }
							multiply = {
								add = 0.85
								desc = great_project_contribution_cost_innovation_seigneurialism
							}
						}
					}
				}
			}

			on_contribution_funded = {
				natural_disaster_great_project_save_scopes_effect = yes
				if = {
					limit = { culture = { has_innovation = innovation_court_officials } }
					custom_tooltip = great_project_contribution_cost_innovation_court_officials
				}
				else_if = {
					limit = { culture = { has_innovation = innovation_baliffs } }
					custom_tooltip = great_project_contribution_cost_innovation_baliffs
					add_character_modifier = {
						modifier = tgp_natural_disaster_recovery_tax_burden_reduced
					}
				}
				else = {
					add_character_modifier = {
						modifier = tgp_natural_disaster_recovery_tax_burden
					}
				}
				if = {
					limit = { culture = { has_innovation = innovation_double_entry_bookkeeping } }
					custom_tooltip = great_project_contribution_cost_innovation_double_entry_bookkeeping
					add_character_modifier = {
						modifier = tgp_natural_disaster_recovery_popular_hero
						years = 20
					}
				}
				else = {
					add_character_modifier = {
						modifier = tgp_natural_disaster_recovery_popular_hero
						years = 10
					}
				}
				great_project_notify_contribution = yes
				great_project_contribution_catalyst_effect = yes
			}

			on_complete = {
				natural_disaster_great_project_save_scopes_effect = yes
				
				send_interface_toast = {
					type = event_toast_effect_good
					title = great_project_contribution_msg_t
					left_icon = root
					right_icon = scope:great_project.great_project_location.duchy

					if = {
						limit = { is_alive = yes }
						natural_disaster_great_project_mandatory_investment_reward_effect = yes
						if = {
							limit = { 
								culture = { 
									has_innovation = innovation_baliffs
									NOT = { has_innovation = innovation_court_officials } 
								}
							}
							remove_character_modifier = tgp_natural_disaster_recovery_tax_burden_reduced
						}
						else_if = {
							limit = { culture = { NOT = { has_innovation = innovation_court_officials } } }
							remove_character_modifier = tgp_natural_disaster_recovery_tax_burden
						}
					}
				}
			}

			ai_will_do = {
				add = -50
				if = { # nobody better than me to deal with this
					limit = { this = top_liege }
					add = 100
				}
				add = {
					value = 0.5
					multiply = ai_honor
				}
				add = {
					value = -0.5
					multiply = ai_greed
				}
				add = {
					value = 0.25
					multiply = ai_rationality
				}
				add = {
					value = 0.25
					multiply = ai_energy
				}
				add = {
					value = 0.5
					multiply = ai_boldness
				}
				add = {
					value = 0.25
					multiply = ai_zeal
				}
				add = {
					value = -0.25
					multiply = ai_vengefulness
				}
				add = {
					value = 0.75
					multiply = ai_compassion
				}
				add = {
					value = 0.25
					multiply = ai_sociability
				}
				if = {
					limit = {
						is_at_war = yes
					}
					multiply = 0
				}
			}

			ai_check_interval_by_tier = {							
				barony = 0
				county = 6
				duchy = 2
				kingdom = 1
				empire = 1
				hegemony = 1
			}
		}
		drainage = {
			contributor_cooldown = natural_disaster_individual_contribution_cooldown_value
			is_required = yes

			context_allows_contributions = {
				tpg_great_project_disaster_in_recovery_phase_trigger = yes
			}

			contributor_is_valid = {
				tgp_natural_disaster_is_valid_contributor_trigger = yes
				custom_tooltip = {
					text = laamp_base_contract_schemes.1301.d.tt.not_enough_troops # TODO TIT-66592 replace with string with accurate value
					current_military_strength >= 100
				}
			}

			cost = { 
				gold = {
					value = 0
					if = {
						limit = { has_treasury = no }
						add = natural_disaster_contributions_cost_value
						add = natural_disaster_contributions_cost_base_discount
						# Innovation-based cost discounts
						if = {
							limit = { culture = { has_innovation = innovation_manorialism } }
							multiply = {
								add = 0.9
								desc = great_project_contribution_cost_innovation_manorialism
							}
						}
						if = {
							limit = { culture = { has_innovation = innovation_wierdijks } }
							multiply = {
								add = 0.85
								desc = great_project_contribution_cost_innovation_wierdijks
							}
						}
					}
				}
				treasury = {
					value = 0
					if = {
						limit = { has_treasury = yes }
						add = natural_disaster_contributions_cost_treasury_value
						add = natural_disaster_contributions_cost_base_discount
						# Innovation-based cost discounts
						if = {
							limit = { culture = { has_innovation = innovation_manorialism } }
							multiply = {
								add = 0.9
								desc = great_project_contribution_cost_innovation_manorialism
							}
						}
						if = {
							limit = { culture = { has_innovation = innovation_wierdijks } }
							multiply = {
								add = 0.85
								desc = great_project_contribution_cost_innovation_wierdijks
							}
						}
					}
				}
			}

			on_contribution_funded = {
				natural_disaster_great_project_save_scopes_effect = yes
				hidden_effect = {
					every_realm_county = {
						add_county_modifier = {
							modifier = tgp_natural_disaster_drainage_reduce_levies
							years = 1
						}
					}
				}
				add_character_modifier = {
					modifier = tgp_natural_disaster_drainage_work_levy_shortage
					years = 10
				}
				add_character_modifier = {
					modifier = tgp_natural_disaster_keeper_of_order
				}
				# Material recovery-like salvage during drainage, duration by innovation
				if = {
					limit = { culture = { has_innovation = innovation_windmills } }
					if = {
						limit = { culture = { has_innovation = innovation_crop_rotation } }
						custom_tooltip = great_project_contribution_cost_innovation_crop_rotation
						add_character_modifier = {
							modifier = tgp_natural_disaster_cleanup_material_recovery
							years = 10
						}
					}
					else = {
						custom_tooltip = great_project_contribution_cost_innovation_windmills
						add_character_modifier = {
							modifier = tgp_natural_disaster_cleanup_material_recovery
							years = 5
						}
					}
				}
				great_project_notify_contribution = yes
				great_project_contribution_catalyst_effect = yes
			}

			on_complete = {
				natural_disaster_great_project_save_scopes_effect = yes
				send_interface_toast = {
					type = event_toast_effect_good
					title = great_project_contribution_msg_t
					left_icon = root
					right_icon = scope:great_project.great_project_location.duchy

					if = {
						limit = { is_alive = yes }
						natural_disaster_great_project_mandatory_investment_reward_effect = yes
						add_learning_lifestyle_xp = major_lifestyle_experience
					}
				}
			}

			ai_will_do = {
				add = -50
				if = { # nobody better than me to deal with this
					limit = { this = top_liege }
					add = 100
				}
				add = {
					value = 0.25
					multiply = ai_honor
				}
				add = {
					value = -0.5
					multiply = ai_greed
				}
				add = {
					value = 0.5
					multiply = ai_rationality
				}
				add = {
					value = 0.5
					multiply = ai_energy
				}
				add = {
					value = 0.25
					multiply = ai_boldness
				}
				add = {
					value = 0.25
					multiply = ai_zeal
				}
				add = {
					value = -0.5
					multiply = ai_vengefulness
				}
				add = {
					value = 0.25
					multiply = ai_compassion
				}
				add = {
					value = 0.25
					multiply = ai_sociability
				}
				if = {
					limit = {
						is_at_war = yes
					}
					multiply = 0
				}
			}

			ai_check_interval_by_tier = {							
				barony = 0
				county = 6
				duchy = 2
				kingdom = 1
				empire = 1
				hegemony = 1
			}
		}
		reconstruction = {
			contributor_cooldown = natural_disaster_individual_contribution_cooldown_value
			is_required = yes

			context_allows_contributions = {
				tpg_great_project_disaster_in_recovery_phase_trigger = yes
			}

			contributor_is_valid = {
				tgp_natural_disaster_is_valid_contributor_trigger = yes
				tgp_natural_disaster_councillor_available_to_manage_trigger = yes
			}

			cost = {
				gold = {
					value = 0
					if = {
						limit = { has_treasury = no }
						add = natural_disaster_contributions_cost_value
						add = natural_disaster_contributions_cost_base_discount
						multiply = {
							value = 1
							add = {
								add = 0.02
								multiply = natural_disaster_realm_counties_total_development_contributions_cost_factor
							}
							desc = great_project_contribution_total_development_factor
						}
						multiply = { # +/- 10% per steward's Stewardship skill difference from medium_skill_rating
							value = 1
							add = {
								add = medium_skill_rating
								subtract = {
									value = 0
									if = {
										limit = { exists = cp:minister_works }
										add = cp:minister_works.stewardship
									}
									else_if = {
										limit = { exists = cp:councillor_steward }
										add = cp:councillor_steward.stewardship
									}
								}
								multiply = 0.1
							}
							min = 0.5
							max = 2
							desc = natural_disaster_realm_counties_steward_stewardship_skill_cost_factor
						}
						# Innovation-based cost discounts
						if = {
							limit = { culture = { has_innovation = innovation_development_01 } }
							multiply = {
								add = 0.9
								desc = great_project_contribution_cost_innovation_development_01
							}
						}
						if = {
							limit = { culture = { has_innovation = innovation_currency_02 } }
							multiply = {
								add = 0.85
								desc = great_project_contribution_cost_innovation_currency_02
							}
						}
						if = {
							limit = { culture = { has_innovation = innovation_currency_03 } }
							multiply = {
								add = 0.8
								desc = great_project_contribution_cost_innovation_currency_03
							}
						}
						if = {
							limit = { culture = { has_innovation = fp3_innovation_mural_sextant } }
							multiply = {
								add = 0.75
								desc = great_project_contribution_cost_innovation_fp3_innovation_mural_sextant
							}
						}
					}
				}
				treasury = {
					value = 0
					if = {
						limit = { has_treasury = yes }
						add = natural_disaster_contributions_cost_treasury_value
						add = natural_disaster_contributions_cost_base_discount
						multiply = {
							value = 1
							add = {
								add = 0.02
								multiply = natural_disaster_realm_counties_total_development_contributions_cost_factor
							}
							desc = great_project_contribution_total_development_factor
						}
						multiply = { # +/- 10% per steward's Stewardship skill difference from medium_skill_rating
							value = 1
							add = {
								add = medium_skill_rating
								subtract = {
									value = 0
									if = {
										limit = { exists = cp:minister_works }
										add = cp:minister_works.stewardship
									}
									else_if = {
										limit = { exists = cp:councillor_steward }
										add = cp:councillor_steward.stewardship
									}
								}
								multiply = 0.1
							}
							min = 0.5
							max = 2
							desc = natural_disaster_realm_counties_steward_stewardship_skill_cost_factor
						}
						# Innovation-based cost discounts
						if = {
							limit = { culture = { has_innovation = innovation_development_01 } }
							multiply = {
								add = 0.9
								desc = great_project_contribution_cost_innovation_development_01
							}
						}
						if = {
							limit = { culture = { has_innovation = innovation_currency_02 } }
							multiply = {
								add = 0.85
								desc = great_project_contribution_cost_innovation_currency_02
							}
						}
						if = {
							limit = { culture = { has_innovation = innovation_currency_03 } }
							multiply = {
								add = 0.8
								desc = great_project_contribution_cost_innovation_currency_03
							}
						}
						if = {
							limit = { culture = { has_innovation = fp3_innovation_mural_sextant } }
							multiply = {
								add = 0.75
								desc = great_project_contribution_cost_innovation_fp3_innovation_mural_sextant
							}
						}
					}
				}
			}

			on_contribution_funded = {
				natural_disaster_great_project_save_scopes_effect = yes
				natural_disaster_assign_councillor_to_manage_effect = { GREAT_PROJECT = scope:great_project }
				if = {
					limit = { exists = var:managing_councillor }
					var:managing_councillor ?= { # try to effectively cancel current task
						custom_tooltip = {
							text = councillor_assigned_to_manage_disaster
							start_default_task = yes
							finish_council_task = yes
						}
					}
				}
				else = {
					scope:councillor ?= {
						custom_tooltip = {
							text = councillor_assigned_to_manage_disaster
							start_default_task = yes
							finish_council_task = yes
						}
					}
				}
				# Economic activity duration by innovation
				if = {
					limit = { culture = { has_innovation = innovation_currency_04 } }
					custom_tooltip = great_project_contribution_cost_innovation_currency_04
					natural_disaster_all_counties_investment_modifier_effect = { 
						OPERATION = add
						MODIFIER = tgp_natural_disaster_reconstruction_economic_activity
						YEARS = 20
					}
				}
				else_if = {
					limit = { culture = { has_innovation = innovation_development_03 } }
					custom_tooltip = great_project_contribution_cost_innovation_development_03
					natural_disaster_all_counties_investment_modifier_effect = { 
						OPERATION = add
						MODIFIER = tgp_natural_disaster_reconstruction_economic_activity
						YEARS = 15
					}
				}
				else = {
					natural_disaster_all_counties_investment_modifier_effect = { 
						OPERATION = add
						MODIFIER = tgp_natural_disaster_reconstruction_economic_activity
						YEARS = 10
					}
				}
				great_project_notify_contribution = yes
				great_project_contribution_catalyst_effect = yes
			}

			on_complete = {
				natural_disaster_great_project_save_scopes_effect = yes
				send_interface_toast = {
					type = event_toast_effect_good
					title = great_project_contribution_msg_t
					left_icon = root
					right_icon = scope:great_project.great_project_location.duchy

					if = {
						limit = { is_alive = yes }
						natural_disaster_great_project_mandatory_investment_reward_effect = yes
					}
					natural_disaster_all_counties_investment_modifier_effect = { 
						OPERATION = add
						MODIFIER = tgp_natural_disaster_reconstruction_development_growth
						YEARS = 25
					}
				}
			}

			ai_will_do = {
				add = -50
				if = { # nobody better than me to deal with this
					limit = { this = top_liege }
					add = 100
				}
				add = {
					value = 0.25
					multiply = ai_honor
				}
				add = {
					value = -0.75
					multiply = ai_greed
				}
				add = {
					value = 0.25
					multiply = ai_rationality
				}
				add = {
					value = 0.5
					multiply = ai_energy
				}
				add = {
					value = 0.25
					multiply = ai_boldness
				}
				add = {
					value = 0.25
					multiply = ai_zeal
				}
				add = {
					value = -0.25
					multiply = ai_vengefulness
				}
				add = {
					value = 0.33
					multiply = ai_compassion
				}
				add = {
					value = 0.5
					multiply = ai_sociability
				}
				if = {
					limit = {
						is_at_war = yes
					}
					multiply = 0
				}
			}

			ai_check_interval_by_tier = {							
				barony = 0
				county = 6
				duchy = 2
				kingdom = 1
				empire = 1
				hegemony = 1
			}
		}
		resettlement = {
			contributor_cooldown = natural_disaster_individual_contribution_cooldown_value
			is_required = no

			context_allows_contributions = {
				tpg_great_project_disaster_in_recovery_phase_trigger = yes
			}

			contributor_is_valid = {
				tgp_natural_disaster_is_valid_contributor_trigger = yes
			}

			cost = {
				gold = {
					value = 0
					if = {
						limit = { has_treasury = no }
						add = natural_disaster_contributions_cost_value
						add = natural_disaster_contributions_cost_base_discount
						multiply = {
							value = 1
							add = {
								add = 0.03
								multiply = natural_disaster_realm_counties_total_development_contributions_cost_factor
							}
							desc = great_project_contribution_total_development_factor
						}
					}
				}
				treasury = {
					value = 0
					if = {
						limit = { has_treasury = yes }
						add = natural_disaster_contributions_cost_treasury_value
						add = natural_disaster_contributions_cost_base_discount
						multiply = {
							value = 1
							add = {
								add = 0.03
								multiply = natural_disaster_realm_counties_total_development_contributions_cost_factor
							}
							desc = great_project_contribution_total_development_factor
						}
					}
				}
			}


			on_contribution_funded = {
				natural_disaster_great_project_save_scopes_effect = yes
				# Domain burden (Muladi removes entirely; Court Officials shortens)
				if = {
					limit = { culture = { has_innovation = innovation_muladi } }
					# No domain burden for Muladi cultures
				}
				else_if = {
					limit = { culture = { has_innovation = innovation_court_officials } }
					add_character_modifier = {
						modifier = tgp_natural_disaster_resettlement_domain_burden
						years = 5
					}
				}
				else = {
					add_character_modifier = {
						modifier = tgp_natural_disaster_resettlement_domain_burden
						years = 10
					}
				}

				# Taxation loss duration (Bailiffs -10y, Seigneurialism -5y)
				if = {
					limit = { culture = { has_innovation = innovation_baliffs } }
					# Reduced by 10 years from 10: skip applying
				}
				else_if = {
					limit = { culture = { has_innovation = innovation_seigneurialism } }
					natural_disaster_all_counties_investment_modifier_effect = { 
						OPERATION = add
						MODIFIER = tgp_natural_disaster_resettlement_taxation_loss
						YEARS = 5
					}
				}
				else = {
					natural_disaster_all_counties_investment_modifier_effect = { 
						OPERATION = add
						MODIFIER = tgp_natural_disaster_resettlement_taxation_loss
						YEARS = 10
					}
				}

				# Levy growth duration (Muladi or Manorialism +10y)
				if = {
					limit = { OR = { culture = { has_innovation = innovation_muladi } culture = { has_innovation = innovation_manorialism } } }
					natural_disaster_all_counties_investment_modifier_effect = { 
						OPERATION = add
						MODIFIER = tgp_natural_disaster_resettlement_levy_growth
						YEARS = 35
					}
				}
				else = {
					natural_disaster_all_counties_investment_modifier_effect = { 
						OPERATION = add
						MODIFIER = tgp_natural_disaster_resettlement_levy_growth
						YEARS = 25
					}
				}
				great_project_notify_contribution = yes
				great_project_contribution_catalyst_effect = yes
			}

			on_complete = {
				natural_disaster_great_project_save_scopes_effect = yes

				send_interface_toast = {
					type = event_toast_effect_good
					title = great_project_contribution_msg_t
					left_icon = root
					right_icon = scope:great_project.great_project_location.duchy

					if = {
						limit = { is_alive = yes }
						natural_disaster_great_project_optional_investment_reward_effect = yes
						remove_character_modifier = tgp_natural_disaster_resettlement_domain_burden
					}
					# County resettlement buff duration (Muladi +10y, East Settling +10y, Rightful Ownership +5y)
					if = {
						limit = { culture = { has_innovation = innovation_muladi } }
						natural_disaster_all_counties_investment_modifier_effect = { 
							OPERATION = add
							MODIFIER = tgp_natural_disaster_resettlement_county_modifier
							YEARS = 20
						}
					}
					else_if = {
						limit = { culture = { has_innovation = innovation_east_settling } }
						natural_disaster_all_counties_investment_modifier_effect = { 
							OPERATION = add
							MODIFIER = tgp_natural_disaster_resettlement_county_modifier
							YEARS = 20
						}
					}
					else_if = {
						limit = { culture = { has_innovation = innovation_rightful_ownership } }
						natural_disaster_all_counties_investment_modifier_effect = { 
							OPERATION = add
							MODIFIER = tgp_natural_disaster_resettlement_county_modifier
							YEARS = 15
						}
					}
					else = {
						natural_disaster_all_counties_investment_modifier_effect = { 
							OPERATION = add
							MODIFIER = tgp_natural_disaster_resettlement_county_modifier
							YEARS = 10
						}
					}
				}
			}

			ai_will_do = {
				add = -75
				if = { # nobody better than me to deal with this
					limit = { this = top_liege }
					add = 100
				}
				add = {
					value = 0.75
					multiply = ai_honor
				}
				add = {
					value = -0.75
					multiply = ai_greed
				}
				add = {
					value = -0.25
					multiply = ai_rationality
				}
				add = {
					value = 0.25
					multiply = ai_energy
				}
				add = {
					value = 0.5
					multiply = ai_boldness
				}
				add = {
					value = -0.25
					multiply = ai_zeal
				}
				add = {
					value = -0.5
					multiply = ai_vengefulness
				}
				add = {
					value = 0.75
					multiply = ai_compassion
				}
				add = {
					value = 0.75
					multiply = ai_sociability
				}
				if = {
					limit = { domain_limit_available < 1 } # AI will never give up domain they don't have
					add = -1000 
				}
				if = {
					limit = {
						is_at_war = yes
					}
					multiply = 0
				}
			}

			ai_check_interval_by_tier = {							
				barony = 0
				county = 6
				duchy = 2
				kingdom = 1
				empire = 1
				hegemony = 1
			}
		}
		aid = {
			contributor_cooldown = natural_disaster_individual_contribution_cooldown_value
			is_required = no

			context_allows_contributions = {
				tpg_great_project_disaster_in_recovery_phase_trigger = yes
			}

			contributor_is_valid = {
				tgp_natural_disaster_is_valid_contributor_trigger = yes
			}

			cost = { 
				gold = {
					value = 0
					if = {
						limit = { has_treasury = no }
						add = natural_disaster_contributions_cost_value
						add = natural_disaster_contributions_cost_base_discount
						multiply = {
							add = 1
							multiply = scope:great_project.var:situation.var:severity
							desc = great_project_contribution_cost_situation_severity
						}
					}
				}
				treasury = {
					value = 0
					if = {
						limit = { has_treasury = yes }
						add = natural_disaster_contributions_cost_treasury_value
						add = natural_disaster_contributions_cost_base_discount
						multiply = {
							add = 1
							multiply = scope:great_project.var:situation.var:severity
							desc = great_project_contribution_cost_situation_severity
						}
					}
				}
			}
			
			on_contribution_funded = {
				natural_disaster_great_project_save_scopes_effect = yes
				add_character_modifier = {
					modifier = tgp_natural_disaster_relief_savior
				}
				# Innovation: Divine Right extends the piety/opinion window
				if = {
					limit = { culture = { has_innovation = innovation_divine_right } }
					custom_tooltip = great_project_contribution_cost_innovation_divine_right
					add_character_modifier = {
						modifier = tgp_natural_disaster_relief_savior
						years = 5
					}
				}
				great_project_notify_contribution = yes
				great_project_contribution_catalyst_effect = yes
			}

			on_complete = {
				natural_disaster_great_project_save_scopes_effect = yes
				
				send_interface_toast = {
					type = event_toast_effect_good
					title = great_project_contribution_msg_t
					left_icon = root
					right_icon = scope:great_project.great_project_location.duchy

					if = {
						limit = { is_alive = yes }
						natural_disaster_great_project_optional_investment_reward_effect = yes
						# Big opinion boost with Head of Faith for humanitarian aid
						if = {
							limit = { 
								faith.religious_head ?= { is_alive = yes }
								NOT = { faith.religious_head = root }
							}
							faith.religious_head = {
								add_opinion = {
									opinion = 30
									modifier = disaster_relief_charitable_aid_opinion
									target = root
								}
							}
						}
					}
					# Innovation gating: Sanitation (35y), Pharmacopoeia (30y), else 25y
					if = {
						limit = { culture = { has_innovation = innovation_sanitation } }
						custom_tooltip = great_project_contribution_cost_innovation_sanitation
						natural_disaster_all_counties_investment_modifier_effect = { 
							OPERATION = add
							MODIFIER = tgp_natural_disaster_aid_county_modifier
							YEARS = 35
						}
					}
					else_if = {
						limit = { culture = { has_innovation = innovation_pharmacopoeia } }
						custom_tooltip = great_project_contribution_cost_innovation_pharmacopoeia
						natural_disaster_all_counties_investment_modifier_effect = { 
							OPERATION = add
							MODIFIER = tgp_natural_disaster_aid_county_modifier
							YEARS = 30
						}
					}
					else = {
						natural_disaster_all_counties_investment_modifier_effect = { 
							OPERATION = add
							MODIFIER = tgp_natural_disaster_aid_county_modifier
							YEARS = 25
						}
					}
				}
			}

			ai_will_do = {
				add = -75
				if = { # nobody better than me to deal with this
					limit = { this = top_liege }
					add = 100
				}
				add = {
					value = 0.75
					multiply = ai_honor
				}
				add = {
					value = -0.75
					multiply = ai_greed
				}
				add = {
					value = -0.25
					multiply = ai_rationality
				}
				add = {
					value = 0.25
					multiply = ai_energy
				}
				add = {
					value = 0.25
					multiply = ai_boldness
				}
				add = {
					value = 0.75
					multiply = ai_zeal
				}
				add = {
					value = -0.75
					multiply = ai_vengefulness
				}
				add = {
					value = 0.75
					multiply = ai_compassion
				}
				add = {
					value = 0.5
					multiply = ai_sociability
				}
				if = {
					limit = {
						is_at_war = yes
					}
					multiply = 0
				}
			}

			ai_check_interval_by_tier = {							
				barony = 0
				county = 6
				duchy = 2
				kingdom = 1
				empire = 1
				hegemony = 1
			}
		}
		memorial = {
			contributor_cooldown = natural_disaster_individual_contribution_cooldown_value
			is_required = no

			context_allows_contributions = {
				tpg_great_project_disaster_in_recovery_phase_trigger = yes
			}

			contributor_is_valid = {
				tgp_natural_disaster_is_valid_contributor_trigger = yes
			}

			cost = { 
				gold = {
					value = 0
					if = {
						limit = { has_treasury = no }
						add = {
							add = natural_disaster_contributions_cost_value
							multiply = 2
							desc = great_project_contribution_cost_num_affected_realm_counties
						}
						add = natural_disaster_contributions_cost_base_discount
						# Innovation-based cost discounts
						if = { 
							limit = { culture = { has_innovation = innovation_currency_03 } }
							multiply = {
								add = 0.9 
								desc = great_project_contribution_cost_innovation_currency_03
							}
						}
						if = { 
							limit = { culture = { has_innovation = innovation_cranes } } 
							multiply = {
								add = 0.85
								desc = great_project_contribution_cost_innovation_cranes
							}
						}
						if = { 
							limit = { culture = { has_innovation = fp3_innovation_mural_sextant } } 
							multiply = {
								add = 0.8
								desc = great_project_contribution_cost_innovation_fp3_innovation_mural_sextant
							}
						}
					}
				}
				treasury = {
					value = 0
					if = {
						limit = { has_treasury = yes }
						add = {
							add = natural_disaster_contributions_cost_treasury_value
							multiply = 2
							desc = great_project_contribution_cost_num_affected_realm_counties
						}
						add = natural_disaster_contributions_cost_base_discount
						# Innovation-based cost discounts
						if = { 
							limit = { culture = { has_innovation = innovation_currency_03 } }
							multiply = {
								add = 0.9 
								desc = great_project_contribution_cost_innovation_currency_03
							}
						}
						if = { 
							limit = { culture = { has_innovation = innovation_cranes } } 
							multiply = {
								add = 0.85
								desc = great_project_contribution_cost_innovation_cranes
							}
						}
						if = { 
							limit = { culture = { has_innovation = fp3_innovation_mural_sextant } } 
							multiply = {
								add = 0.8
								desc = great_project_contribution_cost_innovation_fp3_innovation_mural_sextant
							}
						}
					}
				}
			}
			
			on_contribution_funded = {
				great_project_notify_contribution = yes
				great_project_contribution_catalyst_effect = yes
			}

			on_complete = {
				natural_disaster_great_project_save_scopes_effect = yes
				
				send_interface_toast = {
					type = event_toast_effect_good
					title = great_project_contribution_msg_t
					left_icon = root
					right_icon = scope:great_project.great_project_location.duchy

					if = {
						limit = { is_alive = yes }
						natural_disaster_great_project_optional_investment_reward_effect = yes
						add_character_modifier = tgp_natural_disaster_built_memorial_fortifications
					}
					# Innovation: Wierdijks adds +1 fort level permanently
					if = {
						limit = { culture = { has_innovation = innovation_wierdijks } }
						custom_tooltip = great_project_contribution_cost_innovation_wierdijks
						natural_disaster_all_counties_investment_modifier_effect = { 
							OPERATION = add
							MODIFIER = tgp_natural_disaster_memorial_fortifications_wierdijks
							YEARS = -1
						}
					}
					else = {
						natural_disaster_all_counties_investment_modifier_effect = { 
							OPERATION = add
							MODIFIER = tgp_natural_disaster_memorial_fortifications
							YEARS = -1
						}
					}
				}
			}

			ai_will_do = {
				add = -75
				if = { # nobody better than me to deal with this
					limit = { this = top_liege }
					add = 100
				}
				add = {
					value = 0.5
					multiply = ai_honor
				}
				add = {
					value = -0.75
					multiply = ai_greed
				}
				add = {
					value = 0.5
					multiply = ai_rationality
				}
				add = {
					value = 0.25
					multiply = ai_energy
				}
				add = {
					value = 0.75
					multiply = ai_boldness
				}
				add = {
					value = 0.25
					multiply = ai_zeal
				}
				add = {
					value = 0.25
					multiply = ai_vengefulness
				}
				add = {
					value = -0.25
					multiply = ai_compassion
				}
				add = {
					value = -0.25
					multiply = ai_sociability
				}
				if = {
					limit = {
						is_at_war = yes
					}
					multiply = 0
				}
			}

			ai_check_interval_by_tier = {							
				barony = 0
				county = 6
				duchy = 2
				kingdom = 1
				empire = 1
				hegemony = 1
			}
		}
	}
}
