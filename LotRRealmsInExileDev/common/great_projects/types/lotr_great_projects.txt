@msg_completion_effect_dwarven = "event:/DLC/EP4/SFX/Stingers/China/tgp_mx_sting_finishing_great_project_disaster"
@great_project_dwarven_icon = "gfx/interface/icons/great_projects/_default.dds"
@dwarven_capital_illustration = "gfx/interface/illustrations/decisions/decision_dwarves_03.dds"
@lotr_build_fleet_icon = "gfx/interface/icons/activities/activity_sailing.dds"
@lotr_build_fleet_illustration = "gfx/interface/illustrations/decisions/decision_fleet.dds"
@lotr_mend_realm_icon = "gfx/interface/icons/faith/custom_elves.dds"
@lotr_mend_realm_illustration = "gfx/interface/illustrations/event_scenes/elven_holding.dds"

### The Dwarven Capital Great Project! ~ by Brice Underhill

dwarven_capital_02 = {
	icon = {
		reference = @great_project_dwarven_icon
	}
	illustration = {
		reference = @dwarven_capital_illustration
	}
	name = {
		desc = great_project_type_dwarven_capital_02
	}
	owner = province_owner

	is_important = yes
	is_shown = {
		is_dwarf = yes
		any_held_county = {
			any_province = {
				has_ruined_great_building = no
				has_building_with_flag = first_tier_dwarven_capital_building
				NOT = { has_building_with_flag = second_tier_dwarven_capital_building }
			}
		}
		NOT = { is_planning_great_project = dwarven_capital_02 }
	}

	province_filter = top_realm

	is_location_valid = {
		scope:province = {
			custom_tooltip = {
				text = lotr_great_project_type_dwarven_capital_has_t1_building
				has_building_with_flag = first_tier_dwarven_capital_building
			}
		}
	}

	can_start_planning = {
		is_dwarf = yes
		NOR = {
			is_planning_great_project = dwarven_capital_02
			prestige_level < high_prestige_level
		}
		legitimacy_level >= 2
		trigger_if = {
			limit = {
				any_character_struggle = {
					involvement = involved
					is_struggle_type = balrog_struggle
				}
			}
			any_character_struggle = {
				involvement = involved
				is_struggle_type = balrog_struggle
				is_struggle_phase = struggle_balrog_phase_slumbering
			}
		}
	}

	cost = {
		gold = dwarven_capital_gold_cost
	}

	construction_time = great_project_mandala_construction_time

	contributor_cooldown = standard_contributor_cooldown_value

	on_plan_build = {
		scope:owner = {
			#Memory
			create_character_memory = {
				type = started_planning_dwarven_capital_memory
				participants = { founder = scope:owner }
			}
			scope:new_memory ?= {
				set_variable = {
					name = dwarven_capital_planned_location
					value = scope:province
				}
				set_variable = {
					name = second_tier_dwarven_capital
					value = flag:yes
				}
				if = {
					limit = { 
						exists = var:dwarven_capital_planned_location
						exists = var:second_tier_dwarven_capital
					}
					#To prevent 'unused except in loc' errors :catto:
				}
			}
		}
	}

	on_complete = {
		scope:province = {
			upgrade_dwarven_great_building_effect = yes
		}
		scope:owner = {
			#Owner rewards
			show_as_tooltip = { mandala_owner_reward_01_effect = yes }
		}
		#Tally the rewards
		scope:great_project ?= { #LotR TODO - Change the phases if necessary
			#Rite of Mahal
			determine_if_contributed_and_save_scope_effect = { CONTRIBUTION = rite_of_mahal }
			#Brick
			determine_if_contributed_and_save_scope_effect = { CONTRIBUTION = brick }
			#Tiles
			determine_if_contributed_and_save_scope_effect = { CONTRIBUTION = tiles }
			#Shallow Pools
			determine_if_contributed_and_save_scope_effect = { CONTRIBUTION = shallow_pools }
			#Work Force
			determine_if_contributed_and_save_scope_effect = { CONTRIBUTION = work_force }
			#Decorative Tiles
			determine_if_contributed_and_save_scope_effect = { CONTRIBUTION = decorative_tiles }
			#Decorated Domes
			determine_if_contributed_and_save_scope_effect = { CONTRIBUTION = decorated_ceilings }
			#Family Statues
			determine_if_contributed_and_save_scope_effect = { CONTRIBUTION = throne_room }
		}
		#Dole out some rewards!
		gather_contributors_in_list_effect = yes
		every_in_list = {
			list = contributors_to_reward
			if = {
				limit = { this = scope:owner }
				trigger_event = lotr_great_project.1000
			}
			else = {
				if = {
					limit = { 
						scope:owner = { is_ai = yes }
					}
					show_as_tooltip = { 
						mandala_contributor_opinion_reward_effect = { OVERLORD = scope:owner }
					}
				}
				trigger_event = lotr_great_project.1010
			}
		}
	}

	on_cancel = {
		scope:owner = {
			add_prestige = minor_prestige_loss
		}
		every_contribution = {
			limit = {
				contribution_is_funded = yes
			}
			contributor = {
				if = {
					limit = {
						this != scope:owner
						this != scope:founder
					}
					add_to_list = contributors_to_disappoint	
				}
			}
		}
		every_in_list = {
			list = contributors_to_disappoint
			add_opinion = {
				modifier = wasted_our_efforts
				target = scope:owner
				opinion = -30
			}
		}
	}

	on_start_build = {
		scope:owner = {
			add_legitimacy_effect = { LEGITIMACY = minor_legitimacy_gain }
		}
		scope:great_project = {
			every_contribution = {
				limit = {
					contribution_is_funded = yes
				}
				contributor = {
					add_prestige = minor_prestige_value 
				}	
			}
		}
	}

	allowed_contributor_filter = {
		owner = yes
		tributaries = yes
		vassals = yes
	}

	project_contributions = {
		rite_of_mahal = {
			allowed_contributor_filter = {
				owner = yes
			}
			contributor_is_valid = {
				dwarven_second_tier_trigger = yes
			}

			cost = { }

			contributor_cooldown = individual_contribution_cooldown_value

			on_complete = {
				show_as_tooltip = { mandala_contributor_minor_rite_reward_effect = yes }
			}
			ai_check_interval_by_tier = {							
				barony = 0
				county = 3
				duchy = 3
				kingdom = 3
				empire = 3
				hegemony = 3
			}
			ai_will_do = {
				value = 1000
			}
		}

		brick = {
			contributor_is_valid = { highest_held_title_tier > tier_barony }

			cost = { 
				gold = {
					if = {
						limit = { is_ai = yes }
						value = mandala_contribution_low_gold_cost
					}
					else = { value = dwarven_contribution_mid_gold_cost }
				}
			}

			contributor_cooldown = individual_contribution_cooldown_value

			on_complete = {
				show_as_tooltip = { mandala_contributor_brick_reward_effect = yes }
			}
			ai_check_interval_by_tier = {							
				barony = 0
				county = 12
				duchy = 12
				kingdom = 6
				empire = 6
				hegemony = 6
			}
			ai_will_do = {
				value = 100
				if = {
					limit = {
						is_tributary = yes
						overlord = { has_realm_law_flag = tributaries_more_likely_to_contribute_to_GPs }
					}
					multiply = 2
				}
			}
		}

		tiles = {
			contributor_is_valid = { highest_held_title_tier > tier_barony }

			cost = { 
				gold = {
					if = {
						limit = { is_ai = yes }
						value = mandala_contribution_low_gold_cost
					}
					else = { value = dwarven_contribution_mid_gold_cost }
				}
				piety = {
					if = {
						limit = { is_ai = yes }
						value = mandala_contribution_low_piety_cost
					}
					else = { value = mandala_contribution_mid_piety_cost }
				}
			}

			contributor_cooldown = individual_contribution_cooldown_value

			on_complete = {
				show_as_tooltip = { mandala_contributor_tiles_reward_effect = yes }
			}
			ai_check_interval_by_tier = {							
				barony = 0
				county = 12
				duchy = 12
				kingdom = 6
				empire = 6
				hegemony = 6
			}
			ai_will_do = {
				value = 100
				if = {
					limit = {
						is_tributary = yes
						overlord = { has_realm_law_flag = tributaries_more_likely_to_contribute_to_GPs }
					}
					multiply = 2
				}
			}
		}

		shallow_pools = {
			contributor_is_valid = { highest_held_title_tier > tier_barony }

			cost = { 
				gold = {
					if = {
						limit = { is_ai = yes }
						value = mandala_contribution_low_gold_cost
					}
					else = { value = dwarven_contribution_mid_gold_cost }
				}
				piety = {
					if = {
						limit = { is_ai = yes }
						value = mandala_contribution_low_piety_cost
					}
					else = { value = mandala_contribution_mid_piety_cost }
				}
			}

			contributor_cooldown = individual_contribution_cooldown_value

			on_complete = {
				show_as_tooltip = { mandala_contributor_shallow_pools_reward_effect = yes }
			}
			ai_check_interval_by_tier = {							
				barony = 0
				county = 12
				duchy = 12
				kingdom = 6
				empire = 6
				hegemony = 6
			}
			ai_will_do = {
				value = 100
				if = {
					limit = {
						is_tributary = yes
						overlord = { has_realm_law_flag = tributaries_more_likely_to_contribute_to_GPs }
					}
					multiply = 2
				}
			}
		}

		work_force = {
			contributor_is_valid = { highest_held_title_tier > tier_barony }

			cost = {
				piety = {
					if = {
						limit = { is_ai = yes }
						value = mandala_contribution_mid_piety_cost
					}
					else = { value = mandala_contribution_high_piety_cost }
				} 
			}

			contributor_cooldown = individual_contribution_cooldown_value

			on_complete = {
				show_as_tooltip = { mandala_contributor_work_force_reward_effect = yes }
			}
			ai_check_interval_by_tier = {							
				barony = 0
				county = 12
				duchy = 12
				kingdom = 6
				empire = 6
				hegemony = 6
			}
			ai_will_do = {
				value = 100
				if = {
					limit = {
						is_tributary = yes
						overlord = { has_realm_law_flag = tributaries_more_likely_to_contribute_to_GPs }
					}
					multiply = 2
				}
			}
		}

		decorative_tiles = {
			is_required = no

			contributor_is_valid = { highest_held_title_tier > tier_barony }

			cost = { 
				gold = {
					if = {
						limit = { is_ai = yes }
						value = mandala_contribution_low_gold_cost
					}
					else = { value = dwarven_contribution_mid_gold_cost }
				}
			}

			contributor_cooldown = individual_contribution_cooldown_value

			on_complete = {
				show_as_tooltip = { mandala_contributor_decorative_tiles_reward_effect = yes }
			}
			ai_check_interval_by_tier = {							
				barony = 0
				county = 12
				duchy = 12
				kingdom = 6
				empire = 6
				hegemony = 6
			}
			ai_will_do = {
				value = 50
				if = {
					limit = {
						is_tributary = yes
						overlord = { has_realm_law_flag = tributaries_more_likely_to_contribute_to_GPs }
					}
					multiply = 2
				}
			}
		}

		decorated_ceilings = {
			is_required = no

			contributor_is_valid = { highest_held_title_tier > tier_barony }

			cost = { 
				gold = {
					if = {
						limit = { is_ai = yes }
						value = mandala_contribution_low_gold_cost
					}
					else_if = {
						limit = {
							this = scope:owner
							dynasty = { has_dynasty_modifier = dwarven_decorated_ceilings_dynasty_modifier }
						}
						value = {
							add = dwarven_contribution_mid_gold_cost
							divide = 2
						}
					}
					else = { value = dwarven_contribution_mid_gold_cost }
				}
				piety = {
					if = {
						limit = { is_ai = yes }
						value = mandala_contribution_mid_piety_cost
					}
					else_if = {
						limit = {
							this = scope:owner
							dynasty = { has_dynasty_modifier = dwarven_decorated_ceilings_dynasty_modifier }
						}
						value = {
							add = mandala_contribution_high_piety_cost
							subtract = mandala_contribution_mid_piety_cost
						}
					}
					else = { value = mandala_contribution_high_piety_cost }
				}
			}

			contributor_cooldown = individual_contribution_cooldown_value

			on_complete = {
				show_as_tooltip = { dwarven_contributor_decorated_ceilings_reward_effect = yes }
			}
			ai_check_interval_by_tier = {							
				barony = 0
				county = 12
				duchy = 12
				kingdom = 6
				empire = 6
				hegemony = 6
			}
			ai_will_do = {
				value = 50
				if = {
					limit = {
						is_tributary = yes
						overlord = { has_realm_law_flag = tributaries_more_likely_to_contribute_to_GPs }
					}
					multiply = 2
				}
			}
		}

		throne_room = {
			is_required = no

			is_shown = {
				trigger_if = {
					limit = {
						NOT = { exists = scope:owner }
					}
					always = yes
				}
				trigger_else = {
					exists = scope:owner.primary_heir
					scope:owner.dynasty ?= { has_dynasty_perk = tgp_sea_legacy_3 }
				}
			}

			allowed_contributor_filter = {
				owner = yes
			}
			contributor_is_valid = {
				custom_tooltip = {
					text = tgp_sea_legacy_3_name
					dynasty = { has_dynasty_perk = tgp_sea_legacy_3 }
				}
			}

			cost = { 
				gold = {
					if = {
						limit = { is_ai = yes }
						value = dwarven_contribution_mid_gold_cost
					}
					else = { value = mandala_contribution_high_gold_cost }
				}
				piety = {
					if = {
						limit = { is_ai = yes }
						value = mandala_contribution_mid_piety_cost
					}
					else = { value = mandala_contribution_high_piety_cost }
				}
			}

			contributor_cooldown = individual_contribution_cooldown_value

			on_complete = {
				show_as_tooltip = { dwarven_contributor_throne_room_reward_effect = yes }
			}

			ai_check_interval_by_tier = {							
				barony = 0
				county = 12
				duchy = 12
				kingdom = 6
				empire = 6
				hegemony = 6
			}
			ai_will_do = {
				value = 50
			}
		}
	}

	ai_target_quick_trigger = {
		adult = yes
		rank = county
	}
	ai_check_interval_by_tier = {							
		barony = 0
		county = 1
		duchy = 1
		kingdom = 1
		empire = 1
		hegemony = 1
	}
	ai_will_do = {
		value = 1000
	}

	completion_sound_effect = @msg_completion_effect_dwarven
}

dwarven_capital_03 = {
	icon = {
		reference = @great_project_dwarven_icon
	}
	illustration = {
		reference = @dwarven_capital_illustration
	}
	name = {
		desc = great_project_type_dwarven_capital_03
	}
	owner = province_owner

	is_important = yes
	is_shown = {
		is_dwarf = yes
		any_held_county = {
			any_province = {
				has_ruined_great_building = no
				has_building_with_flag = second_tier_dwarven_capital_building
				NOT = { has_building_with_flag = third_tier_dwarven_capital_building }
			}
		}
		NOT = { is_planning_great_project = dwarven_capital_03 }
	}

	
	province_filter = top_realm

	is_location_valid = {
		scope:province = {
			has_ruined_great_building = no
			custom_tooltip = {
				text = lotr_great_project_type_dwarven_capital_has_t2_building
				has_building_with_flag = second_tier_dwarven_capital_building
			}
		}
	}

	can_start_planning = {
		is_dwarf = yes
		NOR = {
			is_planning_great_project = dwarven_capital_03
			prestige_level < high_prestige_level
		}
		legitimacy_level >= 3
		trigger_if = {
			limit = {
				any_character_struggle = {
					involvement = involved
					is_struggle_type = balrog_struggle
				}
			}
			any_character_struggle = {
				involvement = involved
				is_struggle_type = balrog_struggle
				is_struggle_phase = struggle_balrog_phase_slumbering
			}
		}
	}

	cost = {
		gold = {
			value = dwarven_capital_gold_cost
			multiply = 1.5
		}
	}

	construction_time = great_project_mandala_increased_construction_time

	contributor_cooldown = standard_contributor_cooldown_value

	on_plan_build = {
		scope:owner = {
			#Memory
			create_character_memory = {
				type = started_planning_dwarven_capital_memory
				participants = { founder = scope:owner }
			}
			scope:new_memory ?= {
				set_variable = {
					name = dwarven_capital_planned_location
					value = scope:province
				}
				set_variable = {
					name = third_tier_dwarven_capital
					value = flag:yes
				}
				if = {
					limit = { 
						exists = var:dwarven_capital_planned_location
						exists = var:third_tier_dwarven_capital
					}
					#To prevent 'unused except in loc' errors :catto:
				}
			}
		}
	}

	on_complete = {
		scope:province = {
			upgrade_dwarven_great_building_effect = yes
		}
		scope:owner = {
			#Owner rewards
			show_as_tooltip = { mandala_owner_reward_01_effect = yes }
		}
		#Tally the rewards
		scope:great_project ?= {
			#Rite of Mahal
			determine_if_contributed_and_save_scope_effect = { CONTRIBUTION = rite_of_mahal }
			#Volcanic Stone
			determine_if_contributed_and_save_scope_effect = { CONTRIBUTION = marble_stone }
			#Corbel Gateways
			determine_if_contributed_and_save_scope_effect = { CONTRIBUTION = arched_gateways }
			#Divine Statues
			determine_if_contributed_and_save_scope_effect = { CONTRIBUTION = divine_statues }
			#Work Force
			determine_if_contributed_and_save_scope_effect = { CONTRIBUTION = work_force }
			#Dynasty_prestige
			determine_if_contributed_and_save_scope_effect = { CONTRIBUTION = dynastic_statues }
			#Gilded Ceilings
			determine_if_contributed_and_save_scope_effect = { CONTRIBUTION = gilded_ceilings }
			#Family Temple Compound
			determine_if_contributed_and_save_scope_effect = { CONTRIBUTION = palatial_compound }
		}
		#Dole out some rewards!
		gather_contributors_in_list_effect = yes
		every_in_list = {
			list = contributors_to_reward
			if = {
				limit = { this = scope:owner }
				trigger_event = lotr_great_project.1000
			}
			else = {
				if = {
					limit = { 
						scope:owner = { is_ai = yes }
					}
					show_as_tooltip = { 
						mandala_contributor_opinion_reward_effect = { OVERLORD = scope:owner }
					}
				}
				trigger_event = lotr_great_project.1010
			}
		}
	}

	on_cancel = {
		scope:owner = {
			add_prestige = minor_prestige_loss
		}
		every_contribution = {
			limit = {
				contribution_is_funded = yes
			}
			contributor = {
				if = {
					limit = {
						this != scope:owner
						this != scope:founder
					}
					add_to_list = contributors_to_disappoint	
				}
			}
		}
		every_in_list = {
			list = contributors_to_disappoint
			add_opinion = {
				modifier = wasted_our_efforts
				target = scope:owner
				opinion = -30
			}
		}
	}

	on_start_build = {
		scope:owner = {
			add_legitimacy_effect = { LEGITIMACY = minor_legitimacy_gain }
		}
		scope:great_project = {
			every_contribution = {
				limit = {
					contribution_is_funded = yes
				}
				contributor = {
					add_prestige = minor_prestige_value 
				}	
			}
		}
	}

	allowed_contributor_filter = {
		owner = yes
		tributaries = yes
		vassals = yes
	}

	invite_interaction = request_great_project_contribution_interaction

	project_contributions = {
		rite_of_mahal = {
			allowed_contributor_filter = {
				owner = yes
			}
			contributor_is_valid = { 
				dwarven_third_tier_trigger = yes
			}

			cost = { }

			contributor_cooldown = individual_contribution_cooldown_value

			on_complete = {
				show_as_tooltip = { mandala_contributor_medium_rite_reward_effect = yes }
			}
			ai_check_interval_by_tier = {							
				barony = 0
				county = 3
				duchy = 3
				kingdom = 3
				empire = 3
				hegemony = 3
			}
			ai_will_do = {
				value = 1000
			}
		}

		marble_stone = {
			contributor_is_valid = { highest_held_title_tier > tier_barony }

			cost = { 
				gold = {
					if = {
						limit = { is_ai = yes }
						value = dwarven_contribution_mid_gold_cost
					}
					else = { value = mandala_contribution_high_gold_cost }
				}
			}

			contributor_cooldown = individual_contribution_cooldown_value

			on_complete = {
				show_as_tooltip = { dwarven_contributor_marble_stone_reward_effect = yes }
			}
			ai_check_interval_by_tier = {							
				barony = 0
				county = 12
				duchy = 12
				kingdom = 6
				empire = 6
				hegemony = 6
			}
			ai_will_do = {
				value = 100
				if = {
					limit = {
						is_tributary = yes
						overlord = { has_realm_law_flag = tributaries_more_likely_to_contribute_to_GPs }
					}
					multiply = 2
				}
			}
		}

		arched_gateways = {
			contributor_is_valid = { highest_held_title_tier > tier_barony }

			cost = { 
				gold = {
					if = {
						limit = { is_ai = yes }
						value = dwarven_contribution_mid_gold_cost
					}
					else = { value = mandala_contribution_high_gold_cost }
				}
				piety = {
					if = {
						limit = { is_ai = yes }
						value = mandala_contribution_mid_piety_cost
					}
					else = { value = mandala_contribution_high_piety_cost }
				}
			}

			contributor_cooldown = individual_contribution_cooldown_value

			on_complete = {
				show_as_tooltip = { dwarven_contributor_arched_gateways_reward_effect = yes }
			}
			ai_check_interval_by_tier = {							
				barony = 0
				county = 12
				duchy = 12
				kingdom = 6
				empire = 6
				hegemony = 6
			}
			ai_will_do = {
				value = 100
				if = {
					limit = {
						is_tributary = yes
						overlord = { has_realm_law_flag = tributaries_more_likely_to_contribute_to_GPs }
					}
					multiply = 2
				}
			}
		}

		divine_statues = {
			contributor_is_valid = { highest_held_title_tier > tier_barony }

			cost = { 
				gold = {
					if = {
						limit = { is_ai = yes }
						value = dwarven_contribution_mid_gold_cost
					}
					else = { value = mandala_contribution_high_gold_cost }
				}
				piety = {
					if = {
						limit = { is_ai = yes }
						value = mandala_contribution_mid_piety_cost
					}
					else = { value = mandala_contribution_high_piety_cost }
				}
			}

			contributor_cooldown = individual_contribution_cooldown_value

			on_complete = {
				show_as_tooltip = { mandala_contributor_divine_statues_reward_effect = yes }
			}
			ai_check_interval_by_tier = {							
				barony = 0
				county = 12
				duchy = 12
				kingdom = 6
				empire = 6
				hegemony = 6
			}
			ai_will_do = {
				value = 100
				if = {
					limit = {
						is_tributary = yes
						overlord = { has_realm_law_flag = tributaries_more_likely_to_contribute_to_GPs }
					}
					multiply = 2
				}
			}
		}

		work_force = {
			contributor_is_valid = { highest_held_title_tier > tier_barony }

			cost = {
				piety = {
					if = {
						limit = { is_ai = yes }
						value = mandala_contribution_mid_piety_cost
					}
					else = { value = mandala_contribution_huge_piety_cost }
				} 
			}
			
			contributor_cooldown = individual_contribution_cooldown_value

			on_complete = {
				show_as_tooltip = { mandala_contributor_work_force_reward_effect = yes }
			}
			ai_check_interval_by_tier = {							
				barony = 0
				county = 12
				duchy = 12
				kingdom = 6
				empire = 6
				hegemony = 6
			}
			ai_will_do = {
				value = 100
				if = {
					limit = {
						is_tributary = yes
						overlord = { has_realm_law_flag = tributaries_more_likely_to_contribute_to_GPs }
					}
					multiply = 2
				}
			}
		}

		dynastic_statues = {
			is_required = no

			is_shown = {
				trigger_if = {
					limit = {
						NOT = { exists = scope:owner }
					}
					always = yes
				}
				trigger_else = {
					scope:owner.dynasty ?= { dynasty_prestige_level >= 2 }
				}
			}

			allowed_contributor_filter = {
				owner = yes
			}
			contributor_is_valid = { 
				piety_level >= max_prestige_level
				custom_tooltip = {
					text = great_project_dwarven_capital_has_dynasty_prestige_tt
					dynasty ?= { dynasty_prestige_level >= 2 }
				}
			}

			cost = { 
				gold = {
					if = {
						limit = { is_ai = yes }
						value = dwarven_contribution_mid_gold_cost
					}
					else = { value = mandala_contribution_high_gold_cost }
				}
				piety = {
					if = {
						limit = { is_ai = yes }
						value = mandala_contribution_mid_piety_cost
					}
					else = { value = mandala_contribution_huge_piety_cost }
				}
			}

			contributor_cooldown = individual_contribution_cooldown_value

			on_complete = {
				show_as_tooltip = { dwarven_contributor_dynastic_statues_reward_effect = yes }
			}
			ai_check_interval_by_tier = {							
				barony = 0
				county = 12
				duchy = 12
				kingdom = 6
				empire = 6
				hegemony = 6
			}
			ai_will_do = {
				value = 50
				if = {
					limit = {
						is_tributary = yes
						overlord = { has_realm_law_flag = tributaries_more_likely_to_contribute_to_GPs }
					}
					multiply = 2
				}
			}
		}

		gilded_ceilings = {
			is_required = no

			contributor_is_valid = { highest_held_title_tier > tier_barony }

			cost = { 
				gold = {
					if = {
						limit = { is_ai = yes }
						value = dwarven_contribution_mid_gold_cost
					}
					else = { value = mandala_contribution_high_gold_cost }
				}
			}

			contributor_cooldown = individual_contribution_cooldown_value

			on_complete = {
				show_as_tooltip = { dwarven_contributor_gilded_ceilings_reward_effect = yes }
			}
			ai_check_interval_by_tier = {							
				barony = 0
				county = 12
				duchy = 12
				kingdom = 6
				empire = 6
				hegemony = 6
			}
			ai_will_do = {
				value = 50
				if = {
					limit = {
						is_tributary = yes
						overlord = { has_realm_law_flag = tributaries_more_likely_to_contribute_to_GPs }
					}
					multiply = 2
				}
			}
		}

		palatial_compound = {
			is_required = no

			is_shown = {
				trigger_if = {
					limit = {
						NOT = { exists = scope:owner }
					}
					always = yes
				}
				trigger_else = {
					exists = scope:owner.primary_heir
					scope:owner.dynasty ?= { has_dynasty_perk = lotr_khazad_legacy_3 }
				}
			}

			contributor_is_valid = {
				this = scope:owner
				custom_tooltip = {
					text = lotr_khazad_legacy_3_name
					dynasty = { has_dynasty_perk = lotr_khazad_legacy_3 }
				}
			}

			cost = { 
				gold = {
					if = {
						limit = { is_ai = yes }
						value = dwarven_contribution_mid_gold_cost
					}
					else = { value = mandala_contribution_high_gold_cost }
				}
				piety = {
					if = {
						limit = { is_ai = yes }
						value = mandala_contribution_mid_piety_cost
					}
					else = { value = mandala_contribution_huge_piety_cost }
				}
			}

			contributor_cooldown = individual_contribution_cooldown_value

			on_complete = {
				show_as_tooltip = { dwarven_contributor_palatial_compound_reward_effect = yes }
			}

			ai_check_interval_by_tier = {							
				barony = 0
				county = 12
				duchy = 12
				kingdom = 6
				empire = 6
				hegemony = 6
			}
			ai_will_do = {
				value = 50
			}
		}

	}

	ai_target_quick_trigger = {
		adult = yes
		rank = county
	}
	ai_check_interval_by_tier = {							
		barony = 0
		county = 1
		duchy = 1
		kingdom = 1
		empire = 1
		hegemony = 1
	}
	ai_will_do = {
		value = 1000
	}

	completion_sound_effect = @msg_completion_effect_dwarven
}

dwarven_capital_04 = {
	icon = {
		reference = @great_project_dwarven_icon
	}
	illustration = {
		reference = @dwarven_capital_illustration
	}
	name = {
		desc = great_project_type_dwarven_capital_03
	}
	owner = province_owner

	is_important = yes
	is_shown = {
		is_dwarf = yes
		any_held_county = { 
			any_province = {
				has_ruined_great_building = no
				has_building_with_flag = third_tier_dwarven_capital_building
				NOT = { has_building_with_flag = fourth_tier_dwarven_capital_building }
			}
		}
		NOT = { is_planning_great_project = dwarven_capital_04 }
	}

	
	province_filter = top_realm

	is_location_valid = {
		scope:province = {
			has_ruined_great_building = no
			custom_tooltip = {
				text = lotr_great_project_type_dwarven_capital_has_t3_building
				has_building_with_flag = third_tier_dwarven_capital_building
			}
		}
	}

	can_start_planning = {
		is_dwarf = yes
		NOR = {
			is_planning_great_project = dwarven_capital_04
			prestige_level < very_high_prestige_level
		}
		legitimacy_level >= 4
		trigger_if = {
			limit = {
				any_character_struggle = {
					involvement = involved
					is_struggle_type = balrog_struggle
				}
			}
			any_character_struggle = {
				involvement = involved
				is_struggle_type = balrog_struggle
				is_struggle_phase = struggle_balrog_phase_slumbering
			}
		}
	}

	cost = {
		gold = {
			value = dwarven_capital_gold_cost
			multiply = 2
		}
	}

	construction_time = great_project_mandala_increased_construction_time

	contributor_cooldown = standard_contributor_cooldown_value

	on_plan_build = {
		scope:owner = {
			#Memory
			create_character_memory = {
				type = started_planning_dwarven_capital_memory
				participants = { founder = scope:owner }
			}
			scope:new_memory ?= {
				set_variable = {
					name = dwarven_capital_planned_location
					value = scope:province
				}
				set_variable = {
					name = fourth_tier_dwarven_capital
					value = flag:yes
				}
				if = {
					limit = { 
						exists = var:dwarven_capital_planned_location
						exists = var:fourth_tier_dwarven_capital
					}
					#To prevent 'unused except in loc' errors :catto:
				}
			}
		}
	}

	on_complete = { 
		scope:province = {
			upgrade_dwarven_great_building_effect = yes
		}
		scope:owner = {
			#Owner rewards
			show_as_tooltip = { mandala_owner_reward_01_effect = yes }
		}
		#Tally the rewards
		scope:great_project ?= {
			#Rite of Mahal
			determine_if_contributed_and_save_scope_effect = { CONTRIBUTION = rite_of_mahal }
			#Slabs of Porphyry
			determine_if_contributed_and_save_scope_effect = { CONTRIBUTION = slabs_of_porphyry }
			#Light Shafts
			determine_if_contributed_and_save_scope_effect = { CONTRIBUTION = light_shafts }
			#Great Mirrors
			determine_if_contributed_and_save_scope_effect = { CONTRIBUTION = great_mirrors }
			#Work Force
			determine_if_contributed_and_save_scope_effect = { CONTRIBUTION = work_force }
			#Carven Pillars
			determine_if_contributed_and_save_scope_effect = { CONTRIBUTION = carven_pillars }
			#Bejeweled Ceilings
			determine_if_contributed_and_save_scope_effect = { CONTRIBUTION = bejeweled_ceilings }
			#Palatial Complex
			determine_if_contributed_and_save_scope_effect = { CONTRIBUTION = palatial_complex }
		}
		#Dole out some rewards!
		gather_contributors_in_list_effect = yes
		every_in_list = {
			list = contributors_to_reward
			if = {
				limit = { this = scope:owner }
				trigger_event = lotr_great_project.1000
			}
			else = {
				if = {
					limit = { 
						scope:owner = { is_ai = yes }
					}
					show_as_tooltip = { 
						mandala_contributor_opinion_reward_effect = { OVERLORD = scope:owner }
					}
				}
				trigger_event = lotr_great_project.1010
			}
		}
	}

	on_cancel = {
		scope:owner = {
			add_prestige = minor_prestige_loss
		}
		every_contribution = {
			limit = {
				contribution_is_funded = yes
			}
			contributor = {
				if = {
					limit = {
						this != scope:owner
						this != scope:founder
					}
					add_to_list = contributors_to_disappoint	
				}
			}
		}
		every_in_list = {
			list = contributors_to_disappoint
			add_opinion = {
				modifier = wasted_our_efforts
				target = scope:owner
				opinion = -30
			}
		}
	}

	on_start_build = {
		scope:owner = {
			add_legitimacy_effect = { LEGITIMACY = minor_legitimacy_gain }
		}
		scope:great_project = {
			every_contribution = {
				limit = {
					contribution_is_funded = yes
				}
				contributor = {
					add_prestige = minor_prestige_value 
				}	
			}
		}
	}

	allowed_contributor_filter = {
		owner = yes
		tributaries = yes
		vassals = yes
	}

	project_contributions = {
		rite_of_mahal = {
			allowed_contributor_filter = {
				owner = yes
			}
			contributor_is_valid = { 
				dwarven_fourth_tier_trigger = yes
			}
			cost = { }

			contributor_cooldown = individual_contribution_cooldown_value

			on_complete = {
				show_as_tooltip = { contributed_rite_of_mahal_02_effect = yes }
			}
			ai_check_interval_by_tier = {							
				barony = 0
				county = 3
				duchy = 3
				kingdom = 3
				empire = 3
				hegemony = 3
			}
			ai_will_do = {
				value = 1000
			}
		}

		slabs_of_porphyry = {
			contributor_is_valid = { highest_held_title_tier > tier_barony }

			cost = { 
				gold = {
					if = {
						limit = { is_ai = yes }
						value = dwarven_contribution_mid_gold_cost
					}
					else = { value = dwarven_contribution_huge_gold_cost }
				}
			}

			contributor_cooldown = individual_contribution_cooldown_value
			
			on_complete = {
				show_as_tooltip = { dwarven_contributor_slabs_of_porphyry_reward_effect = yes }
			}
			ai_check_interval_by_tier = {							
				barony = 0
				county = 12
				duchy = 12
				kingdom = 6
				empire = 6
				hegemony = 6
			}
			ai_will_do = {
				value = 100
				if = {
					limit = {
						is_tributary = yes
						overlord = { has_realm_law_flag = tributaries_more_likely_to_contribute_to_GPs }
					}
					multiply = 2
				}
			}
		}

		light_shafts = {
			contributor_is_valid = { highest_held_title_tier > tier_barony }

			cost = { 
				gold = {
					if = {
						limit = { is_ai = yes }
						value = dwarven_contribution_mid_gold_cost
					}
					else = { value = dwarven_contribution_huge_gold_cost }
				}
				piety = {
					if = {
						limit = { is_ai = yes }
						value = mandala_contribution_mid_piety_cost
					}
					else = { value = mandala_contribution_huge_piety_cost }
				}
			}

			contributor_cooldown = individual_contribution_cooldown_value
			
			on_complete = {
				show_as_tooltip = { mandala_contributor_zaungdans_reward_effect = yes }
			}
			ai_check_interval_by_tier = {							
				barony = 0
				county = 12
				duchy = 12
				kingdom = 6
				empire = 6
				hegemony = 6
			}
			ai_will_do = {
				value = 100
				if = {
					limit = {
						is_tributary = yes
						overlord = { has_realm_law_flag = tributaries_more_likely_to_contribute_to_GPs }
					}
					multiply = 2
				}
			}
		}

		great_mirrors = {
			contributor_is_valid = { highest_held_title_tier > tier_barony }

			cost = { 
				gold = {
					if = {
						limit = { is_ai = yes }
						value = dwarven_contribution_mid_gold_cost
					}
					else = { value = dwarven_contribution_huge_gold_cost }
				}
				piety = {
					if = {
						limit = { is_ai = yes }
						value = mandala_contribution_mid_piety_cost
					}
					else = { value = mandala_contribution_huge_piety_cost }
				}
			}

			contributor_cooldown = individual_contribution_cooldown_value
			
			on_complete = {
				show_as_tooltip = { mandala_contributor_gilded_shrines_reward_effect = yes }
			}
			ai_check_interval_by_tier = {							
				barony = 0
				county = 12
				duchy = 12
				kingdom = 6
				empire = 6
				hegemony = 6
			}
			ai_will_do = {
				value = 100
				if = {
					limit = {
						is_tributary = yes
						overlord = { has_realm_law_flag = tributaries_more_likely_to_contribute_to_GPs }
					}
					multiply = 2
				}
			}
		}

		work_force = {
			contributor_is_valid = { highest_held_title_tier > tier_barony }

			cost = { 
				piety = {
					if = {
						limit = { is_ai = yes }
						value = 0
					}
					else = { value = mandala_contribution_huge_piety_cost }
				}
			}

			contributor_cooldown = individual_contribution_cooldown_value

			on_complete = {
				show_as_tooltip = { mandala_contributor_work_force_reward_effect = yes }
			}
			ai_check_interval_by_tier = {							
				barony = 0
				county = 12
				duchy = 12
				kingdom = 6
				empire = 6
				hegemony = 6
			}
			ai_will_do = {
				value = 100
				if = {
					limit = {
						is_tributary = yes
						overlord = { has_realm_law_flag = tributaries_more_likely_to_contribute_to_GPs }
					}
					multiply = 2
				}
			}
		}

		carven_pillars = {
			is_required = no

			contributor_is_valid = { highest_held_title_tier > tier_barony }

			cost = { 
				gold = {
					if = {
						limit = { is_ai = yes }
						value = dwarven_contribution_mid_gold_cost
					}
					else = { value = dwarven_contribution_huge_gold_cost }
				}
				piety = {
					if = {
						limit = { is_ai = yes }
						value = 0
					}
					else = { value = mandala_contribution_huge_piety_cost }
				}
			}

			contributor_cooldown = individual_contribution_cooldown_value

			on_complete = {
				show_as_tooltip = { mandala_contributor_bell_stupas_reward_effect = yes }
			}
			ai_check_interval_by_tier = {							
				barony = 0
				county = 12
				duchy = 12
				kingdom = 6
				empire = 6
				hegemony = 6
			}
			ai_will_do = {
				value = 50
				if = {
					limit = {
						is_tributary = yes
						overlord = { has_realm_law_flag = tributaries_more_likely_to_contribute_to_GPs }
					}
					multiply = 2
				}
			}
		}

		bejeweled_ceilings = {
			is_required = no

			contributor_is_valid = { highest_held_title_tier > tier_barony }

			cost = { 
				gold = dwarven_contribution_mega_gold_cost
				piety = {
					if = {
						limit = { is_ai = yes }
						value = 0
					}
					else = { value = mandala_contribution_mid_piety_cost }
				}
			}

			contributor_cooldown = individual_contribution_cooldown_value

			on_complete = {
				show_as_tooltip = { dwarven_contributor_bejeweled_ceilings_reward_effect = yes }
			}
			ai_check_interval_by_tier = {							
				barony = 0
				county = 12
				duchy = 12
				kingdom = 6
				empire = 6
				hegemony = 6
			}
			ai_will_do = {
				value = 50
				if = {
					limit = {
						is_tributary = yes
						overlord = { has_realm_law_flag = tributaries_more_likely_to_contribute_to_GPs }
					}
					multiply = 2
				}
			}
		}

		palatial_complex = {
			is_required = no

			is_shown = {
				trigger_if = {
					limit = {
						NOT = { exists = scope:owner }
					}
					always = yes
				}
				trigger_else = {
					exists = scope:owner.primary_heir
					scope:owner.dynasty ?= { has_dynasty_perk = lotr_khazad_legacy_3 }
				}
			}

			allowed_contributor_filter = {
				owner = yes
			}
			contributor_is_valid = {
				custom_tooltip = {
					text = lotr_khazad_legacy_3_name
					dynasty = { has_dynasty_perk = lotr_khazad_legacy_3 }
				}
			}

			cost = { 
				gold = {
					if = {
						limit = { is_ai = yes }
						value = dwarven_contribution_mid_gold_cost
					}
					else = { value = mandala_contribution_high_gold_cost }
				}
				piety = {
					if = {
						limit = { is_ai = yes }
						value = 0
					}
					else = { value = mandala_contribution_high_piety_cost }
				}
			}

			contributor_cooldown = individual_contribution_cooldown_value

			on_complete = {
				show_as_tooltip = { mandala_contributor_family_temple_complex_reward_effect = yes }
			}
			ai_check_interval_by_tier = {							
				barony = 0
				county = 12
				duchy = 12
				kingdom = 6
				empire = 6
				hegemony = 6
			}
			ai_will_do = {
				value = 50
			}
		}
	}

	ai_target_quick_trigger = {
		adult = yes
		rank = county
	}
	ai_check_interval_by_tier = {							
		barony = 0
		county = 1
		duchy = 1
		kingdom = 1
		empire = 1
		hegemony = 1
	}
	ai_will_do = {
		value = 1000
	}

	completion_sound_effect = @msg_completion_effect_dwarven
}

dwarven_capital_05 = {
	icon = {
		reference = @great_project_dwarven_icon
	}
	illustration = {
		reference = @dwarven_capital_illustration
	}
	name = {
		desc = great_project_type_dwarven_capital_05
	}
	owner = province_owner

	is_important = yes
	is_shown = {
		is_dwarf = yes
		any_held_county = { 
			any_province = {
				has_ruined_great_building = no
				has_building_with_flag = fourth_tier_dwarven_capital_building
				NOT = { has_building_with_flag = final_tier_dwarven_capital_building }
			}
		}
		NOT = { is_planning_great_project = dwarven_capital_05 }
	}

	
	province_filter = top_realm

	is_location_valid = {
		scope:province = {
			has_ruined_great_building = no
			custom_tooltip = {
				text = lotr_great_project_type_dwarven_capital_has_t4_building
				has_building_with_flag = fourth_tier_dwarven_capital_building
			}
		}
	}

	can_start_planning = {
		is_dwarf = yes
		NOR = {
			is_planning_great_project = dwarven_capital_05
			prestige_level < very_high_prestige_level
		}
		legitimacy_level >= 5
		trigger_if = {
			limit = {
				any_character_struggle = {
					involvement = involved
					is_struggle_type = balrog_struggle
				}
			}
			any_character_struggle = {
				involvement = involved
				is_struggle_type = balrog_struggle
				is_struggle_phase = struggle_balrog_phase_slumbering
			}
		}
	}

	cost = {
		gold = {
			value = dwarven_capital_gold_cost
			multiply = 3
		}
	}

	construction_time = great_project_mandala_massive_construction_time

	contributor_cooldown = standard_contributor_cooldown_value 

	on_plan_build = {
		scope:owner = {
			#Memory
			create_character_memory = {
				type = started_planning_dwarven_capital_memory
				participants = { founder = scope:owner }
			}
			scope:new_memory ?= {
				set_variable = {
					name = dwarven_capital_planned_location
					value = scope:province
				}
				set_variable = {
					name = final_tier_dwarven_capital
					value = flag:yes
				}
				if = {
					limit = { 
						exists = var:dwarven_capital_planned_location
						exists = var:final_tier_dwarven_capital
					}
					#To prevent 'unused except in loc' errors :catto:
				}
			}
		}
	}

	on_complete = { 
		scope:province = {
			upgrade_dwarven_great_building_effect = yes
		}
		scope:owner = {
			#Owner rewards
			show_as_tooltip = { mandala_owner_reward_01_effect = yes }
		}
		#Tally the rewards
		scope:great_project ?= {
			#Rite of Mahal
			determine_if_contributed_and_save_scope_effect = { CONTRIBUTION = rite_of_mahal }
			#Marble Foundation
			determine_if_contributed_and_save_scope_effect = { CONTRIBUTION = marble_foundation }
			#Waterways
			determine_if_contributed_and_save_scope_effect = { CONTRIBUTION = waterways }
			#Work Force
			determine_if_contributed_and_save_scope_effect = { CONTRIBUTION = work_force }
			#Bejeweled Reliefs
			determine_if_contributed_and_save_scope_effect = { CONTRIBUTION = bejeweled_reliefs }
			#Pillar Forest
			determine_if_contributed_and_save_scope_effect = { CONTRIBUTION = pillar_forest }
			#Dwarf-Father's Palace
			determine_if_contributed_and_save_scope_effect = { CONTRIBUTION = dwarf_father_palace }
		}
		#Dole out some rewards!
		gather_contributors_in_list_effect = yes
		every_in_list = {
			list = contributors_to_reward
			if = {
				limit = { this = scope:owner }
				trigger_event = lotr_great_project.1000
			}
			else = {
				if = {
					limit = { 
						scope:owner = { is_ai = yes }
					}
					show_as_tooltip = { 
						mandala_contributor_opinion_reward_effect = { OVERLORD = scope:owner }
					}
				}
				trigger_event = lotr_great_project.1010
			}
		}
	}

	on_cancel = {
		scope:owner = {
			add_prestige = minor_prestige_loss
		}
		every_contribution = {
			limit = {
				contribution_is_funded = yes
			}
			contributor = {
				if = {
					limit = {
						this != scope:owner
						this != scope:founder
					}
					add_to_list = contributors_to_disappoint	
				}
			}
		}
		every_in_list = {
			list = contributors_to_disappoint
			add_opinion = {
				modifier = wasted_our_efforts
				target = scope:owner
				opinion = -30
			}
		}
	}

	on_start_build = { 
		scope:owner = {
			add_legitimacy_effect = { LEGITIMACY = minor_legitimacy_gain }
		}
		scope:great_project = {
			every_contribution = {
				limit = {
					contribution_is_funded = yes
				}
				contributor = {
					add_prestige = minor_prestige_value 
				}	
			}
		}
	}

	allowed_contributor_filter = {
		owner = yes
		tributaries = yes
		vassals = yes
	}

	project_contributions = {
		rite_of_mahal = {
			allowed_contributor_filter = {
				owner = yes
			}
			contributor_is_valid = { 
				dwarven_fourth_tier_trigger = yes
			}

			cost = { }

			contributor_cooldown = individual_contribution_cooldown_value

			on_complete = {
				show_as_tooltip = { mandala_contributor_medium_rite_reward_effect = yes }
			}
			ai_check_interval_by_tier = {							
				barony = 0
				county = 3
				duchy = 3
				kingdom = 3
				empire = 3
				hegemony = 3
			}
			ai_will_do = {
				value = 1000
			}
		}

		marble_foundation = {
			contributor_is_valid = { highest_held_title_tier > tier_barony }

			cost = { 
				gold = {
					if = {
						limit = { is_ai = yes }
						value = dwarven_contribution_high_gold_cost
					}
					else = { value = dwarven_contribution_mega_gold_cost }
				}
			}

			contributor_cooldown = individual_contribution_cooldown_value

			on_complete = {
				show_as_tooltip = { mandala_contributor_marble_foundation_reward_effect = yes }
			}
			ai_check_interval_by_tier = {							
				barony = 0
				county = 12
				duchy = 12
				kingdom = 6
				empire = 6
				hegemony = 6
			}
			ai_will_do = {
				value = 100
				if = {
					limit = {
						is_tributary = yes
						overlord = { has_realm_law_flag = tributaries_more_likely_to_contribute_to_GPs }
					}
					multiply = 2
				}
			}
		}

		waterways = {
			contributor_is_valid = { highest_held_title_tier > tier_barony }

			cost = { 
				gold = {
					if = {
						limit = { is_ai = yes }
						value = dwarven_contribution_high_gold_cost
					}
					else = { value = dwarven_contribution_mega_gold_cost }
				}
				piety = {
					if = {
						limit = { is_ai = yes }
						value = mandala_contribution_high_piety_cost
					}
					else = { value = mandala_contribution_mega_piety_cost }
				}
			}

			contributor_cooldown = individual_contribution_cooldown_value

			on_complete = {
				show_as_tooltip = { dwarven_contributor_waterways_reward_effect = yes }
			}
			ai_check_interval_by_tier = {							
				barony = 0
				county = 12
				duchy = 12
				kingdom = 6
				empire = 6
				hegemony = 6
			}
			ai_will_do = {
				value = 100
				if = {
					limit = {
						is_tributary = yes
						overlord = { has_realm_law_flag = tributaries_more_likely_to_contribute_to_GPs }
					}
					multiply = 2
				}
			}
		}

		work_force = {
			contributor_is_valid = { highest_held_title_tier > tier_barony }

			cost = { 
				piety = {
					if = {
						limit = { is_ai = yes }
						value = mandala_contribution_high_piety_cost
					}
					else = { value = mandala_contribution_mega_piety_cost }
				}
			}

			contributor_cooldown = individual_contribution_cooldown_value

			on_complete = {
				show_as_tooltip = { mandala_contributor_work_force_reward_effect = yes }
			}
			ai_check_interval_by_tier = {							
				barony = 0
				county = 12
				duchy = 12
				kingdom = 6
				empire = 6
				hegemony = 6
			}
			ai_will_do = {
				value = 100
				if = {
					limit = {
						is_tributary = yes
						overlord = { has_realm_law_flag = tributaries_more_likely_to_contribute_to_GPs }
					}
					multiply = 2
				}
			}
		}

		bejeweled_reliefs = {
			is_required = no

			contributor_is_valid = { highest_held_title_tier > tier_barony }

			cost = { 
				gold = {
					if = {
						limit = { is_ai = yes }
						value = dwarven_contribution_high_gold_cost
					}
					else = { value = dwarven_contribution_mega_gold_cost }
				}
				piety = {
					if = {
						limit = { is_ai = yes }
						value = mandala_contribution_low_piety_cost
					}
					else = { value = mandala_contribution_mid_piety_cost }
				}
			}

			contributor_cooldown = individual_contribution_cooldown_value

			on_complete = {
				show_as_tooltip = { mandala_contributor_bejeweled_reliefs_reward_effect = yes }
			}
			ai_check_interval_by_tier = {							
				barony = 0
				county = 12
				duchy = 12
				kingdom = 6
				empire = 6
				hegemony = 6
			}
			ai_will_do = {
				value = 50
				if = {
					limit = {
						is_tributary = yes
						overlord = { has_realm_law_flag = tributaries_more_likely_to_contribute_to_GPs }
					}
					multiply = 2
				}
			}
		}

		pillar_forest = {
			is_required = no

			contributor_is_valid = { highest_held_title_tier > tier_barony }

			cost = { 
				gold = {
					if = {
						limit = { is_ai = yes }
						value = dwarven_contribution_high_gold_cost
					}
					else = { 
						value = dwarven_contribution_mega_gold_cost
						multiply = 1.5
						#Rounds up to the closest number divisible by 5
						divide = 5
						ceiling = yes
						multiply = 5
					}
				}
				piety = {
					if = {
						limit = { is_ai = yes }
						value = mandala_contribution_high_piety_cost
					}
					else = { value = mandala_contribution_mega_piety_cost }
				}
			}

			contributor_cooldown = individual_contribution_cooldown_value

			on_complete = {
				show_as_tooltip = { dwarven_contributor_pillar_forest_reward_effect = yes }
			}
			ai_check_interval_by_tier = {							
				barony = 0
				county = 12
				duchy = 12
				kingdom = 6
				empire = 6
				hegemony = 6
			}
			ai_will_do = {
				value = 50
				if = {
					limit = {
						is_tributary = yes
						overlord = { has_realm_law_flag = tributaries_more_likely_to_contribute_to_GPs }
					}
					multiply = 2
				}
			}
		}

		dwarf_father_palace = {
			is_required = no

			is_shown = {
				trigger_if = {
					limit = {
						NOT = { exists = scope:owner }
					}
					always = yes
				}
				trigger_else = {
					exists = scope:owner.primary_heir
					scope:owner.dynasty ?= { has_dynasty_perk = lotr_khazad_legacy_3 }
				}
			}

			allowed_contributor_filter = {
				owner = yes
			}
			contributor_is_valid = {
				custom_tooltip = {
					text = lotr_khazad_legacy_3_name
					dynasty = { has_dynasty_perk = lotr_khazad_legacy_3 }
				}
			}

			cost = { 
				gold = {
					if = {
						limit = { is_ai = yes }
						value = dwarven_contribution_high_gold_cost
					}
					else = { value = dwarven_contribution_mega_gold_cost }
				}
				piety = {
					if = {
						limit = { is_ai = yes }
						value = mandala_contribution_high_piety_cost
					}
					else = { value = mandala_contribution_mega_piety_cost }
				}
			}

			contributor_cooldown = individual_contribution_cooldown_value

			on_complete = {
				show_as_tooltip = { dwarven_contributor_dwarf_father_palace_reward_effect = yes }
			}
			ai_check_interval_by_tier = {							
				barony = 0
				county = 12
				duchy = 12
				kingdom = 6
				empire = 6
				hegemony = 6
			}
			ai_will_do = {
				value = 50
			}
		}
	}

	ai_target_quick_trigger = {
		adult = yes
		rank = county
	}
	ai_check_interval_by_tier = {							
		barony = 0
		county = 1
		duchy = 1
		kingdom = 1
		empire = 1
		hegemony = 1
	}
	ai_will_do = {
		value = 1000
	}

	completion_sound_effect = @msg_completion_effect_dwarven
}

### Build a Fleet ~ by Aerien
construct_great_fleet = {
	icon = {
		reference = @lotr_build_fleet_icon 
	}
	illustration = {
		reference = @lotr_build_fleet_illustration 
	}

	name = {
		desc = great_project_type_construct_great_fleet
	}
	
	is_important = yes
	
 	is_shown = {
		highest_held_title_tier >= tier_duchy
		OR = {
			is_good_undying = yes 
			is_human = yes 
		}
		any_sub_realm_county = {
			is_coastal_county = yes
		}
		NOR = {
			is_planning_great_project = construct_great_fleet
			custom_tooltip = {
				text = only_single_great_project_type_allowed
				any_great_project = {
					great_project_type = construct_great_fleet
				}
			}
		}
		NOT = {
			any_sub_realm_county = {
				has_county_modifier = great_fleet_constructed_modifier
			}
		}
	}

	can_start_planning = {
		is_independent_ruler = yes
	}
	
	is_valid = {
		scope:province.county.holder.top_liege ?= scope:owner
	}
	
	province_filter = realm
	
	is_location_valid = {
		scope:province = {
			custom_tooltip = {
				text = great_project_type_construct_great_fleet_coastal_county
				is_coastal = yes 
				barony = { is_capital_barony = yes }
			}
			# custom_tooltip = {
				# text = great_project_type_construct_great_fleet_does_not_already_have_fleet_port
				# NOT = {
					# has_building = lotr_great_fleet_01 # you can overwrite duchy buildings, but there's no point in doing it to the same one
				# }
			# }
			# trigger_if = {
				# limit = {
					# barony.county.holder = {
						# is_ai = no
					# }
				# }
				# NOT = {
					# has_building_with_flag = duchy_building
				# }		
				# custom_tooltip = {
					# text = great_project_type_construct_great_barracks_do_not_override_player_building
				# }
			# }
		}
	}

	cost = {
		treasury_or_gold = {
			value = great_project_base_starting_cost
			multiply = 2.5
		}
	}

	construction_time = {
		value = great_project_base_construction_time
		multiply = common_great_project_construction_time_multiplier_value
	}

	allowed_contributor_filter = {
		owner = yes
		vassals = yes
	}

	contributor_cooldown = standard_contributor_cooldown_value
	
	on_start_build = {}
	
	on_complete = {
		custom_tooltip = {
			text = great_project_type_construct_great_fleet_province_gains_great_fleet_modifier
			scope:province.county ?= {
				add_county_modifier = {
					modifier = great_fleet_constructed_modifier 
				}
			}
		}
		custom_tooltip = {
			text = great_project_type_construct_great_fleet_province_gains_great_fleet_building
			scope:province ?= {
				add_great_building = lotr_great_fleet_01
			}
		}
		# if = {
			# limit = {
				# NOT = {
					# scope:province ?= {
						# has_building_with_flag = duchy_building
					# }
				# }
			# }
			# custom_tooltip = {
				# text = great_project_type_construct_great_fleet_province_gains_great_fleet
				# scope:province ?= {
					# add_building = lotr_great_fleet_01
				# }
			# }
		# }
		# else = {
			# custom_tooltip = {
				# text = project_great_barracks_replace_tt
				# scope:province ?= {
					# replace_building_effect = lotr_great_fleet_01
				# }
			# }
		# }
		great_project_notify_completion = { CHARACTER = scope:owner }

		show_as_tooltip = {
			scope:founder.top_liege ?= { # because the real owner doesn't exist in the effect preview
				send_interface_toast = {
					type = event_generic_neutral_text
					title = great_project_completed_msg_t
					left_icon = scope:owner
					right_icon = scope:province.county
					desc = great_project_completed_msg_desc
					if = {
						limit = { is_valid_for_legitimacy_change = yes }
						add_legitimacy = {
							value = medium_legitimacy_gain
						}
					}
					dynasty = { add_dynasty_prestige = 500 }
					if = { # LotR - Elves gain hope
						limit = { is_good_undying = yes }
						add_elven_hope_effect = { VALUE = massive_elven_hope_gain HOPE_EFFECT = effect_elven_hope_great_project_completed }
					}
				}
			}		
		}
		hidden_effect = {
			scope:owner ?= {
				send_interface_toast = {
					type = event_generic_neutral_text
					title = great_project_completed_msg_t
					left_icon = scope:owner
					right_icon = scope:province.county
					desc = great_project_completed_msg_desc
					if = {
						limit = { is_valid_for_legitimacy_change = yes }
						add_legitimacy = {
							value = medium_legitimacy_gain
						}
					}
					dynasty = { add_dynasty_prestige = 500 }
					if = { # LotR - Elves gain hope
						limit = { is_good_undying = yes }
						add_elven_hope_effect = { VALUE = massive_elven_hope_gain HOPE_EFFECT = effect_elven_hope_great_project_completed }
					}
				}
			}
		}
	}
	
	on_cancel = {}

	# Top liege pays with the treasury, while vassals may pitch in with gold
	project_contributions = {
		materials = {
			cost = {
				treasury_or_gold = {
					value = great_project_base_contribution_cost
					multiply = 2
				}
			}

			contributor_cooldown = individual_contribution_cooldown_value
			
			is_required = yes

			on_complete = {
				great_project_reward_contribution_completion_notification_effect = {
					LEVEL = minor
					NON_OWNER_REWARD_EFFECT = great_project_reward_contribution_completion_null
					OWNER_REWARD_EFFECT = great_project_reward_contribution_completion_null
				}
			}
			on_contribution_funded = {
				great_project_notify_contribution = yes
				great_project_contribution_catalyst_effect = yes
			}

			ai_check_interval_by_tier = {							
				barony = 0
				county = 12
				duchy = 9
				kingdom = 6
				empire = 6
				hegemony = 6
			}
			ai_will_do = {
				value = chinese_great_projects_contribution_ai_will_do_base_value
			}
		}
		workforce = {
			cost = {
				treasury_or_gold = {
					value = great_project_base_contribution_cost
					multiply = 2
				}
			}

			contributor_cooldown = individual_contribution_cooldown_value
			
			is_required = yes

			on_complete = {
				great_project_reward_contribution_completion_notification_effect = {
					LEVEL = minor
					NON_OWNER_REWARD_EFFECT = great_project_reward_contribution_completion_null
					OWNER_REWARD_EFFECT = great_project_reward_contribution_completion_null
				}
			}
			on_contribution_funded = {
				great_project_notify_contribution = yes
				great_project_contribution_catalyst_effect = yes
			}

			ai_check_interval_by_tier = {							
				barony = 0
				county = 12
				duchy = 9
				kingdom = 6
				empire = 6
				hegemony = 6
			}
			ai_will_do = {
				value = chinese_great_projects_contribution_ai_will_do_base_value
			}
		}
		engineers = {
			cost = {
				treasury_or_gold = {
					value = great_project_base_contribution_cost
					multiply = 1.5
				}
			}

			contributor_cooldown = individual_contribution_cooldown_value
			
			is_required = no

			on_complete = {
				great_project_reward_contribution_completion_notification_effect = {
					LEVEL = major
					NON_OWNER_REWARD_EFFECT = great_project_reward_contribution_completion_null
					OWNER_REWARD_EFFECT = great_project_reward_contribution_completion_null
				}
				custom_tooltip = {
					text = great_project_type_construct_great_fleet_province_gains_engineers_modifier
					scope:province.county ?= {
						add_county_modifier = {
							modifier = lotr_build_great_fleet_engineers_modifier 
						}
					}
				}
			}
			on_contribution_funded = {
				great_project_notify_contribution = yes
				great_project_contribution_catalyst_effect = yes
			}

			ai_check_interval_by_tier = {							
				barony = 0
				county = 12
				duchy = 9
				kingdom = 6
				empire = 6
				hegemony = 6
			}
			ai_will_do = {
				value = chinese_great_projects_contribution_ai_will_do_base_value
			}
		}
		military_wharf = {
			cost = {
				treasury_or_gold = {
					value = great_project_base_contribution_cost
					multiply = 1.5
				}
			}

			contributor_cooldown = individual_contribution_cooldown_value
			
			is_required = no

			on_complete = {
				great_project_reward_contribution_completion_notification_effect = {
					LEVEL = major
					NON_OWNER_REWARD_EFFECT = great_project_reward_contribution_completion_null
					OWNER_REWARD_EFFECT = great_project_reward_contribution_completion_null
				}
				custom_tooltip = {
					text = great_project_type_construct_great_fleet_province_gains_military_wharf_modifier
					scope:province ?= {
						add_province_modifier = {
							modifier = lotr_build_great_fleet_military_wharf_modifier 
						}
					}
				}
			}
			on_contribution_funded = {
				great_project_notify_contribution = yes
				great_project_contribution_catalyst_effect = yes
			}

			ai_check_interval_by_tier = {							
				barony = 0
				county = 12
				duchy = 9
				kingdom = 6
				empire = 6
				hegemony = 6
			}
			ai_will_do = {
				value = chinese_great_projects_contribution_ai_will_do_base_value
			}
		}
		merchant_quays = {
			cost = {
				treasury_or_gold = {
					value = great_project_base_contribution_cost
					multiply = 1.5
				}
			}

			contributor_cooldown = individual_contribution_cooldown_value
			
			is_required = no

			on_complete = {
				great_project_reward_contribution_completion_notification_effect = {
					LEVEL = major
					NON_OWNER_REWARD_EFFECT = great_project_reward_contribution_completion_null
					OWNER_REWARD_EFFECT = great_project_reward_contribution_completion_null
				}
				custom_tooltip = {
					text = great_project_type_construct_great_fleet_province_gains_merchant_quays_modifier
					scope:province.county ?= {
						add_county_modifier = {
							modifier = lotr_build_great_fleet_merchant_quays_modifier 
						}
					}
				}
			}
			on_contribution_funded = {
				great_project_notify_contribution = yes
				great_project_contribution_catalyst_effect = yes
			}

			ai_check_interval_by_tier = {							
				barony = 0
				county = 12
				duchy = 9
				kingdom = 6
				empire = 6
				hegemony = 6
			}
			ai_will_do = {
				value = chinese_great_projects_contribution_ai_will_do_base_value
			}
		}
	}

	ai_target_quick_trigger = {
		adult = yes
	}
	ai_check_interval_by_tier = {							
		barony = 0
		county = 0
		duchy = 0
		kingdom = 0
		empire = 0
		hegemony = 6
	}
	ai_will_do = {
		value = 500
		if = {
			limit = {
				is_at_war = yes
			}
			multiply = 0
		}
	}

	completion_sound_effect = @msg_completion_effect_generic
}

### Mend the Realm ~ by Aerien
mend_the_realm = {
	icon = {
		reference = @lotr_mend_realm_icon 
	}
	illustration = {
		reference = @lotr_mend_realm_illustration 
	}

	name = {
		desc = great_project_type_mend_the_realm
	}
	
	is_important = yes
	
 	is_shown = {
		highest_held_title_tier >= tier_duchy
		is_elf = yes
		NOR = {
			is_planning_great_project = mend_the_realm
			custom_tooltip = {
				text = only_single_great_project_type_allowed
				any_great_project = {
					great_project_type = mend_the_realm
				}
			}
		}
		NOT = {
			any_realm_county = {
				has_county_modifier = realm_mended_modifier
			}
		}
	}

	can_start_planning = {
		#is_independent_ruler = yes
	}
	
	is_valid = {
		#scope:province.county.holder.top_liege ?= scope:owner
	}
	
	province_filter = realm
	
	is_location_valid = {
		scope:province = {
			has_holding_type = elven_holding
		}
	}

	cost = {
		treasury_or_gold = {
			value = great_project_base_starting_cost
		}
		piety = {
			value = 500 
		}
		prestige = {
			value = 500 
		}
	}

	construction_time = {
		value = great_project_mandala_increased_construction_time # 10 years
		#multiply = common_great_project_construction_time_multiplier_value
	}

	allowed_contributor_filter = {
		owner = yes
		vassals = yes
		liege = yes 
		top_liege = yes
	}

	contributor_cooldown = standard_contributor_cooldown_value
	
	on_start_build = {}
	
	on_complete = {
		custom_tooltip = {
			text = great_project_type_mend_realm_province_gains_mend_realm_modifier
			scope:province.county ?= {
				add_county_modifier = {
					modifier = realm_mended_modifier 
					years = 25 
				}
			}
		}
		great_project_notify_completion = { CHARACTER = scope:owner }

		show_as_tooltip = {
			scope:founder.top_liege ?= { # because the real owner doesn't exist in the effect preview
				send_interface_toast = {
					type = event_generic_neutral_text
					title = great_project_completed_msg_t
					left_icon = scope:owner
					right_icon = scope:province.county
					desc = great_project_completed_msg_desc
					if = {
						limit = { is_valid_for_legitimacy_change = yes }
						add_legitimacy = {
							value = medium_legitimacy_gain
						}
					}
					dynasty = { add_dynasty_prestige = 500 }
					if = { # LotR - Elves gain hope
						limit = { is_good_undying = yes }
						add_elven_hope_effect = { VALUE = monstrous_elven_hope_value HOPE_EFFECT = effect_elven_hope_great_project_completed }
					}
				}
			}		
		}
		hidden_effect = {
			scope:owner ?= {
				send_interface_toast = {
					type = event_generic_neutral_text
					title = great_project_completed_msg_t
					left_icon = scope:owner
					right_icon = scope:province.county
					desc = great_project_completed_msg_desc
					if = {
						limit = { is_valid_for_legitimacy_change = yes }
						add_legitimacy = {
							value = medium_legitimacy_gain
						}
					}
					dynasty = { add_dynasty_prestige = 500 }
					if = { # LotR - Elves gain hope
						limit = { is_good_undying = yes }
						add_elven_hope_effect = { VALUE = monstrous_elven_hope_value HOPE_EFFECT = effect_elven_hope_great_project_completed }
					}
				}
			}
		}
	}
	
	on_cancel = {}

	# Top liege pays with the treasury, while vassals may pitch in with gold
	project_contributions = {
		provisions = {
			cost = {
				treasury_or_gold = {
					value = great_project_base_contribution_cost
					multiply = 2
				}
			}

			contributor_cooldown = individual_contribution_cooldown_value
			
			is_required = yes

			on_complete = {
				great_project_reward_contribution_completion_notification_effect = {
					LEVEL = minor
					NON_OWNER_REWARD_EFFECT = great_project_reward_contribution_completion_null
					OWNER_REWARD_EFFECT = great_project_reward_contribution_completion_null
				}
			}
			on_contribution_funded = {
				great_project_notify_contribution = yes
				great_project_contribution_catalyst_effect = yes
			}

			ai_check_interval_by_tier = {							
				barony = 0
				county = 12
				duchy = 9
				kingdom = 6
				empire = 6
				hegemony = 6
			}
			ai_will_do = {
				value = chinese_great_projects_contribution_ai_will_do_base_value
			}
		}
		messengers = {
			cost = {
				prestige = {
					value = 500 
				}
			}

			contributor_cooldown = individual_contribution_cooldown_value
			
			is_required = yes

			on_complete = {
				great_project_reward_contribution_completion_notification_effect = {
					LEVEL = minor
					NON_OWNER_REWARD_EFFECT = great_project_reward_contribution_completion_null
					OWNER_REWARD_EFFECT = great_project_reward_contribution_completion_null
				}
			}
			on_contribution_funded = {
				great_project_notify_contribution = yes
				great_project_contribution_catalyst_effect = yes
			}

			ai_check_interval_by_tier = {							
				barony = 0
				county = 12
				duchy = 9
				kingdom = 6
				empire = 6
				hegemony = 6
			}
			ai_will_do = {
				value = chinese_great_projects_contribution_ai_will_do_base_value
			}
		}
		encouragement = {
			cost = {
				piety = {
					value = 500 
				}
			}

			contributor_cooldown = individual_contribution_cooldown_value
			
			is_required = yes

			on_complete = {
				great_project_reward_contribution_completion_notification_effect = {
					LEVEL = minor
					NON_OWNER_REWARD_EFFECT = great_project_reward_contribution_completion_null
					OWNER_REWARD_EFFECT = great_project_reward_contribution_completion_null
				}
			}
			on_contribution_funded = {
				great_project_notify_contribution = yes
				great_project_contribution_catalyst_effect = yes
			}

			ai_check_interval_by_tier = {							
				barony = 0
				county = 12
				duchy = 9
				kingdom = 6
				empire = 6
				hegemony = 6
			}
			ai_will_do = {
				value = chinese_great_projects_contribution_ai_will_do_base_value
			}
		}
		train_guards = {
			cost = {
				treasury_or_gold = {
					value = great_project_base_contribution_cost
					multiply = 4
				}
			}

			contributor_cooldown = individual_contribution_cooldown_value
			
			is_required = no

			on_complete = {
				great_project_reward_contribution_completion_notification_effect = {
					LEVEL = major
					NON_OWNER_REWARD_EFFECT = great_project_reward_contribution_completion_null
					OWNER_REWARD_EFFECT = great_project_reward_contribution_completion_null
				}
				custom_tooltip = {
					text = great_project_type_mend_the_realm_province_gains_military_modifier
					scope:province ?= {
						add_province_modifier = {
							modifier = lotr_mend_realm_military_modifier 
							years = 25
						}
					}
				}
			}
			on_contribution_funded = {
				great_project_notify_contribution = yes
				great_project_contribution_catalyst_effect = yes
			}

			ai_check_interval_by_tier = {							
				barony = 0
				county = 12
				duchy = 9
				kingdom = 6
				empire = 6
				hegemony = 6
			}
			ai_will_do = {
				value = chinese_great_projects_contribution_ai_will_do_base_value
			}
		}
		festival_fair = {
			cost = {
				prestige = {
					value = 1000
				}
			}

			contributor_cooldown = individual_contribution_cooldown_value
			
			is_required = no

			on_complete = {
				great_project_reward_contribution_completion_notification_effect = {
					LEVEL = major
					NON_OWNER_REWARD_EFFECT = great_project_reward_contribution_completion_null
					OWNER_REWARD_EFFECT = great_project_reward_contribution_completion_null
				}
				custom_tooltip = {
					text = great_project_type_mend_the_realm_province_gains_economic_modifier
					scope:province ?= {
						add_province_modifier = {
							modifier = lotr_mend_realm_economic_modifier 
							years = 25
						}
					}
				}
			}
			on_contribution_funded = {
				great_project_notify_contribution = yes
				great_project_contribution_catalyst_effect = yes
			}

			ai_check_interval_by_tier = {							
				barony = 0
				county = 12
				duchy = 9
				kingdom = 6
				empire = 6
				hegemony = 6
			}
			ai_will_do = {
				value = chinese_great_projects_contribution_ai_will_do_base_value
			}
		}
		gardeners = {
			cost = {
				piety = {
					value = 1000
				}
			}

			contributor_cooldown = individual_contribution_cooldown_value
			
			is_required = no

			on_complete = {
				great_project_reward_contribution_completion_notification_effect = {
					LEVEL = major
					NON_OWNER_REWARD_EFFECT = great_project_reward_contribution_completion_null
					OWNER_REWARD_EFFECT = great_project_reward_contribution_completion_null
				}
				show_as_tooltip = {
					scope:founder.top_liege = {
						add_character_modifier = { 
							modifier = lotr_mend_realm_spiritual_modifier
							years = 25
						}
					}
				}
				hidden_effect = {
					scope:owner ?= {
						add_character_modifier = { 
							modifier = lotr_mend_realm_spiritual_modifier
							years = 25
						}
					}
				}
			}
			on_contribution_funded = {
				great_project_notify_contribution = yes
				great_project_contribution_catalyst_effect = yes
			}

			ai_check_interval_by_tier = {							
				barony = 0
				county = 12
				duchy = 9
				kingdom = 6
				empire = 6
				hegemony = 6
			}
			ai_will_do = {
				value = chinese_great_projects_contribution_ai_will_do_base_value
			}
		}
	}

	ai_target_quick_trigger = {
		adult = yes
	}
	ai_check_interval_by_tier = {							
		barony = 0
		county = 0
		duchy = 0
		kingdom = 0
		empire = 0
		hegemony = 6
	}
	ai_will_do = {
		value = 500
		if = {
			limit = {
				is_at_war = yes
			}
			multiply = 0
		}
	}

	completion_sound_effect = @msg_completion_effect_generic
}
