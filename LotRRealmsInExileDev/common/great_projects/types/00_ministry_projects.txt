##################################################
# GREAT PROJECTS FOR CHINESE MINISTERS
#
# Grand Campaign - Minister of War
# Sinicize Area - Minister of Rites
# Develop Communities - Minister of Works
# Establish Control - Minister of Rites
##################################################

@msg_completion_effect_generic = "event:/DLC/EP4/SFX/Stingers/China/tgp_mx_sting_finishing_great_project_generic"

@great_project_china_icon = "gfx/interface/icons/great_projects/city_china.dds"
@great_project_default_icon = "gfx/interface/icons/great_projects/_default.dds"
@great_project_campaign_icon = "gfx/interface/icons/court_position_types/grand_guardian_court_position.dds"
@great_project_sinicize_icon = "gfx/interface/icons/court_position_types/minister_bureaucrat_court_position.dds"
@great_project_control_icon = "gfx/interface/icons/icon_game_concept_house_realm_county_control.dds"
@great_project_compel_religious_uniformity_icon = "gfx/interface/icons/court_position_types/court_guru_court_position.dds"

@default_illustration = "gfx/interface/illustrations/great_projects/asia_great_project_default.dds"
@city_china_illustration = "gfx/interface/illustrations/holding_types/tgp_city_china.dds"
@castle_china_illustration = "gfx/interface/illustrations/holding_types/tgp_castle_china.dds"
@sinicize_illustration = "gfx/interface/illustrations/event_story/tgp_dynastic_cycle_stability.dds"
@camp_asia_illustration = "gfx/interface/illustrations/event_scenes/tgp_camp_asia.dds"
@develop_communities_default = "gfx/interface/illustrations/event_scenes/ep3_medi_market.dds"
@compel_religious_uniformity_illustration = "gfx/interface/illustrations/holding_types/tgp_chinese_pagoda.dds"


# Grand Campaign
grand_campaign_project = {
	icon = {
		reference = @great_project_campaign_icon
	}
	illustration = {
		reference = @camp_asia_illustration
	}

	name = {
		desc = great_project_type_grand_campaign_project
	}

	is_important = yes
	is_shown = {
		always = no #LotR
		has_tgp_dlc_trigger = yes
		OR = {
			# has_title = title:h_china #LotR
			# has_title = title:e_minister_grand_marshal
			AND = {
				is_diarch_of_target = top_liege
				top_liege = {
					has_diarchy_type = grand_secretariat
				}
			}
		}
	}
	province_filter = top_liege_border_outer
	owner = founder_top_liege_title_owner

	can_start_planning = {
		#there can only be one Grand Campaign!
		NOR = {
			is_planning_great_project = grand_campaign_project
			custom_tooltip = {
				text = only_single_great_project_type_allowed
				any_great_project = {
					great_project_type = grand_campaign_project
				}
			}
		}
		# If you are the hegemon, you must have a grand marshal appointed
		# trigger_if = { #LotR
		# 	limit = {
		# 		has_title = title:h_china
		# 	}
		# 	custom_tooltip = {
		# 		text = you_have_a_grand_marshal_desc
		# 		exists = cp:minister_grand_marshal
		# 	}
		# }
	}

	is_location_valid = {
		trigger_if = {
			limit = {
				scope:province.kingdom ?= {
					any_in_de_jure_hierarchy = {
						tier = tier_duchy
						holder ?= {
							top_overlord != root.top_overlord
						}
					}
				}
			}
			scope:province.kingdom = {
				any_in_de_jure_hierarchy = {
					tier = tier_duchy
					holder ?= {
						top_overlord != root.top_overlord
					}
				}
			}
		}
		trigger_else = {
			# have at least one valid duchy to attack
			scope:province.county.holder.top_liege = {
				NOT = {
					is_tributary_of = root.top_liege
				}
			}
		}
	}

	cost = {
		influence = {
			value = major_influence_value
			# if = { #LotR
			# 	limit = {
			# 		has_title = title:h_china
			# 	}
			# 	multiply = 2
			# }
		}
		treasury_or_gold = {
			value = great_project_base_starting_cost
			# if = {
			# 	limit = {
			# 		has_title = title:h_china
			# 	}
			# 	multiply = 2
			# }
		}
	}

	construction_time = {
		value = great_project_base_construction_time
		multiply = 5 #25 years
	}

	contributor_cooldown = standard_contributor_cooldown_value
	contribution_threshold = 80

	is_valid = { 
		# exists = title:h_china  #LotR
	}

	on_plan_build = {
		# title:h_china = { #LotR
		title:k_wastelands = {
			set_variable = {
				name = num_of_grand_campaign_projects
				value = {
					add = 1
					if = {
						limit = { exists = var:num_of_grand_campaign_projects }
						add = var:num_of_grand_campaign_projects
					}
				}
			}
		}
	    save_scope_as = grand_campaign_project
	    # Target chosen location's kingdom - this will determine the war targets later and success or failure of the project
	    great_project_location.kingdom = {
	    	# Pick every duchy that has a count or higher that is not under owner's (Emperor of China's) control
            every_in_de_jure_hierarchy = {
           		limit = {
					tier >= tier_county
					tier <= tier_duchy
               		trigger_if = {
               			limit = {
               				exists = holder
               			}
               			holder.top_overlord != scope:owner
	            	}
	            }
	            duchy = {
		            add_to_list = duchies_to_attack
	            }
            }
            save_scope_as = target
	    }
		set_variable = {
			name = grand_campaign_target_kingdom
			value = scope:target
		}
		set_duchies_to_attack_effect = yes
	}

	on_start_build = {
	}
	on_complete = {
		show_as_tooltip = {
			scope:great_project.var:grand_campaign_war ?= {
				end_war = attacker
			}
		}		
		custom_tooltip = grand_campaign_won_tt
		custom_tooltip = grand_campaign_lost_tt
		hidden_effect = {
			every_contribution = {
				limit = {
					contribution_is_funded = yes
				}
				contributor = {
					add_to_list = all_contributors
					remove_character_modifier = tgp_joined_grand_campaign_modifier
					if = {
						limit = {
							prev = {
								contribution_id = attack_1
							}
						}
						save_scope_as = war_leader
					}
				}
			}
			every_in_list = {
				variable = grand_campaign_targets
				if = {
					limit = {
						holder.top_overlord = scope:owner
					}
					add_to_list = titles_won
				}
				else = {
					add_to_list = titles_lost
				}
			}
			scope:owner = {
				trigger_event = tgp_china_ministry.0005
			}
			every_contribution = {
				contributor = {
					trigger_event = tgp_china_ministry.0008
				}
			}
		}
	}

	on_cancel = {
		every_contribution = {
			limit = {
				contribution_is_funded = yes
			}
			contributor = {
				trigger_event = tgp_china_ministry.0006
			}
		}
	}

	allowed_contributor_filter = {
		owner = yes
		vassals = yes
	}

	project_contributions = {
		attack_1 = {
			is_shown = {
				always = yes #it's the mandatory contribution
			}
			contributor_is_valid = {
				has_title = title:e_minister_grand_marshal
			}

			cost = { treasury_or_gold = great_project_base_contribution_cost }

			contributor_cooldown = individual_contribution_cooldown_value

			on_contribution_funded = {
				grand_campaign_contribution_effect = {
					TITLE = attack_1
				}
			}
			on_complete = {
				grand_campaign_contribution_complete_effect = yes
			}
			ai_will_do = {
				value = 1000
			}
			ai_check_interval_by_tier = {
				barony = 0
				county = 24
				duchy = 6
				kingdom = 6
				empire = 6
				hegemony = 0
			}
		}
		attack_2 = {
			is_shown = {
				scope:great_project ?= {
					exists = var:attack_2
				}
			}
			contributor_is_valid = {
				grand_campaign_valid_contributor_trigger = { ID = 2 }
			}
			is_required = no
			cost = { treasury_or_gold = great_project_base_contribution_cost }

			contributor_cooldown = individual_contribution_cooldown_value

			on_contribution_funded = {
				grand_campaign_contribution_effect = {
					TITLE = attack_2
				}
			}
			on_complete = {
				grand_campaign_contribution_complete_effect = yes
			}
			ai_will_do = {
				value = contribute_to_grand_campaign_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 24
				duchy = 6
				kingdom = 6
				empire = 6
				hegemony = 0
			}
		}
		attack_3 = {
			is_shown = {
				scope:great_project ?= {
					exists = var:attack_3
				}
			}
			contributor_is_valid = {
				grand_campaign_valid_contributor_trigger = { ID = 3 }	
			}
			is_required = no

			cost = { treasury_or_gold = great_project_base_contribution_cost }

			contributor_cooldown = individual_contribution_cooldown_value

			on_contribution_funded = {
				grand_campaign_contribution_effect = {
					TITLE = attack_3
				}
			}
			on_complete = {
				grand_campaign_contribution_complete_effect = yes
			}
			ai_will_do = {
				value = contribute_to_grand_campaign_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 24
				duchy = 6
				kingdom = 6
				empire = 6
				hegemony = 0
			}
		}
		attack_4 = {
			is_shown = {
				scope:great_project ?= {
					exists = var:attack_4
				}
			}
			show_in_planning_phase = no
			contributor_is_valid = {
				grand_campaign_valid_contributor_trigger = { ID = 4 }
			}
			is_required = no

			cost = { treasury_or_gold = great_project_base_contribution_cost }

			contributor_cooldown = individual_contribution_cooldown_value

			on_contribution_funded = {
				grand_campaign_contribution_effect = {
					TITLE = attack_4
				}
			}
			on_complete = {
				grand_campaign_contribution_complete_effect = yes
			}
			ai_will_do = {
				value = contribute_to_grand_campaign_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 24
				duchy = 6
				kingdom = 6
				empire = 6
				hegemony = 0
			}
		}
		attack_5 = {
			is_shown = {
				scope:great_project ?= {
					exists = var:attack_5
				}
			}
			show_in_planning_phase = no
			contributor_is_valid = {
				grand_campaign_valid_contributor_trigger = { ID = 5 }
			}
			is_required = no

			cost = { treasury_or_gold = great_project_base_contribution_cost }

			contributor_cooldown = individual_contribution_cooldown_value

			on_contribution_funded = {
				grand_campaign_contribution_effect = {
					TITLE = attack_5
				}
			}
			on_complete = {
				grand_campaign_contribution_complete_effect = yes
			}
			ai_will_do = {
				value = contribute_to_grand_campaign_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 24
				duchy = 6
				kingdom = 6
				empire = 6
				hegemony = 0
			}
		}
		attack_6 = {
			is_shown = {
				scope:great_project ?= {
					exists = var:attack_6
				}
			}
			show_in_planning_phase = no
			contributor_is_valid = {
				grand_campaign_valid_contributor_trigger = { ID = 6 }
			}
			is_required = no

			cost = { treasury_or_gold = great_project_base_contribution_cost }

			contributor_cooldown = individual_contribution_cooldown_value

			on_contribution_funded = {
				grand_campaign_contribution_effect = {
					TITLE = attack_6
				}
			}
			on_complete = {
				grand_campaign_contribution_complete_effect = yes
			}
			ai_will_do = {
				value = contribute_to_grand_campaign_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 24
				duchy = 6
				kingdom = 6
				empire = 6
				hegemony = 0
			}
		}
		attack_7 = {
			is_shown = {
				scope:great_project ?= {
					exists = var:attack_7
				}
			}
			show_in_planning_phase = no
			contributor_is_valid = {
				grand_campaign_valid_contributor_trigger = { ID = 7 }	
			}
			is_required = no

			cost = { treasury_or_gold = great_project_base_contribution_cost }

			contributor_cooldown = individual_contribution_cooldown_value

			on_contribution_funded = {
				grand_campaign_contribution_effect = {
					TITLE = attack_7
				}
			}
			on_complete = {
				grand_campaign_contribution_complete_effect = yes
			}
			ai_will_do = {
				value = contribute_to_grand_campaign_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 24
				duchy = 6
				kingdom = 6
				empire = 6
				hegemony = 0
			}
		}
		attack_8 = {
			is_shown = {
				scope:great_project ?= {
					exists = var:attack_8
				}
			}
			show_in_planning_phase = no
			contributor_is_valid = {
				grand_campaign_valid_contributor_trigger = { ID = 8 }	
			}
			is_required = no

			cost = { treasury_or_gold = great_project_base_contribution_cost }

			contributor_cooldown = individual_contribution_cooldown_value

			on_contribution_funded = {
				grand_campaign_contribution_effect = {
					TITLE = attack_8
				}
			}
			on_complete = {
				grand_campaign_contribution_complete_effect = yes
			}
			ai_will_do = {
				value = contribute_to_grand_campaign_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 24
				duchy = 6
				kingdom = 6
				empire = 6
				hegemony = 0
			}
		}
		attack_9 = {
			is_shown = {
				scope:great_project ?= {
					exists = var:attack_9
				}
			}
			show_in_planning_phase = no
			contributor_is_valid = {
				grand_campaign_valid_contributor_trigger = { ID = 9 }
			}
			is_required = no

			cost = { treasury_or_gold = great_project_base_contribution_cost }

			contributor_cooldown = individual_contribution_cooldown_value

			on_contribution_funded = {
				grand_campaign_contribution_effect = {
					TITLE = attack_9
				}
			}
			on_complete = {
				grand_campaign_contribution_complete_effect = yes
			}
			ai_will_do = {
				value = contribute_to_grand_campaign_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 24
				duchy = 6
				kingdom = 6
				empire = 6
				hegemony = 0
			}
		}
		attack_10 = {
			is_shown = {
				scope:great_project ?= {
					exists = var:attack_10
				}
			}
			show_in_planning_phase = no
			contributor_is_valid = {
				grand_campaign_valid_contributor_trigger = { ID = 10 }
			}
			is_required = no

			cost = { treasury_or_gold = great_project_base_contribution_cost }

			contributor_cooldown = individual_contribution_cooldown_value

			on_contribution_funded = {
				grand_campaign_contribution_effect = {
					TITLE = attack_10
				}
			}
			on_complete = {
				grand_campaign_contribution_complete_effect = yes
			}
			ai_will_do = {
				value = contribute_to_grand_campaign_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 24
				duchy = 6
				kingdom = 6
				empire = 6
				hegemony = 0
			}
		}
		attack_11 = {
			is_shown = {
				scope:great_project ?= {
					exists = var:attack_11
				}
			}
			show_in_planning_phase = no
			contributor_is_valid = {
				grand_campaign_valid_contributor_trigger = { ID = 11 }
			}
			is_required = no

			cost = { treasury_or_gold = great_project_base_contribution_cost }

			contributor_cooldown = individual_contribution_cooldown_value

			on_contribution_funded = {
				grand_campaign_contribution_effect = {
					TITLE = attack_11
				}
			}
			on_complete = {
				grand_campaign_contribution_complete_effect = yes
			}
			ai_will_do = {
				value = contribute_to_grand_campaign_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 24
				duchy = 6
				kingdom = 6
				empire = 6
				hegemony = 0
			}
		}
		attack_12 = {
			is_shown = {
				scope:great_project ?= {
					exists = var:attack_12
				}
			}
			show_in_planning_phase = no
			contributor_is_valid = {
				grand_campaign_valid_contributor_trigger = { ID = 12 }
			}
			is_required = no

			cost = { treasury_or_gold = great_project_base_contribution_cost }

			contributor_cooldown = individual_contribution_cooldown_value

			on_contribution_funded = {
				grand_campaign_contribution_effect = {
					TITLE = attack_12
				}
			}
			on_complete = {
				grand_campaign_contribution_complete_effect = yes
			}
			ai_will_do = {
				value = contribute_to_grand_campaign_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 24
				duchy = 6
				kingdom = 6
				empire = 6
				hegemony = 0
			}
		}
		attack_13 = {
			is_shown = {
				scope:great_project ?= {
					exists = var:attack_13
				}
			}
			show_in_planning_phase = no
			contributor_is_valid = {
				grand_campaign_valid_contributor_trigger = { ID = 13 }
			}
			is_required = no

			cost = { treasury_or_gold = great_project_base_contribution_cost }

			contributor_cooldown = individual_contribution_cooldown_value

			on_contribution_funded = {
				grand_campaign_contribution_effect = {
					TITLE = attack_13
				}
			}
			on_complete = {
				grand_campaign_contribution_complete_effect = yes
			}
			ai_will_do = {
				value = contribute_to_grand_campaign_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 24
				duchy = 6
				kingdom = 6
				empire = 6
				hegemony = 0
			}
		}
		attack_14 = {
			is_shown = {
				scope:great_project ?= {
					exists = var:attack_14
				}
			}
			show_in_planning_phase = no
			contributor_is_valid = {
				grand_campaign_valid_contributor_trigger = { ID = 14 }
			}
			is_required = no

			cost = { treasury_or_gold = great_project_base_contribution_cost }

			contributor_cooldown = individual_contribution_cooldown_value

			on_contribution_funded = {
				grand_campaign_contribution_effect = {
					TITLE = attack_14
				}
			}
			on_complete = {
				grand_campaign_contribution_complete_effect = yes
			}
			ai_will_do = {
				value = contribute_to_grand_campaign_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 24
				duchy = 6
				kingdom = 6
				empire = 6
				hegemony = 0
			}
		}
		attack_15 = {
			is_shown = {
				scope:great_project ?= {
					exists = var:attack_15
				}
			}
			show_in_planning_phase = no
			contributor_is_valid = {
				grand_campaign_valid_contributor_trigger = { ID = 15 }
			}
			is_required = no

			cost = { treasury_or_gold = great_project_base_contribution_cost }

			contributor_cooldown = individual_contribution_cooldown_value

			on_contribution_funded = {
				grand_campaign_contribution_effect = {
					TITLE = attack_15
				}
			}
			on_complete = {
				grand_campaign_contribution_complete_effect = yes
			}
			ai_will_do = {
				value = contribute_to_grand_campaign_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 24
				duchy = 6
				kingdom = 6
				empire = 6
				hegemony = 0
			}
		}
		attack_16 = {
			is_shown = {
				scope:great_project ?= {
					exists = var:attack_16
				}
			}
			show_in_planning_phase = no
			contributor_is_valid = {
				grand_campaign_valid_contributor_trigger = { ID = 16 }
			}
			is_required = no

			cost = { treasury_or_gold = great_project_base_contribution_cost }

			contributor_cooldown = individual_contribution_cooldown_value

			on_contribution_funded = {
				grand_campaign_contribution_effect = {
					TITLE = attack_16
				}
			}
			on_complete = {
				grand_campaign_contribution_complete_effect = yes
			}
			ai_will_do = {
				value = contribute_to_grand_campaign_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 24
				duchy = 6
				kingdom = 6
				empire = 6
				hegemony = 0
			}
		}
		attack_17 = {
			is_shown = {
				scope:great_project ?= {
					exists = var:attack_17
				}
			}
			show_in_planning_phase = no
			contributor_is_valid = {
				grand_campaign_valid_contributor_trigger = { ID = 17 }
			}
			is_required = no

			cost = { treasury_or_gold = great_project_base_contribution_cost }

			contributor_cooldown = individual_contribution_cooldown_value

			on_contribution_funded = {
				grand_campaign_contribution_effect = {
					TITLE = attack_17
				}
			}
			on_complete = {
				grand_campaign_contribution_complete_effect = yes
			}
			ai_will_do = {
				value = contribute_to_grand_campaign_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 24
				duchy = 6
				kingdom = 6
				empire = 6
				hegemony = 0
			}
		}
		attack_18 = {
			is_shown = {
				scope:great_project ?= {
					exists = var:attack_18
				}
			}
			show_in_planning_phase = no
			contributor_is_valid = {
				grand_campaign_valid_contributor_trigger = { ID = 18 }
			}
			is_required = no

			cost = { treasury_or_gold = great_project_base_contribution_cost }

			contributor_cooldown = individual_contribution_cooldown_value

			on_contribution_funded = {
				grand_campaign_contribution_effect = {
					TITLE = attack_18
				}
			}
			on_complete = {
				grand_campaign_contribution_complete_effect = yes
			}
			ai_will_do = {
				value = contribute_to_grand_campaign_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 24
				duchy = 6
				kingdom = 6
				empire = 6
				hegemony = 0
			}
		}
		attack_19 = {
			is_shown = {
				scope:great_project ?= {
					exists = var:attack_19
				}
			}
			show_in_planning_phase = no
			contributor_is_valid = {
				grand_campaign_valid_contributor_trigger = { ID = 19 }
			}
			is_required = no

			cost = { treasury_or_gold = great_project_base_contribution_cost }

			contributor_cooldown = individual_contribution_cooldown_value

			on_contribution_funded = {
				grand_campaign_contribution_effect = {
					TITLE = attack_19
				}
			}
			on_complete = {
				grand_campaign_contribution_complete_effect = yes
			}
			ai_will_do = {
				value = contribute_to_grand_campaign_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 24
				duchy = 6
				kingdom = 6
				empire = 6
				hegemony = 0
			}
		}
		attack_20 = {
			is_shown = {
				scope:great_project ?= {
					exists = var:attack_20
				}
			}
			show_in_planning_phase = no
			contributor_is_valid = {
				grand_campaign_valid_contributor_trigger = { ID = 20 }
			}
			is_required = no

			cost = { treasury_or_gold = great_project_base_contribution_cost }

			contributor_cooldown = individual_contribution_cooldown_value

			on_contribution_funded = {
				grand_campaign_contribution_effect = {
					TITLE = attack_20
				}
			}
			on_complete = {
				grand_campaign_contribution_complete_effect = yes
			}
			ai_will_do = {
				value = contribute_to_grand_campaign_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 24
				duchy = 6
				kingdom = 6
				empire = 6
				hegemony = 0
			}
		}
	}

	ai_will_do = {
		value = 10
		# if = { #LotR
		# 	limit = {
		# 		title:h_china.holder.hegemon_favored_stability_phase_value < 0
		# 	}
		# 	add = 50
		# }
		if = {
			limit = {
				situation:dynastic_cycle ?= {
					OR = {
						situation_current_phase = situation_dynastic_cycle_phase_stability_expansion
						situation_current_phase = situation_dynastic_cycle_phase_instability_conquest
					}
				}
			}
			add = 250
		}
		if = {
			limit = {
				is_at_war = yes
			}
			multiply = 0
		}
	}

	ai_check_interval_by_tier = {
		barony = 0
		county = 0
		duchy = 0
		kingdom = 0
		empire = 24
		hegemony = 24
	}

	ai_target_quick_trigger = {
		adult = yes
		rank = empire
	}

	completion_sound_effect = @msg_completion_effect_generic
}

# Sinicize Area
minister_project_culture = {
	icon = {
		reference = @great_project_sinicize_icon
	}
	illustration = {
		reference = @sinicize_illustration
	}

	name = {
		first_valid = {
			#triggered_desc = { #LotR
			#	trigger = {
			#		title:h_china = {
			#			culture = { has_cultural_pillar = heritage_chinese }
			#		}
			#	}
			#	desc = minister_project_culture_name_chinese
			#}
			desc = minister_project_culture_name_default
		}
	}
	
	is_shown = {
		has_tgp_dlc_trigger = yes
		# You are the hegemon or the relevant minister
		OR = {
			# has_title = title:h_china #LotR
			# has_title = title:e_minister_of_rites #LotR
			AND = {
				is_diarch_of_target = top_liege
				top_liege = {
					has_diarchy_type = grand_secretariat
				}
			}
		}
		trigger_if = { # The AI should not plan more of these projects than there are valid characters to start them
			limit = {
				is_ai = yes
			}
			NOT = {
				any_great_project = {
					count >= 2
					great_project_type = minister_project_culture
				}
			}
		}
	}
	
	province_filter = top_realm

	can_start_planning = {
		# You/your liege/the minister have not already planned this project
		trigger_if = {
			limit = { # When in the advancement phase, we allow everyone with access to do this simultaneously
				situation:dynastic_cycle ?= {
					situation_current_phase = situation_dynastic_cycle_phase_stability_advancement
				}
			}
			NOT = { is_planning_great_project = minister_project_culture }
		}
		trigger_else = { # Otherwise, only a single project at a time
			NOR = {
				is_planning_great_project = minister_project_culture
				custom_tooltip = {
					text = only_single_great_project_type_allowed
					any_great_project = {
						great_project_type = minister_project_culture
					}
				}
			}
		}
		# If you are the hegemon, you must have a minister of works appointed
		# trigger_if = { #LotR
		# 	limit = {
		# 		has_title = title:h_china
		# 	}
		# 	custom_tooltip = {
		# 		text = you_have_a_minister_of_rites_desc
		# 		exists = cp:councillor_court_chaplain
		# 	}
		# }
	}
	
	is_location_valid = {
		scope:province = {
			county = {
				custom_tooltip = {
					text = not_same_culture_as_top_liege_desc
					culture != root.top_liege.culture
				}
			}
			root.top_liege = {
				completely_controls = scope:province.duchy
			}
			custom_tooltip = {
				text = GREAT_PROJECT_CAN_PLAN
				NOT = {
					duchy = {
						any_in_de_jure_hierarchy = {
							tier = tier_barony
							title_province = {
								any_great_project_in_province = {
									great_project_type = minister_project_culture
								}
							}
						}
					}
				}
			}
		}
		trigger_if = {
			limit = {
				scope:founder = {
					is_ai = yes
				}
			}
			scope:province.county.culture = {
				NOT = {
					has_same_culture_heritage = root.top_liege.culture
				}
			}
		}
	}

	is_valid = {
		always = no #LotR
		# scope:owner = { # even when started by a minister, the owner is still the Huangdi; if another realm takes the land, this should invalidate
		# 	has_title = title:h_china
		# }
	}
	
	cost = {
		treasury_or_gold = {
			value = great_project_base_starting_cost
			multiply = 0.2
			if = {
				limit = {
					is_councillor = yes
				}
				multiply = 0.5
			}
		}
	}

	construction_time = {
		value = great_project_base_construction_time
		multiply = 7
		scope:great_project = {
			if = {
				limit = {
					has_variable = project_founded_by_minister
				}
				multiply = 0.75
			}
			every_contribution = {
				limit = {
					NOT = { contribution_id = cultural_liason }
					contribution_is_funded = yes
				}
				subtract = 365
			}
		}
		multiply = common_great_project_construction_time_multiplier_value
	}

	contributor_cooldown = standard_contributor_cooldown_value

	allowed_contributor_filter = {
		owner = yes
		vassals = yes
		top_liege = yes
	}
	
	on_plan_build = {
		scope:founder ?= {
			if = {
				limit = {
					is_councillor = yes
				}
				root = { set_variable = project_founded_by_minister }
			}
		}
	}

	on_start_build = {
	}

	on_complete = {
		situation:dynastic_cycle = {
			if = {
				limit = {
					situation_top_has_catalyst = catalyst_minister_project_culture
				}
				trigger_situation_catalyst = {
					catalyst = catalyst_minister_project_culture
					character = scope:founder
				}
			}
		}
		if = {
			limit = {
				scope:founder = scope:founder.top_liege
				tgp_has_access_to_ministry_trigger = yes
			}
			custom_tooltip = minister_project_cost_desc
		}
		if = {
			limit = {
				NOT = { exists = scope:province }
			}
			custom_tooltip = minister_project_culture_effect_desc
		}
		scope:owner ?= {
			send_interface_toast = {
				type = event_generic_neutral_text
				title = great_project_completed_msg_t
				left_icon = scope:owner
				right_icon = scope:province.county
				desc = great_project_completed_msg_desc
			}
		}
		scope:province ?= {
			duchy = {
				every_de_jure_county = {
					# Change culture or increase cultural acceptance
					if = {
						limit = {
							culture = {
								NOT = { has_same_culture_heritage = scope:owner.top_liege.culture }
							}
						}
						set_county_culture = scope:owner.top_liege.culture
					}
					else_if = {
						limit = {
							culture = {
								this != scope:owner.top_liege.culture
								NOT = { is_in_list = culture_gaining_acceptance }
							}
						}
						culture = {
							add_to_list = culture_gaining_acceptance # So you only increase it once per culture
							change_cultural_acceptance = {
								target = scope:owner.top_liege.culture
								value = {
									value = 2
									if = {
										limit = {
											scope:great_project ?= { has_variable = project_founded_by_minister }
										}
										multiply = 2
									}
								}
								desc = cultural_acceptance_gain_minister_project
							}
						}
					}
					# Tribal rulers become admin
					if = {
						limit = {
							holder ?= {
								OR = {
									government_has_flag = government_is_tribal
									government_has_flag = government_is_nomadic
									government_has_flag = government_is_herder
								}
								NOT = { is_in_list = feudalized_rulers }
							}
						}
						holder = {
							change_to_administrative_effect = yes
							add_to_list = feudalized_rulers # To prevent effect from potentially showing multiple times
						}
					}
					# Tribal holdings are feudalized
					if = {
						limit = {
							title_province = {
								OR = {
									has_holding_type = tribal_holding
									has_holding_type = nomad_holding
									has_holding_type = herder_holding
								}
							}
						}
						title_province = {
							set_holding_type = castle_holding
						}
					}
				}
			}
		}
		scope:founder ?= {
			if = {
				limit = {
					tgp_is_any_minister = yes
					is_alive = yes # this is actually necessary, because they remain the scope character and accessible even after death
				}
				change_influence = minister_influence_gain_value
			}
		}
	}
	
	project_contributions = {
		cultural_liason = {
			contributor_is_valid = {
			}

			cost = {
				treasury_or_gold = {
					value = great_project_base_contribution_cost
					multiply = 0.5
				}
			}

			contributor_cooldown = individual_contribution_cooldown_value
			
			is_required = yes

			on_complete = {
				great_project_reward_contribution_completion_notification_effect = {
					LEVEL = major
					NON_OWNER_REWARD_EFFECT = great_project_reward_contribution_completion_null
					OWNER_REWARD_EFFECT = great_project_reward_contribution_completion_null
				}
			}
			on_contribution_funded = {
				great_project_notify_contribution = yes
				great_project_contribution_catalyst_effect = yes
			}
			ai_will_do = {
				value = chinese_great_projects_contribution_ai_will_do_base_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 18
				duchy = 12
				kingdom = 6
				empire = 3
				hegemony = 3
			}
		}
		send_inhabitants = {
			contributor_is_valid = {
				culture = top_liege.culture
			}

			cost = {
				treasury_or_gold = {
					value = great_project_base_contribution_cost
					multiply = 0.25
				}
			}

			contributor_cooldown = 0
			
			is_required = no

			on_contribution_funded = {
				custom_tooltip = great_project_construction_time_is_reduced_desc
				if = {
					limit = {
						this != scope:owner
						this != scope:founder						
					}
					scope:owner ?= {
						send_interface_toast = {
							type = event_generic_good_with_text
							title = great_project_contributed_msg_t
							desc = great_project_contributed_msg_desc
							left_icon = root
							right_icon = scope:great_project.great_project_location.county
						}			
					}
				}
			}

			on_complete = {
				send_interface_toast = {
					title = great_project_contribution_msg_t
					left_icon = root
					right_icon = scope:great_project.great_project_location.duchy
					
					if = {
						limit = {
							has_trait = governor
						}
						increase_governance_effect = { VALUE = 10 }
					}
					else_if = {
						limit = {
							government_has_flag = government_has_influence
						}
						change_influence = monumental_influence_gain
					}
					else = {
						add_prestige = major_prestige_gain
					}
				}
			}
			
			ai_will_do = {
				value = chinese_great_projects_contribution_ai_will_do_base_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 18
				duchy = 12
				kingdom = 6
				empire = 3
				hegemony = 3
			}
		}
		send_inhabitants_2 = {
			contributor_is_valid = {
				culture = top_liege.culture
			}
			show_in_planning_phase = no

			cost = {
				treasury_or_gold = {
					value = great_project_base_contribution_cost
					multiply = 0.25
				}
			}

			contributor_cooldown = 0
			
			is_required = no

			on_contribution_funded = {
				custom_tooltip = great_project_construction_time_is_reduced_desc
				if = {
					limit = {
						this != scope:owner
						this != scope:founder						
					}
					scope:owner ?= {
						send_interface_toast = {
							type = event_generic_good_with_text
							title = great_project_contributed_msg_t
							desc = great_project_contributed_msg_desc
							left_icon = root
							right_icon = scope:great_project.great_project_location.county
						}			
					}
				}
			}

			on_complete = {
				send_interface_toast = {
					title = great_project_contribution_msg_t
					left_icon = root
					right_icon = scope:great_project.great_project_location.duchy
					
					if = {
						limit = {
							has_trait = governor
						}
						increase_governance_effect = { VALUE = 10 }
					}
					else_if = {
						limit = {
							government_has_flag = government_has_influence
						}
						change_influence = monumental_influence_gain
					}
					else = {
						add_prestige = major_prestige_gain
					}
				}
			}
			
			ai_will_do = {
				value = chinese_great_projects_contribution_ai_will_do_base_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 18
				duchy = 12
				kingdom = 6
				empire = 3
				hegemony = 3
			}
		}
		send_inhabitants_3 = {
			contributor_is_valid = {
				culture = top_liege.culture
			}
			show_in_planning_phase = no

			cost = {
				treasury_or_gold = {
					value = great_project_base_contribution_cost
					multiply = 0.25
				}
			}

			contributor_cooldown = 0
			
			is_required = no

			on_contribution_funded = {
				custom_tooltip = great_project_construction_time_is_reduced_desc
				if = {
					limit = {
						this != scope:owner
						this != scope:founder						
					}
					scope:owner ?= {
						send_interface_toast = {
							type = event_generic_good_with_text
							title = great_project_contributed_msg_t
							desc = great_project_contributed_msg_desc
							left_icon = root
							right_icon = scope:great_project.great_project_location.county
						}			
					}
				}
			}
			
			on_complete = {
				send_interface_toast = {
					title = great_project_contribution_msg_t
					left_icon = root
					right_icon = scope:great_project.great_project_location.duchy
					
					if = {
						limit = {
							has_trait = governor
						}
						increase_governance_effect = { VALUE = 10 }
					}
					else_if = {
						limit = {
							government_has_flag = government_has_influence
						}
						change_influence = monumental_influence_gain
					}
					else = {
						add_prestige = major_prestige_gain
					}
				}
			}
			
			ai_will_do = {
				value = chinese_great_projects_contribution_ai_will_do_base_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 18
				duchy = 12
				kingdom = 6
				empire = 3
				hegemony = 3
			}
		}
	}
	
	ai_will_do = {
		value = 100
		
		if = {
			limit = {
				situation:dynastic_cycle ?= {
					situation_current_phase = situation_dynastic_cycle_phase_stability_advancement
				}
			}
			add = 400
		}
		if = {
			limit = {
				has_trait = diligent
			}
			add = 10
		}
		if = {
			limit = {
				has_trait = arrogant
			}
			add = 5
		}
		if = {
			limit = {
				has_trait = compassionate
			}
			add = -10
		}
		if = {
			limit = {
				has_trait = trusting
			}
			add = -10
		}
		if = {
			limit = {
				culture = {
					NOT = { has_same_culture_heritage = root.top_liege.culture }
				}
			}
			multiply = 0
		}
		if = {
			limit = {
				is_at_war = yes
			}
			multiply = 0
		}
	}

	ai_target_quick_trigger = {
		adult = yes
		rank = empire
	}
	
	ai_check_interval_by_tier = {
		barony = 0
		county = 0
		duchy = 0
		kingdom = 0
		empire = 10
		hegemony = 6
	}

	completion_sound_effect = @msg_completion_effect_generic
}

# Develop Communities
minister_project_development = {
	icon = {
		# trigger = { #LotR
		# 	trigger_if = {
		# 		limit = { exists = scope:province }
		# 		scope:province = {
		# 			OR = {
		# 				geographical_region = world_asia
		# 				geographical_region = world_steppe_east
		# 			}
		# 		}
		# 	}
		# 	trigger_else = {
		# 		scope:founder = {
		# 			capital_province ?= {
		# 				OR = {
		# 					geographical_region = world_asia
		# 					geographical_region = world_steppe_east
		# 				}
		# 			}
		# 		}
		# 	}
		# }
		reference = @great_project_china_icon
	}
	icon = {
		reference = @great_project_default_icon
	}
	illustration = {
		# trigger = { #LotR
		# 	trigger_if = {
		# 		limit = { exists = scope:province }
		# 		scope:province = {
		# 			OR = {
		# 				geographical_region = world_asia
		# 				geographical_region = world_steppe_east
		# 			}
		# 		}
		# 	}
		# 	trigger_else = {
		# 		scope:founder = {
		# 			capital_province ?= {
		# 				OR = {
		# 					geographical_region = world_asia
		# 					geographical_region = world_steppe_east
		# 				}
		# 			}
		# 		}
		# 	}
		# }
		reference = @default_illustration
	}
	illustration = {
		reference = @develop_communities_default
	}

	name = {
		desc = great_project_type_minister_project_development
	}
	
	is_shown = {
		has_tgp_dlc_trigger = yes
		government_allows = administrative
		# You are the hegemon / emperor or the relevant minister / diarch
		OR = {
			this = top_liege
			# has_title = title:e_minister_of_works #LotR
			AND = {
				is_diarch_of_target = top_liege
				top_liege = {
					OR = {
						has_diarchy_type = grand_secretariat
						has_diarchy_type = co_emperorship
					}
				}
			}
		}
	}
	
	province_filter = top_realm

	can_start_planning = {
		# You/your liege/the minister have not already planned this project
		NOT = {
			top_liege = {
				custom_tooltip = {
					text = only_single_great_project_type_allowed
					is_planning_great_project = minister_project_development
				}
			}
		}
		# If you are the hegemon, you must have a minister of works appointed
		# trigger_if = { #LotR
		# 	limit = {
		# 		has_title = title:h_china
		# 	}
		# 	custom_tooltip = {
		# 		text = you_have_a_minister_of_works_desc
		# 		exists = cp:minister_works
		# 	}
		# }
	}
	
	is_location_valid = {
		scope:province = {
			is_county_capital = yes
			root.top_liege = {
				completely_controls = scope:province.duchy
			}
			duchy = {
				title_capital_county = scope:province.county
			}
			custom_tooltip = {
				text = GREAT_PROJECT_CAN_PLAN
				NOT = {
					duchy = {
						any_in_de_jure_hierarchy = {
							tier = tier_barony
							title_province = {
								any_great_project_in_province = {
									great_project_type = minister_project_development
								}
							}
						}
					}
				}
			}
		}
	}

	is_valid = {
	
	}
	
	cost = {
		treasury_or_gold = {
			value = great_project_base_contribution_cost
			multiply = 4
			if = {
				limit = {
					is_councillor = yes
				}
				divide = 2
			}
		}
	}

	construction_time = {
		value = 3650
		scope:great_project = {
			if = {
				limit = {
					has_variable = project_founded_by_minister
				}
				multiply = 0.75
			}
		}
		multiply = common_great_project_construction_time_multiplier_value
	}

	contributor_cooldown = 0

	allowed_contributor_filter = {
		owner = yes
		vassals = yes
		top_liege = yes
	}
	
	on_plan_build = {
		scope:founder ?= {
			if = {
				limit = {
					is_councillor = yes
				}
				root = { set_variable = project_founded_by_minister }
			}
		}
	}

	on_start_build = {
	}

	on_complete = {
		if = {
			limit = {
				scope:founder = scope:founder.top_liege
				tgp_has_access_to_ministry_trigger = yes
			}
			custom_tooltip = minister_project_cost_desc
		}
		if = {
			limit = {
				NOT = { exists = scope:province }
			}
			custom_tooltip = minister_project_development_effect_desc
		}
		save_scope_value_as = {
			name = project_development_value
			value = {
				value = 50
				if = {
					limit = {
						has_variable = project_founded_by_minister
					}
					add = 50
				}
				every_contribution = {
					limit = {
						NOR = {
							contribution_id = personnel
							contribution_id = engineers
						}
						contribution_is_funded = yes
					}
					add = 25
				}
			}
		}
		scope:province ?= {
			duchy = {
				custom_tooltip = minister_project_development_building_desc
				custom_tooltip = minister_project_development_modifier_desc
				hidden_effect = {
					every_de_jure_county = {
						every_county_province = {
							limit = {
								has_holding = yes
							}
							# We set this flag to make the AI want to prioritize economy buildings, which makes the building effect below construct those first and foremost
							barony.holder = {
								add_character_flag = { flag = ai_desire_economy_buildings days = 30 }
							}
							# Add or upgrade a building
							generate_building = yes
						}
						add_county_modifier = {
							modifier = tgp_minister_project_development_modifier
							years = 10
						}
					}
				}
				change_development_progress = scope:project_development_value
			}
		}
		if = {
			limit = {
				has_variable = project_founded_by_minister
			}
			title:e_minister_of_works.holder ?= {
				change_merit = monumental_merit_gain
			}
		}
		scope:founder ?= {
			if = {
				limit = {
					tgp_is_any_minister = yes
					is_alive = yes # this is actually necessary, because they remain the scope character and accessible even after death
				}
				change_influence = minister_influence_gain_value
			}
		}
	}
	
	project_contributions = {
		personnel = {
			cost = {
				treasury_or_gold = great_project_base_contribution_cost
			}

			contributor_cooldown = 0
			
			is_required = yes

			on_complete = {
				if = {
					limit = {
						is_alive = yes
					}
					send_interface_toast = {
						type = event_toast_effect_good
						title = great_project_contribution_msg_t
						left_icon = root
						right_icon = scope:great_project.great_project_location.duchy
						
						if = {
							limit = {
								government_allows = merit
							}
							change_merit = {
								value = monumental_merit_gain
								if = {
									limit = {
										has_title = title:e_minister_of_personnel
									}
									multiply = 2
								}
							}
						}
						else = {
							add_prestige = major_prestige_gain
						}
					}
				}
			}
			on_contribution_funded = {
				great_project_notify_contribution = yes
				great_project_contribution_catalyst_effect = yes
			}
			ai_will_do = {
				value = chinese_great_projects_contribution_ai_will_do_base_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 18
				duchy = 12
				kingdom = 6
				empire = 3
				hegemony = 3
			}
		}
		engineers = {
			cost = {
				treasury_or_gold = great_project_base_contribution_cost
			}

			contributor_cooldown = 0
			
			is_required = yes

			on_complete = {
				if = {
					limit = {
						is_alive = yes
					}
					send_interface_toast = {
						type = event_toast_effect_good
						title = great_project_contribution_msg_t
						left_icon = root
						right_icon = scope:great_project.great_project_location.duchy
						
						change_influence = {
							value = monumental_influence_gain
							if = {
								limit = {
									OR = {
										has_title = title:e_minister_chancellor
										has_title = title:e_minister_censor
									}
								}
								multiply = 2
							}
						}
					}
				}
			}
			on_contribution_funded = {
				great_project_notify_contribution = yes
				great_project_contribution_catalyst_effect = yes
			}
			ai_will_do = {
				value = chinese_great_projects_contribution_ai_will_do_base_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 18
				duchy = 12
				kingdom = 6
				empire = 3
				hegemony = 3
			}
		}
		infrastructure = {
			contributor_is_valid = {
				is_governor = yes
				custom_tooltip = {
					text = great_project_is_near_capital_desc
					capital_province ?= {
						duchy = {
							OR = {
								NOT = { exists = scope:great_project } # safeguard for before the project is planned
								this = scope:great_project.great_project_location.duchy
								any_title_to_title_neighboring_duchy = { this = scope:great_project.great_project_location.duchy }
							}
						}
					}
				}
			}

			cost = {
				treasury_or_gold = {
					value = great_project_base_contribution_cost
					multiply = 2
				}
			}

			contributor_cooldown = 0
			
			is_required = no

			on_contribution_funded = {
				great_project_notify_contribution = yes
				great_project_contribution_catalyst_effect = yes
			}

			on_complete = {
				if = {
					limit = {
						is_alive = yes
					}
					send_interface_toast = {
						type = event_toast_effect_good
						title = great_project_contribution_msg_t
						left_icon = root
						right_icon = scope:great_project.great_project_location.duchy
						
						if = {
							limit = {
								has_trait = governor
							}
							increase_governance_effect = { VALUE = 10 }
						}
						capital_province.county ?= {
							change_development_level = 1
						}
					}
				}
			}
			ai_will_do = {
				value = chinese_great_projects_contribution_ai_will_do_base_value
			}
		}
	}
	
	ai_will_do = {
		value = 30
		
		if = {
			limit = {
				treasury >= 20000
			}
			add = 70
		}
		if = {
			limit = {
				has_trait = diligent
			}
			add = 10
		}
		if = {
			limit = {
				has_trait = just
			}
			add = 5
		}
		if = {
			limit = {
				has_trait = compassionate
			}
			add = -10
		}
		if = {
			limit = {
				has_trait = trusting
			}
			add = -10
		}
		if = {
			limit = {
				culture = {
					NOT = { has_same_culture_heritage = root.top_liege.culture }
				}
			}
			multiply = 0
		}
		if = {
			limit = {
				is_at_war = yes
			}
			multiply = 0
		}
	}

	ai_target_quick_trigger = {
		adult = yes
		rank = empire
	}
	
	ai_check_interval_by_tier = {
		barony = 0
		county = 0
		duchy = 0
		kingdom = 0
		empire = 10
		hegemony = 6
	}

	completion_sound_effect = @msg_completion_effect_generic
}

# Establish Control
minister_project_establish_control = {
	icon = {
		# trigger = { #LotR
		# 	trigger_if = {
		# 		limit = { exists = scope:province }
		# 		scope:province = {
		# 			OR = {
		# 				geographical_region = world_asia
		# 				geographical_region = world_steppe_east
		# 			}
		# 		}
		# 	}
		# 	trigger_else = {
		# 		scope:founder = {
		# 			capital_province ?= {
		# 				OR = {
		# 					geographical_region = world_asia
		# 					geographical_region = world_steppe_east
		# 				}
		# 			}
		# 		}
		# 	}
		# }
		reference = @great_project_control_icon
	}
	icon = {
		reference = @great_project_control_icon
	}
	illustration = {
		reference = @city_china_illustration
	}

	name = {
		desc = great_project_type_minister_project_establish_control
	}

	is_shown = {
		has_tgp_dlc_trigger = yes
		# You are the hegemon or a relevant minister
		OR = {
			has_title = title:h_china
			has_title = title:e_minister_of_justice
			AND = {
				is_diarch_of_target = top_liege
				top_liege = {
					has_diarchy_type = grand_secretariat
				}
			}
		}
	}

	can_start_planning = {
		# You/your liege/the minister have not already planned this project
		trigger_if = {
			limit = { # When in a stable phase, we allow everyone with access to do this simultaneously
				situation:dynastic_cycle ?= {
					OR = {
						situation_current_phase = situation_dynastic_cycle_phase_stability_expansion
						situation_current_phase = situation_dynastic_cycle_phase_stability_advancement
					}
				}
			}
			NOT = { is_planning_great_project = minister_project_establish_control }
		}
		trigger_else = { # Otherwise, only a single project at a time
			NOR = {
				is_planning_great_project = minister_project_establish_control
				custom_tooltip = {
					text = only_single_great_project_type_allowed
					any_great_project = {
						great_project_type = minister_project_establish_control
					}
				}
			}
		}
		# There are valid counties in the realm
		any_realm_county = {
			custom_tooltip = {
				text = has_low_control_or_county_corruption_desc
				OR = {
					has_county_corruption_trigger = yes
					county_control < 100
				}
			}
		}
	}
	
	is_valid = {
		always = no #LotR
		# scope:owner = { # even when started by a minister, the owner is still the Huangdi; if another realm takes the land, this should invalidate #LotR
		# 	has_title = title:h_china
		# }
	}
	
	is_location_valid = {
		scope:province.duchy ?= {
			custom_tooltip = {
				text = has_low_control_or_county_corruption_desc
				any_de_jure_county = {
					OR = {
						has_county_corruption_trigger = yes
						county_control < 100
					}
				}
			}
		}
		scope:province = {
			custom_tooltip = {
				text = GREAT_PROJECT_CAN_PLAN
				NOT = {
					duchy = {
						any_in_de_jure_hierarchy = {
							tier = tier_barony
							title_province = {
								any_great_project_in_province = {
									great_project_type = minister_project_establish_control
								}
							}
						}
					}
				}
			}
		}
	}
	
	province_filter = top_realm
	
	cost = {
		treasury_or_gold = {
			value = great_project_base_starting_cost
			multiply = 2
			if = {
				limit = {
					is_councillor = yes
				}
				divide = 2
			}
		}
	}

	construction_time = {
		value = 1825
		multiply = common_great_project_construction_time_multiplier_value
	}

	contributor_cooldown = 0

	allowed_contributor_filter = {
		owner = yes
		vassals = yes
		tributaries = yes
	}
	
	on_plan_build = {
		scope:founder ?= {
			if = {
				limit = {
					is_councillor = yes
				}
				root = {
					set_variable = {
						name = project_founded_by_minister
						value = {
							value = 0
							add = scope:founder.diplomacy
						}
					}
				}
			}
		}
	}

	on_complete = {
		if = {
			limit = {
				NOT = { exists = scope:province }
			}
			custom_tooltip = minister_project_establish_control_effect_desc
		}
		scope:province.duchy ?= {
			# Inrease local county control (for all counties)
			change_county_control = {
				# Add a base increase
				value = 10
				# If founded by a minister, increase it further based on skills
				if = {
					limit = {
						exists = scope:great_project.var:project_founded_by_minister
					}
					add = {
						value = scope:great_project.var:project_founded_by_minister
						divide = 2
					}
				}
				else_if = { # To show it properly in the tooltip when shown before starting the project
					limit = {
						scope:founder = { is_councillor = yes }
					}
					add = {
						value = 0
						add = scope:founder.diplomacy
						divide = 2
						round = yes
					}
				}
			}
			
			# Speed up de jure drift if we can
			if = {
				limit = { # If we have a holder, who is within the realm, and the duchy is not a de jure part of our top liege's realm
					exists = holder
					holder.top_liege = scope:owner.top_liege
					NOT = { is_ruler_de_jure_liege_or_above = scope:owner.top_liege }
				}
				if = {
					limit = {
						de_jure_drifting_towards = holder.liege.primary_title
					}
					save_scope_as = drifting_title
					holder.liege.primary_title = { save_scope_as = drift_target_title }
				}
				else_if = {
					limit = {
						kingdom = {
							exists = holder
							de_jure_drifting_towards = holder.liege.primary_title
						}
					}
					kingdom = {
						save_scope_as = drifting_title
						holder.liege.primary_title = { save_scope_as = drift_target_title }
					}
				}
				else_if = {
					limit = {
						empire = {
							exists = holder
							de_jure_drifting_towards = holder.liege.primary_title
						}
					}
					empire = {
						save_scope_as = drifting_title
						holder.liege.primary_title = { save_scope_as = drift_target_title }
					}
				}
			}
			if = {
				limit = {
					exists = scope:drifting_title
					exists = scope:drift_target_title
				}
				change_de_jure_drift_progress = {
					target = scope:drift_target_title
					value = {
						value = 100
						if = {
							limit = {
								exists = scope:great_project.var:project_founded_by_minister
							}
							add = {
								value = scope:great_project.var:project_founded_by_minister
								multiply = 2
							}
						}
						else_if = { # To show it properly in the tooltip before starting
							limit = {
								scope:founder = { is_councillor = yes }
							}
							add = {
								value = 0
								add = scope:founder.diplomacy
								multiply = 2
							}
						}
						if = {
							limit = {
								situation:dynastic_cycle ?= { situation_current_phase = situation_dynastic_cycle_phase_stability_advancement }
							}
							add = 30
						}
					}
				}
			}
			
			# Add county modifiers and enable absolute control (we use custom tooltips to format the tooltips better in-game)
			custom_tooltip = minister_project_establish_control_modifier_desc
			custom_tooltip = minister_project_establish_control_holder_desc
			hidden_effect = {
				every_de_jure_county = {
					holder = {
						set_absolute_country_control = yes
					}
					add_county_modifier = {
						modifier = tgp_minister_project_establish_control_modifier
						years = 20
					}
					if = {
						limit = {
							has_county_corruption_trigger = yes
						}
						remove_every_county_corruption_modifier_effect = yes
					}
				}
			}
		}
		scope:founder ?= {
			if = {
				limit = {
					tgp_is_any_minister = yes
					is_alive = yes # this is actually necessary, because they remain the scope character and accessible even after death
				}
				change_influence = minister_influence_gain_value
			}
		}
	}

	project_contributions = {
		city_guards = {
			contributor_is_valid = {
				OR = {
					# has_title = title:h_china #LotR
					# has_title = title:e_minister_of_rites #LotR
					AND = {
						is_diarch_of_target = top_liege
						top_liege = {
							has_diarchy_type = grand_secretariat
						}
					}
					is_governor = yes
				}
			}

			cost = {
				treasury_or_gold = great_project_base_contribution_cost
			}

			contributor_cooldown = 0
			
			is_required = yes

			on_complete = {
				if = {
					limit = {
						is_alive = yes
					}
					send_interface_toast = {
						type = event_toast_effect_good
						title = great_project_contribution_msg_t
						left_icon = root
						right_icon = scope:great_project.great_project_location.duchy
						
						if = {
							limit = {
								government_allows = merit
							}
							change_merit = {
								value = monumental_merit_gain
								if = {
									limit = {
										OR = {
											has_title = title:e_minister_chancellor
											has_title = title:e_minister_censor
											has_title = title:e_minister_of_personnel
										}
									}
									multiply = 2
								}
							}
						}
						else = {
							add_prestige = major_prestige_gain
						}
						if = {
							limit = {
								government_has_flag = government_has_influence
							}
							change_influence = {
								value = monumental_influence_gain
								if = {
									limit = {
										OR = {
											has_title = title:e_minister_chancellor
											has_title = title:e_minister_censor
										}
									}
									multiply = 2
								}
							}
						}
						else = {
							add_prestige = major_prestige_gain
						}
						if = {
							limit = {
								has_trait = governor
							}
							increase_governance_effect = { VALUE = 20 }
						}
					}
				}
			}
			on_contribution_funded = {
				great_project_notify_contribution = yes
				great_project_contribution_catalyst_effect = yes
			}
			ai_will_do = {
				value = chinese_great_projects_contribution_ai_will_do_base_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 18
				duchy = 12
				kingdom = 6
				empire = 3
				hegemony = 3
			}
		}

		highway_patrols = {
			contributor_is_valid = {
				OR = {
					# has_title = title:h_china #LotR
					# has_title = title:e_minister_of_rites #LotR
					AND = {
						is_diarch_of_target = top_liege
						top_liege = {
							has_diarchy_type = grand_secretariat
						}
					}
					custom_tooltip = {
						text = is_a_military_governor_desc
						vassal_contract_has_flag = celestial_military_appointment
					}
				}
			}

			cost = {
				treasury_or_gold = great_project_base_contribution_cost
			}

			contributor_cooldown = 0
			
			is_required = yes

			on_complete = {
				if = {
					limit = {
						is_alive = yes
					}
					send_interface_toast = {
						type = event_toast_effect_good
						title = great_project_contribution_msg_t
						left_icon = root
						right_icon = scope:great_project.great_project_location.duchy
						
						if = {
							limit = {
								government_allows = merit
								this != top_liege
							}
							change_merit = {
								value = monumental_merit_gain
								# if = { #LotR
								# 	limit = {
								# 		OR = {
								# 			has_title = title:e_minister_chancellor
								# 			has_title = title:e_minister_censor
								# 			has_title = title:e_minister_of_war
								# 			has_title = title:e_minister_grand_marshal
								# 		}
								# 	}
								# 	multiply = 2
								# }
							}
						}
						else = {
							add_prestige = major_prestige_gain
						}
						if = {
							limit = {
								has_trait = organizer
							}
							add_trait_xp = {
								trait = organizer
								value = 15
							}
						}
						add_martial_lifestyle_xp = major_lifestyle_xp
					}
				}
			}
			on_contribution_funded = {
				great_project_notify_contribution = yes
				great_project_contribution_catalyst_effect = yes
			}
			ai_will_do = {
				value = chinese_great_projects_contribution_ai_will_do_base_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 18
				duchy = 12
				kingdom = 6
				empire = 3
				hegemony = 3
			}
		}

		administrators = {
			contributor_is_valid = {
			}

			cost = {
				treasury_or_gold = great_project_base_contribution_cost
			}

			contributor_cooldown = 0
			
			is_required = yes

			on_complete = {
				if = {
					limit = {
						is_alive = yes
					}
					send_interface_toast = {
						type = event_toast_effect_good
						title = great_project_contribution_msg_t
						left_icon = root
						right_icon = scope:great_project.great_project_location.duchy
						
						if = {
							limit = {
								government_allows = merit
							}
							change_merit = {
								value = monumental_merit_gain
								if = {
									limit = {
										OR = {
											has_title = title:e_minister_chancellor
											has_title = title:e_minister_of_personnel
											has_title = title:e_minister_of_revenue
											has_title = title:e_minister_of_works
										}
									}
									multiply = 2
								}
							}
						}
						else = {
							add_prestige = major_prestige_gain
						}
						if = {
							limit = {
								has_trait = lifestyle_reveler
							}
							add_trait_xp = {
								trait = lifestyle_reveler
								value = 10
							}
						}
						add_stewardship_lifestyle_xp = major_lifestyle_xp
					}
				}
			}
			on_contribution_funded = {
				great_project_notify_contribution = yes
				great_project_contribution_catalyst_effect = yes
			}
			ai_will_do = {
				value = chinese_great_projects_contribution_ai_will_do_base_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 18
				duchy = 12
				kingdom = 6
				empire = 3
				hegemony = 3
			}
		}

		court_magistrates = {
			contributor_is_valid = {
				OR = {
					# has_title = title:h_china #LotR
					# has_title = title:e_minister_of_rites #LotR
					AND = {
						is_diarch_of_target = top_liege
						top_liege = {
							has_diarchy_type = grand_secretariat
						}
					}
					custom_tooltip = {
						text = is_a_civilian_governor_desc
						vassal_contract_has_flag = celestial_civil_appointment
					}
				}
			}

			cost = {
				treasury_or_gold = great_project_base_contribution_cost
			}

			contributor_cooldown = 0
			
			is_required = yes

			on_complete = {
				if = {
					limit = {
						is_alive = yes
					}
					send_interface_toast = {
						type = event_toast_effect_good
						title = great_project_contribution_msg_t
						left_icon = root
						right_icon = scope:great_project.great_project_location.duchy
						
						if = {
							limit = {
								government_allows = merit
							}
							change_merit = {
								value = major_merit_gain
								if = {
									limit = {
										OR = {
											has_title = title:e_minister_chancellor
											has_title = title:e_minister_of_personnel
											has_title = title:e_minister_of_rites
										}
									}
									multiply = 2
								}
							}
						}
						else = {
							add_prestige = major_prestige_gain
						}
						if = {
							limit = {
								has_trait = confucian_education
							}
							add_trait_xp = {
								trait = confucian_education
								value = 10
							}
						}
						else = {
							add_trait = confucian_education
						}
						add_learning_lifestyle_xp = major_lifestyle_xp
					}
				}
			}
			on_contribution_funded = {
				great_project_notify_contribution = yes
				great_project_contribution_catalyst_effect = yes
			}
			ai_will_do = {
				value = chinese_great_projects_contribution_ai_will_do_base_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 18
				duchy = 12
				kingdom = 6
				empire = 3
				hegemony = 3
			}
		}
	}
	
	ai_will_do = {
		value = 30
		
		if = {
			limit = {
				treasury >= 20000
			}
			add = 70
		}
		if = {
			limit = { has_trait = diligent }
			add = 10
		}
		if = {
			limit = { has_trait = ambitious }
			add = 10
		}
		if = {
			limit = { has_trait = wrathful }
			add = 5
		}
		if = {
			limit = { has_trait = paranoid }
			add = 5
		}
		if = {
			limit = { has_trait = forgiving }
			add = -10
		}
		if = {
			limit = {
				has_trait = lazy
				this != top_liege
			}
			add = -30
		}
		if = {
			limit = {
				culture = {
					NOT = { has_same_culture_heritage = root.top_liege.culture }
				}
			}
			multiply = 0
		}
		if = {
			limit = {
				is_at_war = yes
			}
			multiply = 0
		}
	}

	ai_target_quick_trigger = {
		adult = yes
		rank = empire
	}
	
	ai_check_interval_by_tier = {
		barony = 0
		county = 0
		duchy = 0
		kingdom = 0
		empire = 10
		hegemony = 6
	}

	completion_sound_effect = @msg_completion_effect_generic
}

# Train Troops
minister_project_train_troops = {
	icon = "gfx/interface/icons/celestial_administration_types/icon_game_concept_celestial_military_administration.dds"
	#illustration = { #LotR
	#	trigger = {
	#		trigger_if = {
	#			limit = { exists = scope:province }
	#			scope:province = {
	#				OR = {
	#					geographical_region = world_asia
	#					geographical_region = world_steppe_east
	#				}
	#			}
	#		}
	#		trigger_else = {
	#			scope:founder = {
	#				capital_province ?= {
	#					OR = {
	#						geographical_region = world_asia
	#						geographical_region = world_steppe_east
	#					}
	#				}
	#			}
	#		}
	#	}
	#	reference = "gfx/interface/illustrations/event_scenes/tgp_courtyard_asia.dds"
	#}
	illustration = {
		reference = "gfx/interface/illustrations/event_scenes/ep3_military_tent.dds"
	}

	name = {
		desc = great_project_type_minister_project_train_troops
	}

	is_shown = {
		always = no #LotR
		has_tgp_dlc_trigger = yes
		# You are the hegemon or a relevant minister
		OR = {
			#has_title = title:h_china #LotR
			#has_title = title:e_minister_of_war #LotR
			AND = {
				is_diarch_of_target = top_liege
				top_liege = {
					has_diarchy_type = grand_secretariat
				}
			}
		}
	}

	can_start_planning = {
		# You/your liege/the minister have not already planned this project
		trigger_if = {
			limit = { # When in a stable phase, we allow everyone with access to do this simultaneously
				situation:dynastic_cycle ?= {
					OR = {
						situation_current_phase = situation_dynastic_cycle_phase_stability_expansion
						situation_current_phase = situation_dynastic_cycle_phase_instability_conquest
					}
				}
			}
			NOT = { is_planning_great_project = minister_project_train_troops }
		}
		trigger_else = { # Otherwise, only a single project at a time
			NOR = {
				is_planning_great_project = minister_project_train_troops
				custom_tooltip = {
					text = only_single_great_project_type_allowed
					any_great_project = {
						great_project_type = minister_project_train_troops
					}
				}
			}
		}
		# There are valid counties in the realm
		any_realm_county = {
			any_county_province = {
				has_stationed_regiment = yes
				NOT = { has_province_modifier = tgp_minister_project_train_troops_modifier }
			}
		}
	}
	
	is_valid = {
		#LotR
		#scope:owner = { # even when started by a minister, the owner is still the Huangdi; if another realm takes the land, this should invalidate
		#	has_title = title:h_china
		#}
	}
	
	is_location_valid = {
		scope:province = {
			NOT = { has_province_modifier = tgp_minister_project_train_troops_modifier }
			has_stationed_regiment = yes
			county.holder ?= {
				custom_tooltip = {
				text = holder_has_military_appointment_tt
					OR = {
						vassal_contract_has_flag = celestial_military_appointment
						vassal_contract_has_flag = meritocratic_military_appointment
					}
				}
			}
		}
		scope:province = {
			custom_tooltip = {
				text = GREAT_PROJECT_CAN_PLAN
				NOT = {
					duchy = {
						any_in_de_jure_hierarchy = {
							tier = tier_barony
							title_province = {
								any_great_project_in_province = {
									great_project_type = minister_project_train_troops
								}
							}
						}
					}
				}
			}
		}
	}
	
	province_filter = top_realm
	
	cost = {
		treasury_or_gold = {
			value = great_project_base_starting_cost
			multiply = 2
			if = {
				limit = {
					is_councillor = yes
				}
				divide = 2
			}
		}
	}

	construction_time = {
		value = 1825
		multiply = common_great_project_construction_time_multiplier_value
	}

	contributor_cooldown = 0

	allowed_contributor_filter = {
		owner = yes
		vassals = yes
		tributaries = yes
	}
	
	on_plan_build = {
		scope:founder ?= {
			if = {
				limit = {
					is_councillor = yes
				}
				root = {
					set_variable = {
						name = project_founded_by_minister
						value = {
							value = 0
							add = scope:founder.martial
						}
					}
				}
			}
		}
	}

	on_complete = {
		if = {
			limit = {
				NOT = { exists = scope:province }
			}
			custom_tooltip = minister_project_train_troops_modifier_tt
		}
		situation:dynastic_cycle = {
			if = {
				limit = {
					situation_top_has_catalyst = catalyst_minister_train_troops
				}
				trigger_situation_catalyst = {
					catalyst = catalyst_minister_train_troops
					character = scope:founder
				}
			}
		}
		scope:province.duchy ?= {
			# Inrease local county control (for all counties)
			change_county_control = {
				# Add a base increase
				value = 10
				# If founded by a minister, increase it further based on skills
				if = {
					limit = {
						exists = scope:great_project.var:project_founded_by_minister
					}
					add = {
						value = scope:great_project.var:project_founded_by_minister
						divide = 5
					}
				}
				else_if = { # To show it properly in the tooltip when shown before starting the project
					limit = {
						scope:founder = { is_councillor = yes }
					}
					add = {
						value = 0
						add = scope:founder.martial
						divide = 5
						round = yes
					}
				}
			}
			
			# Add county modifiers and enable absolute control (we use custom tooltips to format the tooltips better in-game)
			custom_tooltip = minister_project_train_troops_modifier_tt
			hidden_effect = {
				every_de_jure_county = {
					limit = {
						holder.top_liege = scope:owner
					}
					every_county_province = {
						limit = {
							NOT = { has_province_modifier = tgp_minister_project_train_troops_modifier }
							has_stationed_regiment = yes
						}
						add_province_modifier = {
							modifier = tgp_minister_project_train_troops_modifier
							years = 20
						}
					}
				}
			}
		}
		scope:founder ?= {
			if = {
				limit = {
					tgp_is_any_minister = yes
					is_alive = yes # this is actually necessary, because they remain the scope character and accessible even after death
				}
				change_influence = minister_influence_gain_value
			}
		}
	}

	project_contributions = {
		train_troops = {
			contributor_is_valid = {
				OR = {
					has_title = title:h_china
					has_title = title:e_minister_of_war
					# Grand Marshal missing on purpose here
					AND = {
						is_diarch_of_target = top_liege
						top_liege = {
							has_diarchy_type = grand_secretariat
						}
					}
				}
			}

			cost = {
				treasury_or_gold = great_project_base_contribution_cost
			}

			contributor_cooldown = 0
			
			is_required = yes

			on_complete = {
				if = {
					limit = {
						is_alive = yes
					}
					send_interface_toast = {
						type = event_toast_effect_good
						title = great_project_contribution_msg_t
						left_icon = root
						right_icon = scope:great_project.great_project_location.duchy
						
						if = {
							limit = {
								government_allows = merit
							}
							change_merit = {
								value = monumental_merit_gain
								if = {
									limit = {
										OR = {
											has_title = title:e_minister_chancellor
											has_title = title:e_minister_grand_marshal
											has_title = title:e_minister_of_war
										}
									}
									multiply = 2
								}
							}
						}
						else = {
							add_prestige = major_prestige_gain
						}
						if = {
							limit = {
								government_has_flag = government_has_influence
							}
							change_influence = {
								value = monumental_influence_gain
								if = {
									limit = {
										OR = {
											has_title = title:e_minister_grand_marshal
											has_title = title:e_minister_of_war
										}
									}
									multiply = 2
								}
							}
						}
						else = {
							add_prestige = major_prestige_gain
						}
					}
				}
			}
			on_contribution_funded = {
				great_project_notify_contribution = yes
			}
			ai_will_do = {
				value = chinese_great_projects_contribution_ai_will_do_base_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 18
				duchy = 12
				kingdom = 6
				empire = 3
				hegemony = 3
			}
		}

		military_academy = {
			contributor_is_valid = {
				OR = {
					has_title = title:h_china
					has_title = title:e_minister_of_war
					has_title = title:e_minister_grand_marshal
					AND = {
						is_governor = yes
						any_directly_owned_province = {
							has_building_or_higher = military_academy_01
						}
					}
				}
			}

			cost = {
				treasury_or_gold = great_project_base_contribution_cost
			}

			contributor_cooldown = 0
			
			is_required = no

			on_complete = {
				if = {
					limit = {
						is_alive = yes
					}
					if = {
						limit = {
							exists = title:e_minister_of_war.holder
						}
						title:e_minister_of_war.holder = {
							save_scope_as = minister
						}
					}
					else_if = {
						limit = {
							exists = title:e_minister_grand_marshal.holder
						}
						title:e_minister_grand_marshal.holder = {
							save_scope_as = minister
						}
					}
					else = {
						title:h_china.holder ?= {
							save_scope_as = minister
						}
					}
					save_scope_value_as = {
						name = minister_exp_boost_value
						value = {
							value = scope:minister.martial
							add = scope:minister.prowess
						}
					}
					send_interface_toast = {
						type = event_toast_effect_good
						title = great_project_contribution_msg_t
						left_icon = root
						right_icon = scope:great_project.great_project_location.duchy
						custom_tooltip = minister_project_train_troops_military_academy_modifier_tt
						scope:great_project.great_project_location.duchy ?= {
							every_de_jure_county_holder = {
								limit = {
									top_liege = root.top_liege 
								}
								every_knight = {
									limit = {
										any_character_trait = {
											has_trait_category = commander
											prev = {
												has_trait_xp = {
													trait = prev
													value < trait_max_value
												}
											}
										}
									}
									add_to_list = knights_to_boost
								}
							}
						}
						if = {
							limit = {
								scope:minister_exp_boost_value >= 50
							}
							add_martial_lifestyle_perk_points = 2
						}
						else = {
							add_martial_lifestyle_perk_points = 1
						}
						hidden_effect = {
							every_knight = {
								limit = {
									any_character_trait = {
										has_trait_category = commander
										prev = {
											has_trait_xp = {
												trait = prev
												value < trait_max_value
											}
										}
									}
								}
								add_to_list = knights_to_boost
							}
							every_in_list = {
								list = knights_to_boost
								random_character_trait = {
									limit = {
										has_trait_category = commander
										prev = {
											has_trait_xp = {
												trait = prev
												value < trait_max_value
											}
										}
									}
									prev = {
										add_trait_xp = {
											trait = prev
											value = scope:minister_exp_boost_value
										}
									}
								}
							}
						}
					}
					custom_tooltip = minister_project_train_troops_military_academy_help_tt
				}
			}
			on_contribution_funded = {
				great_project_notify_contribution = yes
			}
			ai_will_do = {
				value = chinese_great_projects_contribution_ai_will_do_base_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 18
				duchy = 12
				kingdom = 6
				empire = 3
				hegemony = 3
			}
		}

		levy_bootcamp = {
			contributor_is_valid = {
				OR = {
					has_title = title:h_china
					has_title = title:e_minister_of_war
					has_title = title:e_minister_grand_marshal
					AND = {
						is_diarch_of_target = top_liege
						top_liege = {
							has_diarchy_type = grand_secretariat
						}
					}
					is_governor = yes
				}
			}

			cost = {
				treasury_or_gold = great_project_base_contribution_cost
			}

			contributor_cooldown = 0
			
			is_required = no

			on_complete = {
				if = {
					limit = {
						is_alive = yes
					}
					send_interface_toast = {
						type = event_toast_effect_good
						title = great_project_contribution_msg_t
						left_icon = root
						right_icon = scope:great_project.great_project_location.duchy
						
						if = {
							limit = {
								government_allows = merit
								this != top_liege
							}
							change_merit = {
								value = monumental_merit_gain
								if = {
									limit = {
										OR = {
											has_title = title:e_minister_chancellor
											has_title = title:e_minister_of_war
											has_title = title:e_minister_grand_marshal
										}
									}
									multiply = 2
								}
							}
						}
						else = {
							add_prestige = major_prestige_gain
						}
						if = {
							limit = {
								exists = title:e_minister_of_war.holder
							}
							title:e_minister_of_war.holder = {
								save_scope_as = minister
							}
						}
						else_if = {
							limit = {
								exists = title:e_minister_grand_marshal.holder
							}
							title:e_minister_grand_marshal.holder = {
								save_scope_as = minister
							}
						}
						else = {
							title:h_china.holder ?= {
								save_scope_as = minister
							}
						}
						save_scope_value_as = {
							name = minister_exp_boost_value
							value = {
								value = scope:minister.martial
								add = scope:minister.prowess
							}
						}
						add_martial_lifestyle_xp = {
							value = scope:minister_exp_boost_value
							multiply = 20
							max = 3000
						}
						custom_tooltip = minister_project_train_troops_levy_bootcamp_modifier_tt
						scope:great_project.great_project_location.duchy ?= {
							every_de_jure_county = {
								limit = {
									holder.top_liege = root.top_liege
									NOT = { has_county_modifier = tgp_minister_project_train_troops_levy_bootcamp_modifier }
								}
								add_county_modifier = {
									modifier = tgp_minister_project_train_troops_levy_bootcamp_modifier
									years = 10
								}
							}
						}
						capital_county = {
							if = {
								limit = {
									NOT = { has_county_modifier = tgp_minister_project_train_troops_levy_bootcamp_modifier }
								}
								add_county_modifier = {
									modifier = tgp_minister_project_train_troops_levy_bootcamp_modifier
									years = 10
								}
							}
						}
					}
				}
			}
			on_contribution_funded = {
				great_project_notify_contribution = yes
				great_project_contribution_catalyst_effect = yes
			}
			ai_will_do = {
				value = chinese_great_projects_contribution_ai_will_do_base_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 18
				duchy = 12
				kingdom = 6
				empire = 3
				hegemony = 3
			}
		}

		equipment_check = {
			contributor_is_valid = {
				OR = {
					has_title = title:h_china
					has_title = title:e_minister_of_war
					has_title = title:e_minister_grand_marshal
					AND = {
						is_diarch_of_target = top_liege
						top_liege = {
							has_diarchy_type = grand_secretariat
						}
					}
					is_governor = yes
				}
			}

			cost = {
				treasury_or_gold = great_project_base_contribution_cost
			}

			contributor_cooldown = 0
			
			is_required = no

			on_complete = {
				if = {
					limit = {
						is_alive = yes
					}
					send_interface_toast = {
						type = event_toast_effect_good
						title = great_project_contribution_msg_t
						left_icon = root
						right_icon = scope:great_project.great_project_location.duchy
						
						if = {
							limit = {
								government_allows = merit
							}
							change_merit = {
								value = monumental_merit_gain
								if = {
									limit = {
										OR = {
											has_title = title:e_minister_chancellor
											has_title = title:e_minister_of_war
											has_title = title:e_minister_grand_marshal
										}
									}
									multiply = 2
								}
							}
						}
						else = {
							add_prestige = major_prestige_gain
						}
						add_to_list = artifact_holders_list
						scope:great_project.great_project_location.duchy ?= {
							every_de_jure_county_holder = {
								limit = {
									top_liege = root.top_liege
								}
								add_to_list = artifact_holders_list
							}
						}
						custom_tooltip = minister_project_train_troops_artifact_tt
						hidden_effect = {
							every_in_list = {
								list = artifact_holders_list
								random_character_artifact = {
									limit = {
										OR = {
											artifact_slot_type = primary_armament
											artifact_slot_type = armor
											artifact_slot_type = helmet
										}
										artifact_durability >= artifact_max_durability
									}
									random_list = {
										1 = { add_scaled_artifact_modifier_prowess_effect = yes }
										1 = { add_scaled_artifact_modifier_combat_effect = yes }
										1 = { add_scaled_artifact_modifier_negate_prowess_penalty_effect = yes }
										1 = { add_scaled_artifact_modifier_terrain_advantage_effect = yes }
										1 = { add_scaled_artifact_modifier_prestige_effect = yes }
									}
								}
								every_character_artifact = {
									limit = {
										OR = {
											artifact_slot_type = primary_armament
											artifact_slot_type = armor
											artifact_slot_type = helmet
										}
										artifact_durability < artifact_max_durability
									}
									add_durability = {
										value = artifact_max_durability
										subtract = artifact_durability
									}
								}
							}
						}
					}
				}
			}
			on_contribution_funded = {
				great_project_notify_contribution = yes
				great_project_contribution_catalyst_effect = yes
			}
			ai_will_do = {
				value = chinese_great_projects_contribution_ai_will_do_base_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 18
				duchy = 12
				kingdom = 6
				empire = 3
				hegemony = 3
			}
		}

		siege_exercise = {
			contributor_is_valid = {
				OR = {
					has_title = title:h_china
					has_title = title:e_minister_of_war
					has_title = title:e_minister_grand_marshal
					AND = {
						is_diarch_of_target = top_liege
						top_liege = {
							has_diarchy_type = grand_secretariat
						}
					}
					is_governor = yes
					OR = {
						has_trait = military_engineer
						has_trait = logistician
					}
				}
			}

			cost = {
				treasury_or_gold = great_project_base_contribution_cost
			}

			contributor_cooldown = 0
			
			is_required = no

			on_complete = {
				if = {
					limit = {
						is_alive = yes
					}
					send_interface_toast = {
						type = event_toast_effect_good
						title = great_project_contribution_msg_t
						left_icon = root
						right_icon = scope:great_project.great_project_location.duchy
						
						if = {
							limit = {
								government_allows = merit
							}
							change_merit = {
								value = major_merit_gain
								if = {
									limit = {
										OR = {
											has_title = title:e_minister_chancellor
											has_title = title:e_minister_of_war
											has_title = title:e_minister_grand_marshal
										}
									}
									multiply = 2
								}
							}
						}
						else = {
							add_prestige = major_prestige_gain
						}
						if = {
							limit = {
								exists = title:e_minister_of_war.holder
							}
							title:e_minister_of_war.holder = {
								save_scope_as = minister
							}
						}
						else_if = {
							limit = {
								exists = title:e_minister_grand_marshal.holder
							}
							title:e_minister_grand_marshal.holder = {
								save_scope_as = minister
							}
						}
						else = {
							title:h_china.holder ?= {
								save_scope_as = minister
							}
						}
						save_scope_value_as = {
							name = minister_exp_boost_value
							value = {
								value = scope:minister.martial
								add = scope:minister.prowess
								if = {
									limit = {
										OR = {
											has_trait = military_engineer
											has_trait = logistician
										}
									}
									multiply = 1.5
								}
							}
						}
						add_martial_lifestyle_xp = {
							value = scope:minister_exp_boost_value
							multiply = 20
							max = 3000
						}
						custom_tooltip = minister_project_train_troops_siege_exercise_modifier_tt
						hidden_effect = {
							scope:great_project.great_project_location.duchy = {
								every_de_jure_county = {
									limit = {
										holder.top_liege = root.top_liege
									}
									every_county_province = {
										limit = {
											NOT = { has_province_modifier = tgp_minister_project_train_troops_siege_exercise_modifier }
											has_stationed_regiment = yes
										}
										add_province_modifier = {
											modifier = tgp_minister_project_train_troops_siege_exercise_modifier
											years = 10
										}
									}
								}
							}
							every_directly_owned_province = {
								limit = {
									NOT = { has_province_modifier = tgp_minister_project_train_troops_siege_exercise_modifier }
									has_stationed_regiment = yes
								}
								add_province_modifier = {
									modifier = tgp_minister_project_train_troops_siege_exercise_modifier
									years = 10
								}
							}
						}
					}
				}
			}
			on_contribution_funded = {
				great_project_notify_contribution = yes
				great_project_contribution_catalyst_effect = yes
			}
			ai_will_do = {
				value = chinese_great_projects_contribution_ai_will_do_base_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 18
				duchy = 12
				kingdom = 6
				empire = 3
				hegemony = 3
			}
		}
		
		natural_disaster_test = {
			contributor_is_valid = {
				OR = {
					has_title = title:h_china
					has_title = title:e_minister_of_war
					has_title = title:e_minister_grand_marshal
					AND = {
						is_diarch_of_target = top_liege
						top_liege = {
							has_diarchy_type = grand_secretariat
						}
					}
					is_governor = yes
				}
			}

			cost = {
				treasury_or_gold = great_project_base_contribution_cost
			}

			contributor_cooldown = 0
			
			is_required = no

			on_complete = {
				if = {
					limit = {
						is_alive = yes
					}
					send_interface_toast = {
						type = event_toast_effect_good
						title = great_project_contribution_msg_t
						left_icon = root
						right_icon = scope:great_project.great_project_location.duchy
						
						if = {
							limit = {
								government_allows = merit
							}
							change_merit = {
								value = major_merit_gain
								if = {
									limit = {
										OR = {
											has_title = title:e_minister_chancellor
											has_title = title:e_minister_of_war
											has_title = title:e_minister_grand_marshal
										}
									}
									multiply = 2
								}
							}
						}
						else = {
							add_prestige = major_prestige_gain
						}
						custom_tooltip = minister_project_train_troops_natural_disaster_test_modifier_tt
						hidden_effect = {
							scope:great_project.great_project_location.duchy ?= {
								every_de_jure_county = {
									limit = {
										holder.top_liege = root.top_liege
										NOT = { has_county_modifier = tgp_minister_project_train_troops_natural_disaster_test_modifier }
									}
									add_county_modifier = {
										modifier = tgp_minister_project_train_troops_natural_disaster_test_modifier
										years = 10
									}
								}
							}
							capital_county = {
								if = {
									limit = {
										NOT = { has_county_modifier = tgp_minister_project_train_troops_natural_disaster_test_modifier }
										holder = root
									}
									add_county_modifier = {
										modifier = tgp_minister_project_train_troops_natural_disaster_test_modifier
										years = 10
									}
								}
							}
						}
					}
				}
			}
			on_contribution_funded = {
				great_project_notify_contribution = yes
			}
			ai_will_do = {
				value = chinese_great_projects_contribution_ai_will_do_base_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 18
				duchy = 12
				kingdom = 6
				empire = 3
				hegemony = 3
			}
		}
	}
	
	ai_will_do = {
		value = 30
		
		if = {
			limit = {
				treasury >= 20000
			}
			add = 70
		}
		if = {
			limit = { has_trait = diligent }
			add = 10
		}
		if = {
			limit = { has_trait = ambitious }
			add = 10
		}
		if = {
			limit = { has_trait = wrathful }
			add = 5
		}
		if = {
			limit = { has_trait = brave }
			add = 5
		}
		if = {
			limit = { has_trait = craven }
			add = -10
		}
		if = {
			limit = {
				has_trait = lazy
				this != top_liege
			}
			add = -30
		}
		if = {
			limit = {
				NOT = {
					has_trait = education_martial
				}
			}
			add = -30
		}
		if = {
			limit = {
				is_at_war = yes
			}
			multiply = 1.25
		}
		if = {
			limit = {
				situation:dynastic_cycle ?= {
					situation_current_phase = situation_dynastic_cycle_phase_stability_advancement
				}
			}
			multiply = 0.25
		}
	}

	ai_target_quick_trigger = {
		adult = yes
		rank = empire
	}
	
	ai_check_interval_by_tier = {
		barony = 0
		county = 0
		duchy = 0
		kingdom = 0
		empire = 5
		hegemony = 3
	}

	completion_sound_effect = @msg_completion_effect_generic
}

# Conduct Census
minister_project_conduct_census = {
	icon = "gfx/interface/icons/celestial_administration_types/icon_game_concept_celestial_metropolitan_administration.dds"
	# illustration = { #LotR
	# 	trigger = {
	# 		trigger_if = {
	# 			limit = { exists = scope:province }
	# 			scope:province = {
	# 				OR = {
	# 					geographical_region = world_asia
	# 					geographical_region = world_steppe_east
	# 				}
	# 			}
	# 		}
	# 		trigger_else = {
	# 			scope:founder = {
	# 				capital_province ?= {
	# 					OR = {
	# 						geographical_region = world_asia
	# 						geographical_region = world_steppe_east
	# 					}
	# 				}
	# 			}
	# 		}
	# 	}
	# 	reference = "gfx/interface/illustrations/event_scenes/tgp_physician_asia.dds"
	# }
	illustration = {
		reference = "gfx/interface/illustrations/event_scenes/councilchamber.dds"
	}

	name = great_project_type_minister_project_conduct_census

	is_shown = {
		has_tgp_dlc_trigger = yes
		always = no #LotR
		# You are the hegemon or a relevant minister
		OR = {
			# has_title = title:h_china #LotR
			has_title = title:e_minister_of_revenue
			AND = {
				is_diarch_of_target = top_liege
				top_liege = {
					has_diarchy_type = grand_secretariat
				}
			}
		}
	}

	can_start_planning = {
		# You/your liege/the minister have not already planned this project
		trigger_if = {
			limit = { # When in a stable phase, we allow everyone with access to do this simultaneously
				situation:dynastic_cycle ?= {
					OR = {
						situation_current_phase = situation_dynastic_cycle_phase_stability_expansion
						situation_current_phase = situation_dynastic_cycle_phase_instability_conquest
					}
				}
			}
			NOT = { is_planning_great_project = minister_project_conduct_census }
		}
		trigger_else = { # Otherwise, only a single project at a time
			NOR = {
				is_planning_great_project = minister_project_conduct_census
				custom_tooltip = {
					text = only_single_great_project_type_allowed
					any_great_project = {
						great_project_type = minister_project_conduct_census
					}
				}
			}
		}
		# There are valid counties in the realm
		any_realm_county = {
			NOT = { has_county_modifier = tgp_minister_project_conduct_census_modifier }
		}
	}
	
	is_valid = {
		scope:owner = { # even when started by a minister, the owner is still the Huangdi; if another realm takes the land, this should invalidate
			# has_title = title:h_china #LotR
		}
	}
	
	is_location_valid = {
		scope:province.duchy = {
			any_de_jure_county = {
				holder.top_liege = root.top_liege
				NOT = { has_county_modifier = tgp_minister_project_conduct_census_modifier }
			}
		}
		scope:province = {
			custom_tooltip = {
				text = GREAT_PROJECT_CAN_PLAN
				NOT = {
					duchy = {
						any_in_de_jure_hierarchy = {
							tier = tier_barony
							title_province = {
								any_great_project_in_province = {
									great_project_type = minister_project_conduct_census
								}
							}
						}
					}
				}
			}
		}
	}
	
	province_filter = top_realm
	
	cost = {
		treasury_or_gold = {
			value = great_project_base_starting_cost
			multiply = 2
			if = {
				limit = {
					is_councillor = yes
				}
				divide = 2
			}
		}
	}

	construction_time = {
		value = 1825
		multiply = common_great_project_construction_time_multiplier_value
	}

	contributor_cooldown = 0

	allowed_contributor_filter = {
		owner = yes
		vassals = yes
		tributaries = yes
	}
	
	on_plan_build = {
		scope:founder ?= {
			if = {
				limit = {
					is_councillor = yes
				}
				root = {
					set_variable = {
						name = project_founded_by_minister
						value = {
							value = 0
							add = scope:founder.stewardship
						}
					}
				}
			}
		}
	}

	on_complete = {
		if = {
			limit = {
				NOT = { exists = scope:province }
			}
			custom_tooltip = minister_project_conduct_census_modifier_tt
		}
		situation:dynastic_cycle = {
			if = {
				limit = {
					situation_top_has_catalyst = catalyst_minister_conduct_census
				}
				trigger_situation_catalyst = {
					catalyst = catalyst_minister_conduct_census
					character = scope:founder
				}
			}
		}
		scope:province.duchy ?= {
			# Inrease local county control (for all counties)
			change_county_control = {
				# Add a base increase
				value = 10
				# If founded by a minister, increase it further based on skills
				if = {
					limit = {
						exists = scope:great_project.var:project_founded_by_minister
					}
					add = {
						value = scope:great_project.var:project_founded_by_minister
						divide = 5
					}
				}
				else_if = { # To show it properly in the tooltip when shown before starting the project
					limit = {
						scope:founder = { is_councillor = yes }
					}
					add = {
						value = 0
						add = scope:founder.stewardship
						divide = 5
						round = yes
					}
				}
			}
			
			# Add county modifiers and enable absolute control (we use custom tooltips to format the tooltips better in-game)
			custom_tooltip = minister_project_conduct_census_modifier_tt
			hidden_effect = {
				every_de_jure_county = {
					limit = {
						holder.top_liege = scope:owner
						NOT = { has_county_modifier = tgp_minister_project_conduct_census_modifier }
					}
					add_county_modifier = {
						modifier = tgp_minister_project_conduct_census_modifier
						years = 20
					}	
				}
			}
		}
		scope:founder ?= {
			if = {
				limit = {
					tgp_is_any_minister = yes
					is_alive = yes # this is actually necessary, because they remain the scope character and accessible even after death
				}
				change_influence = minister_influence_gain_value
			}
		}
	}

	project_contributions = {
		conduct_census = {
			contributor_is_valid = {
				OR = {
					# has_title = title:h_china #LotR
					has_title = title:e_minister_of_revenue
					AND = {
						is_diarch_of_target = top_liege
						top_liege = {
							has_diarchy_type = grand_secretariat
						}
					}
				}
			}

			cost = {
				treasury_or_gold = great_project_base_contribution_cost
			}

			contributor_cooldown = 0
			
			is_required = yes

			on_complete = {
				if = {
					limit = {
						is_alive = yes
					}
					send_interface_toast = {
						type = event_toast_effect_good
						title = great_project_contribution_msg_t
						left_icon = root
						right_icon = scope:great_project.great_project_location.duchy
						
						if = {
							limit = {
								government_allows = merit
							}
							change_merit = {
								value = monumental_merit_gain
								if = {
									limit = {
										OR = {
											has_title = title:e_minister_chancellor
											has_title = title:e_minister_of_revenue
										}
									}
									multiply = 2
								}
							}
						}
						else = {
							add_prestige = major_prestige_gain
						}
						if = {
							limit = {
								government_has_flag = government_has_influence
							}
							change_influence = {
								value = monumental_influence_gain
								if = {
									limit = {
										has_title = title:e_minister_of_revenue
									}
									multiply = 2
								}
							}
						}
						else = {
							add_prestige = major_prestige_gain
						}
					}
				}
			}
			on_contribution_funded = {
				great_project_notify_contribution = yes
			}
			ai_will_do = {
				value = chinese_great_projects_contribution_ai_will_do_base_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 0
				duchy = 0
				kingdom = 0
				empire = 3
				hegemony = 3
			}
		}

		purge_treasury_debt = {
			contributor_is_valid = {
				OR = {
					# has_title = title:h_china #LotR
					has_title = title:e_minister_of_revenue
					AND = {
						is_diarch_of_target = top_liege
						top_liege = {
							has_diarchy_type = grand_secretariat
						}
					}
					is_governor = yes
					title:e_minister_of_revenue.holder ?= {
						treasury >= 1000
					}
				}
			}

			cost = {
				treasury_or_gold = great_project_base_contribution_cost
			}

			contributor_cooldown = 0
			
			is_required = no

			on_complete = {
				if = {
					limit = {
						is_alive = yes
					}
					send_interface_toast = {
						type = event_toast_effect_good
						title = great_project_contribution_msg_t
						left_icon = root
						right_icon = scope:great_project.great_project_location.duchy
						
						if = {
							limit = {
								government_allows = merit
								this != top_liege
							}
							change_merit = {
								value = monumental_merit_gain
								if = {
									limit = {
										OR = {
											has_title = title:e_minister_chancellor
											has_title = title:e_minister_of_revenue
										}
									}
									multiply = 2
								}
							}
						}
						else = {
							add_prestige = major_prestige_gain
						}
						if = {
							limit = {
								exists = title:e_minister_of_revenue.holder
							}
							title:e_minister_of_revenue.holder = {
								save_scope_as = minister
							}
						}
						else = {
							top_liege = {
								save_scope_as = minister
							}
						}
						add_stewardship_lifestyle_xp = {
							value = scope:minister.stewardship
							multiply = 20
							max = 3000
						}
						custom_tooltip = minister_project_conduct_census_purge_treasury_debt_tt
						hidden_effect = {
							scope:great_project.great_project_location.duchy ?= {
								every_de_jure_county_holder = {
									limit = {
										top_liege = root.top_liege
										has_treasury = yes
									}
									send_interface_message = {
										type = event_toast_effect_good
										title = great_project_purge_treasury_debt_msg_t
										left_icon = root
										right_icon = scope:great_project.great_project_location.duchy
										if = {
											limit = {
												treasury < 0
											}
											scope:minister = {
												pay_short_term_treasury = {
													target = prev
													treasury = 1000
												}
											}
											if = {
												limit = {
													NOT = {
														has_character_modifier = tgp_minister_project_conduct_census_purge_treasury_debt_modifier
													}
												}
												add_character_modifier = {
													modifier = tgp_minister_project_conduct_census_purge_treasury_debt_modifier
													years = 5
												}
											}
										}
										else = {
											if = {
												limit = {
													NOT = {
														has_character_modifier = tgp_minister_project_conduct_census_purge_treasury_debt_modifier
													}
												}
												add_character_modifier = {
													modifier = tgp_minister_project_conduct_census_purge_treasury_debt_modifier
													years = 10
												}
											}
										}
									}
								}
							}
							if = {
								limit = {
									NOT = {
										has_character_modifier = tgp_minister_project_conduct_census_purge_treasury_debt_modifier
									}
								}
								add_character_modifier = {
									modifier = tgp_minister_project_conduct_census_purge_treasury_debt_modifier
									years = 10
								}
							}
						}
					}
				}
			}
			on_contribution_funded = {
				great_project_notify_contribution = yes
			}
			ai_will_do = {
				value = chinese_great_projects_contribution_ai_will_do_base_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 18
				duchy = 12
				kingdom = 6
				empire = 3
				hegemony = 3
			}
		}

		verify_passed_exams = {
			contributor_is_valid = {
				OR = {
					# has_title = title:h_china #LotR
					has_title = title:e_minister_of_revenue
					has_title = title:e_minister_of_rites
					has_title = title:e_minister_censor
					has_title = title:e_minister_of_justice
					AND = {
						is_diarch_of_target = top_liege
						top_liege = {
							has_diarchy_type = grand_secretariat
						}
					}
				}
			}

			cost = {
				treasury_or_gold = great_project_base_contribution_cost
			}

			contributor_cooldown = 0
			
			is_required = no

			on_complete = {
				if = {
					limit = {
						is_alive = yes
					}
					send_interface_toast = {
						type = event_toast_effect_good
						title = great_project_contribution_msg_t
						left_icon = root
						right_icon = scope:great_project.great_project_location.duchy
						
						if = {
							limit = {
								government_allows = merit
							}
							change_merit = {
								value = monumental_merit_gain
								if = {
									limit = {
										OR = {
											has_title = title:e_minister_chancellor
											has_title = title:e_minister_of_revenue
											has_title = title:e_minister_of_rites
										}
									}
									multiply = 2
								}
							}
						}
						else = {
							add_prestige = major_prestige_gain
						}
						if = {
							limit = {
								government_has_flag = government_has_influence
							}
							change_influence = {
								value = monumental_influence_gain
								if = {
									limit = {
										OR = {
											has_title = title:e_minister_of_revenue
											has_title = title:e_minister_of_rites
										}
									}
									multiply = 2
								}
							}
						}
						else = {
							add_prestige = major_prestige_gain
						}
						custom_tooltip = minister_project_conduct_census_verify_passed_exams_tt
						hidden_effect = {
							scope:great_project.great_project_location.duchy ?= {
								every_de_jure_county_holder = {
									limit = {
										top_liege = root.top_liege
										any_secret = {
											secret_type = secret_exam_cheater
										}
									}
									random_secret = {
										limit = {
											secret_type = secret_exam_cheater
										}
										random = {
											chance = root.intrigue
											reveal_to = root
										}
									}
								}
							}
						}
					}
				}
			}
			on_contribution_funded = {
				great_project_notify_contribution = yes
			}
			ai_will_do = {
				value = chinese_great_projects_contribution_ai_will_do_base_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 0
				duchy = 0
				kingdom = 0
				empire = 3
				hegemony = 3
			}
		}

		fertility_effort = {
			contributor_is_valid = {
				OR = {
					# has_title = title:h_china #LotR
					has_title = title:e_minister_of_revenue
					AND = {
						is_diarch_of_target = top_liege
						top_liege = {
							has_diarchy_type = grand_secretariat
						}
					}
					is_governor = yes
				}
			}

			cost = {
				treasury_or_gold = great_project_base_contribution_cost
			}

			contributor_cooldown = 0
			
			is_required = no

			on_complete = {
				if = {
					limit = {
						is_alive = yes
					}
					send_interface_toast = {
						type = event_toast_effect_good
						title = great_project_contribution_msg_t
						left_icon = root
						right_icon = scope:great_project.great_project_location.duchy
						
						if = {
							limit = {
								government_allows = merit
							}
							change_merit = {
								value = major_merit_gain
								if = {
									limit = {
										OR = {
											has_title = title:e_minister_chancellor
											has_title = title:e_minister_of_revenue
										}
									}
									multiply = 2
								}
							}
						}
						else = {
							add_prestige = major_prestige_gain
						}
						custom_tooltip = minister_project_conduct_census_fertility_effort_modifier_tt
						hidden_effect = {
							scope:great_project.great_project_location.duchy ?= {
								every_de_jure_county = {
									limit = {
										holder.top_liege = root.top_liege
										NOT = { has_county_modifier = tgp_minister_project_conduct_census_fertility_effort_modifier }
									}
									add_county_modifier = {
										modifier = tgp_minister_project_conduct_census_fertility_effort_modifier
										years = 10
									}
								}
							}
							capital_county = {
								if = {
									limit = {
										NOT = { has_county_modifier = tgp_minister_project_conduct_census_fertility_effort_modifier }
									}
									add_county_modifier = {
										modifier = tgp_minister_project_conduct_census_fertility_effort_modifier
										years = 10
									}
								}
							}
						}
					}
				}
			}
			on_contribution_funded = {
				great_project_notify_contribution = yes
				great_project_contribution_catalyst_effect = yes
			}
			ai_will_do = {
				value = chinese_great_projects_contribution_ai_will_do_base_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 18
				duchy = 12
				kingdom = 6
				empire = 3
				hegemony = 3
			}
		}
		
		natural_disaster_insurance = {
			contributor_is_valid = {
				OR = {
					# has_title = title:h_china #LotR
					has_title = title:e_minister_of_revenue
					AND = {
						is_diarch_of_target = top_liege
						top_liege = {
							has_diarchy_type = grand_secretariat
						}
					}
					is_governor = yes
				}
			}

			cost = {
				treasury_or_gold = great_project_base_contribution_cost
			}

			contributor_cooldown = 0
			
			is_required = no

			on_complete = {
				if = {
					limit = {
						is_alive = yes
					}
					send_interface_toast = {
						type = event_toast_effect_good
						title = great_project_contribution_msg_t
						left_icon = root
						right_icon = scope:great_project.great_project_location.duchy
						
						if = {
							limit = {
								government_allows = merit
							}
							change_merit = {
								value = major_merit_gain
								if = {
									limit = {
										OR = {
											has_title = title:e_minister_chancellor
											has_title = title:e_minister_of_revenue
										}
									}
									multiply = 2
								}
							}
						}
						else = {
							add_prestige = major_prestige_gain
						}
						custom_tooltip = minister_project_conduct_census_natural_disaster_insurance_modifier_tt
						hidden_effect = {
							scope:great_project.great_project_location.duchy ?= {
								every_de_jure_county = {
									limit = {
										holder.top_liege = root.top_liege
										NOT = { has_county_modifier = tgp_minister_project_conduct_census_natural_disaster_insurance_modifier }
									}
									add_county_modifier = {
										modifier = tgp_minister_project_conduct_census_natural_disaster_insurance_modifier
										years = 10
									}
								}
							}
							capital_county = {
								if = {
									limit = {
										NOT = { has_county_modifier = tgp_minister_project_conduct_census_natural_disaster_insurance_modifier }
										holder = root
									}
									add_county_modifier = {
										modifier = tgp_minister_project_conduct_census_natural_disaster_insurance_modifier
										years = 10
									}
								}
							}
						}
					}
				}
			}
			on_contribution_funded = {
				great_project_notify_contribution = yes
			}
			ai_will_do = {
				value = chinese_great_projects_contribution_ai_will_do_base_value
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 18
				duchy = 12
				kingdom = 6
				empire = 3
				hegemony = 3
			}
		}
	}
	
	ai_will_do = {
		value = 10
		
		if = {
			limit = {
				treasury >= 20000
			}
			add = 70
		}
		if = {
			limit = { has_trait = diligent }
			add = 10
		}
		if = {
			limit = { has_trait = ambitious }
			add = 10
		}
		if = {
			limit = { has_trait = content }
			add = -10
		}
		if = {
			limit = { has_trait = trusting }
			add = -10
		}
		if = {
			limit = {
				has_trait = lazy
				this != top_liege
			}
			add = -30
		}
		if = {
			limit = {
				NOT = {
					has_trait = education_stewardship
				}
			}
			add = -30
		}
		if = {
			limit = {
				top_participant_group:dynastic_cycle ?= {
					OR = {
						participant_group_type = advancement_movement
						participant_group_type = pro_hegemon_movement
					}
				}
			}
			add = 10
		}
		if = {
			limit = {
				is_at_war = yes
			}
			multiply = 0
		}
	}

	ai_target_quick_trigger = {
		adult = yes
		rank = empire
	}
	
	ai_check_interval_by_tier = {
		barony = 0
		county = 0
		duchy = 0
		kingdom = 0
		empire = 10
		hegemony = 6
	}

	completion_sound_effect = @msg_completion_effect_generic
}

# Compel Religious Uniformity
minister_compel_religious_uniformity = {
	icon = {
		reference = @great_project_compel_religious_uniformity_icon
	}
	illustration = {
		reference = @compel_religious_uniformity_illustration
	}

	name = minister_compel_religious_uniformity_name
	
	is_shown = {
		always = no #LotR
		has_tgp_dlc_trigger = yes
		# You are the hegemon or the relevant minister
		OR = {
			# has_title = title:h_china #LotR
			has_title = title:e_minister_of_rites
			AND = {
				is_diarch_of_target = top_liege
				top_liege = {
					has_diarchy_type = grand_secretariat
				}
			}
		}
		trigger_if = { # The AI should not plan more of these projects than there are valid characters to start them
			limit = {
				is_ai = yes
			}
			NOT = {
				any_great_project = {
					count >= 2
					great_project_type = minister_compel_religious_uniformity
				}
			}
		}
	}
	
	province_filter = top_realm

	can_start_planning = {
		# You/your liege/the minister have not already planned this project
		trigger_if = {
			limit = { # When in the advancement phase, we allow everyone with access to do this simultaneously
				situation:dynastic_cycle ?= {
					situation_current_phase = situation_dynastic_cycle_phase_stability_advancement
				}
			}
			NOT = { is_planning_great_project = minister_compel_religious_uniformity }
		}
		trigger_else = { # Otherwise, only a single project at a time
			NOR = {
				is_planning_great_project = minister_compel_religious_uniformity
				custom_tooltip = {
					text = only_single_great_project_type_allowed
					any_great_project = {
						great_project_type = minister_compel_religious_uniformity
					}
				}
			}
		}
		# If you are the hegemon, you must have a minister of works appointed
		trigger_if = {
			limit = {
				always = no #LotR
				# has_title = title:h_china #LotR
			}
			custom_tooltip = {
				text = you_have_a_minister_of_rites_desc
				exists = cp:councillor_court_chaplain
			}
		}
	}
	
	is_location_valid = {
		scope:province = {
			county = {
				custom_tooltip = {
					text = not_same_faith_as_top_liege_desc
					faith != root.top_liege.faith
				}
			}
			root.top_liege = {
				completely_controls = scope:province.duchy
			}
			custom_tooltip = {
				text = GREAT_PROJECT_CAN_PLAN
				NOT = {
					duchy = {
						any_in_de_jure_hierarchy = {
							tier = tier_barony
							title_province = {
								any_great_project_in_province = {
									great_project_type = minister_compel_religious_uniformity
								}
							}
						}
					}
				}
			}
		}
		trigger_if = {
			limit = {
				scope:founder = {
					is_ai = yes
				}
			}
			scope:province.county.faith = {
				faith_hostility_level = {
					target = scope:founder.top_liege.faith
					value >= faith_hostile_level
				}
			}
		}
	}

	is_valid = {
		scope:owner = { # even when started by a minister, the owner is still the Huangdi; if another realm takes the land, this should invalidate
			# has_title = title:h_china #LotR
		}
	}
	
	cost = {
		treasury_or_gold = {
			value = great_project_base_starting_cost
			multiply = 0.2
			if = {
				limit = {
					is_councillor = yes
				}
				multiply = 0.5
			}
		}
	}

	construction_time = {
		value = great_project_base_construction_time
		multiply = 7
		scope:great_project = {
			if = {
				limit = {
					has_variable = project_founded_by_minister
				}
				multiply = 0.75
			}
			every_contribution = {
				limit = {
					NOT = { contribution_id = cultural_liason }
					contribution_is_funded = yes
				}
				subtract = 365
			}
		}
		multiply = common_great_project_construction_time_multiplier_value
	}

	contributor_cooldown = standard_contributor_cooldown_value

	allowed_contributor_filter = {
		owner = yes
		vassals = yes
		top_liege = yes
	}
	
	on_plan_build = {
		scope:founder ?= {
			if = {
				limit = {
					is_councillor = yes
				}
				root = { set_variable = project_founded_by_minister }
			}
		}
	}

	on_start_build = {
	}

	on_complete = {
		situation:dynastic_cycle = {
			if = {
				limit = {
					situation_top_has_catalyst = catalyst_minister_compel_religious_uniformity
				}
				trigger_situation_catalyst = {
					catalyst = catalyst_minister_compel_religious_uniformity
					character = scope:founder
				}
			}
		}
		if = {
			limit = {
				scope:founder = scope:founder.top_liege
				scope:owner ?= {
					tgp_has_access_to_ministry_trigger = yes
				}
			}
			custom_tooltip = minister_project_cost_desc
		}
		if = {
			limit = {
				NOT = { exists = scope:province }
			}
			custom_tooltip = minister_compel_religious_uniformity_effect_desc
		}
		scope:owner ?= {
			send_interface_toast = {
				type = event_generic_neutral_text
				title = great_project_completed_msg_t
				left_icon = scope:owner
				right_icon = scope:province.county
				desc = great_project_completed_msg_desc
			}
		}
		scope:province ?= {
			duchy = {
				every_de_jure_county = {
					# Change culture or increase cultural acceptance
					if = {
						limit = {
							faith != scope:owner.top_liege.faith
						}
						set_county_faith = scope:owner.top_liege.faith
					}
					else_if = {
						limit = {
							faith = scope:owner.top_liege.faith
						}
						change_county_control = 5
						add_county_modifier = {
							modifier = tgp_compelled_religious_uniformity_county_modifier
							years = 10
						}
					}
				}
			}
		}
		scope:founder ?= {
			if = {
				limit = {
					tgp_is_any_minister = yes
					is_alive = yes # this is actually necessary, because they remain the scope character and accessible even after death
				}
				change_influence = minister_influence_gain_value
			}
		}
	}
	
	project_contributions = {
		religious_liason = {
			contributor_is_valid = {
			}

			cost = {
				treasury_or_gold = {
					value = great_project_base_contribution_cost
					multiply = 0.5
				}
			}

			contributor_cooldown = individual_contribution_cooldown_value
			
			is_required = yes

			on_complete = {
				great_project_reward_contribution_completion_notification_effect = {
					LEVEL = major
					NON_OWNER_REWARD_EFFECT = great_project_reward_contribution_completion_null
					OWNER_REWARD_EFFECT = great_project_reward_contribution_completion_null
				}
			}
			on_contribution_funded = {
				great_project_notify_contribution = yes
				great_project_contribution_catalyst_effect = yes
			}
			ai_will_do = {
				value = chinese_great_projects_contribution_ai_will_do_base_value
				if = {
					limit = {
						faith = {
							faith_hostility_level = {
								target = root.top_liege.faith
								value >= faith_hostile_level
							}
						}
					}
					add = -100
				}
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 18
				duchy = 12
				kingdom = 6
				empire = 3
				hegemony = 3
			}
		}
		construct_new_shrines = {
			contributor_is_valid = {
			}

			cost = {
				treasury_or_gold = {
					value = great_project_base_contribution_cost
					multiply = 0.25
				}
			}

			contributor_cooldown = 0
			
			is_required = no

			on_contribution_funded = {
				custom_tooltip = great_project_construction_time_is_reduced_desc
				if = {
					limit = {
						this != scope:owner
						this != scope:founder						
					}
					scope:owner ?= {
						send_interface_toast = {
							type = event_generic_good_with_text
							title = great_project_contributed_msg_t
							desc = great_project_contributed_msg_desc
							left_icon = root
							right_icon = scope:great_project.great_project_location.county
						}			
					}
				}
			}

			on_complete = {
				send_interface_toast = {
					title = great_project_contribution_msg_t
					left_icon = root
					right_icon = scope:great_project.great_project_location.duchy
					
					if = {
						limit = {
							has_trait = governor
						}
						increase_governance_effect = { VALUE = 10 }
					}
					else_if = {
						limit = {
							government_has_flag = government_has_influence
						}
						change_influence = monumental_influence_gain
					}
					else = {
						add_prestige = major_prestige_gain
					}
				}
			}
			
			ai_will_do = {
				value = chinese_great_projects_contribution_ai_will_do_base_value
				if = {
					limit = {
						faith = {
							faith_hostility_level = {
								target = root.top_liege.faith
								value >= faith_hostile_level
							}
						}
					}
					multiply = 0
				}
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 18
				duchy = 12
				kingdom = 6
				empire = 3
				hegemony = 3
			}
		}
		investigate_improper_rites = {
			contributor_is_valid = {
			}

			cost = {
				treasury_or_gold = {
					value = great_project_base_contribution_cost
					multiply = 0.25
				}
			}

			contributor_cooldown = 0
			
			is_required = no

			on_contribution_funded = {
				custom_tooltip = great_project_construction_time_is_reduced_desc
				if = {
					limit = {
						this != scope:owner
						this != scope:founder						
					}
					scope:owner ?= {
						send_interface_toast = {
							type = event_generic_good_with_text
							title = great_project_contributed_msg_t
							desc = great_project_contributed_msg_desc
							left_icon = root
							right_icon = scope:great_project.great_project_location.county
						}			
					}
				}
			}

			on_complete = {
				send_interface_toast = {
					title = great_project_contribution_msg_t
					left_icon = root
					right_icon = scope:great_project.great_project_location.duchy
					
					if = {
						limit = {
							has_trait = governor
						}
						increase_governance_effect = { VALUE = 10 }
					}
					else_if = {
						limit = {
							government_has_flag = government_has_influence
						}
						change_influence = monumental_influence_gain
					}
					else = {
						add_prestige = major_prestige_gain
					}
				}
			}
			
			ai_will_do = {
				value = chinese_great_projects_contribution_ai_will_do_base_value
				if = {
					limit = {
						faith = {
							faith_hostility_level = {
								target = root.top_liege.faith
								value >= faith_hostile_level
							}
						}
					}
					add = -100
				}
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 18
				duchy = 12
				kingdom = 6
				empire = 3
				hegemony = 3
			}
		}
		promote_faithful_relocation = {
			contributor_is_valid = {
			}

			cost = {
				treasury_or_gold = {
					value = great_project_base_contribution_cost
					multiply = 0.25
				}
			}

			contributor_cooldown = 0
			
			is_required = no

			on_contribution_funded = {
				custom_tooltip = great_project_construction_time_is_reduced_desc
				if = {
					limit = {
						this != scope:owner
						this != scope:founder						
					}
					scope:owner ?= {
						send_interface_toast = {
							type = event_generic_good_with_text
							title = great_project_contributed_msg_t
							desc = great_project_contributed_msg_desc
							left_icon = root
							right_icon = scope:great_project.great_project_location.county
						}			
					}
				}
			}
			
			on_complete = {
				send_interface_toast = {
					title = great_project_contribution_msg_t
					left_icon = root
					right_icon = scope:great_project.great_project_location.duchy
					
					if = {
						limit = {
							has_trait = governor
						}
						increase_governance_effect = { VALUE = 10 }
					}
					else_if = {
						limit = {
							government_has_flag = government_has_influence
						}
						change_influence = minister_influence_gain_value
					}
					else = {
						add_prestige = major_prestige_gain
					}
				}
			}
			
			ai_will_do = {
				value = chinese_great_projects_contribution_ai_will_do_base_value
				if = {
					limit = {
						faith = {
							faith_hostility_level = {
								target = root.top_liege.faith
								value >= faith_hostile_level
							}
						}
					}
					add = -100
				}
			}
			
			ai_check_interval_by_tier = {
				barony = 0
				county = 18
				duchy = 12
				kingdom = 6
				empire = 3
				hegemony = 3
			}
		}
	}
	
	ai_will_do = {
		value = 15
		
		if = {
			limit = {
				situation:dynastic_cycle ?= {
					situation_current_phase = situation_dynastic_cycle_phase_stability_advancement
				}
			}
			add = 10
		}
		if = {
			limit = {
				has_trait = zealous
			}
			add = 10
		}
		if = {
			limit = {
				has_trait = arrogant
			}
			add = 5
		}
		if = {
			limit = {
				has_trait = compassionate
			}
			add = -10
		}
		if = {
			limit = {
				has_trait = cynical
			}
			add = -10
		}
		if = {
			limit = {
				faith != root.top_liege.faith
			}
			multiply = 0
		}
		if = {
			limit = {
				is_at_war = yes
			}
			multiply = 0
		}
	}

	ai_target_quick_trigger = {
		adult = yes
		rank = empire
	}
	
	ai_check_interval_by_tier = {
		barony = 0
		county = 0
		duchy = 0
		kingdom = 0
		empire = 10
		hegemony = 6
	}

	completion_sound_effect = @msg_completion_effect_generic
}
